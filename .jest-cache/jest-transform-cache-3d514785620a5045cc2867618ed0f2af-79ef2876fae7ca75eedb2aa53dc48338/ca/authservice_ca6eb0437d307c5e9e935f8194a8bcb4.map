{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\backend-gateway\\src\\auth\\auth.service.ts","mappings":";AAAA,sDAAsD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEtD,2CAAqF;AAKrF,mDAAoC;AAM7B,IAAM,WAAW,GAAjB,MAAM,WAAW;IAEH;IACA;IAFnB,YACmB,MAAqB,EACrB,UAAsB;QADtB,WAAM,GAAN,MAAM,CAAe;QACrB,eAAU,GAAV,UAAU,CAAY;IACtC,CAAC;IAEG,KAAK,CAAC,QAAQ,CAAC,WAAwB;QAC5C,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,WAAW,CAAA;QAEvC,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YACrD,KAAK,EAAE,EAAE,KAAK,EAAE;SACjB,CAAC,CAAA;QACF,IAAI,YAAY,EAAE,CAAC;YACjB,MAAM,IAAI,0BAAiB,CAAC,2BAA2B,CAAC,CAAA;QAC1D,CAAC;QAED,MAAM,cAAc,GAAG,MAAM,QAAQ,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAA;QAExD,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YACzC,IAAI,EAAE;gBACJ,KAAK;gBACL,QAAQ,EAAE,cAAc;aACzB;SACF,CAAC,CAAA;QAEF,6DAA6D;QAC7D,MAAM,EAAE,QAAQ,EAAE,CAAC,EAAE,GAAG,MAAM,EAAE,GAAG,IAAI,CAAA;QACvC,OAAO,MAAM,CAAA;IACf,CAAC;IAEM,KAAK,CAAC,YAAY,CAAC,KAAa,EAAE,IAAY;QACnD,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,EAAE,CAAC,CAAA;QAEpE,yBAAyB;QACzB,IAAI,IAAI,IAAI,CAAC,MAAM,QAAQ,CAAC,OAAO,CAAC,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC;YAC1D,6DAA6D;YAC7D,MAAM,EAAE,QAAQ,EAAE,CAAC,EAAE,GAAG,MAAM,EAAE,GAAG,IAAI,CAAA;YACvC,OAAO,MAAM,CAAA;QACf,CAAC;QACD,OAAO,IAAI,CAAA;IACb,CAAC;IACM,KAAK,CAAC,KAAK,CAAC,QAAkB;QACnC,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,KAAK,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAA;QAEvE,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,MAAM,IAAI,8BAAqB,CAAC,sBAAsB,CAAC,CAAA;QACzD,CAAC;QAED,MAAM,OAAO,GAAG,EAAE,KAAK,EAAE,IAAI,CAAC,KAAK,EAAE,GAAG,EAAE,IAAI,CAAC,EAAE,EAAE,CAAA;QAEnD,OAAO;YACL,YAAY,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC;SAC5C,CAAA;IACH,CAAC;CACF,CAAA;AAtDY,kCAAW;sBAAX,WAAW;IADvB,IAAA,mBAAU,GAAE;;GACA,WAAW,CAsDvB","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\backend-gateway\\src\\auth\\auth.service.ts"],"sourcesContent":["// 文件路径: apps/backend-gateway/src/auth/auth.service.ts\n\nimport { ConflictException, Injectable, UnauthorizedException } from '@nestjs/common'\nimport type { JwtService } from '@nestjs/jwt'\nimport type { User } from '@prisma/client'\n// [核心修正] 放弃旧的 '@/' 别名，从 @tuheg/common-backend 导入共享的 PrismaService\nimport type { PrismaService } from '@tuheg/common-backend'\nimport * as bcryptjs from 'bcryptjs'\nimport type { LoginDto } from './dto/login.dto'\n// [注释] 导入DTO类型，确保数据结构一致\nimport type { RegisterDto } from './dto/register.dto'\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly jwtService: JwtService\n  ) {}\n\n  public async register(registerDto: RegisterDto): Promise<Omit<User, 'password'>> {\n    const { email, password } = registerDto\n\n    const existingUser = await this.prisma.user.findUnique({\n      where: { email },\n    })\n    if (existingUser) {\n      throw new ConflictException('Email already registered.')\n    }\n\n    const hashedPassword = await bcryptjs.hash(password, 10)\n\n    const user = await this.prisma.user.create({\n      data: {\n        email,\n        password: hashedPassword,\n      },\n    })\n\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    const { password: _, ...result } = user\n    return result\n  }\n\n  public async validateUser(email: string, pass: string): Promise<Omit<User, 'password'> | null> {\n    const user = await this.prisma.user.findUnique({ where: { email } })\n\n    // [还原] 使用 bcrypt.compare\n    if (user && (await bcryptjs.compare(pass, user.password))) {\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { password: _, ...result } = user\n      return result\n    }\n    return null\n  }\n  public async login(loginDto: LoginDto): Promise<{ access_token: string }> {\n    const user = await this.validateUser(loginDto.email, loginDto.password)\n\n    if (!user) {\n      throw new UnauthorizedException('Invalid credentials.')\n    }\n\n    const payload = { email: user.email, sub: user.id }\n\n    return {\n      access_token: this.jwtService.sign(payload),\n    }\n  }\n}\n"],"version":3}