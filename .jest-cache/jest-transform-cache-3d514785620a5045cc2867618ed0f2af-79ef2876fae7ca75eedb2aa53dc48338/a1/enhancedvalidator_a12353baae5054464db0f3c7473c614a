b4a7e6f6ec6cb29b2b8233b65795d2cc
"use strict";
// 文件路径: packages/common-backend/src/validation/enhanced-validator.ts
// 核心理念: 类型即文档，运行时验证，友好的错误消息
Object.defineProperty(exports, "__esModule", { value: true });
exports.EnhancedValidator = void 0;
const zod_1 = require("zod");
/**
 * @class EnhancedValidator
 * @description 增强的验证器，提供 Pydantic 风格的友好错误消息
 */
class EnhancedValidator {
    /**
     * @method validate
     * @description 验证数据
     * @param schema - Zod schema
     * @param data - 要验证的数据
     * @returns 验证结果
     */
    static validate(schema, data) {
        try {
            const parsed = schema.parse(data);
            return {
                success: true,
                data: parsed,
            };
        }
        catch (error) {
            if (error instanceof zod_1.z.ZodError) {
                return {
                    success: false,
                    errors: EnhancedValidator.formatZodErrors(error),
                };
            }
            return {
                success: false,
                errors: [
                    {
                        path: [],
                        message: error instanceof Error ? error.message : String(error),
                        code: 'UNKNOWN_ERROR',
                    },
                ],
            };
        }
    }
    /**
     * @method validateAsync
     * @description 异步验证数据（支持异步验证规则）
     * @param schema - Zod schema
     * @param data - 要验证的数据
     * @returns 验证结果 Promise
     */
    static async validateAsync(schema, data) {
        try {
            const parsed = await schema.parseAsync(data);
            return {
                success: true,
                data: parsed,
            };
        }
        catch (error) {
            if (error instanceof zod_1.z.ZodError) {
                return {
                    success: false,
                    errors: EnhancedValidator.formatZodErrors(error),
                };
            }
            return {
                success: false,
                errors: [
                    {
                        path: [],
                        message: error instanceof Error ? error.message : String(error),
                        code: 'UNKNOWN_ERROR',
                    },
                ],
            };
        }
    }
    /**
     * @method safeParse
     * @description 安全解析（不抛出异常）
     * @param schema - Zod schema
     * @param data - 要验证的数据
     * @returns 验证结果
     */
    static safeParse(schema, data) {
        const result = schema.safeParse(data);
        if (result.success) {
            return {
                success: true,
                data: result.data,
            };
        }
        return {
            success: false,
            errors: EnhancedValidator.formatZodErrors(result.error),
        };
    }
    /**
     * @method formatZodErrors
     * @description 格式化 Zod 错误为友好的错误消息
     */
    static formatZodErrors(error) {
        return error.errors.map((err) => {
            const validationError = {
                path: err.path,
                message: EnhancedValidator.formatErrorMessage(err),
                code: err.code,
            };
            // 添加类型信息
            if (err.code === 'invalid_type') {
                validationError.expected = err.expected;
                validationError.received = err.received;
            }
            // 添加约束信息
            if (err.code === 'too_small' || err.code === 'too_big') {
                const constraintErr = err;
                validationError.expected = `minimum: ${constraintErr.minimum ?? 'N/A'}, maximum: ${constraintErr.maximum ?? 'N/A'}`;
                validationError.received = constraintErr.received;
            }
            return validationError;
        });
    }
    /**
     * @method formatErrorMessage
     * @description 格式化错误消息，使其更友好
     */
    static formatErrorMessage(err) {
        const path = err.path.length > 0 ? err.path.join('.') : 'root';
        switch (err.code) {
            case 'invalid_type':
                return `${path}: 期望类型 "${err.expected}"，但收到类型 "${err.received}"`;
            case 'invalid_string':
                if (err.validation === 'email') {
                    return `${path}: 无效的电子邮件地址`;
                }
                if (err.validation === 'url') {
                    return `${path}: 无效的 URL`;
                }
                if (err.validation === 'uuid') {
                    return `${path}: 无效的 UUID`;
                }
                return `${path}: 字符串验证失败`;
            case 'too_small':
                if (err.type === 'string') {
                    return `${path}: 字符串长度至少为 ${err.minimum} 个字符`;
                }
                if (err.type === 'number') {
                    return `${path}: 数值必须大于或等于 ${err.minimum}`;
                }
                if (err.type === 'array') {
                    return `${path}: 数组至少需要 ${err.minimum} 个元素`;
                }
                return `${path}: 值太小（最小: ${err.minimum}）`;
            case 'too_big':
                if (err.type === 'string') {
                    return `${path}: 字符串长度不能超过 ${err.maximum} 个字符`;
                }
                if (err.type === 'number') {
                    return `${path}: 数值不能超过 ${err.maximum}`;
                }
                if (err.type === 'array') {
                    return `${path}: 数组最多只能包含 ${err.maximum} 个元素`;
                }
                return `${path}: 值太大（最大: ${err.maximum}）`;
            case 'invalid_enum_value':
                return `${path}: 无效的枚举值。允许的值: ${err.options?.join(', ') ?? 'N/A'}`;
            case 'invalid_literal':
                return `${path}: 必须是字面量值 "${err.expected}"`;
            case 'unrecognized_keys':
                return `${path}: 未知的键: ${err.keys.join(', ')}`;
            case 'invalid_union':
                return `${path}: 值不匹配任何联合类型选项`;
            case 'invalid_date':
                return `${path}: 无效的日期格式`;
            case 'custom':
                return err.message ?? `${path}: 自定义验证失败`;
            default:
                return err.message ?? `${path}: 验证失败`;
        }
    }
    /**
     * @method formatErrorsAsString
     * @description 将错误格式化为字符串（用于日志或用户消息）
     */
    static formatErrorsAsString(errors) {
        return errors
            .map((err) => {
            const path = err.path.length > 0 ? err.path.join('.') : 'root';
            let message = `${path}: ${err.message}`;
            if (err.expected) {
                message += ` (期望: ${err.expected})`;
            }
            if (err.received !== undefined) {
                message += ` (收到: ${JSON.stringify(err.received)})`;
            }
            return message;
        })
            .join('\n');
    }
}
exports.EnhancedValidator = EnhancedValidator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFx2YWxpZGF0aW9uXFxlbmhhbmNlZC12YWxpZGF0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHFFQUFxRTtBQUNyRSw0QkFBNEI7OztBQUc1Qiw2QkFBdUI7QUFrQ3ZCOzs7R0FHRztBQUNILE1BQWEsaUJBQWlCO0lBQzVCOzs7Ozs7T0FNRztJQUNJLE1BQU0sQ0FBQyxRQUFRLENBQUksTUFBb0IsRUFBRSxJQUFhO1FBQzNELElBQUksQ0FBQztZQUNILE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDakMsT0FBTztnQkFDTCxPQUFPLEVBQUUsSUFBSTtnQkFDYixJQUFJLEVBQUUsTUFBTTthQUNiLENBQUE7UUFDSCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksS0FBSyxZQUFZLE9BQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDaEMsT0FBTztvQkFDTCxPQUFPLEVBQUUsS0FBSztvQkFDZCxNQUFNLEVBQUUsaUJBQWlCLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQztpQkFDakQsQ0FBQTtZQUNILENBQUM7WUFFRCxPQUFPO2dCQUNMLE9BQU8sRUFBRSxLQUFLO2dCQUNkLE1BQU0sRUFBRTtvQkFDTjt3QkFDRSxJQUFJLEVBQUUsRUFBRTt3QkFDUixPQUFPLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQzt3QkFDL0QsSUFBSSxFQUFFLGVBQWU7cUJBQ3RCO2lCQUNGO2FBQ0YsQ0FBQTtRQUNILENBQUM7SUFDSCxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0ksTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQy9CLE1BQW9CLEVBQ3BCLElBQWE7UUFFYixJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0s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QUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ1gsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFBO1lBQzlELElBQUksT0FBTyxHQUFHLEdBQUcsSUFBSSxLQUFLLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtZQUV2QyxJQUFJLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDakIsT0FBTyxJQUFJLFNBQVMsR0FBRyxDQUFDLFFBQVEsR0FBRyxDQUFBO1lBQ3JDLENBQUM7WUFFRCxJQUFJLEdBQUcsQ0FBQyxRQUFRLEtBQUssU0FBUyxFQUFFLENBQUM7Z0JBQy9CLE9BQU8sSUFBSSxTQUFTLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUE7WUFDckQsQ0FBQztZQUVELE9BQU8sT0FBTyxDQUFBO1FBQ2hCLENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNmLENBQUM7Q0FDRjtBQTFORCw4Q0EwTkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFx2YWxpZGF0aW9uXFxlbmhhbmNlZC12YWxpZGF0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8g5paH5Lu26Lev5b6EOiBwYWNrYWdlcy9jb21tb24tYmFja2VuZC9zcmMvdmFsaWRhdGlvbi9lbmhhbmNlZC12YWxpZGF0b3IudHNcbi8vIOaguOW/g+eQhuW/tTog57G75Z6L5Y2z5paH5qGj77yM6L+Q6KGM5pe26aqM6K+B77yM5Y+L5aW955qE6ZSZ6K+v5raI5oGvXG5cbmltcG9ydCB0eXBlIHsgWm9kRXJyb3IsIFpvZFNjaGVtYSB9IGZyb20gJ3pvZCdcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnXG5cbi8qKlxuICogQGludGVyZmFjZSBWYWxpZGF0aW9uUmVzdWx0XG4gKiBAZGVzY3JpcHRpb24g6aqM6K+B57uT5p6cXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgVmFsaWRhdGlvblJlc3VsdDxUPiB7XG4gIC8qKiDpqozor4HmmK/lkKbmiJDlip8gKi9cbiAgc3VjY2VzczogYm9vbGVhblxuICAvKiog6aqM6K+B5ZCO55qE5pWw5o2u77yI5aaC5p6c5oiQ5Yqf77yJICovXG4gIGRhdGE/OiBUXG4gIC8qKiDpqozor4HplJnor6/vvIjlpoLmnpzlpLHotKXvvIkgKi9cbiAgZXJyb3JzPzogVmFsaWRhdGlvbkVycm9yW11cbn1cblxuLyoqXG4gKiBAaW50ZXJmYWNlIFZhbGlkYXRpb25FcnJvclxuICogQGRlc2NyaXB0aW9uIOmqjOivgemUmeivr+ivpuaDhVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFZhbGlkYXRpb25FcnJvciB7XG4gIC8qKiDlrZfmrrXot6/lvoQgKi9cbiAgcGF0aDogKHN0cmluZyB8IG51bWJlcilbXVxuICAvKiog6ZSZ6K+v5raI5oGvICovXG4gIG1lc3NhZ2U6IHN0cmluZ1xuICAvKiog6ZSZ6K+v5Luj56CBICovXG4gIGNvZGU6IHN0cmluZ1xuICAvKiog5pyf5pyb55qE57G75Z6L5oiW5YC8ICovXG4gIGV4cGVjdGVkPzogc3RyaW5nXG4gIC8qKiDlrp7pmYXmlLbliLDnmoTlgLwgKi9cbiAgcmVjZWl2ZWQ/OiB1bmtub3duXG4gIC8qKiDltYzlpZfplJnor6/vvIjlpoLmnpzmnInvvIkgKi9cbiAgbmVzdGVkPzogVmFsaWRhdGlvbkVycm9yW11cbn1cblxuLyoqXG4gKiBAY2xhc3MgRW5oYW5jZWRWYWxpZGF0b3JcbiAqIEBkZXNjcmlwdGlvbiDlop7lvLrnmoTpqozor4HlmajvvIzmj5DkvpsgUHlkYW50aWMg6aOO5qC855qE5Y+L5aW96ZSZ6K+v5raI5oGvXG4gKi9cbmV4cG9ydCBjbGFzcyBFbmhhbmNlZFZhbGlkYXRvciB7XG4gIC8qKlxuICAgKiBAbWV0aG9kIHZhbGlkYXRlXG4gICAqIEBkZXNjcmlwdGlvbiDpqozor4HmlbDmja5cbiAgICogQHBhcmFtIHNjaGVtYSAtIFpvZCBzY2hlbWFcbiAgICogQHBhcmFtIGRhdGEgLSDopoHpqozor4HnmoTmlbDmja5cbiAgICogQHJldHVybnMg6aqM6K+B57uT5p6cXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIHZhbGlkYXRlPFQ+KHNjaGVtYTogWm9kU2NoZW1hPFQ+LCBkYXRhOiB1bmtub3duKTogVmFsaWRhdGlvblJlc3VsdDxUPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhcnNlZCA9IHNjaGVtYS5wYXJzZShkYXRhKVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcGFyc2VkLFxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiB6LlpvZEVycm9yKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3JzOiBFbmhhbmNlZFZhbGlkYXRvci5mb3JtYXRab2RFcnJvcnMoZXJyb3IpLFxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBwYXRoOiBbXSxcbiAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICAgICAgIGNvZGU6ICdVTktOT1dOX0VSUk9SJyxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIHZhbGlkYXRlQXN5bmNcbiAgICogQGRlc2NyaXB0aW9uIOW8guatpemqjOivgeaVsOaNru+8iOaUr+aMgeW8guatpemqjOivgeinhOWIme+8iVxuICAgKiBAcGFyYW0gc2NoZW1hIC0gWm9kIHNjaGVtYVxuICAgKiBAcGFyYW0gZGF0YSAtIOimgemqjOivgeeahOaVsOaNrlxuICAgKiBAcmV0dXJucyDpqozor4Hnu5PmnpwgUHJvbWlzZVxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBhc3luYyB2YWxpZGF0ZUFzeW5jPFQ+KFxuICAgIHNjaGVtYTogWm9kU2NoZW1hPFQ+LFxuICAgIGRhdGE6IHVua25vd25cbiAgKTogUHJvbWlzZTxWYWxpZGF0aW9uUmVzdWx0PFQ+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhcnNlZCA9IGF3YWl0IHNjaGVtYS5wYXJzZUFzeW5jKGRhdGEpXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBwYXJzZWQsXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIHouWm9kRXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcnM6IEVuaGFuY2VkVmFsaWRhdG9yLmZvcm1hdFpvZEVycm9ycyhlcnJvciksXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHBhdGg6IFtdLFxuICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgICAgICAgY29kZTogJ1VOS05PV05fRVJST1InLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2Qgc2FmZVBhcnNlXG4gICAqIEBkZXNjcmlwdGlvbiDlronlhajop6PmnpDvvIjkuI3mipvlh7rlvILluLjvvIlcbiAgICogQHBhcmFtIHNjaGVtYSAtIFpvZCBzY2hlbWFcbiAgICogQHBhcmFtIGRhdGEgLSDopoHpqozor4HnmoTmlbDmja5cbiAgICogQHJldHVybnMg6aqM6K+B57uT5p6cXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIHNhZmVQYXJzZTxUPihzY2hlbWE6IFpvZFNjaGVtYTxUPiwgZGF0YTogdW5rbm93bik6IFZhbGlkYXRpb25SZXN1bHQ8VD4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IHNjaGVtYS5zYWZlUGFyc2UoZGF0YSlcblxuICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcmVzdWx0LmRhdGEsXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3JzOiBFbmhhbmNlZFZhbGlkYXRvci5mb3JtYXRab2RFcnJvcnMocmVzdWx0LmVycm9yKSxcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBmb3JtYXRab2RFcnJvcnNcbiAgICogQGRlc2NyaXB0aW9uIOagvOW8j+WMliBab2Qg6ZSZ6K+v5Li65Y+L5aW955qE6ZSZ6K+v5raI5oGvXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBmb3JtYXRab2RFcnJvcnMoZXJyb3I6IFpvZEVycm9yKTogVmFsaWRhdGlvbkVycm9yW10ge1xuICAgIHJldHVybiBlcnJvci5lcnJvcnMubWFwKChlcnIpID0+IHtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvcjogVmFsaWRhdGlvbkVycm9yID0ge1xuICAgICAgICBwYXRoOiBlcnIucGF0aCxcbiAgICAgICAgbWVzc2FnZTogRW5oYW5jZWRWYWxpZGF0b3IuZm9ybWF0RXJyb3JNZXNzYWdlKGVyciksXG4gICAgICAgIGNvZGU6IGVyci5jb2RlLFxuICAgICAgfVxuXG4gICAgICAvLyDmt7vliqDnsbvlnovkv6Hmga9cbiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ2ludmFsaWRfdHlwZScpIHtcbiAgICAgICAgdmFsaWRhdGlvbkVycm9yLmV4cGVjdGVkID0gZXJyLmV4cGVjdGVkXG4gICAgICAgIHZhbGlkYXRpb25FcnJvci5yZWNlaXZlZCA9IGVyci5yZWNlaXZlZFxuICAgICAgfVxuXG4gICAgICAvLyDmt7vliqDnuqbmnZ/kv6Hmga9cbiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ3Rvb19zbWFsbCcgfHwgZXJyLmNvZGUgPT09ICd0b29fYmlnJykge1xuICAgICAgICBjb25zdCBjb25zdHJhaW50RXJyID0gZXJyIGFzIHsgbWluaW11bT86IG51bWJlcjsgbWF4aW11bT86IG51bWJlcjsgcmVjZWl2ZWQ/OiB1bmtub3duIH1cbiAgICAgICAgdmFsaWRhdGlvbkVycm9yLmV4cGVjdGVkID0gYG1pbmltdW06ICR7Y29uc3RyYWludEVyci5taW5pbXVtID8/ICdOL0EnfSwgbWF4aW11bTogJHtjb25zdHJhaW50RXJyLm1heGltdW0gPz8gJ04vQSd9YFxuICAgICAgICB2YWxpZGF0aW9uRXJyb3IucmVjZWl2ZWQgPSBjb25zdHJhaW50RXJyLnJlY2VpdmVkXG4gICAgICB9XG5cbiAgICAgIHJldHVybiB2YWxpZGF0aW9uRXJyb3JcbiAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgZm9ybWF0RXJyb3JNZXNzYWdlXG4gICAqIEBkZXNjcmlwdGlvbiDmoLzlvI/ljJbplJnor6/mtojmga/vvIzkvb/lhbbmm7Tlj4vlpb1cbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGZvcm1hdEVycm9yTWVzc2FnZShlcnI6IHouWm9kSXNzdWUpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBhdGggPSBlcnIucGF0aC5sZW5ndGggPiAwID8gZXJyLnBhdGguam9pbignLicpIDogJ3Jvb3QnXG5cbiAgICBzd2l0Y2ggKGVyci5jb2RlKSB7XG4gICAgICBjYXNlICdpbnZhbGlkX3R5cGUnOlxuICAgICAgICByZXR1cm4gYCR7cGF0aH06IOacn+acm+exu+WeiyBcIiR7ZXJyLmV4cGVjdGVkfVwi77yM5L2G5pS25Yiw57G75Z6LIFwiJHtlcnIucmVjZWl2ZWR9XCJgXG5cbiAgICAgIGNhc2UgJ2ludmFsaWRfc3RyaW5nJzpcbiAgICAgICAgaWYgKGVyci52YWxpZGF0aW9uID09PSAnZW1haWwnKSB7XG4gICAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDml6DmlYjnmoTnlLXlrZDpgq7ku7blnLDlnYBgXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVyci52YWxpZGF0aW9uID09PSAndXJsJykge1xuICAgICAgICAgIHJldHVybiBgJHtwYXRofTog5peg5pWI55qEIFVSTGBcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXJyLnZhbGlkYXRpb24gPT09ICd1dWlkJykge1xuICAgICAgICAgIHJldHVybiBgJHtwYXRofTog5peg5pWI55qEIFVVSURgXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDlrZfnrKbkuLLpqozor4HlpLHotKVgXG5cbiAgICAgIGNhc2UgJ3Rvb19zbWFsbCc6XG4gICAgICAgIGlmIChlcnIudHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICByZXR1cm4gYCR7cGF0aH06IOWtl+espuS4sumVv+W6puiHs+WwkeS4uiAke2Vyci5taW5pbXVtfSDkuKrlrZfnrKZgXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVyci50eXBlID09PSAnbnVtYmVyJykge1xuICAgICAgICAgIHJldHVybiBgJHtwYXRofTog5pWw5YC85b+F6aG75aSn5LqO5oiW562J5LqOICR7ZXJyLm1pbmltdW19YFxuICAgICAgICB9XG4gICAgICAgIGlmIChlcnIudHlwZSA9PT0gJ2FycmF5Jykge1xuICAgICAgICAgIHJldHVybiBgJHtwYXRofTog5pWw57uE6Iez5bCR6ZyA6KaBICR7ZXJyLm1pbmltdW19IOS4quWFg+e0oGBcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYCR7cGF0aH06IOWAvOWkquWwj++8iOacgOWwjzogJHtlcnIubWluaW11bX3vvIlgXG5cbiAgICAgIGNhc2UgJ3Rvb19iaWcnOlxuICAgICAgICBpZiAoZXJyLnR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDlrZfnrKbkuLLplb/luqbkuI3og73otoXov4cgJHtlcnIubWF4aW11bX0g5Liq5a2X56ymYFxuICAgICAgICB9XG4gICAgICAgIGlmIChlcnIudHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICByZXR1cm4gYCR7cGF0aH06IOaVsOWAvOS4jeiDvei2hei/hyAke2Vyci5tYXhpbXVtfWBcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXJyLnR5cGUgPT09ICdhcnJheScpIHtcbiAgICAgICAgICByZXR1cm4gYCR7cGF0aH06IOaVsOe7hOacgOWkmuWPquiDveWMheWQqyAke2Vyci5tYXhpbXVtfSDkuKrlhYPntKBgXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDlgLzlpKrlpKfvvIjmnIDlpKc6ICR7ZXJyLm1heGltdW1977yJYFxuXG4gICAgICBjYXNlICdpbnZhbGlkX2VudW1fdmFsdWUnOlxuICAgICAgICByZXR1cm4gYCR7cGF0aH06IOaXoOaViOeahOaemuS4vuWAvOOAguWFgeiuuOeahOWAvDogJHtlcnIub3B0aW9ucz8uam9pbignLCAnKSA/PyAnTi9BJ31gXG5cbiAgICAgIGNhc2UgJ2ludmFsaWRfbGl0ZXJhbCc6XG4gICAgICAgIHJldHVybiBgJHtwYXRofTog5b+F6aG75piv5a2X6Z2i6YeP5YC8IFwiJHtlcnIuZXhwZWN0ZWR9XCJgXG5cbiAgICAgIGNhc2UgJ3VucmVjb2duaXplZF9rZXlzJzpcbiAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDmnKrnn6XnmoTplK46ICR7ZXJyLmtleXMuam9pbignLCAnKX1gXG5cbiAgICAgIGNhc2UgJ2ludmFsaWRfdW5pb24nOlxuICAgICAgICByZXR1cm4gYCR7cGF0aH06IOWAvOS4jeWMuemFjeS7u+S9leiBlOWQiOexu+Wei+mAiemhuWBcblxuICAgICAgY2FzZSAnaW52YWxpZF9kYXRlJzpcbiAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDml6DmlYjnmoTml6XmnJ/moLzlvI9gXG5cbiAgICAgIGNhc2UgJ2N1c3RvbSc6XG4gICAgICAgIHJldHVybiBlcnIubWVzc2FnZSA/PyBgJHtwYXRofTog6Ieq5a6a5LmJ6aqM6K+B5aSx6LSlYFxuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gZXJyLm1lc3NhZ2UgPz8gYCR7cGF0aH06IOmqjOivgeWksei0pWBcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBmb3JtYXRFcnJvcnNBc1N0cmluZ1xuICAgKiBAZGVzY3JpcHRpb24g5bCG6ZSZ6K+v5qC85byP5YyW5Li65a2X56ym5Liy77yI55So5LqO5pel5b+X5oiW55So5oi35raI5oGv77yJXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZvcm1hdEVycm9yc0FzU3RyaW5nKGVycm9yczogVmFsaWRhdGlvbkVycm9yW10pOiBzdHJpbmcge1xuICAgIHJldHVybiBlcnJvcnNcbiAgICAgIC5tYXAoKGVycikgPT4ge1xuICAgICAgICBjb25zdCBwYXRoID0gZXJyLnBhdGgubGVuZ3RoID4gMCA/IGVyci5wYXRoLmpvaW4oJy4nKSA6ICdyb290J1xuICAgICAgICBsZXQgbWVzc2FnZSA9IGAke3BhdGh9OiAke2Vyci5tZXNzYWdlfWBcblxuICAgICAgICBpZiAoZXJyLmV4cGVjdGVkKSB7XG4gICAgICAgICAgbWVzc2FnZSArPSBgICjmnJ/mnJs6ICR7ZXJyLmV4cGVjdGVkfSlgXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyLnJlY2VpdmVkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBtZXNzYWdlICs9IGAgKOaUtuWIsDogJHtKU09OLnN0cmluZ2lmeShlcnIucmVjZWl2ZWQpfSlgXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbWVzc2FnZVxuICAgICAgfSlcbiAgICAgIC5qb2luKCdcXG4nKVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=