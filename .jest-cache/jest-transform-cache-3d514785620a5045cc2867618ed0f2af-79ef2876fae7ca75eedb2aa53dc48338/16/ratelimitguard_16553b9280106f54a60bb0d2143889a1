4c609e2d9a4c040fbda270c48b714f8f
"use strict";
// 文件路径: packages/common-backend/src/rate-limit/rate-limit.guard.ts
// 核心理念: API 限流保护，防止滥用和过载
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var RateLimitGuard_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RateLimitGuard = exports.RateLimit = exports.RATE_LIMIT_KEY = void 0;
const common_1 = require("@nestjs/common");
/**
 * @constant RATE_LIMIT_KEY
 * @description 元数据键，用于存储限流配置
 */
exports.RATE_LIMIT_KEY = 'rate_limit';
/**
 * @decorator RateLimit
 * @description 限流装饰器
 *
 * @example
 * ```typescript
 * @RateLimit({ windowMs: 60, max: 100 })
 * @Get()
 * findAll() {
 *   return this.service.findAll();
 * }
 * ```
 */
const RateLimit = (options = {}) => {
    return (_target, _propertyKey, descriptor) => {
        Reflect.defineMetadata(exports.RATE_LIMIT_KEY, options, descriptor.value);
    };
};
exports.RateLimit = RateLimit;
/**
 * @guard RateLimitGuard
 * @description 限流守卫
 */
let RateLimitGuard = RateLimitGuard_1 = class RateLimitGuard {
    rateLimitService;
    reflector;
    logger = new common_1.Logger(RateLimitGuard_1.name);
    constructor(rateLimitService, reflector) {
        this.rateLimitService = rateLimitService;
        this.reflector = reflector;
    }
    async canActivate(context) {
        const request = context.switchToHttp().getRequest();
        const response = context.switchToHttp().getResponse();
        // 获取限流配置
        const options = this.reflector.get(exports.RATE_LIMIT_KEY, context.getHandler()) || {
            windowMs: 60, // 默认 60 秒
            max: 100, // 默认 100 次请求
        };
        // 生成限流键
        const keyGenerator = options.keyGenerator || this.defaultKeyGenerator;
        const key = keyGenerator(request);
        // 检查限流
        const result = await this.rateLimitService.checkLimit(key, {
            windowMs: options.windowMs,
            max: options.max,
        });
        // 设置限流响应头
        response.setHeader('X-RateLimit-Limit', options.max);
        response.setHeader('X-RateLimit-Remaining', result.remaining);
        response.setHeader('X-RateLimit-Reset', result.resetTime);
        if (!result.allowed) {
            const message = options.message ||
                `Rate limit exceeded. Try again in ${Math.ceil(result.retryAfter / 1000)} seconds.`;
            this.logger.warn(`Rate limit exceeded for key: ${key}, remaining: ${result.remaining}`);
            throw new common_1.HttpException({
                statusCode: common_1.HttpStatus.TOO_MANY_REQUESTS,
                message,
                retryAfter: Math.ceil(result.retryAfter / 1000),
            }, common_1.HttpStatus.TOO_MANY_REQUESTS);
        }
        return true;
    }
    /**
     * @method defaultKeyGenerator
     * @description 默认限流键生成器（基于 IP 和用户 ID）
     */
    defaultKeyGenerator(request) {
        const ip = request.ip || request.socket.remoteAddress || 'unknown';
        const userId = request.user?.id || 'anonymous';
        const path = request.path;
        return `rate_limit:${ip}:${userId}:${path}`;
    }
};
exports.RateLimitGuard = RateLimitGuard;
exports.RateLimitGuard = RateLimitGuard = RateLimitGuard_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object, Object])
], RateLimitGuard);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxyYXRlLWxpbWl0XFxyYXRlLWxpbWl0Lmd1YXJkLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxtRUFBbUU7QUFDbkUseUJBQXlCOzs7Ozs7Ozs7Ozs7O0FBRXpCLDJDQU91QjtBQUt2Qjs7O0dBR0c7QUFDVSxRQUFBLGNBQWMsR0FBRyxZQUFZLENBQUE7QUFxQjFDOzs7Ozs7Ozs7Ozs7R0FZRztBQUNJLE1BQU0sU0FBUyxHQUFHLENBQUMsVUFBaUMsRUFBRSxFQUFFLEVBQUU7SUFDL0QsT0FBTyxDQUFDLE9BQWdCLEVBQUUsWUFBb0IsRUFBRSxVQUE4QixFQUFFLEVBQUU7UUFDaEYsT0FBTyxDQUFDLGNBQWMsQ0FBQyxzQkFBYyxFQUFFLE9BQU8sRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDbkUsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBSlksUUFBQSxTQUFTLGFBSXJCO0FBRUQ7OztHQUdHO0FBRUksSUFBTSxjQUFjLHNCQUFwQixNQUFNLGNBQWM7SUFJTjtJQUNBO0lBSkYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGdCQUFjLENBQUMsSUFBSSxDQUFDLENBQUE7SUFFekQsWUFDbUIsZ0JBQWtDLEVBQ2xDLFNBQW9CO1FBRHBCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsY0FBUyxHQUFULFNBQVMsQ0FBVztJQUNwQyxDQUFDO0lBRUosS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUF5QjtRQUN6QyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsVUFBVSxFQUFXLENBQUE7UUFDNUQsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDLFdBQVcsRUFBWSxDQUFBO1FBRS9ELFNBQVM7UUFDVCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FDaEMsc0JBQWMsRUFDZCxPQUFPLENBQUMsVUFBVSxFQUFFLENBQ3JCLElBQUk7WUFDSCxRQUFRLEVBQUUsRUFBRSxFQUFFLFVBQVU7WUFDeEIsR0FBRyxFQUFFLEdBQUcsRUFBRSxhQUFhO1NBQ3hCLENBQUE7UUFFRCxRQUFRO1FBQ1IsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUE7UUFDckUsTUFBTSxHQUFHLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWpDLE9BQU87UUFDUCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ3pELFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUztZQUMzQixHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUk7U0FDbEIsQ0FBQyxDQUFBO1FBRUYsVUFBVTtRQUNWLFFBQVEsQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsT0FBTyxDQUFDLEdBQUksQ0FBQyxDQUFBO1FBQ3JELFFBQVEsQ0FBQyxTQUFTLENBQUMsdUJBQXVCLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQzdELFFBQVEsQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBRXpELElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDcEIsTUFBTSxPQUFPLEdBQ1gsT0FBTyxDQUFDLE9BQU87Z0JBQ2YscUNBQXFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFBO1lBRXJGLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGdDQUFnQyxHQUFHLGdCQUFnQixNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQTtZQUV2RixNQUFNLElBQUksc0JBQWEsQ0FDckI7Z0JBQ0UsVUFBVSxFQUFFLG1CQUFVLENBQUMsaUJBQWlCO2dCQUN4QyxPQUFPO2dCQUNQLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO2FBQ2hELEVBQ0QsbUJBQVUsQ0FBQyxpQkFBaUIsQ0FDN0IsQ0FBQTtRQUNILENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFFRDs7O09BR0c7SUFDSyxtQkFBbUIsQ0FBQyxPQUFnQjtRQUMxQyxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUMsRUFBRSxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsYUFBYSxJQUFJLFNBQVMsQ0FBQTtRQUNsRSxNQUFNLE1BQU0sR0FBSSxPQUFzQyxDQUFDLElBQUksRUFBRSxFQUFFLElBQUksV0FBVyxDQUFBO1FBQzlFLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUE7UUFDekIsT0FBTyxjQUFjLEVBQUUsSUFBSSxNQUFNLElBQUksSUFBSSxFQUFFLENBQUE7SUFDN0MsQ0FBQztDQUNGLENBQUE7QUFsRVksd0NBQWM7eUJBQWQsY0FBYztJQUQxQixJQUFBLG1CQUFVLEdBQUU7O0dBQ0EsY0FBYyxDQWtFMUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxyYXRlLWxpbWl0XFxyYXRlLWxpbWl0Lmd1YXJkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL3JhdGUtbGltaXQvcmF0ZS1saW1pdC5ndWFyZC50c1xuLy8g5qC45b+D55CG5b+1OiBBUEkg6ZmQ5rWB5L+d5oqk77yM6Ziy5q2i5rul55So5ZKM6L+H6L29XG5cbmltcG9ydCB7XG4gIHR5cGUgQ2FuQWN0aXZhdGUsXG4gIHR5cGUgRXhlY3V0aW9uQ29udGV4dCxcbiAgSHR0cEV4Y2VwdGlvbixcbiAgSHR0cFN0YXR1cyxcbiAgSW5qZWN0YWJsZSxcbiAgTG9nZ2VyLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbidcbmltcG9ydCB0eXBlIHsgUmVmbGVjdG9yIH0gZnJvbSAnQG5lc3Rqcy9jb3JlJ1xuaW1wb3J0IHR5cGUgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnXG5pbXBvcnQgdHlwZSB7IFJhdGVMaW1pdFNlcnZpY2UgfSBmcm9tICcuL3JhdGUtbGltaXQuc2VydmljZSdcblxuLyoqXG4gKiBAY29uc3RhbnQgUkFURV9MSU1JVF9LRVlcbiAqIEBkZXNjcmlwdGlvbiDlhYPmlbDmja7plK7vvIznlKjkuo7lrZjlgqjpmZDmtYHphY3nva5cbiAqL1xuZXhwb3J0IGNvbnN0IFJBVEVfTElNSVRfS0VZID0gJ3JhdGVfbGltaXQnXG5cbi8qKlxuICogQGludGVyZmFjZSBSYXRlTGltaXRPcHRpb25zXG4gKiBAZGVzY3JpcHRpb24g6ZmQ5rWB6YCJ6aG5XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUmF0ZUxpbWl0R3VhcmRPcHRpb25zIHtcbiAgLyoqIOaXtumXtOeql+WPo++8iOenku+8iSAqL1xuICB3aW5kb3dNcz86IG51bWJlclxuICAvKiog5pyA5aSn6K+35rGC5pWwICovXG4gIG1heD86IG51bWJlclxuICAvKiog6ZmQ5rWB6ZSu55Sf5oiQ5ZmoICovXG4gIGtleUdlbmVyYXRvcj86IChyZXF1ZXN0OiBSZXF1ZXN0KSA9PiBzdHJpbmdcbiAgLyoqIOaYr+WQpui3s+i/h+aIkOWKn+ivt+axgiAqL1xuICBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzPzogYm9vbGVhblxuICAvKiog5piv5ZCm6Lez6L+H5aSx6LSl6K+35rGCICovXG4gIHNraXBGYWlsZWRSZXF1ZXN0cz86IGJvb2xlYW5cbiAgLyoqIOiHquWumuS5iemUmeivr+a2iOaBryAqL1xuICBtZXNzYWdlPzogc3RyaW5nXG59XG5cbi8qKlxuICogQGRlY29yYXRvciBSYXRlTGltaXRcbiAqIEBkZXNjcmlwdGlvbiDpmZDmtYHoo4XppbDlmahcbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogQFJhdGVMaW1pdCh7IHdpbmRvd01zOiA2MCwgbWF4OiAxMDAgfSlcbiAqIEBHZXQoKVxuICogZmluZEFsbCgpIHtcbiAqICAgcmV0dXJuIHRoaXMuc2VydmljZS5maW5kQWxsKCk7XG4gKiB9XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGNvbnN0IFJhdGVMaW1pdCA9IChvcHRpb25zOiBSYXRlTGltaXRHdWFyZE9wdGlvbnMgPSB7fSkgPT4ge1xuICByZXR1cm4gKF90YXJnZXQ6IHVua25vd24sIF9wcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBQcm9wZXJ0eURlc2NyaXB0b3IpID0+IHtcbiAgICBSZWZsZWN0LmRlZmluZU1ldGFkYXRhKFJBVEVfTElNSVRfS0VZLCBvcHRpb25zLCBkZXNjcmlwdG9yLnZhbHVlKVxuICB9XG59XG5cbi8qKlxuICogQGd1YXJkIFJhdGVMaW1pdEd1YXJkXG4gKiBAZGVzY3JpcHRpb24g6ZmQ5rWB5a6I5Y2rXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSYXRlTGltaXRHdWFyZCBpbXBsZW1lbnRzIENhbkFjdGl2YXRlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFJhdGVMaW1pdEd1YXJkLm5hbWUpXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSByYXRlTGltaXRTZXJ2aWNlOiBSYXRlTGltaXRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVmbGVjdG9yOiBSZWZsZWN0b3JcbiAgKSB7fVxuXG4gIGFzeW5jIGNhbkFjdGl2YXRlKGNvbnRleHQ6IEV4ZWN1dGlvbkNvbnRleHQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gY29udGV4dC5zd2l0Y2hUb0h0dHAoKS5nZXRSZXF1ZXN0PFJlcXVlc3Q+KClcbiAgICBjb25zdCByZXNwb25zZSA9IGNvbnRleHQuc3dpdGNoVG9IdHRwKCkuZ2V0UmVzcG9uc2U8UmVzcG9uc2U+KClcblxuICAgIC8vIOiOt+WPlumZkOa1gemFjee9rlxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnJlZmxlY3Rvci5nZXQ8UmF0ZUxpbWl0R3VhcmRPcHRpb25zPihcbiAgICAgIFJBVEVfTElNSVRfS0VZLFxuICAgICAgY29udGV4dC5nZXRIYW5kbGVyKClcbiAgICApIHx8IHtcbiAgICAgIHdpbmRvd01zOiA2MCwgLy8g6buY6K6kIDYwIOenklxuICAgICAgbWF4OiAxMDAsIC8vIOm7mOiupCAxMDAg5qyh6K+35rGCXG4gICAgfVxuXG4gICAgLy8g55Sf5oiQ6ZmQ5rWB6ZSuXG4gICAgY29uc3Qga2V5R2VuZXJhdG9yID0gb3B0aW9ucy5rZXlHZW5lcmF0b3IgfHwgdGhpcy5kZWZhdWx0S2V5R2VuZXJhdG9yXG4gICAgY29uc3Qga2V5ID0ga2V5R2VuZXJhdG9yKHJlcXVlc3QpXG5cbiAgICAvLyDmo4Dmn6XpmZDmtYFcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnJhdGVMaW1pdFNlcnZpY2UuY2hlY2tMaW1pdChrZXksIHtcbiAgICAgIHdpbmRvd01zOiBvcHRpb25zLndpbmRvd01zISxcbiAgICAgIG1heDogb3B0aW9ucy5tYXghLFxuICAgIH0pXG5cbiAgICAvLyDorr7nva7pmZDmtYHlk43lupTlpLRcbiAgICByZXNwb25zZS5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LUxpbWl0Jywgb3B0aW9ucy5tYXghKVxuICAgIHJlc3BvbnNlLnNldEhlYWRlcignWC1SYXRlTGltaXQtUmVtYWluaW5nJywgcmVzdWx0LnJlbWFpbmluZylcbiAgICByZXNwb25zZS5zZXRIZWFkZXIoJ1gtUmF0ZUxpbWl0LVJlc2V0JywgcmVzdWx0LnJlc2V0VGltZSlcblxuICAgIGlmICghcmVzdWx0LmFsbG93ZWQpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPVxuICAgICAgICBvcHRpb25zLm1lc3NhZ2UgfHxcbiAgICAgICAgYFJhdGUgbGltaXQgZXhjZWVkZWQuIFRyeSBhZ2FpbiBpbiAke01hdGguY2VpbChyZXN1bHQucmV0cnlBZnRlciAvIDEwMDApfSBzZWNvbmRzLmBcblxuICAgICAgdGhpcy5sb2dnZXIud2FybihgUmF0ZSBsaW1pdCBleGNlZWRlZCBmb3Iga2V5OiAke2tleX0sIHJlbWFpbmluZzogJHtyZXN1bHQucmVtYWluaW5nfWApXG5cbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKFxuICAgICAgICB7XG4gICAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1cy5UT09fTUFOWV9SRVFVRVNUUyxcbiAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgIHJldHJ5QWZ0ZXI6IE1hdGguY2VpbChyZXN1bHQucmV0cnlBZnRlciAvIDEwMDApLFxuICAgICAgICB9LFxuICAgICAgICBIdHRwU3RhdHVzLlRPT19NQU5ZX1JFUVVFU1RTXG4gICAgICApXG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGRlZmF1bHRLZXlHZW5lcmF0b3JcbiAgICogQGRlc2NyaXB0aW9uIOm7mOiupOmZkOa1gemUrueUn+aIkOWZqO+8iOWfuuS6jiBJUCDlkoznlKjmiLcgSUTvvIlcbiAgICovXG4gIHByaXZhdGUgZGVmYXVsdEtleUdlbmVyYXRvcihyZXF1ZXN0OiBSZXF1ZXN0KTogc3RyaW5nIHtcbiAgICBjb25zdCBpcCA9IHJlcXVlc3QuaXAgfHwgcmVxdWVzdC5zb2NrZXQucmVtb3RlQWRkcmVzcyB8fCAndW5rbm93bidcbiAgICBjb25zdCB1c2VySWQgPSAocmVxdWVzdCBhcyB7IHVzZXI/OiB7IGlkPzogc3RyaW5nIH0gfSkudXNlcj8uaWQgfHwgJ2Fub255bW91cydcbiAgICBjb25zdCBwYXRoID0gcmVxdWVzdC5wYXRoXG4gICAgcmV0dXJuIGByYXRlX2xpbWl0OiR7aXB9OiR7dXNlcklkfToke3BhdGh9YFxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=