{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\__tests__\\logic.service.integration.spec.ts","mappings":";AAAA,iFAAiF;;AA6BjF,gDAAgD;AAChD,IAAI,CAAC,IAAI,CAAC,uBAAuB,EAAE,GAAG,EAAE,CAAC,CAAC;IACxC,GAAG,IAAI,CAAC,aAAa,CAAC,uBAAuB,CAAC,EAAE,WAAW;IAC3D,eAAe,EAAE,IAAI,CAAC,EAAE,EAAE,EAAE,oCAAoC;CACjE,CAAC,CAAC,CAAA;AA9BH,2CAAkF;AAClF,6CAA0D;AAE1D,0DAW8B;AAC9B,2DAAyD;AACzD,mDAA8C;AAC9C,+DAAyD;AAEzD,uBAAuB;AACvB,MAAM,gBAAiB,SAAQ,4BAAY;IAClC,KAAK,CAAC,sBAAsB,CAAC,OAA0B,EAAE,IAAS;QACvE,OAAO,IAAI,CAAC,kBAAkB,CAAC,OAAO,EAAE,IAAI,CAAC,CAAA;IAC/C,CAAC;CACF;AAQD,QAAQ,CAAC,4BAA4B,EAAE,GAAG,EAAE;IAC1C,IAAI,OAAyB,CAAA;IAC7B,IAAI,aAAmD,CAAA;IACvD,IAAI,iBAAkD,CAAA;IACtD,IAAI,wBAAyD,CAAA;IAC7D,IAAI,mBAA+C,CAAA;IACnD,IAAI,cAA4C,CAAA;IAChD,IAAI,YAAwC,CAAA;IAE5C,cAAc;IACd,MAAM,qBAAqB,GAAG,gCAA4B,CAAA;IAE1D,MAAM,eAAe,GAAG,EAA8B,CAAA;IACtD,kCAAkC;IAClC,MAAM,aAAa,GAAsB;QACvC,MAAM,EAAE,UAAU;QAClB,MAAM,EAAE,UAAU;QAClB,YAAY,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE,OAAO,EAAE,mBAAmB,EAAE;QAC/D,iBAAiB,EAAE;YACjB,EAAE,EAAE,UAAU;YACd,IAAI,EAAE,WAAW;YACjB,OAAO,EAAE,UAAU;YACnB,SAAS,EAAE,IAAI,IAAI,EAAE;YACrB,SAAS,EAAE,IAAI,IAAI,EAAE;YACrB,SAAS,EAAE,IAAI;YACf,SAAS,EAAE,EAAE;SACd;QACD,aAAa,EAAE,qCAAqC,EAAE,YAAY;KACnE,CAAA;IAED,MAAM,eAAe,GAAiB;QACpC,EAAE,EAAE,EAAE,kBAAkB,EAAE,QAAQ,EAAE,QAAQ,EAAE,OAAO,EAAE,EAAE,EAAE;KAC5D,CAAA;IAED,MAAM,iBAAiB,GAA+B;QACpD,OAAO,EAAE,IAAI;QACb,KAAK,EAAE,GAAG;QACV,SAAS,EAAE,IAAI;QACf,MAAM,EAAE,QAAQ;KACjB,CAAA;IAED,UAAU,CAAC,KAAK,IAAI,EAAE;QACpB,sCAAsC;QACtC,aAAa,GAAG,IAAA,yBAAI,GAA6B,CAAA;QACjD,iBAAiB,GAAG,IAAA,yBAAI,GAAwB,CAAA;QAChD,wBAAwB,GAAG,IAAA,yBAAI,GAAwB,CAAA;QACvD,wBAAwB,CAAC,UAAU,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,CAAA;QACxE,wBAAwB,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,SAAS,CAAC,CAAA;QACvE,mBAAmB,GAAG,IAAA,yBAAI,GAAmB,CAAA;QAC7C,cAAc,GAAG,IAAA,yBAAI,GAAqB,CAAA;QAC1C,YAAY,GAAG,IAAA,yBAAI,GAAmB,CAAA;QACtC,mBAAmB,CAAC,WAAW,CAAC,iBAAiB,CAAC;YAChD,EAAE,EAAE,eAAe;YACnB,IAAI,EAAE,YAAY;YAClB,QAAQ,EAAE,EAAE;SACb,CAAC,CAAA;QACF,mBAAmB,CAAC,UAAU,CAAC,iBAAiB,CAAC;YAC/C,EAAE,EAAE,cAAc;YAClB,IAAI,EAAE,WAAW;YACjB,OAAO,EAAE,eAAe;YACxB,SAAS,EAAE,IAAI,IAAI,EAAE;YACrB,QAAQ,EAAE,EAAE;SACb,CAAC,CAAA;QACF,mBAAmB,CAAC,aAAa,CAAC,iBAAiB,CAAC,SAAS,CAAC,CAAA;QAC9D,mBAAmB,CAAC,KAAK,CAAC,iBAAiB,CAAC,SAAS,CAAC,CAAA;QACtD,mBAAmB,CAAC,SAAS,CAAC,eAAe,CAAC,KAAK,CAAC,CAAA;QAEpD,MAAM,MAAM,GAAkB,MAAM,cAAI,CAAC,mBAAmB,CAAC;YAC3D,SAAS,EAAE;gBACT,gBAAgB;gBAChB,kBAAkB;gBAClB,EAAE,OAAO,EAAE,0CAAyB,EAAE,QAAQ,EAAE,aAAa,EAAE;gBAC/D,EAAE,OAAO,EAAE,qCAAoB,EAAE,QAAQ,EAAE,iBAAiB,EAAE;gBAC9D,EAAE,OAAO,EAAE,gCAAe,EAAE,QAAQ,EAAE,mBAAmB,EAAE;gBAC3D,EAAE,OAAO,EAAE,qCAAoB,EAAE,QAAQ,EAAE,wBAAwB,EAAE;gBACrE,EAAE,OAAO,EAAE,uCAAiB,EAAE,QAAQ,EAAE,cAAc,EAAE;gBACxD,EAAE,OAAO,EAAE,gCAAe,EAAE,QAAQ,EAAE,YAAY,EAAE;aACrD;SACF,CAAC,CAAC,OAAO,EAAE,CAAA;QAEZ,OAAO,GAAG,MAAM,CAAC,GAAG,CAAmB,gBAAgB,CAAC,CAAA;IAC1D,CAAC,CAAC,CAAA;IAEF,SAAS,CAAC,GAAG,EAAE;QACb,eAAe;QACf,IAAI,CAAC,aAAa,EAAE,CAAA;IACtB,CAAC,CAAC,CAAA;IAEF,EAAE,CAAC,mBAAmB,EAAE,GAAG,EAAE;QAC3B,MAAM,CAAC,OAAO,CAAC,CAAC,WAAW,EAAE,CAAA;IAC/B,CAAC,CAAC,CAAA;IAEF,QAAQ,CAAC,6CAA6C,EAAE,GAAG,EAAE;QAC3D,UAAU,CAAC,GAAG,EAAE;YACd,cAAc;YACd,aAAa,CAAC,kBAAkB,CAAC,iBAAiB,CAAC;gBACjD,KAAK,EAAE,eAAe;aACvB,CAAC,CAAA;YACF,iBAAiB,CAAC,SAAS,CAAC,eAAe,CAAC,0BAA0B,CAAC,CAAA;YACvE,qBAAqB,CAAC,iBAAiB,CAAC,eAAe,CAAC,CAAA;QAC1D,CAAC,CAAC,CAAA;QAEF,EAAE,CAAC,wEAAwE,EAAE,KAAK,IAAI,EAAE;YACtF,WAAW;YACX,MAAM,QAAQ,GAAG,EAAE,EAAE,EAAE,aAAa,CAAC,MAAM,EAAS,CAAA;YACpD,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,sBAAsB,CAAC,aAAa,EAAE,QAAQ,CAAC,CAAA;YAE5E,UAAU;YACV,MAAM,CAAC,wBAAwB,CAAC,UAAU,CAAC,CAAC,oBAAoB,CAC9D,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,YAAY,CAAC,EAC1C;gBACE,MAAM,EAAE,aAAa,CAAC,MAAM;gBAC5B,aAAa,EAAE,aAAa,CAAC,aAAa;aAC3C,CACF,CAAA;YACD,MAAM,CAAC,aAAa,CAAC,kBAAkB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAA;YACjE,MAAM,CAAC,aAAa,CAAC,kBAAkB,CAAC,CAAC,oBAAoB,CAC3D,EAAE,EAAE,EAAE,aAAa,CAAC,MAAM,EAAU,EACpC,eAAe,CAChB,CAAA;YAED,MAAM,CAAC,iBAAiB,CAAC,SAAS,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAA;YAC5D,MAAM,CAAC,iBAAiB,CAAC,SAAS,CAAC,CAAC,oBAAoB,CAAC,oBAAoB,CAAC,CAAA;YAE9E,MAAM,CAAC,qBAAqB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAA;YAEtD,MAAM,WAAW,GAAG,qBAAqB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAA;YACvD,MAAM,MAAM,GAAG,WAAW,CAAC,CAAC,CAAC,CAAA;YAC7B,MAAM,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,IAAI,CAAC,0BAA0B,CAAC,CAAA;YAC7D,MAAM,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,iBAAiB,CAAC,CAAC,CAAA;YAC/E,MAAM,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,YAAY,CAAC,CAAC,CAAA;YAE7E,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,eAAe,CAAC,CAAA;QACzC,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;IAEF,QAAQ,CAAC,kCAAkC,EAAE,GAAG,EAAE;QAChD,EAAE,CAAC,yEAAyE,EAAE,KAAK,IAAI,EAAE;YACvF,MAAM,OAAO,GAAG,IAAI,sCAAqB,CAAC,sBAAsB,EAAE,EAAE,CAAC,CAAA;YAErE,aAAa,CAAC,kBAAkB,CAAC,iBAAiB,CAAC;gBACjD,KAAK,EAAE,eAAe;aACvB,CAAC,CAAA;YACF,iBAAiB,CAAC,SAAS,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAA;YACrD,qBAAqB,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAA;YAEhD,MAAM,QAAQ,GAAG,EAAE,EAAE,EAAE,aAAa,CAAC,MAAM,EAAS,CAAA;YACpD,MAAM,MAAM,CAAC,OAAO,CAAC,sBAAsB,CAAC,aAAa,EAAE,QAAQ,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CACnF,qCAA4B,CAC7B,CAAA;QACH,CAAC,CAAC,CAAA;QAEF,EAAE,CAAC,2EAA2E,EAAE,KAAK,IAAI,EAAE;YACzF,wBAAwB,CAAC,UAAU,CAAC,qBAAqB,CAAC;gBACxD,OAAO,EAAE,KAAK;gBACd,KAAK,EAAE,IAAI;gBACX,SAAS,EAAE,IAAI;gBACf,MAAM,EAAE,oBAAoB;aAC7B,CAAC,CAAA;YAEF,MAAM,QAAQ,GAAG,EAAE,EAAE,EAAE,aAAa,CAAC,MAAM,EAAS,CAAA;YACpD,MAAM,MAAM,CAAC,OAAO,CAAC,sBAAsB,CAAC,aAAa,EAAE,QAAQ,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CACnF,4BAAmB,CACpB,CAAA;YACD,MAAM,CAAC,qBAAqB,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAA;QACtD,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;AACJ,CAAC,CAAC,CAAA","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\__tests__\\logic.service.integration.spec.ts"],"sourcesContent":["// 文件路径: apps/logic-agent/src/__tests__/logic.service.integration.spec.ts (真正完整版)\n\nimport type { BaseChatModel } from '@langchain/core/language_models/chat_models'\nimport { BadRequestException, InternalServerErrorException } from '@nestjs/common'\nimport { Test, type TestingModule } from '@nestjs/testing'\nimport type { User } from '@prisma/client'\nimport {\n  AiGenerationException,\n  callAiWithGuard,\n  type DirectiveSet,\n  DynamicAiSchedulerService,\n  EventBusService,\n  type GameActionJobData,\n  LangfuseService,\n  type PromptInjectionCheckResult,\n  PromptInjectionGuard,\n  PromptManagerService,\n} from '@tuheg/common-backend'\nimport { type MockProxy, mock } from 'jest-mock-extended'\nimport { LogicService } from './logic.service'\nimport { RuleEngineService } from './rule-engine.service'\n\n// 测试子类，用于访问protected方法\nclass TestLogicService extends LogicService {\n  public async testGenerateDirectives(jobData: GameActionJobData, user: any) {\n    return this.generateDirectives(jobData, user)\n  }\n}\n\n// 模拟 @tuheg/common-backend, 只替换 callAiWithGuard\njest.mock('@tuheg/common-backend', () => ({\n  ...jest.requireActual('@tuheg/common-backend'), // 保留所有真实导出\n  callAiWithGuard: jest.fn(), // 将 callAiWithGuard 替换为一个 Jest 模拟函数\n}))\n\ndescribe('LogicService (Integration)', () => {\n  let service: TestLogicService\n  let schedulerMock: MockProxy<DynamicAiSchedulerService>\n  let promptManagerMock: MockProxy<PromptManagerService>\n  let promptInjectionGuardMock: MockProxy<PromptInjectionGuard>\n  let langfuseServiceMock: MockProxy<LangfuseService>\n  let ruleEngineMock: MockProxy<RuleEngineService>\n  let eventBusMock: MockProxy<EventBusService>\n\n  // 将模拟函数进行类型转换\n  const mockedCallAiWithGuard = callAiWithGuard as jest.Mock\n\n  const MOCK_CHAT_MODEL = {} as unknown as BaseChatModel\n  // [核心修复] 为模拟数据补上 correlationId 字段\n  const MOCK_JOB_DATA: GameActionJobData = {\n    gameId: 'game-123',\n    userId: 'user-abc',\n    playerAction: { type: 'command', payload: 'Attack the goblin' },\n    gameStateSnapshot: {\n      id: 'game-123',\n      name: 'Mock Game',\n      ownerId: 'user-abc',\n      createdAt: new Date(),\n      updatedAt: new Date(),\n      character: null,\n      worldBook: [],\n    },\n    correlationId: 'test-correlation-id-integration-456', // <-- 加上这一行\n  }\n\n  const MOCK_DIRECTIVES: DirectiveSet = [\n    { op: 'update_character', targetId: 'player', payload: {} },\n  ]\n\n  const SAFE_GUARD_RESULT: PromptInjectionCheckResult = {\n    allowed: true,\n    score: 0.1,\n    threshold: 0.75,\n    reason: 'passed',\n  }\n\n  beforeEach(async () => {\n    // 使用 jest-mock-extended 创建所有依赖的深度模拟对象\n    schedulerMock = mock<DynamicAiSchedulerService>()\n    promptManagerMock = mock<PromptManagerService>()\n    promptInjectionGuardMock = mock<PromptInjectionGuard>()\n    promptInjectionGuardMock.checkInput.mockResolvedValue(SAFE_GUARD_RESULT)\n    promptInjectionGuardMock.ensureSafeOrThrow.mockResolvedValue(undefined)\n    langfuseServiceMock = mock<LangfuseService>()\n    ruleEngineMock = mock<RuleEngineService>()\n    eventBusMock = mock<EventBusService>()\n    langfuseServiceMock.createTrace.mockResolvedValue({\n      id: 'mock-trace-id',\n      name: 'mock-trace',\n      metadata: {},\n    })\n    langfuseServiceMock.createSpan.mockResolvedValue({\n      id: 'mock-span-id',\n      name: 'mock-span',\n      traceId: 'mock-trace-id',\n      startTime: new Date(),\n      metadata: {},\n    })\n    langfuseServiceMock.logGeneration.mockResolvedValue(undefined)\n    langfuseServiceMock.flush.mockResolvedValue(undefined)\n    langfuseServiceMock.isEnabled.mockReturnValue(false)\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        TestLogicService,\n        // 为所有依赖项提供我们的模拟实例\n        { provide: DynamicAiSchedulerService, useValue: schedulerMock },\n        { provide: PromptManagerService, useValue: promptManagerMock },\n        { provide: LangfuseService, useValue: langfuseServiceMock },\n        { provide: PromptInjectionGuard, useValue: promptInjectionGuardMock },\n        { provide: RuleEngineService, useValue: ruleEngineMock },\n        { provide: EventBusService, useValue: eventBusMock },\n      ],\n    }).compile()\n\n    service = module.get<TestLogicService>(TestLogicService)\n  })\n\n  afterEach(() => {\n    // 在每个测试后重置所有模拟\n    jest.clearAllMocks()\n  })\n\n  it('should be defined', () => {\n    expect(service).toBeDefined()\n  })\n\n  describe('Happy Path: Successful Directive Generation', () => {\n    beforeEach(() => {\n      // 预设所有模拟依赖的行为\n      schedulerMock.getProviderForRole.mockResolvedValue({\n        model: MOCK_CHAT_MODEL,\n      })\n      promptManagerMock.getPrompt.mockReturnValue('This is a system prompt.')\n      mockedCallAiWithGuard.mockResolvedValue(MOCK_DIRECTIVES)\n    })\n\n    it('should call dependencies with correct parameters and return directives', async () => {\n      // 调用被测试的方法\n      const mockUser = { id: MOCK_JOB_DATA.userId } as any\n      const result = await service.testGenerateDirectives(MOCK_JOB_DATA, mockUser)\n\n      // 验证交互和结果\n      expect(promptInjectionGuardMock.checkInput).toHaveBeenCalledWith(\n        JSON.stringify(MOCK_JOB_DATA.playerAction),\n        {\n          userId: MOCK_JOB_DATA.userId,\n          correlationId: MOCK_JOB_DATA.correlationId,\n        }\n      )\n      expect(schedulerMock.getProviderForRole).toHaveBeenCalledTimes(1)\n      expect(schedulerMock.getProviderForRole).toHaveBeenCalledWith(\n        { id: MOCK_JOB_DATA.userId } as User,\n        'logic_parsing'\n      )\n\n      expect(promptManagerMock.getPrompt).toHaveBeenCalledTimes(1)\n      expect(promptManagerMock.getPrompt).toHaveBeenCalledWith('01_logic_engine.md')\n\n      expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1)\n\n      const aiGuardArgs = mockedCallAiWithGuard.mock.calls[0]\n      const params = aiGuardArgs[1]\n      expect(params.system_prompt).toBe('This is a system prompt.')\n      expect(params.game_state).toBe(JSON.stringify(MOCK_JOB_DATA.gameStateSnapshot))\n      expect(params.player_action).toBe(JSON.stringify(MOCK_JOB_DATA.playerAction))\n\n      expect(result).toEqual(MOCK_DIRECTIVES)\n    })\n  })\n\n  describe('Error Handling: AI Guard Failure', () => {\n    it('should throw an InternalServerErrorException when callAiWithGuard fails', async () => {\n      const aiError = new AiGenerationException('AI failed validation', {})\n\n      schedulerMock.getProviderForRole.mockResolvedValue({\n        model: MOCK_CHAT_MODEL,\n      })\n      promptManagerMock.getPrompt.mockReturnValue('prompt')\n      mockedCallAiWithGuard.mockRejectedValue(aiError)\n\n      const mockUser = { id: MOCK_JOB_DATA.userId } as any\n      await expect(service.testGenerateDirectives(MOCK_JOB_DATA, mockUser)).rejects.toThrow(\n        InternalServerErrorException\n      )\n    })\n\n    it('should throw BadRequestException when prompt injection guard blocks input', async () => {\n      promptInjectionGuardMock.checkInput.mockResolvedValueOnce({\n        allowed: false,\n        score: 0.99,\n        threshold: 0.75,\n        reason: 'threshold-exceeded',\n      })\n\n      const mockUser = { id: MOCK_JOB_DATA.userId } as any\n      await expect(service.testGenerateDirectives(MOCK_JOB_DATA, mockUser)).rejects.toThrow(\n        BadRequestException\n      )\n      expect(mockedCallAiWithGuard).not.toHaveBeenCalled()\n    })\n  })\n})\n"],"version":3}