229bc12da573ec01e6177cd97db58378
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var PluginSandboxService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PluginSandboxService = void 0;
const fs = __importStar(require("node:fs"));
const path = __importStar(require("node:path"));
const vm = __importStar(require("node:vm"));
const common_1 = require("@nestjs/common");
/**
 * Plugin Sandbox Service
 * 提供安全的插件测试环境
 */
let PluginSandboxService = PluginSandboxService_1 = class PluginSandboxService {
    _pluginRegistry;
    logger = new common_1.Logger(PluginSandboxService_1.name);
    sandboxes = new Map();
    constructor(_pluginRegistry) {
        this._pluginRegistry = _pluginRegistry;
    }
    /**
     * 在沙盒中测试插件激活
     */
    async testPluginActivation(pluginPath, options = {}) {
        const startTime = Date.now();
        try {
            const sandboxId = this.generateSandboxId();
            const context = this.createSandboxContext(sandboxId, options);
            // 读取插件代码
            const pluginCode = await fs.promises.readFile(pluginPath, 'utf-8');
            // 验证插件代码安全性
            this.validatePluginCode(pluginCode);
            // 在沙盒中执行插件代码
            const script = new vm.Script(pluginCode, {
                filename: path.basename(pluginPath),
            });
            const pluginModule = { exports: {} };
            context.module = pluginModule;
            context.exports = pluginModule.exports;
            context.require = this.createSafeRequire(options.allowedModules || []);
            script.runInContext(context, { timeout: options.timeout || 5000 });
            // 获取插件类
            const PluginClass = pluginModule.exports.default || pluginModule.exports;
            if (!PluginClass) {
                throw new Error('Plugin must export a default class or function');
            }
            // 创建插件实例
            const mockContext = {
                pluginId: sandboxId,
                config: {},
                logger: {
                    info: (message) => this.logger.log(`[Sandbox:${sandboxId}] ${message}`),
                    warn: (message) => this.logger.warn(`[Sandbox:${sandboxId}] ${message}`),
                    error: (message) => this.logger.error(`[Sandbox:${sandboxId}] ${message}`),
                    debug: (message) => this.logger.debug(`[Sandbox:${sandboxId}] ${message}`),
                },
            };
            const plugin = typeof PluginClass === 'function' ? new PluginClass(mockContext) : PluginClass(mockContext);
            // 测试激活
            if (plugin.activate && typeof plugin.activate === 'function') {
                await plugin.activate(mockContext);
            }
            // 验证插件结构
            this.validatePluginStructure(plugin);
            const executionTime = Date.now() - startTime;
            // 清理沙盒
            this.cleanupSandbox(sandboxId);
            return {
                success: true,
                result: {
                    manifest: plugin.manifest,
                    activated: true,
                },
                executionTime,
            };
        }
        catch (error) {
            const executionTime = Date.now() - startTime;
            this.logger.error(`Plugin activation test failed: ${error instanceof Error ? error.message : String(error)}`);
            return {
                success: false,
                error: error instanceof Error ? error.message : String(error),
                executionTime,
            };
        }
    }
    /**
     * 在沙盒中测试插件工具执行
     */
    async testPluginTool(pluginPath, toolId, input, options = {}) {
        const startTime = Date.now();
        try {
            const sandboxId = this.generateSandboxId();
            const context = this.createSandboxContext(sandboxId, options);
            // 读取并执行插件代码
            const pluginCode = await fs.promises.readFile(pluginPath, 'utf-8');
            // 验证插件代码安全性
            this.validatePluginCode(pluginCode);
            const script = new vm.Script(pluginCode, {
                filename: path.basename(pluginPath),
            });
            const pluginModule = { exports: {} };
            context.module = pluginModule;
            context.exports = pluginModule.exports;
            context.require = this.createSafeRequire(options.allowedModules || []);
            script.runInContext(context, { timeout: options.timeout || 10000 });
            // 创建插件实例
            const PluginClass = pluginModule.exports.default || pluginModule.exports;
            const mockContext = {
                pluginId: sandboxId,
                config: {},
                logger: {
                    info: (message) => this.logger.log(`[Sandbox:${sandboxId}] ${message}`),
                    warn: (message) => this.logger.warn(`[Sandbox:${sandboxId}] ${message}`),
                    error: (message) => this.logger.error(`[Sandbox:${sandboxId}] ${message}`),
                    debug: (message) => this.logger.debug(`[Sandbox:${sandboxId}] ${message}`),
                },
            };
            const plugin = typeof PluginClass === 'function' ? new PluginClass(mockContext) : PluginClass(mockContext);
            // 激活插件
            if (plugin.activate) {
                await plugin.activate(mockContext);
            }
            // 查找并执行工具
            const tool = plugin.manifest.contributes?.aiTools?.find((t) => t.id === toolId);
            if (!tool) {
                throw new Error(`Tool ${toolId} not found in plugin`);
            }
            const result = await tool.execute(input);
            const executionTime = Date.now() - startTime;
            this.cleanupSandbox(sandboxId);
            return {
                success: true,
                result,
                executionTime,
            };
        }
        catch (error) {
            const executionTime = Date.now() - startTime;
            this.logger.error(`Plugin tool test failed: ${error instanceof Error ? error.message : String(error)}`);
            return {
                success: false,
                error: error instanceof Error ? error.message : String(error),
                executionTime,
            };
        }
    }
    /**
     * 创建沙盒上下文
     */
    createSandboxContext(sandboxId, _options) {
        const context = vm.createContext({
            console: {
                log: (...args) => this.logger.log(`[Sandbox:${sandboxId}]`, ...args),
                warn: (...args) => this.logger.warn(`[Sandbox:${sandboxId}]`, ...args),
                error: (...args) => this.logger.error(`[Sandbox:${sandboxId}]`, ...args),
            },
            // REMOVER: Acesso perigoso ao Buffer - pode ser usado para RCE
            // Buffer,
            // REMOVER: setTimeout personalizado - pode ser bypassado
            // setTimeout: (callback: Function, delay: number) => {
            //   if (delay > (options.timeout || 5000)) {
            //     throw new Error('Timeout exceeded')
            //   }
            //   return setTimeout(callback, delay)
            // },
            // clearTimeout,
            // Bloquear acesso a construtores e funções perigosas
            Buffer: undefined,
            Function: undefined,
            eval: undefined,
            setTimeout: undefined,
            setInterval: undefined,
            clearTimeout: undefined,
            clearInterval: undefined,
            global: undefined,
            process: undefined,
            __dirname: undefined,
            __filename: undefined,
            require: undefined,
            module: undefined,
            exports: undefined,
        });
        this.sandboxes.set(sandboxId, context);
        return context;
    }
    /**
     * 创建安全的require函数
     */
    createSafeRequire(allowedModules) {
        const safeModules = new Set(['path', 'url', 'util', 'crypto', ...allowedModules]);
        return (moduleId) => {
            if (!safeModules.has(moduleId)) {
                throw new Error(`Module '${moduleId}' is not allowed in sandbox`);
            }
            try {
                return require(moduleId);
            }
            catch (error) {
                throw new Error(`Failed to load module '${moduleId}': ${error instanceof Error ? error.message : String(error)}`);
            }
        };
    }
    /**
     * 验证插件代码安全性
     */
    validatePluginCode(code) {
        const dangerousPatterns = [
            // Acesso direto ao global
            /\bglobal\b/,
            /\bprocess\b/,
            /\b__dirname\b/,
            /\b__filename\b/,
            /\brequire\b/,
            /\bmodule\b/,
            /\bexports\b/,
            // Funções perigosas
            /\beval\b/,
            /\bFunction\b/,
            /\bsetTimeout\b/,
            /\bsetInterval\b/,
            /\bclearTimeout\b/,
            /\bclearInterval\b/,
            // Acesso ao sistema de arquivos
            /\bfs\b/,
            /\bpath\b/,
            // Acesso à rede
            /\bhttp\b/,
            /\bhttps\b/,
            /\bnet\b/,
            /\bdns\b/,
            // Acesso ao sistema
            /\bchild_process\b/,
            /\bos\b/,
            /\bcrypto\b/,
            /\bBuffer\b/,
        ];
        for (const pattern of dangerousPatterns) {
            if (pattern.test(code)) {
                throw new Error(`Plugin code contains dangerous pattern: ${pattern}`);
            }
        }
    }
    /**
     * 验证插件结构
     */
    validatePluginStructure(plugin) {
        if (!plugin.manifest) {
            throw new Error('Plugin must have a manifest');
        }
        const manifest = plugin.manifest;
        if (!manifest.id || typeof manifest.id !== 'string') {
            throw new Error('Plugin manifest must have a valid id');
        }
        if (!manifest.name || typeof manifest.name !== 'string') {
            throw new Error('Plugin manifest must have a valid name');
        }
        if (!manifest.version || typeof manifest.version !== 'string') {
            throw new Error('Plugin manifest must have a valid version');
        }
        // 验证贡献点
        if (manifest.contributes) {
            if (manifest.contributes.aiTools) {
                for (const tool of manifest.contributes.aiTools) {
                    if (!tool.id || !tool.name || !tool.execute) {
                        throw new Error('AI tool must have id, name, and execute function');
                    }
                }
            }
        }
    }
    /**
     * 生成沙盒ID
     */
    generateSandboxId() {
        return `sandbox_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    /**
     * 清理沙盒
     */
    cleanupSandbox(sandboxId) {
        this.sandboxes.delete(sandboxId);
    }
    /**
     * 获取沙盒统计信息
     */
    getSandboxStats() {
        return {
            activeSandboxes: this.sandboxes.size,
        };
    }
};
exports.PluginSandboxService = PluginSandboxService;
exports.PluginSandboxService = PluginSandboxService = PluginSandboxService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object])
], PluginSandboxService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxwbHVnaW5zXFxwbHVnaW4tc2FuZGJveC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw0Q0FBNkI7QUFDN0IsZ0RBQWlDO0FBQ2pDLDRDQUE2QjtBQUM3QiwyQ0FBbUQ7QUFtQm5EOzs7R0FHRztBQUVJLElBQU0sb0JBQW9CLDRCQUExQixNQUFNLG9CQUFvQjtJQUlWO0lBSEosTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLHNCQUFvQixDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzlDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBc0IsQ0FBQTtJQUUxRCxZQUFxQixlQUErQjtRQUEvQixvQkFBZSxHQUFmLGVBQWUsQ0FBZ0I7SUFBRyxDQUFDO0lBRXhEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLG9CQUFvQixDQUN4QixVQUFrQixFQUNsQixVQUEwQixFQUFFO1FBRTVCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQTtRQUU1QixJQUFJLENBQUM7WUFDSCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQTtZQUMxQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFBO1lBRTdELFNBQVM7WUFDVCxNQUFNLFVBQVUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQTtZQUVsRSxZQUFZO1lBQ1osSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBRW5DLGFBQWE7WUFDYixNQUFNLE1BQU0sR0FBRyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFO2dCQUN2QyxRQUFRLEVBQUUsSUFBSSxDQUFD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QUNqQyxLQUFLLE1BQU0sSUFBSSxJQUFJLFFBQVEsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7b0JBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQzt3QkFDNUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxrREFBa0QsQ0FBQyxDQUFBO29CQUNyRSxDQUFDO2dCQUNILENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLGlCQUFpQjtRQUN2QixPQUFPLFdBQVcsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFBO0lBQzNFLENBQUM7SUFFRDs7T0FFRztJQUNLLGNBQWMsQ0FBQyxTQUFpQjtRQUN0QyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUNsQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxlQUFlO1FBQ2IsT0FBTztZQUNMLGVBQWUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUk7U0FDckMsQ0FBQTtJQUNILENBQUM7Q0FDRixDQUFBO0FBdFZZLG9EQUFvQjsrQkFBcEIsb0JBQW9CO0lBRGhDLElBQUEsbUJBQVUsR0FBRTs7R0FDQSxvQkFBb0IsQ0FzVmhDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxwYWNrYWdlc1xcY29tbW9uLWJhY2tlbmRcXHNyY1xccGx1Z2luc1xccGx1Z2luLXNhbmRib3guc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdub2RlOmZzJ1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdub2RlOnBhdGgnXG5pbXBvcnQgKiBhcyB2bSBmcm9tICdub2RlOnZtJ1xuaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nXG5pbXBvcnQgdHlwZSB7IFBsdWdpblJlZ2lzdHJ5IH0gZnJvbSAnLi9wbHVnaW4ucmVnaXN0cnknXG5pbXBvcnQgdHlwZSB7IFBsdWdpbkNvbnRleHQsIFBsdWdpbk1hbmlmZXN0IH0gZnJvbSAnLi9wbHVnaW4udHlwZXMnXG5cbmV4cG9ydCBpbnRlcmZhY2UgU2FuZGJveE9wdGlvbnMge1xuICB0aW1lb3V0PzogbnVtYmVyXG4gIG1lbW9yeUxpbWl0PzogbnVtYmVyXG4gIGFsbG93ZWRNb2R1bGVzPzogc3RyaW5nW11cbiAgaXNvbGF0ZWRDb250ZXh0PzogYm9vbGVhblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNhbmRib3hSZXN1bHQge1xuICBzdWNjZXNzOiBib29sZWFuXG4gIHJlc3VsdD86IGFueVxuICBlcnJvcj86IHN0cmluZ1xuICBleGVjdXRpb25UaW1lOiBudW1iZXJcbiAgbWVtb3J5VXNhZ2U/OiBudW1iZXJcbn1cblxuLyoqXG4gKiBQbHVnaW4gU2FuZGJveCBTZXJ2aWNlXG4gKiDmj5DkvpvlronlhajnmoTmj5Lku7bmtYvor5Xnjq/looNcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBsdWdpblNhbmRib3hTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFBsdWdpblNhbmRib3hTZXJ2aWNlLm5hbWUpXG4gIHByaXZhdGUgcmVhZG9ubHkgc2FuZGJveGVzID0gbmV3IE1hcDxzdHJpbmcsIHZtLkNvbnRleHQ+KClcblxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBfcGx1Z2luUmVnaXN0cnk6IFBsdWdpblJlZ2lzdHJ5KSB7fVxuXG4gIC8qKlxuICAgKiDlnKjmspnnm5LkuK3mtYvor5Xmj5Lku7bmv4DmtLtcbiAgICovXG4gIGFzeW5jIHRlc3RQbHVnaW5BY3RpdmF0aW9uKFxuICAgIHBsdWdpblBhdGg6IHN0cmluZyxcbiAgICBvcHRpb25zOiBTYW5kYm94T3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8U2FuZGJveFJlc3VsdD4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KClcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzYW5kYm94SWQgPSB0aGlzLmdlbmVyYXRlU2FuZGJveElkKClcbiAgICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmNyZWF0ZVNhbmRib3hDb250ZXh0KHNhbmRib3hJZCwgb3B0aW9ucylcblxuICAgICAgLy8g6K+75Y+W5o+S5Lu25Luj56CBXG4gICAgICBjb25zdCBwbHVnaW5Db2RlID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUocGx1Z2luUGF0aCwgJ3V0Zi04JylcblxuICAgICAgLy8g6aqM6K+B5o+S5Lu25Luj56CB5a6J5YWo5oCnXG4gICAgICB0aGlzLnZhbGlkYXRlUGx1Z2luQ29kZShwbHVnaW5Db2RlKVxuXG4gICAgICAvLyDlnKjmspnnm5LkuK3miafooYzmj5Lku7bku6PnoIFcbiAgICAgIGNvbnN0IHNjcmlwdCA9IG5ldyB2bS5TY3JpcHQocGx1Z2luQ29kZSwge1xuICAgICAgICBmaWxlbmFtZTogcGF0aC5iYXNlbmFtZShwbHVnaW5QYXRoKSxcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IHBsdWdpbk1vZHVsZSA9IHsgZXhwb3J0czoge30gfVxuICAgICAgY29udGV4dC5tb2R1bGUgPSBwbHVnaW5Nb2R1bGVcbiAgICAgIGNvbnRleHQuZXhwb3J0cyA9IHBsdWdpbk1vZHVsZS5leHBvcnRzXG4gICAgICBjb250ZXh0LnJlcXVpcmUgPSB0aGlzLmNyZWF0ZVNhZmVSZXF1aXJlKG9wdGlvbnMuYWxsb3dlZE1vZHVsZXMgfHwgW10pXG5cbiAgICAgIHNjcmlwdC5ydW5JbkNvbnRleHQoY29udGV4dCwgeyB0aW1lb3V0OiBvcHRpb25zLnRpbWVvdXQgfHwgNTAwMCB9KVxuXG4gICAgICAvLyDojrflj5bmj5Lku7bnsbtcbiAgICAgIGNvbnN0IFBsdWdpbkNsYXNzID0gKHBsdWdpbk1vZHVsZS5leHBvcnRzIGFzIGFueSkuZGVmYXVsdCB8fCBwbHVnaW5Nb2R1bGUuZXhwb3J0c1xuICAgICAgaWYgKCFQbHVnaW5DbGFzcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsdWdpbiBtdXN0IGV4cG9ydCBhIGRlZmF1bHQgY2xhc3Mgb3IgZnVuY3Rpb24nKVxuICAgICAgfVxuXG4gICAgICAvLyDliJvlu7rmj5Lku7blrp7kvotcbiAgICAgIGNvbnN0IG1vY2tDb250ZXh0OiBQbHVnaW5Db250ZXh0ID0ge1xuICAgICAgICBwbHVnaW5JZDogc2FuZGJveElkLFxuICAgICAgICBjb25maWc6IHt9LFxuICAgICAgICBsb2dnZXI6IHtcbiAgICAgICAgICBpbmZvOiAobWVzc2FnZTogc3RyaW5nKSA9PiB0aGlzLmxvZ2dlci5sb2coYFtTYW5kYm94OiR7c2FuZGJveElkfV0gJHttZXNzYWdlfWApLFxuICAgICAgICAgIHdhcm46IChtZXNzYWdlOiBzdHJpbmcpID0+IHRoaXMubG9nZ2VyLndhcm4oYFtTYW5kYm94OiR7c2FuZGJveElkfV0gJHttZXNzYWdlfWApLFxuICAgICAgICAgIGVycm9yOiAobWVzc2FnZTogc3RyaW5nKSA9PiB0aGlzLmxvZ2dlci5lcnJvcihgW1NhbmRib3g6JHtzYW5kYm94SWR9XSAke21lc3NhZ2V9YCksXG4gICAgICAgICAgZGVidWc6IChtZXNzYWdlOiBzdHJpbmcpID0+IHRoaXMubG9nZ2VyLmRlYnVnKGBbU2FuZGJveDoke3NhbmRib3hJZH1dICR7bWVzc2FnZX1gKSxcbiAgICAgICAgfSxcbiAgICAgIH1cblxuICAgICAgY29uc3QgcGx1Z2luID1cbiAgICAgICAgdHlwZW9mIFBsdWdpbkNsYXNzID09PSAnZnVuY3Rpb24nID8gbmV3IFBsdWdpbkNsYXNzKG1vY2tDb250ZXh0KSA6IFBsdWdpbkNsYXNzKG1vY2tDb250ZXh0KVxuXG4gICAgICAvLyDmtYvor5Xmv4DmtLtcbiAgICAgIGlmIChwbHVnaW4uYWN0aXZhdGUgJiYgdHlwZW9mIHBsdWdpbi5hY3RpdmF0ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBhd2FpdCBwbHVnaW4uYWN0aXZhdGUobW9ja0NvbnRleHQpXG4gICAgICB9XG5cbiAgICAgIC8vIOmqjOivgeaPkuS7tue7k+aehFxuICAgICAgdGhpcy52YWxpZGF0ZVBsdWdpblN0cnVjdHVyZShwbHVnaW4pXG5cbiAgICAgIGNvbnN0IGV4ZWN1dGlvblRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXG5cbiAgICAgIC8vIOa4heeQhuaymeebklxuICAgICAgdGhpcy5jbGVhbnVwU2FuZGJveChzYW5kYm94SWQpXG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIHJlc3VsdDoge1xuICAgICAgICAgIG1hbmlmZXN0OiBwbHVnaW4ubWFuaWZlc3QsXG4gICAgICAgICAgYWN0aXZhdGVkOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICBleGVjdXRpb25UaW1lLFxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zdCBleGVjdXRpb25UaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBQbHVnaW4gYWN0aXZhdGlvbiB0ZXN0IGZhaWxlZDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YFxuICAgICAgKVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICAgZXhlY3V0aW9uVGltZSxcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5Zyo5rKZ55uS5Lit5rWL6K+V5o+S5Lu25bel5YW35omn6KGMXG4gICAqL1xuICBhc3luYyB0ZXN0UGx1Z2luVG9vbChcbiAgICBwbHVnaW5QYXRoOiBzdHJpbmcsXG4gICAgdG9vbElkOiBzdHJpbmcsXG4gICAgaW5wdXQ6IGFueSxcbiAgICBvcHRpb25zOiBTYW5kYm94T3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8U2FuZGJveFJlc3VsdD4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KClcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzYW5kYm94SWQgPSB0aGlzLmdlbmVyYXRlU2FuZGJveElkKClcbiAgICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmNyZWF0ZVNhbmRib3hDb250ZXh0KHNhbmRib3hJZCwgb3B0aW9ucylcblxuICAgICAgLy8g6K+75Y+W5bm25omn6KGM5o+S5Lu25Luj56CBXG4gICAgICBjb25zdCBwbHVnaW5Db2RlID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUocGx1Z2luUGF0aCwgJ3V0Zi04JylcblxuICAgICAgLy8g6aqM6K+B5o+S5Lu25Luj56CB5a6J5YWo5oCnXG4gICAgICB0aGlzLnZhbGlkYXRlUGx1Z2luQ29kZShwbHVnaW5Db2RlKVxuXG4gICAgICBjb25zdCBzY3JpcHQgPSBuZXcgdm0uU2NyaXB0KHBsdWdpbkNvZGUsIHtcbiAgICAgICAgZmlsZW5hbWU6IHBhdGguYmFzZW5hbWUocGx1Z2luUGF0aCksXG4gICAgICB9KVxuXG4gICAgICBjb25zdCBwbHVnaW5Nb2R1bGUgPSB7IGV4cG9ydHM6IHt9IH1cbiAgICAgIGNvbnRleHQubW9kdWxlID0gcGx1Z2luTW9kdWxlXG4gICAgICBjb250ZXh0LmV4cG9ydHMgPSBwbHVnaW5Nb2R1bGUuZXhwb3J0c1xuICAgICAgY29udGV4dC5yZXF1aXJlID0gdGhpcy5jcmVhdGVTYWZlUmVxdWlyZShvcHRpb25zLmFsbG93ZWRNb2R1bGVzIHx8IFtdKVxuXG4gICAgICBzY3JpcHQucnVuSW5Db250ZXh0KGNvbnRleHQsIHsgdGltZW91dDogb3B0aW9ucy50aW1lb3V0IHx8IDEwMDAwIH0pXG5cbiAgICAgIC8vIOWIm+W7uuaPkuS7tuWunuS+i1xuICAgICAgY29uc3QgUGx1Z2luQ2xhc3MgPSAocGx1Z2luTW9kdWxlLmV4cG9ydHMgYXMgYW55KS5kZWZhdWx0IHx8IHBsdWdpbk1vZHVsZS5leHBvcnRzXG4gICAgICBjb25zdCBtb2NrQ29udGV4dDogUGx1Z2luQ29udGV4dCA9IHtcbiAgICAgICAgcGx1Z2luSWQ6IHNhbmRib3hJZCxcbiAgICAgICAgY29uZmlnOiB7fSxcbiAgICAgICAgbG9nZ2VyOiB7XG4gICAgICAgICAgaW5mbzogKG1lc3NhZ2U6IHN0cmluZykgPT4gdGhpcy5sb2dnZXIubG9nKGBbU2FuZGJveDoke3NhbmRib3hJZH1dICR7bWVzc2FnZX1gKSxcbiAgICAgICAgICB3YXJuOiAobWVzc2FnZTogc3RyaW5nKSA9PiB0aGlzLmxvZ2dlci53YXJuKGBbU2FuZGJveDoke3NhbmRib3hJZH1dICR7bWVzc2FnZX1gKSxcbiAgICAgICAgICBlcnJvcjogKG1lc3NhZ2U6IHN0cmluZykgPT4gdGhpcy5sb2dnZXIuZXJyb3IoYFtTYW5kYm94OiR7c2FuZGJveElkfV0gJHttZXNzYWdlfWApLFxuICAgICAgICAgIGRlYnVnOiAobWVzc2FnZTogc3RyaW5nKSA9PiB0aGlzLmxvZ2dlci5kZWJ1ZyhgW1NhbmRib3g6JHtzYW5kYm94SWR9XSAke21lc3NhZ2V9YCksXG4gICAgICAgIH0sXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBsdWdpbiA9XG4gICAgICAgIHR5cGVvZiBQbHVnaW5DbGFzcyA9PT0gJ2Z1bmN0aW9uJyA/IG5ldyBQbHVnaW5DbGFzcyhtb2NrQ29udGV4dCkgOiBQbHVnaW5DbGFzcyhtb2NrQ29udGV4dClcblxuICAgICAgLy8g5r+A5rS75o+S5Lu2XG4gICAgICBpZiAocGx1Z2luLmFjdGl2YXRlKSB7XG4gICAgICAgIGF3YWl0IHBsdWdpbi5hY3RpdmF0ZShtb2NrQ29udGV4dClcbiAgICAgIH1cblxuICAgICAgLy8g5p+l5om+5bm25omn6KGM5bel5YW3XG4gICAgICBjb25zdCB0b29sID0gcGx1Z2luLm1hbmlmZXN0LmNvbnRyaWJ1dGVzPy5haVRvb2xzPy5maW5kKCh0KSA9PiB0LmlkID09PSB0b29sSWQpXG4gICAgICBpZiAoIXRvb2wpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUb29sICR7dG9vbElkfSBub3QgZm91bmQgaW4gcGx1Z2luYClcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdG9vbC5leGVjdXRlKGlucHV0KVxuXG4gICAgICBjb25zdCBleGVjdXRpb25UaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgdGhpcy5jbGVhbnVwU2FuZGJveChzYW5kYm94SWQpXG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIHJlc3VsdCxcbiAgICAgICAgZXhlY3V0aW9uVGltZSxcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgZXhlY3V0aW9uVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgUGx1Z2luIHRvb2wgdGVzdCBmYWlsZWQ6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcbiAgICAgIClcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICAgIGV4ZWN1dGlvblRpbWUsXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOWIm+W7uuaymeebkuS4iuS4i+aWh1xuICAgKi9cbiAgcHJpdmF0ZSBjcmVhdGVTYW5kYm94Q29udGV4dChzYW5kYm94SWQ6IHN0cmluZywgX29wdGlvbnM6IFNhbmRib3hPcHRpb25zKTogdm0uQ29udGV4dCB7XG4gICAgY29uc3QgY29udGV4dCA9IHZtLmNyZWF0ZUNvbnRleHQoe1xuICAgICAgY29uc29sZToge1xuICAgICAgICBsb2c6ICguLi5hcmdzOiBhbnlbXSkgPT4gdGhpcy5sb2dnZXIubG9nKGBbU2FuZGJveDoke3NhbmRib3hJZH1dYCwgLi4uYXJncyksXG4gICAgICAgIHdhcm46ICguLi5hcmdzOiBhbnlbXSkgPT4gdGhpcy5sb2dnZXIud2FybihgW1NhbmRib3g6JHtzYW5kYm94SWR9XWAsIC4uLmFyZ3MpLFxuICAgICAgICBlcnJvcjogKC4uLmFyZ3M6IGFueVtdKSA9PiB0aGlzLmxvZ2dlci5lcnJvcihgW1NhbmRib3g6JHtzYW5kYm94SWR9XWAsIC4uLmFyZ3MpLFxuICAgICAgfSxcbiAgICAgIC8vIFJFTU9WRVI6IEFjZXNzbyBwZXJpZ29zbyBhbyBCdWZmZXIgLSBwb2RlIHNlciB1c2FkbyBwYXJhIFJDRVxuICAgICAgLy8gQnVmZmVyLFxuXG4gICAgICAvLyBSRU1PVkVSOiBzZXRUaW1lb3V0IHBlcnNvbmFsaXphZG8gLSBwb2RlIHNlciBieXBhc3NhZG9cbiAgICAgIC8vIHNldFRpbWVvdXQ6IChjYWxsYmFjazogRnVuY3Rpb24sIGRlbGF5OiBudW1iZXIpID0+IHtcbiAgICAgIC8vICAgaWYgKGRlbGF5ID4gKG9wdGlvbnMudGltZW91dCB8fCA1MDAwKSkge1xuICAgICAgLy8gICAgIHRocm93IG5ldyBFcnJvcignVGltZW91dCBleGNlZWRlZCcpXG4gICAgICAvLyAgIH1cbiAgICAgIC8vICAgcmV0dXJuIHNldFRpbWVvdXQoY2FsbGJhY2ssIGRlbGF5KVxuICAgICAgLy8gfSxcbiAgICAgIC8vIGNsZWFyVGltZW91dCxcblxuICAgICAgLy8gQmxvcXVlYXIgYWNlc3NvIGEgY29uc3RydXRvcmVzIGUgZnVuw6fDtWVzIHBlcmlnb3Nhc1xuICAgICAgQnVmZmVyOiB1bmRlZmluZWQsXG4gICAgICBGdW5jdGlvbjogdW5kZWZpbmVkLFxuICAgICAgZXZhbDogdW5kZWZpbmVkLFxuICAgICAgc2V0VGltZW91dDogdW5kZWZpbmVkLFxuICAgICAgc2V0SW50ZXJ2YWw6IHVuZGVmaW5lZCxcbiAgICAgIGNsZWFyVGltZW91dDogdW5kZWZpbmVkLFxuICAgICAgY2xlYXJJbnRlcnZhbDogdW5kZWZpbmVkLFxuICAgICAgZ2xvYmFsOiB1bmRlZmluZWQsXG4gICAgICBwcm9jZXNzOiB1bmRlZmluZWQsXG4gICAgICBfX2Rpcm5hbWU6IHVuZGVmaW5lZCxcbiAgICAgIF9fZmlsZW5hbWU6IHVuZGVmaW5lZCxcbiAgICAgIHJlcXVpcmU6IHVuZGVmaW5lZCxcbiAgICAgIG1vZHVsZTogdW5kZWZpbmVkLFxuICAgICAgZXhwb3J0czogdW5kZWZpbmVkLFxuICAgIH0pXG5cbiAgICB0aGlzLnNhbmRib3hlcy5zZXQoc2FuZGJveElkLCBjb250ZXh0KVxuICAgIHJldHVybiBjb250ZXh0XG4gIH1cblxuICAvKipcbiAgICog5Yib5bu65a6J5YWo55qEcmVxdWlyZeWHveaVsFxuICAgKi9cbiAgcHJpdmF0ZSBjcmVhdGVTYWZlUmVxdWlyZShhbGxvd2VkTW9kdWxlczogc3RyaW5nW10pOiBGdW5jdGlvbiB7XG4gICAgY29uc3Qgc2FmZU1vZHVsZXMgPSBuZXcgU2V0KFsncGF0aCcsICd1cmwnLCAndXRpbCcsICdjcnlwdG8nLCAuLi5hbGxvd2VkTW9kdWxlc10pXG5cbiAgICByZXR1cm4gKG1vZHVsZUlkOiBzdHJpbmcpID0+IHtcbiAgICAgIGlmICghc2FmZU1vZHVsZXMuaGFzKG1vZHVsZUlkKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1vZHVsZSAnJHttb2R1bGVJZH0nIGlzIG5vdCBhbGxvd2VkIGluIHNhbmRib3hgKVxuICAgICAgfVxuXG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gcmVxdWlyZShtb2R1bGVJZClcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRmFpbGVkIHRvIGxvYWQgbW9kdWxlICcke21vZHVsZUlkfSc6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcbiAgICAgICAgKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDpqozor4Hmj5Lku7bku6PnoIHlronlhajmgKdcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVQbHVnaW5Db2RlKGNvZGU6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IGRhbmdlcm91c1BhdHRlcm5zID0gW1xuICAgICAgLy8gQWNlc3NvIGRpcmV0byBhbyBnbG9iYWxcbiAgICAgIC9cXGJnbG9iYWxcXGIvLFxuICAgICAgL1xcYnByb2Nlc3NcXGIvLFxuICAgICAgL1xcYl9fZGlybmFtZVxcYi8sXG4gICAgICAvXFxiX19maWxlbmFtZVxcYi8sXG4gICAgICAvXFxicmVxdWlyZVxcYi8sXG4gICAgICAvXFxibW9kdWxlXFxiLyxcbiAgICAgIC9cXGJleHBvcnRzXFxiLyxcblxuICAgICAgLy8gRnVuw6fDtWVzIHBlcmlnb3Nhc1xuICAgICAgL1xcYmV2YWxcXGIvLFxuICAgICAgL1xcYkZ1bmN0aW9uXFxiLyxcbiAgICAgIC9cXGJzZXRUaW1lb3V0XFxiLyxcbiAgICAgIC9cXGJzZXRJbnRlcnZhbFxcYi8sXG4gICAgICAvXFxiY2xlYXJUaW1lb3V0XFxiLyxcbiAgICAgIC9cXGJjbGVhckludGVydmFsXFxiLyxcblxuICAgICAgLy8gQWNlc3NvIGFvIHNpc3RlbWEgZGUgYXJxdWl2b3NcbiAgICAgIC9cXGJmc1xcYi8sXG4gICAgICAvXFxicGF0aFxcYi8sXG5cbiAgICAgIC8vIEFjZXNzbyDDoCByZWRlXG4gICAgICAvXFxiaHR0cFxcYi8sXG4gICAgICAvXFxiaHR0cHNcXGIvLFxuICAgICAgL1xcYm5ldFxcYi8sXG4gICAgICAvXFxiZG5zXFxiLyxcblxuICAgICAgLy8gQWNlc3NvIGFvIHNpc3RlbWFcbiAgICAgIC9cXGJjaGlsZF9wcm9jZXNzXFxiLyxcbiAgICAgIC9cXGJvc1xcYi8sXG4gICAgICAvXFxiY3J5cHRvXFxiLyxcbiAgICAgIC9cXGJCdWZmZXJcXGIvLFxuICAgIF1cblxuICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiBkYW5nZXJvdXNQYXR0ZXJucykge1xuICAgICAgaWYgKHBhdHRlcm4udGVzdChjb2RlKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFBsdWdpbiBjb2RlIGNvbnRhaW5zIGRhbmdlcm91cyBwYXR0ZXJuOiAke3BhdHRlcm59YClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6aqM6K+B5o+S5Lu257uT5p6EXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlUGx1Z2luU3RydWN0dXJlKHBsdWdpbjogYW55KTogdm9pZCB7XG4gICAgaWYgKCFwbHVnaW4ubWFuaWZlc3QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignUGx1Z2luIG11c3QgaGF2ZSBhIG1hbmlmZXN0JylcbiAgICB9XG5cbiAgICBjb25zdCBtYW5pZmVzdDogUGx1Z2luTWFuaWZlc3QgPSBwbHVnaW4ubWFuaWZlc3RcblxuICAgIGlmICghbWFuaWZlc3QuaWQgfHwgdHlwZW9mIG1hbmlmZXN0LmlkICE9PSAnc3RyaW5nJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdQbHVnaW4gbWFuaWZlc3QgbXVzdCBoYXZlIGEgdmFsaWQgaWQnKVxuICAgIH1cblxuICAgIGlmICghbWFuaWZlc3QubmFtZSB8fCB0eXBlb2YgbWFuaWZlc3QubmFtZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignUGx1Z2luIG1hbmlmZXN0IG11c3QgaGF2ZSBhIHZhbGlkIG5hbWUnKVxuICAgIH1cblxuICAgIGlmICghbWFuaWZlc3QudmVyc2lvbiB8fCB0eXBlb2YgbWFuaWZlc3QudmVyc2lvbiAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignUGx1Z2luIG1hbmlmZXN0IG11c3QgaGF2ZSBhIHZhbGlkIHZlcnNpb24nKVxuICAgIH1cblxuICAgIC8vIOmqjOivgei0oeeMrueCuVxuICAgIGlmIChtYW5pZmVzdC5jb250cmlidXRlcykge1xuICAgICAgaWYgKG1hbmlmZXN0LmNvbnRyaWJ1dGVzLmFpVG9vbHMpIHtcbiAgICAgICAgZm9yIChjb25zdCB0b29sIG9mIG1hbmlmZXN0LmNvbnRyaWJ1dGVzLmFpVG9vbHMpIHtcbiAgICAgICAgICBpZiAoIXRvb2wuaWQgfHwgIXRvb2wubmFtZSB8fCAhdG9vbC5leGVjdXRlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FJIHRvb2wgbXVzdCBoYXZlIGlkLCBuYW1lLCBhbmQgZXhlY3V0ZSBmdW5jdGlvbicpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOeUn+aIkOaymeebkklEXG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlU2FuZGJveElkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBzYW5kYm94XyR7RGF0ZS5ub3coKX1fJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YFxuICB9XG5cbiAgLyoqXG4gICAqIOa4heeQhuaymeebklxuICAgKi9cbiAgcHJpdmF0ZSBjbGVhbnVwU2FuZGJveChzYW5kYm94SWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuc2FuZGJveGVzLmRlbGV0ZShzYW5kYm94SWQpXG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5rKZ55uS57uf6K6h5L+h5oGvXG4gICAqL1xuICBnZXRTYW5kYm94U3RhdHMoKTogeyBhY3RpdmVTYW5kYm94ZXM6IG51bWJlciB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgYWN0aXZlU2FuZGJveGVzOiB0aGlzLnNhbmRib3hlcy5zaXplLFxuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9