{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\cache\\cache.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\cache\\cache.service.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/cache/cache.service.ts\n// 核心理念: 多级缓存策略，支持内存和 Redis\n\nimport { CACHE_MANAGER } from '@nestjs/cache-manager'\nimport { Inject, Injectable, Logger } from '@nestjs/common'\nimport type { Cache } from 'cache-manager'\n\n/**\n * 装饰器：为方法添加统一的错误日志记录\n */\nfunction withErrorLogging(operation: string, returnValue?: any) {\n  return (target: any, propertyKey: string, descriptor: PropertyDescriptor) => {\n    const originalMethod = descriptor.value || descriptor.get\n    if (!originalMethod) {\n      throw new Error(`withErrorLogging decorator can only be applied to methods`)\n    }\n\n    const logger = new Logger(target.constructor.name)\n\n    descriptor.value = async function (...args: any[]) {\n      try {\n        return await originalMethod.apply(this, args)\n      } catch (error) {\n        logger.error(`Failed to ${operation}:`, error)\n        return returnValue\n      }\n    }\n  }\n}\n\n/**\n * @interface CacheOptions\n * @description 缓存选项\n */\nexport interface CacheOptions {\n  /** TTL（秒） */\n  ttl?: number\n  /** 缓存键前缀 */\n  prefix?: string\n}\n\n/**\n * @service CacheService\n * @description 缓存服务\n * 提供统一的缓存接口，支持内存和 Redis\n */\n@Injectable()\nexport class CacheService {\n  private readonly logger = new Logger(CacheService.name)\n\n  constructor(@Inject(CACHE_MANAGER) private readonly cacheManager: Cache) {}\n\n  /**\n   * @method get\n   * @description 获取缓存值\n   *\n   * @example\n   * ```typescript\n   * const value = await cacheService.get<string>('user:123');\n   * ```\n   */\n  @withErrorLogging('get cache key', undefined)\n  async get<T>(key: string, options?: CacheOptions): Promise<T | undefined> {\n    const fullKey = this.buildKey(key, options?.prefix)\n    const value = await this.cacheManager.get<T>(fullKey)\n    return value\n  }\n\n  /**\n   * @method set\n   * @description 设置缓存值\n   *\n   * @example\n   * ```typescript\n   * await cacheService.set('user:123', userData, { ttl: 3600 });\n   * ```\n   */\n  @withErrorLogging('set cache key')\n  async set<T>(key: string, value: T, options?: CacheOptions): Promise<void> {\n    const fullKey = this.buildKey(key, options?.prefix)\n    const ttl = options?.ttl ? options.ttl * 1000 : undefined // 转换为毫秒\n    await this.cacheManager.set(fullKey, value, ttl)\n  }\n\n  /**\n   * @method delete\n   * @description 删除缓存\n   */\n  @withErrorLogging('delete cache key')\n  async delete(key: string, prefix?: string): Promise<void> {\n    const fullKey = this.buildKey(key, prefix)\n    await this.cacheManager.del(fullKey)\n  }\n\n  /**\n   * @method clear\n   * @description 清空所有缓存\n   */\n  @withErrorLogging('clear cache')\n  async clear(): Promise<void> {\n    // 使用cache-manager的store接口来清空缓存\n    const store = (this.cacheManager as any).store\n    if (store && typeof store.reset === 'function') {\n      await store.reset()\n    } else {\n      // 如果没有reset方法，记录警告但不抛出错误\n      this.logger.warn('Cache store does not support reset operation')\n    }\n  }\n\n  /**\n   * @method getOrSet\n   * @description 获取缓存，如果不存在则设置\n   *\n   * @example\n   * ```typescript\n   * const user = await cacheService.getOrSet(\n   *   'user:123',\n   *   async () => await this.userService.findById('123'),\n   *   { ttl: 3600 },\n   * );\n   * ```\n   */\n  async getOrSet<T>(key: string, factory: () => Promise<T>, options?: CacheOptions): Promise<T> {\n    const cached = await this.get<T>(key, options)\n    if (cached !== undefined) {\n      return cached\n    }\n\n    const value = await factory()\n    await this.set(key, value, options)\n    return value\n  }\n\n  /**\n   * @method buildKey\n   * @description 构建完整的缓存键\n   */\n  private buildKey(key: string, prefix?: string): string {\n    return prefix ? `${prefix}:${key}` : key\n  }\n}\n"],"version":3}