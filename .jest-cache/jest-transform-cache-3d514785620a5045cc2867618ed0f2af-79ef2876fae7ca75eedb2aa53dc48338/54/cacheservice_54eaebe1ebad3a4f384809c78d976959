f6a008a59ee1b68cf238dc14d34f8f54
"use strict";
// 文件路径: packages/common-backend/src/cache/cache.service.ts
// 核心理念: 多级缓存策略，支持内存和 Redis
var __runInitializers = (this && this.__runInitializers) || function (thisArg, initializers, value) {
    var useValue = arguments.length > 2;
    for (var i = 0; i < initializers.length; i++) {
        value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);
    }
    return useValue ? value : void 0;
};
var __esDecorate = (this && this.__esDecorate) || function (ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {
    function accept(f) { if (f !== void 0 && typeof f !== "function") throw new TypeError("Function expected"); return f; }
    var kind = contextIn.kind, key = kind === "getter" ? "get" : kind === "setter" ? "set" : "value";
    var target = !descriptorIn && ctor ? contextIn["static"] ? ctor : ctor.prototype : null;
    var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});
    var _, done = false;
    for (var i = decorators.length - 1; i >= 0; i--) {
        var context = {};
        for (var p in contextIn) context[p] = p === "access" ? {} : contextIn[p];
        for (var p in contextIn.access) context.access[p] = contextIn.access[p];
        context.addInitializer = function (f) { if (done) throw new TypeError("Cannot add initializers after decoration has completed"); extraInitializers.push(accept(f || null)); };
        var result = (0, decorators[i])(kind === "accessor" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);
        if (kind === "accessor") {
            if (result === void 0) continue;
            if (result === null || typeof result !== "object") throw new TypeError("Object expected");
            if (_ = accept(result.get)) descriptor.get = _;
            if (_ = accept(result.set)) descriptor.set = _;
            if (_ = accept(result.init)) initializers.unshift(_);
        }
        else if (_ = accept(result)) {
            if (kind === "field") initializers.unshift(_);
            else descriptor[key] = _;
        }
    }
    if (target) Object.defineProperty(target, contextIn.name, descriptor);
    done = true;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CacheService = void 0;
const cache_manager_1 = require("@nestjs/cache-manager");
const common_1 = require("@nestjs/common");
/**
 * 装饰器：为方法添加统一的错误日志记录
 */
function withErrorLogging(operation, returnValue) {
    return (target, propertyKey, descriptor) => {
        const originalMethod = descriptor.value || descriptor.get;
        if (!originalMethod) {
            throw new Error(`withErrorLogging decorator can only be applied to methods`);
        }
        const logger = new common_1.Logger(target.constructor.name);
        descriptor.value = async function (...args) {
            try {
                return await originalMethod.apply(this, args);
            }
            catch (error) {
                logger.error(`Failed to ${operation}:`, error);
                return returnValue;
            }
        };
    };
}
/**
 * @service CacheService
 * @description 缓存服务
 * 提供统一的缓存接口，支持内存和 Redis
 */
let CacheService = (() => {
    let _classDecorators = [(0, common_1.Injectable)()];
    let _classDescriptor;
    let _classExtraInitializers = [];
    let _classThis;
    let _instanceExtraInitializers = [];
    let _get_decorators;
    let _set_decorators;
    let _delete_decorators;
    let _clear_decorators;
    var CacheService = class {
        static { _classThis = this; }
        static {
            const _metadata = typeof Symbol === "function" && Symbol.metadata ? Object.create(null) : void 0;
            _get_decorators = [withErrorLogging('get cache key', undefined)];
            _set_decorators = [withErrorLogging('set cache key')];
            _delete_decorators = [withErrorLogging('delete cache key')];
            _clear_decorators = [withErrorLogging('clear cache')];
            __esDecorate(this, null, _get_decorators, { kind: "method", name: "get", static: false, private: false, access: { has: obj => "get" in obj, get: obj => obj.get }, metadata: _metadata }, null, _instanceExtraInitializers);
            __esDecorate(this, null, _set_decorators, { kind: "method", name: "set", static: false, private: false, access: { has: obj => "set" in obj, get: obj => obj.set }, metadata: _metadata }, null, _instanceExtraInitializers);
            __esDecorate(this, null, _delete_decorators, { kind: "method", name: "delete", static: false, private: false, access: { has: obj => "delete" in obj, get: obj => obj.delete }, metadata: _metadata }, null, _instanceExtraInitializers);
            __esDecorate(this, null, _clear_decorators, { kind: "method", name: "clear", static: false, private: false, access: { has: obj => "clear" in obj, get: obj => obj.clear }, metadata: _metadata }, null, _instanceExtraInitializers);
            __esDecorate(null, _classDescriptor = { value: _classThis }, _classDecorators, { kind: "class", name: _classThis.name, metadata: _metadata }, null, _classExtraInitializers);
            CacheService = _classThis = _classDescriptor.value;
            if (_metadata) Object.defineProperty(_classThis, Symbol.metadata, { enumerable: true, configurable: true, writable: true, value: _metadata });
            __runInitializers(_classThis, _classExtraInitializers);
        }
        cacheManager = __runInitializers(this, _instanceExtraInitializers);
        logger = new common_1.Logger(CacheService.name);
        constructor(cacheManager) {
            this.cacheManager = cacheManager;
        }
        /**
         * @method get
         * @description 获取缓存值
         *
         * @example
         * ```typescript
         * const value = await cacheService.get<string>('user:123');
         * ```
         */
        async get(key, options) {
            const fullKey = this.buildKey(key, options?.prefix);
            const value = await this.cacheManager.get(fullKey);
            return value;
        }
        /**
         * @method set
         * @description 设置缓存值
         *
         * @example
         * ```typescript
         * await cacheService.set('user:123', userData, { ttl: 3600 });
         * ```
         */
        async set(key, value, options) {
            const fullKey = this.buildKey(key, options?.prefix);
            const ttl = options?.ttl ? options.ttl * 1000 : undefined; // 转换为毫秒
            await this.cacheManager.set(fullKey, value, ttl);
        }
        /**
         * @method delete
         * @description 删除缓存
         */
        async delete(key, prefix) {
            const fullKey = this.buildKey(key, prefix);
            await this.cacheManager.del(fullKey);
        }
        /**
         * @method clear
         * @description 清空所有缓存
         */
        async clear() {
            // 使用cache-manager的store接口来清空缓存
            const store = this.cacheManager.store;
            if (store && typeof store.reset === 'function') {
                await store.reset();
            }
            else {
                // 如果没有reset方法，记录警告但不抛出错误
                this.logger.warn('Cache store does not support reset operation');
            }
        }
        /**
         * @method getOrSet
         * @description 获取缓存，如果不存在则设置
         *
         * @example
         * ```typescript
         * const user = await cacheService.getOrSet(
         *   'user:123',
         *   async () => await this.userService.findById('123'),
         *   { ttl: 3600 },
         * );
         * ```
         */
        async getOrSet(key, factory, options) {
            const cached = await this.get(key, options);
            if (cached !== undefined) {
                return cached;
            }
            const value = await factory();
            await this.set(key, value, options);
            return value;
        }
        /**
         * @method buildKey
         * @description 构建完整的缓存键
         */
        buildKey(key, prefix) {
            return prefix ? `${prefix}:${key}` : key;
        }
    };
    return CacheService = _classThis;
})();
exports.CacheService = CacheService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxjYWNoZVxcY2FjaGUuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiO0FBQUEsMkRBQTJEO0FBQzNELDJCQUEyQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUUzQix5REFBcUQ7QUFDckQsMkNBQTJEO0FBRzNEOztHQUVHO0FBQ0gsU0FBUyxnQkFBZ0IsQ0FBQyxTQUFpQixFQUFFLFdBQWlCO0lBQzVELE9BQU8sQ0FBQyxNQUFXLEVBQUUsV0FBbUIsRUFBRSxVQUE4QixFQUFFLEVBQUU7UUFDMUUsTUFBTSxjQUFjLEdBQUcsVUFBVSxDQUFDLEtBQUssSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFBO1FBQ3pELElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNwQixNQUFNLElBQUksS0FBSyxDQUFDLDJEQUEyRCxDQUFDLENBQUE7UUFDOUUsQ0FBQztRQUVELE1BQU0sTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFbEQsVUFBVSxDQUFDLEtBQUssR0FBRyxLQUFLLFdBQVcsR0FBRyxJQUFXO1lBQy9DLElBQUksQ0FBQztnQkFDSCxPQUFPLE1BQU0sY0FBYyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7WUFDL0MsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2YsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLFNBQVMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFBO2dCQUM5QyxPQUFPLFdBQVcsQ0FBQTtZQUNwQixDQUFDO1FBQ0gsQ0FBQyxDQUFBO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQWFEOzs7O0dBSUc7SUFFVSxZQUFZOzRCQUR4QixJQUFBLG1CQUFVLEdBQUU7Ozs7Ozs7Ozs7Ozs7K0JBZVYsZ0JBQWdCLENBQUMsZUFBZSxFQUFFLFNB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QWU7WUFDM0MsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUE7UUFDMUMsQ0FBQzs7OztBQTdGVSxvQ0FBWSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xccGFja2FnZXNcXGNvbW1vbi1iYWNrZW5kXFxzcmNcXGNhY2hlXFxjYWNoZS5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL2NhY2hlL2NhY2hlLnNlcnZpY2UudHNcbi8vIOaguOW/g+eQhuW/tTog5aSa57qn57yT5a2Y562W55Wl77yM5pSv5oyB5YaF5a2Y5ZKMIFJlZGlzXG5cbmltcG9ydCB7IENBQ0hFX01BTkFHRVIgfSBmcm9tICdAbmVzdGpzL2NhY2hlLW1hbmFnZXInXG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJ1xuaW1wb3J0IHR5cGUgeyBDYWNoZSB9IGZyb20gJ2NhY2hlLW1hbmFnZXInXG5cbi8qKlxuICog6KOF6aWw5Zmo77ya5Li65pa55rOV5re75Yqg57uf5LiA55qE6ZSZ6K+v5pel5b+X6K6w5b2VXG4gKi9cbmZ1bmN0aW9uIHdpdGhFcnJvckxvZ2dpbmcob3BlcmF0aW9uOiBzdHJpbmcsIHJldHVyblZhbHVlPzogYW55KSB7XG4gIHJldHVybiAodGFyZ2V0OiBhbnksIHByb3BlcnR5S2V5OiBzdHJpbmcsIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcikgPT4ge1xuICAgIGNvbnN0IG9yaWdpbmFsTWV0aG9kID0gZGVzY3JpcHRvci52YWx1ZSB8fCBkZXNjcmlwdG9yLmdldFxuICAgIGlmICghb3JpZ2luYWxNZXRob2QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgd2l0aEVycm9yTG9nZ2luZyBkZWNvcmF0b3IgY2FuIG9ubHkgYmUgYXBwbGllZCB0byBtZXRob2RzYClcbiAgICB9XG5cbiAgICBjb25zdCBsb2dnZXIgPSBuZXcgTG9nZ2VyKHRhcmdldC5jb25zdHJ1Y3Rvci5uYW1lKVxuXG4gICAgZGVzY3JpcHRvci52YWx1ZSA9IGFzeW5jIGZ1bmN0aW9uICguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IG9yaWdpbmFsTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoYEZhaWxlZCB0byAke29wZXJhdGlvbn06YCwgZXJyb3IpXG4gICAgICAgIHJldHVybiByZXR1cm5WYWx1ZVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEBpbnRlcmZhY2UgQ2FjaGVPcHRpb25zXG4gKiBAZGVzY3JpcHRpb24g57yT5a2Y6YCJ6aG5XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVPcHRpb25zIHtcbiAgLyoqIFRUTO+8iOenku+8iSAqL1xuICB0dGw/OiBudW1iZXJcbiAgLyoqIOe8k+WtmOmUruWJjee8gCAqL1xuICBwcmVmaXg/OiBzdHJpbmdcbn1cblxuLyoqXG4gKiBAc2VydmljZSBDYWNoZVNlcnZpY2VcbiAqIEBkZXNjcmlwdGlvbiDnvJPlrZjmnI3liqFcbiAqIOaPkOS+m+e7n+S4gOeahOe8k+WtmOaOpeWPo++8jOaUr+aMgeWGheWtmOWSjCBSZWRpc1xuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ2FjaGVTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKENhY2hlU2VydmljZS5uYW1lKVxuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoQ0FDSEVfTUFOQUdFUikgcHJpdmF0ZSByZWFkb25seSBjYWNoZU1hbmFnZXI6IENhY2hlKSB7fVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGdldFxuICAgKiBAZGVzY3JpcHRpb24g6I635Y+W57yT5a2Y5YC8XG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogY29uc3QgdmFsdWUgPSBhd2FpdCBjYWNoZVNlcnZpY2UuZ2V0PHN0cmluZz4oJ3VzZXI6MTIzJyk7XG4gICAqIGBgYFxuICAgKi9cbiAgQHdpdGhFcnJvckxvZ2dpbmcoJ2dldCBjYWNoZSBrZXknLCB1bmRlZmluZWQpXG4gIGFzeW5jIGdldDxUPihrZXk6IHN0cmluZywgb3B0aW9ucz86IENhY2hlT3B0aW9ucyk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IGZ1bGxLZXkgPSB0aGlzLmJ1aWxkS2V5KGtleSwgb3B0aW9ucz8ucHJlZml4KVxuICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGhpcy5jYWNoZU1hbmFnZXIuZ2V0PFQ+KGZ1bGxLZXkpXG4gICAgcmV0dXJuIHZhbHVlXG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBzZXRcbiAgICogQGRlc2NyaXB0aW9uIOiuvue9rue8k+WtmOWAvFxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGB0eXBlc2NyaXB0XG4gICAqIGF3YWl0IGNhY2hlU2VydmljZS5zZXQoJ3VzZXI6MTIzJywgdXNlckRhdGEsIHsgdHRsOiAzNjAwIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIEB3aXRoRXJyb3JMb2dnaW5nKCdzZXQgY2FjaGUga2V5JylcbiAgYXN5bmMgc2V0PFQ+KGtleTogc3RyaW5nLCB2YWx1ZTogVCwgb3B0aW9ucz86IENhY2hlT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGZ1bGxLZXkgPSB0aGlzLmJ1aWxkS2V5KGtleSwgb3B0aW9ucz8ucHJlZml4KVxuICAgIGNvbnN0IHR0bCA9IG9wdGlvbnM/LnR0bCA/IG9wdGlvbnMudHRsICogMTAwMCA6IHVuZGVmaW5lZCAvLyDovazmjaLkuLrmr6vnp5JcbiAgICBhd2FpdCB0aGlzLmNhY2hlTWFuYWdlci5zZXQoZnVsbEtleSwgdmFsdWUsIHR0bClcbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGRlbGV0ZVxuICAgKiBAZGVzY3JpcHRpb24g5Yig6Zmk57yT5a2YXG4gICAqL1xuICBAd2l0aEVycm9yTG9nZ2luZygnZGVsZXRlIGNhY2hlIGtleScpXG4gIGFzeW5jIGRlbGV0ZShrZXk6IHN0cmluZywgcHJlZml4Pzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZnVsbEtleSA9IHRoaXMuYnVpbGRLZXkoa2V5LCBwcmVmaXgpXG4gICAgYXdhaXQgdGhpcy5jYWNoZU1hbmFnZXIuZGVsKGZ1bGxLZXkpXG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBjbGVhclxuICAgKiBAZGVzY3JpcHRpb24g5riF56m65omA5pyJ57yT5a2YXG4gICAqL1xuICBAd2l0aEVycm9yTG9nZ2luZygnY2xlYXIgY2FjaGUnKVxuICBhc3luYyBjbGVhcigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyDkvb/nlKhjYWNoZS1tYW5hZ2Vy55qEc3RvcmXmjqXlj6PmnaXmuIXnqbrnvJPlrZhcbiAgICBjb25zdCBzdG9yZSA9ICh0aGlzLmNhY2hlTWFuYWdlciBhcyBhbnkpLnN0b3JlXG4gICAgaWYgKHN0b3JlICYmIHR5cGVvZiBzdG9yZS5yZXNldCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgYXdhaXQgc3RvcmUucmVzZXQoKVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyDlpoLmnpzmsqHmnIlyZXNldOaWueazle+8jOiusOW9leitpuWRiuS9huS4jeaKm+WHuumUmeivr1xuICAgICAgdGhpcy5sb2dnZXIud2FybignQ2FjaGUgc3RvcmUgZG9lcyBub3Qgc3VwcG9ydCByZXNldCBvcGVyYXRpb24nKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGdldE9yU2V0XG4gICAqIEBkZXNjcmlwdGlvbiDojrflj5bnvJPlrZjvvIzlpoLmnpzkuI3lrZjlnKjliJnorr7nva5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBgdHlwZXNjcmlwdFxuICAgKiBjb25zdCB1c2VyID0gYXdhaXQgY2FjaGVTZXJ2aWNlLmdldE9yU2V0KFxuICAgKiAgICd1c2VyOjEyMycsXG4gICAqICAgYXN5bmMgKCkgPT4gYXdhaXQgdGhpcy51c2VyU2VydmljZS5maW5kQnlJZCgnMTIzJyksXG4gICAqICAgeyB0dGw6IDM2MDAgfSxcbiAgICogKTtcbiAgICogYGBgXG4gICAqL1xuICBhc3luYyBnZXRPclNldDxUPihrZXk6IHN0cmluZywgZmFjdG9yeTogKCkgPT4gUHJvbWlzZTxUPiwgb3B0aW9ucz86IENhY2hlT3B0aW9ucyk6IFByb21pc2U8VD4ge1xuICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IHRoaXMuZ2V0PFQ+KGtleSwgb3B0aW9ucylcbiAgICBpZiAoY2FjaGVkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBjYWNoZWRcbiAgICB9XG5cbiAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGZhY3RvcnkoKVxuICAgIGF3YWl0IHRoaXMuc2V0KGtleSwgdmFsdWUsIG9wdGlvbnMpXG4gICAgcmV0dXJuIHZhbHVlXG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBidWlsZEtleVxuICAgKiBAZGVzY3JpcHRpb24g5p6E5bu65a6M5pW055qE57yT5a2Y6ZSuXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkS2V5KGtleTogc3RyaW5nLCBwcmVmaXg/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBwcmVmaXggPyBgJHtwcmVmaXh9OiR7a2V5fWAgOiBrZXlcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9