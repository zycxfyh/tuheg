{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\prompts\\prompt-manager.service.ts","mappings":";AAAA,0DAA0D;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE1D,2CAAsE;AACtE,gDAAiC;AACjC,2CAA4B;IAGf,oBAAoB;4BADhC,IAAA,mBAAU,GAAE;;;;;;;;YACb,6KAyDC;;;YAzDY,uDAAoB;;QACd,MAAM,GAAG,IAAI,eAAM,CAAC,oBAAoB,CAAC,IAAI,CAAC,CAAA;QAC9C,WAAW,GAAG,IAAI,GAAG,EAAkB,CAAA;QACxD,2BAA2B;QACV,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAA;QAE5D;;WAEG;QACH,KAAK,CAAC,YAAY;YAChB,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,sCAAsC,CAAC,CAAA;YACvD,MAAM,IAAI,CAAC,cAAc,EAAE,CAAA;QAC7B,CAAC;QAED;;;;WAIG;QACI,SAAS,CAAC,QAAgB;YAC/B,MAAM,MAAM,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAA;YAC7C,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,kCAAkC;gBAClC,MAAM,IAAI,KAAK,CACb,WAAW,QAAQ,2FAA2F,CAC/G,CAAA;YACH,CAAC;YACD,OAAO,MAAM,CAAA;QACf,CAAC;QAED;;WAEG;QACK,KAAK,CAAC,cAAc;YAC1B,IAAI,CAAC;gBACH,MAAM,KAAK,GAAG,MAAM,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,UAAU,CAAC,CAAA;gBAC/C,MAAM,aAAa,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAA;gBAElE,IAAI,aAAa,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;oBAC/B,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,kCAAkC,IAAI,CAAC,UAAU,EAAE,CAAC,CAAA;oBACrE,OAAM;gBACR,CAAC;gBAED,KAAK,MAAM,IAAI,IAAI,aAAa,EAAE,CAAC;oBACjC,MAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,CAAA;oBACjD,MAAM,OAAO,GAAG,MAAM,EAAE,CAAC,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAA;oBACpD,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,EAAE,OAAO,CAAC,CAAA;oBACnC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,wBAAwB,IAAI,EAAE,CAAC,CAAA;gBACjD,CAAC;gBAED,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,uBAAuB,IAAI,CAAC,WAAW,CAAC,IAAI,aAAa,CAAC,CAAA;YAC5E,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,6CAA6C,IAAI,CAAC,UAAU,GAAG,EAAE,KAAK,CAAC,CAAA;gBACzF,2BAA2B;gBAC3B,MAAM,IAAI,KAAK,CAAC,oDAAoD,CAAC,CAAA;YACvE,CAAC;QACH,CAAC;;;;AAxDU,oDAAoB","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\prompts\\prompt-manager.service.ts"],"sourcesContent":["// 文件路徑: libs/common/src/prompts/prompt-manager.service.ts\n\nimport { Injectable, Logger, type OnModuleInit } from '@nestjs/common'\nimport * as fs from 'fs/promises'\nimport * as path from 'path'\n\n@Injectable()\nexport class PromptManagerService implements OnModuleInit {\n  private readonly logger = new Logger(PromptManagerService.name)\n  private readonly promptCache = new Map<string, string>()\n  // [核心] 定位到我們新建的 assets 文件夾\n  private readonly promptsDir = path.join(__dirname, 'assets')\n\n  /**\n   * NestJS生命週期鉤子，在模塊初始化時自動調用。\n   */\n  async onModuleInit() {\n    this.logger.log('Initializing PromptManagerService...')\n    await this.loadAllPrompts()\n  }\n\n  /**\n   * 從緩存中獲取一個已加載的prompt。\n   * @param filename - 例如 '01_logic_engine.md'\n   * @returns 文件的字符串內容\n   */\n  public getPrompt(filename: string): string {\n    const prompt = this.promptCache.get(filename)\n    if (!prompt) {\n      // 在生產環境中，如果啟動時未能加載prompt，這是一個致命錯誤\n      throw new Error(\n        `Prompt \"${filename}\" not found in cache. Ensure it exists in the assets directory and was loaded at startup.`\n      )\n    }\n    return prompt\n  }\n\n  /**\n   * 讀取 assets 文件夾中的所有 .md 文件並將其緩存到內存中。\n   */\n  private async loadAllPrompts() {\n    try {\n      const files = await fs.readdir(this.promptsDir)\n      const markdownFiles = files.filter((file) => file.endsWith('.md'))\n\n      if (markdownFiles.length === 0) {\n        this.logger.warn(`No prompt files (.md) found in ${this.promptsDir}`)\n        return\n      }\n\n      for (const file of markdownFiles) {\n        const filePath = path.join(this.promptsDir, file)\n        const content = await fs.readFile(filePath, 'utf-8')\n        this.promptCache.set(file, content)\n        this.logger.log(`  [+] Loaded prompt: ${file}`)\n      }\n\n      this.logger.log(`Successfully loaded ${this.promptCache.size} prompt(s).`)\n    } catch (error) {\n      this.logger.error(`Failed to load prompts from filesystem at ${this.promptsDir}.`, error)\n      // 這是一個致命的啟動錯誤，我們應該拋出它來停止應用\n      throw new Error('Could not initialize prompts. Halting application.')\n    }\n  }\n}\n"],"version":3}