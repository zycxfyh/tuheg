04744059105dd19e6088e3546c3de3bb
"use strict";
// 文件路径: apps/logic-agent/src/__tests__/logic.service.integration.spec.ts (真正完整版)
Object.defineProperty(exports, "__esModule", { value: true });
// 模拟 @tuheg/common-backend, 只替换 callAiWithGuard
jest.mock('@tuheg/common-backend', () => ({
    ...jest.requireActual('@tuheg/common-backend'), // 保留所有真实导出
    callAiWithGuard: jest.fn(), // 将 callAiWithGuard 替换为一个 Jest 模拟函数
}));
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const common_backend_1 = require("@tuheg/common-backend");
const jest_mock_extended_1 = require("jest-mock-extended");
const logic_service_1 = require("../logic.service");
const rule_engine_service_1 = require("../rule-engine.service");
// 测试子类，用于访问protected方法
class TestLogicService extends logic_service_1.LogicService {
    async testGenerateDirectives(jobData, user) {
        return this.generateDirectives(jobData, user);
    }
}
describe('LogicService (Integration)', () => {
    let service;
    let schedulerMock;
    let promptManagerMock;
    let promptInjectionGuardMock;
    let langfuseServiceMock;
    let ruleEngineMock;
    let eventBusMock;
    // 将模拟函数进行类型转换
    const mockedCallAiWithGuard = common_backend_1.callAiWithGuard;
    const MOCK_CHAT_MODEL = {};
    // [核心修复] 为模拟数据补上 correlationId 字段
    const MOCK_JOB_DATA = {
        gameId: 'game-123',
        userId: 'user-abc',
        playerAction: { type: 'command', payload: 'Attack the goblin' },
        gameStateSnapshot: {
            id: 'game-123',
            name: 'Mock Game',
            ownerId: 'user-abc',
            createdAt: new Date(),
            updatedAt: new Date(),
            character: null,
            worldBook: [],
        },
        correlationId: 'test-correlation-id-integration-456', // <-- 加上这一行
    };
    const MOCK_DIRECTIVES = [
        { op: 'update_character', targetId: 'player', payload: {} },
    ];
    const SAFE_GUARD_RESULT = {
        allowed: true,
        score: 0.1,
        threshold: 0.75,
        reason: 'passed',
    };
    beforeEach(async () => {
        // 使用 jest-mock-extended 创建所有依赖的深度模拟对象
        schedulerMock = (0, jest_mock_extended_1.mock)();
        promptManagerMock = (0, jest_mock_extended_1.mock)();
        promptInjectionGuardMock = (0, jest_mock_extended_1.mock)();
        promptInjectionGuardMock.checkInput.mockResolvedValue(SAFE_GUARD_RESULT);
        promptInjectionGuardMock.ensureSafeOrThrow.mockResolvedValue(undefined);
        langfuseServiceMock = (0, jest_mock_extended_1.mock)();
        ruleEngineMock = (0, jest_mock_extended_1.mock)();
        eventBusMock = (0, jest_mock_extended_1.mock)();
        langfuseServiceMock.createTrace.mockResolvedValue({
            id: 'mock-trace-id',
            name: 'mock-trace',
            metadata: {},
        });
        langfuseServiceMock.createSpan.mockResolvedValue({
            id: 'mock-span-id',
            name: 'mock-span',
            traceId: 'mock-trace-id',
            startTime: new Date(),
            metadata: {},
        });
        langfuseServiceMock.logGeneration.mockResolvedValue(undefined);
        langfuseServiceMock.flush.mockResolvedValue(undefined);
        langfuseServiceMock.isEnabled.mockReturnValue(false);
        const module = await testing_1.Test.createTestingModule({
            providers: [
                TestLogicService,
                // 为所有依赖项提供我们的模拟实例
                { provide: common_backend_1.DynamicAiSchedulerService, useValue: schedulerMock },
                { provide: common_backend_1.PromptManagerService, useValue: promptManagerMock },
                { provide: common_backend_1.LangfuseService, useValue: langfuseServiceMock },
                { provide: common_backend_1.PromptInjectionGuard, useValue: promptInjectionGuardMock },
                { provide: rule_engine_service_1.RuleEngineService, useValue: ruleEngineMock },
                { provide: common_backend_1.EventBusService, useValue: eventBusMock },
            ],
        }).compile();
        service = module.get(TestLogicService);
    });
    afterEach(() => {
        // 在每个测试后重置所有模拟
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('Happy Path: Successful Directive Generation', () => {
        beforeEach(() => {
            // 预设所有模拟依赖的行为
            schedulerMock.getProviderForRole.mockResolvedValue({
                model: MOCK_CHAT_MODEL,
            });
            promptManagerMock.getPrompt.mockReturnValue('This is a system prompt.');
            mockedCallAiWithGuard.mockResolvedValue(MOCK_DIRECTIVES);
        });
        it('should call dependencies with correct parameters and return directives', async () => {
            // 调用被测试的方法
            const mockUser = { id: MOCK_JOB_DATA.userId };
            const result = await service.testGenerateDirectives(MOCK_JOB_DATA, mockUser);
            // 验证交互和结果
            expect(promptInjectionGuardMock.checkInput).toHaveBeenCalledWith(JSON.stringify(MOCK_JOB_DATA.playerAction), {
                userId: MOCK_JOB_DATA.userId,
                correlationId: MOCK_JOB_DATA.correlationId,
            });
            expect(schedulerMock.getProviderForRole).toHaveBeenCalledTimes(1);
            expect(schedulerMock.getProviderForRole).toHaveBeenCalledWith({ id: MOCK_JOB_DATA.userId }, 'logic_parsing');
            expect(promptManagerMock.getPrompt).toHaveBeenCalledTimes(1);
            expect(promptManagerMock.getPrompt).toHaveBeenCalledWith('01_logic_engine.md');
            expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1);
            const aiGuardArgs = mockedCallAiWithGuard.mock.calls[0];
            const params = aiGuardArgs[1];
            expect(params.system_prompt).toBe('This is a system prompt.');
            expect(params.game_state).toBe(JSON.stringify(MOCK_JOB_DATA.gameStateSnapshot));
            expect(params.player_action).toBe(JSON.stringify(MOCK_JOB_DATA.playerAction));
            expect(result).toEqual(MOCK_DIRECTIVES);
        });
    });
    describe('Error Handling: AI Guard Failure', () => {
        it('should throw an InternalServerErrorException when callAiWithGuard fails', async () => {
            const aiError = new common_backend_1.AiGenerationException('AI failed validation', {});
            schedulerMock.getProviderForRole.mockResolvedValue({
                model: MOCK_CHAT_MODEL,
            });
            promptManagerMock.getPrompt.mockReturnValue('prompt');
            mockedCallAiWithGuard.mockRejectedValue(aiError);
            const mockUser = { id: MOCK_JOB_DATA.userId };
            await expect(service.testGenerateDirectives(MOCK_JOB_DATA, mockUser)).rejects.toThrow(common_1.InternalServerErrorException);
        });
        it('should throw BadRequestException when prompt injection guard blocks input', async () => {
            promptInjectionGuardMock.checkInput.mockResolvedValueOnce({
                allowed: false,
                score: 0.99,
                threshold: 0.75,
                reason: 'threshold-exceeded',
            });
            const mockUser = { id: MOCK_JOB_DATA.userId };
            await expect(service.testGenerateDirectives(MOCK_JOB_DATA, mockUser)).rejects.toThrow(common_1.BadRequestException);
            expect(mockedCallAiWithGuard).not.toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcbG9naWMuc2VydmljZS5pbnRlZ3JhdGlvbi5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxpRkFBaUY7O0FBNkJqRixnREFBZ0Q7QUFDaEQsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFLFdBQVc7SUFDM0QsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFBRSxvQ0FBb0M7Q0FDakUsQ0FBQyxDQUFDLENBQUE7QUE5QkgsMkNBQWtGO0FBQ2xGLDZDQUEwRDtBQUUxRCwwREFXOEI7QUFDOUIsMkRBQXlEO0FBQ3pELG9EQUErQztBQUMvQyxnRUFBMEQ7QUFFMUQsdUJBQXVCO0FBQ3ZCLE1BQU0sZ0JBQWlCLFNBQVEsNEJBQVk7SUFDbEMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLE9BQTBCLEVBQUUsSUFBUztRQUN2RSxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDL0MsQ0FBQztDQUNGO0FBUUQsUUFBUSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtJQUMxQyxJQUFJLE9BQXlCLENBQUE7SUFDN0IsSUFBSSxhQUFtRCxDQUFBO0lBQ3ZELElBQUksaUJBQWtELENBQUE7SUFDdEQsSUFBSSx3QkFBeUQsQ0FBQTtJQUM3RCxJQUFJLG1CQUErQyxDQUFBO0lBQ25ELElBQUksY0FBNEMsQ0FBQTtJQUNoRCxJQUFJLFlBQXdDLENBQUE7SUFFNUMsY0FBYztJQUNkLE1BQU0scUJBQXFCLEdBQUcsZ0NBQTRCLENBQUE7SUFFMUQsTUFBTSxlQUFlLEdBQUcsRUFBOEIsQ0FBQTtJQUN0RCxrQ0FBa0M7SUFDbEMsTUFBTSxhQUFhLEdBQXNCO1FBQ3ZDLE1BQU0sRUFBRSxVQUFVO1FB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QUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtRQUN0RCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcbG9naWMuc2VydmljZS5pbnRlZ3JhdGlvbi5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogYXBwcy9sb2dpYy1hZ2VudC9zcmMvX190ZXN0c19fL2xvZ2ljLnNlcnZpY2UuaW50ZWdyYXRpb24uc3BlYy50cyAo55yf5q2j5a6M5pW054mIKVxuXG5pbXBvcnQgdHlwZSB7IEJhc2VDaGF0TW9kZWwgfSBmcm9tICdAbGFuZ2NoYWluL2NvcmUvbGFuZ3VhZ2VfbW9kZWxzL2NoYXRfbW9kZWxzJ1xuaW1wb3J0IHsgQmFkUmVxdWVzdEV4Y2VwdGlvbiwgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJ1xuaW1wb3J0IHsgVGVzdCwgdHlwZSBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJ1xuaW1wb3J0IHR5cGUgeyBVc2VyIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQge1xuICBBaUdlbmVyYXRpb25FeGNlcHRpb24sXG4gIGNhbGxBaVdpdGhHdWFyZCxcbiAgdHlwZSBEaXJlY3RpdmVTZXQsXG4gIER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2UsXG4gIEV2ZW50QnVzU2VydmljZSxcbiAgdHlwZSBHYW1lQWN0aW9uSm9iRGF0YSxcbiAgTGFuZ2Z1c2VTZXJ2aWNlLFxuICB0eXBlIFByb21wdEluamVjdGlvbkNoZWNrUmVzdWx0LFxuICBQcm9tcHRJbmplY3Rpb25HdWFyZCxcbiAgUHJvbXB0TWFuYWdlclNlcnZpY2UsXG59IGZyb20gJ0B0dWhlZy9jb21tb24tYmFja2VuZCdcbmltcG9ydCB7IHR5cGUgTW9ja1Byb3h5LCBtb2NrIH0gZnJvbSAnamVzdC1tb2NrLWV4dGVuZGVkJ1xuaW1wb3J0IHsgTG9naWNTZXJ2aWNlIH0gZnJvbSAnLi4vbG9naWMuc2VydmljZSdcbmltcG9ydCB7IFJ1bGVFbmdpbmVTZXJ2aWNlIH0gZnJvbSAnLi4vcnVsZS1lbmdpbmUuc2VydmljZSdcblxuLy8g5rWL6K+V5a2Q57G777yM55So5LqO6K6/6ZeucHJvdGVjdGVk5pa55rOVXG5jbGFzcyBUZXN0TG9naWNTZXJ2aWNlIGV4dGVuZHMgTG9naWNTZXJ2aWNlIHtcbiAgcHVibGljIGFzeW5jIHRlc3RHZW5lcmF0ZURpcmVjdGl2ZXMoam9iRGF0YTogR2FtZUFjdGlvbkpvYkRhdGEsIHVzZXI6IGFueSkge1xuICAgIHJldHVybiB0aGlzLmdlbmVyYXRlRGlyZWN0aXZlcyhqb2JEYXRhLCB1c2VyKVxuICB9XG59XG5cbi8vIOaooeaLnyBAdHVoZWcvY29tbW9uLWJhY2tlbmQsIOWPquabv+aNoiBjYWxsQWlXaXRoR3VhcmRcbmplc3QubW9jaygnQHR1aGVnL2NvbW1vbi1iYWNrZW5kJywgKCkgPT4gKHtcbiAgLi4uamVzdC5yZXF1aXJlQWN0dWFsKCdAdHVoZWcvY29tbW9uLWJhY2tlbmQnKSwgLy8g5L+d55WZ5omA5pyJ55yf5a6e5a+85Ye6XG4gIGNhbGxBaVdpdGhHdWFyZDogamVzdC5mbigpLCAvLyDlsIYgY2FsbEFpV2l0aEd1YXJkIOabv+aNouS4uuS4gOS4qiBKZXN0IOaooeaLn+WHveaVsFxufSkpXG5cbmRlc2NyaWJlKCdMb2dpY1NlcnZpY2UgKEludGVncmF0aW9uKScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFRlc3RMb2dpY1NlcnZpY2VcbiAgbGV0IHNjaGVkdWxlck1vY2s6IE1vY2tQcm94eTxEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlPlxuICBsZXQgcHJvbXB0TWFuYWdlck1vY2s6IE1vY2tQcm94eTxQcm9tcHRNYW5hZ2VyU2VydmljZT5cbiAgbGV0IHByb21wdEluamVjdGlvbkd1YXJkTW9jazogTW9ja1Byb3h5PFByb21wdEluamVjdGlvbkd1YXJkPlxuICBsZXQgbGFuZ2Z1c2VTZXJ2aWNlTW9jazogTW9ja1Byb3h5PExhbmdmdXNlU2VydmljZT5cbiAgbGV0IHJ1bGVFbmdpbmVNb2NrOiBNb2NrUHJveHk8UnVsZUVuZ2luZVNlcnZpY2U+XG4gIGxldCBldmVudEJ1c01vY2s6IE1vY2tQcm94eTxFdmVudEJ1c1NlcnZpY2U+XG5cbiAgLy8g5bCG5qih5ouf5Ye95pWw6L+b6KGM57G75Z6L6L2s5o2iXG4gIGNvbnN0IG1vY2tlZENhbGxBaVdpdGhHdWFyZCA9IGNhbGxBaVdpdGhHdWFyZCBhcyBqZXN0Lk1vY2tcblxuICBjb25zdCBNT0NLX0NIQVRfTU9ERUwgPSB7fSBhcyB1bmtub3duIGFzIEJhc2VDaGF0TW9kZWxcbiAgLy8gW+aguOW/g+S/ruWkjV0g5Li65qih5ouf5pWw5o2u6KGl5LiKIGNvcnJlbGF0aW9uSWQg5a2X5q61XG4gIGNvbnN0IE1PQ0tfSk9CX0RBVEE6IEdhbWVBY3Rpb25Kb2JEYXRhID0ge1xuICAgIGdhbWVJZDogJ2dhbWUtMTIzJyxcbiAgICB1c2VySWQ6ICd1c2VyLWFiYycsXG4gICAgcGxheWVyQWN0aW9uOiB7IHR5cGU6ICdjb21tYW5kJywgcGF5bG9hZDogJ0F0dGFjayB0aGUgZ29ibGluJyB9LFxuICAgIGdhbWVTdGF0ZVNuYXBzaG90OiB7XG4gICAgICBpZDogJ2dhbWUtMTIzJyxcbiAgICAgIG5hbWU6ICdNb2NrIEdhbWUnLFxuICAgICAgb3duZXJJZDogJ3VzZXItYWJjJyxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIGNoYXJhY3RlcjogbnVsbCxcbiAgICAgIHdvcmxkQm9vazogW10sXG4gICAgfSxcbiAgICBjb3JyZWxhdGlvbklkOiAndGVzdC1jb3JyZWxhdGlvbi1pZC1pbnRlZ3JhdGlvbi00NTYnLCAvLyA8LS0g5Yqg5LiK6L+Z5LiA6KGMXG4gIH1cblxuICBjb25zdCBNT0NLX0RJUkVDVElWRVM6IERpcmVjdGl2ZVNldCA9IFtcbiAgICB7IG9wOiAndXBkYXRlX2NoYXJhY3RlcicsIHRhcmdldElkOiAncGxheWVyJywgcGF5bG9hZDoge30gfSxcbiAgXVxuXG4gIGNvbnN0IFNBRkVfR1VBUkRfUkVTVUxUOiBQcm9tcHRJbmplY3Rpb25DaGVja1Jlc3VsdCA9IHtcbiAgICBhbGxvd2VkOiB0cnVlLFxuICAgIHNjb3JlOiAwLjEsXG4gICAgdGhyZXNob2xkOiAwLjc1LFxuICAgIHJlYXNvbjogJ3Bhc3NlZCcsXG4gIH1cblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyDkvb/nlKggamVzdC1tb2NrLWV4dGVuZGVkIOWIm+W7uuaJgOacieS+nei1lueahOa3seW6puaooeaLn+WvueixoVxuICAgIHNjaGVkdWxlck1vY2sgPSBtb2NrPER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2U+KClcbiAgICBwcm9tcHRNYW5hZ2VyTW9jayA9IG1vY2s8UHJvbXB0TWFuYWdlclNlcnZpY2U+KClcbiAgICBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2sgPSBtb2NrPFByb21wdEluamVjdGlvbkd1YXJkPigpXG4gICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmNoZWNrSW5wdXQubW9ja1Jlc29sdmVkVmFsdWUoU0FGRV9HVUFSRF9SRVNVTFQpXG4gICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmVuc3VyZVNhZmVPclRocm93Lm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZClcbiAgICBsYW5nZnVzZVNlcnZpY2VNb2NrID0gbW9jazxMYW5nZnVzZVNlcnZpY2U+KClcbiAgICBydWxlRW5naW5lTW9jayA9IG1vY2s8UnVsZUVuZ2luZVNlcnZpY2U+KClcbiAgICBldmVudEJ1c01vY2sgPSBtb2NrPEV2ZW50QnVzU2VydmljZT4oKVxuICAgIGxhbmdmdXNlU2VydmljZU1vY2suY3JlYXRlVHJhY2UubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgaWQ6ICdtb2NrLXRyYWNlLWlkJyxcbiAgICAgIG5hbWU6ICdtb2NrLXRyYWNlJyxcbiAgICAgIG1ldGFkYXRhOiB7fSxcbiAgICB9KVxuICAgIGxhbmdmdXNlU2VydmljZU1vY2suY3JlYXRlU3Bhbi5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICBpZDogJ21vY2stc3Bhbi1pZCcsXG4gICAgICBuYW1lOiAnbW9jay1zcGFuJyxcbiAgICAgIHRyYWNlSWQ6ICdtb2NrLXRyYWNlLWlkJyxcbiAgICAgIHN0YXJ0VGltZTogbmV3IERhdGUoKSxcbiAgICAgIG1ldGFkYXRhOiB7fSxcbiAgICB9KVxuICAgIGxhbmdmdXNlU2VydmljZU1vY2subG9nR2VuZXJhdGlvbi5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpXG4gICAgbGFuZ2Z1c2VTZXJ2aWNlTW9jay5mbHVzaC5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpXG4gICAgbGFuZ2Z1c2VTZXJ2aWNlTW9jay5pc0VuYWJsZWQubW9ja1JldHVyblZhbHVlKGZhbHNlKVxuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBUZXN0TG9naWNTZXJ2aWNlLFxuICAgICAgICAvLyDkuLrmiYDmnInkvp3otZbpobnmj5DkvpvmiJHku6znmoTmqKHmi5/lrp7kvotcbiAgICAgICAgeyBwcm92aWRlOiBEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlLCB1c2VWYWx1ZTogc2NoZWR1bGVyTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IFByb21wdE1hbmFnZXJTZXJ2aWNlLCB1c2VWYWx1ZTogcHJvbXB0TWFuYWdlck1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBMYW5nZnVzZVNlcnZpY2UsIHVzZVZhbHVlOiBsYW5nZnVzZVNlcnZpY2VNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogUHJvbXB0SW5qZWN0aW9uR3VhcmQsIHVzZVZhbHVlOiBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBSdWxlRW5naW5lU2VydmljZSwgdXNlVmFsdWU6IHJ1bGVFbmdpbmVNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogRXZlbnRCdXNTZXJ2aWNlLCB1c2VWYWx1ZTogZXZlbnRCdXNNb2NrIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKVxuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8VGVzdExvZ2ljU2VydmljZT4oVGVzdExvZ2ljU2VydmljZSlcbiAgfSlcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIC8vIOWcqOavj+S4qua1i+ivleWQjumHjee9ruaJgOacieaooeaLn1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpXG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ0hhcHB5IFBhdGg6IFN1Y2Nlc3NmdWwgRGlyZWN0aXZlIEdlbmVyYXRpb24nLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAvLyDpooTorr7miYDmnInmqKHmi5/kvp3otZbnmoTooYzkuLpcbiAgICAgIHNjaGVkdWxlck1vY2suZ2V0UHJvdmlkZXJGb3JSb2xlLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgbW9kZWw6IE1PQ0tfQ0hBVF9NT0RFTCxcbiAgICAgIH0pXG4gICAgICBwcm9tcHRNYW5hZ2VyTW9jay5nZXRQcm9tcHQubW9ja1JldHVyblZhbHVlKCdUaGlzIGlzIGEgc3lzdGVtIHByb21wdC4nKVxuICAgICAgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkLm1vY2tSZXNvbHZlZFZhbHVlKE1PQ0tfRElSRUNUSVZFUylcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjYWxsIGRlcGVuZGVuY2llcyB3aXRoIGNvcnJlY3QgcGFyYW1ldGVycyBhbmQgcmV0dXJuIGRpcmVjdGl2ZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyDosIPnlKjooqvmtYvor5XnmoTmlrnms5VcbiAgICAgIGNvbnN0IG1vY2tVc2VyID0geyBpZDogTU9DS19KT0JfREFUQS51c2VySWQgfSBhcyBhbnlcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UudGVzdEdlbmVyYXRlRGlyZWN0aXZlcyhNT0NLX0pPQl9EQVRBLCBtb2NrVXNlcilcblxuICAgICAgLy8g6aqM6K+B5Lqk5LqS5ZKM57uT5p6cXG4gICAgICBleHBlY3QocHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmNoZWNrSW5wdXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBKU09OLnN0cmluZ2lmeShNT0NLX0pPQl9EQVRBLnBsYXllckFjdGlvbiksXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VySWQ6IE1PQ0tfSk9CX0RBVEEudXNlcklkLFxuICAgICAgICAgIGNvcnJlbGF0aW9uSWQ6IE1PQ0tfSk9CX0RBVEEuY29ycmVsYXRpb25JZCxcbiAgICAgICAgfVxuICAgICAgKVxuICAgICAgZXhwZWN0KHNjaGVkdWxlck1vY2suZ2V0UHJvdmlkZXJGb3JSb2xlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSlcbiAgICAgIGV4cGVjdChzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIHsgaWQ6IE1PQ0tfSk9CX0RBVEEudXNlcklkIH0gYXMgVXNlcixcbiAgICAgICAgJ2xvZ2ljX3BhcnNpbmcnXG4gICAgICApXG5cbiAgICAgIGV4cGVjdChwcm9tcHRNYW5hZ2VyTW9jay5nZXRQcm9tcHQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKVxuICAgICAgZXhwZWN0KHByb21wdE1hbmFnZXJNb2NrLmdldFByb21wdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJzAxX2xvZ2ljX2VuZ2luZS5tZCcpXG5cbiAgICAgIGV4cGVjdChtb2NrZWRDYWxsQWlXaXRoR3VhcmQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKVxuXG4gICAgICBjb25zdCBhaUd1YXJkQXJncyA9IG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrLmNhbGxzWzBdXG4gICAgICBjb25zdCBwYXJhbXMgPSBhaUd1YXJkQXJnc1sxXVxuICAgICAgZXhwZWN0KHBhcmFtcy5zeXN0ZW1fcHJvbXB0KS50b0JlKCdUaGlzIGlzIGEgc3lzdGVtIHByb21wdC4nKVxuICAgICAgZXhwZWN0KHBhcmFtcy5nYW1lX3N0YXRlKS50b0JlKEpTT04uc3RyaW5naWZ5KE1PQ0tfSk9CX0RBVEEuZ2FtZVN0YXRlU25hcHNob3QpKVxuICAgICAgZXhwZWN0KHBhcmFtcy5wbGF5ZXJfYWN0aW9uKS50b0JlKEpTT04uc3RyaW5naWZ5KE1PQ0tfSk9CX0RBVEEucGxheWVyQWN0aW9uKSlcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChNT0NLX0RJUkVDVElWRVMpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnRXJyb3IgSGFuZGxpbmc6IEFJIEd1YXJkIEZhaWx1cmUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBhbiBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uIHdoZW4gY2FsbEFpV2l0aEd1YXJkIGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYWlFcnJvciA9IG5ldyBBaUdlbmVyYXRpb25FeGNlcHRpb24oJ0FJIGZhaWxlZCB2YWxpZGF0aW9uJywge30pXG5cbiAgICAgIHNjaGVkdWxlck1vY2suZ2V0UHJvdmlkZXJGb3JSb2xlLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgbW9kZWw6IE1PQ0tfQ0hBVF9NT0RFTCxcbiAgICAgIH0pXG4gICAgICBwcm9tcHRNYW5hZ2VyTW9jay5nZXRQcm9tcHQubW9ja1JldHVyblZhbHVlKCdwcm9tcHQnKVxuICAgICAgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkLm1vY2tSZWplY3RlZFZhbHVlKGFpRXJyb3IpXG5cbiAgICAgIGNvbnN0IG1vY2tVc2VyID0geyBpZDogTU9DS19KT0JfREFUQS51c2VySWQgfSBhcyBhbnlcbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLnRlc3RHZW5lcmF0ZURpcmVjdGl2ZXMoTU9DS19KT0JfREFUQSwgbW9ja1VzZXIpKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAgIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb25cbiAgICAgIClcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBCYWRSZXF1ZXN0RXhjZXB0aW9uIHdoZW4gcHJvbXB0IGluamVjdGlvbiBndWFyZCBibG9ja3MgaW5wdXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2suY2hlY2tJbnB1dC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgICBhbGxvd2VkOiBmYWxzZSxcbiAgICAgICAgc2NvcmU6IDAuOTksXG4gICAgICAgIHRocmVzaG9sZDogMC43NSxcbiAgICAgICAgcmVhc29uOiAndGhyZXNob2xkLWV4Y2VlZGVkJyxcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IG1vY2tVc2VyID0geyBpZDogTU9DS19KT0JfREFUQS51c2VySWQgfSBhcyBhbnlcbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLnRlc3RHZW5lcmF0ZURpcmVjdGl2ZXMoTU9DS19KT0JfREFUQSwgbW9ja1VzZXIpKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAgIEJhZFJlcXVlc3RFeGNlcHRpb25cbiAgICAgIClcbiAgICAgIGV4cGVjdChtb2NrZWRDYWxsQWlXaXRoR3VhcmQpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICB9KVxuICB9KVxufSlcbiJdLCJ2ZXJzaW9uIjozfQ==