{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\observability\\sentry.config.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\observability\\sentry.config.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/observability/sentry.config.ts\n// 核心理念: 增强的错误追踪和性能监控配置\n\nimport * as Sentry from '@sentry/node'\nimport type { NodeOptions } from '@sentry/node'\n\n/**\n * @interface SentryConfigOptions\n * @description Sentry 配置选项\n */\nexport interface SentryConfigOptions {\n  /** 环境名称 */\n  environment?: string\n  /** 发布版本 */\n  release?: string\n  /** DSN */\n  dsn?: string\n  /** 采样率 */\n  tracesSampleRate?: number\n  /** 性能监控采样率 */\n  profilesSampleRate?: number\n  /** 是否启用性能监控 */\n  enablePerformanceMonitoring?: boolean\n  /** 自定义标签 */\n  tags?: Record<string, string>\n  /** 忽略的错误 */\n  ignoreErrors?: string[]\n}\n\n/**\n * @function configureSentry\n * @description 配置 Sentry，增强错误追踪和性能监控\n *\n * @example\n * ```typescript\n * configureSentry({\n *   environment: 'production',\n *   release: '1.0.0',\n *   enablePerformanceMonitoring: true,\n *   tags: {\n *     service: 'backend-gateway',\n *   },\n * });\n * ```\n */\nexport function configureSentry(options: SentryConfigOptions = {}): void {\n  const {\n    environment = process.env.NODE_ENV || 'development',\n    release = process.env.APP_VERSION || '1.0.0',\n    dsn = process.env.SENTRY_DSN,\n    tracesSampleRate = environment === 'production' ? 0.1 : 1.0,\n    profilesSampleRate = environment === 'production' ? 0.1 : 1.0,\n    enablePerformanceMonitoring = true,\n    tags = {},\n    ignoreErrors = [\n      // 忽略常见的网络错误\n      'NetworkError',\n      'Network request failed',\n      // 忽略已知的第三方库错误\n      'ResizeObserver loop limit exceeded',\n    ],\n  } = options\n\n  if (!dsn) {\n    console.warn('Sentry DSN not configured, skipping Sentry initialization')\n    return\n  }\n\n  const sentryOptions: NodeOptions = {\n    dsn,\n    environment,\n    release,\n    tracesSampleRate,\n    profilesSampleRate: enablePerformanceMonitoring ? profilesSampleRate : 0,\n    // 忽略的错误\n    ignoreErrors,\n    // 自定义标签\n    initialScope: {\n      tags: {\n        ...tags,\n        environment,\n        release,\n      },\n    },\n    // 性能监控配置\n    integrations: [\n      // HTTP 请求追踪\n      Sentry.httpIntegration(),\n      // Express 追踪\n      Sentry.expressIntegration(),\n    ],\n    // 在开发环境中启用调试\n    debug: environment === 'development',\n    // 自动会话追踪\n    autoSessionTracking: true,\n    // 发送默认 PII（个人可识别信息）\n    sendDefaultPii: false,\n  }\n\n  Sentry.init(sentryOptions)\n\n  console.log(`Sentry initialized for environment: ${environment}, release: ${release}`)\n}\n\n/**\n * @function setSentryUser\n * @description 设置 Sentry 用户上下文\n */\nexport function setSentryUser(user: { id: string; email?: string; username?: string }): void {\n  Sentry.setUser({\n    id: user.id,\n    email: user.email,\n    username: user.username,\n  })\n}\n\n/**\n * @function setSentryContext\n * @description 设置 Sentry 上下文\n */\nexport function setSentryContext(key: string, context: Record<string, unknown>): void {\n  Sentry.setContext(key, context)\n}\n\n/**\n * @function setSentryTag\n * @description 设置 Sentry 标签\n */\nexport function setSentryTag(key: string, value: string): void {\n  Sentry.setTag(key, value)\n}\n\n/**\n * @function captureException\n * @description 捕获异常（增强版）\n */\nexport function captureException(\n  error: Error,\n  context?: {\n    tags?: Record<string, string>\n    extra?: Record<string, unknown>\n    user?: { id: string; email?: string }\n  }\n): void {\n  if (context?.tags) {\n    for (const [key, value] of Object.entries(context.tags)) {\n      Sentry.setTag(key, value)\n    }\n  }\n\n  if (context?.extra) {\n    Sentry.setExtra('context', context.extra)\n  }\n\n  if (context?.user) {\n    setSentryUser(context.user)\n  }\n\n  Sentry.captureException(error)\n}\n\n/**\n * @function captureMessage\n * @description 捕获消息（增强版）\n */\nexport function captureMessage(\n  message: string,\n  level: Sentry.SeverityLevel = 'info',\n  context?: {\n    tags?: Record<string, string>\n    extra?: Record<string, unknown>\n  }\n): void {\n  if (context?.tags) {\n    for (const [key, value] of Object.entries(context.tags)) {\n      Sentry.setTag(key, value)\n    }\n  }\n\n  if (context?.extra) {\n    Sentry.setExtra('context', context.extra)\n  }\n\n  Sentry.captureMessage(message, level)\n}\n"],"version":3}