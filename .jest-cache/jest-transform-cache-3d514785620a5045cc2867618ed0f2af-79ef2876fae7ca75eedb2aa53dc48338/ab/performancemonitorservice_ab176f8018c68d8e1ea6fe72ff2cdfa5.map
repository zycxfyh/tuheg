{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\observability\\performance-monitor.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\observability\\performance-monitor.service.ts"],"sourcesContent":["// æ–‡ä»¶è·¯å¾„: packages/common-backend/src/observability/performance-monitor.service.ts\n// èŒè´£: æ€§èƒ½ç›‘æ§æœåŠ¡ï¼Œå®ç°SLAæŒ‡æ ‡æ”¶é›†å’Œå‘Šè­¦\n\nimport { Injectable, Logger } from '@nestjs/common'\nimport { Cron, CronExpression } from '@nestjs/schedule'\nimport * as os from 'os'\nimport {\n  getSLATarget,\n  isPerformanceHealthy,\n  PERFORMANCE_CONFIG,\n  type ServiceSLAs,\n} from '../config/performance-config'\n\n/**\n * @interface PerformanceMetrics\n * @description æ€§èƒ½æŒ‡æ ‡æ•°æ®ç»“æ„\n */\nexport interface PerformanceMetrics {\n  timestamp: number\n  service: keyof ServiceSLAs\n  responseTime: {\n    p50: number\n    p95: number\n    p99: number\n    avg: number\n  }\n  errorRate: number\n  availability: number\n  throughput: number\n  system: {\n    cpuUsage: number\n    memoryUsage: number\n    activeConnections: number\n  }\n}\n\n/**\n * @interface AlertCondition\n * @description å‘Šè­¦æ¡ä»¶\n */\nexport interface AlertCondition {\n  service: keyof ServiceSLAs\n  metric: string\n  threshold: number\n  currentValue: number\n  level: 'warning' | 'critical' | 'emergency' | 'healthy'\n  timestamp: number\n}\n\n/**\n * @service PerformanceMonitorService\n * @description æ€§èƒ½ç›‘æ§æœåŠ¡\n */\n@Injectable()\nexport class PerformanceMonitorService {\n  private readonly logger = new Logger(PerformanceMonitorService.name)\n\n  // æŒ‡æ ‡å­˜å‚¨ (å†…å­˜ä¸­ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Redisæˆ–æ•°æ®åº“)\n  private readonly metrics: PerformanceMetrics[] = []\n  private readonly alerts: AlertCondition[] = []\n\n  // è®¡æ•°å™¨\n  private requestCount = 0\n  private errorCount = 0\n  private responseTimes: number[] = []\n\n  constructor() {\n    this.logger.log('PerformanceMonitorService initialized with SLA targets')\n  }\n\n  /**\n   * @method recordRequest\n   * @description è®°å½•APIè¯·æ±‚\n   */\n  recordRequest(_service: keyof ServiceSLAs, responseTime: number, isError = false): void {\n    this.requestCount++\n    this.responseTimes.push(responseTime)\n\n    if (isError) {\n      this.errorCount++\n    }\n\n    // ä¿æŒæœ€è¿‘1000ä¸ªå“åº”æ—¶é—´çš„è®°å½•\n    if (this.responseTimes.length > 1000) {\n      this.responseTimes.shift()\n    }\n  }\n\n  /**\n   * @method collectMetrics\n   * @description æ”¶é›†å½“å‰æ€§èƒ½æŒ‡æ ‡\n   */\n  @Cron(CronExpression.EVERY_MINUTE)\n  async collectMetrics(): Promise<void> {\n    try {\n      const metrics = await this.gatherCurrentMetrics()\n      this.metrics.push(metrics)\n\n      // ä¿æŒæœ€è¿‘24å°æ—¶çš„æ•°æ®\n      const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000\n      this.metrics.splice(\n        0,\n        this.metrics.findIndex((m) => m.timestamp < oneDayAgo)\n      )\n\n      // æ£€æŸ¥SLAåˆè§„æ€§\n      await this.checkSLAViolations(metrics)\n\n      this.logger.debug(`Performance metrics collected: ${JSON.stringify(metrics)}`)\n    } catch (error) {\n      this.logger.error('Failed to collect performance metrics:', error)\n    }\n  }\n\n  /**\n   * @method checkSLAViolations\n   * @description æ£€æŸ¥SLAè¿è§„\n   */\n  @Cron(CronExpression.EVERY_5_MINUTES)\n  async checkSLAViolations(metrics: PerformanceMetrics): Promise<void> {\n    const sla = getSLATarget(metrics.service)\n\n    // æ£€æŸ¥å“åº”æ—¶é—´\n    const rtHealth = isPerformanceHealthy(metrics.service, 'responseTime', metrics.responseTime.p95)\n    if (!rtHealth.healthy) {\n      await this.createAlert({\n        service: metrics.service,\n        metric: 'responseTime',\n        threshold: sla.responseTime.p95,\n        currentValue: metrics.responseTime.p95,\n        level: rtHealth.level,\n        timestamp: Date.now(),\n      })\n    }\n\n    // æ£€æŸ¥é”™è¯¯ç‡\n    const erHealth = isPerformanceHealthy(metrics.service, 'errorRate', metrics.errorRate)\n    if (!erHealth.healthy) {\n      await this.createAlert({\n        service: metrics.service,\n        metric: 'errorRate',\n        threshold: sla.errorRate,\n        currentValue: metrics.errorRate,\n        level: erHealth.level,\n        timestamp: Date.now(),\n      })\n    }\n\n    // æ£€æŸ¥å¯ç”¨æ€§\n    const avHealth = isPerformanceHealthy(metrics.service, 'availability', metrics.availability)\n    if (!avHealth.healthy) {\n      await this.createAlert({\n        service: metrics.service,\n        metric: 'availability',\n        threshold: sla.availability,\n        currentValue: metrics.availability,\n        level: avHealth.level,\n        timestamp: Date.now(),\n      })\n    }\n  }\n\n  /**\n   * @method createAlert\n   * @description åˆ›å»ºå‘Šè­¦\n   */\n  private async createAlert(alert: AlertCondition): Promise<void> {\n    this.alerts.push(alert)\n\n    // ä¿æŒæœ€è¿‘100ä¸ªå‘Šè­¦\n    if (this.alerts.length > 100) {\n      this.alerts.shift()\n    }\n\n    // å‘é€å‘Šè­¦é€šçŸ¥ (è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€Slackç­‰)\n    this.logger.warn(\n      `ğŸš¨ Performance Alert: ${alert.service} ${alert.metric} ${alert.level} - ${alert.currentValue} > ${alert.threshold}`\n    )\n\n    // TODO: é›†æˆSentryæˆ–å…¶ä»–å‘Šè­¦ç³»ç»Ÿ\n  }\n\n  /**\n   * @method gatherCurrentMetrics\n   * @description æ”¶é›†å½“å‰ç³»ç»ŸæŒ‡æ ‡\n   */\n  private async gatherCurrentMetrics(): Promise<PerformanceMetrics> {\n    // è®¡ç®—å“åº”æ—¶é—´ç™¾åˆ†ä½æ•°\n    const sortedTimes = [...this.responseTimes].sort((a, b) => a - b)\n    const p50 = this.calculatePercentile(sortedTimes, 50)\n    const p95 = this.calculatePercentile(sortedTimes, 95)\n    const p99 = this.calculatePercentile(sortedTimes, 99)\n    const avg = this.responseTimes.reduce((a, b) => a + b, 0) / this.responseTimes.length\n\n    // è®¡ç®—é”™è¯¯ç‡\n    const errorRate = this.requestCount > 0 ? (this.errorCount / this.requestCount) * 100 : 0\n\n    // ç³»ç»ŸæŒ‡æ ‡\n    const cpuUsage = (os.loadavg()[0] / os.cpus().length) * 100\n    const memoryUsage = ((os.totalmem() - os.freemem()) / os.totalmem()) * 100\n\n    // æ¨¡æ‹Ÿæ´»è·ƒè¿æ¥æ•° (ç”Ÿäº§ç¯å¢ƒéœ€è¦ä»WebSocketç½‘å…³è·å–)\n    const activeConnections = 0 // TODO: é›†æˆWebSocketè¿æ¥è®¡æ•°\n\n    return {\n      timestamp: Date.now(),\n      service: 'api', // é»˜è®¤ç›‘æ§APIæœåŠ¡\n      responseTime: { p50, p95, p99, avg },\n      errorRate,\n      availability: 99.9, // TODO: è®¡ç®—çœŸå®å¯ç”¨æ€§\n      throughput: this.requestCount,\n      system: {\n        cpuUsage,\n        memoryUsage,\n        activeConnections,\n      },\n    }\n  }\n\n  /**\n   * @method calculatePercentile\n   * @description è®¡ç®—ç™¾åˆ†ä½æ•°\n   */\n  private calculatePercentile(sortedArray: number[], percentile: number): number {\n    if (sortedArray.length === 0) return 0\n\n    const index = (percentile / 100) * (sortedArray.length - 1)\n    const lower = Math.floor(index)\n    const upper = Math.ceil(index)\n\n    if (lower === upper) {\n      return sortedArray[lower]\n    }\n\n    return sortedArray[lower] + (sortedArray[upper] - sortedArray[lower]) * (index - lower)\n  }\n\n  /**\n   * @method getMetrics\n   * @description è·å–æ€§èƒ½æŒ‡æ ‡\n   */\n  getMetrics(hours: number = 1): PerformanceMetrics[] {\n    const cutoff = Date.now() - hours * 60 * 60 * 1000\n    return this.metrics.filter((m) => m.timestamp >= cutoff)\n  }\n\n  /**\n   * @method getAlerts\n   * @description è·å–å‘Šè­¦åˆ—è¡¨\n   */\n  getAlerts(hours: number = 24): AlertCondition[] {\n    const cutoff = Date.now() - hours * 60 * 60 * 1000\n    return this.alerts.filter((a) => a.timestamp >= cutoff)\n  }\n\n  /**\n   * @method getSLASummary\n   * @description è·å–SLAæ‘˜è¦\n   */\n  getSLASummary(): Record<\n    keyof ServiceSLAs,\n    {\n      target: any\n      current: any\n      status: 'healthy' | 'warning' | 'critical' | 'emergency'\n    }\n  > {\n    const summary = {} as any\n    const services = Object.keys(PERFORMANCE_CONFIG.slas) as (keyof ServiceSLAs)[]\n\n    for (const service of services) {\n      const recentMetrics = this.getMetrics(1).filter((m) => m.service === service)\n      const latest = recentMetrics[recentMetrics.length - 1]\n\n      if (latest) {\n        const sla = getSLATarget(service)\n        const rtHealth = isPerformanceHealthy(service, 'responseTime', latest.responseTime.p95)\n        const erHealth = isPerformanceHealthy(service, 'errorRate', latest.errorRate)\n\n        summary[service] = {\n          target: sla,\n          current: {\n            responseTime: latest.responseTime,\n            errorRate: latest.errorRate,\n            availability: latest.availability,\n          },\n          status: rtHealth.healthy && erHealth.healthy ? 'healthy' : rtHealth.level,\n        }\n      } else {\n        summary[service] = {\n          target: getSLATarget(service),\n          current: null,\n          status: 'healthy' as const,\n        }\n      }\n    }\n\n    return summary\n  }\n\n  /**\n   * @method resetCounters\n   * @description é‡ç½®è®¡æ•°å™¨ (ç”¨äºæµ‹è¯•)\n   */\n  resetCounters(): void {\n    this.requestCount = 0\n    this.errorCount = 0\n    this.responseTimes = []\n  }\n}\n"],"version":3}