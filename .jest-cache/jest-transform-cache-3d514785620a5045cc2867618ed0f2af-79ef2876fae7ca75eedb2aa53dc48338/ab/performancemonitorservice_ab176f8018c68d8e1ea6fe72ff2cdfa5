917294d98b03cfd2f638e23604f90444
"use strict";
// Êñá‰ª∂Ë∑ØÂæÑ: packages/common-backend/src/observability/performance-monitor.service.ts
// ËÅåË¥£: ÊÄßËÉΩÁõëÊéßÊúçÂä°ÔºåÂÆûÁé∞SLAÊåáÊ†áÊî∂ÈõÜÂíåÂëäË≠¶
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __runInitializers = (this && this.__runInitializers) || function (thisArg, initializers, value) {
    var useValue = arguments.length > 2;
    for (var i = 0; i < initializers.length; i++) {
        value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);
    }
    return useValue ? value : void 0;
};
var __esDecorate = (this && this.__esDecorate) || function (ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {
    function accept(f) { if (f !== void 0 && typeof f !== "function") throw new TypeError("Function expected"); return f; }
    var kind = contextIn.kind, key = kind === "getter" ? "get" : kind === "setter" ? "set" : "value";
    var target = !descriptorIn && ctor ? contextIn["static"] ? ctor : ctor.prototype : null;
    var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});
    var _, done = false;
    for (var i = decorators.length - 1; i >= 0; i--) {
        var context = {};
        for (var p in contextIn) context[p] = p === "access" ? {} : contextIn[p];
        for (var p in contextIn.access) context.access[p] = contextIn.access[p];
        context.addInitializer = function (f) { if (done) throw new TypeError("Cannot add initializers after decoration has completed"); extraInitializers.push(accept(f || null)); };
        var result = (0, decorators[i])(kind === "accessor" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);
        if (kind === "accessor") {
            if (result === void 0) continue;
            if (result === null || typeof result !== "object") throw new TypeError("Object expected");
            if (_ = accept(result.get)) descriptor.get = _;
            if (_ = accept(result.set)) descriptor.set = _;
            if (_ = accept(result.init)) initializers.unshift(_);
        }
        else if (_ = accept(result)) {
            if (kind === "field") initializers.unshift(_);
            else descriptor[key] = _;
        }
    }
    if (target) Object.defineProperty(target, contextIn.name, descriptor);
    done = true;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.PerformanceMonitorService = void 0;
const common_1 = require("@nestjs/common");
const schedule_1 = require("@nestjs/schedule");
const os = __importStar(require("os"));
const performance_config_1 = require("../config/performance-config");
/**
 * @service PerformanceMonitorService
 * @description ÊÄßËÉΩÁõëÊéßÊúçÂä°
 */
let PerformanceMonitorService = (() => {
    let _classDecorators = [(0, common_1.Injectable)()];
    let _classDescriptor;
    let _classExtraInitializers = [];
    let _classThis;
    let _instanceExtraInitializers = [];
    let _collectMetrics_decorators;
    let _checkSLAViolations_decorators;
    var PerformanceMonitorService = class {
        static { _classThis = this; }
        static {
            const _metadata = typeof Symbol === "function" && Symbol.metadata ? Object.create(null) : void 0;
            _collectMetrics_decorators = [(0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_MINUTE)];
            _checkSLAViolations_decorators = [(0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_5_MINUTES)];
            __esDecorate(this, null, _collectMetrics_decorators, { kind: "method", name: "collectMetrics", static: false, private: false, access: { has: obj => "collectMetrics" in obj, get: obj => obj.collectMetrics }, metadata: _metadata }, null, _instanceExtraInitializers);
            __esDecorate(this, null, _checkSLAViolations_decorators, { kind: "method", name: "checkSLAViolations", static: false, private: false, access: { has: obj => "checkSLAViolations" in obj, get: obj => obj.checkSLAViolations }, metadata: _metadata }, null, _instanceExtraInitializers);
            __esDecorate(null, _classDescriptor = { value: _classThis }, _classDecorators, { kind: "class", name: _classThis.name, metadata: _metadata }, null, _classExtraInitializers);
            PerformanceMonitorService = _classThis = _classDescriptor.value;
            if (_metadata) Object.defineProperty(_classThis, Symbol.metadata, { enumerable: true, configurable: true, writable: true, value: _metadata });
            __runInitializers(_classThis, _classExtraInitializers);
        }
        logger = (__runInitializers(this, _instanceExtraInitializers), new common_1.Logger(PerformanceMonitorService.name));
        // ÊåáÊ†áÂ≠òÂÇ® (ÂÜÖÂ≠ò‰∏≠ÔºåÁîü‰∫ßÁéØÂ¢ÉÂª∫ËÆÆ‰ΩøÁî®RedisÊàñÊï∞ÊçÆÂ∫ì)
        metrics = [];
        alerts = [];
        // ËÆ°Êï∞Âô®
        requestCount = 0;
        errorCount = 0;
        responseTimes = [];
        constructor() {
            this.logger.log('PerformanceMonitorService initialized with SLA targets');
        }
        /**
         * @method recordRequest
         * @description ËÆ∞ÂΩïAPIËØ∑Ê±Ç
         */
        recordRequest(_service, responseTime, isError = false) {
            this.requestCount++;
            this.responseTimes.push(responseTime);
            if (isError) {
                this.errorCount++;
            }
            // ‰øùÊåÅÊúÄËøë1000‰∏™ÂìçÂ∫îÊó∂Èó¥ÁöÑËÆ∞ÂΩï
            if (this.responseTimes.length > 1000) {
                this.responseTimes.shift();
            }
        }
        /**
         * @method collectMetrics
         * @description Êî∂ÈõÜÂΩìÂâçÊÄßËÉΩÊåáÊ†á
         */
        async collectMetrics() {
            try {
                const metrics = await this.gatherCurrentMetrics();
                this.metrics.push(metrics);
                // ‰øùÊåÅÊúÄËøë24Â∞èÊó∂ÁöÑÊï∞ÊçÆ
                const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000;
                this.metrics.splice(0, this.metrics.findIndex((m) => m.timestamp < oneDayAgo));
                // Ê£ÄÊü•SLAÂêàËßÑÊÄß
                await this.checkSLAViolations(metrics);
                this.logger.debug(`Performance metrics collected: ${JSON.stringify(metrics)}`);
            }
            catch (error) {
                this.logger.error('Failed to collect performance metrics:', error);
            }
        }
        /**
         * @method checkSLAViolations
         * @description Ê£ÄÊü•SLAËøùËßÑ
         */
        async checkSLAViolations(metrics) {
            const sla = (0, performance_config_1.getSLATarget)(metrics.service);
            // Ê£ÄÊü•ÂìçÂ∫îÊó∂Èó¥
            const rtHealth = (0, performance_config_1.isPerformanceHealthy)(metrics.service, 'responseTime', metrics.responseTime.p95);
            if (!rtHealth.healthy) {
                await this.createAlert({
                    service: metrics.service,
                    metric: 'responseTime',
                    threshold: sla.responseTime.p95,
                    currentValue: metrics.responseTime.p95,
                    level: rtHealth.level,
                    timestamp: Date.now(),
                });
            }
            // Ê£ÄÊü•ÈîôËØØÁéá
            const erHealth = (0, performance_config_1.isPerformanceHealthy)(metrics.service, 'errorRate', metrics.errorRate);
            if (!erHealth.healthy) {
                await this.createAlert({
                    service: metrics.service,
                    metric: 'errorRate',
                    threshold: sla.errorRate,
                    currentValue: metrics.errorRate,
                    level: erHealth.level,
                    timestamp: Date.now(),
                });
            }
            // Ê£ÄÊü•ÂèØÁî®ÊÄß
            const avHealth = (0, performance_config_1.isPerformanceHealthy)(metrics.service, 'availability', metrics.availability);
            if (!avHealth.healthy) {
                await this.createAlert({
                    service: metrics.service,
                    metric: 'availability',
                    threshold: sla.availability,
                    currentValue: metrics.availability,
                    level: avHealth.level,
                    timestamp: Date.now(),
                });
            }
        }
        /**
         * @method createAlert
         * @description ÂàõÂª∫ÂëäË≠¶
         */
        async createAlert(alert) {
            this.alerts.push(alert);
            // ‰øùÊåÅÊúÄËøë100‰∏™ÂëäË≠¶
            if (this.alerts.length > 100) {
                this.alerts.shift();
            }
            // ÂèëÈÄÅÂëäË≠¶ÈÄöÁü• (ËøôÈáåÂèØ‰ª•ÈõÜÊàêÈÇÆ‰ª∂„ÄÅSlackÁ≠â)
            this.logger.warn(`üö® Performance Alert: ${alert.service} ${alert.metric} ${alert.level} - ${alert.currentValue} > ${alert.threshold}`);
            // TODO: ÈõÜÊàêSentryÊàñÂÖ∂‰ªñÂëäË≠¶Á≥ªÁªü
        }
        /**
         * @method gatherCurrentMetrics
         * @description Êî∂ÈõÜÂΩìÂâçÁ≥ªÁªüÊåáÊ†á
         */
        async gatherCurrentMetrics() {
            // ËÆ°ÁÆóÂìçÂ∫îÊó∂Èó¥ÁôæÂàÜ‰ΩçÊï∞
            const sortedTimes = [...this.responseTimes].sort((a, b) => a - b);
            const p50 = this.calculatePercentile(sortedTimes, 50);
            const p95 = this.calculatePercentile(sortedTimes, 95);
            const p99 = this.calculatePercentile(sortedTimes, 99);
            const avg = this.responseTimes.reduce((a, b) => a + b, 0) / this.responseTimes.length;
            // ËÆ°ÁÆóÈîôËØØÁéá
            const errorRate = this.requestCount > 0 ? (this.errorCount / this.requestCount) * 100 : 0;
            // Á≥ªÁªüÊåáÊ†á
            const cpuUsage = (os.loadavg()[0] / os.cpus().length) * 100;
            const memoryUsage = ((os.totalmem() - os.freemem()) / os.totalmem()) * 100;
            // Ê®°ÊãüÊ¥ªË∑ÉËøûÊé•Êï∞ (Áîü‰∫ßÁéØÂ¢ÉÈúÄË¶Å‰ªéWebSocketÁΩëÂÖ≥Ëé∑Âèñ)
            const activeConnections = 0; // TODO: ÈõÜÊàêWebSocketËøûÊé•ËÆ°Êï∞
            return {
                timestamp: Date.now(),
                service: 'api', // ÈªòËÆ§ÁõëÊéßAPIÊúçÂä°
                responseTime: { p50, p95, p99, avg },
                errorRate,
                availability: 99.9, // TODO: ËÆ°ÁÆóÁúüÂÆûÂèØÁî®ÊÄß
                throughput: this.requestCount,
                system: {
                    cpuUsage,
                    memoryUsage,
                    activeConnections,
                },
            };
        }
        /**
         * @method calculatePercentile
         * @description ËÆ°ÁÆóÁôæÂàÜ‰ΩçÊï∞
         */
        calculatePercentile(sortedArray, percentile) {
            if (sortedArray.length === 0)
                return 0;
            const index = (percentile / 100) * (sortedArray.length - 1);
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            if (lower === upper) {
                return sortedArray[lower];
            }
            return sortedArray[lower] + (sortedArray[upper] - sortedArray[lower]) * (index - lower);
        }
        /**
         * @method getMetrics
         * @description Ëé∑ÂèñÊÄßËÉΩÊåáÊ†á
         */
        getMetrics(hours = 1) {
            const cutoff = Date.now() - hours * 60 * 60 * 1000;
            return this.metrics.filter((m) => m.timestamp >= cutoff);
        }
        /**
         * @method getAlerts
         * @description Ëé∑ÂèñÂëäË≠¶ÂàóË°®
         */
        getAlerts(hours = 24) {
            const cutoff = Date.now() - hours * 60 * 60 * 1000;
            return this.alerts.filter((a) => a.timestamp >= cutoff);
        }
        /**
         * @method getSLASummary
         * @description Ëé∑ÂèñSLAÊëòË¶Å
         */
        getSLASummary() {
            const summary = {};
            const services = Object.keys(performance_config_1.PERFORMANCE_CONFIG.slas);
            for (const service of services) {
                const recentMetrics = this.getMetrics(1).filter((m) => m.service === service);
                const latest = recentMetrics[recentMetrics.length - 1];
                if (latest) {
                    const sla = (0, performance_config_1.getSLATarget)(service);
                    const rtHealth = (0, performance_config_1.isPerformanceHealthy)(service, 'responseTime', latest.responseTime.p95);
                    const erHealth = (0, performance_config_1.isPerformanceHealthy)(service, 'errorRate', latest.errorRate);
                    summary[service] = {
                        target: sla,
                        current: {
                            responseTime: latest.responseTime,
                            errorRate: latest.errorRate,
                            availability: latest.availability,
                        },
                        status: rtHealth.healthy && erHealth.healthy ? 'healthy' : rtHealth.level,
                    };
                }
                else {
                    summary[service] = {
                        target: (0, performance_config_1.getSLATarget)(service),
                        current: null,
                        status: 'healthy',
                    };
                }
            }
            return summary;
        }
        /**
         * @method resetCounters
         * @description ÈáçÁΩÆËÆ°Êï∞Âô® (Áî®‰∫éÊµãËØï)
         */
        resetCounters() {
            this.requestCount = 0;
            this.errorCount = 0;
            this.responseTimes = [];
        }
    };
    return PerformanceMonitorService = _classThis;
})();
exports.PerformanceMonitorService = PerformanceMonitorService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxvYnNlcnZhYmlsaXR5XFxwZXJmb3JtYW5jZS1tb25pdG9yLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBLGlGQUFpRjtBQUNqRiwwQkFBMEI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFMUIsMkNBQW1EO0FBQ25ELCtDQUF1RDtBQUN2RCx1Q0FBd0I7QUFDeEIscUVBS3FDO0FBc0NyQzs7O0dBR0c7SUFFVSx5QkFBeUI7NEJBRHJDLElBQUEsbUJBQVUsR0FBRTs7Ozs7Ozs7Ozs7MENBdUNWLElBQUEsZUFBSSxFQUFDLHlCQUFjLENBQUMsWUFBWSxDQUFDOzhDQTBCakMsSUFBQSxlQUFJLEVBQUMseUJBQWMsQ0FBQyxlQUFlLENBQUM7WUF6QnJDLDZMQUFNLGNBQWMsNkRBbUJuQjtZQU9ELHlNQUFNLGtCQUFrQiw2REF5Q3ZCO1lBMUdILDZLQStQQzs7O1lBL1BZLHVEQUF5Qjs7UUFDbkIsTUFBTSxJQURaLG1EQUF5QixFQUNWLElBQUksZUFBTSxDQUFDLHlCQUF5QixDQUFDLElBQUksQ0FBQyxFQUFBO1FBRXBFLCtCQUErQjtRQUNkLE9BQU8sR0FBeUIsRUFBRSxDQUFBO1FBQ2xDLE1BQU0sR0FBcUIsRUFBRSxDQUFBO1FBRTlDLE1BQU07UUFDRSxZQUFZLEdBQUcsQ0FBQyxDQUFBO1FBQ2hCLFVBQVUsR0FBRyxDQUFDLENBQUE7UUFDZCxhQUFhLEdBQWEsRUFBRSxDQUFBO1FBRXBDO1lBQ0UsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsd0RBQXdELENBQUMsQ0FBQTtRQUMzRSxDQUFDO1FBRUQ7OztXQUdHO1FBQ0gsYUFBYSxDQUFDLFFBQTJCLEVBQUUsWUFBb0IsRUFBRSxPQUFPLEdBQUcsS0FBSztZQUM5RSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7WUFDbkIs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QUFNLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFBO29CQUN2RixNQUFNLFFBQVEsR0FBRyxJQUFBLHlDQUFvQixFQUFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFBO29CQUU3RSxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUc7d0JBQ2pCLE1BQU0sRUFBRSxHQUFHO3dCQUNYLE9BQU8sRUFBRTs0QkFDUCxZQUFZLEVBQUUsTUFBTSxDQUFDLFlBQVk7NEJBQ2pDLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUzs0QkFDM0IsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZO3lCQUNsQzt3QkFDRCxNQUFNLEVBQUUsUUFBUSxDQUFDLE9BQU8sSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLO3FCQUMxRSxDQUFBO2dCQUNILENBQUM7cUJBQU0sQ0FBQztvQkFDTixPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUc7d0JBQ2pCLE1BQU0sRUFBRSxJQUFBLGlDQUFZLEVBQUMsT0FBTyxDQUFDO3dCQUM3QixPQUFPLEVBQUUsSUFBSTt3QkFDYixNQUFNLEVBQUUsU0FBa0I7cUJBQzNCLENBQUE7Z0JBQ0gsQ0FBQztZQUNILENBQUM7WUFFRCxPQUFPLE9BQU8sQ0FBQTtRQUNoQixDQUFDO1FBRUQ7OztXQUdHO1FBQ0gsYUFBYTtZQUNYLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFBO1lBQ3JCLElBQUksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFBO1lBQ25CLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFBO1FBQ3pCLENBQUM7Ozs7QUE5UFUsOERBQXlCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxwYWNrYWdlc1xcY29tbW9uLWJhY2tlbmRcXHNyY1xcb2JzZXJ2YWJpbGl0eVxccGVyZm9ybWFuY2UtbW9uaXRvci5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL29ic2VydmFiaWxpdHkvcGVyZm9ybWFuY2UtbW9uaXRvci5zZXJ2aWNlLnRzXG4vLyDogYzotKM6IOaAp+iDveebkeaOp+acjeWKoe+8jOWunueOsFNMQeaMh+agh+aUtumbhuWSjOWRiuitplxuXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbidcbmltcG9ydCB7IENyb24sIENyb25FeHByZXNzaW9uIH0gZnJvbSAnQG5lc3Rqcy9zY2hlZHVsZSdcbmltcG9ydCAqIGFzIG9zIGZyb20gJ29zJ1xuaW1wb3J0IHtcbiAgZ2V0U0xBVGFyZ2V0LFxuICBpc1BlcmZvcm1hbmNlSGVhbHRoeSxcbiAgUEVSRk9STUFOQ0VfQ09ORklHLFxuICB0eXBlIFNlcnZpY2VTTEFzLFxufSBmcm9tICcuLi9jb25maWcvcGVyZm9ybWFuY2UtY29uZmlnJ1xuXG4vKipcbiAqIEBpbnRlcmZhY2UgUGVyZm9ybWFuY2VNZXRyaWNzXG4gKiBAZGVzY3JpcHRpb24g5oCn6IO95oyH5qCH5pWw5o2u57uT5p6EXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUGVyZm9ybWFuY2VNZXRyaWNzIHtcbiAgdGltZXN0YW1wOiBudW1iZXJcbiAgc2VydmljZToga2V5b2YgU2VydmljZVNMQXNcbiAgcmVzcG9uc2VUaW1lOiB7XG4gICAgcDUwOiBudW1iZXJcbiAgICBwOTU6IG51bWJlclxuICAgIHA5OTogbnVtYmVyXG4gICAgYXZnOiBudW1iZXJcbiAgfVxuICBlcnJvclJhdGU6IG51bWJlclxuICBhdmFpbGFiaWxpdHk6IG51bWJlclxuICB0aHJvdWdocHV0OiBudW1iZXJcbiAgc3lzdGVtOiB7XG4gICAgY3B1VXNhZ2U6IG51bWJlclxuICAgIG1lbW9yeVVzYWdlOiBudW1iZXJcbiAgICBhY3RpdmVDb25uZWN0aW9uczogbnVtYmVyXG4gIH1cbn1cblxuLyoqXG4gKiBAaW50ZXJmYWNlIEFsZXJ0Q29uZGl0aW9uXG4gKiBAZGVzY3JpcHRpb24g5ZGK6K2m5p2h5Lu2XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQWxlcnRDb25kaXRpb24ge1xuICBzZXJ2aWNlOiBrZXlvZiBTZXJ2aWNlU0xBc1xuICBtZXRyaWM6IHN0cmluZ1xuICB0aHJlc2hvbGQ6IG51bWJlclxuICBjdXJyZW50VmFsdWU6IG51bWJlclxuICBsZXZlbDogJ3dhcm5pbmcnIHwgJ2NyaXRpY2FsJyB8ICdlbWVyZ2VuY3knIHwgJ2hlYWx0aHknXG4gIHRpbWVzdGFtcDogbnVtYmVyXG59XG5cbi8qKlxuICogQHNlcnZpY2UgUGVyZm9ybWFuY2VNb25pdG9yU2VydmljZVxuICogQGRlc2NyaXB0aW9uIOaAp+iDveebkeaOp+acjeWKoVxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGVyZm9ybWFuY2VNb25pdG9yU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihQZXJmb3JtYW5jZU1vbml0b3JTZXJ2aWNlLm5hbWUpXG5cbiAgLy8g5oyH5qCH5a2Y5YKoICjlhoXlrZjkuK3vvIznlJ/kuqfnjq/looPlu7rorq7kvb/nlKhSZWRpc+aIluaVsOaNruW6kylcbiAgcHJpdmF0ZSByZWFkb25seSBtZXRyaWNzOiBQZXJmb3JtYW5jZU1ldHJpY3NbXSA9IFtdXG4gIHByaXZhdGUgcmVhZG9ubHkgYWxlcnRzOiBBbGVydENvbmRpdGlvbltdID0gW11cblxuICAvLyDorqHmlbDlmahcbiAgcHJpdmF0ZSByZXF1ZXN0Q291bnQgPSAwXG4gIHByaXZhdGUgZXJyb3JDb3VudCA9IDBcbiAgcHJpdmF0ZSByZXNwb25zZVRpbWVzOiBudW1iZXJbXSA9IFtdXG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5sb2dnZXIubG9nKCdQZXJmb3JtYW5jZU1vbml0b3JTZXJ2aWNlIGluaXRpYWxpemVkIHdpdGggU0xBIHRhcmdldHMnKVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgcmVjb3JkUmVxdWVzdFxuICAgKiBAZGVzY3JpcHRpb24g6K6w5b2VQVBJ6K+35rGCXG4gICAqL1xuICByZWNvcmRSZXF1ZXN0KF9zZXJ2aWNlOiBrZXlvZiBTZXJ2aWNlU0xBcywgcmVzcG9uc2VUaW1lOiBudW1iZXIsIGlzRXJyb3IgPSBmYWxzZSk6IHZvaWQge1xuICAgIHRoaXMucmVxdWVzdENvdW50KytcbiAgICB0aGlzLnJlc3BvbnNlVGltZXMucHVzaChyZXNwb25zZVRpbWUpXG5cbiAgICBpZiAoaXNFcnJvcikge1xuICAgICAgdGhpcy5lcnJvckNvdW50KytcbiAgICB9XG5cbiAgICAvLyDkv53mjIHmnIDov5ExMDAw5Liq5ZON5bqU5pe26Ze055qE6K6w5b2VXG4gICAgaWYgKHRoaXMucmVzcG9uc2VUaW1lcy5sZW5ndGggPiAxMDAwKSB7XG4gICAgICB0aGlzLnJlc3BvbnNlVGltZXMuc2hpZnQoKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGNvbGxlY3RNZXRyaWNzXG4gICAqIEBkZXNjcmlwdGlvbiDmlLbpm4blvZPliY3mgKfog73mjIfmoIdcbiAgICovXG4gIEBDcm9uKENyb25FeHByZXNzaW9uLkVWRVJZX01JTlVURSlcbiAgYXN5bmMgY29sbGVjdE1ldHJpY3MoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCB0aGlzLmdhdGhlckN1cnJlbnRNZXRyaWNzKClcbiAgICAgIHRoaXMubWV0cmljcy5wdXNoKG1ldHJpY3MpXG5cbiAgICAgIC8vIOS/neaMgeacgOi/kTI05bCP5pe255qE5pWw5o2uXG4gICAgICBjb25zdCBvbmVEYXlBZ28gPSBEYXRlLm5vdygpIC0gMjQgKiA2MCAqIDYwICogMTAwMFxuICAgICAgdGhpcy5tZXRyaWNzLnNwbGljZShcbiAgICAgICAgMCxcbiAgICAgICAgdGhpcy5tZXRyaWNzLmZpbmRJbmRleCgobSkgPT4gbS50aW1lc3RhbXAgPCBvbmVEYXlBZ28pXG4gICAgICApXG5cbiAgICAgIC8vIOajgOafpVNMQeWQiOinhOaAp1xuICAgICAgYXdhaXQgdGhpcy5jaGVja1NMQVZpb2xhdGlvbnMobWV0cmljcylcblxuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYFBlcmZvcm1hbmNlIG1ldHJpY3MgY29sbGVjdGVkOiAke0pTT04uc3RyaW5naWZ5KG1ldHJpY3MpfWApXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gY29sbGVjdCBwZXJmb3JtYW5jZSBtZXRyaWNzOicsIGVycm9yKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGNoZWNrU0xBVmlvbGF0aW9uc1xuICAgKiBAZGVzY3JpcHRpb24g5qOA5p+lU0xB6L+d6KeEXG4gICAqL1xuICBAQ3JvbihDcm9uRXhwcmVzc2lvbi5FVkVSWV81X01JTlVURVMpXG4gIGFzeW5jIGNoZWNrU0xBVmlvbGF0aW9ucyhtZXRyaWNzOiBQZXJmb3JtYW5jZU1ldHJpY3MpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzbGEgPSBnZXRTTEFUYXJnZXQobWV0cmljcy5zZXJ2aWNlKVxuXG4gICAgLy8g5qOA5p+l5ZON5bqU5pe26Ze0XG4gICAgY29uc3QgcnRIZWFsdGggPSBpc1BlcmZvcm1hbmNlSGVhbHRoeShtZXRyaWNzLnNlcnZpY2UsICdyZXNwb25zZVRpbWUnLCBtZXRyaWNzLnJlc3BvbnNlVGltZS5wOTUpXG4gICAgaWYgKCFydEhlYWx0aC5oZWFsdGh5KSB7XG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZUFsZXJ0KHtcbiAgICAgICAgc2VydmljZTogbWV0cmljcy5zZXJ2aWNlLFxuICAgICAgICBtZXRyaWM6ICdyZXNwb25zZVRpbWUnLFxuICAgICAgICB0aHJlc2hvbGQ6IHNsYS5yZXNwb25zZVRpbWUucDk1LFxuICAgICAgICBjdXJyZW50VmFsdWU6IG1ldHJpY3MucmVzcG9uc2VUaW1lLnA5NSxcbiAgICAgICAgbGV2ZWw6IHJ0SGVhbHRoLmxldmVsLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICB9KVxuICAgIH1cblxuICAgIC8vIOajgOafpemUmeivr+eOh1xuICAgIGNvbnN0IGVySGVhbHRoID0gaXNQZXJmb3JtYW5jZUhlYWx0aHkobWV0cmljcy5zZXJ2aWNlLCAnZXJyb3JSYXRlJywgbWV0cmljcy5lcnJvclJhdGUpXG4gICAgaWYgKCFlckhlYWx0aC5oZWFsdGh5KSB7XG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZUFsZXJ0KHtcbiAgICAgICAgc2VydmljZTogbWV0cmljcy5zZXJ2aWNlLFxuICAgICAgICBtZXRyaWM6ICdlcnJvclJhdGUnLFxuICAgICAgICB0aHJlc2hvbGQ6IHNsYS5lcnJvclJhdGUsXG4gICAgICAgIGN1cnJlbnRWYWx1ZTogbWV0cmljcy5lcnJvclJhdGUsXG4gICAgICAgIGxldmVsOiBlckhlYWx0aC5sZXZlbCxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgfSlcbiAgICB9XG5cbiAgICAvLyDmo4Dmn6Xlj6/nlKjmgKdcbiAgICBjb25zdCBhdkhlYWx0aCA9IGlzUGVyZm9ybWFuY2VIZWFsdGh5KG1ldHJpY3Muc2VydmljZSwgJ2F2YWlsYWJpbGl0eScsIG1ldHJpY3MuYXZhaWxhYmlsaXR5KVxuICAgIGlmICghYXZIZWFsdGguaGVhbHRoeSkge1xuICAgICAgYXdhaXQgdGhpcy5jcmVhdGVBbGVydCh7XG4gICAgICAgIHNlcnZpY2U6IG1ldHJpY3Muc2VydmljZSxcbiAgICAgICAgbWV0cmljOiAnYXZhaWxhYmlsaXR5JyxcbiAgICAgICAgdGhyZXNob2xkOiBzbGEuYXZhaWxhYmlsaXR5LFxuICAgICAgICBjdXJyZW50VmFsdWU6IG1ldHJpY3MuYXZhaWxhYmlsaXR5LFxuICAgICAgICBsZXZlbDogYXZIZWFsdGgubGV2ZWwsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgY3JlYXRlQWxlcnRcbiAgICogQGRlc2NyaXB0aW9uIOWIm+W7uuWRiuitplxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVBbGVydChhbGVydDogQWxlcnRDb25kaXRpb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmFsZXJ0cy5wdXNoKGFsZXJ0KVxuXG4gICAgLy8g5L+d5oyB5pyA6L+RMTAw5Liq5ZGK6K2mXG4gICAgaWYgKHRoaXMuYWxlcnRzLmxlbmd0aCA+IDEwMCkge1xuICAgICAgdGhpcy5hbGVydHMuc2hpZnQoKVxuICAgIH1cblxuICAgIC8vIOWPkemAgeWRiuitpumAmuefpSAo6L+Z6YeM5Y+v5Lul6ZuG5oiQ6YKu5Lu244CBU2xhY2vnrYkpXG4gICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgIGDwn5qoIFBlcmZvcm1hbmNlIEFsZXJ0OiAke2FsZXJ0LnNlcnZpY2V9ICR7YWxlcnQubWV0cmljfSAke2FsZXJ0LmxldmVsfSAtICR7YWxlcnQuY3VycmVudFZhbHVlfSA+ICR7YWxlcnQudGhyZXNob2xkfWBcbiAgICApXG5cbiAgICAvLyBUT0RPOiDpm4bmiJBTZW50cnnmiJblhbbku5blkYrorabns7vnu59cbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGdhdGhlckN1cnJlbnRNZXRyaWNzXG4gICAqIEBkZXNjcmlwdGlvbiDmlLbpm4blvZPliY3ns7vnu5/mjIfmoIdcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2F0aGVyQ3VycmVudE1ldHJpY3MoKTogUHJvbWlzZTxQZXJmb3JtYW5jZU1ldHJpY3M+IHtcbiAgICAvLyDorqHnrpflk43lupTml7bpl7Tnmb7liIbkvY3mlbBcbiAgICBjb25zdCBzb3J0ZWRUaW1lcyA9IFsuLi50aGlzLnJlc3BvbnNlVGltZXNdLnNvcnQoKGEsIGIpID0+IGEgLSBiKVxuICAgIGNvbnN0IHA1MCA9IHRoaXMuY2FsY3VsYXRlUGVyY2VudGlsZShzb3J0ZWRUaW1lcywgNTApXG4gICAgY29uc3QgcDk1ID0gdGhpcy5jYWxjdWxhdGVQZXJjZW50aWxlKHNvcnRlZFRpbWVzLCA5NSlcbiAgICBjb25zdCBwOTkgPSB0aGlzLmNhbGN1bGF0ZVBlcmNlbnRpbGUoc29ydGVkVGltZXMsIDk5KVxuICAgIGNvbnN0IGF2ZyA9IHRoaXMucmVzcG9uc2VUaW1lcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHRoaXMucmVzcG9uc2VUaW1lcy5sZW5ndGhcblxuICAgIC8vIOiuoeeul+mUmeivr+eOh1xuICAgIGNvbnN0IGVycm9yUmF0ZSA9IHRoaXMucmVxdWVzdENvdW50ID4gMCA/ICh0aGlzLmVycm9yQ291bnQgLyB0aGlzLnJlcXVlc3RDb3VudCkgKiAxMDAgOiAwXG5cbiAgICAvLyDns7vnu5/mjIfmoIdcbiAgICBjb25zdCBjcHVVc2FnZSA9IChvcy5sb2FkYXZnKClbMF0gLyBvcy5jcHVzKCkubGVuZ3RoKSAqIDEwMFxuICAgIGNvbnN0IG1lbW9yeVVzYWdlID0gKChvcy50b3RhbG1lbSgpIC0gb3MuZnJlZW1lbSgpKSAvIG9zLnRvdGFsbWVtKCkpICogMTAwXG5cbiAgICAvLyDmqKHmi5/mtLvot4Pov57mjqXmlbAgKOeUn+S6p+eOr+Wig+mcgOimgeS7jldlYlNvY2tldOe9keWFs+iOt+WPlilcbiAgICBjb25zdCBhY3RpdmVDb25uZWN0aW9ucyA9IDAgLy8gVE9ETzog6ZuG5oiQV2ViU29ja2V06L+e5o6l6K6h5pWwXG5cbiAgICByZXR1cm4ge1xuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgc2VydmljZTogJ2FwaScsIC8vIOm7mOiupOebkeaOp0FQSeacjeWKoVxuICAgICAgcmVzcG9uc2VUaW1lOiB7IHA1MCwgcDk1LCBwOTksIGF2ZyB9LFxuICAgICAgZXJyb3JSYXRlLFxuICAgICAgYXZhaWxhYmlsaXR5OiA5OS45LCAvLyBUT0RPOiDorqHnrpfnnJ/lrp7lj6/nlKjmgKdcbiAgICAgIHRocm91Z2hwdXQ6IHRoaXMucmVxdWVzdENvdW50LFxuICAgICAgc3lzdGVtOiB7XG4gICAgICAgIGNwdVVzYWdlLFxuICAgICAgICBtZW1vcnlVc2FnZSxcbiAgICAgICAgYWN0aXZlQ29ubmVjdGlvbnMsXG4gICAgICB9LFxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGNhbGN1bGF0ZVBlcmNlbnRpbGVcbiAgICogQGRlc2NyaXB0aW9uIOiuoeeul+eZvuWIhuS9jeaVsFxuICAgKi9cbiAgcHJpdmF0ZSBjYWxjdWxhdGVQZXJjZW50aWxlKHNvcnRlZEFycmF5OiBudW1iZXJbXSwgcGVyY2VudGlsZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBpZiAoc29ydGVkQXJyYXkubGVuZ3RoID09PSAwKSByZXR1cm4gMFxuXG4gICAgY29uc3QgaW5kZXggPSAocGVyY2VudGlsZSAvIDEwMCkgKiAoc29ydGVkQXJyYXkubGVuZ3RoIC0gMSlcbiAgICBjb25zdCBsb3dlciA9IE1hdGguZmxvb3IoaW5kZXgpXG4gICAgY29uc3QgdXBwZXIgPSBNYXRoLmNlaWwoaW5kZXgpXG5cbiAgICBpZiAobG93ZXIgPT09IHVwcGVyKSB7XG4gICAgICByZXR1cm4gc29ydGVkQXJyYXlbbG93ZXJdXG4gICAgfVxuXG4gICAgcmV0dXJuIHNvcnRlZEFycmF5W2xvd2VyXSArIChzb3J0ZWRBcnJheVt1cHBlcl0gLSBzb3J0ZWRBcnJheVtsb3dlcl0pICogKGluZGV4IC0gbG93ZXIpXG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBnZXRNZXRyaWNzXG4gICAqIEBkZXNjcmlwdGlvbiDojrflj5bmgKfog73mjIfmoIdcbiAgICovXG4gIGdldE1ldHJpY3MoaG91cnM6IG51bWJlciA9IDEpOiBQZXJmb3JtYW5jZU1ldHJpY3NbXSB7XG4gICAgY29uc3QgY3V0b2ZmID0gRGF0ZS5ub3coKSAtIGhvdXJzICogNjAgKiA2MCAqIDEwMDBcbiAgICByZXR1cm4gdGhpcy5tZXRyaWNzLmZpbHRlcigobSkgPT4gbS50aW1lc3RhbXAgPj0gY3V0b2ZmKVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgZ2V0QWxlcnRzXG4gICAqIEBkZXNjcmlwdGlvbiDojrflj5blkYrorabliJfooahcbiAgICovXG4gIGdldEFsZXJ0cyhob3VyczogbnVtYmVyID0gMjQpOiBBbGVydENvbmRpdGlvbltdIHtcbiAgICBjb25zdCBjdXRvZmYgPSBEYXRlLm5vdygpIC0gaG91cnMgKiA2MCAqIDYwICogMTAwMFxuICAgIHJldHVybiB0aGlzLmFsZXJ0cy5maWx0ZXIoKGEpID0+IGEudGltZXN0YW1wID49IGN1dG9mZilcbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGdldFNMQVN1bW1hcnlcbiAgICogQGRlc2NyaXB0aW9uIOiOt+WPllNMQeaRmOimgVxuICAgKi9cbiAgZ2V0U0xBU3VtbWFyeSgpOiBSZWNvcmQ8XG4gICAga2V5b2YgU2VydmljZVNMQXMsXG4gICAge1xuICAgICAgdGFyZ2V0OiBhbnlcbiAgICAgIGN1cnJlbnQ6IGFueVxuICAgICAgc3RhdHVzOiAnaGVhbHRoeScgfCAnd2FybmluZycgfCAnY3JpdGljYWwnIHwgJ2VtZXJnZW5jeSdcbiAgICB9XG4gID4ge1xuICAgIGNvbnN0IHN1bW1hcnkgPSB7fSBhcyBhbnlcbiAgICBjb25zdCBzZXJ2aWNlcyA9IE9iamVjdC5rZXlzKFBFUkZPUk1BTkNFX0NPTkZJRy5zbGFzKSBhcyAoa2V5b2YgU2VydmljZVNMQXMpW11cblxuICAgIGZvciAoY29uc3Qgc2VydmljZSBvZiBzZXJ2aWNlcykge1xuICAgICAgY29uc3QgcmVjZW50TWV0cmljcyA9IHRoaXMuZ2V0TWV0cmljcygxKS5maWx0ZXIoKG0pID0+IG0uc2VydmljZSA9PT0gc2VydmljZSlcbiAgICAgIGNvbnN0IGxhdGVzdCA9IHJlY2VudE1ldHJpY3NbcmVjZW50TWV0cmljcy5sZW5ndGggLSAxXVxuXG4gICAgICBpZiAobGF0ZXN0KSB7XG4gICAgICAgIGNvbnN0IHNsYSA9IGdldFNMQVRhcmdldChzZXJ2aWNlKVxuICAgICAgICBjb25zdCBydEhlYWx0aCA9IGlzUGVyZm9ybWFuY2VIZWFsdGh5KHNlcnZpY2UsICdyZXNwb25zZVRpbWUnLCBsYXRlc3QucmVzcG9uc2VUaW1lLnA5NSlcbiAgICAgICAgY29uc3QgZXJIZWFsdGggPSBpc1BlcmZvcm1hbmNlSGVhbHRoeShzZXJ2aWNlLCAnZXJyb3JSYXRlJywgbGF0ZXN0LmVycm9yUmF0ZSlcblxuICAgICAgICBzdW1tYXJ5W3NlcnZpY2VdID0ge1xuICAgICAgICAgIHRhcmdldDogc2xhLFxuICAgICAgICAgIGN1cnJlbnQ6IHtcbiAgICAgICAgICAgIHJlc3BvbnNlVGltZTogbGF0ZXN0LnJlc3BvbnNlVGltZSxcbiAgICAgICAgICAgIGVycm9yUmF0ZTogbGF0ZXN0LmVycm9yUmF0ZSxcbiAgICAgICAgICAgIGF2YWlsYWJpbGl0eTogbGF0ZXN0LmF2YWlsYWJpbGl0eSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHN0YXR1czogcnRIZWFsdGguaGVhbHRoeSAmJiBlckhlYWx0aC5oZWFsdGh5ID8gJ2hlYWx0aHknIDogcnRIZWFsdGgubGV2ZWwsXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN1bW1hcnlbc2VydmljZV0gPSB7XG4gICAgICAgICAgdGFyZ2V0OiBnZXRTTEFUYXJnZXQoc2VydmljZSksXG4gICAgICAgICAgY3VycmVudDogbnVsbCxcbiAgICAgICAgICBzdGF0dXM6ICdoZWFsdGh5JyBhcyBjb25zdCxcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBzdW1tYXJ5XG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCByZXNldENvdW50ZXJzXG4gICAqIEBkZXNjcmlwdGlvbiDph43nva7orqHmlbDlmaggKOeUqOS6jua1i+ivlSlcbiAgICovXG4gIHJlc2V0Q291bnRlcnMoKTogdm9pZCB7XG4gICAgdGhpcy5yZXF1ZXN0Q291bnQgPSAwXG4gICAgdGhpcy5lcnJvckNvdW50ID0gMFxuICAgIHRoaXMucmVzcG9uc2VUaW1lcyA9IFtdXG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==