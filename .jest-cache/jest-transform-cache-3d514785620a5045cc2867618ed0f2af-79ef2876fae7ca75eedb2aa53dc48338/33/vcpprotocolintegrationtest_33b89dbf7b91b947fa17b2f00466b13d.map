{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\vcptoolbox\\src\\integration-tests\\vcp-protocol-integration.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\vcptoolbox\\src\\integration-tests\\vcp-protocol-integration.test.ts"],"sourcesContent":["// ============================================================================\r\n// VCP协议核心集成测试\r\n// 验证 VCPToolBox 协议标准的正确集成\r\n// ============================================================================\r\n\r\nimport { Test, TestingModule } from '@nestjs/testing'\r\nimport { ConfigService } from '@nestjs/config'\r\nimport { VCPProtocolService } from '../../../../packages/common-backend/src/vcp/vcp-protocol.service'\r\n\r\ndescribe('VCPProtocolService Integration', () => {\r\n  let service: VCPProtocolService\r\n  let configService: ConfigService\r\n\r\n  beforeEach(async () => {\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        VCPProtocolService,\r\n        {\r\n          provide: ConfigService,\r\n          useValue: {\r\n            get: jest.fn((key: string, defaultValue?: any) => {\r\n              const config = {\r\n                AI_PROVIDER: 'openai',\r\n                AI_MODEL: 'gpt-4'\r\n              }\r\n              return config[key] || defaultValue\r\n            })\r\n          }\r\n        }\r\n      ]\r\n    }).compile()\r\n\r\n    service = module.get<VCPProtocolService>(VCPProtocolService)\r\n    configService = module.get<ConfigService>(ConfigService)\r\n  })\r\n\r\n  it('应该能获取协议统计信息', () => {\r\n    const stats = service.getProtocolStats()\r\n\r\n    expect(stats).toHaveProperty('pendingRequests')\r\n    expect(stats).toHaveProperty('activeEndpoints')\r\n    expect(stats).toHaveProperty('queuedMessages')\r\n    expect(stats).toHaveProperty('activeSubscriptions')\r\n    expect(typeof stats.pendingRequests).toBe('number')\r\n  })\r\n\r\n  it('应该能执行健康检查', async () => {\r\n    const health = await service.healthCheck()\r\n\r\n    expect(health).toHaveProperty('status')\r\n    expect(['healthy', 'error']).toContain(health.status)\r\n\r\n    if (health.status === 'healthy') {\r\n      expect(health).toHaveProperty('details')\r\n    }\r\n  })\r\n\r\n  it('应该能获取可用端点', () => {\r\n    const endpoints = service.getAvailableEndpoints()\r\n\r\n    expect(Array.isArray(endpoints)).toBe(true)\r\n    // 系统端点应该已经被注册\r\n    expect(endpoints.length).toBeGreaterThan(0)\r\n\r\n    // 检查是否有预期的端点\r\n    const aiService = endpoints.find(ep => ep.id === 'ai-service')\r\n    expect(aiService).toBeDefined()\r\n    expect(aiService?.capabilities).toContain('text-generation')\r\n  })\r\n\r\n  it('应该能按能力过滤端点', () => {\r\n    const textGenEndpoints = service.getAvailableEndpoints('text-generation')\r\n\r\n    expect(Array.isArray(textGenEndpoints)).toBe(true)\r\n    textGenEndpoints.forEach(endpoint => {\r\n      expect(endpoint.capabilities).toContain('text-generation')\r\n    })\r\n  })\r\n\r\n  it('应该能注册自定义端点', () => {\r\n    const customEndpoint = {\r\n      id: 'custom-endpoint',\r\n      type: 'tool' as const,\r\n      url: 'http://custom-tool.com',\r\n      capabilities: ['custom-analysis'],\r\n      status: 'online' as const,\r\n      metadata: {\r\n        version: '1.0.0',\r\n        description: 'Custom analysis tool',\r\n        author: 'test',\r\n        lastSeen: new Date()\r\n      }\r\n    }\r\n\r\n    expect(() => {\r\n      service.registerEndpoint(customEndpoint)\r\n    }).not.toThrow()\r\n\r\n    const endpoints = service.getAvailableEndpoints('custom-analysis')\r\n    expect(endpoints.some(ep => ep.id === 'custom-endpoint')).toBe(true)\r\n  })\r\n\r\n  it('应该能注销端点', () => {\r\n    // 先注册一个端点\r\n    const testEndpoint = {\r\n      id: 'test-endpoint-to-remove',\r\n      type: 'service' as const,\r\n      url: 'http://test.com',\r\n      capabilities: ['test-service'],\r\n      status: 'online' as const,\r\n      metadata: {\r\n        version: '1.0.0',\r\n        description: 'Test endpoint',\r\n        author: 'test',\r\n        lastSeen: new Date()\r\n      }\r\n    }\r\n\r\n    service.registerEndpoint(testEndpoint)\r\n\r\n    // 确认端点已注册\r\n    let endpoints = service.getAvailableEndpoints('test-service')\r\n    expect(endpoints.some(ep => ep.id === 'test-endpoint-to-remove')).toBe(true)\r\n\r\n    // 注销端点\r\n    service.unregisterEndpoint('test-endpoint-to-remove')\r\n\r\n    // 确认端点已移除\r\n    endpoints = service.getAvailableEndpoints('test-service')\r\n    expect(endpoints.some(ep => ep.id === 'test-endpoint-to-remove')).toBe(false)\r\n  })\r\n\r\n  it('应该能调用AI生成工具（模拟）', async () => {\r\n    const prompt = '写一个简短的故事'\r\n    const options = {\r\n      model: 'gpt-4',\r\n      temperature: 0.7,\r\n      maxTokens: 500\r\n    }\r\n\r\n    // 由于没有实际的AI服务，这可能会失败或返回模拟结果\r\n    await expect(service.callAIGenerationTool(prompt, options)).rejects.toThrow()\r\n  })\r\n\r\n  it('应该能调用分析工具（模拟）', async () => {\r\n    const content = '这是一个测试文本'\r\n    const analysisType = 'sentiment'\r\n\r\n    await expect(service.callAnalysisTool(content, analysisType)).rejects.toThrow()\r\n  })\r\n\r\n  it('应该能调用翻译工具（模拟）', async () => {\r\n    const text = 'Hello world'\r\n    const targetLanguage = 'zh-CN'\r\n\r\n    const result = await service.callTranslationTool(text, targetLanguage)\r\n    // 当前实现可能返回原文本或模拟结果\r\n    expect(typeof result).toBe('string')\r\n  })\r\n\r\n  it('应该能执行记忆操作（模拟）', async () => {\r\n    // 这些操作可能会失败，因为没有实际的后端服务\r\n    await expect(service.readMemory('test-key')).rejects.toThrow()\r\n    await expect(service.writeMemory('test-key', 'test-value')).rejects.toThrow()\r\n  })\r\n\r\n  it('应该能执行文件操作（模拟）', async () => {\r\n    const fileData = { content: 'test file content' }\r\n\r\n    await expect(service.uploadFile(fileData)).rejects.toThrow()\r\n    await expect(service.downloadFile('test-file-id')).rejects.toThrow()\r\n  })\r\n\r\n  it('应该能发送叙事生成请求（模拟）', async () => {\r\n    const storyId = 'test-story-123'\r\n    const prompt = '写一个科幻故事'\r\n    const context = { genre: 'sci-fi', length: 'short' }\r\n\r\n    const taskId = await service.requestNarrativeGeneration(storyId, prompt, context)\r\n    expect(typeof taskId).toBe('string')\r\n    expect(taskId.length).toBeGreaterThan(0)\r\n  })\r\n\r\n  it('应该能发送Agent协作请求（模拟）', async () => {\r\n    const collaborationId = 'test-collab-123'\r\n    const agentIds = ['agent1', 'agent2']\r\n    const task = { type: 'story-writing', priority: 'high' }\r\n\r\n    const resultId = await service.requestAgentCollaboration(collaborationId, agentIds, task)\r\n    expect(typeof resultId).toBe('string')\r\n  })\r\n\r\n  it('应该能广播系统事件（模拟）', async () => {\r\n    const eventType = 'system.maintenance'\r\n    const eventData = { message: 'System maintenance scheduled', time: '2024-01-01T00:00:00Z' }\r\n\r\n    // 不应该抛出错误\r\n    await expect(service.broadcastSystemEvent(eventType, eventData)).resolves.not.toThrow()\r\n  })\r\n\r\n  it('应该能清理过期任务', async () => {\r\n    // 不应该抛出错误\r\n    await expect(service.cleanupExpiredTasks()).resolves.not.toThrow()\r\n  })\r\n})\r\n"],"version":3}