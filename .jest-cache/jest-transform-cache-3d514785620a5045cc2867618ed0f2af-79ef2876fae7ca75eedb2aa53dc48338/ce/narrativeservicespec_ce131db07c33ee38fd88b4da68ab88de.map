{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\narrative-agent\\src\\__tests__\\narrative.service.spec.ts","mappings":";AAAA,qEAAqE;AACrE,6CAA6C;;AAqB7C,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE,GAAG,EAAE,CAAC,CAAC;IACnC,GAAG,IAAI,CAAC,aAAa,CAAC,kBAAkB,CAAC;IACzC,eAAe,EAAE,IAAI,CAAC,EAAE,EAAE;CAC3B,CAAC,CAAC,CAAA;AArBH,yCAA2C;AAC3C,2CAAkD;AAClD,6CAA0D;AAY1D,0DAA2G;AAC3G,2DAAiE;AACjE,4DAAuD;AAOvD,QAAQ,CAAC,kBAAkB,EAAE,GAAG,EAAE;IAChC,IAAI,OAAyB,CAAA;IAC7B,IAAI,UAAuC,CAAA;IAC3C,IAAI,aAAuD,CAAA;IAC3D,IAAI,iBAAsD,CAAA;IAC1D,IAAI,eAA2C,CAAA;IAC/C,IAAI,YAA4C,CAAA;IAChD,IAAI,qBAA8D,CAAA;IAClE,IAAI,mBAA0D,CAAA;IAC9D,IAAI,wBAA6D,CAAA;IACjE,MAAM,qBAAqB,GAAG,eAA4B,CAAA;IAE1D,MAAM,eAAe,GAAG,EAA8B,CAAA;IACtD,MAAM,YAAY,GAA8B;QAC9C,MAAM,EAAE,UAAU;QAClB,MAAM,EAAE,UAAU;QAClB,YAAY,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE,OAAO,EAAE,aAAa,EAAE;QACzD,kBAAkB,EAAE,EAAE;QACtB,aAAa,EAAE,wBAAwB;KACxC,CAAA;IAED,MAAM,eAAe,GAAG;QACtB,EAAE,EAAE,YAAY,CAAC,MAAM;QACvB,SAAS,EAAE,EAAE,EAAE,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE;QACzC,SAAS,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE,OAAO,EAAE,EAAE,EAAE;KACvC,CAAA;IAED,MAAM,gBAAgB,GAAG;QACvB,SAAS,EAAE,6CAA6C;QACxD,OAAO,EAAE,EAAE;KACZ,CAAA;IAED,UAAU,CAAC,KAAK,IAAI,EAAE;QACpB,UAAU,GAAG,IAAA,6BAAQ,GAAgB,CAAA;QACrC,aAAa,GAAG,IAAA,6BAAQ,GAA6B,CAAA;QACrD,iBAAiB,GAAG,IAAA,6BAAQ,GAAwB,CAAA;QACpD,eAAe,GAAG,IAAA,6BAAQ,GAAe,CAAA;QACzC,YAAY,GAAG,IAAA,6BAAQ,GAAmB,CAAA;QAC1C,qBAAqB,GAAG,IAAA,6BAAQ,GAA4B,CAAA;QAC5D,mBAAmB,GAAG,IAAA,6BAAQ,GAA0B,CAAA;QACxD,wBAAwB,GAAG,IAAA,6BAAQ,GAAwB,CAAA;QAE3D,MAAM,eAAe,GAA+B;YAClD,OAAO,EAAE,IAAI;YACb,KAAK,EAAE,GAAG;YACV,SAAS,EAAE,IAAI;YACf,MAAM,EAAE,QAAQ;SACjB,CAAA;QACD,wBAAwB,CAAC,UAAU,CAAC,iBAAiB,CAAC,eAAe,CAAC,CAAA;QACtE,mBAAmB,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,EAAE,CAAC,CAAA;QAE3D,uDAAuD;QACvD,MAAM,cAAc,GAAG;YACrB,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,cAAc,EAAE;YAChC,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,kBAAkB,CAAC,CAAC,QAAQ,EAAE,EAAE;gBACnD,oCAAoC;gBACpC,IAAI,QAAQ,CAAC,IAAI,EAAE,CAAC;oBAClB,QAAQ,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC,CAAA;gBACpC,CAAC;gBACD,IAAI,QAAQ,CAAC,QAAQ,EAAE,CAAC;oBACtB,QAAQ,CAAC,QAAQ,EAAE,CAAA;gBACrB,CAAC;gBACD,OAAO,EAAE,WAAW,EAAE,IAAI,CAAC,EAAE,EAAE,EAAE,CAAA;YACnC,CAAC,CAAC;YACF,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC;SAC5D,CAAA;QACD,eAAe,CAAC,IAAI,CAAC,eAAe,CAAC,cAAqB,CAAC,CAAA;QAE3D,MAAM,MAAM,GAAkB,MAAM,cAAI,CAAC,mBAAmB,CAAC;YAC3D,SAAS,EAAE;gBACT,oCAAgB;gBAChB,EAAE,OAAO,EAAE,aAAa,EAAE,QAAQ,EAAE,UAAU,EAAE;gBAChD,EAAE,OAAO,EAAE,0CAAyB,EAAE,QAAQ,EAAE,aAAa,EAAE;gBAC/D,EAAE,OAAO,EAAE,oBAAoB,EAAE,QAAQ,EAAE,iBAAiB,EAAE;gBAC9D,EAAE,OAAO,EAAE,mBAAW,EAAE,QAAQ,EAAE,eAAe,EAAE;gBACnD,EAAE,OAAO,EAAE,eAAe,EAAE,QAAQ,EAAE,YAAY,EAAE;gBACpD,EAAE,OAAO,EAAE,wBAAwB,EAAE,QAAQ,EAAE,qBAAqB,EAAE;gBACtE,EAAE,OAAO,EAAE,sBAAsB,EAAE,QAAQ,EAAE,mBAAmB,EAAE;gBAClE,EAAE,OAAO,EAAE,oBAAoB,EAAE,QAAQ,EAAE,wBAAwB,EAAE;aACtE;SACF,CAAC,CAAC,OAAO,EAAE,CAAA;QAEZ,OAAO,GAAG,MAAM,CAAC,GAAG,CAAmB,oCAAgB,CAAC,CAAA;IAC1D,CAAC,CAAC,CAAA;IAEF,SAAS,CAAC,GAAG,EAAE;QACb,IAAI,CAAC,aAAa,EAAE,CAAA;IACtB,CAAC,CAAC,CAAA;IAEF,EAAE,CAAC,mBAAmB,EAAE,GAAG,EAAE;QAC3B,MAAM,CAAC,OAAO,CAAC,CAAC,WAAW,EAAE,CAAA;IAC/B,CAAC,CAAC,CAAA;IAEF,QAAQ,CAAC,+BAA+B,EAAE,GAAG,EAAE;QAC7C,UAAU,CAAC,GAAG,EAAE;YACd,UAAU,CAAC,IAAI,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,eAAwB,CAAC,CAAA;YAC7E,cAAc;YACd,qBAAqB,CAAC,iBAAiB,CAAC,gBAAgB,CAAC,CAAA;YACzD,iBAAiB,CAAC,SAAS,CAAC,eAAe,CAAC,eAAe,CAAC,CAAA;YAC5D,aAAa,CAAC,kBAAkB,CAAC,iBAAiB,CAAC;gBACjD,KAAK,EAAE,eAAe;aACvB,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;QAEF,EAAE,CAAC,0DAA0D,EAAE,KAAK,IAAI,EAAE;YACxE,MAAM,OAAO,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAA;YAE5C,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC,oBAAoB,CAAC;gBAC7D,KAAK,EAAE,EAAE,EAAE,EAAE,YAAY,CAAC,MAAM,EAAE;gBAClC,OAAO,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,SAAS,EAAE,IAAI,EAAE;aAC9C,CAAC,CAAA;YACF,MAAM,CAAC,wBAAwB,CAAC,UAAU,CAAC,CAAC,oBAAoB,CAC9D,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,YAAY,CAAC,EACzC;gBACE,MAAM,EAAE,YAAY,CAAC,MAAM;aAC5B,CACF,CAAA;YACD,MAAM,CAAC,qBAAqB,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAA;YACtD,MAAM,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,oBAAoB,CAAC,aAAa,EAAE;gBAC/D,MAAM,EAAE,YAAY,CAAC,MAAM;gBAC3B,KAAK,EAAE,sBAAsB;gBAC7B,IAAI,EAAE,MAAM,CAAC,gBAAgB,CAAC;oBAC5B,OAAO,EAAE,uBAAuB;oBAChC,WAAW,EAAE,gBAAgB;iBAC9B,CAAC;aACH,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;IAEF,QAAQ,CAAC,mCAAmC,EAAE,GAAG,EAAE;QACjD,EAAE,CAAC,8DAA8D,EAAE,KAAK,IAAI,EAAE;YAC5E,UAAU,CAAC,IAAI,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,IAAI,0BAAiB,EAAE,CAAC,CAAA;YAC5E,MAAM,OAAO,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAA;YAC5C,MAAM,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,oBAAoB,CAAC,aAAa,EAAE;gBAC/D,MAAM,EAAE,YAAY,CAAC,MAAM;gBAC3B,KAAK,EAAE,mBAAmB;gBAC1B,IAAI,EAAE,MAAM,CAAC,gBAAgB,CAAC;oBAC5B,OAAO,EAAE,gDAAgD;oBACzD,KAAK,EAAE,WAAW;iBACnB,CAAC;aACH,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;QAEF,EAAE,CAAC,qDAAqD,EAAE,KAAK,IAAI,EAAE;YACnE,MAAM,OAAO,GAAG,IAAI,qBAAqB,CAAC,WAAW,CAAC,CAAA;YACtD,UAAU,CAAC,IAAI,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,eAAwB,CAAC,CAAA;YAE7E,6CAA6C;YAC7C,aAAa,CAAC,kBAAkB,CAAC,iBAAiB,CAAC;gBACjD,KAAK,EAAE,eAAe;aACvB,CAAC,CAAA;YACF,iBAAiB,CAAC,SAAS,CAAC,eAAe,CAAC,eAAe,CAAC,CAAA;YAE5D,qBAAqB;YACrB,qBAAqB,CAAC,qBAAqB,CAAC,OAAO,CAAC,CAAA;YAEpD,MAAM,OAAO,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAA;YAE5C,MAAM,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,oBAAoB,CAAC,aAAa,EAAE;gBAC/D,MAAM,EAAE,YAAY,CAAC,MAAM;gBAC3B,KAAK,EAAE,mBAAmB;gBAC1B,IAAI,EAAE,MAAM,CAAC,gBAAgB,CAAC;oBAC5B,OAAO,EAAE,gDAAgD;oBACzD,KAAK,EAAE,WAAW;iBACnB,CAAC;aACH,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;QAEF,EAAE,CAAC,iEAAiE,EAAE,KAAK,IAAI,EAAE;YAC/E,wBAAwB,CAAC,UAAU,CAAC,qBAAqB,CAAC;gBACxD,OAAO,EAAE,KAAK;gBACd,KAAK,EAAE,IAAI;gBACX,SAAS,EAAE,IAAI;gBACf,MAAM,EAAE,oBAAoB;gBAC5B,YAAY,EAAE,WAAW;aAC1B,CAAC,CAAA;YAEF,MAAM,OAAO,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAA;YAE5C,MAAM,CAAC,qBAAqB,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAA;YACpD,MAAM,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,oBAAoB,CAAC,aAAa,EAAE;gBAC/D,MAAM,EAAE,YAAY,CAAC,MAAM;gBAC3B,KAAK,EAAE,mBAAmB;gBAC1B,IAAI,EAAE,MAAM,CAAC,gBAAgB,CAAC;oBAC5B,OAAO,EAAE,gDAAgD;iBAC1D,CAAC;aACH,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;AACJ,CAAC,CAAC,CAAA","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\narrative-agent\\src\\__tests__\\narrative.service.spec.ts"],"sourcesContent":["// 文件路径: apps/narrative-agent/src/__tests__/narrative.service.spec.ts\n// 描述: NarrativeService 的单元测试套件，涵盖叙事生成逻辑和错误处理\n\nimport type { BaseChatModel } from '@langchain/core/language_models/chat_models'\nimport { HttpService } from '@nestjs/axios'\nimport { NotFoundException } from '@nestjs/common'\nimport { Test, type TestingModule } from '@nestjs/testing'\nimport type { PrismaClient } from '@prisma/client'\nimport type {\n  AiGenerationException,\n  ContextSummarizerService,\n  callAiWithGuard,\n  MemoryHierarchyService,\n  NarrativeRenderingPayload,\n  PromptInjectionCheckResult,\n  PromptInjectionGuard,\n  PromptManagerService,\n} from '@tuheg/ai-domain'\nimport { DynamicAiSchedulerService, type EventBusService, type PrismaService } from '@tuheg/infrastructure'\nimport { type DeepMockProxy, mockDeep } from 'jest-mock-extended'\nimport { NarrativeService } from '../narrative.service'\n\njest.mock('@tuheg/ai-domain', () => ({\n  ...jest.requireActual('@tuheg/ai-domain'),\n  callAiWithGuard: jest.fn(),\n}))\n\ndescribe('NarrativeService', () => {\n  let service: NarrativeService\n  let prismaMock: DeepMockProxy<PrismaClient>\n  let schedulerMock: DeepMockProxy<DynamicAiSchedulerService>\n  let promptManagerMock: DeepMockProxy<PromptManagerService>\n  let httpServiceMock: DeepMockProxy<HttpService>\n  let eventBusMock: DeepMockProxy<EventBusService>\n  let contextSummarizerMock: DeepMockProxy<ContextSummarizerService>\n  let memoryHierarchyMock: DeepMockProxy<MemoryHierarchyService>\n  let promptInjectionGuardMock: DeepMockProxy<PromptInjectionGuard>\n  const mockedCallAiWithGuard = callAiWithGuard as jest.Mock\n\n  const MOCK_CHAT_MODEL = {} as unknown as BaseChatModel\n  const MOCK_PAYLOAD: NarrativeRenderingPayload = {\n    gameId: 'game-123',\n    userId: 'user-abc',\n    playerAction: { type: 'command', payload: 'Look around' },\n    executedDirectives: [],\n    correlationId: 'test-narrative-corr-id',\n  }\n\n  const MOCK_GAME_STATE = {\n    id: MOCK_PAYLOAD.gameId,\n    character: { id: 'char-1', name: 'Hero' },\n    worldBook: { id: 'wb-1', entries: {} },\n  }\n\n  const MOCK_AI_RESPONSE = {\n    narrative: 'You look around and see a vast, empty room.',\n    options: [],\n  }\n\n  beforeEach(async () => {\n    prismaMock = mockDeep<PrismaClient>()\n    schedulerMock = mockDeep<DynamicAiSchedulerService>()\n    promptManagerMock = mockDeep<PromptManagerService>()\n    httpServiceMock = mockDeep<HttpService>()\n    eventBusMock = mockDeep<EventBusService>()\n    contextSummarizerMock = mockDeep<ContextSummarizerService>()\n    memoryHierarchyMock = mockDeep<MemoryHierarchyService>()\n    promptInjectionGuardMock = mockDeep<PromptInjectionGuard>()\n\n    const guardSafeResult: PromptInjectionCheckResult = {\n      allowed: true,\n      score: 0.1,\n      threshold: 0.75,\n      reason: 'passed',\n    }\n    promptInjectionGuardMock.checkInput.mockResolvedValue(guardSafeResult)\n    memoryHierarchyMock.getActiveMemories.mockResolvedValue([])\n\n    // Mock HttpService post method to return an Observable\n    const mockObservable = {\n      pipe: jest.fn().mockReturnThis(),\n      subscribe: jest.fn().mockImplementation((observer) => {\n        // Simulate successful HTTP response\n        if (observer.next) {\n          observer.next({ data: 'success' })\n        }\n        if (observer.complete) {\n          observer.complete()\n        }\n        return { unsubscribe: jest.fn() }\n      }),\n      toPromise: jest.fn().mockResolvedValue({ data: 'success' }),\n    }\n    httpServiceMock.post.mockReturnValue(mockObservable as any)\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        NarrativeService,\n        { provide: PrismaService, useValue: prismaMock },\n        { provide: DynamicAiSchedulerService, useValue: schedulerMock },\n        { provide: PromptManagerService, useValue: promptManagerMock },\n        { provide: HttpService, useValue: httpServiceMock },\n        { provide: EventBusService, useValue: eventBusMock },\n        { provide: ContextSummarizerService, useValue: contextSummarizerMock },\n        { provide: MemoryHierarchyService, useValue: memoryHierarchyMock },\n        { provide: PromptInjectionGuard, useValue: promptInjectionGuardMock },\n      ],\n    }).compile()\n\n    service = module.get<NarrativeService>(NarrativeService)\n  })\n\n  afterEach(() => {\n    jest.clearAllMocks()\n  })\n\n  it('should be defined', () => {\n    expect(service).toBeDefined()\n  })\n\n  describe('processNarrative (Happy Path)', () => {\n    beforeEach(() => {\n      prismaMock.game.findUniqueOrThrow.mockResolvedValue(MOCK_GAME_STATE as never)\n      // 模拟3次AI调用都成功\n      mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE)\n      promptManagerMock.getPrompt.mockReturnValue('A mock prompt')\n      schedulerMock.getProviderForRole.mockResolvedValue({\n        model: MOCK_CHAT_MODEL,\n      })\n    })\n\n    it('should generate narrative and publish a completion event', async () => {\n      await service.processNarrative(MOCK_PAYLOAD)\n\n      expect(prismaMock.game.findUniqueOrThrow).toHaveBeenCalledWith({\n        where: { id: MOCK_PAYLOAD.gameId },\n        include: { character: true, worldBook: true },\n      })\n      expect(promptInjectionGuardMock.checkInput).toHaveBeenCalledWith(\n        JSON.stringify(MOCK_PAYLOAD.playerAction),\n        {\n          userId: MOCK_PAYLOAD.userId,\n        }\n      )\n      expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1)\n      expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {\n        userId: MOCK_PAYLOAD.userId,\n        event: 'processing_completed',\n        data: expect.objectContaining({\n          message: 'AI response received.',\n          progression: MOCK_AI_RESPONSE,\n        }),\n      })\n    })\n  })\n\n  describe('processNarrative (Error Handling)', () => {\n    it('should handle NotFoundException and send failure via gateway', async () => {\n      prismaMock.game.findUniqueOrThrow.mockRejectedValue(new NotFoundException())\n      await service.processNarrative(MOCK_PAYLOAD)\n      expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {\n        userId: MOCK_PAYLOAD.userId,\n        event: 'processing_failed',\n        data: expect.objectContaining({\n          message: 'An error occurred during narrative generation.',\n          error: 'Not Found',\n        }),\n      })\n    })\n\n    it('should handle AI error and send failure via gateway', async () => {\n      const aiError = new AiGenerationException('AI failed')\n      prismaMock.game.findUniqueOrThrow.mockResolvedValue(MOCK_GAME_STATE as never)\n\n      // [核心修复] 即使在失败场景下，我们也要先告诉 schedulerMock 该做什么\n      schedulerMock.getProviderForRole.mockResolvedValue({\n        model: MOCK_CHAT_MODEL,\n      })\n      promptManagerMock.getPrompt.mockReturnValue('A mock prompt')\n\n      // 然后，我们再模拟 AI 调用本身失败\n      mockedCallAiWithGuard.mockRejectedValueOnce(aiError)\n\n      await service.processNarrative(MOCK_PAYLOAD)\n\n      expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {\n        userId: MOCK_PAYLOAD.userId,\n        event: 'processing_failed',\n        data: expect.objectContaining({\n          message: 'An error occurred during narrative generation.',\n          error: 'AI failed',\n        }),\n      })\n    })\n\n    it('should reject promptly when prompt injection guard blocks input', async () => {\n      promptInjectionGuardMock.checkInput.mockResolvedValueOnce({\n        allowed: false,\n        score: 0.98,\n        threshold: 0.75,\n        reason: 'threshold-exceeded',\n        inputPreview: 'malicious',\n      })\n\n      await service.processNarrative(MOCK_PAYLOAD)\n\n      expect(mockedCallAiWithGuard).not.toHaveBeenCalled()\n      expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {\n        userId: MOCK_PAYLOAD.userId,\n        event: 'processing_failed',\n        data: expect.objectContaining({\n          message: 'An error occurred during narrative generation.',\n        }),\n      })\n    })\n  })\n})\n"],"version":3}