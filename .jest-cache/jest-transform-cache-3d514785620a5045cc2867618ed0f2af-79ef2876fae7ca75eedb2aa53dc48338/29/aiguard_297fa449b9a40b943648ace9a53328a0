360a01e1db7453ca6a5dd1cbe4cf39e9
"use strict";
// 文件路径: packages/common-backend/src/ai/ai-guard.ts
var __esDecorate = (this && this.__esDecorate) || function (ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {
    function accept(f) { if (f !== void 0 && typeof f !== "function") throw new TypeError("Function expected"); return f; }
    var kind = contextIn.kind, key = kind === "getter" ? "get" : kind === "setter" ? "set" : "value";
    var target = !descriptorIn && ctor ? contextIn["static"] ? ctor : ctor.prototype : null;
    var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});
    var _, done = false;
    for (var i = decorators.length - 1; i >= 0; i--) {
        var context = {};
        for (var p in contextIn) context[p] = p === "access" ? {} : contextIn[p];
        for (var p in contextIn.access) context.access[p] = contextIn.access[p];
        context.addInitializer = function (f) { if (done) throw new TypeError("Cannot add initializers after decoration has completed"); extraInitializers.push(accept(f || null)); };
        var result = (0, decorators[i])(kind === "accessor" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);
        if (kind === "accessor") {
            if (result === void 0) continue;
            if (result === null || typeof result !== "object") throw new TypeError("Object expected");
            if (_ = accept(result.get)) descriptor.get = _;
            if (_ = accept(result.set)) descriptor.set = _;
            if (_ = accept(result.init)) initializers.unshift(_);
        }
        else if (_ = accept(result)) {
            if (kind === "field") initializers.unshift(_);
            else descriptor[key] = _;
        }
    }
    if (target) Object.defineProperty(target, contextIn.name, descriptor);
    done = true;
};
var __runInitializers = (this && this.__runInitializers) || function (thisArg, initializers, value) {
    var useValue = arguments.length > 2;
    for (var i = 0; i < initializers.length; i++) {
        value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);
    }
    return useValue ? value : void 0;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PromptInjectionGuard = void 0;
exports.callAiWithGuard = callAiWithGuard;
const common_1 = require("@nestjs/common");
const prompt_injection_detected_exception_1 = require("../errors/prompt-injection-detected.exception");
const ai_exception_1 = require("../exceptions/ai-exception");
/**
 * 提示注入防护服务
 * 提供AI输入的安全检查功能
 */
let PromptInjectionGuard = (() => {
    let _classDecorators = [(0, common_1.Injectable)()];
    let _classDescriptor;
    let _classExtraInitializers = [];
    let _classThis;
    var PromptInjectionGuard = class {
        static { _classThis = this; }
        static {
            const _metadata = typeof Symbol === "function" && Symbol.metadata ? Object.create(null) : void 0;
            __esDecorate(null, _classDescriptor = { value: _classThis }, _classDecorators, { kind: "class", name: _classThis.name, metadata: _metadata }, null, _classExtraInitializers);
            PromptInjectionGuard = _classThis = _classDescriptor.value;
            if (_metadata) Object.defineProperty(_classThis, Symbol.metadata, { enumerable: true, configurable: true, writable: true, value: _metadata });
            __runInitializers(_classThis, _classExtraInitializers);
        }
        threshold = 0.7;
        /**
         * 检查输入是否包含提示注入攻击
         * @param input 用户输入
         * @param context 上下文信息
         * @returns 检查结果
         */
        async checkInput(input, context) {
            // 简单的实现 - 在实际项目中应该使用更复杂的检测逻辑
            const suspiciousPatterns = [
                /ignore.*previous.*instructions/i,
                /system.*prompt/i,
                /override.*settings/i,
                /bypass.*restrictions/i,
            ];
            const score = suspiciousPatterns.some((pattern) => pattern.test(input)) ? 0.9 : 0.1;
            if (score >= this.threshold) {
                throw new prompt_injection_detected_exception_1.PromptInjectionDetectedException('Potential prompt injection detected', {
                    score,
                    threshold: this.threshold,
                    preview: input.substring(0, 100),
                    context: context?.correlationId ?? undefined,
                    correlationId: context?.correlationId ?? undefined,
                    userId: context?.userId,
                });
            }
            return {
                allowed: true,
                score,
                threshold: this.threshold,
                reason: score < this.threshold ? 'passed' : 'failed',
                details: {
                    preview: input.substring(0, 100),
                },
            };
        }
        /**
         * 检查输入并在不安全时抛出异常
         * @param input 用户输入
         * @param context 上下文信息
         */
        async ensureSafeOrThrow(input, context) {
            const result = await this.checkInput(input, context);
            if (!result.allowed) {
                throw new prompt_injection_detected_exception_1.PromptInjectionDetectedException('Input failed security check', {
                    score: result.score,
                    threshold: result.threshold,
                    preview: result.details?.preview ?? undefined,
                    context: context?.correlationId ?? undefined,
                    correlationId: context?.correlationId ?? undefined,
                    userId: context?.userId ?? undefined,
                });
            }
        }
    };
    return PromptInjectionGuard = _classThis;
})();
exports.PromptInjectionGuard = PromptInjectionGuard;
const MAX_RETRIES = 2;
/**
 * [核心护栏] 使用Zod Schema安全地调用AI提供商，并提供自动重试和超时机制。
 * @param provider AI提供商实例
 * @param prompt 要发送给AI的提示文本
 * @param schema 用于验证输出的Zod Schema
 * @param timeoutMs 超时时间（毫秒），默认为30000ms (30秒)
 * @returns 一个Promise，成功时解析为符合Schema的类型安全数据
 * @throws {AiGenerationException} 如果AI在多次重试后仍无法生成有效数据或超时
 */
async function callAiWithGuard(provider, // 简化的接口
prompt, schema, timeoutMs = 30000 // 默认30秒超时
) {
    let lastError = null;
    for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
        try {
            // [新增] 创建带超时的Promise
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => {
                    reject(new Error(`AI request timed out after ${timeoutMs}ms`));
                }, timeoutMs);
            });
            // 竞态执行：AI调用 vs 超时
            const response = await Promise.race([provider.generate({ prompt, temperature: 0.7 }), timeoutPromise]);
            // 尝试解析响应字符串
            const dataToParse = JSON.parse(response);
            const parseResult = await schema.safeParseAsync(dataToParse);
            if (parseResult.success) {
                return parseResult.data;
            }
            else {
                lastError = parseResult.error;
                console.warn(`[AI Guard] Attempt ${attempt + 1} failed validation:`, lastError);
            }
        }
        catch (error) {
            lastError = error;
            console.error(`[AI Guard] Attempt ${attempt + 1} failed with invocation error:`, error);
            // 如果是超时错误，直接抛出，不再重试
            if (error instanceof Error && error.message.includes('timed out')) {
                throw new ai_exception_1.AiGenerationException(`AI request timed out after ${timeoutMs}ms`, error);
            }
        }
    }
    // 如果所有尝试都失败了，则抛出最终的异常
    throw new ai_exception_1.AiGenerationException(`AI failed to generate valid data after ${MAX_RETRIES + 1} attempts.`, lastError);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxhaVxcYWktZ3VhcmQudHMiLCJtYXBwaW5ncyI6IjtBQUFBLG1EQUFtRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQTBHbkQsMENBK0NDO0FBdkpELDJDQUEyQztBQUUzQyx1R0FBZ0c7QUFDaEcsNkRBQWtFO0FBaUJsRTs7O0dBR0c7SUFFVSxvQkFBb0I7NEJBRGhDLElBQUEsbUJBQVUsR0FBRTs7Ozs7Ozs7WUFDYiw2S0FrRUM7OztZQWxFWSx1REFBb0I7O1FBQ2QsU0FBUyxHQUFHLEdBQUcsQ0FBQTtRQUVoQzs7Ozs7V0FLRztRQUNILEtBQUssQ0FBQyxVQUFVLENBQ2QsS0FBYSxFQUNiLE9BQXFEO1lBRXJELDZCQUE2QjtZQUM3QixNQUFNLGtCQUFrQixHQUFHO2dCQUN6QixpQ0FBaUM7Z0JBQ2pDLGlCQUFpQjtnQkFDakIscUJBQXFCO2dCQUNyQix1QkFBdUI7YUFDeEIsQ0FBQTtZQUVELE1BQU0sS0FBSyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQTtZQUVuRixJQUFJLEtBQUssSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQzVCLE1BQU0sSUFBSSxzRUFBZ0MsQ0FBQyxxQ0FBcUMsRUFBRTtvQkFDaEYsS0FBSztvQkFDTCxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7b0JBQ3pCLE9BQU8sRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUM7b0JBQ2hDLE9BQU8sRUFBRSxPQUFPLEVBQUUsYUFBYSxJQUFJLFNBQVM7b0JBQzVDLGFBQWEsRUFBRSxPQUFPLEVBQUUsYUFBYSxJQUFJLFNBQVM7b0JBQ2xELE1B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LEtBQUssRUFBRSxDQUFDO1lBQ2YsU0FBUyxHQUFHLEtBQUssQ0FBQTtZQUNqQixPQUFPLENBQUMsS0FBSyxDQUFDLHNCQUFzQixPQUFPLEdBQUcsQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsQ0FBQTtZQUV2RixvQkFBb0I7WUFDcEIsSUFBSSxLQUFLLFlBQVksS0FBSyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7Z0JBQ2xFLE1BQU0sSUFBSSxvQ0FBcUIsQ0FBQyw4QkFBOEIsU0FBUyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUE7WUFDckYsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0lBRUQsc0JBQXNCO0lBQ3RCLE1BQU0sSUFBSSxvQ0FBcUIsQ0FDN0IsMENBQTBDLFdBQVcsR0FBRyxDQUFDLFlBQVksRUFDckUsU0FBUyxDQUNWLENBQUE7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxwYWNrYWdlc1xcY29tbW9uLWJhY2tlbmRcXHNyY1xcYWlcXGFpLWd1YXJkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL2FpL2FpLWd1YXJkLnRzXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbidcbmltcG9ydCB0eXBlIHsgeiB9IGZyb20gJ3pvZCdcbmltcG9ydCB7IFByb21wdEluamVjdGlvbkRldGVjdGVkRXhjZXB0aW9uIH0gZnJvbSAnLi4vZXJyb3JzL3Byb21wdC1pbmplY3Rpb24tZGV0ZWN0ZWQuZXhjZXB0aW9uJ1xuaW1wb3J0IHsgQWlHZW5lcmF0aW9uRXhjZXB0aW9uIH0gZnJvbSAnLi4vZXhjZXB0aW9ucy9haS1leGNlcHRpb24nXG5cbi8qKlxuICog5o+Q56S65rOo5YWl5qOA5p+l57uT5p6c57G75Z6LXG4gKi9cbmV4cG9ydCB0eXBlIFByb21wdEluamVjdGlvbkNoZWNrUmVzdWx0ID0ge1xuICBhbGxvd2VkOiBib29sZWFuXG4gIHNjb3JlOiBudW1iZXJcbiAgdGhyZXNob2xkOiBudW1iZXJcbiAgcmVhc29uOiBzdHJpbmdcbiAgaW5wdXRQcmV2aWV3Pzogc3RyaW5nXG4gIGRldGFpbHM/OiB7XG4gICAgcHJldmlldz86IHN0cmluZ1xuICAgIGNvbnRleHQ/OiBzdHJpbmdcbiAgfVxufVxuXG4vKipcbiAqIOaPkOekuuazqOWFpemYsuaKpOacjeWKoVxuICog5o+Q5L6bQUnovpPlhaXnmoTlronlhajmo4Dmn6Xlip/og71cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFByb21wdEluamVjdGlvbkd1YXJkIHtcbiAgcHJpdmF0ZSByZWFkb25seSB0aHJlc2hvbGQgPSAwLjdcblxuICAvKipcbiAgICog5qOA5p+l6L6T5YWl5piv5ZCm5YyF5ZCr5o+Q56S65rOo5YWl5pS75Ye7XG4gICAqIEBwYXJhbSBpbnB1dCDnlKjmiLfovpPlhaVcbiAgICogQHBhcmFtIGNvbnRleHQg5LiK5LiL5paH5L+h5oGvXG4gICAqIEByZXR1cm5zIOajgOafpee7k+aenFxuICAgKi9cbiAgYXN5bmMgY2hlY2tJbnB1dChcbiAgICBpbnB1dDogc3RyaW5nLFxuICAgIGNvbnRleHQ/OiB7IHVzZXJJZD86IHN0cmluZzsgY29ycmVsYXRpb25JZD86IHN0cmluZyB9XG4gICk6IFByb21pc2U8UHJvbXB0SW5qZWN0aW9uQ2hlY2tSZXN1bHQ+IHtcbiAgICAvLyDnroDljZXnmoTlrp7njrAgLSDlnKjlrp7pmYXpobnnm67kuK3lupTor6Xkvb/nlKjmm7TlpI3mnYLnmoTmo4DmtYvpgLvovpFcbiAgICBjb25zdCBzdXNwaWNpb3VzUGF0dGVybnMgPSBbXG4gICAgICAvaWdub3JlLipwcmV2aW91cy4qaW5zdHJ1Y3Rpb25zL2ksXG4gICAgICAvc3lzdGVtLipwcm9tcHQvaSxcbiAgICAgIC9vdmVycmlkZS4qc2V0dGluZ3MvaSxcbiAgICAgIC9ieXBhc3MuKnJlc3RyaWN0aW9ucy9pLFxuICAgIF1cblxuICAgIGNvbnN0IHNjb3JlID0gc3VzcGljaW91c1BhdHRlcm5zLnNvbWUoKHBhdHRlcm4pID0+IHBhdHRlcm4udGVzdChpbnB1dCkpID8gMC45IDogMC4xXG5cbiAgICBpZiAoc2NvcmUgPj0gdGhpcy50aHJlc2hvbGQpIHtcbiAgICAgIHRocm93IG5ldyBQcm9tcHRJbmplY3Rpb25EZXRlY3RlZEV4Y2VwdGlvbignUG90ZW50aWFsIHByb21wdCBpbmplY3Rpb24gZGV0ZWN0ZWQnLCB7XG4gICAgICAgIHNjb3JlLFxuICAgICAgICB0aHJlc2hvbGQ6IHRoaXMudGhyZXNob2xkLFxuICAgICAgICBwcmV2aWV3OiBpbnB1dC5zdWJzdHJpbmcoMCwgMTAwKSxcbiAgICAgICAgY29udGV4dDogY29udGV4dD8uY29ycmVsYXRpb25JZCA/PyB1bmRlZmluZWQsXG4gICAgICAgIGNvcnJlbGF0aW9uSWQ6IGNvbnRleHQ/LmNvcnJlbGF0aW9uSWQgPz8gdW5kZWZpbmVkLFxuICAgICAgICB1c2VySWQ6IGNvbnRleHQ/LnVzZXJJZCxcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGFsbG93ZWQ6IHRydWUsXG4gICAgICBzY29yZSxcbiAgICAgIHRocmVzaG9sZDogdGhpcy50aHJlc2hvbGQsXG4gICAgICByZWFzb246IHNjb3JlIDwgdGhpcy50aHJlc2hvbGQgPyAncGFzc2VkJyA6ICdmYWlsZWQnLFxuICAgICAgZGV0YWlsczoge1xuICAgICAgICBwcmV2aWV3OiBpbnB1dC5zdWJzdHJpbmcoMCwgMTAwKSxcbiAgICAgIH0sXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOajgOafpei+k+WFpeW5tuWcqOS4jeWuieWFqOaXtuaKm+WHuuW8guW4uFxuICAgKiBAcGFyYW0gaW5wdXQg55So5oi36L6T5YWlXG4gICAqIEBwYXJhbSBjb250ZXh0IOS4iuS4i+aWh+S/oeaBr1xuICAgKi9cbiAgYXN5bmMgZW5zdXJlU2FmZU9yVGhyb3coXG4gICAgaW5wdXQ6IHN0cmluZyxcbiAgICBjb250ZXh0PzogeyB1c2VySWQ/OiBzdHJpbmc7IGNvcnJlbGF0aW9uSWQ/OiBzdHJpbmcgfVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmNoZWNrSW5wdXQoaW5wdXQsIGNvbnRleHQpXG4gICAgaWYgKCFyZXN1bHQuYWxsb3dlZCkge1xuICAgICAgdGhyb3cgbmV3IFByb21wdEluamVjdGlvbkRldGVjdGVkRXhjZXB0aW9uKCdJbnB1dCBmYWlsZWQgc2VjdXJpdHkgY2hlY2snLCB7XG4gICAgICAgIHNjb3JlOiByZXN1bHQuc2NvcmUsXG4gICAgICAgIHRocmVzaG9sZDogcmVzdWx0LnRocmVzaG9sZCxcbiAgICAgICAgcHJldmlldzogcmVzdWx0LmRldGFpbHM/LnByZXZpZXcgPz8gdW5kZWZpbmVkLFxuICAgICAgICBjb250ZXh0OiBjb250ZXh0Py5jb3JyZWxhdGlvbklkID8/IHVuZGVmaW5lZCxcbiAgICAgICAgY29ycmVsYXRpb25JZDogY29udGV4dD8uY29ycmVsYXRpb25JZCA/PyB1bmRlZmluZWQsXG4gICAgICAgIHVzZXJJZDogY29udGV4dD8udXNlcklkID8/IHVuZGVmaW5lZCxcbiAgICAgIH0pXG4gICAgfVxuICB9XG59XG5cbmNvbnN0IE1BWF9SRVRSSUVTID0gMlxuXG4vKipcbiAqIFvmoLjlv4PmiqTmoI9dIOS9v+eUqFpvZCBTY2hlbWHlronlhajlnLDosIPnlKhBSeaPkOS+m+WVhu+8jOW5tuaPkOS+m+iHquWKqOmHjeivleWSjOi2heaXtuacuuWItuOAglxuICogQHBhcmFtIHByb3ZpZGVyIEFJ5o+Q5L6b5ZWG5a6e5L6LXG4gKiBAcGFyYW0gcHJvbXB0IOimgeWPkemAgee7mUFJ55qE5o+Q56S65paH5pysXG4gKiBAcGFyYW0gc2NoZW1hIOeUqOS6jumqjOivgei+k+WHuueahFpvZCBTY2hlbWFcbiAqIEBwYXJhbSB0aW1lb3V0TXMg6LaF5pe25pe26Ze077yI5q+r56eS77yJ77yM6buY6K6k5Li6MzAwMDBtcyAoMzDnp5IpXG4gKiBAcmV0dXJucyDkuIDkuKpQcm9taXNl77yM5oiQ5Yqf5pe26Kej5p6Q5Li656ym5ZCIU2NoZW1h55qE57G75Z6L5a6J5YWo5pWw5o2uXG4gKiBAdGhyb3dzIHtBaUdlbmVyYXRpb25FeGNlcHRpb259IOWmguaenEFJ5Zyo5aSa5qyh6YeN6K+V5ZCO5LuN5peg5rOV55Sf5oiQ5pyJ5pWI5pWw5o2u5oiW6LaF5pe2XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjYWxsQWlXaXRoR3VhcmQ8VCBleHRlbmRzIHouWm9kVHlwZT4oXG4gIHByb3ZpZGVyOiB7IGdlbmVyYXRlOiAob3B0aW9uczogeyBwcm9tcHQ6IHN0cmluZzsgdGVtcGVyYXR1cmU/OiBudW1iZXIgfSkgPT4gUHJvbWlzZTxzdHJpbmc+IH0sIC8vIOeugOWMlueahOaOpeWPo1xuICBwcm9tcHQ6IHN0cmluZyxcbiAgc2NoZW1hOiBULFxuICB0aW1lb3V0TXM6IG51bWJlciA9IDMwMDAwIC8vIOm7mOiupDMw56eS6LaF5pe2XG4pOiBQcm9taXNlPHouaW5mZXI8VD4+IHtcbiAgbGV0IGxhc3RFcnJvcjogdW5rbm93biA9IG51bGxcblxuICBmb3IgKGxldCBhdHRlbXB0ID0gMDsgYXR0ZW1wdCA8PSBNQVhfUkVUUklFUzsgYXR0ZW1wdCsrKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFvmlrDlop5dIOWIm+W7uuW4pui2heaXtueahFByb21pc2VcbiAgICAgIGNvbnN0IHRpbWVvdXRQcm9taXNlID0gbmV3IFByb21pc2U8bmV2ZXI+KChfLCByZWplY3QpID0+IHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgQUkgcmVxdWVzdCB0aW1lZCBvdXQgYWZ0ZXIgJHt0aW1lb3V0TXN9bXNgKSlcbiAgICAgICAgfSwgdGltZW91dE1zKVxuICAgICAgfSlcblxuICAgICAgLy8g56ue5oCB5omn6KGM77yaQUnosIPnlKggdnMg6LaF5pe2XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IFByb21pc2UucmFjZShbcHJvdmlkZXIuZ2VuZXJhdGUoeyBwcm9tcHQsIHRlbXBlcmF0dXJlOiAwLjcgfSksIHRpbWVvdXRQcm9taXNlXSlcblxuICAgICAgLy8g5bCd6K+V6Kej5p6Q5ZON5bqU5a2X56ym5LiyXG4gICAgICBjb25zdCBkYXRhVG9QYXJzZSA9IEpTT04ucGFyc2UocmVzcG9uc2UpXG5cbiAgICAgIGNvbnN0IHBhcnNlUmVzdWx0ID0gYXdhaXQgc2NoZW1hLnNhZmVQYXJzZUFzeW5jKGRhdGFUb1BhcnNlKVxuXG4gICAgICBpZiAocGFyc2VSZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gcGFyc2VSZXN1bHQuZGF0YVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGFzdEVycm9yID0gcGFyc2VSZXN1bHQuZXJyb3JcbiAgICAgICAgY29uc29sZS53YXJuKGBbQUkgR3VhcmRdIEF0dGVtcHQgJHthdHRlbXB0ICsgMX0gZmFpbGVkIHZhbGlkYXRpb246YCwgbGFzdEVycm9yKVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsYXN0RXJyb3IgPSBlcnJvclxuICAgICAgY29uc29sZS5lcnJvcihgW0FJIEd1YXJkXSBBdHRlbXB0ICR7YXR0ZW1wdCArIDF9IGZhaWxlZCB3aXRoIGludm9jYXRpb24gZXJyb3I6YCwgZXJyb3IpXG5cbiAgICAgIC8vIOWmguaenOaYr+i2heaXtumUmeivr++8jOebtOaOpeaKm+WHuu+8jOS4jeWGjemHjeivlVxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygndGltZWQgb3V0JykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFpR2VuZXJhdGlvbkV4Y2VwdGlvbihgQUkgcmVxdWVzdCB0aW1lZCBvdXQgYWZ0ZXIgJHt0aW1lb3V0TXN9bXNgLCBlcnJvcilcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyDlpoLmnpzmiYDmnInlsJ3or5Xpg73lpLHotKXkuobvvIzliJnmipvlh7rmnIDnu4jnmoTlvILluLhcbiAgdGhyb3cgbmV3IEFpR2VuZXJhdGlvbkV4Y2VwdGlvbihcbiAgICBgQUkgZmFpbGVkIHRvIGdlbmVyYXRlIHZhbGlkIGRhdGEgYWZ0ZXIgJHtNQVhfUkVUUklFUyArIDF9IGF0dGVtcHRzLmAsXG4gICAgbGFzdEVycm9yXG4gIClcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==