{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\__tests__\\logic.service.spec.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\__tests__\\logic.service.spec.ts"],"sourcesContent":["// 文件路径: apps/logic-agent/src/__tests__/logic.service.spec.ts\n\nimport { Test, type TestingModule } from '@nestjs/testing'\nimport {\n  callAiWithGuard,\n  type DirectiveSet,\n  DynamicAiSchedulerService,\n  EventBusService,\n  type GameActionJobData,\n  PrismaService,\n  PromptInjectionGuard,\n  PromptManagerService,\n} from '@tuheg/common-backend'\nimport { type MockProxy, mock } from 'jest-mock-extended'\nimport { LogicService } from '../logic.service'\nimport { RuleEngineService } from '../rule-engine.service'\n\n// [核心] 模拟 @tuheg/common-backend 模块，特别是 callAiWithGuard 函数\njest.mock('@tuheg/common-backend', () => ({\n  ...jest.requireActual('@tuheg/common-backend'), // 保留其他真实导出\n  callAiWithGuard: jest.fn(), // 将 callAiWithGuard 替换为一个 Jest 模拟函数\n}))\n\ndescribe('LogicService', () => {\n  let logicService: LogicService\n  let ruleEngineService: RuleEngineService\n  let eventBusService: MockProxy<EventBusService>\n\n  // 将模拟函数类型化，便于在测试中进行类型提示\n  const mockedCallAiWithGuard = callAiWithGuard as jest.Mock\n\n  beforeEach(async () => {\n    // 使用 jest-mock-extended 创建所有依赖的深度模拟对象\n    const eventBusMock = mock<EventBusService>()\n    const prismaMock = mock<PrismaService>()\n    const schedulerMock = mock<DynamicAiSchedulerService>()\n    schedulerMock.getProviderForRole.mockResolvedValue({\n      model: { invoke: jest.fn().mockResolvedValue('mock response') } as any,\n    })\n    const promptManagerMock = mock<PromptManagerService>()\n    const promptInjectionGuardMock = mock<PromptInjectionGuard>()\n    promptInjectionGuardMock.checkInput.mockResolvedValue({\n      allowed: true,\n      score: 0.1,\n      threshold: 0.7,\n      reason: 'passed',\n    })\n    const ruleEngineMock = mock<RuleEngineService>({\n      // 模拟 execute 方法为一个空的 resolved Promise\n      execute: jest.fn().mockResolvedValue(undefined),\n    })\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        LogicService,\n        // 提供真实的 RuleEngineService，但其依赖 PrismaService 是模拟的\n        RuleEngineService,\n        { provide: EventBusService, useValue: eventBusMock },\n        { provide: PrismaService, useValue: prismaMock },\n        { provide: DynamicAiSchedulerService, useValue: schedulerMock },\n        { provide: PromptManagerService, useValue: promptManagerMock },\n        { provide: PromptInjectionGuard, useValue: promptInjectionGuardMock },\n      ],\n    })\n      // 覆盖 RuleEngineService 的实例，以便我们可以监视它的方法\n      .overrideProvider(RuleEngineService)\n      .useValue(ruleEngineMock)\n      .compile()\n\n    logicService = module.get<LogicService>(LogicService)\n    ruleEngineService = module.get<RuleEngineService>(RuleEngineService)\n    eventBusService = module.get(EventBusService)\n\n    // 在每个测试前重置模拟函数的状态\n    mockedCallAiWithGuard.mockClear()\n    eventBusService.publish.mockClear()\n    ;(ruleEngineService.execute as jest.Mock).mockClear()\n  })\n\n  it('should be defined', () => {\n    expect(logicService).toBeDefined()\n  })\n\n  describe('processLogic', () => {\n    it('should correctly process a player action, execute directives, and publish a completion event', async () => {\n      // 1. 准备 (Arrange)\n      const mockJobData: GameActionJobData = {\n        gameId: 'test-game-id',\n        userId: 'test-user-id',\n        playerAction: { type: 'command', payload: 'test command' },\n        gameStateSnapshot: {} as any, // 在此测试中我们不关心快照的具体内容\n      }\n\n      const mockDirectives: DirectiveSet = [\n        {\n          op: 'update_character',\n          targetId: 'player',\n          payload: { hp: { op: 'decrement', value: 10 } },\n        },\n      ]\n\n      // 设置 callAiWithGuard 的模拟行为：当它被调用时，返回我们预设的指令集\n      mockedCallAiWithGuard.mockResolvedValue(mockDirectives)\n\n      // 2. 行动 (Act)\n      await logicService.processLogic(mockJobData)\n\n      // 3. 断言 (Assert)\n      // 验证AI护栏函数是否被调用过1次\n      expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1)\n\n      // 验证 RuleEngineService 的 execute 方法是否被调用，并且传入了正确的 gameId 和 AI 生成的指令\n      expect(ruleEngineService.execute).toHaveBeenCalledTimes(1)\n      expect(ruleEngineService.execute).toHaveBeenCalledWith(mockJobData.gameId, mockDirectives)\n\n      // 验证 EventBusService 的 publish 方法是否被调用，以通知下一个微服务\n      expect(eventBusService.publish).toHaveBeenCalledTimes(1)\n      expect(eventBusService.publish).toHaveBeenCalledWith('LOGIC_PROCESSING_COMPLETE', {\n        gameId: mockJobData.gameId,\n        userId: mockJobData.userId,\n        playerAction: mockJobData.playerAction,\n      })\n    })\n\n    it('should throw an error if AI guard fails', async () => {\n      // 1. 准备 (Arrange)\n      const mockJobData: GameActionJobData = {} as any\n      const errorMessage = 'AI failed to generate valid data'\n      // 设置 callAiWithGuard 的模拟行为：当它被调用时，抛出一个错误\n      mockedCallAiWithGuard.mockRejectedValue(new Error(errorMessage))\n\n      // 2. & 3. 行动与断言 (Act & Assert)\n      // 验证当 generateDirectives 失败时，processLogic 会向上抛出异常\n      await expect(logicService.processLogic(mockJobData)).rejects.toThrow(\n        expect.objectContaining({\n          message: expect.stringContaining(errorMessage),\n        })\n      )\n\n      // 验证在这种失败情况下，RuleEngine 和 EventBus 都不会被调用\n      expect(ruleEngineService.execute).not.toHaveBeenCalled()\n      expect(eventBusService.publish).not.toHaveBeenCalled()\n    })\n  })\n})\n"],"version":3}