{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\plugins\\plugin-sandbox.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\plugins\\plugin-sandbox.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common'\nimport * as fs from 'fs'\nimport * as path from 'path'\nimport * as vm from 'vm'\nimport type { PluginRegistry } from './plugin.registry'\nimport { Plugin, type PluginContext, type PluginManifest } from './plugin.types'\n\nexport interface SandboxOptions {\n  timeout?: number\n  memoryLimit?: number\n  allowedModules?: string[]\n  isolatedContext?: boolean\n}\n\nexport interface SandboxResult {\n  success: boolean\n  result?: any\n  error?: string\n  executionTime: number\n  memoryUsage?: number\n}\n\n/**\n * Plugin Sandbox Service\n * 提供安全的插件测试环境\n */\n@Injectable()\nexport class PluginSandboxService {\n  private readonly logger = new Logger(PluginSandboxService.name)\n  private readonly sandboxes = new Map<string, vm.Context>()\n\n  constructor(private readonly pluginRegistry: PluginRegistry) {}\n\n  /**\n   * 在沙盒中测试插件激活\n   */\n  async testPluginActivation(\n    pluginPath: string,\n    options: SandboxOptions = {}\n  ): Promise<SandboxResult> {\n    const startTime = Date.now()\n\n    try {\n      const sandboxId = this.generateSandboxId()\n      const context = this.createSandboxContext(sandboxId, options)\n\n      // 读取插件代码\n      const pluginCode = await fs.promises.readFile(pluginPath, 'utf-8')\n\n      // 验证插件代码安全性\n      this.validatePluginCode(pluginCode)\n\n      // 在沙盒中执行插件代码\n      const script = new vm.Script(pluginCode, {\n        filename: path.basename(pluginPath),\n      })\n\n      const pluginModule = { exports: {} }\n      context.module = pluginModule\n      context.exports = pluginModule.exports\n      context.require = this.createSafeRequire(options.allowedModules || [])\n\n      script.runInContext(context, { timeout: options.timeout || 5000 })\n\n      // 获取插件类\n      const PluginClass = (pluginModule.exports as any).default || pluginModule.exports\n      if (!PluginClass) {\n        throw new Error('Plugin must export a default class or function')\n      }\n\n      // 创建插件实例\n      const mockContext: PluginContext = {\n        pluginId: sandboxId,\n        config: {},\n        logger: {\n          info: (message: string) => this.logger.log(`[Sandbox:${sandboxId}] ${message}`),\n          warn: (message: string) => this.logger.warn(`[Sandbox:${sandboxId}] ${message}`),\n          error: (message: string) => this.logger.error(`[Sandbox:${sandboxId}] ${message}`),\n          debug: (message: string) => this.logger.debug(`[Sandbox:${sandboxId}] ${message}`),\n        },\n      }\n\n      const plugin =\n        typeof PluginClass === 'function' ? new PluginClass(mockContext) : PluginClass(mockContext)\n\n      // 测试激活\n      if (plugin.activate && typeof plugin.activate === 'function') {\n        await plugin.activate(mockContext)\n      }\n\n      // 验证插件结构\n      this.validatePluginStructure(plugin)\n\n      const executionTime = Date.now() - startTime\n\n      // 清理沙盒\n      this.cleanupSandbox(sandboxId)\n\n      return {\n        success: true,\n        result: {\n          manifest: plugin.manifest,\n          activated: true,\n        },\n        executionTime,\n      }\n    } catch (error) {\n      const executionTime = Date.now() - startTime\n      this.logger.error(`Plugin activation test failed: ${error instanceof Error ? error.message : String(error)}`)\n\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : String(error),\n        executionTime,\n      }\n    }\n  }\n\n  /**\n   * 在沙盒中测试插件工具执行\n   */\n  async testPluginTool(\n    pluginPath: string,\n    toolId: string,\n    input: any,\n    options: SandboxOptions = {}\n  ): Promise<SandboxResult> {\n    const startTime = Date.now()\n\n    try {\n      const sandboxId = this.generateSandboxId()\n      const context = this.createSandboxContext(sandboxId, options)\n\n      // 读取并执行插件代码\n      const pluginCode = await fs.promises.readFile(pluginPath, 'utf-8')\n\n      // 验证插件代码安全性\n      this.validatePluginCode(pluginCode)\n\n      const script = new vm.Script(pluginCode, {\n        filename: path.basename(pluginPath),\n      })\n\n      const pluginModule = { exports: {} }\n      context.module = pluginModule\n      context.exports = pluginModule.exports\n      context.require = this.createSafeRequire(options.allowedModules || [])\n\n      script.runInContext(context, { timeout: options.timeout || 10000 })\n\n      // 创建插件实例\n      const PluginClass = (pluginModule.exports as any).default || pluginModule.exports\n      const mockContext: PluginContext = {\n        pluginId: sandboxId,\n        config: {},\n        logger: {\n          info: (message: string) => this.logger.log(`[Sandbox:${sandboxId}] ${message}`),\n          warn: (message: string) => this.logger.warn(`[Sandbox:${sandboxId}] ${message}`),\n          error: (message: string) => this.logger.error(`[Sandbox:${sandboxId}] ${message}`),\n          debug: (message: string) => this.logger.debug(`[Sandbox:${sandboxId}] ${message}`),\n        },\n      }\n\n      const plugin =\n        typeof PluginClass === 'function' ? new PluginClass(mockContext) : PluginClass(mockContext)\n\n      // 激活插件\n      if (plugin.activate) {\n        await plugin.activate(mockContext)\n      }\n\n      // 查找并执行工具\n      const tool = plugin.manifest.contributes?.aiTools?.find((t) => t.id === toolId)\n      if (!tool) {\n        throw new Error(`Tool ${toolId} not found in plugin`)\n      }\n\n      const result = await tool.execute(input)\n\n      const executionTime = Date.now() - startTime\n      this.cleanupSandbox(sandboxId)\n\n      return {\n        success: true,\n        result,\n        executionTime,\n      }\n    } catch (error) {\n      const executionTime = Date.now() - startTime\n      this.logger.error(`Plugin tool test failed: ${error instanceof Error ? error.message : String(error)}`)\n\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : String(error),\n        executionTime,\n      }\n    }\n  }\n\n  /**\n   * 创建沙盒上下文\n   */\n  private createSandboxContext(sandboxId: string, options: SandboxOptions): vm.Context {\n    const context = vm.createContext({\n      console: {\n        log: (...args: any[]) => this.logger.log(`[Sandbox:${sandboxId}]`, ...args),\n        warn: (...args: any[]) => this.logger.warn(`[Sandbox:${sandboxId}]`, ...args),\n        error: (...args: any[]) => this.logger.error(`[Sandbox:${sandboxId}]`, ...args),\n      },\n      // REMOVER: Acesso perigoso ao Buffer - pode ser usado para RCE\n      // Buffer,\n\n      // REMOVER: setTimeout personalizado - pode ser bypassado\n      // setTimeout: (callback: Function, delay: number) => {\n      //   if (delay > (options.timeout || 5000)) {\n      //     throw new Error('Timeout exceeded')\n      //   }\n      //   return setTimeout(callback, delay)\n      // },\n      // clearTimeout,\n\n      // Bloquear acesso a construtores e funções perigosas\n      Buffer: undefined,\n      Function: undefined,\n      eval: undefined,\n      setTimeout: undefined,\n      setInterval: undefined,\n      clearTimeout: undefined,\n      clearInterval: undefined,\n      global: undefined,\n      process: undefined,\n      __dirname: undefined,\n      __filename: undefined,\n      require: undefined,\n      module: undefined,\n      exports: undefined,\n    })\n\n    this.sandboxes.set(sandboxId, context)\n    return context\n  }\n\n  /**\n   * 创建安全的require函数\n   */\n  private createSafeRequire(allowedModules: string[]): Function {\n    const safeModules = new Set(['path', 'url', 'util', 'crypto', ...allowedModules])\n\n    return (moduleId: string) => {\n      if (!safeModules.has(moduleId)) {\n        throw new Error(`Module '${moduleId}' is not allowed in sandbox`)\n      }\n\n      try {\n        return require(moduleId)\n      } catch (error) {\n        throw new Error(`Failed to load module '${moduleId}': ${error instanceof Error ? error.message : String(error)}`)\n      }\n    }\n  }\n\n  /**\n   * 验证插件代码安全性\n   */\n  private validatePluginCode(code: string): void {\n    const dangerousPatterns = [\n      // Acesso direto ao global\n      /\\bglobal\\b/,\n      /\\bprocess\\b/,\n      /\\b__dirname\\b/,\n      /\\b__filename\\b/,\n      /\\brequire\\b/,\n      /\\bmodule\\b/,\n      /\\bexports\\b/,\n\n      // Funções perigosas\n      /\\beval\\b/,\n      /\\bFunction\\b/,\n      /\\bsetTimeout\\b/,\n      /\\bsetInterval\\b/,\n      /\\bclearTimeout\\b/,\n      /\\bclearInterval\\b/,\n\n      // Acesso ao sistema de arquivos\n      /\\bfs\\b/,\n      /\\bpath\\b/,\n\n      // Acesso à rede\n      /\\bhttp\\b/,\n      /\\bhttps\\b/,\n      /\\bnet\\b/,\n      /\\bdns\\b/,\n\n      // Acesso ao sistema\n      /\\bchild_process\\b/,\n      /\\bos\\b/,\n      /\\bcrypto\\b/,\n      /\\bBuffer\\b/,\n    ]\n\n    for (const pattern of dangerousPatterns) {\n      if (pattern.test(code)) {\n        throw new Error(`Plugin code contains dangerous pattern: ${pattern}`)\n      }\n    }\n  }\n\n  /**\n   * 验证插件结构\n   */\n  private validatePluginStructure(plugin: any): void {\n    if (!plugin.manifest) {\n      throw new Error('Plugin must have a manifest')\n    }\n\n    const manifest: PluginManifest = plugin.manifest\n\n    if (!manifest.id || typeof manifest.id !== 'string') {\n      throw new Error('Plugin manifest must have a valid id')\n    }\n\n    if (!manifest.name || typeof manifest.name !== 'string') {\n      throw new Error('Plugin manifest must have a valid name')\n    }\n\n    if (!manifest.version || typeof manifest.version !== 'string') {\n      throw new Error('Plugin manifest must have a valid version')\n    }\n\n    // 验证贡献点\n    if (manifest.contributes) {\n      if (manifest.contributes.aiTools) {\n        for (const tool of manifest.contributes.aiTools) {\n          if (!tool.id || !tool.name || !tool.execute) {\n            throw new Error('AI tool must have id, name, and execute function')\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * 生成沙盒ID\n   */\n  private generateSandboxId(): string {\n    return `sandbox_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n  }\n\n  /**\n   * 清理沙盒\n   */\n  private cleanupSandbox(sandboxId: string): void {\n    this.sandboxes.delete(sandboxId)\n  }\n\n  /**\n   * 获取沙盒统计信息\n   */\n  getSandboxStats(): { activeSandboxes: number } {\n    return {\n      activeSandboxes: this.sandboxes.size,\n    }\n  }\n}\n"],"version":3}