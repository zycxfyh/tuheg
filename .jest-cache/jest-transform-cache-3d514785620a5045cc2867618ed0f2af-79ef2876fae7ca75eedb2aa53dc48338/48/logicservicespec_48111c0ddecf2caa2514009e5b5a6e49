67d1eb84205a373047f4d205e3312f74
"use strict";
// 文件路径: apps/logic-agent/src/__tests__/logic.service.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
// [核心] 模拟 @tuheg/common-backend 模块，特别是 callAiWithGuard 函数
jest.mock('@tuheg/common-backend', () => ({
    ...jest.requireActual('@tuheg/common-backend'), // 保留其他真实导出
    callAiWithGuard: jest.fn(), // 将 callAiWithGuard 替换为一个 Jest 模拟函数
}));
const testing_1 = require("@nestjs/testing");
const common_backend_1 = require("@tuheg/common-backend");
const jest_mock_extended_1 = require("jest-mock-extended");
const logic_service_1 = require("../logic.service");
const rule_engine_service_1 = require("../rule-engine.service");
describe('LogicService', () => {
    let logicService;
    let ruleEngineService;
    let eventBusService;
    // 将模拟函数类型化，便于在测试中进行类型提示
    const mockedCallAiWithGuard = common_backend_1.callAiWithGuard;
    beforeEach(async () => {
        // 使用 jest-mock-extended 创建所有依赖的深度模拟对象
        const eventBusMock = (0, jest_mock_extended_1.mock)();
        const prismaMock = (0, jest_mock_extended_1.mock)();
        const schedulerMock = (0, jest_mock_extended_1.mock)();
        schedulerMock.getProviderForRole.mockResolvedValue({
            model: { invoke: jest.fn().mockResolvedValue('mock response') },
        });
        const promptManagerMock = (0, jest_mock_extended_1.mock)();
        const promptInjectionGuardMock = (0, jest_mock_extended_1.mock)();
        promptInjectionGuardMock.checkInput.mockResolvedValue({
            allowed: true,
            score: 0.1,
            threshold: 0.7,
            reason: 'passed',
        });
        const ruleEngineMock = (0, jest_mock_extended_1.mock)({
            // 模拟 execute 方法为一个空的 resolved Promise
            execute: jest.fn().mockResolvedValue(undefined),
        });
        const module = await testing_1.Test.createTestingModule({
            providers: [
                logic_service_1.LogicService,
                // 提供真实的 RuleEngineService，但其依赖 PrismaService 是模拟的
                rule_engine_service_1.RuleEngineService,
                { provide: common_backend_1.EventBusService, useValue: eventBusMock },
                { provide: common_backend_1.PrismaService, useValue: prismaMock },
                { provide: common_backend_1.DynamicAiSchedulerService, useValue: schedulerMock },
                { provide: common_backend_1.PromptManagerService, useValue: promptManagerMock },
                { provide: common_backend_1.PromptInjectionGuard, useValue: promptInjectionGuardMock },
            ],
        })
            // 覆盖 RuleEngineService 的实例，以便我们可以监视它的方法
            .overrideProvider(rule_engine_service_1.RuleEngineService)
            .useValue(ruleEngineMock)
            .compile();
        logicService = module.get(logic_service_1.LogicService);
        ruleEngineService = module.get(rule_engine_service_1.RuleEngineService);
        eventBusService = module.get(common_backend_1.EventBusService);
        // 在每个测试前重置模拟函数的状态
        mockedCallAiWithGuard.mockClear();
        eventBusService.publish.mockClear();
        ruleEngineService.execute.mockClear();
    });
    it('should be defined', () => {
        expect(logicService).toBeDefined();
    });
    describe('processLogic', () => {
        it('should correctly process a player action, execute directives, and publish a completion event', async () => {
            // 1. 准备 (Arrange)
            const mockJobData = {
                gameId: 'test-game-id',
                userId: 'test-user-id',
                playerAction: { type: 'command', payload: 'test command' },
                gameStateSnapshot: {}, // 在此测试中我们不关心快照的具体内容
            };
            const mockDirectives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { hp: { op: 'decrement', value: 10 } },
                },
            ];
            // 设置 callAiWithGuard 的模拟行为：当它被调用时，返回我们预设的指令集
            mockedCallAiWithGuard.mockResolvedValue(mockDirectives);
            // 2. 行动 (Act)
            await logicService.processLogic(mockJobData);
            // 3. 断言 (Assert)
            // 验证AI护栏函数是否被调用过1次
            expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1);
            // 验证 RuleEngineService 的 execute 方法是否被调用，并且传入了正确的 gameId 和 AI 生成的指令
            expect(ruleEngineService.execute).toHaveBeenCalledTimes(1);
            expect(ruleEngineService.execute).toHaveBeenCalledWith(mockJobData.gameId, mockDirectives);
            // 验证 EventBusService 的 publish 方法是否被调用，以通知下一个微服务
            expect(eventBusService.publish).toHaveBeenCalledTimes(1);
            expect(eventBusService.publish).toHaveBeenCalledWith('LOGIC_PROCESSING_COMPLETE', {
                gameId: mockJobData.gameId,
                userId: mockJobData.userId,
                playerAction: mockJobData.playerAction,
            });
        });
        it('should throw an error if AI guard fails', async () => {
            // 1. 准备 (Arrange)
            const mockJobData = {};
            const errorMessage = 'AI failed to generate valid data';
            // 设置 callAiWithGuard 的模拟行为：当它被调用时，抛出一个错误
            mockedCallAiWithGuard.mockRejectedValue(new Error(errorMessage));
            // 2. & 3. 行动与断言 (Act & Assert)
            // 验证当 generateDirectives 失败时，processLogic 会向上抛出异常
            await expect(logicService.processLogic(mockJobData)).rejects.toThrow(expect.objectContaining({
                message: expect.stringContaining(errorMessage),
            }));
            // 验证在这种失败情况下，RuleEngine 和 EventBus 都不会被调用
            expect(ruleEngineService.execute).not.toHaveBeenCalled();
            expect(eventBusService.publish).not.toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcbG9naWMuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSw2REFBNkQ7O0FBaUI3RCwwREFBMEQ7QUFDMUQsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFLFdBQVc7SUFDM0QsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFBRSxvQ0FBb0M7Q0FDakUsQ0FBQyxDQUFDLENBQUE7QUFuQkgsNkNBQTBEO0FBQzFELDBEQVM4QjtBQUM5QiwyREFBeUQ7QUFDekQsb0RBQStDO0FBQy9DLGdFQUEwRDtBQVExRCxRQUFRLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtJQUM1QixJQUFJLFlBQTBCLENBQUE7SUFDOUIsSUFBSSxpQkFBb0MsQ0FBQTtJQUN4QyxJQUFJLGVBQTJDLENBQUE7SUFFL0Msd0JBQXdCO0lBQ3hCLE1BQU0scUJBQXFCLEdBQUcsZ0NBQTRCLENBQUE7SUFFMUQsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLHNDQUFzQztRQUN0QyxNQUFNLFlBQVksR0FBRyxJQUFBLHlCQUFJLEdBQW1CLENBQUE7UUFDNUMsTUFBTSxVQUFVLEdBQUcsSUFBQSx5QkFBSSxHQUFpQixDQUFBO1FBQ3hDLE1BQU0sYUFBYSxHQUFHLElBQUEseUJBQUksR0FBNkIsQ0FBQTtRQUN2RCxhQUFhLENBQUMsa0JBQWtCLENBQUMsaUJBQWlCLENBQUM7WUFDakQsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQUMsRUFBUztTQUN2RSxDQUFDLENBQUE7UUFDRixNQUFNLGlCQUFpQixHQUFHLElBQUEseUJBQUksR0FBd0IsQ0FBQTtRQUN0RCxNQUFNLHdCQUF3QixHQUFHLElBQUEseUJBQUksR0FBd0IsQ0FBQTtRQUM3RCx3QkFBd0IsQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUM7WUFDcEQsT0FBTyxFQUFFLElBQUk7WUFDYixLQUFLLEVBQUUsR0FBRztZQUNWLFNBQVMsRUFBRSxHQUFHO1lBQ2QsTUFBTSxFQUFFLFFBQVE7U0FDakIsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxjQUFjLEdBQUcsSUFBQSx5QkFBSSxFQUFvQjtZQUM3QyxzQ0FBc0M7WUFDdEMsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUM7U0FDaEQsQ0FBQyxDQUFBO1FBRUYsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCw0QkFBWTtnQkFDWixrREFBa0Q7Z0JBQ2xELHVDQUFpQjtnQkFDakIsRUFBRSxPQUFPLEVBQUUsZ0NBQWUsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFO2dCQUNwRCxFQUFFLE9BQU8sRUFBRSw4QkFBYSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUU7Z0JBQ2hELEVBQUUsT0FBTyxFQUFFLDBDQUF5QixFQUFFLFFBQVEsRUFBRSxhQUFhLEVBQUU7Z0JBQy9ELEVBQUUsT0FBTyxFQUFFLHFDQUFvQixFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBRTtnQkFDOUQsRUFBRSxPQUFPLEVBQUUscUNBQW9CLEVBQUUsUUFBUSxFQUFFLHdCQUF3QixFQUFFO2FBQ3RFO1NBQ0YsQ0FBQztZQUNBLHdDQUF3QzthQUN2QyxnQkFBZ0IsQ0FBQyx1Q0FBaUIsQ0FBQzthQUNuQyxRQUFRLENBQUMsY0FBYyxDQUFDO2FBQ3hCLE9BQU8sRUFBRSxDQUFBO1FBRVosWUFBWSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQWUsNEJBQVksQ0FBQyxDQUFBO1FBQ3JELGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQW9CLHVDQUFpQixDQUFDLENBQUE7UUFDcEUsZUFBZSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0NBQWUsQ0FBQyxDQUFBO1FBRTdDLGtCQUFrQjtRQUNsQixxQkFBcUIsQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUNqQyxlQUFlLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUNsQztRQUFDLGlCQUFpQixDQUFDLE9BQXFCLENBQUMsU0FBUyxFQUFFLENBQUE7SUFDdkQsQ0FBQyxDQUFDLENBQUE7SUFFRixFQUFFLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1FBQzNCLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUNwQyxDQUFDLENBQUMsQ0FBQTtJQUVGLFFBQVEsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO1FBQzVCLEVBQUUsQ0FBQyw4RkFBOEYsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM1RyxrQkFBa0I7WUFDbEIsTUFBTSxXQUFXLEdBQXNCO2dCQUNyQyxNQUFNLEVBQUUsY0FBYztnQkFDdEIsTUFBTSxFQUFFLGNBQWM7Z0JBQ3RCLFlBQVksRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRTtnQkFDMUQsaUJBQWlCLEVBQUUsRUFBUyxFQUFFLG9CQUFvQjthQUNuRCxDQUFBO1lBRUQsTUFBTSxjQUFjLEdBQWlCO2dCQUNuQztvQkFDRSxFQUFFLEVBQUUsa0JBQWtCO29CQUN0QixRQUFRLEVBQUUsUUFBUTtvQkFDbEIsT0FBTyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUU7aUJBQ2hEO2FBQ0YsQ0FBQTtZQUVELDZDQUE2QztZQUM3QyxxQkFBcUIsQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsQ0FBQTtZQUV2RCxjQUFjO1lBQ2QsTUFBTSxZQUFZLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFBO1lBRTVDLGlCQUFpQjtZQUNqQixtQkFBbUI7WUFDbkIsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFFdEQsb0VBQW9FO1lBQ3BFLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUMxRCxNQUFNLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUMsb0JBQW9CLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxjQUFjLENBQUMsQ0FBQTtZQUUxRixpREFBaUQ7WUFDakQsTUFBTSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUN4RCxNQUFNLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLDJCQUEyQixFQUFFO2dCQUNoRixNQUFNLEVBQUUsV0FBVyxDQUFDLE1BQU07Z0JBQzFCLE1BQU0sRUFBRSxXQUFXLENBQUMsTUFBTTtnQkFDMUIsWUFBWSxFQUFFLFdBQVcsQ0FBQyxZQUFZO2FBQ3ZDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO1FBRUYsRUFBRSxDQUFDLHlDQUF5QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3ZELGtCQUFrQjtZQUNsQixNQUFNLFdBQVcsR0FBc0IsRUFBUyxDQUFBO1lBQ2hELE1BQU0sWUFBWSxHQUFHLGtDQUFrQyxDQUFBO1lBQ3ZELHlDQUF5QztZQUN6QyxxQkFBcUIsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFBO1lBRWhFLCtCQUErQjtZQUMvQixrREFBa0Q7WUFDbEQsTUFBTSxNQUFNLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQ2xFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUM7YUFDL0MsQ0FBQyxDQUNILENBQUE7WUFFRCwwQ0FBMEM7WUFDMUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1lBQ3hELE1BQU0sQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLENBQUE7UUFDeEQsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQyxDQUFBIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxhcHBzXFxsb2dpYy1hZ2VudFxcc3JjXFxfX3Rlc3RzX19cXGxvZ2ljLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyDmlofku7bot6/lvoQ6IGFwcHMvbG9naWMtYWdlbnQvc3JjL19fdGVzdHNfXy9sb2dpYy5zZXJ2aWNlLnNwZWMudHNcblxuaW1wb3J0IHsgVGVzdCwgdHlwZSBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJ1xuaW1wb3J0IHtcbiAgY2FsbEFpV2l0aEd1YXJkLFxuICB0eXBlIERpcmVjdGl2ZVNldCxcbiAgRHluYW1pY0FpU2NoZWR1bGVyU2VydmljZSxcbiAgRXZlbnRCdXNTZXJ2aWNlLFxuICB0eXBlIEdhbWVBY3Rpb25Kb2JEYXRhLFxuICBQcmlzbWFTZXJ2aWNlLFxuICBQcm9tcHRJbmplY3Rpb25HdWFyZCxcbiAgUHJvbXB0TWFuYWdlclNlcnZpY2UsXG59IGZyb20gJ0B0dWhlZy9jb21tb24tYmFja2VuZCdcbmltcG9ydCB7IHR5cGUgTW9ja1Byb3h5LCBtb2NrIH0gZnJvbSAnamVzdC1tb2NrLWV4dGVuZGVkJ1xuaW1wb3J0IHsgTG9naWNTZXJ2aWNlIH0gZnJvbSAnLi4vbG9naWMuc2VydmljZSdcbmltcG9ydCB7IFJ1bGVFbmdpbmVTZXJ2aWNlIH0gZnJvbSAnLi4vcnVsZS1lbmdpbmUuc2VydmljZSdcblxuLy8gW+aguOW/g10g5qih5oufIEB0dWhlZy9jb21tb24tYmFja2VuZCDmqKHlnZfvvIznibnliKvmmK8gY2FsbEFpV2l0aEd1YXJkIOWHveaVsFxuamVzdC5tb2NrKCdAdHVoZWcvY29tbW9uLWJhY2tlbmQnLCAoKSA9PiAoe1xuICAuLi5qZXN0LnJlcXVpcmVBY3R1YWwoJ0B0dWhlZy9jb21tb24tYmFja2VuZCcpLCAvLyDkv53nlZnlhbbku5bnnJ/lrp7lr7zlh7pcbiAgY2FsbEFpV2l0aEd1YXJkOiBqZXN0LmZuKCksIC8vIOWwhiBjYWxsQWlXaXRoR3VhcmQg5pu/5o2i5Li65LiA5LiqIEplc3Qg5qih5ouf5Ye95pWwXG59KSlcblxuZGVzY3JpYmUoJ0xvZ2ljU2VydmljZScsICgpID0+IHtcbiAgbGV0IGxvZ2ljU2VydmljZTogTG9naWNTZXJ2aWNlXG4gIGxldCBydWxlRW5naW5lU2VydmljZTogUnVsZUVuZ2luZVNlcnZpY2VcbiAgbGV0IGV2ZW50QnVzU2VydmljZTogTW9ja1Byb3h5PEV2ZW50QnVzU2VydmljZT5cblxuICAvLyDlsIbmqKHmi5/lh73mlbDnsbvlnovljJbvvIzkvr/kuo7lnKjmtYvor5XkuK3ov5vooYznsbvlnovmj5DnpLpcbiAgY29uc3QgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkID0gY2FsbEFpV2l0aEd1YXJkIGFzIGplc3QuTW9ja1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIOS9v+eUqCBqZXN0LW1vY2stZXh0ZW5kZWQg5Yib5bu65omA5pyJ5L6d6LWW55qE5rex5bqm5qih5ouf5a+56LGhXG4gICAgY29uc3QgZXZlbnRCdXNNb2NrID0gbW9jazxFdmVudEJ1c1NlcnZpY2U+KClcbiAgICBjb25zdCBwcmlzbWFNb2NrID0gbW9jazxQcmlzbWFTZXJ2aWNlPigpXG4gICAgY29uc3Qgc2NoZWR1bGVyTW9jayA9IG1vY2s8RHluYW1pY0FpU2NoZWR1bGVyU2VydmljZT4oKVxuICAgIHNjaGVkdWxlck1vY2suZ2V0UHJvdmlkZXJGb3JSb2xlLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIG1vZGVsOiB7IGludm9rZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKCdtb2NrIHJlc3BvbnNlJykgfSBhcyBhbnksXG4gICAgfSlcbiAgICBjb25zdCBwcm9tcHRNYW5hZ2VyTW9jayA9IG1vY2s8UHJvbXB0TWFuYWdlclNlcnZpY2U+KClcbiAgICBjb25zdCBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2sgPSBtb2NrPFByb21wdEluamVjdGlvbkd1YXJkPigpXG4gICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmNoZWNrSW5wdXQubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgYWxsb3dlZDogdHJ1ZSxcbiAgICAgIHNjb3JlOiAwLjEsXG4gICAgICB0aHJlc2hvbGQ6IDAuNyxcbiAgICAgIHJlYXNvbjogJ3Bhc3NlZCcsXG4gICAgfSlcbiAgICBjb25zdCBydWxlRW5naW5lTW9jayA9IG1vY2s8UnVsZUVuZ2luZVNlcnZpY2U+KHtcbiAgICAgIC8vIOaooeaLnyBleGVjdXRlIOaWueazleS4uuS4gOS4quepuueahCByZXNvbHZlZCBQcm9taXNlXG4gICAgICBleGVjdXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICB9KVxuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBMb2dpY1NlcnZpY2UsXG4gICAgICAgIC8vIOaPkOS+m+ecn+WunueahCBSdWxlRW5naW5lU2VydmljZe+8jOS9huWFtuS+nei1liBQcmlzbWFTZXJ2aWNlIOaYr+aooeaLn+eahFxuICAgICAgICBSdWxlRW5naW5lU2VydmljZSxcbiAgICAgICAgeyBwcm92aWRlOiBFdmVudEJ1c1NlcnZpY2UsIHVzZVZhbHVlOiBldmVudEJ1c01vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQcmlzbWFTZXJ2aWNlLCB1c2VWYWx1ZTogcHJpc21hTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2UsIHVzZVZhbHVlOiBzY2hlZHVsZXJNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogUHJvbXB0TWFuYWdlclNlcnZpY2UsIHVzZVZhbHVlOiBwcm9tcHRNYW5hZ2VyTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IFByb21wdEluamVjdGlvbkd1YXJkLCB1c2VWYWx1ZTogcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrIH0sXG4gICAgICBdLFxuICAgIH0pXG4gICAgICAvLyDopobnm5YgUnVsZUVuZ2luZVNlcnZpY2Ug55qE5a6e5L6L77yM5Lul5L6/5oiR5Lus5Y+v5Lul55uR6KeG5a6D55qE5pa55rOVXG4gICAgICAub3ZlcnJpZGVQcm92aWRlcihSdWxlRW5naW5lU2VydmljZSlcbiAgICAgIC51c2VWYWx1ZShydWxlRW5naW5lTW9jaylcbiAgICAgIC5jb21waWxlKClcblxuICAgIGxvZ2ljU2VydmljZSA9IG1vZHVsZS5nZXQ8TG9naWNTZXJ2aWNlPihMb2dpY1NlcnZpY2UpXG4gICAgcnVsZUVuZ2luZVNlcnZpY2UgPSBtb2R1bGUuZ2V0PFJ1bGVFbmdpbmVTZXJ2aWNlPihSdWxlRW5naW5lU2VydmljZSlcbiAgICBldmVudEJ1c1NlcnZpY2UgPSBtb2R1bGUuZ2V0KEV2ZW50QnVzU2VydmljZSlcblxuICAgIC8vIOWcqOavj+S4qua1i+ivleWJjemHjee9ruaooeaLn+WHveaVsOeahOeKtuaAgVxuICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrQ2xlYXIoKVxuICAgIGV2ZW50QnVzU2VydmljZS5wdWJsaXNoLm1vY2tDbGVhcigpXG4gICAgOyhydWxlRW5naW5lU2VydmljZS5leGVjdXRlIGFzIGplc3QuTW9jaykubW9ja0NsZWFyKClcbiAgfSlcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KGxvZ2ljU2VydmljZSkudG9CZURlZmluZWQoKVxuICB9KVxuXG4gIGRlc2NyaWJlKCdwcm9jZXNzTG9naWMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgcHJvY2VzcyBhIHBsYXllciBhY3Rpb24sIGV4ZWN1dGUgZGlyZWN0aXZlcywgYW5kIHB1Ymxpc2ggYSBjb21wbGV0aW9uIGV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gMS4g5YeG5aSHIChBcnJhbmdlKVxuICAgICAgY29uc3QgbW9ja0pvYkRhdGE6IEdhbWVBY3Rpb25Kb2JEYXRhID0ge1xuICAgICAgICBnYW1lSWQ6ICd0ZXN0LWdhbWUtaWQnLFxuICAgICAgICB1c2VySWQ6ICd0ZXN0LXVzZXItaWQnLFxuICAgICAgICBwbGF5ZXJBY3Rpb246IHsgdHlwZTogJ2NvbW1hbmQnLCBwYXlsb2FkOiAndGVzdCBjb21tYW5kJyB9LFxuICAgICAgICBnYW1lU3RhdGVTbmFwc2hvdDoge30gYXMgYW55LCAvLyDlnKjmraTmtYvor5XkuK3miJHku6zkuI3lhbPlv4Plv6vnhafnmoTlhbfkvZPlhoXlrrlcbiAgICAgIH1cblxuICAgICAgY29uc3QgbW9ja0RpcmVjdGl2ZXM6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndXBkYXRlX2NoYXJhY3RlcicsXG4gICAgICAgICAgdGFyZ2V0SWQ6ICdwbGF5ZXInLFxuICAgICAgICAgIHBheWxvYWQ6IHsgaHA6IHsgb3A6ICdkZWNyZW1lbnQnLCB2YWx1ZTogMTAgfSB9LFxuICAgICAgICB9LFxuICAgICAgXVxuXG4gICAgICAvLyDorr7nva4gY2FsbEFpV2l0aEd1YXJkIOeahOaooeaLn+ihjOS4uu+8muW9k+Wug+iiq+iwg+eUqOaXtu+8jOi/lOWbnuaIkeS7rOmihOiuvueahOaMh+S7pOmbhlxuICAgICAgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tEaXJlY3RpdmVzKVxuXG4gICAgICAvLyAyLiDooYzliqggKEFjdClcbiAgICAgIGF3YWl0IGxvZ2ljU2VydmljZS5wcm9jZXNzTG9naWMobW9ja0pvYkRhdGEpXG5cbiAgICAgIC8vIDMuIOaWreiogCAoQXNzZXJ0KVxuICAgICAgLy8g6aqM6K+BQUnmiqTmoI/lh73mlbDmmK/lkKbooqvosIPnlKjov4cx5qyhXG4gICAgICBleHBlY3QobW9ja2VkQ2FsbEFpV2l0aEd1YXJkKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSlcblxuICAgICAgLy8g6aqM6K+BIFJ1bGVFbmdpbmVTZXJ2aWNlIOeahCBleGVjdXRlIOaWueazleaYr+WQpuiiq+iwg+eUqO+8jOW5tuS4lOS8oOWFpeS6huato+ehrueahCBnYW1lSWQg5ZKMIEFJIOeUn+aIkOeahOaMh+S7pFxuICAgICAgZXhwZWN0KHJ1bGVFbmdpbmVTZXJ2aWNlLmV4ZWN1dGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKVxuICAgICAgZXhwZWN0KHJ1bGVFbmdpbmVTZXJ2aWNlLmV4ZWN1dGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKG1vY2tKb2JEYXRhLmdhbWVJZCwgbW9ja0RpcmVjdGl2ZXMpXG5cbiAgICAgIC8vIOmqjOivgSBFdmVudEJ1c1NlcnZpY2Ug55qEIHB1Ymxpc2gg5pa55rOV5piv5ZCm6KKr6LCD55So77yM5Lul6YCa55+l5LiL5LiA5Liq5b6u5pyN5YqhXG4gICAgICBleHBlY3QoZXZlbnRCdXNTZXJ2aWNlLnB1Ymxpc2gpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKVxuICAgICAgZXhwZWN0KGV2ZW50QnVzU2VydmljZS5wdWJsaXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnTE9HSUNfUFJPQ0VTU0lOR19DT01QTEVURScsIHtcbiAgICAgICAgZ2FtZUlkOiBtb2NrSm9iRGF0YS5nYW1lSWQsXG4gICAgICAgIHVzZXJJZDogbW9ja0pvYkRhdGEudXNlcklkLFxuICAgICAgICBwbGF5ZXJBY3Rpb246IG1vY2tKb2JEYXRhLnBsYXllckFjdGlvbixcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3IgaWYgQUkgZ3VhcmQgZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyAxLiDlh4blpIcgKEFycmFuZ2UpXG4gICAgICBjb25zdCBtb2NrSm9iRGF0YTogR2FtZUFjdGlvbkpvYkRhdGEgPSB7fSBhcyBhbnlcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9ICdBSSBmYWlsZWQgdG8gZ2VuZXJhdGUgdmFsaWQgZGF0YSdcbiAgICAgIC8vIOiuvue9riBjYWxsQWlXaXRoR3VhcmQg55qE5qih5ouf6KGM5Li677ya5b2T5a6D6KKr6LCD55So5pe277yM5oqb5Ye65LiA5Liq6ZSZ6K+vXG4gICAgICBtb2NrZWRDYWxsQWlXaXRoR3VhcmQubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKGVycm9yTWVzc2FnZSkpXG5cbiAgICAgIC8vIDIuICYgMy4g6KGM5Yqo5LiO5pat6KiAIChBY3QgJiBBc3NlcnQpXG4gICAgICAvLyDpqozor4HlvZMgZ2VuZXJhdGVEaXJlY3RpdmVzIOWksei0peaXtu+8jHByb2Nlc3NMb2dpYyDkvJrlkJHkuIrmipvlh7rlvILluLhcbiAgICAgIGF3YWl0IGV4cGVjdChsb2dpY1NlcnZpY2UucHJvY2Vzc0xvZ2ljKG1vY2tKb2JEYXRhKSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgbWVzc2FnZTogZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoZXJyb3JNZXNzYWdlKSxcbiAgICAgICAgfSlcbiAgICAgIClcblxuICAgICAgLy8g6aqM6K+B5Zyo6L+Z56eN5aSx6LSl5oOF5Ya15LiL77yMUnVsZUVuZ2luZSDlkowgRXZlbnRCdXMg6YO95LiN5Lya6KKr6LCD55SoXG4gICAgICBleHBlY3QocnVsZUVuZ2luZVNlcnZpY2UuZXhlY3V0ZSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgICAgZXhwZWN0KGV2ZW50QnVzU2VydmljZS5wdWJsaXNoKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgfSlcbiAgfSlcbn0pXG4iXSwidmVyc2lvbiI6M30=