{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\websocket.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\websocket.service.ts"],"sourcesContent":["// ============================================================================\r\n// WebSocket通信服务集成\r\n// 集成 VCPToolBox 的实时通信能力到创世星环\r\n// ============================================================================\r\n\r\nimport { Injectable, Logger, OnModuleDestroy, OnModuleInit } from '@nestjs/common'\r\nimport { ConfigService } from '@nestjs/config'\r\nimport { webSocketCommunication, WSMessage } from '../../../apps/vcptoolbox/src/modules/communication/WebSocketCommunication'\r\n\r\n@Injectable()\r\nexport class WebSocketService implements OnModuleInit, OnModuleDestroy {\r\n  private readonly logger = new Logger(WebSocketService.name)\r\n  private serverStarted = false\r\n\r\n  constructor(private configService: ConfigService) {}\r\n\r\n  async onModuleInit() {\r\n    await this.initializeWebSocketServer()\r\n    this.setupEventHandlers()\r\n    this.logger.log('WebSocket通信服务已初始化')\r\n  }\r\n\r\n  async onModuleDestroy() {\r\n    if (this.serverStarted) {\r\n      await webSocketCommunication.stop()\r\n      this.logger.log('WebSocket通信服务已停止')\r\n    }\r\n  }\r\n\r\n  // ==================== 服务器管理 ====================\r\n\r\n  /**\r\n   * 初始化WebSocket服务器\r\n   */\r\n  private async initializeWebSocketServer(): Promise<void> {\r\n    try {\r\n      const port = this.configService.get('WEBSOCKET_PORT', 8080)\r\n      const host = this.configService.get('WEBSOCKET_HOST', 'localhost')\r\n\r\n      await webSocketCommunication.start()\r\n      this.serverStarted = true\r\n\r\n      this.logger.log(`WebSocket服务器启动成功: ws://${host}:${port}`)\r\n    } catch (error) {\r\n      this.logger.error('WebSocket服务器启动失败:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 设置事件处理器\r\n   */\r\n  private setupEventHandlers(): void {\r\n    // 监听连接事件\r\n    webSocketCommunication.on('clientConnected', (client: any) => {\r\n      this.logger.debug(`客户端已连接: ${client.id}`)\r\n      this.handleClientConnected(client)\r\n    })\r\n\r\n    webSocketCommunication.on('clientDisconnected', (client: any) => {\r\n      this.logger.debug(`客户端已断开: ${client.id}`)\r\n      this.handleClientDisconnected(client)\r\n    })\r\n\r\n    webSocketCommunication.on('messageReceived', (data: { recipientId: string, message: WSMessage }) => {\r\n      this.handleMessageReceived(data.recipientId, data.message)\r\n    })\r\n\r\n    webSocketCommunication.on('broadcastSent', (data: { message: WSMessage, sender: any }) => {\r\n      this.logger.debug(`广播消息已发送: ${data.message.action}`)\r\n    })\r\n\r\n    // 监听服务器事件\r\n    webSocketCommunication.on('serverError', (error: Error) => {\r\n      this.logger.error('WebSocket服务器错误:', error)\r\n    })\r\n  }\r\n\r\n  // ==================== 客户端管理 ====================\r\n\r\n  /**\r\n   * 处理客户端连接\r\n   */\r\n  private async handleClientConnected(client: any): Promise<void> {\r\n    // 可以在这里执行额外的连接初始化逻辑\r\n    // 比如验证用户身份、设置默认订阅等\r\n    this.logger.log(`新客户端连接: ${client.id} (${client.metadata.ip})`)\r\n  }\r\n\r\n  /**\r\n   * 处理客户端断开\r\n   */\r\n  private async handleClientDisconnected(client: any): Promise<void> {\r\n    this.logger.log(`客户端断开连接: ${client.id}`)\r\n  }\r\n\r\n  /**\r\n   * 处理接收到的消息\r\n   */\r\n  private async handleMessageReceived(recipientId: string, message: WSMessage): Promise<void> {\r\n    // 根据消息类型路由到相应的处理逻辑\r\n    switch (message.action) {\r\n      case 'narrative.update':\r\n        await this.handleNarrativeUpdate(recipientId, message)\r\n        break\r\n      case 'agent.status':\r\n        await this.handleAgentStatusUpdate(recipientId, message)\r\n        break\r\n      case 'collaboration.invite':\r\n        await this.handleCollaborationInvite(recipientId, message)\r\n        break\r\n      default:\r\n        this.logger.debug(`接收到消息: ${message.action} -> ${recipientId}`)\r\n    }\r\n  }\r\n\r\n  // ==================== 叙事专用消息处理 ====================\r\n\r\n  /**\r\n   * 处理叙事更新消息\r\n   */\r\n  private async handleNarrativeUpdate(recipientId: string, message: WSMessage): Promise<void> {\r\n    // 处理实时叙事协作更新\r\n    const { storyId, content, authorId } = message.payload\r\n\r\n    this.logger.debug(`叙事更新: 故事 ${storyId} 由 ${authorId} 更新`)\r\n\r\n    // 可以在这里触发其他协作参与者的实时更新\r\n    // 比如广播给所有协作者\r\n    await this.broadcastToStoryCollaborators(storyId, {\r\n      type: 'event',\r\n      action: 'narrative.collaborative_update',\r\n      payload: {\r\n        storyId,\r\n        content,\r\n        authorId,\r\n        timestamp: new Date()\r\n      },\r\n      timestamp: new Date(),\r\n      source: 'system'\r\n    }, [recipientId]) // 排除发送者自己\r\n  }\r\n\r\n  /**\r\n   * 处理Agent状态更新\r\n   */\r\n  private async handleAgentStatusUpdate(recipientId: string, message: WSMessage): Promise<void> {\r\n    const { agentId, status, currentTask } = message.payload\r\n\r\n    this.logger.debug(`Agent状态更新: ${agentId} -> ${status}`)\r\n\r\n    // 广播Agent状态变化\r\n    await this.broadcastToAgents({\r\n      type: 'event',\r\n      action: 'agent.status_changed',\r\n      payload: {\r\n        agentId,\r\n        status,\r\n        currentTask,\r\n        timestamp: new Date()\r\n      },\r\n      timestamp: new Date(),\r\n      source: 'system'\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 处理协作邀请\r\n   */\r\n  private async handleCollaborationInvite(recipientId: string, message: WSMessage): Promise<void> {\r\n    const { storyId, inviterId, inviteeId, role } = message.payload\r\n\r\n    this.logger.debug(`协作邀请: ${inviterId} 邀请 ${inviteeId} 加入故事 ${storyId}`)\r\n\r\n    // 发送邀请通知给被邀请者\r\n    const success = webSocketCommunication.sendToAgent(inviteeId, {\r\n      type: 'event',\r\n      action: 'collaboration.invited',\r\n      payload: {\r\n        storyId,\r\n        inviterId,\r\n        role,\r\n        timestamp: new Date()\r\n      },\r\n      timestamp: new Date(),\r\n      source: 'system'\r\n    })\r\n\r\n    if (success) {\r\n      this.logger.debug(`协作邀请已发送给: ${inviteeId}`)\r\n    } else {\r\n      this.logger.warn(`协作邀请发送失败，被邀请者不在线: ${inviteeId}`)\r\n    }\r\n  }\r\n\r\n  // ==================== 公共接口 ====================\r\n\r\n  /**\r\n   * 向特定Agent发送消息\r\n   */\r\n  async sendToAgent(agentId: string, message: Partial<WSMessage>): Promise<boolean> {\r\n    return webSocketCommunication.sendToAgent(agentId, {\r\n      id: `msg-${Date.now()}`,\r\n      type: message.type || 'event',\r\n      action: message.action || 'message',\r\n      payload: message.payload || {},\r\n      timestamp: new Date(),\r\n      source: 'system',\r\n      ...message\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 广播到所有Agent\r\n   */\r\n  async broadcastToAgents(message: Partial<WSMessage>): Promise<number> {\r\n    return webSocketCommunication.broadcastToAgents({\r\n      id: `broadcast-${Date.now()}`,\r\n      type: message.type || 'event',\r\n      action: message.action || 'broadcast',\r\n      payload: message.payload || {},\r\n      timestamp: new Date(),\r\n      source: 'system',\r\n      ...message\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 广播到故事协作者\r\n   */\r\n  async broadcastToStoryCollaborators(\r\n    storyId: string,\r\n    message: Partial<WSMessage>,\r\n    excludeClientIds: string[] = []\r\n  ): Promise<void> {\r\n    // 这里应该从数据库获取故事的协作者列表\r\n    // 暂时模拟广播到所有连接的客户端\r\n    await this.broadcastToAgents(message)\r\n  }\r\n\r\n  /**\r\n   * 创建协作房间\r\n   */\r\n  async createCollaborationRoom(storyId: string, participants: string[]): Promise<string | null> {\r\n    // 这里应该创建专门的协作房间\r\n    // 暂时返回null表示未实现\r\n    this.logger.debug(`创建协作房间: ${storyId} 参与者: ${participants.join(', ')}`)\r\n    return null\r\n  }\r\n\r\n  /**\r\n   * 加入协作房间\r\n   */\r\n  async joinCollaborationRoom(roomId: string, agentId: string): Promise<boolean> {\r\n    // 这里应该实现加入协作房间的逻辑\r\n    this.logger.debug(`Agent ${agentId} 加入房间: ${roomId}`)\r\n    return true\r\n  }\r\n\r\n  /**\r\n   * 发送实时编辑更新\r\n   */\r\n  async sendRealtimeEdit(storyId: string, agentId: string, editData: any): Promise<void> {\r\n    await this.broadcastToStoryCollaborators(storyId, {\r\n      type: 'event',\r\n      action: 'realtime.edit',\r\n      payload: {\r\n        storyId,\r\n        agentId,\r\n        editData,\r\n        timestamp: new Date()\r\n      }\r\n    }, [agentId]) // 排除自己\r\n  }\r\n\r\n  /**\r\n   * 发送AI生成进度\r\n   */\r\n  async sendGenerationProgress(storyId: string, agentId: string, progress: number, status: string): Promise<void> {\r\n    await this.broadcastToStoryCollaborators(storyId, {\r\n      type: 'event',\r\n      action: 'generation.progress',\r\n      payload: {\r\n        storyId,\r\n        agentId,\r\n        progress,\r\n        status,\r\n        timestamp: new Date()\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 发送Agent协作状态\r\n   */\r\n  async sendAgentCollaborationStatus(storyId: string, collaborationData: any): Promise<void> {\r\n    await this.broadcastToAgents({\r\n      type: 'event',\r\n      action: 'agent.collaboration_status',\r\n      payload: {\r\n        storyId,\r\n        collaborationData,\r\n        timestamp: new Date()\r\n      }\r\n    })\r\n  }\r\n\r\n  // ==================== 统计和监控 ====================\r\n\r\n  /**\r\n   * 获取WebSocket统计信息\r\n   */\r\n  getWebSocketStats(): any {\r\n    if (!this.serverStarted) {\r\n      return { status: 'stopped' }\r\n    }\r\n\r\n    return {\r\n      status: 'running',\r\n      ...webSocketCommunication.getServerStats()\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取活跃协作会话\r\n   */\r\n  getActiveCollaborationSessions(): any[] {\r\n    // 这里应该返回活跃的协作会话信息\r\n    // 暂时返回空数组\r\n    return []\r\n  }\r\n\r\n  /**\r\n   * 健康检查\r\n   */\r\n  async healthCheck(): Promise<{ status: string, details?: any }> {\r\n    if (!this.serverStarted) {\r\n      return { status: 'error', details: 'WebSocket server not started' }\r\n    }\r\n\r\n    try {\r\n      const stats = this.getWebSocketStats()\r\n      return {\r\n        status: 'healthy',\r\n        details: stats\r\n      }\r\n    } catch (error) {\r\n      return {\r\n        status: 'error',\r\n        details: error instanceof Error ? error.message : String(error)\r\n      }\r\n    }\r\n  }\r\n}\r\n"],"version":3}