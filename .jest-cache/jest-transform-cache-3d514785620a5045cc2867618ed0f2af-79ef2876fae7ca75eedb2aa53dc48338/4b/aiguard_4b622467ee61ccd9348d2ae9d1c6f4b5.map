{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\ai\\ai-guard.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\ai\\ai-guard.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/ai/ai-guard.ts\n\nimport { Injectable } from '@nestjs/common'\nimport type { z } from 'zod'\nimport { PromptInjectionDetectedException } from '../errors/prompt-injection-detected.exception'\nimport { AiGenerationException } from '../exceptions/ai-exception'\n\n/**\n * 提示注入检查结果类型\n */\nexport type PromptInjectionCheckResult = {\n  allowed: boolean\n  score: number\n  threshold: number\n  reason: string\n  inputPreview?: string\n  details?: {\n    preview?: string\n    context?: string\n  }\n}\n\n/**\n * 提示注入防护服务\n * 提供AI输入的安全检查功能\n */\n@Injectable()\nexport class PromptInjectionGuard {\n  private readonly threshold = 0.7\n\n  /**\n   * 检查输入是否包含提示注入攻击\n   * @param input 用户输入\n   * @param context 上下文信息\n   * @returns 检查结果\n   */\n  async checkInput(\n    input: string,\n    context?: { userId?: string; correlationId?: string }\n  ): Promise<PromptInjectionCheckResult> {\n    // 简单的实现 - 在实际项目中应该使用更复杂的检测逻辑\n    const suspiciousPatterns = [\n      /ignore.*previous.*instructions/i,\n      /system.*prompt/i,\n      /override.*settings/i,\n      /bypass.*restrictions/i,\n    ]\n\n    const score = suspiciousPatterns.some((pattern) => pattern.test(input)) ? 0.9 : 0.1\n\n    if (score >= this.threshold) {\n      throw new PromptInjectionDetectedException('Potential prompt injection detected', {\n        score,\n        threshold: this.threshold,\n        preview: input.substring(0, 100),\n        context: context?.correlationId ?? undefined,\n        correlationId: context?.correlationId ?? undefined,\n        userId: context?.userId,\n      })\n    }\n\n    return {\n      allowed: true,\n      score,\n      threshold: this.threshold,\n      reason: score < this.threshold ? 'passed' : 'failed',\n      details: {\n        preview: input.substring(0, 100),\n      },\n    }\n  }\n\n  /**\n   * 检查输入并在不安全时抛出异常\n   * @param input 用户输入\n   * @param context 上下文信息\n   */\n  async ensureSafeOrThrow(\n    input: string,\n    context?: { userId?: string; correlationId?: string }\n  ): Promise<void> {\n    const result = await this.checkInput(input, context)\n    if (!result.allowed) {\n      throw new PromptInjectionDetectedException('Input failed security check', {\n        score: result.score,\n        threshold: result.threshold,\n        preview: result.details?.preview ?? undefined,\n        context: context?.correlationId ?? undefined,\n        correlationId: context?.correlationId ?? undefined,\n        userId: context?.userId ?? undefined,\n      })\n    }\n  }\n}\n\nconst MAX_RETRIES = 2\n\n/**\n * [核心护栏] 使用Zod Schema安全地调用AI提供商，并提供自动重试和超时机制。\n * @param provider AI提供商实例\n * @param prompt 要发送给AI的提示文本\n * @param schema 用于验证输出的Zod Schema\n * @param timeoutMs 超时时间（毫秒），默认为30000ms (30秒)\n * @returns 一个Promise，成功时解析为符合Schema的类型安全数据\n * @throws {AiGenerationException} 如果AI在多次重试后仍无法生成有效数据或超时\n */\nexport async function callAiWithGuard<T extends z.ZodType>(\n  provider: { generate: (options: { prompt: string; temperature?: number }) => Promise<string> }, // 简化的接口\n  prompt: string,\n  schema: T,\n  timeoutMs: number = 30000 // 默认30秒超时\n): Promise<z.infer<T>> {\n  let lastError: unknown = null\n\n  for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {\n    try {\n      // [新增] 创建带超时的Promise\n      const timeoutPromise = new Promise<never>((_, reject) => {\n        setTimeout(() => {\n          reject(new Error(`AI request timed out after ${timeoutMs}ms`))\n        }, timeoutMs)\n      })\n\n      // 竞态执行：AI调用 vs 超时\n      const response = await Promise.race([provider.generate({ prompt, temperature: 0.7 }), timeoutPromise])\n\n      // 尝试解析响应字符串\n      const dataToParse = JSON.parse(response)\n\n      const parseResult = await schema.safeParseAsync(dataToParse)\n\n      if (parseResult.success) {\n        return parseResult.data\n      } else {\n        lastError = parseResult.error\n        console.warn(`[AI Guard] Attempt ${attempt + 1} failed validation:`, lastError)\n      }\n    } catch (error) {\n      lastError = error\n      console.error(`[AI Guard] Attempt ${attempt + 1} failed with invocation error:`, error)\n\n      // 如果是超时错误，直接抛出，不再重试\n      if (error instanceof Error && error.message.includes('timed out')) {\n        throw new AiGenerationException(`AI request timed out after ${timeoutMs}ms`, error)\n      }\n    }\n  }\n\n  // 如果所有尝试都失败了，则抛出最终的异常\n  throw new AiGenerationException(\n    `AI failed to generate valid data after ${MAX_RETRIES + 1} attempts.`,\n    lastError\n  )\n}\n"],"version":3}