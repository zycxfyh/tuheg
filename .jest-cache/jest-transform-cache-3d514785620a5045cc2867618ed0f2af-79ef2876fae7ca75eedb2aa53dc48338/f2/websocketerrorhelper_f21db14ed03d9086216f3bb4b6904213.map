{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\errors\\websocket-error-helper.ts","mappings":";AAAA,qEAAqE;AACrE,mCAAmC;AACnC,EAAE;AACF,QAAQ;AACR,kDAAkD;AAClD,iBAAiB;AACjB,oBAAoB;;AAwDpB,0DAiBC;AAvED,iEAA0F;AA6B1F;;;;;;;;;;;;;;;;;;;;;;;;GAwBG;AACH,SAAgB,uBAAuB,CACrC,aAAsC,EACtC,aAAsB,EACtB,aAAsB;IAEtB,iBAAiB;IACjB,MAAM,eAAe,GAAG,uBAAuB,CAAC,aAAa,CAAC,CAAA;IAE9D,OAAO;QACL,SAAS,EAAE,aAAa,CAAC,SAAS;QAClC,YAAY,EAAE,eAAe;QAC7B,SAAS,EAAE,aAAa,CAAC,SAAS;QAClC,eAAe,EAAE,aAAa,CAAC,eAAe;QAC9C,aAAa;QACb,SAAS,EAAE,aAAa,CAAC,SAAS;QAClC,aAAa;KACd,CAAA;AACH,CAAC;AAED;;;;;;;;;;;;;GAaG;AACH,SAAS,uBAAuB,CAAC,aAAsC;IACrE,sBAAsB;IACtB,IAAI,aAAa,CAAC,eAAe,EAAE,CAAC;QAClC,OAAO,aAAa,CAAC,OAAO,CAAA;IAC9B,CAAC;IAED,mBAAmB;IACnB,QAAQ,aAAa,CAAC,SAAS,EAAE,CAAC;QAChC,KAAK,0CAAmB,CAAC,gBAAgB;YACvC,OAAO,eAAe,CAAA;QAExB,KAAK,0CAAmB,CAAC,mBAAmB;YAC1C,OAAO,8BAA8B,CAAA;QAEvC,KAAK,0CAAmB,CAAC,aAAa;YACpC,OAAO,mBAAmB,CAAA;QAE5B,KAAK,0CAAmB,CAAC,cAAc;YACrC,OAAO,iBAAiB,CAAA;QAE1B,KAAK,0CAAmB,CAAC,oBAAoB;YAC3C,OAAO,gBAAgB,CAAA;QAEzB;YACE,OAAO,aAAa,CAAC,OAAO,IAAI,YAAY,CAAA;IAChD,CAAC;AACH,CAAC","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\errors\\websocket-error-helper.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/errors/websocket-error-helper.ts\n// 职责: 将处理错误转换为 WebSocket 友好的错误事件载荷\n//\n// 核心功能:\n// 1. 将 ProcessingErrorResponse 转换为 WebSocket 事件数据\n// 2. 生成用户友好的错误消息\n// 3. 提供前端错误处理的标准化格式\n\nimport { type ProcessingErrorResponse, ProcessingErrorType } from './error-classification'\n\n/**\n * WebSocket processing_failed 事件的标准载荷\n *\n * @property errorCode - 错误分类码（前端可根据此显示不同UI）\n * @property errorMessage - 用户友好的错误信息\n * @property retryable - 是否可重试\n * @property suggestedAction - 建议的用户操作\n * @property correlationId - 关联ID（用于追踪）\n * @property errorType - 错误类型（用于调试）\n */\nexport interface ProcessingFailedEventPayload {\n  /** 错误分类码 */\n  errorCode: string\n  /** 用户友好的错误信息 */\n  errorMessage: string\n  /** 是否可重试 */\n  retryable: boolean\n  /** 建议的用户操作 */\n  suggestedAction?: string\n  /** 关联ID（用于追踪） */\n  correlationId?: string\n  /** 错误类型（用于调试和日志） */\n  errorType?: ProcessingErrorType\n  /** 原始错误消息（用于调试，可选） */\n  originalError?: string\n}\n\n/**\n * 将 ProcessingErrorResponse 转换为 WebSocket 事件载荷\n *\n * @param errorResponse - 标准化的错误响应\n * @param correlationId - 关联ID（可选）\n * @returns WebSocket 友好的错误事件载荷\n *\n * @remarks\n * 此函数确保：\n * 1. 错误信息对用户友好\n * 2. 前端可以根据 errorCode 显示不同的 UI\n * 3. 用户知道是否应该重试以及如何操作\n *\n * @example\n * ```typescript\n * const errorResponse = classifyProcessingError(error);\n * const eventPayload = formatErrorForWebSocket(errorResponse, correlationId);\n *\n * eventBus.publish('NOTIFY_USER', {\n *   userId,\n *   event: 'processing_failed',\n *   data: eventPayload,\n * });\n * ```\n */\nexport function formatErrorForWebSocket(\n  errorResponse: ProcessingErrorResponse,\n  correlationId?: string,\n  originalError?: string\n): ProcessingFailedEventPayload {\n  // 根据错误类型生成更友好的消息\n  const friendlyMessage = getFriendlyErrorMessage(errorResponse)\n\n  return {\n    errorCode: errorResponse.errorCode,\n    errorMessage: friendlyMessage,\n    retryable: errorResponse.retryable,\n    suggestedAction: errorResponse.suggestedAction,\n    correlationId,\n    errorType: errorResponse.errorType,\n    originalError,\n  }\n}\n\n/**\n * 根据错误类型生成用户友好的错误消息\n *\n * @param errorResponse - 错误响应\n * @returns 用户友好的错误消息\n *\n * @remarks\n * 不同错误类型对应不同的用户消息：\n * - VALIDATION_ERROR: \"输入格式错误\"\n * - AI_GENERATION_ERROR: \"AI 生成失败，请重试\"\n * - NETWORK_ERROR: \"网络连接失败，请检查网络后重试\"\n * - DATABASE_ERROR: \"数据服务暂时不可用，请稍后重试\"\n * - BUSINESS_LOGIC_ERROR: \"处理失败，请检查输入\"\n */\nfunction getFriendlyErrorMessage(errorResponse: ProcessingErrorResponse): string {\n  // 如果已经有建议的操作，优先使用原始消息\n  if (errorResponse.suggestedAction) {\n    return errorResponse.message\n  }\n\n  // 根据错误类型返回本地化的友好消息\n  switch (errorResponse.errorType) {\n    case ProcessingErrorType.VALIDATION_ERROR:\n      return '输入格式错误，请检查后重试'\n\n    case ProcessingErrorType.AI_GENERATION_ERROR:\n      return 'AI 处理失败，系统将自动重试。如果问题持续，请联系支持'\n\n    case ProcessingErrorType.NETWORK_ERROR:\n      return '网络连接失败，请检查网络连接后重试'\n\n    case ProcessingErrorType.DATABASE_ERROR:\n      return '数据服务暂时不可用，请稍后重试'\n\n    case ProcessingErrorType.BUSINESS_LOGIC_ERROR:\n      return '处理失败，请检查输入是否正确'\n\n    default:\n      return errorResponse.message || '处理失败，请稍后重试'\n  }\n}\n"],"version":3}