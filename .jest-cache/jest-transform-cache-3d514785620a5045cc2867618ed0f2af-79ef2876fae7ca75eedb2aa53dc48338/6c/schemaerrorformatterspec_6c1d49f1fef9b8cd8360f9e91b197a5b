5000e50e52f553e6257f6d271f7a38fb
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const zod_1 = require("zod");
const schema_error_formatter_1 = require("./schema-error-formatter");
describe('formatZodError', () => {
    it('should format missing field error', () => {
        const schema = zod_1.z.object({
            name: zod_1.z.string(),
            age: zod_1.z.number(),
        });
        const result = schema.safeParse({ name: 'John' });
        expect(result.success).toBe(false);
        if (!result.success) {
            const formatted = (0, schema_error_formatter_1.formatZodError)(result.error);
            expect(formatted.summary).toContain('Validation failed');
            expect(formatted.fieldErrors.length).toBeGreaterThan(0);
            expect(formatted.fieldErrors.some((e) => e.path.includes('age'))).toBe(true);
            expect(formatted.aiFeedback).toContain('age');
        }
    });
    it('should format type mismatch error', () => {
        const schema = zod_1.z.object({
            count: zod_1.z.number(),
        });
        const result = schema.safeParse({ count: 'not-a-number' });
        expect(result.success).toBe(false);
        if (!result.success) {
            const formatted = (0, schema_error_formatter_1.formatZodError)(result.error);
            expect(formatted.fieldErrors.length).toBeGreaterThan(0);
            const countError = formatted.fieldErrors.find((e) => e.path === 'count');
            expect(countError).toBeDefined();
            expect(countError?.expected).toBe('number');
            // received 可能为 undefined（如果无法从错误中提取）
            // 只要错误消息正确就足够了
        }
    });
    it('should format enum error', () => {
        const schema = zod_1.z.object({
            status: zod_1.z.enum(['active', 'inactive', 'pending']),
        });
        const result = schema.safeParse({ status: 'invalid' });
        expect(result.success).toBe(false);
        if (!result.success) {
            const formatted = (0, schema_error_formatter_1.formatZodError)(result.error);
            const statusError = formatted.fieldErrors.find((e) => e.path === 'status');
            expect(statusError).toBeDefined();
            expect(statusError?.expected).toContain('active');
            expect(statusError?.expected).toContain('inactive');
        }
    });
    it('should format array length error', () => {
        const schema = zod_1.z.object({
            items: zod_1.z.array(zod_1.z.string()).min(2),
        });
        const result = schema.safeParse({ items: ['one'] });
        expect(result.success).toBe(false);
        if (!result.success) {
            const formatted = (0, schema_error_formatter_1.formatZodError)(result.error);
            const itemsError = formatted.fieldErrors.find((e) => e.path === 'items');
            expect(itemsError).toBeDefined();
            expect(itemsError?.expected).toContain('at least');
        }
    });
    it('should generate AI-friendly feedback', () => {
        const schema = zod_1.z.object({
            name: zod_1.z.string().min(1),
            email: zod_1.z.string().email(),
        });
        const result = schema.safeParse({
            name: '',
            email: 'invalid-email',
        });
        expect(result.success).toBe(false);
        if (!result.success) {
            const formatted = (0, schema_error_formatter_1.formatZodError)(result.error);
            expect(formatted.aiFeedback).toContain('Validation Errors Detected');
            expect(formatted.aiFeedback).toContain('Action Required');
            expect(formatted.aiFeedback).toContain('name');
            expect(formatted.aiFeedback).toContain('email');
        }
    });
    it('should handle nested object errors', () => {
        const schema = zod_1.z.object({
            user: zod_1.z.object({
                name: zod_1.z.string(),
                age: zod_1.z.number(),
            }),
        });
        const result = schema.safeParse({
            user: { name: 'John' },
        });
        expect(result.success).toBe(false);
        if (!result.success) {
            const formatted = (0, schema_error_formatter_1.formatZodError)(result.error);
            const userAgeError = formatted.fieldErrors.find((e) => e.path.includes('age'));
            expect(userAgeError).toBeDefined();
            expect(formatted.aiFeedback).toContain('user');
        }
    });
    it('should format as JSON correctly', () => {
        const schema = zod_1.z.object({
            name: zod_1.z.string(),
        });
        const result = schema.safeParse({});
        expect(result.success).toBe(false);
        if (!result.success) {
            const formatted = (0, schema_error_formatter_1.formatZodError)(result.error);
            const json = (0, schema_error_formatter_1.formatZodErrorAsJson)(formatted);
            expect(() => JSON.parse(json)).not.toThrow();
            const parsed = JSON.parse(json);
            expect(parsed).toHaveProperty('summary');
            expect(parsed).toHaveProperty('fieldErrors');
            expect(parsed).toHaveProperty('errorCount');
        }
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxhaVxcX190ZXN0c19fXFxzY2hlbWEtZXJyb3ItZm9ybWF0dGVyLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBdUI7QUFDdkIscUVBQStFO0FBRS9FLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7SUFDOUIsRUFBRSxDQUFDLG1DQUFtQyxFQUFFLEdBQUcsRUFBRTtRQUMzQyxNQUFNLE1BQU0sR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO1lBQ3RCLElBQUksRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFO1lBQ2hCLEdBQUcsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFO1NBQ2hCLENBQUMsQ0FBQTtRQUVGLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQTtRQUNqRCxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUVsQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3BCLE1BQU0sU0FBUyxHQUFHLElBQUEsdUNBQWMsRUFBQyxNQUFNLENBQUMsS0FBWSxDQUFDLENBQUE7WUFDckQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtZQUN4RCxNQUFNLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDdkQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxD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LENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQyxDQUFBIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxwYWNrYWdlc1xcY29tbW9uLWJhY2tlbmRcXHNyY1xcYWlcXF9fdGVzdHNfX1xcc2NoZW1hLWVycm9yLWZvcm1hdHRlci5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHogfSBmcm9tICd6b2QnXG5pbXBvcnQgeyBmb3JtYXRab2RFcnJvciwgZm9ybWF0Wm9kRXJyb3JBc0pzb24gfSBmcm9tICcuL3NjaGVtYS1lcnJvci1mb3JtYXR0ZXInXG5cbmRlc2NyaWJlKCdmb3JtYXRab2RFcnJvcicsICgpID0+IHtcbiAgaXQoJ3Nob3VsZCBmb3JtYXQgbWlzc2luZyBmaWVsZCBlcnJvcicsICgpID0+IHtcbiAgICBjb25zdCBzY2hlbWEgPSB6Lm9iamVjdCh7XG4gICAgICBuYW1lOiB6LnN0cmluZygpLFxuICAgICAgYWdlOiB6Lm51bWJlcigpLFxuICAgIH0pXG5cbiAgICBjb25zdCByZXN1bHQgPSBzY2hlbWEuc2FmZVBhcnNlKHsgbmFtZTogJ0pvaG4nIH0pXG4gICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKGZhbHNlKVxuXG4gICAgaWYgKCFyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgY29uc3QgZm9ybWF0dGVkID0gZm9ybWF0Wm9kRXJyb3IocmVzdWx0LmVycm9yIGFzIGFueSlcbiAgICAgIGV4cGVjdChmb3JtYXR0ZWQuc3VtbWFyeSkudG9Db250YWluKCdWYWxpZGF0aW9uIGZhaWxlZCcpXG4gICAgICBleHBlY3QoZm9ybWF0dGVkLmZpZWxkRXJyb3JzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApXG4gICAgICBleHBlY3QoZm9ybWF0dGVkLmZpZWxkRXJyb3JzLnNvbWUoKGUpID0+IGUucGF0aC5pbmNsdWRlcygnYWdlJykpKS50b0JlKHRydWUpXG4gICAgICBleHBlY3QoZm9ybWF0dGVkLmFpRmVlZGJhY2spLnRvQ29udGFpbignYWdlJylcbiAgICB9XG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBmb3JtYXQgdHlwZSBtaXNtYXRjaCBlcnJvcicsICgpID0+IHtcbiAgICBjb25zdCBzY2hlbWEgPSB6Lm9iamVjdCh7XG4gICAgICBjb3VudDogei5udW1iZXIoKSxcbiAgICB9KVxuXG4gICAgY29uc3QgcmVzdWx0ID0gc2NoZW1hLnNhZmVQYXJzZSh7IGNvdW50OiAnbm90LWEtbnVtYmVyJyB9KVxuICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZShmYWxzZSlcblxuICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGZvcm1hdHRlZCA9IGZvcm1hdFpvZEVycm9yKHJlc3VsdC5lcnJvciBhcyBhbnkpXG4gICAgICBleHBlY3QoZm9ybWF0dGVkLmZpZWxkRXJyb3JzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApXG4gICAgICBjb25zdCBjb3VudEVycm9yID0gZm9ybWF0dGVkLmZpZWxkRXJyb3JzLmZpbmQoKGUpID0+IGUucGF0aCA9PT0gJ2NvdW50JylcbiAgICAgIGV4cGVjdChjb3VudEVycm9yKS50b0JlRGVmaW5lZCgpXG4gICAgICBleHBlY3QoY291bnRFcnJvcj8uZXhwZWN0ZWQpLnRvQmUoJ251bWJlcicpXG4gICAgICAvLyByZWNlaXZlZCDlj6/og73kuLogdW5kZWZpbmVk77yI5aaC5p6c5peg5rOV5LuO6ZSZ6K+v5Lit5o+Q5Y+W77yJXG4gICAgICAvLyDlj6ropoHplJnor6/mtojmga/mraPnoa7lsLHotrPlpJ/kuoZcbiAgICB9XG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBmb3JtYXQgZW51bSBlcnJvcicsICgpID0+IHtcbiAgICBjb25zdCBzY2hlbWEgPSB6Lm9iamVjdCh7XG4gICAgICBzdGF0dXM6IHouZW51bShbJ2FjdGl2ZScsICdpbmFjdGl2ZScsICdwZW5kaW5nJ10pLFxuICAgIH0pXG5cbiAgICBjb25zdCByZXN1bHQgPSBzY2hlbWEuc2FmZVBhcnNlKHsgc3RhdHVzOiAnaW52YWxpZCcgfSlcbiAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUoZmFsc2UpXG5cbiAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICBjb25zdCBmb3JtYXR0ZWQgPSBmb3JtYXRab2RFcnJvcihyZXN1bHQuZXJyb3IgYXMgYW55KVxuICAgICAgY29uc3Qgc3RhdHVzRXJyb3IgPSBmb3JtYXR0ZWQuZmllbGRFcnJvcnMuZmluZCgoZSkgPT4gZS5wYXRoID09PSAnc3RhdHVzJylcbiAgICAgIGV4cGVjdChzdGF0dXNFcnJvcikudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KHN0YXR1c0Vycm9yPy5leHBlY3RlZCkudG9Db250YWluKCdhY3RpdmUnKVxuICAgICAgZXhwZWN0KHN0YXR1c0Vycm9yPy5leHBlY3RlZCkudG9Db250YWluKCdpbmFjdGl2ZScpXG4gICAgfVxuICB9KVxuXG4gIGl0KCdzaG91bGQgZm9ybWF0IGFycmF5IGxlbmd0aCBlcnJvcicsICgpID0+IHtcbiAgICBjb25zdCBzY2hlbWEgPSB6Lm9iamVjdCh7XG4gICAgICBpdGVtczogei5hcnJheSh6LnN0cmluZygpKS5taW4oMiksXG4gICAgfSlcblxuICAgIGNvbnN0IHJlc3VsdCA9IHNjaGVtYS5zYWZlUGFyc2UoeyBpdGVtczogWydvbmUnXSB9KVxuICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZShmYWxzZSlcblxuICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGZvcm1hdHRlZCA9IGZvcm1hdFpvZEVycm9yKHJlc3VsdC5lcnJvciBhcyBhbnkpXG4gICAgICBjb25zdCBpdGVtc0Vycm9yID0gZm9ybWF0dGVkLmZpZWxkRXJyb3JzLmZpbmQoKGUpID0+IGUucGF0aCA9PT0gJ2l0ZW1zJylcbiAgICAgIGV4cGVjdChpdGVtc0Vycm9yKS50b0JlRGVmaW5lZCgpXG4gICAgICBleHBlY3QoaXRlbXNFcnJvcj8uZXhwZWN0ZWQpLnRvQ29udGFpbignYXQgbGVhc3QnKVxuICAgIH1cbiAgfSlcblxuICBpdCgnc2hvdWxkIGdlbmVyYXRlIEFJLWZyaWVuZGx5IGZlZWRiYWNrJywgKCkgPT4ge1xuICAgIGNvbnN0IHNjaGVtYSA9IHoub2JqZWN0KHtcbiAgICAgIG5hbWU6IHouc3RyaW5nKCkubWluKDEpLFxuICAgICAgZW1haWw6IHouc3RyaW5nKCkuZW1haWwoKSxcbiAgICB9KVxuXG4gICAgY29uc3QgcmVzdWx0ID0gc2NoZW1hLnNhZmVQYXJzZSh7XG4gICAgICBuYW1lOiAnJyxcbiAgICAgIGVtYWlsOiAnaW52YWxpZC1lbWFpbCcsXG4gICAgfSlcbiAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUoZmFsc2UpXG5cbiAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICBjb25zdCBmb3JtYXR0ZWQgPSBmb3JtYXRab2RFcnJvcihyZXN1bHQuZXJyb3IgYXMgYW55KVxuICAgICAgZXhwZWN0KGZvcm1hdHRlZC5haUZlZWRiYWNrKS50b0NvbnRhaW4oJ1ZhbGlkYXRpb24gRXJyb3JzIERldGVjdGVkJylcbiAgICAgIGV4cGVjdChmb3JtYXR0ZWQuYWlGZWVkYmFjaykudG9Db250YWluKCdBY3Rpb24gUmVxdWlyZWQnKVxuICAgICAgZXhwZWN0KGZvcm1hdHRlZC5haUZlZWRiYWNrKS50b0NvbnRhaW4oJ25hbWUnKVxuICAgICAgZXhwZWN0KGZvcm1hdHRlZC5haUZlZWRiYWNrKS50b0NvbnRhaW4oJ2VtYWlsJylcbiAgICB9XG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBoYW5kbGUgbmVzdGVkIG9iamVjdCBlcnJvcnMnLCAoKSA9PiB7XG4gICAgY29uc3Qgc2NoZW1hID0gei5vYmplY3Qoe1xuICAgICAgdXNlcjogei5vYmplY3Qoe1xuICAgICAgICBuYW1lOiB6LnN0cmluZygpLFxuICAgICAgICBhZ2U6IHoubnVtYmVyKCksXG4gICAgICB9KSxcbiAgICB9KVxuXG4gICAgY29uc3QgcmVzdWx0ID0gc2NoZW1hLnNhZmVQYXJzZSh7XG4gICAgICB1c2VyOiB7IG5hbWU6ICdKb2huJyB9LFxuICAgIH0pXG4gICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKGZhbHNlKVxuXG4gICAgaWYgKCFyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgY29uc3QgZm9ybWF0dGVkID0gZm9ybWF0Wm9kRXJyb3IocmVzdWx0LmVycm9yIGFzIGFueSlcbiAgICAgIGNvbnN0IHVzZXJBZ2VFcnJvciA9IGZvcm1hdHRlZC5maWVsZEVycm9ycy5maW5kKChlKSA9PiBlLnBhdGguaW5jbHVkZXMoJ2FnZScpKVxuICAgICAgZXhwZWN0KHVzZXJBZ2VFcnJvcikudG9CZURlZmluZWQoKVxuICAgICAgZXhwZWN0KGZvcm1hdHRlZC5haUZlZWRiYWNrKS50b0NvbnRhaW4oJ3VzZXInKVxuICAgIH1cbiAgfSlcblxuICBpdCgnc2hvdWxkIGZvcm1hdCBhcyBKU09OIGNvcnJlY3RseScsICgpID0+IHtcbiAgICBjb25zdCBzY2hlbWEgPSB6Lm9iamVjdCh7XG4gICAgICBuYW1lOiB6LnN0cmluZygpLFxuICAgIH0pXG5cbiAgICBjb25zdCByZXN1bHQgPSBzY2hlbWEuc2FmZVBhcnNlKHt9KVxuICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZShmYWxzZSlcblxuICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGZvcm1hdHRlZCA9IGZvcm1hdFpvZEVycm9yKHJlc3VsdC5lcnJvcilcbiAgICAgIGNvbnN0IGpzb24gPSBmb3JtYXRab2RFcnJvckFzSnNvbihmb3JtYXR0ZWQpXG4gICAgICBleHBlY3QoKCkgPT4gSlNPTi5wYXJzZShqc29uKSkubm90LnRvVGhyb3coKVxuICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShqc29uKVxuICAgICAgZXhwZWN0KHBhcnNlZCkudG9IYXZlUHJvcGVydHkoJ3N1bW1hcnknKVxuICAgICAgZXhwZWN0KHBhcnNlZCkudG9IYXZlUHJvcGVydHkoJ2ZpZWxkRXJyb3JzJylcbiAgICAgIGV4cGVjdChwYXJzZWQpLnRvSGF2ZVByb3BlcnR5KCdlcnJvckNvdW50JylcbiAgICB9XG4gIH0pXG59KVxuIl0sInZlcnNpb24iOjN9