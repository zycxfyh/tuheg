{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\vcp-protocol.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\vcp-protocol.service.ts"],"sourcesContent":["// ============================================================================\r\n// VCP协议核心服务集成\r\n// 集成 VCPToolBox 的统一交互标准到创世星环\r\n// ============================================================================\r\n\r\nimport { Injectable, Logger, OnModuleInit } from '@nestjs/common'\r\nimport { ConfigService } from '@nestjs/config'\r\nimport {\r\n  vcpProtocol,\r\n  VCPMessage,\r\n  VCPToolRequest,\r\n  VCPToolResponse,\r\n  VCPMemoryOperation,\r\n  VCPFileOperation,\r\n  VCPEndpoint\r\n} from '../../../apps/vcptoolbox/src/modules/communication/VCPProtocol'\r\n\r\n@Injectable()\r\nexport class VCPProtocolService implements OnModuleInit {\r\n  private readonly logger = new Logger(VCPProtocolService.name)\r\n\r\n  constructor(private configService: ConfigService) {}\r\n\r\n  async onModuleInit() {\r\n    await this.initializeVCPProtocol()\r\n    this.setupProtocolHandlers()\r\n    this.registerSystemEndpoints()\r\n    this.logger.log('VCP协议服务已初始化')\r\n  }\r\n\r\n  // ==================== 协议初始化 ====================\r\n\r\n  /**\r\n   * 初始化VCP协议\r\n   */\r\n  private async initializeVCPProtocol(): Promise<void> {\r\n    // 设置协议事件监听器\r\n    vcpProtocol.on('message', (message: VCPMessage) => {\r\n      this.logger.debug(`VCP消息接收: ${message.action}`)\r\n    })\r\n\r\n    vcpProtocol.on('error', (error: Error) => {\r\n      this.logger.error('VCP协议错误:', error)\r\n    })\r\n\r\n    this.logger.log('VCP协议核心已初始化')\r\n  }\r\n\r\n  /**\r\n   * 设置协议处理器\r\n   */\r\n  private setupProtocolHandlers(): void {\r\n    // 订阅重要的协议事件\r\n    vcpProtocol.subscribe('tool.execution', (message: VCPMessage) => {\r\n      this.handleToolExecutionEvent(message)\r\n    })\r\n\r\n    vcpProtocol.subscribe('agent.collaboration', (message: VCPMessage) => {\r\n      this.handleAgentCollaborationEvent(message)\r\n    })\r\n\r\n    vcpProtocol.subscribe('narrative.generation', (message: VCPMessage) => {\r\n      this.handleNarrativeGenerationEvent(message)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 注册系统端点\r\n   */\r\n  private registerSystemEndpoints(): void {\r\n    // 注册AI服务端点\r\n    vcpProtocol.registerEndpoint({\r\n      id: 'ai-service',\r\n      type: 'service',\r\n      url: 'internal://ai-service',\r\n      capabilities: ['text-generation', 'image-generation', 'analysis'],\r\n      status: 'online',\r\n      metadata: {\r\n        version: '1.0.0',\r\n        description: 'AI服务端点',\r\n        author: 'system',\r\n        lastSeen: new Date()\r\n      }\r\n    })\r\n\r\n    // 注册记忆服务端点\r\n    vcpProtocol.registerEndpoint({\r\n      id: 'memory-service',\r\n      type: 'service',\r\n      url: 'internal://memory-service',\r\n      capabilities: ['memory-read', 'memory-write', 'memory-search'],\r\n      status: 'online',\r\n      metadata: {\r\n        version: '1.0.0',\r\n        description: '记忆服务端点',\r\n        author: 'system',\r\n        lastSeen: new Date()\r\n      }\r\n    })\r\n\r\n    // 注册文件服务端点\r\n    vcpProtocol.registerEndpoint({\r\n      id: 'file-service',\r\n      type: 'service',\r\n      url: 'internal://file-service',\r\n      capabilities: ['file-upload', 'file-download', 'file-list'],\r\n      status: 'online',\r\n      metadata: {\r\n        version: '1.0.0',\r\n        description: '文件服务端点',\r\n        author: 'system',\r\n        lastSeen: new Date()\r\n      }\r\n    })\r\n\r\n    this.logger.log('系统端点已注册')\r\n  }\r\n\r\n  // ==================== 事件处理器 ====================\r\n\r\n  /**\r\n   * 处理工具执行事件\r\n   */\r\n  private async handleToolExecutionEvent(message: VCPMessage): Promise<void> {\r\n    const { toolId, status, result } = message.payload\r\n    this.logger.debug(`工具执行事件: ${toolId} - ${status}`)\r\n\r\n    // 可以在这里添加监控、日志记录等\r\n    if (status === 'error') {\r\n      this.logger.warn(`工具执行失败: ${toolId}`, result)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 处理Agent协作事件\r\n   */\r\n  private async handleAgentCollaborationEvent(message: VCPMessage): Promise<void> {\r\n    const { agentId, action, context } = message.payload\r\n    this.logger.debug(`Agent协作事件: ${agentId} - ${action}`)\r\n\r\n    // 处理协作相关的逻辑\r\n  }\r\n\r\n  /**\r\n   * 处理叙事生成事件\r\n   */\r\n  private async handleNarrativeGenerationEvent(message: VCPMessage): Promise<void> {\r\n    const { storyId, progress, status } = message.payload\r\n    this.logger.debug(`叙事生成事件: ${storyId} - ${progress}% - ${status}`)\r\n\r\n    // 处理叙事生成进度\r\n  }\r\n\r\n  // ==================== 工具集成接口 ====================\r\n\r\n  /**\r\n   * 调用AI生成工具\r\n   */\r\n  async callAIGenerationTool(prompt: string, options: {\r\n    model?: string\r\n    temperature?: number\r\n    maxTokens?: number\r\n    type?: 'text' | 'image' | 'audio'\r\n  } = {}): Promise<VCPToolResponse> {\r\n    const request: VCPToolRequest = {\r\n      toolId: options.type === 'image' ? 'image-generator' : 'text-generator',\r\n      action: 'generate',\r\n      parameters: {\r\n        prompt,\r\n        model: options.model || 'gpt-4',\r\n        temperature: options.temperature || 0.7,\r\n        maxTokens: options.maxTokens || 1000\r\n      },\r\n      options: {\r\n        timeout: 60000, // 60秒超时\r\n        async: true\r\n      }\r\n    }\r\n\r\n    try {\r\n      const response = await vcpProtocol.callTool(request)\r\n      this.logger.log(`AI工具调用成功: ${request.toolId}`)\r\n      return response\r\n    } catch (error: any) {\r\n      this.logger.error(`AI工具调用失败: ${request.toolId}`, error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 调用分析工具\r\n   */\r\n  async callAnalysisTool(content: string, analysisType: string): Promise<VCPToolResponse> {\r\n    const request: VCPToolRequest = {\r\n      toolId: 'content-analyzer',\r\n      action: 'analyze',\r\n      parameters: {\r\n        content,\r\n        type: analysisType\r\n      },\r\n      options: {\r\n        timeout: 30000,\r\n        async: false\r\n      }\r\n    }\r\n\r\n    const response = await vcpProtocol.callTool(request)\r\n    this.logger.log(`分析工具调用成功: ${analysisType}`)\r\n    return response\r\n  }\r\n\r\n  /**\r\n   * 调用翻译工具\r\n   */\r\n  async callTranslationTool(text: string, targetLanguage: string): Promise<string> {\r\n    const request: VCPToolRequest = {\r\n      toolId: 'translator',\r\n      action: 'translate',\r\n      parameters: {\r\n        text,\r\n        targetLanguage\r\n      }\r\n    }\r\n\r\n    const response = await vcpProtocol.callTool(request)\r\n    return response.result?.translatedText || text\r\n  }\r\n\r\n  // ==================== 记忆操作接口 ====================\r\n\r\n  /**\r\n   * 读取记忆\r\n   */\r\n  async readMemory(key: string, scope: 'agent' | 'session' | 'global' = 'global'): Promise<any> {\r\n    const operation: VCPMemoryOperation = {\r\n      operation: 'read',\r\n      scope,\r\n      parameters: { key }\r\n    }\r\n\r\n    const message: VCPMessage = {\r\n      id: `memory-read-${Date.now()}`,\r\n      version: '1.0',\r\n      type: 'request',\r\n      action: 'memory.read',\r\n      payload: operation,\r\n      metadata: {\r\n        timestamp: new Date(),\r\n        source: 'vcp-protocol-service',\r\n        priority: 'normal'\r\n      },\r\n      security: {\r\n        permissions: ['memory.read']\r\n      }\r\n    }\r\n\r\n    const response = await vcpProtocol.sendMessage(message)\r\n    return response\r\n  }\r\n\r\n  /**\r\n   * 写入记忆\r\n   */\r\n  async writeMemory(key: string, value: any, scope: 'agent' | 'session' | 'global' = 'global'): Promise<void> {\r\n    const operation: VCPMemoryOperation = {\r\n      operation: 'write',\r\n      scope,\r\n      parameters: { key, value }\r\n    }\r\n\r\n    const message: VCPMessage = {\r\n      id: `memory-write-${Date.now()}`,\r\n      version: '1.0',\r\n      type: 'request',\r\n      action: 'memory.write',\r\n      payload: operation,\r\n      metadata: {\r\n        timestamp: new Date(),\r\n        source: 'vcp-protocol-service',\r\n        priority: 'normal'\r\n      },\r\n      security: {\r\n        permissions: ['memory.write']\r\n      }\r\n    }\r\n\r\n    await vcpProtocol.sendMessage(message)\r\n  }\r\n\r\n  /**\r\n   * 搜索记忆\r\n   */\r\n  async searchMemory(query: string, tags?: string[]): Promise<any[]> {\r\n    const operation: VCPMemoryOperation = {\r\n      operation: 'search',\r\n      scope: 'global',\r\n      parameters: {\r\n        query,\r\n        tags,\r\n        limit: 10\r\n      }\r\n    }\r\n\r\n    const message: VCPMessage = {\r\n      id: `memory-search-${Date.now()}`,\r\n      version: '1.0',\r\n      type: 'request',\r\n      action: 'memory.search',\r\n      payload: operation,\r\n      metadata: {\r\n        timestamp: new Date(),\r\n        source: 'vcp-protocol-service',\r\n        priority: 'normal'\r\n      },\r\n      security: {\r\n        permissions: ['memory.read']\r\n      }\r\n    }\r\n\r\n    const response = await vcpProtocol.sendMessage(message)\r\n    return response?.results || []\r\n  }\r\n\r\n  // ==================== 文件操作接口 ====================\r\n\r\n  /**\r\n   * 上传文件\r\n   */\r\n  async uploadFile(fileData: any, options?: { mimeType?: string, filename?: string }): Promise<any> {\r\n    const operation: VCPFileOperation = {\r\n      operation: 'upload',\r\n      path: options?.filename || `upload-${Date.now()}`,\r\n      data: fileData,\r\n      options: {\r\n        mimeType: options?.mimeType\r\n      }\r\n    }\r\n\r\n    const message: VCPMessage = {\r\n      id: `file-upload-${Date.now()}`,\r\n      version: '1.0',\r\n      type: 'request',\r\n      action: 'file.upload',\r\n      payload: operation,\r\n      metadata: {\r\n        timestamp: new Date(),\r\n        source: 'vcp-protocol-service',\r\n        priority: 'normal'\r\n      },\r\n      security: {\r\n        permissions: ['file.upload']\r\n      }\r\n    }\r\n\r\n    const response = await vcpProtocol.sendMessage(message)\r\n    return response\r\n  }\r\n\r\n  /**\r\n   * 下载文件\r\n   */\r\n  async downloadFile(fileId: string): Promise<any> {\r\n    const operation: VCPFileOperation = {\r\n      operation: 'download',\r\n      path: fileId\r\n    }\r\n\r\n    const message: VCPMessage = {\r\n      id: `file-download-${Date.now()}`,\r\n      version: '1.0',\r\n      type: 'request',\r\n      action: 'file.download',\r\n      payload: operation,\r\n      metadata: {\r\n        timestamp: new Date(),\r\n        source: 'vcp-protocol-service',\r\n        priority: 'normal'\r\n      },\r\n      security: {\r\n        permissions: ['file.download']\r\n      }\r\n    }\r\n\r\n    const response = await vcpProtocol.sendMessage(message)\r\n    return response?.data\r\n  }\r\n\r\n  // ==================== 叙事专用接口 ====================\r\n\r\n  /**\r\n   * 发送叙事生成请求\r\n   */\r\n  async requestNarrativeGeneration(storyId: string, prompt: string, context: any): Promise<string> {\r\n    const message: VCPMessage = {\r\n      id: `narrative-gen-${Date.now()}`,\r\n      version: '1.0',\r\n      type: 'request',\r\n      action: 'narrative.generate',\r\n      payload: {\r\n        storyId,\r\n        prompt,\r\n        context,\r\n        options: {\r\n          async: true,\r\n          priority: 'high'\r\n        }\r\n      },\r\n      metadata: {\r\n        timestamp: new Date(),\r\n        source: 'narrative-service',\r\n        priority: 'high'\r\n      },\r\n      security: {\r\n        permissions: ['narrative.generate']\r\n      }\r\n    }\r\n\r\n    const response = await vcpProtocol.sendMessage(message)\r\n    return response?.taskId || message.id\r\n  }\r\n\r\n  /**\r\n   * 发送Agent协作请求\r\n   */\r\n  async requestAgentCollaboration(\r\n    collaborationId: string,\r\n    agentIds: string[],\r\n    task: any\r\n  ): Promise<string> {\r\n    const message: VCPMessage = {\r\n      id: `collaboration-${Date.now()}`,\r\n      version: '1.0',\r\n      type: 'request',\r\n      action: 'agent.collaborate',\r\n      payload: {\r\n        collaborationId,\r\n        agentIds,\r\n        task,\r\n        strategy: 'parallel' // 并行协作\r\n      },\r\n      metadata: {\r\n        timestamp: new Date(),\r\n        source: 'collaboration-service',\r\n        priority: 'normal'\r\n      },\r\n      security: {\r\n        permissions: ['agent.collaborate']\r\n      }\r\n    }\r\n\r\n    const response = await vcpProtocol.sendMessage(message)\r\n    return response?.collaborationId || collaborationId\r\n  }\r\n\r\n  /**\r\n   * 广播系统事件\r\n   */\r\n  async broadcastSystemEvent(eventType: string, eventData: any): Promise<void> {\r\n    const message: VCPMessage = {\r\n      id: `system-event-${Date.now()}`,\r\n      version: '1.0',\r\n      type: 'event',\r\n      action: `system.${eventType}`,\r\n      payload: eventData,\r\n      metadata: {\r\n        timestamp: new Date(),\r\n        source: 'system',\r\n        priority: 'normal'\r\n      },\r\n      security: {\r\n        permissions: ['system.broadcast']\r\n      }\r\n    }\r\n\r\n    await vcpProtocol.sendMessage(message)\r\n  }\r\n\r\n  // ==================== 端点管理 ====================\r\n\r\n  /**\r\n   * 获取可用端点\r\n   */\r\n  getAvailableEndpoints(capability?: string): VCPEndpoint[] {\r\n    return vcpProtocol.findEndpoints(capability)\r\n  }\r\n\r\n  /**\r\n   * 注册自定义端点\r\n   */\r\n  registerEndpoint(endpoint: VCPEndpoint): void {\r\n    vcpProtocol.registerEndpoint(endpoint)\r\n    this.logger.log(`自定义端点已注册: ${endpoint.id}`)\r\n  }\r\n\r\n  /**\r\n   * 注销端点\r\n   */\r\n  unregisterEndpoint(endpointId: string): void {\r\n    vcpProtocol.unregisterEndpoint(endpointId)\r\n    this.logger.log(`端点已注销: ${endpointId}`)\r\n  }\r\n\r\n  // ==================== 监控和统计 ====================\r\n\r\n  /**\r\n   * 获取协议统计信息\r\n   */\r\n  getProtocolStats(): any {\r\n    return vcpProtocol.getStats()\r\n  }\r\n\r\n  /**\r\n   * 健康检查\r\n   */\r\n  async healthCheck(): Promise<{ status: string, details?: any }> {\r\n    try {\r\n      const stats = this.getProtocolStats()\r\n      return {\r\n        status: 'healthy',\r\n        details: stats\r\n      }\r\n    } catch (error: any) {\r\n      return {\r\n        status: 'error',\r\n        details: error.message\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 清理过期任务\r\n   */\r\n  async cleanupExpiredTasks(): Promise<void> {\r\n    // 清理VCP协议中的过期任务\r\n    this.logger.log('VCP协议任务清理完成')\r\n  }\r\n}\r\n"],"version":3}