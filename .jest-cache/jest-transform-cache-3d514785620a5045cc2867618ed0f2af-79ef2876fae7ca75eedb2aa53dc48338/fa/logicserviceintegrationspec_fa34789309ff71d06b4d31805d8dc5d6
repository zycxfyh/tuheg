911d52fc4812077e213a33129c7e20a0
"use strict";
// 文件路径: apps/logic-agent/src/__tests__/logic.service.integration.spec.ts (真正完整版)
Object.defineProperty(exports, "__esModule", { value: true });
// 模拟 @tuheg/common-backend, 只替换 callAiWithGuard
jest.mock('@tuheg/common-backend', () => ({
    ...jest.requireActual('@tuheg/common-backend'), // 保留所有真实导出
    callAiWithGuard: jest.fn(), // 将 callAiWithGuard 替换为一个 Jest 模拟函数
}));
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const infrastructure_1 = require("@tuheg/infrastructure");
const jest_mock_extended_1 = require("jest-mock-extended");
const logic_service_1 = require("../logic.service");
const rule_engine_service_1 = require("../rule-engine.service");
// 测试子类，用于访问protected方法
class TestLogicService extends logic_service_1.LogicService {
    async testGenerateDirectives(jobData, user) {
        return this.generateDirectives(jobData, user);
    }
}
describe('LogicService (Integration)', () => {
    let service;
    let schedulerMock;
    let promptManagerMock;
    let promptInjectionGuardMock;
    let langfuseServiceMock;
    let ruleEngineMock;
    let eventBusMock;
    // 将模拟函数进行类型转换
    const mockedCallAiWithGuard = callAiWithGuard;
    const MOCK_CHAT_MODEL = {};
    // [核心修复] 为模拟数据补上 correlationId 字段
    const MOCK_JOB_DATA = {
        gameId: 'game-123',
        userId: 'user-abc',
        playerAction: { type: 'command', payload: 'Attack the goblin' },
        gameStateSnapshot: {
            id: 'game-123',
            name: 'Mock Game',
            ownerId: 'user-abc',
            createdAt: new Date(),
            updatedAt: new Date(),
            character: null,
            worldBook: [],
        },
        correlationId: 'test-correlation-id-integration-456', // <-- 加上这一行
    };
    const MOCK_DIRECTIVES = [
        { op: 'update_character', targetId: 'player', payload: {} },
    ];
    const SAFE_GUARD_RESULT = {
        allowed: true,
        score: 0.1,
        threshold: 0.75,
        reason: 'passed',
    };
    beforeEach(async () => {
        // 使用 jest-mock-extended 创建所有依赖的深度模拟对象
        schedulerMock = (0, jest_mock_extended_1.mock)();
        promptManagerMock = (0, jest_mock_extended_1.mock)();
        promptInjectionGuardMock = (0, jest_mock_extended_1.mock)();
        promptInjectionGuardMock.checkInput.mockResolvedValue(SAFE_GUARD_RESULT);
        promptInjectionGuardMock.ensureSafeOrThrow.mockResolvedValue(undefined);
        langfuseServiceMock = (0, jest_mock_extended_1.mock)();
        ruleEngineMock = (0, jest_mock_extended_1.mock)();
        eventBusMock = (0, jest_mock_extended_1.mock)();
        langfuseServiceMock.createTrace.mockResolvedValue({
            id: 'mock-trace-id',
            name: 'mock-trace',
            metadata: {},
        });
        langfuseServiceMock.createSpan.mockResolvedValue({
            id: 'mock-span-id',
            name: 'mock-span',
            traceId: 'mock-trace-id',
            startTime: new Date(),
            metadata: {},
        });
        langfuseServiceMock.logGeneration.mockResolvedValue(undefined);
        langfuseServiceMock.flush.mockResolvedValue(undefined);
        langfuseServiceMock.isEnabled.mockReturnValue(false);
        const module = await testing_1.Test.createTestingModule({
            providers: [
                TestLogicService,
                // 为所有依赖项提供我们的模拟实例
                { provide: infrastructure_1.DynamicAiSchedulerService, useValue: schedulerMock },
                { provide: PromptManagerService, useValue: promptManagerMock },
                { provide: LangfuseService, useValue: langfuseServiceMock },
                { provide: PromptInjectionGuard, useValue: promptInjectionGuardMock },
                { provide: rule_engine_service_1.RuleEngineService, useValue: ruleEngineMock },
                { provide: EventBusService, useValue: eventBusMock },
            ],
        }).compile();
        service = module.get(TestLogicService);
    });
    afterEach(() => {
        // 在每个测试后重置所有模拟
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('Happy Path: Successful Directive Generation', () => {
        beforeEach(() => {
            // 预设所有模拟依赖的行为
            schedulerMock.getProviderForRole.mockResolvedValue({
                model: MOCK_CHAT_MODEL,
            });
            promptManagerMock.getPrompt.mockReturnValue('This is a system prompt.');
            mockedCallAiWithGuard.mockResolvedValue(MOCK_DIRECTIVES);
        });
        it('should call dependencies with correct parameters and return directives', async () => {
            // 调用被测试的方法
            const mockUser = { id: MOCK_JOB_DATA.userId };
            const result = await service.testGenerateDirectives(MOCK_JOB_DATA, mockUser);
            // 验证交互和结果
            expect(promptInjectionGuardMock.checkInput).toHaveBeenCalledWith(JSON.stringify(MOCK_JOB_DATA.playerAction), {
                userId: MOCK_JOB_DATA.userId,
                correlationId: MOCK_JOB_DATA.correlationId,
            });
            expect(schedulerMock.getProviderForRole).toHaveBeenCalledTimes(1);
            expect(schedulerMock.getProviderForRole).toHaveBeenCalledWith({ id: MOCK_JOB_DATA.userId }, 'logic_parsing');
            expect(promptManagerMock.getPrompt).toHaveBeenCalledTimes(1);
            expect(promptManagerMock.getPrompt).toHaveBeenCalledWith('01_logic_engine.md');
            expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1);
            const aiGuardArgs = mockedCallAiWithGuard.mock.calls[0];
            const params = aiGuardArgs[1];
            expect(params.system_prompt).toBe('This is a system prompt.');
            expect(params.game_state).toBe(JSON.stringify(MOCK_JOB_DATA.gameStateSnapshot));
            expect(params.player_action).toBe(JSON.stringify(MOCK_JOB_DATA.playerAction));
            expect(result).toEqual(MOCK_DIRECTIVES);
        });
    });
    describe('Error Handling: AI Guard Failure', () => {
        it('should throw an InternalServerErrorException when callAiWithGuard fails', async () => {
            const aiError = new AiGenerationException('AI failed validation', {});
            schedulerMock.getProviderForRole.mockResolvedValue({
                model: MOCK_CHAT_MODEL,
            });
            promptManagerMock.getPrompt.mockReturnValue('prompt');
            mockedCallAiWithGuard.mockRejectedValue(aiError);
            const mockUser = { id: MOCK_JOB_DATA.userId };
            await expect(service.testGenerateDirectives(MOCK_JOB_DATA, mockUser)).rejects.toThrow(common_1.InternalServerErrorException);
        });
        it('should throw BadRequestException when prompt injection guard blocks input', async () => {
            promptInjectionGuardMock.checkInput.mockResolvedValueOnce({
                allowed: false,
                score: 0.99,
                threshold: 0.75,
                reason: 'threshold-exceeded',
            });
            const mockUser = { id: MOCK_JOB_DATA.userId };
            await expect(service.testGenerateDirectives(MOCK_JOB_DATA, mockUser)).rejects.toThrow(common_1.BadRequestException);
            expect(mockedCallAiWithGuard).not.toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcbG9naWMuc2VydmljZS5pbnRlZ3JhdGlvbi5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxpRkFBaUY7O0FBNEJqRixnREFBZ0Q7QUFDaEQsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFLFdBQVc7SUFDM0QsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFBRSxvQ0FBb0M7Q0FDakUsQ0FBQyxDQUFDLENBQUE7QUE3QkgsMkNBQWtGO0FBQ2xGLDZDQUEwRDtBQVcxRCwwREFBdUY7QUFFdkYsMkRBQXlEO0FBQ3pELG9EQUErQztBQUMvQyxnRUFBMEQ7QUFFMUQsdUJBQXVCO0FBQ3ZCLE1BQU0sZ0JBQWlCLFNBQVEsNEJBQVk7SUFDbEMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLE9BQTBCLEVBQUUsSUFBUztRQUN2RSxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDL0MsQ0FBQztDQUNGO0FBUUQsUUFBUSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtJQUMxQyxJQUFJLE9BQXlCLENBQUE7SUFDN0IsSUFBSSxhQUFtRCxDQUFBO0lBQ3ZELElBQUksaUJBQWtELENBQUE7SUFDdEQsSUFBSSx3QkFBeUQsQ0FBQTtJQUM3RCxJQUFJLG1CQUErQyxDQUFBO0lBQ25ELElBQUksY0FBNEMsQ0FBQTtJQUNoRCxJQUFJLFlBQXdDLENBQUE7SUFFNUMsY0FBYztJQUNkLE1BQU0scUJBQXFCLEdBQUcsZUFBNEIsQ0FBQTtJQUUxRCxNQUFNLGVBQWUsR0FBRyxFQUE4QixDQUFBO0lBQ3RELGtDQUFrQztJQUNsQyxNQUFNLGFBQWEsR0FBc0I7UUFDdkMsTUFBTSxFQUFFLFVBQVU7UUFD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Q0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtRQUN0RCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcbG9naWMuc2VydmljZS5pbnRlZ3JhdGlvbi5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogYXBwcy9sb2dpYy1hZ2VudC9zcmMvX190ZXN0c19fL2xvZ2ljLnNlcnZpY2UuaW50ZWdyYXRpb24uc3BlYy50cyAo55yf5q2j5a6M5pW054mIKVxuXG5pbXBvcnQgdHlwZSB7IEJhc2VDaGF0TW9kZWwgfSBmcm9tICdAbGFuZ2NoYWluL2NvcmUvbGFuZ3VhZ2VfbW9kZWxzL2NoYXRfbW9kZWxzJ1xuaW1wb3J0IHsgQmFkUmVxdWVzdEV4Y2VwdGlvbiwgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJ1xuaW1wb3J0IHsgVGVzdCwgdHlwZSBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJ1xuaW1wb3J0IHR5cGUgeyBVc2VyIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQgdHlwZSB7XG4gIEFpR2VuZXJhdGlvbkV4Y2VwdGlvbixcbiAgY2FsbEFpV2l0aEd1YXJkLFxuICBEaXJlY3RpdmVTZXQsXG4gIExhbmdmdXNlU2VydmljZSxcbiAgUHJvbXB0SW5qZWN0aW9uQ2hlY2tSZXN1bHQsXG4gIFByb21wdEluamVjdGlvbkd1YXJkLFxuICBQcm9tcHRNYW5hZ2VyU2VydmljZSxcbn0gZnJvbSAnQHR1aGVnL2FpLWRvbWFpbidcbmltcG9ydCB7IER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2UsIHR5cGUgRXZlbnRCdXNTZXJ2aWNlIH0gZnJvbSAnQHR1aGVnL2luZnJhc3RydWN0dXJlJ1xuaW1wb3J0IHR5cGUgeyBHYW1lQWN0aW9uSm9iRGF0YSB9IGZyb20gJ0B0dWhlZy9haS1kb21haW4nXG5pbXBvcnQgeyB0eXBlIE1vY2tQcm94eSwgbW9jayB9IGZyb20gJ2plc3QtbW9jay1leHRlbmRlZCdcbmltcG9ydCB7IExvZ2ljU2VydmljZSB9IGZyb20gJy4uL2xvZ2ljLnNlcnZpY2UnXG5pbXBvcnQgeyBSdWxlRW5naW5lU2VydmljZSB9IGZyb20gJy4uL3J1bGUtZW5naW5lLnNlcnZpY2UnXG5cbi8vIOa1i+ivleWtkOexu++8jOeUqOS6juiuv+mXrnByb3RlY3RlZOaWueazlVxuY2xhc3MgVGVzdExvZ2ljU2VydmljZSBleHRlbmRzIExvZ2ljU2VydmljZSB7XG4gIHB1YmxpYyBhc3luYyB0ZXN0R2VuZXJhdGVEaXJlY3RpdmVzKGpvYkRhdGE6IEdhbWVBY3Rpb25Kb2JEYXRhLCB1c2VyOiBhbnkpIHtcbiAgICByZXR1cm4gdGhpcy5nZW5lcmF0ZURpcmVjdGl2ZXMoam9iRGF0YSwgdXNlcilcbiAgfVxufVxuXG4vLyDmqKHmi58gQHR1aGVnL2NvbW1vbi1iYWNrZW5kLCDlj6rmm7/mjaIgY2FsbEFpV2l0aEd1YXJkXG5qZXN0Lm1vY2soJ0B0dWhlZy9jb21tb24tYmFja2VuZCcsICgpID0+ICh7XG4gIC4uLmplc3QucmVxdWlyZUFjdHVhbCgnQHR1aGVnL2NvbW1vbi1iYWNrZW5kJyksIC8vIOS/neeVmeaJgOacieecn+WunuWvvOWHulxuICBjYWxsQWlXaXRoR3VhcmQ6IGplc3QuZm4oKSwgLy8g5bCGIGNhbGxBaVdpdGhHdWFyZCDmm7/mjaLkuLrkuIDkuKogSmVzdCDmqKHmi5/lh73mlbBcbn0pKVxuXG5kZXNjcmliZSgnTG9naWNTZXJ2aWNlIChJbnRlZ3JhdGlvbiknLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBUZXN0TG9naWNTZXJ2aWNlXG4gIGxldCBzY2hlZHVsZXJNb2NrOiBNb2NrUHJveHk8RHluYW1pY0FpU2NoZWR1bGVyU2VydmljZT5cbiAgbGV0IHByb21wdE1hbmFnZXJNb2NrOiBNb2NrUHJveHk8UHJvbXB0TWFuYWdlclNlcnZpY2U+XG4gIGxldCBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2s6IE1vY2tQcm94eTxQcm9tcHRJbmplY3Rpb25HdWFyZD5cbiAgbGV0IGxhbmdmdXNlU2VydmljZU1vY2s6IE1vY2tQcm94eTxMYW5nZnVzZVNlcnZpY2U+XG4gIGxldCBydWxlRW5naW5lTW9jazogTW9ja1Byb3h5PFJ1bGVFbmdpbmVTZXJ2aWNlPlxuICBsZXQgZXZlbnRCdXNNb2NrOiBNb2NrUHJveHk8RXZlbnRCdXNTZXJ2aWNlPlxuXG4gIC8vIOWwhuaooeaLn+WHveaVsOi/m+ihjOexu+Wei+i9rOaNolxuICBjb25zdCBtb2NrZWRDYWxsQWlXaXRoR3VhcmQgPSBjYWxsQWlXaXRoR3VhcmQgYXMgamVzdC5Nb2NrXG5cbiAgY29uc3QgTU9DS19DSEFUX01PREVMID0ge30gYXMgdW5rbm93biBhcyBCYXNlQ2hhdE1vZGVsXG4gIC8vIFvmoLjlv4Pkv67lpI1dIOS4uuaooeaLn+aVsOaNruihpeS4iiBjb3JyZWxhdGlvbklkIOWtl+autVxuICBjb25zdCBNT0NLX0pPQl9EQVRBOiBHYW1lQWN0aW9uSm9iRGF0YSA9IHtcbiAgICBnYW1lSWQ6ICdnYW1lLTEyMycsXG4gICAgdXNlcklkOiAndXNlci1hYmMnLFxuICAgIHBsYXllckFjdGlvbjogeyB0eXBlOiAnY29tbWFuZCcsIHBheWxvYWQ6ICdBdHRhY2sgdGhlIGdvYmxpbicgfSxcbiAgICBnYW1lU3RhdGVTbmFwc2hvdDoge1xuICAgICAgaWQ6ICdnYW1lLTEyMycsXG4gICAgICBuYW1lOiAnTW9jayBHYW1lJyxcbiAgICAgIG93bmVySWQ6ICd1c2VyLWFiYycsXG4gICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICBjaGFyYWN0ZXI6IG51bGwsXG4gICAgICB3b3JsZEJvb2s6IFtdLFxuICAgIH0sXG4gICAgY29ycmVsYXRpb25JZDogJ3Rlc3QtY29ycmVsYXRpb24taWQtaW50ZWdyYXRpb24tNDU2JywgLy8gPC0tIOWKoOS4iui/meS4gOihjFxuICB9XG5cbiAgY29uc3QgTU9DS19ESVJFQ1RJVkVTOiBEaXJlY3RpdmVTZXQgPSBbXG4gICAgeyBvcDogJ3VwZGF0ZV9jaGFyYWN0ZXInLCB0YXJnZXRJZDogJ3BsYXllcicsIHBheWxvYWQ6IHt9IH0sXG4gIF1cblxuICBjb25zdCBTQUZFX0dVQVJEX1JFU1VMVDogUHJvbXB0SW5qZWN0aW9uQ2hlY2tSZXN1bHQgPSB7XG4gICAgYWxsb3dlZDogdHJ1ZSxcbiAgICBzY29yZTogMC4xLFxuICAgIHRocmVzaG9sZDogMC43NSxcbiAgICByZWFzb246ICdwYXNzZWQnLFxuICB9XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgLy8g5L2/55SoIGplc3QtbW9jay1leHRlbmRlZCDliJvlu7rmiYDmnInkvp3otZbnmoTmt7HluqbmqKHmi5/lr7nosaFcbiAgICBzY2hlZHVsZXJNb2NrID0gbW9jazxEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlPigpXG4gICAgcHJvbXB0TWFuYWdlck1vY2sgPSBtb2NrPFByb21wdE1hbmFnZXJTZXJ2aWNlPigpXG4gICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrID0gbW9jazxQcm9tcHRJbmplY3Rpb25HdWFyZD4oKVxuICAgIHByb21wdEluamVjdGlvbkd1YXJkTW9jay5jaGVja0lucHV0Lm1vY2tSZXNvbHZlZFZhbHVlKFNBRkVfR1VBUkRfUkVTVUxUKVxuICAgIHByb21wdEluamVjdGlvbkd1YXJkTW9jay5lbnN1cmVTYWZlT3JUaHJvdy5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpXG4gICAgbGFuZ2Z1c2VTZXJ2aWNlTW9jayA9IG1vY2s8TGFuZ2Z1c2VTZXJ2aWNlPigpXG4gICAgcnVsZUVuZ2luZU1vY2sgPSBtb2NrPFJ1bGVFbmdpbmVTZXJ2aWNlPigpXG4gICAgZXZlbnRCdXNNb2NrID0gbW9jazxFdmVudEJ1c1NlcnZpY2U+KClcbiAgICBsYW5nZnVzZVNlcnZpY2VNb2NrLmNyZWF0ZVRyYWNlLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIGlkOiAnbW9jay10cmFjZS1pZCcsXG4gICAgICBuYW1lOiAnbW9jay10cmFjZScsXG4gICAgICBtZXRhZGF0YToge30sXG4gICAgfSlcbiAgICBsYW5nZnVzZVNlcnZpY2VNb2NrLmNyZWF0ZVNwYW4ubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgaWQ6ICdtb2NrLXNwYW4taWQnLFxuICAgICAgbmFtZTogJ21vY2stc3BhbicsXG4gICAgICB0cmFjZUlkOiAnbW9jay10cmFjZS1pZCcsXG4gICAgICBzdGFydFRpbWU6IG5ldyBEYXRlKCksXG4gICAgICBtZXRhZGF0YToge30sXG4gICAgfSlcbiAgICBsYW5nZnVzZVNlcnZpY2VNb2NrLmxvZ0dlbmVyYXRpb24ubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKVxuICAgIGxhbmdmdXNlU2VydmljZU1vY2suZmx1c2gubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKVxuICAgIGxhbmdmdXNlU2VydmljZU1vY2suaXNFbmFibGVkLm1vY2tSZXR1cm5WYWx1ZShmYWxzZSlcblxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgVGVzdExvZ2ljU2VydmljZSxcbiAgICAgICAgLy8g5Li65omA5pyJ5L6d6LWW6aG55o+Q5L6b5oiR5Lus55qE5qih5ouf5a6e5L6LXG4gICAgICAgIHsgcHJvdmlkZTogRHluYW1pY0FpU2NoZWR1bGVyU2VydmljZSwgdXNlVmFsdWU6IHNjaGVkdWxlck1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQcm9tcHRNYW5hZ2VyU2VydmljZSwgdXNlVmFsdWU6IHByb21wdE1hbmFnZXJNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogTGFuZ2Z1c2VTZXJ2aWNlLCB1c2VWYWx1ZTogbGFuZ2Z1c2VTZXJ2aWNlTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IFByb21wdEluamVjdGlvbkd1YXJkLCB1c2VWYWx1ZTogcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogUnVsZUVuZ2luZVNlcnZpY2UsIHVzZVZhbHVlOiBydWxlRW5naW5lTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IEV2ZW50QnVzU2VydmljZSwgdXNlVmFsdWU6IGV2ZW50QnVzTW9jayB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKClcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PFRlc3RMb2dpY1NlcnZpY2U+KFRlc3RMb2dpY1NlcnZpY2UpXG4gIH0pXG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICAvLyDlnKjmr4/kuKrmtYvor5XlkI7ph43nva7miYDmnInmqKHmi59cbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKVxuICB9KVxuXG4gIGl0KCdzaG91bGQgYmUgZGVmaW5lZCcsICgpID0+IHtcbiAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKVxuICB9KVxuXG4gIGRlc2NyaWJlKCdIYXBweSBQYXRoOiBTdWNjZXNzZnVsIERpcmVjdGl2ZSBHZW5lcmF0aW9uJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgLy8g6aKE6K6+5omA5pyJ5qih5ouf5L6d6LWW55qE6KGM5Li6XG4gICAgICBzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIG1vZGVsOiBNT0NLX0NIQVRfTU9ERUwsXG4gICAgICB9KVxuICAgICAgcHJvbXB0TWFuYWdlck1vY2suZ2V0UHJvbXB0Lm1vY2tSZXR1cm5WYWx1ZSgnVGhpcyBpcyBhIHN5c3RlbSBwcm9tcHQuJylcbiAgICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0RJUkVDVElWRVMpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgY2FsbCBkZXBlbmRlbmNpZXMgd2l0aCBjb3JyZWN0IHBhcmFtZXRlcnMgYW5kIHJldHVybiBkaXJlY3RpdmVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8g6LCD55So6KKr5rWL6K+V55qE5pa55rOVXG4gICAgICBjb25zdCBtb2NrVXNlciA9IHsgaWQ6IE1PQ0tfSk9CX0RBVEEudXNlcklkIH0gYXMgYW55XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnRlc3RHZW5lcmF0ZURpcmVjdGl2ZXMoTU9DS19KT0JfREFUQSwgbW9ja1VzZXIpXG5cbiAgICAgIC8vIOmqjOivgeS6pOS6kuWSjOe7k+aenFxuICAgICAgZXhwZWN0KHByb21wdEluamVjdGlvbkd1YXJkTW9jay5jaGVja0lucHV0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkoTU9DS19KT0JfREFUQS5wbGF5ZXJBY3Rpb24pLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlcklkOiBNT0NLX0pPQl9EQVRBLnVzZXJJZCxcbiAgICAgICAgICBjb3JyZWxhdGlvbklkOiBNT0NLX0pPQl9EQVRBLmNvcnJlbGF0aW9uSWQsXG4gICAgICAgIH1cbiAgICAgIClcbiAgICAgIGV4cGVjdChzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpXG4gICAgICBleHBlY3Qoc2NoZWR1bGVyTW9jay5nZXRQcm92aWRlckZvclJvbGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICB7IGlkOiBNT0NLX0pPQl9EQVRBLnVzZXJJZCB9IGFzIFVzZXIsXG4gICAgICAgICdsb2dpY19wYXJzaW5nJ1xuICAgICAgKVxuXG4gICAgICBleHBlY3QocHJvbXB0TWFuYWdlck1vY2suZ2V0UHJvbXB0KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSlcbiAgICAgIGV4cGVjdChwcm9tcHRNYW5hZ2VyTW9jay5nZXRQcm9tcHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCcwMV9sb2dpY19lbmdpbmUubWQnKVxuXG4gICAgICBleHBlY3QobW9ja2VkQ2FsbEFpV2l0aEd1YXJkKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSlcblxuICAgICAgY29uc3QgYWlHdWFyZEFyZ3MgPSBtb2NrZWRDYWxsQWlXaXRoR3VhcmQubW9jay5jYWxsc1swXVxuICAgICAgY29uc3QgcGFyYW1zID0gYWlHdWFyZEFyZ3NbMV1cbiAgICAgIGV4cGVjdChwYXJhbXMuc3lzdGVtX3Byb21wdCkudG9CZSgnVGhpcyBpcyBhIHN5c3RlbSBwcm9tcHQuJylcbiAgICAgIGV4cGVjdChwYXJhbXMuZ2FtZV9zdGF0ZSkudG9CZShKU09OLnN0cmluZ2lmeShNT0NLX0pPQl9EQVRBLmdhbWVTdGF0ZVNuYXBzaG90KSlcbiAgICAgIGV4cGVjdChwYXJhbXMucGxheWVyX2FjdGlvbikudG9CZShKU09OLnN0cmluZ2lmeShNT0NLX0pPQl9EQVRBLnBsYXllckFjdGlvbikpXG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoTU9DS19ESVJFQ1RJVkVTKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ0Vycm9yIEhhbmRsaW5nOiBBSSBHdWFyZCBGYWlsdXJlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdGhyb3cgYW4gSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbiB3aGVuIGNhbGxBaVdpdGhHdWFyZCBmYWlscycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGFpRXJyb3IgPSBuZXcgQWlHZW5lcmF0aW9uRXhjZXB0aW9uKCdBSSBmYWlsZWQgdmFsaWRhdGlvbicsIHt9KVxuXG4gICAgICBzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIG1vZGVsOiBNT0NLX0NIQVRfTU9ERUwsXG4gICAgICB9KVxuICAgICAgcHJvbXB0TWFuYWdlck1vY2suZ2V0UHJvbXB0Lm1vY2tSZXR1cm5WYWx1ZSgncHJvbXB0JylcbiAgICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrUmVqZWN0ZWRWYWx1ZShhaUVycm9yKVxuXG4gICAgICBjb25zdCBtb2NrVXNlciA9IHsgaWQ6IE1PQ0tfSk9CX0RBVEEudXNlcklkIH0gYXMgYW55XG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS50ZXN0R2VuZXJhdGVEaXJlY3RpdmVzKE1PQ0tfSk9CX0RBVEEsIG1vY2tVc2VyKSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uXG4gICAgICApXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgQmFkUmVxdWVzdEV4Y2VwdGlvbiB3aGVuIHByb21wdCBpbmplY3Rpb24gZ3VhcmQgYmxvY2tzIGlucHV0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmNoZWNrSW5wdXQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgYWxsb3dlZDogZmFsc2UsXG4gICAgICAgIHNjb3JlOiAwLjk5LFxuICAgICAgICB0aHJlc2hvbGQ6IDAuNzUsXG4gICAgICAgIHJlYXNvbjogJ3RocmVzaG9sZC1leGNlZWRlZCcsXG4gICAgICB9KVxuXG4gICAgICBjb25zdCBtb2NrVXNlciA9IHsgaWQ6IE1PQ0tfSk9CX0RBVEEudXNlcklkIH0gYXMgYW55XG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS50ZXN0R2VuZXJhdGVEaXJlY3RpdmVzKE1PQ0tfSk9CX0RBVEEsIG1vY2tVc2VyKSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBCYWRSZXF1ZXN0RXhjZXB0aW9uXG4gICAgICApXG4gICAgICBleHBlY3QobW9ja2VkQ2FsbEFpV2l0aEd1YXJkKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgfSlcbiAgfSlcbn0pXG4iXSwidmVyc2lvbiI6M30=