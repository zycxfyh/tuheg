ec7d7311fc2c9a3782da6891fc022750
"use strict";
// 文件路径: apps/logic-agent/src/__tests__/rule-engine.service.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const common_backend_1 = require("@tuheg/common-backend");
const jest_mock_extended_1 = require("jest-mock-extended");
const rule_engine_service_1 = require("../rule-engine.service");
describe('RuleEngineService', () => {
    let service;
    let prismaMock;
    const MOCK_GAME_ID = 'test-game-id';
    const MOCK_CHARACTER = {
        id: 'char-id',
        gameId: MOCK_GAME_ID,
        name: 'Kael',
        hp: 100,
        maxHp: 100,
        mp: 50,
        maxMp: 50,
        status: 'Normal',
        card: {},
    };
    beforeEach(async () => {
        prismaMock = (0, jest_mock_extended_1.mockDeep)();
        // Ensure $transaction is properly mocked
        prismaMock.$transaction.mockImplementation(async (fn) => {
            return await fn(prismaMock);
        });
        const module = await testing_1.Test.createTestingModule({
            providers: [rule_engine_service_1.RuleEngineService, { provide: common_backend_1.PrismaService, useValue: prismaMock }],
        }).compile();
        service = module.get(rule_engine_service_1.RuleEngineService);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    it('should do nothing if directives array is empty', async () => {
        await service.execute(MOCK_GAME_ID, []);
        expect(prismaMock.$transaction).not.toHaveBeenCalled();
    });
    describe('Character Updates', () => {
        beforeEach(() => {
            prismaMock.character.findUniqueOrThrow.mockResolvedValue(MOCK_CHARACTER);
        });
        it('should correctly apply a single "decrement" hp directive', async () => {
            const directives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { hp: { op: 'decrement', value: 10 } },
                },
            ];
            await service.execute(MOCK_GAME_ID, directives);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: { hp: 90 },
            });
        });
        it('should correctly apply multiple directives in one transaction', async () => {
            const directives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: {
                        hp: { op: 'increment', value: 5 },
                        mp: { op: 'set', value: 42 },
                        status: { op: 'set', value: 'Energized' },
                    },
                },
            ];
            await service.execute(MOCK_GAME_ID, directives);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: {
                    hp: 105,
                    mp: 42,
                    status: 'Energized',
                },
            });
        });
        it('should handle string "append" and "prepend" operations', async () => {
            const initialCharacter = { ...MOCK_CHARACTER };
            prismaMock.character.findUniqueOrThrow.mockResolvedValue(initialCharacter);
            const prependDirective = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { status: { op: 'prepend', value: 'Slightly ' } },
                },
            ];
            await service.execute(MOCK_GAME_ID, prependDirective);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: { status: 'Slightly Normal' },
            });
            const appendedCharacter = {
                ...initialCharacter,
                status: 'Slightly Normal',
            };
            prismaMock.character.findUniqueOrThrow.mockResolvedValue(appendedCharacter);
            const appendDirective = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { status: { op: 'append', value: ' and Confused' } },
                },
            ];
            await service.execute(MOCK_GAME_ID, appendDirective);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: { status: 'Slightly Normal and Confused' },
            });
        });
    });
    describe('Error Handling', () => {
        it('should re-throw transaction failures as a RuleEngineExecutionException', async () => {
            const dbError = new Error('Database connection lost');
            prismaMock.$transaction.mockRejectedValue(dbError);
            const directives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { hp: { op: 'decrement', value: 10 } },
                },
            ];
            await expect(service.execute(MOCK_GAME_ID, directives)).rejects.toThrow('Rule engine transaction failed: Database connection lost');
        });
        it('should throw BadRequestException for an unknown operation', async () => {
            const directives = [
                {
                    op: 'unknown_operation', // 使用一个未知的操作
                    targetId: 'player',
                    payload: {},
                },
            ];
            await expect(service.execute(MOCK_GAME_ID, directives)).rejects.toThrow(common_1.BadRequestException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xccnVsZS1lbmdpbmUuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxtRUFBbUU7O0FBRW5FLDJDQUFvRDtBQUNwRCw2Q0FBMEQ7QUFFMUQsMERBQXdFO0FBQ3hFLDJEQUFpRTtBQUNqRSxnRUFBMEQ7QUFFMUQsUUFBUSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRTtJQUNqQyxJQUFJLE9BQTBCLENBQUE7SUFDOUIsSUFBSSxVQUF3QyxDQUFBO0lBRTVDLE1BQU0sWUFBWSxHQUFHLGNBQWMsQ0FBQTtJQUNuQyxNQUFNLGNBQWMsR0FBYztRQUNoQyxFQUFFLEVBQUUsU0FBUztRQUNiLE1BQU0sRUFBRSxZQUFZO1FBQ3BCLElBQUksRUFBRSxNQUFNO1FBQ1osRUFBRSxFQUFFLEdBQUc7UUFDUCxLQUFLLEVBQUUsR0FBRztRQUNWLEVBQUUsRUFBRSxFQUFFO1FBQ04sS0FBSyxFQUFFLEVBQUU7UUFDVCxNQUFNLEVBQUUsUUFBUTtRQUNoQixJQUFJLEVBQUUsRUFBdUI7S0FDOUIsQ0FBQTtJQUVELFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixVQUFVLEdBQUcsSUFBQSw2QkFBUSxHQUFpQixDQUFBO1FBRXRDLHlDQUF5QztRQUN6QyxVQUFVLENBQUMsWUFBWSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxFQUFPLEVBQUUsRUFBRTtZQUMzRCxPQUFPLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQzdCLENBQUMsQ0FBQyxDQUFBO1FBRUYsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRSxDQUFDLHVDQUFpQixFQUFFLEVBQUUsT0FBTyxFQUFFLDhCQUFhLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxDQUFDO1NBQ2pGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtRQUVa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Q0FBQyxDQUFBIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxhcHBzXFxsb2dpYy1hZ2VudFxcc3JjXFxfX3Rlc3RzX19cXHJ1bGUtZW5naW5lLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyDmlofku7bot6/lvoQ6IGFwcHMvbG9naWMtYWdlbnQvc3JjL19fdGVzdHNfXy9ydWxlLWVuZ2luZS5zZXJ2aWNlLnNwZWMudHNcblxuaW1wb3J0IHsgQmFkUmVxdWVzdEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJ1xuaW1wb3J0IHsgVGVzdCwgdHlwZSBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJ1xuaW1wb3J0IHR5cGUgeyBDaGFyYWN0ZXIsIFByaXNtYSwgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQgeyB0eXBlIERpcmVjdGl2ZVNldCwgUHJpc21hU2VydmljZSB9IGZyb20gJ0B0dWhlZy9jb21tb24tYmFja2VuZCdcbmltcG9ydCB7IHR5cGUgRGVlcE1vY2tQcm94eSwgbW9ja0RlZXAgfSBmcm9tICdqZXN0LW1vY2stZXh0ZW5kZWQnXG5pbXBvcnQgeyBSdWxlRW5naW5lU2VydmljZSB9IGZyb20gJy4uL3J1bGUtZW5naW5lLnNlcnZpY2UnXG5cbmRlc2NyaWJlKCdSdWxlRW5naW5lU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFJ1bGVFbmdpbmVTZXJ2aWNlXG4gIGxldCBwcmlzbWFNb2NrOiBEZWVwTW9ja1Byb3h5PFByaXNtYVNlcnZpY2U+XG5cbiAgY29uc3QgTU9DS19HQU1FX0lEID0gJ3Rlc3QtZ2FtZS1pZCdcbiAgY29uc3QgTU9DS19DSEFSQUNURVI6IENoYXJhY3RlciA9IHtcbiAgICBpZDogJ2NoYXItaWQnLFxuICAgIGdhbWVJZDogTU9DS19HQU1FX0lELFxuICAgIG5hbWU6ICdLYWVsJyxcbiAgICBocDogMTAwLFxuICAgIG1heEhwOiAxMDAsXG4gICAgbXA6IDUwLFxuICAgIG1heE1wOiA1MCxcbiAgICBzdGF0dXM6ICdOb3JtYWwnLFxuICAgIGNhcmQ6IHt9IGFzIFByaXNtYS5Kc29uT2JqZWN0LFxuICB9XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgcHJpc21hTW9jayA9IG1vY2tEZWVwPFByaXNtYVNlcnZpY2U+KClcblxuICAgIC8vIEVuc3VyZSAkdHJhbnNhY3Rpb24gaXMgcHJvcGVybHkgbW9ja2VkXG4gICAgcHJpc21hTW9jay4kdHJhbnNhY3Rpb24ubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChmbjogYW55KSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgZm4ocHJpc21hTW9jaylcbiAgICB9KVxuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1J1bGVFbmdpbmVTZXJ2aWNlLCB7IHByb3ZpZGU6IFByaXNtYVNlcnZpY2UsIHVzZVZhbHVlOiBwcmlzbWFNb2NrIH1dLFxuICAgIH0pLmNvbXBpbGUoKVxuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8UnVsZUVuZ2luZVNlcnZpY2U+KFJ1bGVFbmdpbmVTZXJ2aWNlKVxuICB9KVxuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKClcbiAgfSlcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVEZWZpbmVkKClcbiAgfSlcblxuICBpdCgnc2hvdWxkIGRvIG5vdGhpbmcgaWYgZGlyZWN0aXZlcyBhcnJheSBpcyBlbXB0eScsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGUoTU9DS19HQU1FX0lELCBbXSlcbiAgICBleHBlY3QocHJpc21hTW9jay4kdHJhbnNhY3Rpb24pLm5vdC50b0hhdmVCZWVuQ2FsbGVkKClcbiAgfSlcblxuICBkZXNjcmliZSgnQ2hhcmFjdGVyIFVwZGF0ZXMnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBwcmlzbWFNb2NrLmNoYXJhY3Rlci5maW5kVW5pcXVlT3JUaHJvdy5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0NIQVJBQ1RFUilcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgYXBwbHkgYSBzaW5nbGUgXCJkZWNyZW1lbnRcIiBocCBkaXJlY3RpdmUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkaXJlY3RpdmVzOiBEaXJlY3RpdmVTZXQgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBvcDogJ3VwZGF0ZV9jaGFyYWN0ZXInLFxuICAgICAgICAgIHRhcmdldElkOiAncGxheWVyJyxcbiAgICAgICAgICBwYXlsb2FkOiB7IGhwOiB7IG9wOiAnZGVjcmVtZW50JywgdmFsdWU6IDEwIH0gfSxcbiAgICAgICAgfSxcbiAgICAgIF1cbiAgICAgIGF3YWl0IHNlcnZpY2UuZXhlY3V0ZShNT0NLX0dBTUVfSUQsIGRpcmVjdGl2ZXMpXG4gICAgICBleHBlY3QocHJpc21hTW9jay5jaGFyYWN0ZXIudXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHdoZXJlOiB7IGdhbWVJZDogTU9DS19HQU1FX0lEIH0sXG4gICAgICAgIGRhdGE6IHsgaHA6IDkwIH0sXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIGNvcnJlY3RseSBhcHBseSBtdWx0aXBsZSBkaXJlY3RpdmVzIGluIG9uZSB0cmFuc2FjdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRpcmVjdGl2ZXM6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndXBkYXRlX2NoYXJhY3RlcicsXG4gICAgICAgICAgdGFyZ2V0SWQ6ICdwbGF5ZXInLFxuICAgICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICAgIGhwOiB7IG9wOiAnaW5jcmVtZW50JywgdmFsdWU6IDUgfSxcbiAgICAgICAgICAgIG1wOiB7IG9wOiAnc2V0JywgdmFsdWU6IDQyIH0sXG4gICAgICAgICAgICBzdGF0dXM6IHsgb3A6ICdzZXQnLCB2YWx1ZTogJ0VuZXJnaXplZCcgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXVxuICAgICAgYXdhaXQgc2VydmljZS5leGVjdXRlKE1PQ0tfR0FNRV9JRCwgZGlyZWN0aXZlcylcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLmNoYXJhY3Rlci51cGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgd2hlcmU6IHsgZ2FtZUlkOiBNT0NLX0dBTUVfSUQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGhwOiAxMDUsXG4gICAgICAgICAgbXA6IDQyLFxuICAgICAgICAgIHN0YXR1czogJ0VuZXJnaXplZCcsXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBzdHJpbmcgXCJhcHBlbmRcIiBhbmQgXCJwcmVwZW5kXCIgb3BlcmF0aW9ucycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGluaXRpYWxDaGFyYWN0ZXIgPSB7IC4uLk1PQ0tfQ0hBUkFDVEVSIH1cbiAgICAgIHByaXNtYU1vY2suY2hhcmFjdGVyLmZpbmRVbmlxdWVPclRocm93Lm1vY2tSZXNvbHZlZFZhbHVlKGluaXRpYWxDaGFyYWN0ZXIpXG5cbiAgICAgIGNvbnN0IHByZXBlbmREaXJlY3RpdmU6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndXBkYXRlX2NoYXJhY3RlcicsXG4gICAgICAgICAgdGFyZ2V0SWQ6ICdwbGF5ZXInLFxuICAgICAgICAgIHBheWxvYWQ6IHsgc3RhdHVzOiB7IG9wOiAncHJlcGVuZCcsIHZhbHVlOiAnU2xpZ2h0bHkgJyB9IH0sXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgICBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGUoTU9DS19HQU1FX0lELCBwcmVwZW5kRGlyZWN0aXZlKVxuICAgICAgZXhwZWN0KHByaXNtYU1vY2suY2hhcmFjdGVyLnVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICB3aGVyZTogeyBnYW1lSWQ6IE1PQ0tfR0FNRV9JRCB9LFxuICAgICAgICBkYXRhOiB7IHN0YXR1czogJ1NsaWdodGx5IE5vcm1hbCcgfSxcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IGFwcGVuZGVkQ2hhcmFjdGVyID0ge1xuICAgICAgICAuLi5pbml0aWFsQ2hhcmFjdGVyLFxuICAgICAgICBzdGF0dXM6ICdTbGlnaHRseSBOb3JtYWwnLFxuICAgICAgfVxuICAgICAgcHJpc21hTW9jay5jaGFyYWN0ZXIuZmluZFVuaXF1ZU9yVGhyb3cubW9ja1Jlc29sdmVkVmFsdWUoYXBwZW5kZWRDaGFyYWN0ZXIpXG5cbiAgICAgIGNvbnN0IGFwcGVuZERpcmVjdGl2ZTogRGlyZWN0aXZlU2V0ID0gW1xuICAgICAgICB7XG4gICAgICAgICAgb3A6ICd1cGRhdGVfY2hhcmFjdGVyJyxcbiAgICAgICAgICB0YXJnZXRJZDogJ3BsYXllcicsXG4gICAgICAgICAgcGF5bG9hZDogeyBzdGF0dXM6IHsgb3A6ICdhcHBlbmQnLCB2YWx1ZTogJyBhbmQgQ29uZnVzZWQnIH0gfSxcbiAgICAgICAgfSxcbiAgICAgIF1cbiAgICAgIGF3YWl0IHNlcnZpY2UuZXhlY3V0ZShNT0NLX0dBTUVfSUQsIGFwcGVuZERpcmVjdGl2ZSlcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLmNoYXJhY3Rlci51cGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgd2hlcmU6IHsgZ2FtZUlkOiBNT0NLX0dBTUVfSUQgfSxcbiAgICAgICAgZGF0YTogeyBzdGF0dXM6ICdTbGlnaHRseSBOb3JtYWwgYW5kIENvbmZ1c2VkJyB9LFxuICAgICAgfSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdFcnJvciBIYW5kbGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJlLXRocm93IHRyYW5zYWN0aW9uIGZhaWx1cmVzIGFzIGEgUnVsZUVuZ2luZUV4ZWN1dGlvbkV4Y2VwdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRiRXJyb3IgPSBuZXcgRXJyb3IoJ0RhdGFiYXNlIGNvbm5lY3Rpb24gbG9zdCcpXG4gICAgICBwcmlzbWFNb2NrLiR0cmFuc2FjdGlvbi5tb2NrUmVqZWN0ZWRWYWx1ZShkYkVycm9yKVxuICAgICAgY29uc3QgZGlyZWN0aXZlczogRGlyZWN0aXZlU2V0ID0gW1xuICAgICAgICB7XG4gICAgICAgICAgb3A6ICd1cGRhdGVfY2hhcmFjdGVyJyxcbiAgICAgICAgICB0YXJnZXRJZDogJ3BsYXllcicsXG4gICAgICAgICAgcGF5bG9hZDogeyBocDogeyBvcDogJ2RlY3JlbWVudCcsIHZhbHVlOiAxMCB9IH0sXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5leGVjdXRlKE1PQ0tfR0FNRV9JRCwgZGlyZWN0aXZlcykpLnJlamVjdHMudG9UaHJvdyhcbiAgICAgICAgJ1J1bGUgZW5naW5lIHRyYW5zYWN0aW9uIGZhaWxlZDogRGF0YWJhc2UgY29ubmVjdGlvbiBsb3N0J1xuICAgICAgKVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIHRocm93IEJhZFJlcXVlc3RFeGNlcHRpb24gZm9yIGFuIHVua25vd24gb3BlcmF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZGlyZWN0aXZlczogRGlyZWN0aXZlU2V0ID0gW1xuICAgICAgICB7XG4gICAgICAgICAgb3A6ICd1bmtub3duX29wZXJhdGlvbicsIC8vIOS9v+eUqOS4gOS4quacquefpeeahOaTjeS9nFxuICAgICAgICAgIHRhcmdldElkOiAncGxheWVyJyxcbiAgICAgICAgICBwYXlsb2FkOiB7fSxcbiAgICAgICAgfSBhcyBhbnksIC8vIFR5cGUgYXNzZXJ0aW9uIHRvIGJ5cGFzcyB0eXBlIGNoZWNraW5nXG4gICAgICBdXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5leGVjdXRlKE1PQ0tfR0FNRV9JRCwgZGlyZWN0aXZlcykpLnJlamVjdHMudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKVxuICAgIH0pXG4gIH0pXG59KVxuIl0sInZlcnNpb24iOjN9