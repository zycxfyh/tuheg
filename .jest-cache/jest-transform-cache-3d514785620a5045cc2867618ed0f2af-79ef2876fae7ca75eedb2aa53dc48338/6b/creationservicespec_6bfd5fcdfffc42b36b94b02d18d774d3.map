{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\creation-agent\\src\\__tests__\\creation.service.spec.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\creation-agent\\src\\__tests__\\creation.service.spec.ts"],"sourcesContent":["// 文件路径: apps/creation-agent/src/__tests__/creation.service.spec.ts\n// 描述: CreationService 的单元测试，专注于世界生成逻辑和数据库交互\n\nimport { InternalServerErrorException } from '@nestjs/common'\nimport { Test, type TestingModule } from '@nestjs/testing'\nimport type { Game, PrismaClient } from '@prisma/client'\nimport {\n  AiGenerationException,\n  type AiProvider,\n  callAiWithGuard,\n  PromptInjectionDetectedException,\n  PromptInjectionGuard,\n  PromptManagerService,\n} from '@tuheg/ai-domain'\nimport { DynamicAiSchedulerService, type EventBusService, type PrismaService } from '@tuheg/infrastructure'\nimport { type DeepMockProxy, mockDeep } from 'jest-mock-extended'\nimport { CreationService } from '../creation.service'\n\njest.mock('@tuheg/ai-domain', () => ({\n  ...jest.requireActual('@tuheg/ai-domain'),\n  callAiWithGuard: jest.fn(),\n}))\n\ndescribe('CreationService', () => {\n  let service: CreationService\n  let prismaMock: DeepMockProxy<PrismaClient>\n  let schedulerMock: DeepMockProxy<DynamicAiSchedulerService>\n  let promptManagerMock: DeepMockProxy<PromptManagerService>\n  let eventBusMock: DeepMockProxy<EventBusService>\n  let promptInjectionGuardMock: DeepMockProxy<PromptInjectionGuard>\n  const mockedCallAiWithGuard = callAiWithGuard as jest.Mock\n\n  // Mock AI Provider following actual AiProvider interface\n  const MOCK_AI_PROVIDER: AiProvider = {\n    name: 'test-model',\n    provider: 'OpenAI',\n    generate: jest.fn().mockResolvedValue('mocked AI response'),\n  }\n\n  const MOCK_PAYLOAD = {\n    userId: 'user-123',\n    concept: 'A cyberpunk city ruled by sentient cats.',\n  }\n\n  const MOCK_AI_RESPONSE = {\n    gameName: 'Neko-Kyoto Prime',\n    character: {\n      name: 'Jax',\n      card: {\n        coreIdentity: 'A rogue street samurai cat',\n        personality: ['cynical', 'agile'],\n        appearance: 'A sleek black cat with a robotic eye.',\n      },\n    },\n    worldBook: [{ key: 'Neko-Kyoto', content: { description: 'The main city.' } }],\n  }\n\n  beforeEach(async () => {\n    prismaMock = mockDeep<PrismaClient>()\n    schedulerMock = mockDeep<DynamicAiSchedulerService>()\n    promptManagerMock = mockDeep<PromptManagerService>()\n    eventBusMock = mockDeep<EventBusService>()\n    promptInjectionGuardMock = mockDeep<PromptInjectionGuard>()\n    promptInjectionGuardMock.ensureSafeOrThrow.mockResolvedValue(undefined)\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        CreationService,\n        { provide: PrismaService, useValue: prismaMock },\n        { provide: DynamicAiSchedulerService, useValue: schedulerMock },\n        { provide: PromptManagerService, useValue: promptManagerMock },\n        { provide: EventBusService, useValue: eventBusMock },\n        { provide: PromptInjectionGuard, useValue: promptInjectionGuardMock },\n      ],\n    }).compile()\n\n    service = module.get<CreationService>(CreationService)\n\n    // Mock $transaction to execute the callback immediately\n    prismaMock.$transaction.mockImplementation((callback: unknown) => {\n      if (typeof callback === 'function') {\n        return callback(prismaMock)\n      }\n      return Promise.resolve([])\n    })\n  })\n\n  afterEach(() => {\n    jest.clearAllMocks()\n  })\n\n  it('should be defined', () => {\n    expect(service).toBeDefined()\n  })\n\n  describe('Happy Path', () => {\n    it('should create a new world, save it, and publish completion event', async () => {\n      schedulerMock.getProviderForRole.mockResolvedValue(MOCK_AI_PROVIDER)\n      promptManagerMock.getPrompt.mockReturnValue('persona prompt')\n      mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE)\n      const mockGame: Game = {\n        id: 'game-456',\n        name: MOCK_AI_RESPONSE.gameName,\n        ownerId: MOCK_PAYLOAD.userId,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      }\n      prismaMock.game.create.mockResolvedValue(mockGame)\n\n      await service.createNewWorld(MOCK_PAYLOAD)\n\n      expect(promptInjectionGuardMock.ensureSafeOrThrow).toHaveBeenCalledWith(\n        MOCK_PAYLOAD.concept,\n        {\n          userId: MOCK_PAYLOAD.userId,\n        }\n      )\n      expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1)\n      expect(prismaMock.$transaction).toHaveBeenCalledTimes(1)\n      expect(prismaMock.game.create).toHaveBeenCalled()\n      expect(prismaMock.character.create).toHaveBeenCalled()\n      expect(prismaMock.worldBookEntry.createMany).toHaveBeenCalled()\n      expect(eventBusMock.publish).toHaveBeenCalledWith(\n        'NOTIFY_USER',\n        expect.objectContaining({\n          event: 'creation_completed',\n        })\n      )\n    })\n  })\n\n  describe('Error Handling', () => {\n    it('should throw and publish failure event if AI generation fails', async () => {\n      const aiError = new AiGenerationException('AI failed')\n      schedulerMock.getProviderForRole.mockResolvedValue(MOCK_AI_PROVIDER)\n      promptManagerMock.getPrompt.mockReturnValue('persona prompt')\n      mockedCallAiWithGuard.mockRejectedValue(aiError)\n\n      try {\n        await service.createNewWorld(MOCK_PAYLOAD)\n        fail('Expected createNewWorld to throw')\n      } catch (error) {\n        expect(error).toBeInstanceOf(InternalServerErrorException)\n      }\n\n      expect(prismaMock.$transaction).not.toHaveBeenCalled()\n      expect(eventBusMock.publish).toHaveBeenCalledWith(\n        'NOTIFY_USER',\n        expect.objectContaining({\n          event: 'creation_failed',\n          userId: MOCK_PAYLOAD.userId,\n        })\n      )\n    })\n\n    it('should throw and publish failure event if database transaction fails', async () => {\n      const dbError = new Error('DB connection lost')\n      schedulerMock.getProviderForRole.mockResolvedValue(MOCK_AI_PROVIDER)\n      promptManagerMock.getPrompt.mockReturnValue('persona prompt')\n      mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE)\n      prismaMock.$transaction.mockRejectedValue(dbError)\n\n      try {\n        await service.createNewWorld(MOCK_PAYLOAD)\n        fail('Expected createNewWorld to throw')\n      } catch (error) {\n        expect(error).toBe(dbError)\n      }\n\n      expect(eventBusMock.publish).toHaveBeenCalledWith(\n        'NOTIFY_USER',\n        expect.objectContaining({\n          event: 'creation_failed',\n          userId: MOCK_PAYLOAD.userId,\n        })\n      )\n    })\n\n    it('should propagate prompt injection errors before invoking AI', async () => {\n      const guardError = new PromptInjectionDetectedException('blocked', {\n        score: 0.95,\n        threshold: 0.75,\n      })\n      promptInjectionGuardMock.ensureSafeOrThrow.mockRejectedValueOnce(guardError)\n\n      try {\n        await service.createNewWorld(MOCK_PAYLOAD)\n        fail('Expected createNewWorld to throw')\n      } catch (error) {\n        expect(error).toBeInstanceOf(PromptInjectionDetectedException)\n      }\n\n      expect(mockedCallAiWithGuard).not.toHaveBeenCalled()\n      expect(prismaMock.$transaction).not.toHaveBeenCalled()\n      expect(eventBusMock.publish).toHaveBeenCalledWith(\n        'NOTIFY_USER',\n        expect.objectContaining({\n          event: 'creation_failed',\n          userId: MOCK_PAYLOAD.userId,\n        })\n      )\n    })\n  })\n})\n"],"version":3}