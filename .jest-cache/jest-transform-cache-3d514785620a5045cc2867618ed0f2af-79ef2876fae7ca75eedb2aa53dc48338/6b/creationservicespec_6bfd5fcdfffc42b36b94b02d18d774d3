6ccaa8c995ec9d1c9164af13c44cbe6b
"use strict";
// 文件路径: apps/creation-agent/src/__tests__/creation.service.spec.ts
// 描述: CreationService 的单元测试，专注于世界生成逻辑和数据库交互
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('@tuheg/ai-domain', () => ({
    ...jest.requireActual('@tuheg/ai-domain'),
    callAiWithGuard: jest.fn(),
}));
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const ai_domain_1 = require("@tuheg/ai-domain");
const infrastructure_1 = require("@tuheg/infrastructure");
const jest_mock_extended_1 = require("jest-mock-extended");
const creation_service_1 = require("../creation.service");
describe('CreationService', () => {
    let service;
    let prismaMock;
    let schedulerMock;
    let promptManagerMock;
    let eventBusMock;
    let promptInjectionGuardMock;
    const mockedCallAiWithGuard = ai_domain_1.callAiWithGuard;
    // Mock AI Provider following actual AiProvider interface
    const MOCK_AI_PROVIDER = {
        name: 'test-model',
        provider: 'OpenAI',
        generate: jest.fn().mockResolvedValue('mocked AI response'),
    };
    const MOCK_PAYLOAD = {
        userId: 'user-123',
        concept: 'A cyberpunk city ruled by sentient cats.',
    };
    const MOCK_AI_RESPONSE = {
        gameName: 'Neko-Kyoto Prime',
        character: {
            name: 'Jax',
            card: {
                coreIdentity: 'A rogue street samurai cat',
                personality: ['cynical', 'agile'],
                appearance: 'A sleek black cat with a robotic eye.',
            },
        },
        worldBook: [{ key: 'Neko-Kyoto', content: { description: 'The main city.' } }],
    };
    beforeEach(async () => {
        prismaMock = (0, jest_mock_extended_1.mockDeep)();
        schedulerMock = (0, jest_mock_extended_1.mockDeep)();
        promptManagerMock = (0, jest_mock_extended_1.mockDeep)();
        eventBusMock = (0, jest_mock_extended_1.mockDeep)();
        promptInjectionGuardMock = (0, jest_mock_extended_1.mockDeep)();
        promptInjectionGuardMock.ensureSafeOrThrow.mockResolvedValue(undefined);
        const module = await testing_1.Test.createTestingModule({
            providers: [
                creation_service_1.CreationService,
                { provide: PrismaService, useValue: prismaMock },
                { provide: infrastructure_1.DynamicAiSchedulerService, useValue: schedulerMock },
                { provide: ai_domain_1.PromptManagerService, useValue: promptManagerMock },
                { provide: EventBusService, useValue: eventBusMock },
                { provide: ai_domain_1.PromptInjectionGuard, useValue: promptInjectionGuardMock },
            ],
        }).compile();
        service = module.get(creation_service_1.CreationService);
        // Mock $transaction to execute the callback immediately
        prismaMock.$transaction.mockImplementation((callback) => {
            if (typeof callback === 'function') {
                return callback(prismaMock);
            }
            return Promise.resolve([]);
        });
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('Happy Path', () => {
        it('should create a new world, save it, and publish completion event', async () => {
            schedulerMock.getProviderForRole.mockResolvedValue(MOCK_AI_PROVIDER);
            promptManagerMock.getPrompt.mockReturnValue('persona prompt');
            mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE);
            const mockGame = {
                id: 'game-456',
                name: MOCK_AI_RESPONSE.gameName,
                ownerId: MOCK_PAYLOAD.userId,
                createdAt: new Date(),
                updatedAt: new Date(),
            };
            prismaMock.game.create.mockResolvedValue(mockGame);
            await service.createNewWorld(MOCK_PAYLOAD);
            expect(promptInjectionGuardMock.ensureSafeOrThrow).toHaveBeenCalledWith(MOCK_PAYLOAD.concept, {
                userId: MOCK_PAYLOAD.userId,
            });
            expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1);
            expect(prismaMock.$transaction).toHaveBeenCalledTimes(1);
            expect(prismaMock.game.create).toHaveBeenCalled();
            expect(prismaMock.character.create).toHaveBeenCalled();
            expect(prismaMock.worldBookEntry.createMany).toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_completed',
            }));
        });
    });
    describe('Error Handling', () => {
        it('should throw and publish failure event if AI generation fails', async () => {
            const aiError = new ai_domain_1.AiGenerationException('AI failed');
            schedulerMock.getProviderForRole.mockResolvedValue(MOCK_AI_PROVIDER);
            promptManagerMock.getPrompt.mockReturnValue('persona prompt');
            mockedCallAiWithGuard.mockRejectedValue(aiError);
            try {
                await service.createNewWorld(MOCK_PAYLOAD);
                fail('Expected createNewWorld to throw');
            }
            catch (error) {
                expect(error).toBeInstanceOf(common_1.InternalServerErrorException);
            }
            expect(prismaMock.$transaction).not.toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_failed',
                userId: MOCK_PAYLOAD.userId,
            }));
        });
        it('should throw and publish failure event if database transaction fails', async () => {
            const dbError = new Error('DB connection lost');
            schedulerMock.getProviderForRole.mockResolvedValue(MOCK_AI_PROVIDER);
            promptManagerMock.getPrompt.mockReturnValue('persona prompt');
            mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE);
            prismaMock.$transaction.mockRejectedValue(dbError);
            try {
                await service.createNewWorld(MOCK_PAYLOAD);
                fail('Expected createNewWorld to throw');
            }
            catch (error) {
                expect(error).toBe(dbError);
            }
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_failed',
                userId: MOCK_PAYLOAD.userId,
            }));
        });
        it('should propagate prompt injection errors before invoking AI', async () => {
            const guardError = new ai_domain_1.PromptInjectionDetectedException('blocked', {
                score: 0.95,
                threshold: 0.75,
            });
            promptInjectionGuardMock.ensureSafeOrThrow.mockRejectedValueOnce(guardError);
            try {
                await service.createNewWorld(MOCK_PAYLOAD);
                fail('Expected createNewWorld to throw');
            }
            catch (error) {
                expect(error).toBeInstanceOf(ai_domain_1.PromptInjectionDetectedException);
            }
            expect(mockedCallAiWithGuard).not.toHaveBeenCalled();
            expect(prismaMock.$transaction).not.toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_failed',
                userId: MOCK_PAYLOAD.userId,
            }));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGNyZWF0aW9uLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcY3JlYXRpb24uc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxtRUFBbUU7QUFDbkUsNENBQTRDOztBQWlCNUMsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ25DLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQztJQUN6QyxlQUFlLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUMzQixDQUFDLENBQUMsQ0FBQTtBQWxCSCwyQ0FBNkQ7QUFDN0QsNkNBQTBEO0FBRTFELGdEQU95QjtBQUN6QiwwREFBMkc7QUFDM0csMkRBQWlFO0FBQ2pFLDBEQUFxRDtBQU9yRCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksT0FBd0IsQ0FBQTtJQUM1QixJQUFJLFVBQXVDLENBQUE7SUFDM0MsSUFBSSxhQUF1RCxDQUFBO0lBQzNELElBQUksaUJBQXNELENBQUE7SUFDMUQsSUFBSSxZQUE0QyxDQUFBO0lBQ2hELElBQUksd0JBQTZELENBQUE7SUFDakUsTUFBTSxxQkFBcUIsR0FBRywyQkFBNEIsQ0FBQTtJQUUxRCx5REFBeUQ7SUFDekQsTUFBTSxnQkFBZ0IsR0FBZTtRQUNuQyxJQUFJLEVBQUUsWUFBWTtRQUNsQixRQUFRLEVBQUUsUUFBUTtRQUNsQixRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixDQUFDO0tBQzVELENBQUE7SUFFRCxNQUFNLFlBQVksR0FBRztRQUNuQixNQUFNLEVBQUUsVUFBVTtRQUNsQixPQUFPLEVBQUUsMENBQTBDO0tBQ3BELENBQUE7SUFFRCxNQUFNLGdCQUFnQixHQUFHO1FBQ3ZCLFFBQVEsRUFBRSxrQkFBa0I7UUFDNUIsU0FBUyxFQUFFO1lBQ1QsSUFBSSxFQUFFLEtBQUs7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QUFDLE9BQU8sQ0FBQyxDQUFDLG9CQUFvQixDQUMvQyxhQUFhLEVBQ2IsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixLQUFLLEVBQUUsaUJBQWlCO2dCQUN4QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07YUFDNUIsQ0FBQyxDQUNILENBQUE7UUFDSCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGNyZWF0aW9uLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcY3JlYXRpb24uc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogYXBwcy9jcmVhdGlvbi1hZ2VudC9zcmMvX190ZXN0c19fL2NyZWF0aW9uLnNlcnZpY2Uuc3BlYy50c1xuLy8g5o+P6L+wOiBDcmVhdGlvblNlcnZpY2Ug55qE5Y2V5YWD5rWL6K+V77yM5LiT5rOo5LqO5LiW55WM55Sf5oiQ6YC76L6R5ZKM5pWw5o2u5bqT5Lqk5LqSXG5cbmltcG9ydCB7IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbidcbmltcG9ydCB7IFRlc3QsIHR5cGUgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZydcbmltcG9ydCB0eXBlIHsgR2FtZSwgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQge1xuICBBaUdlbmVyYXRpb25FeGNlcHRpb24sXG4gIHR5cGUgQWlQcm92aWRlcixcbiAgY2FsbEFpV2l0aEd1YXJkLFxuICBQcm9tcHRJbmplY3Rpb25EZXRlY3RlZEV4Y2VwdGlvbixcbiAgUHJvbXB0SW5qZWN0aW9uR3VhcmQsXG4gIFByb21wdE1hbmFnZXJTZXJ2aWNlLFxufSBmcm9tICdAdHVoZWcvYWktZG9tYWluJ1xuaW1wb3J0IHsgRHluYW1pY0FpU2NoZWR1bGVyU2VydmljZSwgdHlwZSBFdmVudEJ1c1NlcnZpY2UsIHR5cGUgUHJpc21hU2VydmljZSB9IGZyb20gJ0B0dWhlZy9pbmZyYXN0cnVjdHVyZSdcbmltcG9ydCB7IHR5cGUgRGVlcE1vY2tQcm94eSwgbW9ja0RlZXAgfSBmcm9tICdqZXN0LW1vY2stZXh0ZW5kZWQnXG5pbXBvcnQgeyBDcmVhdGlvblNlcnZpY2UgfSBmcm9tICcuLi9jcmVhdGlvbi5zZXJ2aWNlJ1xuXG5qZXN0Lm1vY2soJ0B0dWhlZy9haS1kb21haW4nLCAoKSA9PiAoe1xuICAuLi5qZXN0LnJlcXVpcmVBY3R1YWwoJ0B0dWhlZy9haS1kb21haW4nKSxcbiAgY2FsbEFpV2l0aEd1YXJkOiBqZXN0LmZuKCksXG59KSlcblxuZGVzY3JpYmUoJ0NyZWF0aW9uU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IENyZWF0aW9uU2VydmljZVxuICBsZXQgcHJpc21hTW9jazogRGVlcE1vY2tQcm94eTxQcmlzbWFDbGllbnQ+XG4gIGxldCBzY2hlZHVsZXJNb2NrOiBEZWVwTW9ja1Byb3h5PER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2U+XG4gIGxldCBwcm9tcHRNYW5hZ2VyTW9jazogRGVlcE1vY2tQcm94eTxQcm9tcHRNYW5hZ2VyU2VydmljZT5cbiAgbGV0IGV2ZW50QnVzTW9jazogRGVlcE1vY2tQcm94eTxFdmVudEJ1c1NlcnZpY2U+XG4gIGxldCBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2s6IERlZXBNb2NrUHJveHk8UHJvbXB0SW5qZWN0aW9uR3VhcmQ+XG4gIGNvbnN0IG1vY2tlZENhbGxBaVdpdGhHdWFyZCA9IGNhbGxBaVdpdGhHdWFyZCBhcyBqZXN0Lk1vY2tcblxuICAvLyBNb2NrIEFJIFByb3ZpZGVyIGZvbGxvd2luZyBhY3R1YWwgQWlQcm92aWRlciBpbnRlcmZhY2VcbiAgY29uc3QgTU9DS19BSV9QUk9WSURFUjogQWlQcm92aWRlciA9IHtcbiAgICBuYW1lOiAndGVzdC1tb2RlbCcsXG4gICAgcHJvdmlkZXI6ICdPcGVuQUknLFxuICAgIGdlbmVyYXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoJ21vY2tlZCBBSSByZXNwb25zZScpLFxuICB9XG5cbiAgY29uc3QgTU9DS19QQVlMT0FEID0ge1xuICAgIHVzZXJJZDogJ3VzZXItMTIzJyxcbiAgICBjb25jZXB0OiAnQSBjeWJlcnB1bmsgY2l0eSBydWxlZCBieSBzZW50aWVudCBjYXRzLicsXG4gIH1cblxuICBjb25zdCBNT0NLX0FJX1JFU1BPTlNFID0ge1xuICAgIGdhbWVOYW1lOiAnTmVrby1LeW90byBQcmltZScsXG4gICAgY2hhcmFjdGVyOiB7XG4gICAgICBuYW1lOiAnSmF4JyxcbiAgICAgIGNhcmQ6IHtcbiAgICAgICAgY29yZUlkZW50aXR5OiAnQSByb2d1ZSBzdHJlZXQgc2FtdXJhaSBjYXQnLFxuICAgICAgICBwZXJzb25hbGl0eTogWydjeW5pY2FsJywgJ2FnaWxlJ10sXG4gICAgICAgIGFwcGVhcmFuY2U6ICdBIHNsZWVrIGJsYWNrIGNhdCB3aXRoIGEgcm9ib3RpYyBleWUuJyxcbiAgICAgIH0sXG4gICAgfSxcbiAgICB3b3JsZEJvb2s6IFt7IGtleTogJ05la28tS3lvdG8nLCBjb250ZW50OiB7IGRlc2NyaXB0aW9uOiAnVGhlIG1haW4gY2l0eS4nIH0gfV0sXG4gIH1cblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBwcmlzbWFNb2NrID0gbW9ja0RlZXA8UHJpc21hQ2xpZW50PigpXG4gICAgc2NoZWR1bGVyTW9jayA9IG1vY2tEZWVwPER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2U+KClcbiAgICBwcm9tcHRNYW5hZ2VyTW9jayA9IG1vY2tEZWVwPFByb21wdE1hbmFnZXJTZXJ2aWNlPigpXG4gICAgZXZlbnRCdXNNb2NrID0gbW9ja0RlZXA8RXZlbnRCdXNTZXJ2aWNlPigpXG4gICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrID0gbW9ja0RlZXA8UHJvbXB0SW5qZWN0aW9uR3VhcmQ+KClcbiAgICBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2suZW5zdXJlU2FmZU9yVGhyb3cubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKVxuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBDcmVhdGlvblNlcnZpY2UsXG4gICAgICAgIHsgcHJvdmlkZTogUHJpc21hU2VydmljZSwgdXNlVmFsdWU6IHByaXNtYU1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlLCB1c2VWYWx1ZTogc2NoZWR1bGVyTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IFByb21wdE1hbmFnZXJTZXJ2aWNlLCB1c2VWYWx1ZTogcHJvbXB0TWFuYWdlck1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBFdmVudEJ1c1NlcnZpY2UsIHVzZVZhbHVlOiBldmVudEJ1c01vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQcm9tcHRJbmplY3Rpb25HdWFyZCwgdXNlVmFsdWU6IHByb21wdEluamVjdGlvbkd1YXJkTW9jayB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKClcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PENyZWF0aW9uU2VydmljZT4oQ3JlYXRpb25TZXJ2aWNlKVxuXG4gICAgLy8gTW9jayAkdHJhbnNhY3Rpb24gdG8gZXhlY3V0ZSB0aGUgY2FsbGJhY2sgaW1tZWRpYXRlbHlcbiAgICBwcmlzbWFNb2NrLiR0cmFuc2FjdGlvbi5tb2NrSW1wbGVtZW50YXRpb24oKGNhbGxiYWNrOiB1bmtub3duKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhwcmlzbWFNb2NrKVxuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSlcbiAgICB9KVxuICB9KVxuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKClcbiAgfSlcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVEZWZpbmVkKClcbiAgfSlcblxuICBkZXNjcmliZSgnSGFwcHkgUGF0aCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBhIG5ldyB3b3JsZCwgc2F2ZSBpdCwgYW5kIHB1Ymxpc2ggY29tcGxldGlvbiBldmVudCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHNjaGVkdWxlck1vY2suZ2V0UHJvdmlkZXJGb3JSb2xlLm1vY2tSZXNvbHZlZFZhbHVlKE1PQ0tfQUlfUFJPVklERVIpXG4gICAgICBwcm9tcHRNYW5hZ2VyTW9jay5nZXRQcm9tcHQubW9ja1JldHVyblZhbHVlKCdwZXJzb25hIHByb21wdCcpXG4gICAgICBtb2NrZWRDYWxsQWlXaXRoR3VhcmQubW9ja1Jlc29sdmVkVmFsdWUoTU9DS19BSV9SRVNQT05TRSlcbiAgICAgIGNvbnN0IG1vY2tHYW1lOiBHYW1lID0ge1xuICAgICAgICBpZDogJ2dhbWUtNDU2JyxcbiAgICAgICAgbmFtZTogTU9DS19BSV9SRVNQT05TRS5nYW1lTmFtZSxcbiAgICAgICAgb3duZXJJZDogTU9DS19QQVlMT0FELnVzZXJJZCxcbiAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB9XG4gICAgICBwcmlzbWFNb2NrLmdhbWUuY3JlYXRlLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tHYW1lKVxuXG4gICAgICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZU5ld1dvcmxkKE1PQ0tfUEFZTE9BRClcblxuICAgICAgZXhwZWN0KHByb21wdEluamVjdGlvbkd1YXJkTW9jay5lbnN1cmVTYWZlT3JUaHJvdykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIE1PQ0tfUEFZTE9BRC5jb25jZXB0LFxuICAgICAgICB7XG4gICAgICAgICAgdXNlcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICB9XG4gICAgICApXG4gICAgICBleHBlY3QobW9ja2VkQ2FsbEFpV2l0aEd1YXJkKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSlcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLiR0cmFuc2FjdGlvbikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpXG4gICAgICBleHBlY3QocHJpc21hTW9jay5nYW1lLmNyZWF0ZSkudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgICBleHBlY3QocHJpc21hTW9jay5jaGFyYWN0ZXIuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLndvcmxkQm9va0VudHJ5LmNyZWF0ZU1hbnkpLnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgICAgZXhwZWN0KGV2ZW50QnVzTW9jay5wdWJsaXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ05PVElGWV9VU0VSJyxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGV2ZW50OiAnY3JlYXRpb25fY29tcGxldGVkJyxcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdFcnJvciBIYW5kbGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHRocm93IGFuZCBwdWJsaXNoIGZhaWx1cmUgZXZlbnQgaWYgQUkgZ2VuZXJhdGlvbiBmYWlscycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGFpRXJyb3IgPSBuZXcgQWlHZW5lcmF0aW9uRXhjZXB0aW9uKCdBSSBmYWlsZWQnKVxuICAgICAgc2NoZWR1bGVyTW9jay5nZXRQcm92aWRlckZvclJvbGUubW9ja1Jlc29sdmVkVmFsdWUoTU9DS19BSV9QUk9WSURFUilcbiAgICAgIHByb21wdE1hbmFnZXJNb2NrLmdldFByb21wdC5tb2NrUmV0dXJuVmFsdWUoJ3BlcnNvbmEgcHJvbXB0JylcbiAgICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrUmVqZWN0ZWRWYWx1ZShhaUVycm9yKVxuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZU5ld1dvcmxkKE1PQ0tfUEFZTE9BRClcbiAgICAgICAgZmFpbCgnRXhwZWN0ZWQgY3JlYXRlTmV3V29ybGQgdG8gdGhyb3cnKVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgZXhwZWN0KGVycm9yKS50b0JlSW5zdGFuY2VPZihJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKVxuICAgICAgfVxuXG4gICAgICBleHBlY3QocHJpc21hTW9jay4kdHJhbnNhY3Rpb24pLm5vdC50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChldmVudEJ1c01vY2sucHVibGlzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdOT1RJRllfVVNFUicsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBldmVudDogJ2NyZWF0aW9uX2ZhaWxlZCcsXG4gICAgICAgICAgdXNlcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICB9KVxuICAgICAgKVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGFuZCBwdWJsaXNoIGZhaWx1cmUgZXZlbnQgaWYgZGF0YWJhc2UgdHJhbnNhY3Rpb24gZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkYkVycm9yID0gbmV3IEVycm9yKCdEQiBjb25uZWN0aW9uIGxvc3QnKVxuICAgICAgc2NoZWR1bGVyTW9jay5nZXRQcm92aWRlckZvclJvbGUubW9ja1Jlc29sdmVkVmFsdWUoTU9DS19BSV9QUk9WSURFUilcbiAgICAgIHByb21wdE1hbmFnZXJNb2NrLmdldFByb21wdC5tb2NrUmV0dXJuVmFsdWUoJ3BlcnNvbmEgcHJvbXB0JylcbiAgICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0FJX1JFU1BPTlNFKVxuICAgICAgcHJpc21hTW9jay4kdHJhbnNhY3Rpb24ubW9ja1JlamVjdGVkVmFsdWUoZGJFcnJvcilcblxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc2VydmljZS5jcmVhdGVOZXdXb3JsZChNT0NLX1BBWUxPQUQpXG4gICAgICAgIGZhaWwoJ0V4cGVjdGVkIGNyZWF0ZU5ld1dvcmxkIHRvIHRocm93JylcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGV4cGVjdChlcnJvcikudG9CZShkYkVycm9yKVxuICAgICAgfVxuXG4gICAgICBleHBlY3QoZXZlbnRCdXNNb2NrLnB1Ymxpc2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnTk9USUZZX1VTRVInLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgZXZlbnQ6ICdjcmVhdGlvbl9mYWlsZWQnLFxuICAgICAgICAgIHVzZXJJZDogTU9DS19QQVlMT0FELnVzZXJJZCxcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBwcm9wYWdhdGUgcHJvbXB0IGluamVjdGlvbiBlcnJvcnMgYmVmb3JlIGludm9raW5nIEFJJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZ3VhcmRFcnJvciA9IG5ldyBQcm9tcHRJbmplY3Rpb25EZXRlY3RlZEV4Y2VwdGlvbignYmxvY2tlZCcsIHtcbiAgICAgICAgc2NvcmU6IDAuOTUsXG4gICAgICAgIHRocmVzaG9sZDogMC43NSxcbiAgICAgIH0pXG4gICAgICBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2suZW5zdXJlU2FmZU9yVGhyb3cubW9ja1JlamVjdGVkVmFsdWVPbmNlKGd1YXJkRXJyb3IpXG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHNlcnZpY2UuY3JlYXRlTmV3V29ybGQoTU9DS19QQVlMT0FEKVxuICAgICAgICBmYWlsKCdFeHBlY3RlZCBjcmVhdGVOZXdXb3JsZCB0byB0aHJvdycpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBleHBlY3QoZXJyb3IpLnRvQmVJbnN0YW5jZU9mKFByb21wdEluamVjdGlvbkRldGVjdGVkRXhjZXB0aW9uKVxuICAgICAgfVxuXG4gICAgICBleHBlY3QobW9ja2VkQ2FsbEFpV2l0aEd1YXJkKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgICBleHBlY3QocHJpc21hTW9jay4kdHJhbnNhY3Rpb24pLm5vdC50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChldmVudEJ1c01vY2sucHVibGlzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdOT1RJRllfVVNFUicsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBldmVudDogJ2NyZWF0aW9uX2ZhaWxlZCcsXG4gICAgICAgICAgdXNlcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICB9KVxuICAgICAgKVxuICAgIH0pXG4gIH0pXG59KVxuIl0sInZlcnNpb24iOjN9