4ea5aa605299bd5bd22b053634bb6e41
"use strict";
// 文件路径: packages/common-backend/src/types/queue-message-schemas.ts
// 职责: 定义所有队列消息的 Zod Schema，用于运行时验证
//
// 核心功能:
// 1. 为所有跨服务消息定义严格的 Schema
// 2. 确保消息格式在运行时被验证
// 3. 无效消息被立即丢弃，避免下游错误
Object.defineProperty(exports, "__esModule", { value: true });
exports.narrativeRenderingPayloadSchema = exports.gameActionJobDataSchema = exports.gameCreationPayloadSchema = void 0;
const zod_1 = require("zod");
const submit_action_dto_1 = require("../dto/submit-action.dto");
const state_change_directive_dto_1 = require("./state-change-directive.dto");
/**
 * GameCreationPayload Schema
 * 用于验证从 backend-gateway 发往 creation-agent 的创世消息
 */
exports.gameCreationPayloadSchema = zod_1.z.object({
    userId: zod_1.z.string().min(1, 'UserId must not be empty'),
    concept: zod_1.z
        .string()
        .min(10, 'Concept must be at least 10 characters long')
        .max(500, 'Concept must be 500 characters or less'),
});
/**
 * GameActionJobData Schema
 * 用于验证从 backend-gateway 发往 logic-agent 的玩家行动消息
 *
 * 注意：gameStateSnapshot 是一个复杂的 Prisma 类型，这里只验证基本结构
 * 详细的结构验证在业务逻辑层进行
 */
exports.gameActionJobDataSchema = zod_1.z.object({
    gameId: zod_1.z.string().uuid('GameId must be a valid UUID'),
    userId: zod_1.z.string().min(1, 'UserId must not be empty'),
    playerAction: submit_action_dto_1.submitActionSchema,
    gameStateSnapshot: zod_1.z.object({
        id: zod_1.z.string(),
        name: zod_1.z.string(),
        ownerId: zod_1.z.string(),
        createdAt: zod_1.z.union([zod_1.z.date(), zod_1.z.string()]), // 支持 Date 对象和 ISO 字符串
        updatedAt: zod_1.z.union([zod_1.z.date(), zod_1.z.string()]),
        character: zod_1.z
            .object({
            id: zod_1.z.string(),
            gameId: zod_1.z.string(),
            name: zod_1.z.string(),
            card: zod_1.z.unknown(), // Prisma Json 类型
            createdAt: zod_1.z.union([zod_1.z.date(), zod_1.z.string()]),
            updatedAt: zod_1.z.union([zod_1.z.date(), zod_1.z.string()]),
        })
            .nullable()
            .optional(),
        worldBook: zod_1.z
            .array(zod_1.z.object({
            id: zod_1.z.string(),
            gameId: zod_1.z.string(),
            key: zod_1.z.string(),
            content: zod_1.z.unknown(), // Prisma Json 类型
            createdAt: zod_1.z.union([zod_1.z.date(), zod_1.z.string()]),
            updatedAt: zod_1.z.union([zod_1.z.date(), zod_1.z.string()]),
        }))
            .optional(),
    }),
    correlationId: zod_1.z.string().optional(),
});
/**
 * NarrativeRenderingPayload Schema
 * 用于验证从 logic-agent 发往 narrative-agent 的叙事渲染消息
 */
exports.narrativeRenderingPayloadSchema = zod_1.z.object({
    gameId: zod_1.z.string().uuid('GameId must be a valid UUID'),
    userId: zod_1.z.string().min(1, 'UserId must not be empty'),
    playerAction: submit_action_dto_1.submitActionSchema,
    executedDirectives: state_change_directive_dto_1.directiveSetSchema,
    correlationId: zod_1.z.string().min(1, 'CorrelationId must not be empty'),
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFx0eXBlc1xccXVldWUtbWVzc2FnZS1zY2hlbWFzLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxtRUFBbUU7QUFDbkUsbUNBQW1DO0FBQ25DLEVBQUU7QUFDRixRQUFRO0FBQ1IsMEJBQTBCO0FBQzFCLG1CQUFtQjtBQUNuQixzQkFBc0I7OztBQUV0Qiw2QkFBdUI7QUFDdkIsZ0VBQTZEO0FBQzdELDZFQUFpRTtBQUVqRTs7O0dBR0c7QUFDVSxRQUFBLHlCQUF5QixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDaEQsTUFBTSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLDBCQUEwQixDQUFDO0lBQ3JELE9BQU8sRUFBRSxPQUFDO1NBQ1AsTUFBTSxFQUFFO1NBQ1IsR0FBRyxDQUFDLEVBQUUsRUFBRSw2Q0FBNkMsQ0FBQztTQUN0RCxHQUFHLENBQUMsR0FBRyxFQUFFLHdDQUF3QyxDQUFDO0NBQ3RELENBQUMsQ0FBQTtBQUlGOzs7Ozs7R0FNRztBQUNVLFFBQUEsdUJBQXVCLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUM5QyxNQUFNLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyw2QkFBNkIsQ0FBQztJQUN0RCxNQUFNLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsMEJBQTBCLENBQUM7SUFDckQsWUFBWSxFQUFFLHNDQUFrQjtJQUNoQyxpQkFBaUIsRUFBRSxPQUFDLENBQUMsTUFBTSxDQUFDO1FBQzFCLEVBQUUsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFO1FBQ2QsSUFBSSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUU7UUFDaEIsT0FBTyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUU7UUFDbkIsU0FBUyxFQUFFLE9BQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRSxzQkFBc0I7UUFDbEUsU0FBUyxFQUFFLE9BQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDMUMsU0FBUyxFQUFFLE9BQUM7YUFDVCxNQUFNLENBQUM7WUFDTixFQUFFLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRTtZQUNkLE1BQU0sRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFO1lBQ2xCLElBQUksRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFO1lBQ2hCLElBQUksRUFBRSxPQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsaUJBQWlCO1lBQ3BDLFNBQVMsRUFBRSxPQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQzFDLFNBQVMsRUFBRSxPQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1NBQzNDLENBQUM7YUFDRCxRQUFRLEVBQUU7YUFDVixRQUFRLEVBQUU7UUFDYixTQUFTLEVBQUUsT0FBQzthQUNULEtBQUssQ0FDSixPQUFDLENBQUMsTUFBTSxDQUFDO1lBQ1AsRUFBRSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUU7WUFDZCxNQUFNLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRTtZQUNsQixHQUFHLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRTtZQUNmLE9BQU8sRUFBRSxPQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsaUJBQWlCO1lBQ3ZDLFNBQVMsRUFBRSxPQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQzFDLFNBQVMsRUFBRSxPQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1NBQzNDLENBQUMsQ0FDSDthQUNBLFFBQVEsRUFBRTtLQUNkLENBQUM7SUFDRixhQUFhLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtDQUNyQyxDQUFDLENBQUE7QUFFRjs7O0dBR0c7QUFDVSxRQUFBLCtCQUErQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDdEQsTUFBTSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsNkJBQTZCLENBQUM7SUFDdEQsTUFBTSxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLDBCQUEwQixDQUFDO0lBQ3JELFlBQVksRUFBRSxzQ0FBa0I7SUFDaEMsa0JBQWtCLEVBQUUsK0NBQWtCO0lBQ3RDLGFBQWEsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxpQ0FBaUMsQ0FBQztDQUNwRSxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFx0eXBlc1xccXVldWUtbWVzc2FnZS1zY2hlbWFzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL3R5cGVzL3F1ZXVlLW1lc3NhZ2Utc2NoZW1hcy50c1xuLy8g6IGM6LSjOiDlrprkuYnmiYDmnInpmJ/liJfmtojmga/nmoQgWm9kIFNjaGVtYe+8jOeUqOS6jui/kOihjOaXtumqjOivgVxuLy9cbi8vIOaguOW/g+WKn+iDvTpcbi8vIDEuIOS4uuaJgOaciei3qOacjeWKoea2iOaBr+WumuS5ieS4peagvOeahCBTY2hlbWFcbi8vIDIuIOehruS/nea2iOaBr+agvOW8j+WcqOi/kOihjOaXtuiiq+mqjOivgVxuLy8gMy4g5peg5pWI5raI5oGv6KKr56uL5Y2z5Lii5byD77yM6YG/5YWN5LiL5ri46ZSZ6K+vXG5cbmltcG9ydCB7IHogfSBmcm9tICd6b2QnXG5pbXBvcnQgeyBzdWJtaXRBY3Rpb25TY2hlbWEgfSBmcm9tICcuLi9kdG8vc3VibWl0LWFjdGlvbi5kdG8nXG5pbXBvcnQgeyBkaXJlY3RpdmVTZXRTY2hlbWEgfSBmcm9tICcuL3N0YXRlLWNoYW5nZS1kaXJlY3RpdmUuZHRvJ1xuXG4vKipcbiAqIEdhbWVDcmVhdGlvblBheWxvYWQgU2NoZW1hXG4gKiDnlKjkuo7pqozor4Hku44gYmFja2VuZC1nYXRld2F5IOWPkeW+gCBjcmVhdGlvbi1hZ2VudCDnmoTliJvkuJbmtojmga9cbiAqL1xuZXhwb3J0IGNvbnN0IGdhbWVDcmVhdGlvblBheWxvYWRTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIHVzZXJJZDogei5zdHJpbmcoKS5taW4oMSwgJ1VzZXJJZCBtdXN0IG5vdCBiZSBlbXB0eScpLFxuICBjb25jZXB0OiB6XG4gICAgLnN0cmluZygpXG4gICAgLm1pbigxMCwgJ0NvbmNlcHQgbXVzdCBiZSBhdCBsZWFzdCAxMCBjaGFyYWN0ZXJzIGxvbmcnKVxuICAgIC5tYXgoNTAwLCAnQ29uY2VwdCBtdXN0IGJlIDUwMCBjaGFyYWN0ZXJzIG9yIGxlc3MnKSxcbn0pXG5cbmV4cG9ydCB0eXBlIEdhbWVDcmVhdGlvblBheWxvYWQgPSB6LmluZmVyPHR5cGVvZiBnYW1lQ3JlYXRpb25QYXlsb2FkU2NoZW1hPlxuXG4vKipcbiAqIEdhbWVBY3Rpb25Kb2JEYXRhIFNjaGVtYVxuICog55So5LqO6aqM6K+B5LuOIGJhY2tlbmQtZ2F0ZXdheSDlj5HlvoAgbG9naWMtYWdlbnQg55qE546p5a626KGM5Yqo5raI5oGvXG4gKlxuICog5rOo5oSP77yaZ2FtZVN0YXRlU25hcHNob3Qg5piv5LiA5Liq5aSN5p2C55qEIFByaXNtYSDnsbvlnovvvIzov5nph4zlj6rpqozor4Hln7rmnKznu5PmnoRcbiAqIOivpue7hueahOe7k+aehOmqjOivgeWcqOS4muWKoemAu+i+keWxgui/m+ihjFxuICovXG5leHBvcnQgY29uc3QgZ2FtZUFjdGlvbkpvYkRhdGFTY2hlbWEgPSB6Lm9iamVjdCh7XG4gIGdhbWVJZDogei5zdHJpbmcoKS51dWlkKCdHYW1lSWQgbXVzdCBiZSBhIHZhbGlkIFVVSUQnKSxcbiAgdXNlcklkOiB6LnN0cmluZygpLm1pbigxLCAnVXNlcklkIG11c3Qgbm90IGJlIGVtcHR5JyksXG4gIHBsYXllckFjdGlvbjogc3VibWl0QWN0aW9uU2NoZW1hLFxuICBnYW1lU3RhdGVTbmFwc2hvdDogei5vYmplY3Qoe1xuICAgIGlkOiB6LnN0cmluZygpLFxuICAgIG5hbWU6IHouc3RyaW5nKCksXG4gICAgb3duZXJJZDogei5zdHJpbmcoKSxcbiAgICBjcmVhdGVkQXQ6IHoudW5pb24oW3ouZGF0ZSgpLCB6LnN0cmluZygpXSksIC8vIOaUr+aMgSBEYXRlIOWvueixoeWSjCBJU08g5a2X56ym5LiyXG4gICAgdXBkYXRlZEF0OiB6LnVuaW9uKFt6LmRhdGUoKSwgei5zdHJpbmcoKV0pLFxuICAgIGNoYXJhY3RlcjogelxuICAgICAgLm9iamVjdCh7XG4gICAgICAgIGlkOiB6LnN0cmluZygpLFxuICAgICAgICBnYW1lSWQ6IHouc3RyaW5nKCksXG4gICAgICAgIG5hbWU6IHouc3RyaW5nKCksXG4gICAgICAgIGNhcmQ6IHoudW5rbm93bigpLCAvLyBQcmlzbWEgSnNvbiDnsbvlnotcbiAgICAgICAgY3JlYXRlZEF0OiB6LnVuaW9uKFt6LmRhdGUoKSwgei5zdHJpbmcoKV0pLFxuICAgICAgICB1cGRhdGVkQXQ6IHoudW5pb24oW3ouZGF0ZSgpLCB6LnN0cmluZygpXSksXG4gICAgICB9KVxuICAgICAgLm51bGxhYmxlKClcbiAgICAgIC5vcHRpb25hbCgpLFxuICAgIHdvcmxkQm9vazogelxuICAgICAgLmFycmF5KFxuICAgICAgICB6Lm9iamVjdCh7XG4gICAgICAgICAgaWQ6IHouc3RyaW5nKCksXG4gICAgICAgICAgZ2FtZUlkOiB6LnN0cmluZygpLFxuICAgICAgICAgIGtleTogei5zdHJpbmcoKSxcbiAgICAgICAgICBjb250ZW50OiB6LnVua25vd24oKSwgLy8gUHJpc21hIEpzb24g57G75Z6LXG4gICAgICAgICAgY3JlYXRlZEF0OiB6LnVuaW9uKFt6LmRhdGUoKSwgei5zdHJpbmcoKV0pLFxuICAgICAgICAgIHVwZGF0ZWRBdDogei51bmlvbihbei5kYXRlKCksIHouc3RyaW5nKCldKSxcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICAgIC5vcHRpb25hbCgpLFxuICB9KSxcbiAgY29ycmVsYXRpb25JZDogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxufSlcblxuLyoqXG4gKiBOYXJyYXRpdmVSZW5kZXJpbmdQYXlsb2FkIFNjaGVtYVxuICog55So5LqO6aqM6K+B5LuOIGxvZ2ljLWFnZW50IOWPkeW+gCBuYXJyYXRpdmUtYWdlbnQg55qE5Y+Z5LqL5riy5p+T5raI5oGvXG4gKi9cbmV4cG9ydCBjb25zdCBuYXJyYXRpdmVSZW5kZXJpbmdQYXlsb2FkU2NoZW1hID0gei5vYmplY3Qoe1xuICBnYW1lSWQ6IHouc3RyaW5nKCkudXVpZCgnR2FtZUlkIG11c3QgYmUgYSB2YWxpZCBVVUlEJyksXG4gIHVzZXJJZDogei5zdHJpbmcoKS5taW4oMSwgJ1VzZXJJZCBtdXN0IG5vdCBiZSBlbXB0eScpLFxuICBwbGF5ZXJBY3Rpb246IHN1Ym1pdEFjdGlvblNjaGVtYSxcbiAgZXhlY3V0ZWREaXJlY3RpdmVzOiBkaXJlY3RpdmVTZXRTY2hlbWEsXG4gIGNvcnJlbGF0aW9uSWQ6IHouc3RyaW5nKCkubWluKDEsICdDb3JyZWxhdGlvbklkIG11c3Qgbm90IGJlIGVtcHR5JyksXG59KVxuXG5leHBvcnQgdHlwZSBOYXJyYXRpdmVSZW5kZXJpbmdQYXlsb2FkID0gei5pbmZlcjx0eXBlb2YgbmFycmF0aXZlUmVuZGVyaW5nUGF5bG9hZFNjaGVtYT5cbiJdLCJ2ZXJzaW9uIjozfQ==