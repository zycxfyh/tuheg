ca20cea9b749ac73e48c6ceae2196ca9
"use strict";
// 文件路径: apps/creation-agent/src/__tests__/creation.service.spec.ts
// 描述: CreationService 的单元测试，专注于世界生成逻辑和数据库交互
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('@tuheg/common-backend', () => ({
    ...jest.requireActual('@tuheg/common-backend'),
    callAiWithGuard: jest.fn(),
}));
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const common_backend_1 = require("@tuheg/common-backend");
const jest_mock_extended_1 = require("jest-mock-extended");
const creation_service_1 = require("../creation.service");
describe('CreationService', () => {
    let service;
    let prismaMock;
    let schedulerMock;
    let promptManagerMock;
    let eventBusMock;
    let promptInjectionGuardMock;
    const mockedCallAiWithGuard = common_backend_1.callAiWithGuard;
    // Mock AI Provider following actual AiProvider interface
    const MOCK_AI_PROVIDER = {
        name: 'test-model',
        provider: 'OpenAI',
        generate: jest.fn().mockResolvedValue('mocked AI response'),
    };
    const MOCK_PAYLOAD = {
        userId: 'user-123',
        concept: 'A cyberpunk city ruled by sentient cats.',
    };
    const MOCK_AI_RESPONSE = {
        gameName: 'Neko-Kyoto Prime',
        character: {
            name: 'Jax',
            card: {
                coreIdentity: 'A rogue street samurai cat',
                personality: ['cynical', 'agile'],
                appearance: 'A sleek black cat with a robotic eye.',
            },
        },
        worldBook: [{ key: 'Neko-Kyoto', content: { description: 'The main city.' } }],
    };
    beforeEach(async () => {
        prismaMock = (0, jest_mock_extended_1.mockDeep)();
        schedulerMock = (0, jest_mock_extended_1.mockDeep)();
        promptManagerMock = (0, jest_mock_extended_1.mockDeep)();
        eventBusMock = (0, jest_mock_extended_1.mockDeep)();
        promptInjectionGuardMock = (0, jest_mock_extended_1.mockDeep)();
        promptInjectionGuardMock.ensureSafeOrThrow.mockResolvedValue(undefined);
        const module = await testing_1.Test.createTestingModule({
            providers: [
                creation_service_1.CreationService,
                { provide: common_backend_1.PrismaService, useValue: prismaMock },
                { provide: common_backend_1.DynamicAiSchedulerService, useValue: schedulerMock },
                { provide: common_backend_1.PromptManagerService, useValue: promptManagerMock },
                { provide: common_backend_1.EventBusService, useValue: eventBusMock },
                { provide: common_backend_1.PromptInjectionGuard, useValue: promptInjectionGuardMock },
            ],
        }).compile();
        service = module.get(creation_service_1.CreationService);
        // Mock $transaction to execute the callback immediately
        prismaMock.$transaction.mockImplementation((callback) => {
            if (typeof callback === 'function') {
                return callback(prismaMock);
            }
            return Promise.resolve([]);
        });
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('Happy Path', () => {
        it('should create a new world, save it, and publish completion event', async () => {
            schedulerMock.getProviderForRole.mockResolvedValue(MOCK_AI_PROVIDER);
            promptManagerMock.getPrompt.mockReturnValue('persona prompt');
            mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE);
            const mockGame = {
                id: 'game-456',
                name: MOCK_AI_RESPONSE.gameName,
                ownerId: MOCK_PAYLOAD.userId,
                createdAt: new Date(),
                updatedAt: new Date(),
            };
            prismaMock.game.create.mockResolvedValue(mockGame);
            await service.createNewWorld(MOCK_PAYLOAD);
            expect(promptInjectionGuardMock.ensureSafeOrThrow).toHaveBeenCalledWith(MOCK_PAYLOAD.concept, {
                userId: MOCK_PAYLOAD.userId,
            });
            expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1);
            expect(prismaMock.$transaction).toHaveBeenCalledTimes(1);
            expect(prismaMock.game.create).toHaveBeenCalled();
            expect(prismaMock.character.create).toHaveBeenCalled();
            expect(prismaMock.worldBookEntry.createMany).toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_completed',
            }));
        });
    });
    describe('Error Handling', () => {
        it('should throw and publish failure event if AI generation fails', async () => {
            const aiError = new common_backend_1.AiGenerationException('AI failed');
            schedulerMock.getProviderForRole.mockResolvedValue(MOCK_AI_PROVIDER);
            promptManagerMock.getPrompt.mockReturnValue('persona prompt');
            mockedCallAiWithGuard.mockRejectedValue(aiError);
            try {
                await service.createNewWorld(MOCK_PAYLOAD);
                fail('Expected createNewWorld to throw');
            }
            catch (error) {
                expect(error).toBeInstanceOf(common_1.InternalServerErrorException);
            }
            expect(prismaMock.$transaction).not.toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_failed',
                userId: MOCK_PAYLOAD.userId,
            }));
        });
        it('should throw and publish failure event if database transaction fails', async () => {
            const dbError = new Error('DB connection lost');
            schedulerMock.getProviderForRole.mockResolvedValue(MOCK_AI_PROVIDER);
            promptManagerMock.getPrompt.mockReturnValue('persona prompt');
            mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE);
            prismaMock.$transaction.mockRejectedValue(dbError);
            try {
                await service.createNewWorld(MOCK_PAYLOAD);
                fail('Expected createNewWorld to throw');
            }
            catch (error) {
                expect(error).toBe(dbError);
            }
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_failed',
                userId: MOCK_PAYLOAD.userId,
            }));
        });
        it('should propagate prompt injection errors before invoking AI', async () => {
            const guardError = new common_backend_1.PromptInjectionDetectedException('blocked', {
                score: 0.95,
                threshold: 0.75,
            });
            promptInjectionGuardMock.ensureSafeOrThrow.mockRejectedValueOnce(guardError);
            try {
                await service.createNewWorld(MOCK_PAYLOAD);
                fail('Expected createNewWorld to throw');
            }
            catch (error) {
                expect(error).toBeInstanceOf(common_backend_1.PromptInjectionDetectedException);
            }
            expect(mockedCallAiWithGuard).not.toHaveBeenCalled();
            expect(prismaMock.$transaction).not.toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_failed',
                userId: MOCK_PAYLOAD.userId,
            }));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGNyZWF0aW9uLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcY3JlYXRpb24uc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxtRUFBbUU7QUFDbkUsNENBQTRDOztBQW1CNUMsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQztJQUM5QyxlQUFlLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUMzQixDQUFDLENBQUMsQ0FBQTtBQXBCSCwyQ0FBNkQ7QUFDN0QsNkNBQTBEO0FBRTFELDBEQVU4QjtBQUM5QiwyREFBaUU7QUFDakUsMERBQXFEO0FBT3JELFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7SUFDL0IsSUFBSSxPQUF3QixDQUFBO0lBQzVCLElBQUksVUFBdUMsQ0FBQTtJQUMzQyxJQUFJLGFBQXVELENBQUE7SUFDM0QsSUFBSSxpQkFBc0QsQ0FBQTtJQUMxRCxJQUFJLFlBQTRDLENBQUE7SUFDaEQsSUFBSSx3QkFBNkQsQ0FBQTtJQUNqRSxNQUFNLHFCQUFxQixHQUFHLGdDQUE0QixDQUFBO0lBRTFELHlEQUF5RDtJQUN6RCxNQUFNLGdCQUFnQixHQUFlO1FBQ25DLElBQUksRUFBRSxZQUFZO1FBQ2xCLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsb0JBQW9CLENBQUM7S0FDNUQsQ0FBQTtJQUVELE1BQU0sWUFBWSxHQUFHO1FBQ25CLE1BQU0sRUFBRSxVQUFVO1FBQ2xCLE9BQU8sRUFBRSwwQ0FBMEM7S0FDcEQsQ0FBQTtJQUVELE1BQU0sZ0JBQWdCLEdBQUc7UUFDdkIsUUFBUSxFQUFFLGtCQUFrQjtRQUM1QixTQUFTLEVBQUU7WUFDVCxJQUFJLEVBQUUsS0FBSztZQUNYLElBQUksRUFB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QUMsQ0FBQyxvQkFBb0IsQ0FDL0MsYUFBYSxFQUNiLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsS0FBSyxFQUFFLGlCQUFpQjtnQkFDeEIsTUFBTSxFQUFFLFlBQVksQ0FBQyxNQUFNO2FBQzVCLENBQUMsQ0FDSCxDQUFBO1FBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQyxDQUFBIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxhcHBzXFxjcmVhdGlvbi1hZ2VudFxcc3JjXFxfX3Rlc3RzX19cXGNyZWF0aW9uLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyDmlofku7bot6/lvoQ6IGFwcHMvY3JlYXRpb24tYWdlbnQvc3JjL19fdGVzdHNfXy9jcmVhdGlvbi5zZXJ2aWNlLnNwZWMudHNcbi8vIOaPj+i/sDogQ3JlYXRpb25TZXJ2aWNlIOeahOWNleWFg+a1i+ivle+8jOS4k+azqOS6juS4lueVjOeUn+aIkOmAu+i+keWSjOaVsOaNruW6k+S6pOS6klxuXG5pbXBvcnQgeyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nXG5pbXBvcnQgeyBUZXN0LCB0eXBlIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnXG5pbXBvcnQgdHlwZSB7IEdhbWUsIFByaXNtYUNsaWVudCB9IGZyb20gJ0BwcmlzbWEvY2xpZW50J1xuaW1wb3J0IHtcbiAgQWlHZW5lcmF0aW9uRXhjZXB0aW9uLFxuICB0eXBlIEFpUHJvdmlkZXIsXG4gIGNhbGxBaVdpdGhHdWFyZCxcbiAgRHluYW1pY0FpU2NoZWR1bGVyU2VydmljZSxcbiAgRXZlbnRCdXNTZXJ2aWNlLFxuICBQcmlzbWFTZXJ2aWNlLFxuICBQcm9tcHRJbmplY3Rpb25EZXRlY3RlZEV4Y2VwdGlvbixcbiAgUHJvbXB0SW5qZWN0aW9uR3VhcmQsXG4gIFByb21wdE1hbmFnZXJTZXJ2aWNlLFxufSBmcm9tICdAdHVoZWcvY29tbW9uLWJhY2tlbmQnXG5pbXBvcnQgeyB0eXBlIERlZXBNb2NrUHJveHksIG1vY2tEZWVwIH0gZnJvbSAnamVzdC1tb2NrLWV4dGVuZGVkJ1xuaW1wb3J0IHsgQ3JlYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vY3JlYXRpb24uc2VydmljZSdcblxuamVzdC5tb2NrKCdAdHVoZWcvY29tbW9uLWJhY2tlbmQnLCAoKSA9PiAoe1xuICAuLi5qZXN0LnJlcXVpcmVBY3R1YWwoJ0B0dWhlZy9jb21tb24tYmFja2VuZCcpLFxuICBjYWxsQWlXaXRoR3VhcmQ6IGplc3QuZm4oKSxcbn0pKVxuXG5kZXNjcmliZSgnQ3JlYXRpb25TZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogQ3JlYXRpb25TZXJ2aWNlXG4gIGxldCBwcmlzbWFNb2NrOiBEZWVwTW9ja1Byb3h5PFByaXNtYUNsaWVudD5cbiAgbGV0IHNjaGVkdWxlck1vY2s6IERlZXBNb2NrUHJveHk8RHluYW1pY0FpU2NoZWR1bGVyU2VydmljZT5cbiAgbGV0IHByb21wdE1hbmFnZXJNb2NrOiBEZWVwTW9ja1Byb3h5PFByb21wdE1hbmFnZXJTZXJ2aWNlPlxuICBsZXQgZXZlbnRCdXNNb2NrOiBEZWVwTW9ja1Byb3h5PEV2ZW50QnVzU2VydmljZT5cbiAgbGV0IHByb21wdEluamVjdGlvbkd1YXJkTW9jazogRGVlcE1vY2tQcm94eTxQcm9tcHRJbmplY3Rpb25HdWFyZD5cbiAgY29uc3QgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkID0gY2FsbEFpV2l0aEd1YXJkIGFzIGplc3QuTW9ja1xuXG4gIC8vIE1vY2sgQUkgUHJvdmlkZXIgZm9sbG93aW5nIGFjdHVhbCBBaVByb3ZpZGVyIGludGVyZmFjZVxuICBjb25zdCBNT0NLX0FJX1BST1ZJREVSOiBBaVByb3ZpZGVyID0ge1xuICAgIG5hbWU6ICd0ZXN0LW1vZGVsJyxcbiAgICBwcm92aWRlcjogJ09wZW5BSScsXG4gICAgZ2VuZXJhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSgnbW9ja2VkIEFJIHJlc3BvbnNlJyksXG4gIH1cblxuICBjb25zdCBNT0NLX1BBWUxPQUQgPSB7XG4gICAgdXNlcklkOiAndXNlci0xMjMnLFxuICAgIGNvbmNlcHQ6ICdBIGN5YmVycHVuayBjaXR5IHJ1bGVkIGJ5IHNlbnRpZW50IGNhdHMuJyxcbiAgfVxuXG4gIGNvbnN0IE1PQ0tfQUlfUkVTUE9OU0UgPSB7XG4gICAgZ2FtZU5hbWU6ICdOZWtvLUt5b3RvIFByaW1lJyxcbiAgICBjaGFyYWN0ZXI6IHtcbiAgICAgIG5hbWU6ICdKYXgnLFxuICAgICAgY2FyZDoge1xuICAgICAgICBjb3JlSWRlbnRpdHk6ICdBIHJvZ3VlIHN0cmVldCBzYW11cmFpIGNhdCcsXG4gICAgICAgIHBlcnNvbmFsaXR5OiBbJ2N5bmljYWwnLCAnYWdpbGUnXSxcbiAgICAgICAgYXBwZWFyYW5jZTogJ0Egc2xlZWsgYmxhY2sgY2F0IHdpdGggYSByb2JvdGljIGV5ZS4nLFxuICAgICAgfSxcbiAgICB9LFxuICAgIHdvcmxkQm9vazogW3sga2V5OiAnTmVrby1LeW90bycsIGNvbnRlbnQ6IHsgZGVzY3JpcHRpb246ICdUaGUgbWFpbiBjaXR5LicgfSB9XSxcbiAgfVxuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIHByaXNtYU1vY2sgPSBtb2NrRGVlcDxQcmlzbWFDbGllbnQ+KClcbiAgICBzY2hlZHVsZXJNb2NrID0gbW9ja0RlZXA8RHluYW1pY0FpU2NoZWR1bGVyU2VydmljZT4oKVxuICAgIHByb21wdE1hbmFnZXJNb2NrID0gbW9ja0RlZXA8UHJvbXB0TWFuYWdlclNlcnZpY2U+KClcbiAgICBldmVudEJ1c01vY2sgPSBtb2NrRGVlcDxFdmVudEJ1c1NlcnZpY2U+KClcbiAgICBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2sgPSBtb2NrRGVlcDxQcm9tcHRJbmplY3Rpb25HdWFyZD4oKVxuICAgIHByb21wdEluamVjdGlvbkd1YXJkTW9jay5lbnN1cmVTYWZlT3JUaHJvdy5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpXG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIENyZWF0aW9uU2VydmljZSxcbiAgICAgICAgeyBwcm92aWRlOiBQcmlzbWFTZXJ2aWNlLCB1c2VWYWx1ZTogcHJpc21hTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2UsIHVzZVZhbHVlOiBzY2hlZHVsZXJNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogUHJvbXB0TWFuYWdlclNlcnZpY2UsIHVzZVZhbHVlOiBwcm9tcHRNYW5hZ2VyTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IEV2ZW50QnVzU2VydmljZSwgdXNlVmFsdWU6IGV2ZW50QnVzTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IFByb21wdEluamVjdGlvbkd1YXJkLCB1c2VWYWx1ZTogcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKVxuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8Q3JlYXRpb25TZXJ2aWNlPihDcmVhdGlvblNlcnZpY2UpXG5cbiAgICAvLyBNb2NrICR0cmFuc2FjdGlvbiB0byBleGVjdXRlIHRoZSBjYWxsYmFjayBpbW1lZGlhdGVseVxuICAgIHByaXNtYU1vY2suJHRyYW5zYWN0aW9uLm1vY2tJbXBsZW1lbnRhdGlvbigoY2FsbGJhY2s6IHVua25vd24pID0+IHtcbiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHByaXNtYU1vY2spXG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtdKVxuICAgIH0pXG4gIH0pXG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKVxuICB9KVxuXG4gIGl0KCdzaG91bGQgYmUgZGVmaW5lZCcsICgpID0+IHtcbiAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKVxuICB9KVxuXG4gIGRlc2NyaWJlKCdIYXBweSBQYXRoJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgbmV3IHdvcmxkLCBzYXZlIGl0LCBhbmQgcHVibGlzaCBjb21wbGV0aW9uIGV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgc2NoZWR1bGVyTW9jay5nZXRQcm92aWRlckZvclJvbGUubW9ja1Jlc29sdmVkVmFsdWUoTU9DS19BSV9QUk9WSURFUilcbiAgICAgIHByb21wdE1hbmFnZXJNb2NrLmdldFByb21wdC5tb2NrUmV0dXJuVmFsdWUoJ3BlcnNvbmEgcHJvbXB0JylcbiAgICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0FJX1JFU1BPTlNFKVxuICAgICAgY29uc3QgbW9ja0dhbWU6IEdhbWUgPSB7XG4gICAgICAgIGlkOiAnZ2FtZS00NTYnLFxuICAgICAgICBuYW1lOiBNT0NLX0FJX1JFU1BPTlNFLmdhbWVOYW1lLFxuICAgICAgICBvd25lcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH1cbiAgICAgIHByaXNtYU1vY2suZ2FtZS5jcmVhdGUubW9ja1Jlc29sdmVkVmFsdWUobW9ja0dhbWUpXG5cbiAgICAgIGF3YWl0IHNlcnZpY2UuY3JlYXRlTmV3V29ybGQoTU9DS19QQVlMT0FEKVxuXG4gICAgICBleHBlY3QocHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmVuc3VyZVNhZmVPclRocm93KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgTU9DS19QQVlMT0FELmNvbmNlcHQsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VySWQ6IE1PQ0tfUEFZTE9BRC51c2VySWQsXG4gICAgICAgIH1cbiAgICAgIClcbiAgICAgIGV4cGVjdChtb2NrZWRDYWxsQWlXaXRoR3VhcmQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKVxuICAgICAgZXhwZWN0KHByaXNtYU1vY2suJHRyYW5zYWN0aW9uKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSlcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLmdhbWUuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLmNoYXJhY3Rlci5jcmVhdGUpLnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgICAgZXhwZWN0KHByaXNtYU1vY2sud29ybGRCb29rRW50cnkuY3JlYXRlTWFueSkudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgICBleHBlY3QoZXZlbnRCdXNNb2NrLnB1Ymxpc2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnTk9USUZZX1VTRVInLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgZXZlbnQ6ICdjcmVhdGlvbl9jb21wbGV0ZWQnLFxuICAgICAgICB9KVxuICAgICAgKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ0Vycm9yIEhhbmRsaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdGhyb3cgYW5kIHB1Ymxpc2ggZmFpbHVyZSBldmVudCBpZiBBSSBnZW5lcmF0aW9uIGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYWlFcnJvciA9IG5ldyBBaUdlbmVyYXRpb25FeGNlcHRpb24oJ0FJIGZhaWxlZCcpXG4gICAgICBzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZS5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0FJX1BST1ZJREVSKVxuICAgICAgcHJvbXB0TWFuYWdlck1vY2suZ2V0UHJvbXB0Lm1vY2tSZXR1cm5WYWx1ZSgncGVyc29uYSBwcm9tcHQnKVxuICAgICAgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkLm1vY2tSZWplY3RlZFZhbHVlKGFpRXJyb3IpXG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHNlcnZpY2UuY3JlYXRlTmV3V29ybGQoTU9DS19QQVlMT0FEKVxuICAgICAgICBmYWlsKCdFeHBlY3RlZCBjcmVhdGVOZXdXb3JsZCB0byB0aHJvdycpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBleHBlY3QoZXJyb3IpLnRvQmVJbnN0YW5jZU9mKEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24pXG4gICAgICB9XG5cbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLiR0cmFuc2FjdGlvbikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgICAgZXhwZWN0KGV2ZW50QnVzTW9jay5wdWJsaXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ05PVElGWV9VU0VSJyxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGV2ZW50OiAnY3JlYXRpb25fZmFpbGVkJyxcbiAgICAgICAgICB1c2VySWQ6IE1PQ0tfUEFZTE9BRC51c2VySWQsXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgYW5kIHB1Ymxpc2ggZmFpbHVyZSBldmVudCBpZiBkYXRhYmFzZSB0cmFuc2FjdGlvbiBmYWlscycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRiRXJyb3IgPSBuZXcgRXJyb3IoJ0RCIGNvbm5lY3Rpb24gbG9zdCcpXG4gICAgICBzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZS5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0FJX1BST1ZJREVSKVxuICAgICAgcHJvbXB0TWFuYWdlck1vY2suZ2V0UHJvbXB0Lm1vY2tSZXR1cm5WYWx1ZSgncGVyc29uYSBwcm9tcHQnKVxuICAgICAgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkLm1vY2tSZXNvbHZlZFZhbHVlKE1PQ0tfQUlfUkVTUE9OU0UpXG4gICAgICBwcmlzbWFNb2NrLiR0cmFuc2FjdGlvbi5tb2NrUmVqZWN0ZWRWYWx1ZShkYkVycm9yKVxuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZU5ld1dvcmxkKE1PQ0tfUEFZTE9BRClcbiAgICAgICAgZmFpbCgnRXhwZWN0ZWQgY3JlYXRlTmV3V29ybGQgdG8gdGhyb3cnKVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgZXhwZWN0KGVycm9yKS50b0JlKGRiRXJyb3IpXG4gICAgICB9XG5cbiAgICAgIGV4cGVjdChldmVudEJ1c01vY2sucHVibGlzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdOT1RJRllfVVNFUicsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBldmVudDogJ2NyZWF0aW9uX2ZhaWxlZCcsXG4gICAgICAgICAgdXNlcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICB9KVxuICAgICAgKVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIHByb3BhZ2F0ZSBwcm9tcHQgaW5qZWN0aW9uIGVycm9ycyBiZWZvcmUgaW52b2tpbmcgQUknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBndWFyZEVycm9yID0gbmV3IFByb21wdEluamVjdGlvbkRldGVjdGVkRXhjZXB0aW9uKCdibG9ja2VkJywge1xuICAgICAgICBzY29yZTogMC45NSxcbiAgICAgICAgdGhyZXNob2xkOiAwLjc1LFxuICAgICAgfSlcbiAgICAgIHByb21wdEluamVjdGlvbkd1YXJkTW9jay5lbnN1cmVTYWZlT3JUaHJvdy5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UoZ3VhcmRFcnJvcilcblxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc2VydmljZS5jcmVhdGVOZXdXb3JsZChNT0NLX1BBWUxPQUQpXG4gICAgICAgIGZhaWwoJ0V4cGVjdGVkIGNyZWF0ZU5ld1dvcmxkIHRvIHRocm93JylcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGV4cGVjdChlcnJvcikudG9CZUluc3RhbmNlT2YoUHJvbXB0SW5qZWN0aW9uRGV0ZWN0ZWRFeGNlcHRpb24pXG4gICAgICB9XG5cbiAgICAgIGV4cGVjdChtb2NrZWRDYWxsQWlXaXRoR3VhcmQpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLiR0cmFuc2FjdGlvbikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgICAgZXhwZWN0KGV2ZW50QnVzTW9jay5wdWJsaXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ05PVElGWV9VU0VSJyxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGV2ZW50OiAnY3JlYXRpb25fZmFpbGVkJyxcbiAgICAgICAgICB1c2VySWQ6IE1PQ0tfUEFZTE9BRC51c2VySWQsXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgfSlcbiAgfSlcbn0pXG4iXSwidmVyc2lvbiI6M30=