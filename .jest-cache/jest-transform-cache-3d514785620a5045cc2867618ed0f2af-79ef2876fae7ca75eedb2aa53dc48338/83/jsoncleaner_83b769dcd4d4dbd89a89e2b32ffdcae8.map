{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\ai\\json-cleaner.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\ai\\json-cleaner.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/ai/json-cleaner.ts\n// 职责: 尝试修复并解析可能不规范的 AI JSON 输出\n//\n// 背景:\n// AI 模型（特别是 LLM）在输出 JSON 时经常会出现以下问题：\n// - 包裹在 Markdown 代码块中（```json ... ```）\n// - 包含 JSON 不支持的单引号或注释\n// - 缺少逗号或括号不匹配\n// - 前后包含说明文字\n//\n// 本模块提供自动修复功能，尝试多种策略将\"脏 JSON\"转换为有效的 JSON 对象或数组。\n//\n// 修复策略（按优先级）:\n// 1. 直接解析（最快的路径）\n// 2. 使用 jsonrepair 库修复常见语法错误\n// 3. 先修复引号再使用 jsonrepair\n// 4. 仅修复引号\n//\n// 限制:\n// - 只接受 JSON 对象或数组，不接受原始值（null, string, number, boolean）\n// - 如果所有策略都失败，会抛出 JsonSanitizationError\n\n// 动态导入以避免CommonJS/ESM问题\n\n/**\n * JSON 清理错误\n * 当无法将输入字符串修复为有效 JSON 时抛出\n *\n * @property context - 包含原始输入和最后一次尝试的错误信息\n */\nexport class JsonSanitizationError extends Error {\n  constructor(\n    message: string,\n    public readonly context?: { raw: string; lastError?: unknown }\n  ) {\n    super(message)\n    this.name = 'JsonSanitizationError'\n  }\n}\n\n/**\n * 类型守卫：检查值是否为可接受的 JSON 结构（对象或数组）\n *\n * @param value - 要检查的值\n * @returns 如果是对象或数组返回 true，否则返回 false\n *\n * @remarks\n * 我们只接受对象和数组，不接受原始值（null, string, number, boolean）\n * 这是因为 AI 输出通常是结构化的数据，而不是单个值\n */\nfunction isAcceptableJsonValue(value: unknown): value is Record<string, unknown> | unknown[] {\n  // null 的类型是 'object'，需要显式排除\n  if (value === null) {\n    return false\n  }\n  // 数组是可接受的\n  if (Array.isArray(value)) {\n    return true\n  }\n  // 对象（但不是 null）是可接受的\n  return typeof value === 'object'\n}\n\n/**\n * 移除 Markdown 代码块包裹，如 ```json ... ```\n */\nfunction stripCodeFences(raw: string): string {\n  let result = raw.trim()\n\n  if (result.startsWith('```')) {\n    // 移除开头的 ``` 或 ```json\n    result = result.replace(/^```[a-zA-Z]*\\s*/i, '')\n  }\n  if (result.endsWith('```')) {\n    result = result.replace(/```$/i, '')\n  }\n\n  return result.trim()\n}\n\n/**\n * 尝试提取字符串中的 JSON 主体（去掉说明文字、前后缀）。\n */\nfunction extractJsonCore(raw: string): string {\n  const firstBrace = raw.indexOf('{')\n  const firstBracket = raw.indexOf('[')\n\n  let start = -1\n  if (firstBrace !== -1 && firstBracket !== -1) {\n    start = Math.min(firstBrace, firstBracket)\n  } else {\n    start = Math.max(firstBrace, firstBracket)\n  }\n\n  if (start === -1) {\n    return raw\n  }\n\n  const lastBrace = raw.lastIndexOf('}')\n  const lastBracket = raw.lastIndexOf(']')\n  const endCandidates = [lastBrace, lastBracket].filter((index) => index !== -1)\n  const end = endCandidates.length > 0 ? Math.max(...endCandidates) : raw.length - 1\n\n  if (end <= start) {\n    return raw.slice(start)\n  }\n\n  return raw.slice(start, end + 1)\n}\n\n/**\n * 尝试替换常见的单引号 JSON 格式为双引号。\n */\nfunction normalizeQuotes(raw: string): string {\n  const hasDoubleQuotes = raw.includes('\"')\n  const hasSingleQuotes = raw.includes(\"'\")\n\n  if (!hasDoubleQuotes && hasSingleQuotes) {\n    return raw.replace(/'/g, '\"')\n  }\n\n  return raw\n}\n\n/**\n * 清理并解析 JSON 字符串\n *\n * @param raw - 可能是\"脏\"的 JSON 字符串，或已经是对象/数组的值\n * @returns 解析后的 JSON 对象或数组\n * @throws {JsonSanitizationError} 如果无法修复为有效 JSON\n *\n * @remarks\n * 修复流程：\n * 1. 如果不是字符串，直接返回（可能已经是解析过的对象）\n * 2. 移除 Markdown 代码块包裹\n * 3. 提取 JSON 核心部分（去掉前后说明文字）\n * 4. 尝试多种修复策略：\n *    a. 直接解析（最快的路径）\n *    b. 使用 jsonrepair 修复语法错误\n *    c. 先修复引号再使用 jsonrepair\n *    d. 仅修复引号\n * 5. 验证结果是对象或数组（不接受原始值）\n * 6. 如果所有策略都失败，抛出错误\n *\n * @example\n * ```typescript\n * // 处理包裹在 Markdown 中的 JSON\n * const result = cleanAndParseJson('```json\\n{\"key\": \"value\"}\\n```');\n * // => { key: \"value\" }\n *\n * // 处理单引号 JSON\n * const result2 = cleanAndParseJson(\"{'status': 'ok'}\");\n * // => { status: \"ok\" }\n *\n * // 处理包含注释的 JSON\n * const result3 = cleanAndParseJson('{\"name\": \"test\", // comment\\n}');\n * // => { name: \"test\" }\n * ```\n */\nexport async function cleanAndParseJson(raw: unknown): Promise<unknown> {\n  // 如果已经是对象或数组，直接返回（避免不必要的处理）\n  if (typeof raw !== 'string') {\n    return raw\n  }\n\n  // 步骤 1: 移除 Markdown 代码块包裹\n  let working = stripCodeFences(raw)\n  // 步骤 2: 提取 JSON 核心部分（去掉前后说明文字）\n  working = extractJsonCore(working)\n  // 步骤 3: 去除首尾空白\n  working = working.trim()\n\n  // 步骤 4: 按优先级尝试多种修复策略\n  // 从最快到最慢，从简单到复杂\n  const attempts: Array<() => unknown | Promise<unknown>> = [\n    // 策略 1: 直接解析（最快的路径，适用于已经是有效 JSON 的情况）\n    () => JSON.parse(working),\n    // 策略 2: 使用 jsonrepair 修复常见语法错误（如缺少逗号、括号不匹配等）\n    async () => {\n      try {\n        const { jsonrepair } = await import('jsonrepair')\n        const repaired = jsonrepair(working)\n        console.log('jsonrepair input:', JSON.stringify(working))\n        console.log('jsonrepair output:', JSON.stringify(repaired))\n        return JSON.parse(repaired)\n      } catch (error) {\n        console.log('jsonrepair strategy failed:', error)\n        // 如果jsonrepair不可用，跳过此策略，让下一个策略尝试\n        return undefined\n      }\n    },\n    // 策略 3: 先修复引号再使用 jsonrepair（处理单引号 JSON）\n    async () => {\n      try {\n        const { jsonrepair } = await import('jsonrepair')\n        return JSON.parse(jsonrepair(normalizeQuotes(working)))\n      } catch {\n        // 如果jsonrepair不可用，跳过此策略，让下一个策略尝试\n        return undefined\n      }\n    },\n    // 策略 4: 仅修复引号（如果 jsonrepair 也不起作用）\n    () => JSON.parse(normalizeQuotes(working)),\n  ]\n\n  let lastError: unknown\n  for (const attempt of attempts) {\n    try {\n      const parsed = await attempt()\n      // 如果策略返回undefined，跳过此策略\n      if (parsed === undefined) {\n        continue\n      }\n      // 验证结果是对象或数组（不接受原始值）\n      if (isAcceptableJsonValue(parsed)) {\n        return parsed\n      }\n      // 如果解析成功但不是对象/数组，记录错误但继续尝试其他策略\n      lastError = new Error('Sanitized output was not a JSON object or array.')\n    } catch (error) {\n      // 解析失败，记录错误并尝试下一个策略\n      lastError = error\n      // 调试输出\n      console.log(`Strategy failed:`, error)\n    }\n  }\n\n  // 所有策略都失败，抛出详细的错误信息\n  throw new JsonSanitizationError('Failed to sanitize AI output into valid JSON.', {\n    raw,\n    lastError,\n  })\n}\n"],"version":3}