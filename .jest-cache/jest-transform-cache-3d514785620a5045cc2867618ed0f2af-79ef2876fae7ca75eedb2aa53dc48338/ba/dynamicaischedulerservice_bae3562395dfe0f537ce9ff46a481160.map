{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\ai\\dynamic-ai-scheduler.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\ai\\dynamic-ai-scheduler.service.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/ai/dynamic-ai-scheduler.service.ts\n\nimport { Injectable, InternalServerErrorException, Logger } from '@nestjs/common'\nimport type { ConfigService } from '@nestjs/config'\nimport type { AiConfiguration, User } from '@prisma/client'\nimport type { PrismaService } from '../prisma/prisma.service'\nimport type { AiProvider, AiRole } from '../types/ai-providers.types'\nimport type { AiProviderFactory } from './ai-provider.factory'\n\n@Injectable()\nexport class DynamicAiSchedulerService {\n  private readonly logger = new Logger(DynamicAiSchedulerService.name)\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly aiProviderFactory: AiProviderFactory,\n    private readonly configService: ConfigService\n  ) {}\n\n  public async getProviderForRole(user: User, role: AiRole): Promise<AiProvider> {\n    this.logger.debug(`[Scheduler] New request for role: \"${role}\" from user ${user.id}`)\n\n    // [!] 核心改造 1: 查询逻辑翻译\n    // 我们不再查询一个字符串数组，而是查询一个关系。\n    // 我们要找的是：一个 AiConfiguration，它的 'roles' 关系中，\n    // 'some' (至少有一个) Role 的 'name' 字段等于我们想要的 'role'。\n    const dedicatedConfig = await this.prisma.aiConfiguration.findFirst({\n      where: {\n        ownerId: user.id,\n        roles: {\n          some: {\n            name: role, // 这就是新的、正确的 Prisma 关系查询语法\n          },\n        },\n      },\n    })\n\n    if (dedicatedConfig) {\n      this.logger.log(\n        `[Scheduler] Priority 1 (Dedicated): Found dedicated config \"${dedicatedConfig.provider}/${dedicatedConfig.modelId}\" for role \"${role}\".`\n      )\n      return this.aiProviderFactory.createProvider(dedicatedConfig)\n    }\n    this.logger.debug(\n      `[Scheduler] Priority 1 (Dedicated): No dedicated AI found for role \"${role}\".`\n    )\n\n    // 优先级 2: 征用逻辑保持不变\n    const anyUserConfig = await this.prisma.aiConfiguration.findFirst({\n      where: { ownerId: user.id },\n      orderBy: { createdAt: 'asc' },\n    })\n\n    if (anyUserConfig) {\n      this.logger.log(\n        `[Scheduler] Priority 2 (Requisition): Requisitioning general-purpose AI \"${anyUserConfig.provider}/${anyUserConfig.modelId}\" for role \"${role}\".`\n      )\n      return this.aiProviderFactory.createProvider(anyUserConfig)\n    }\n    this.logger.debug(`[Scheduler] Priority 2 (Requisition): User has no AI configurations at all.`)\n\n    // 优先级 3: 后备逻辑保持不变，但模拟对象结构需要改变\n    this.logger.warn(\n      `[Scheduler] Priority 3 (System Fallback): Falling back to system default AI for role \"${role}\".`\n    )\n    try {\n      return this.createFallbackProvider()\n    } catch (error) {\n      this.logger.error(\n        `[Scheduler] CRITICAL FAILURE: System fallback AI failed to initialize.`,\n        error instanceof Error ? error.stack : undefined\n      )\n      throw new InternalServerErrorException(\n        'AI processing failed: No AI is available or configured correctly.'\n      )\n    }\n  }\n\n  private createFallbackProvider(): AiProvider {\n    try {\n      // 优先使用专门的DeepSeek配置，如果没有则使用后备配置\n      const apiKey = this.configService.get<string>('DEEPSEEK_API_KEY') ||\n                     this.configService.getOrThrow<string>('FALLBACK_API_KEY')\n      const modelId = this.configService.get<string>('FALLBACK_MODEL_ID', 'deepseek-chat')\n      const baseUrlFromEnv = this.configService.get<string>('DEEPSEEK_BASE_URL') ||\n                             this.configService.get<string>('FALLBACK_BASE_URL')\n\n      // [!] 核心改造 2: 模拟对象结构翻译\n      // 新的 AiConfiguration 类型没有 `assignedRoles` 字段。\n      // 我们创建一个不包含任何角色信息的、纯粹的配置对象。\n      // 注意：这个模拟对象缺少 'roles' 属性，所以我们需要告诉 TypeScript\n      // 它符合 AiConfiguration 的形状（通过类型断言 as AiConfiguration）。\n      const fallbackConfig = {\n        id: 'system-fallback',\n        provider: 'DeepSeek',\n        apiKey,\n        baseUrl: baseUrlFromEnv ?? null,\n        modelId,\n        ownerId: 'system',\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      } as AiConfiguration // 类型断言，表示我们确信这个对象的结构是兼容的\n\n      return this.aiProviderFactory.createProvider(fallbackConfig)\n    } catch (error) {\n      this.logger.error(\n        'System fallback AI configuration is missing or invalid. Check your .env file for FALLBACK_... variables.',\n        error\n      )\n      throw new Error('System default AI is not configured.')\n    }\n  }\n}\n"],"version":3}