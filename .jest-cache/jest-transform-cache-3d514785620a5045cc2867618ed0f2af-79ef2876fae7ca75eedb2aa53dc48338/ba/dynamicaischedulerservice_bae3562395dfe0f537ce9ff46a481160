29650092ceb625855df2645aa0ea7228
"use strict";
// 文件路径: packages/common-backend/src/ai/dynamic-ai-scheduler.service.ts
var __esDecorate = (this && this.__esDecorate) || function (ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {
    function accept(f) { if (f !== void 0 && typeof f !== "function") throw new TypeError("Function expected"); return f; }
    var kind = contextIn.kind, key = kind === "getter" ? "get" : kind === "setter" ? "set" : "value";
    var target = !descriptorIn && ctor ? contextIn["static"] ? ctor : ctor.prototype : null;
    var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});
    var _, done = false;
    for (var i = decorators.length - 1; i >= 0; i--) {
        var context = {};
        for (var p in contextIn) context[p] = p === "access" ? {} : contextIn[p];
        for (var p in contextIn.access) context.access[p] = contextIn.access[p];
        context.addInitializer = function (f) { if (done) throw new TypeError("Cannot add initializers after decoration has completed"); extraInitializers.push(accept(f || null)); };
        var result = (0, decorators[i])(kind === "accessor" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);
        if (kind === "accessor") {
            if (result === void 0) continue;
            if (result === null || typeof result !== "object") throw new TypeError("Object expected");
            if (_ = accept(result.get)) descriptor.get = _;
            if (_ = accept(result.set)) descriptor.set = _;
            if (_ = accept(result.init)) initializers.unshift(_);
        }
        else if (_ = accept(result)) {
            if (kind === "field") initializers.unshift(_);
            else descriptor[key] = _;
        }
    }
    if (target) Object.defineProperty(target, contextIn.name, descriptor);
    done = true;
};
var __runInitializers = (this && this.__runInitializers) || function (thisArg, initializers, value) {
    var useValue = arguments.length > 2;
    for (var i = 0; i < initializers.length; i++) {
        value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);
    }
    return useValue ? value : void 0;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DynamicAiSchedulerService = void 0;
const common_1 = require("@nestjs/common");
let DynamicAiSchedulerService = (() => {
    let _classDecorators = [(0, common_1.Injectable)()];
    let _classDescriptor;
    let _classExtraInitializers = [];
    let _classThis;
    var DynamicAiSchedulerService = class {
        static { _classThis = this; }
        static {
            const _metadata = typeof Symbol === "function" && Symbol.metadata ? Object.create(null) : void 0;
            __esDecorate(null, _classDescriptor = { value: _classThis }, _classDecorators, { kind: "class", name: _classThis.name, metadata: _metadata }, null, _classExtraInitializers);
            DynamicAiSchedulerService = _classThis = _classDescriptor.value;
            if (_metadata) Object.defineProperty(_classThis, Symbol.metadata, { enumerable: true, configurable: true, writable: true, value: _metadata });
            __runInitializers(_classThis, _classExtraInitializers);
        }
        prisma;
        aiProviderFactory;
        configService;
        logger = new common_1.Logger(DynamicAiSchedulerService.name);
        constructor(prisma, aiProviderFactory, configService) {
            this.prisma = prisma;
            this.aiProviderFactory = aiProviderFactory;
            this.configService = configService;
        }
        async getProviderForRole(user, role) {
            this.logger.debug(`[Scheduler] New request for role: "${role}" from user ${user.id}`);
            // [!] 核心改造 1: 查询逻辑翻译
            // 我们不再查询一个字符串数组，而是查询一个关系。
            // 我们要找的是：一个 AiConfiguration，它的 'roles' 关系中，
            // 'some' (至少有一个) Role 的 'name' 字段等于我们想要的 'role'。
            const dedicatedConfig = await this.prisma.aiConfiguration.findFirst({
                where: {
                    ownerId: user.id,
                    roles: {
                        some: {
                            name: role, // 这就是新的、正确的 Prisma 关系查询语法
                        },
                    },
                },
            });
            if (dedicatedConfig) {
                this.logger.log(`[Scheduler] Priority 1 (Dedicated): Found dedicated config "${dedicatedConfig.provider}/${dedicatedConfig.modelId}" for role "${role}".`);
                return this.aiProviderFactory.createProvider(dedicatedConfig);
            }
            this.logger.debug(`[Scheduler] Priority 1 (Dedicated): No dedicated AI found for role "${role}".`);
            // 优先级 2: 征用逻辑保持不变
            const anyUserConfig = await this.prisma.aiConfiguration.findFirst({
                where: { ownerId: user.id },
                orderBy: { createdAt: 'asc' },
            });
            if (anyUserConfig) {
                this.logger.log(`[Scheduler] Priority 2 (Requisition): Requisitioning general-purpose AI "${anyUserConfig.provider}/${anyUserConfig.modelId}" for role "${role}".`);
                return this.aiProviderFactory.createProvider(anyUserConfig);
            }
            this.logger.debug(`[Scheduler] Priority 2 (Requisition): User has no AI configurations at all.`);
            // 优先级 3: 后备逻辑保持不变，但模拟对象结构需要改变
            this.logger.warn(`[Scheduler] Priority 3 (System Fallback): Falling back to system default AI for role "${role}".`);
            try {
                return this.createFallbackProvider();
            }
            catch (error) {
                this.logger.error(`[Scheduler] CRITICAL FAILURE: System fallback AI failed to initialize.`, error instanceof Error ? error.stack : undefined);
                throw new common_1.InternalServerErrorException('AI processing failed: No AI is available or configured correctly.');
            }
        }
        createFallbackProvider() {
            try {
                // 优先使用专门的DeepSeek配置，如果没有则使用后备配置
                const apiKey = this.configService.get('DEEPSEEK_API_KEY') ||
                    this.configService.getOrThrow('FALLBACK_API_KEY');
                const modelId = this.configService.get('FALLBACK_MODEL_ID', 'deepseek-chat');
                const baseUrlFromEnv = this.configService.get('DEEPSEEK_BASE_URL') ||
                    this.configService.get('FALLBACK_BASE_URL');
                // [!] 核心改造 2: 模拟对象结构翻译
                // 新的 AiConfiguration 类型没有 `assignedRoles` 字段。
                // 我们创建一个不包含任何角色信息的、纯粹的配置对象。
                // 注意：这个模拟对象缺少 'roles' 属性，所以我们需要告诉 TypeScript
                // 它符合 AiConfiguration 的形状（通过类型断言 as AiConfiguration）。
                const fallbackConfig = {
                    id: 'system-fallback',
                    provider: 'DeepSeek',
                    apiKey,
                    baseUrl: baseUrlFromEnv ?? null,
                    modelId,
                    ownerId: 'system',
                    createdAt: new Date(),
                    updatedAt: new Date(),
                }; // 类型断言，表示我们确信这个对象的结构是兼容的
                return this.aiProviderFactory.createProvider(fallbackConfig);
            }
            catch (error) {
                this.logger.error('System fallback AI configuration is missing or invalid. Check your .env file for FALLBACK_... variables.', error);
                throw new Error('System default AI is not configured.');
            }
        }
    };
    return DynamicAiSchedulerService = _classThis;
})();
exports.DynamicAiSchedulerService = DynamicAiSchedulerService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxhaVxcZHluYW1pYy1haS1zY2hlZHVsZXIuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiO0FBQUEsdUVBQXVFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRXZFLDJDQUFpRjtJQVFwRSx5QkFBeUI7NEJBRHJDLElBQUEsbUJBQVUsR0FBRTs7Ozs7Ozs7WUFDYiw2S0FzR0M7OztZQXRHWSx1REFBeUI7O1FBSWpCLE1BQU07UUFDTixpQkFBaUI7UUFDakIsYUFBYTtRQUxmLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVwRSxZQUNtQixNQUFxQixFQUNyQixpQkFBb0MsRUFDcEMsYUFBNEI7WUFGNUIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtZQUNyQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1lBQ3BDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVDLENBQUM7UUFFRyxLQUFLLENBQUMsa0JBQWtCLENBQUMsSUFBVSxFQUFFLElBQVk7WUFDdEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsc0NBQXNDLElBQUksZUFBZSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtZQUVyRixxQkFBcUI7WUFDckIsMEJBQTBCO1lBQzFCLDRDQUE0QztZQUM1QyxpREFBaUQ7WUFDakQsTUFBTSxlQUFlLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUM7Z0JBQ2xFLEtBQUssRUFBRTtvQkFDTCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUU7b0JBQ2hCLEtBQUssRUFBRTt3QkFDTCxJQUFJLEVBQUU7NEJBQ0osSUFBSSxFQUFFLElBQUksRUFBRSwwQkFBMEI7eUJBQ3ZDO3FCQUNGO2lCQUNGO2FBQ0YsQ0FBQyxDQUFBO1lBRUYsSUFBSSxlQUFlLEVBQUUsQ0FB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QUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2YsMEdBQTBHLEVBQzFHLEtBQUssQ0FDTixDQUFBO2dCQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsc0NBQXNDLENBQUMsQ0FBQTtZQUN6RCxDQUFDO1FBQ0gsQ0FBQzs7OztBQXJHVSw4REFBeUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxhaVxcZHluYW1pYy1haS1zY2hlZHVsZXIuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyDmlofku7bot6/lvoQ6IHBhY2thZ2VzL2NvbW1vbi1iYWNrZW5kL3NyYy9haS9keW5hbWljLWFpLXNjaGVkdWxlci5zZXJ2aWNlLnRzXG5cbmltcG9ydCB7IEluamVjdGFibGUsIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJ1xuaW1wb3J0IHR5cGUgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnXG5pbXBvcnQgdHlwZSB7IEFpQ29uZmlndXJhdGlvbiwgVXNlciB9IGZyb20gJ0BwcmlzbWEvY2xpZW50J1xuaW1wb3J0IHR5cGUgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJpc21hL3ByaXNtYS5zZXJ2aWNlJ1xuaW1wb3J0IHR5cGUgeyBBaVByb3ZpZGVyLCBBaVJvbGUgfSBmcm9tICcuLi90eXBlcy9haS1wcm92aWRlcnMudHlwZXMnXG5pbXBvcnQgdHlwZSB7IEFpUHJvdmlkZXJGYWN0b3J5IH0gZnJvbSAnLi9haS1wcm92aWRlci5mYWN0b3J5J1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRHluYW1pY0FpU2NoZWR1bGVyU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlLm5hbWUpXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhaVByb3ZpZGVyRmFjdG9yeTogQWlQcm92aWRlckZhY3RvcnksXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlXG4gICkge31cblxuICBwdWJsaWMgYXN5bmMgZ2V0UHJvdmlkZXJGb3JSb2xlKHVzZXI6IFVzZXIsIHJvbGU6IEFpUm9sZSk6IFByb21pc2U8QWlQcm92aWRlcj4ge1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBbU2NoZWR1bGVyXSBOZXcgcmVxdWVzdCBmb3Igcm9sZTogXCIke3JvbGV9XCIgZnJvbSB1c2VyICR7dXNlci5pZH1gKVxuXG4gICAgLy8gWyFdIOaguOW/g+aUuemAoCAxOiDmn6Xor6LpgLvovpHnv7vor5FcbiAgICAvLyDmiJHku6zkuI3lho3mn6Xor6LkuIDkuKrlrZfnrKbkuLLmlbDnu4TvvIzogIzmmK/mn6Xor6LkuIDkuKrlhbPns7vjgIJcbiAgICAvLyDmiJHku6zopoHmib7nmoTmmK/vvJrkuIDkuKogQWlDb25maWd1cmF0aW9u77yM5a6D55qEICdyb2xlcycg5YWz57O75Lit77yMXG4gICAgLy8gJ3NvbWUnICjoh7PlsJHmnInkuIDkuKopIFJvbGUg55qEICduYW1lJyDlrZfmrrXnrYnkuo7miJHku6zmg7PopoHnmoQgJ3JvbGUn44CCXG4gICAgY29uc3QgZGVkaWNhdGVkQ29uZmlnID0gYXdhaXQgdGhpcy5wcmlzbWEuYWlDb25maWd1cmF0aW9uLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBvd25lcklkOiB1c2VyLmlkLFxuICAgICAgICByb2xlczoge1xuICAgICAgICAgIHNvbWU6IHtcbiAgICAgICAgICAgIG5hbWU6IHJvbGUsIC8vIOi/meWwseaYr+aWsOeahOOAgeato+ehrueahCBQcmlzbWEg5YWz57O75p+l6K+i6K+t5rOVXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSlcblxuICAgIGlmIChkZWRpY2F0ZWRDb25maWcpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYFtTY2hlZHVsZXJdIFByaW9yaXR5IDEgKERlZGljYXRlZCk6IEZvdW5kIGRlZGljYXRlZCBjb25maWcgXCIke2RlZGljYXRlZENvbmZpZy5wcm92aWRlcn0vJHtkZWRpY2F0ZWRDb25maWcubW9kZWxJZH1cIiBmb3Igcm9sZSBcIiR7cm9sZX1cIi5gXG4gICAgICApXG4gICAgICByZXR1cm4gdGhpcy5haVByb3ZpZGVyRmFjdG9yeS5jcmVhdGVQcm92aWRlcihkZWRpY2F0ZWRDb25maWcpXG4gICAgfVxuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYFtTY2hlZHVsZXJdIFByaW9yaXR5IDEgKERlZGljYXRlZCk6IE5vIGRlZGljYXRlZCBBSSBmb3VuZCBmb3Igcm9sZSBcIiR7cm9sZX1cIi5gXG4gICAgKVxuXG4gICAgLy8g5LyY5YWI57qnIDI6IOW+geeUqOmAu+i+keS/neaMgeS4jeWPmFxuICAgIGNvbnN0IGFueVVzZXJDb25maWcgPSBhd2FpdCB0aGlzLnByaXNtYS5haUNvbmZpZ3VyYXRpb24uZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7IG93bmVySWQ6IHVzZXIuaWQgfSxcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnYXNjJyB9LFxuICAgIH0pXG5cbiAgICBpZiAoYW55VXNlckNvbmZpZykge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgW1NjaGVkdWxlcl0gUHJpb3JpdHkgMiAoUmVxdWlzaXRpb24pOiBSZXF1aXNpdGlvbmluZyBnZW5lcmFsLXB1cnBvc2UgQUkgXCIke2FueVVzZXJDb25maWcucHJvdmlkZXJ9LyR7YW55VXNlckNvbmZpZy5tb2RlbElkfVwiIGZvciByb2xlIFwiJHtyb2xlfVwiLmBcbiAgICAgIClcbiAgICAgIHJldHVybiB0aGlzLmFpUHJvdmlkZXJGYWN0b3J5LmNyZWF0ZVByb3ZpZGVyKGFueVVzZXJDb25maWcpXG4gICAgfVxuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBbU2NoZWR1bGVyXSBQcmlvcml0eSAyIChSZXF1aXNpdGlvbik6IFVzZXIgaGFzIG5vIEFJIGNvbmZpZ3VyYXRpb25zIGF0IGFsbC5gKVxuXG4gICAgLy8g5LyY5YWI57qnIDM6IOWQjuWkh+mAu+i+keS/neaMgeS4jeWPmO+8jOS9huaooeaLn+Wvueixoee7k+aehOmcgOimgeaUueWPmFxuICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICBgW1NjaGVkdWxlcl0gUHJpb3JpdHkgMyAoU3lzdGVtIEZhbGxiYWNrKTogRmFsbGluZyBiYWNrIHRvIHN5c3RlbSBkZWZhdWx0IEFJIGZvciByb2xlIFwiJHtyb2xlfVwiLmBcbiAgICApXG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUZhbGxiYWNrUHJvdmlkZXIoKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYFtTY2hlZHVsZXJdIENSSVRJQ0FMIEZBSUxVUkU6IFN5c3RlbSBmYWxsYmFjayBBSSBmYWlsZWQgdG8gaW5pdGlhbGl6ZS5gLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3Iuc3RhY2sgOiB1bmRlZmluZWRcbiAgICAgIClcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnQUkgcHJvY2Vzc2luZyBmYWlsZWQ6IE5vIEFJIGlzIGF2YWlsYWJsZSBvciBjb25maWd1cmVkIGNvcnJlY3RseS4nXG4gICAgICApXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVGYWxsYmFja1Byb3ZpZGVyKCk6IEFpUHJvdmlkZXIge1xuICAgIHRyeSB7XG4gICAgICAvLyDkvJjlhYjkvb/nlKjkuJPpl6jnmoREZWVwU2Vla+mFjee9ru+8jOWmguaenOayoeacieWImeS9v+eUqOWQjuWkh+mFjee9rlxuICAgICAgY29uc3QgYXBpS2V5ID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdERUVQU0VFS19BUElfS0VZJykgfHxcbiAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnU2VydmljZS5nZXRPclRocm93PHN0cmluZz4oJ0ZBTExCQUNLX0FQSV9LRVknKVxuICAgICAgY29uc3QgbW9kZWxJZCA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignRkFMTEJBQ0tfTU9ERUxfSUQnLCAnZGVlcHNlZWstY2hhdCcpXG4gICAgICBjb25zdCBiYXNlVXJsRnJvbUVudiA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignREVFUFNFRUtfQkFTRV9VUkwnKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0ZBTExCQUNLX0JBU0VfVVJMJylcblxuICAgICAgLy8gWyFdIOaguOW/g+aUuemAoCAyOiDmqKHmi5/lr7nosaHnu5PmnoTnv7vor5FcbiAgICAgIC8vIOaWsOeahCBBaUNvbmZpZ3VyYXRpb24g57G75Z6L5rKh5pyJIGBhc3NpZ25lZFJvbGVzYCDlrZfmrrXjgIJcbiAgICAgIC8vIOaIkeS7rOWIm+W7uuS4gOS4quS4jeWMheWQq+S7u+S9leinkuiJsuS/oeaBr+eahOOAgee6r+eyueeahOmFjee9ruWvueixoeOAglxuICAgICAgLy8g5rOo5oSP77ya6L+Z5Liq5qih5ouf5a+56LGh57y65bCRICdyb2xlcycg5bGe5oCn77yM5omA5Lul5oiR5Lus6ZyA6KaB5ZGK6K+JIFR5cGVTY3JpcHRcbiAgICAgIC8vIOWug+espuWQiCBBaUNvbmZpZ3VyYXRpb24g55qE5b2i54q277yI6YCa6L+H57G75Z6L5pat6KiAIGFzIEFpQ29uZmlndXJhdGlvbu+8ieOAglxuICAgICAgY29uc3QgZmFsbGJhY2tDb25maWcgPSB7XG4gICAgICAgIGlkOiAnc3lzdGVtLWZhbGxiYWNrJyxcbiAgICAgICAgcHJvdmlkZXI6ICdEZWVwU2VlaycsXG4gICAgICAgIGFwaUtleSxcbiAgICAgICAgYmFzZVVybDogYmFzZVVybEZyb21FbnYgPz8gbnVsbCxcbiAgICAgICAgbW9kZWxJZCxcbiAgICAgICAgb3duZXJJZDogJ3N5c3RlbScsXG4gICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSBhcyBBaUNvbmZpZ3VyYXRpb24gLy8g57G75Z6L5pat6KiA77yM6KGo56S65oiR5Lus56Gu5L+h6L+Z5Liq5a+56LGh55qE57uT5p6E5piv5YW85a6555qEXG5cbiAgICAgIHJldHVybiB0aGlzLmFpUHJvdmlkZXJGYWN0b3J5LmNyZWF0ZVByb3ZpZGVyKGZhbGxiYWNrQ29uZmlnKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgJ1N5c3RlbSBmYWxsYmFjayBBSSBjb25maWd1cmF0aW9uIGlzIG1pc3Npbmcgb3IgaW52YWxpZC4gQ2hlY2sgeW91ciAuZW52IGZpbGUgZm9yIEZBTExCQUNLXy4uLiB2YXJpYWJsZXMuJyxcbiAgICAgICAgZXJyb3JcbiAgICAgIClcbiAgICAgIHRocm93IG5ldyBFcnJvcignU3lzdGVtIGRlZmF1bHQgQUkgaXMgbm90IGNvbmZpZ3VyZWQuJylcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==