aeafb8a7fea4728c85a3ef5e2555b617
"use strict";
// 文件路径: packages/common-backend/src/errors/websocket-error-helper.ts
// 职责: 将处理错误转换为 WebSocket 友好的错误事件载荷
//
// 核心功能:
// 1. 将 ProcessingErrorResponse 转换为 WebSocket 事件数据
// 2. 生成用户友好的错误消息
// 3. 提供前端错误处理的标准化格式
Object.defineProperty(exports, "__esModule", { value: true });
exports.formatErrorForWebSocket = formatErrorForWebSocket;
const error_classification_1 = require("./error-classification");
/**
 * 将 ProcessingErrorResponse 转换为 WebSocket 事件载荷
 *
 * @param errorResponse - 标准化的错误响应
 * @param correlationId - 关联ID（可选）
 * @returns WebSocket 友好的错误事件载荷
 *
 * @remarks
 * 此函数确保：
 * 1. 错误信息对用户友好
 * 2. 前端可以根据 errorCode 显示不同的 UI
 * 3. 用户知道是否应该重试以及如何操作
 *
 * @example
 * ```typescript
 * const errorResponse = classifyProcessingError(error);
 * const eventPayload = formatErrorForWebSocket(errorResponse, correlationId);
 *
 * eventBus.publish('NOTIFY_USER', {
 *   userId,
 *   event: 'processing_failed',
 *   data: eventPayload,
 * });
 * ```
 */
function formatErrorForWebSocket(errorResponse, correlationId, originalError) {
    // 根据错误类型生成更友好的消息
    const friendlyMessage = getFriendlyErrorMessage(errorResponse);
    return {
        errorCode: errorResponse.errorCode,
        errorMessage: friendlyMessage,
        retryable: errorResponse.retryable,
        suggestedAction: errorResponse.suggestedAction,
        correlationId,
        errorType: errorResponse.errorType,
        originalError,
    };
}
/**
 * 根据错误类型生成用户友好的错误消息
 *
 * @param errorResponse - 错误响应
 * @returns 用户友好的错误消息
 *
 * @remarks
 * 不同错误类型对应不同的用户消息：
 * - VALIDATION_ERROR: "输入格式错误"
 * - AI_GENERATION_ERROR: "AI 生成失败，请重试"
 * - NETWORK_ERROR: "网络连接失败，请检查网络后重试"
 * - DATABASE_ERROR: "数据服务暂时不可用，请稍后重试"
 * - BUSINESS_LOGIC_ERROR: "处理失败，请检查输入"
 */
function getFriendlyErrorMessage(errorResponse) {
    // 如果已经有建议的操作，优先使用原始消息
    if (errorResponse.suggestedAction) {
        return errorResponse.message;
    }
    // 根据错误类型返回本地化的友好消息
    switch (errorResponse.errorType) {
        case error_classification_1.ProcessingErrorType.VALIDATION_ERROR:
            return '输入格式错误，请检查后重试';
        case error_classification_1.ProcessingErrorType.AI_GENERATION_ERROR:
            return 'AI 处理失败，系统将自动重试。如果问题持续，请联系支持';
        case error_classification_1.ProcessingErrorType.NETWORK_ERROR:
            return '网络连接失败，请检查网络连接后重试';
        case error_classification_1.ProcessingErrorType.DATABASE_ERROR:
            return '数据服务暂时不可用，请稍后重试';
        case error_classification_1.ProcessingErrorType.BUSINESS_LOGIC_ERROR:
            return '处理失败，请检查输入是否正确';
        default:
            return errorResponse.message || '处理失败，请稍后重试';
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxlcnJvcnNcXHdlYnNvY2tldC1lcnJvci1oZWxwZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHFFQUFxRTtBQUNyRSxtQ0FBbUM7QUFDbkMsRUFBRTtBQUNGLFFBQVE7QUFDUixrREFBa0Q7QUFDbEQsaUJBQWlCO0FBQ2pCLG9CQUFvQjs7QUF3RHBCLDBEQWlCQztBQXZFRCxpRUFBMEY7QUE2QjFGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F3Qkc7QUFDSCxTQUFnQix1QkFBdUIsQ0FDckMsYUFBc0MsRUFDdEMsYUFBc0IsRUFDdEIsYUFBc0I7SUFFdEIsaUJBQWlCO0lBQ2pCLE1BQU0sZUFBZSxHQUFHLHVCQUF1QixDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBRTlELE9BQU87UUFDTCxTQUFTLEVBQUUsYUFBYSxDQUFDLFNBQVM7UUFDbEMsWUFBWSxFQUFFLGVBQWU7UUFDN0IsU0FBUyxFQUFFLGFBQWEsQ0FBQyxTQUFTO1FBQ2xDLGVBQWUsRUFBRSxhQUFhLENBQUMsZUFBZTtRQUM5QyxhQUFhO1FBQ2IsU0FBUyxFQUFFLGFBQWEsQ0FBQyxTQUFTO1FBQ2xDLGFBQWE7S0FDZCxDQUFBO0FBQ0gsQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7O0dBYUc7QUFDSCxTQUFTLHVCQUF1QixDQUFDLGFBQXNDO0lBQ3JFLHNCQUFzQjtJQUN0QixJQUFJLGFBQWEsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUNsQyxPQUFPLGFBQWEsQ0FBQyxPQUFPLENBQUE7SUFDOUIsQ0FBQztJQUVELG1CQUFtQjtJQUNuQixRQUFRLGFBQWEsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNoQyxLQUFLLDBDQUFtQixDQUFDLGdCQUFnQjtZQUN2QyxPQUFPLGVBQWUsQ0FBQTtRQUV4QixLQUFLLDBDQUFtQixDQUFDLG1CQUFtQjtZQUMxQyxPQUFPLDhCQUE4QixDQUFBO1FBRXZDLEtBQUssMENBQW1CLENBQUMsYUFBYTtZQUNwQyxPQUFPLG1CQUFtQixDQUFBO1FBRTVCLEtBQUssMENBQW1CLENBQUMsY0FBYztZQUNyQyxPQUFPLGlCQUFpQixDQUFBO1FBRTFCLEtBQUssMENBQW1CLENBQUMsb0JBQW9CO1lBQzNDLE9BQU8sZ0JBQWdCLENBQUE7UUFFekI7WUFDRSxPQUFPLGFBQWEsQ0FBQyxPQUFPLElBQUksWUFBWSxDQUFBO0lBQ2hELENBQUM7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxwYWNrYWdlc1xcY29tbW9uLWJhY2tlbmRcXHNyY1xcZXJyb3JzXFx3ZWJzb2NrZXQtZXJyb3ItaGVscGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL2Vycm9ycy93ZWJzb2NrZXQtZXJyb3ItaGVscGVyLnRzXG4vLyDogYzotKM6IOWwhuWkhOeQhumUmeivr+i9rOaNouS4uiBXZWJTb2NrZXQg5Y+L5aW955qE6ZSZ6K+v5LqL5Lu26L296I23XG4vL1xuLy8g5qC45b+D5Yqf6IO9OlxuLy8gMS4g5bCGIFByb2Nlc3NpbmdFcnJvclJlc3BvbnNlIOi9rOaNouS4uiBXZWJTb2NrZXQg5LqL5Lu25pWw5o2uXG4vLyAyLiDnlJ/miJDnlKjmiLflj4vlpb3nmoTplJnor6/mtojmga9cbi8vIDMuIOaPkOS+m+WJjeerr+mUmeivr+WkhOeQhueahOagh+WHhuWMluagvOW8j1xuXG5pbXBvcnQgeyB0eXBlIFByb2Nlc3NpbmdFcnJvclJlc3BvbnNlLCBQcm9jZXNzaW5nRXJyb3JUeXBlIH0gZnJvbSAnLi9lcnJvci1jbGFzc2lmaWNhdGlvbidcblxuLyoqXG4gKiBXZWJTb2NrZXQgcHJvY2Vzc2luZ19mYWlsZWQg5LqL5Lu255qE5qCH5YeG6L296I23XG4gKlxuICogQHByb3BlcnR5IGVycm9yQ29kZSAtIOmUmeivr+WIhuexu+egge+8iOWJjeerr+WPr+agueaNruatpOaYvuekuuS4jeWQjFVJ77yJXG4gKiBAcHJvcGVydHkgZXJyb3JNZXNzYWdlIC0g55So5oi35Y+L5aW955qE6ZSZ6K+v5L+h5oGvXG4gKiBAcHJvcGVydHkgcmV0cnlhYmxlIC0g5piv5ZCm5Y+v6YeN6K+VXG4gKiBAcHJvcGVydHkgc3VnZ2VzdGVkQWN0aW9uIC0g5bu66K6u55qE55So5oi35pON5L2cXG4gKiBAcHJvcGVydHkgY29ycmVsYXRpb25JZCAtIOWFs+iBlElE77yI55So5LqO6L+96Liq77yJXG4gKiBAcHJvcGVydHkgZXJyb3JUeXBlIC0g6ZSZ6K+v57G75Z6L77yI55So5LqO6LCD6K+V77yJXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUHJvY2Vzc2luZ0ZhaWxlZEV2ZW50UGF5bG9hZCB7XG4gIC8qKiDplJnor6/liIbnsbvnoIEgKi9cbiAgZXJyb3JDb2RlOiBzdHJpbmdcbiAgLyoqIOeUqOaIt+WPi+WlveeahOmUmeivr+S/oeaBryAqL1xuICBlcnJvck1lc3NhZ2U6IHN0cmluZ1xuICAvKiog5piv5ZCm5Y+v6YeN6K+VICovXG4gIHJldHJ5YWJsZTogYm9vbGVhblxuICAvKiog5bu66K6u55qE55So5oi35pON5L2cICovXG4gIHN1Z2dlc3RlZEFjdGlvbj86IHN0cmluZ1xuICAvKiog5YWz6IGUSUTvvIjnlKjkuo7ov73ouKrvvIkgKi9cbiAgY29ycmVsYXRpb25JZD86IHN0cmluZ1xuICAvKiog6ZSZ6K+v57G75Z6L77yI55So5LqO6LCD6K+V5ZKM5pel5b+X77yJICovXG4gIGVycm9yVHlwZT86IFByb2Nlc3NpbmdFcnJvclR5cGVcbiAgLyoqIOWOn+Wni+mUmeivr+a2iOaBr++8iOeUqOS6juiwg+ivle+8jOWPr+mAie+8iSAqL1xuICBvcmlnaW5hbEVycm9yPzogc3RyaW5nXG59XG5cbi8qKlxuICog5bCGIFByb2Nlc3NpbmdFcnJvclJlc3BvbnNlIOi9rOaNouS4uiBXZWJTb2NrZXQg5LqL5Lu26L296I23XG4gKlxuICogQHBhcmFtIGVycm9yUmVzcG9uc2UgLSDmoIflh4bljJbnmoTplJnor6/lk43lupRcbiAqIEBwYXJhbSBjb3JyZWxhdGlvbklkIC0g5YWz6IGUSUTvvIjlj6/pgInvvIlcbiAqIEByZXR1cm5zIFdlYlNvY2tldCDlj4vlpb3nmoTplJnor6/kuovku7bovb3ojbdcbiAqXG4gKiBAcmVtYXJrc1xuICog5q2k5Ye95pWw56Gu5L+d77yaXG4gKiAxLiDplJnor6/kv6Hmga/lr7nnlKjmiLflj4vlpb1cbiAqIDIuIOWJjeerr+WPr+S7peagueaNriBlcnJvckNvZGUg5pi+56S65LiN5ZCM55qEIFVJXG4gKiAzLiDnlKjmiLfnn6XpgZPmmK/lkKblupTor6Xph43or5Xku6Xlj4rlpoLkvZXmk43kvZxcbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogY29uc3QgZXJyb3JSZXNwb25zZSA9IGNsYXNzaWZ5UHJvY2Vzc2luZ0Vycm9yKGVycm9yKTtcbiAqIGNvbnN0IGV2ZW50UGF5bG9hZCA9IGZvcm1hdEVycm9yRm9yV2ViU29ja2V0KGVycm9yUmVzcG9uc2UsIGNvcnJlbGF0aW9uSWQpO1xuICpcbiAqIGV2ZW50QnVzLnB1Ymxpc2goJ05PVElGWV9VU0VSJywge1xuICogICB1c2VySWQsXG4gKiAgIGV2ZW50OiAncHJvY2Vzc2luZ19mYWlsZWQnLFxuICogICBkYXRhOiBldmVudFBheWxvYWQsXG4gKiB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0RXJyb3JGb3JXZWJTb2NrZXQoXG4gIGVycm9yUmVzcG9uc2U6IFByb2Nlc3NpbmdFcnJvclJlc3BvbnNlLFxuICBjb3JyZWxhdGlvbklkPzogc3RyaW5nLFxuICBvcmlnaW5hbEVycm9yPzogc3RyaW5nXG4pOiBQcm9jZXNzaW5nRmFpbGVkRXZlbnRQYXlsb2FkIHtcbiAgLy8g5qC55o2u6ZSZ6K+v57G75Z6L55Sf5oiQ5pu05Y+L5aW955qE5raI5oGvXG4gIGNvbnN0IGZyaWVuZGx5TWVzc2FnZSA9IGdldEZyaWVuZGx5RXJyb3JNZXNzYWdlKGVycm9yUmVzcG9uc2UpXG5cbiAgcmV0dXJuIHtcbiAgICBlcnJvckNvZGU6IGVycm9yUmVzcG9uc2UuZXJyb3JDb2RlLFxuICAgIGVycm9yTWVzc2FnZTogZnJpZW5kbHlNZXNzYWdlLFxuICAgIHJldHJ5YWJsZTogZXJyb3JSZXNwb25zZS5yZXRyeWFibGUsXG4gICAgc3VnZ2VzdGVkQWN0aW9uOiBlcnJvclJlc3BvbnNlLnN1Z2dlc3RlZEFjdGlvbixcbiAgICBjb3JyZWxhdGlvbklkLFxuICAgIGVycm9yVHlwZTogZXJyb3JSZXNwb25zZS5lcnJvclR5cGUsXG4gICAgb3JpZ2luYWxFcnJvcixcbiAgfVxufVxuXG4vKipcbiAqIOagueaNrumUmeivr+exu+Wei+eUn+aIkOeUqOaIt+WPi+WlveeahOmUmeivr+a2iOaBr1xuICpcbiAqIEBwYXJhbSBlcnJvclJlc3BvbnNlIC0g6ZSZ6K+v5ZON5bqUXG4gKiBAcmV0dXJucyDnlKjmiLflj4vlpb3nmoTplJnor6/mtojmga9cbiAqXG4gKiBAcmVtYXJrc1xuICog5LiN5ZCM6ZSZ6K+v57G75Z6L5a+55bqU5LiN5ZCM55qE55So5oi35raI5oGv77yaXG4gKiAtIFZBTElEQVRJT05fRVJST1I6IFwi6L6T5YWl5qC85byP6ZSZ6K+vXCJcbiAqIC0gQUlfR0VORVJBVElPTl9FUlJPUjogXCJBSSDnlJ/miJDlpLHotKXvvIzor7fph43or5VcIlxuICogLSBORVRXT1JLX0VSUk9SOiBcIue9kee7nOi/nuaOpeWksei0pe+8jOivt+ajgOafpee9kee7nOWQjumHjeivlVwiXG4gKiAtIERBVEFCQVNFX0VSUk9SOiBcIuaVsOaNruacjeWKoeaaguaXtuS4jeWPr+eUqO+8jOivt+eojeWQjumHjeivlVwiXG4gKiAtIEJVU0lORVNTX0xPR0lDX0VSUk9SOiBcIuWkhOeQhuWksei0pe+8jOivt+ajgOafpei+k+WFpVwiXG4gKi9cbmZ1bmN0aW9uIGdldEZyaWVuZGx5RXJyb3JNZXNzYWdlKGVycm9yUmVzcG9uc2U6IFByb2Nlc3NpbmdFcnJvclJlc3BvbnNlKTogc3RyaW5nIHtcbiAgLy8g5aaC5p6c5bey57uP5pyJ5bu66K6u55qE5pON5L2c77yM5LyY5YWI5L2/55So5Y6f5aeL5raI5oGvXG4gIGlmIChlcnJvclJlc3BvbnNlLnN1Z2dlc3RlZEFjdGlvbikge1xuICAgIHJldHVybiBlcnJvclJlc3BvbnNlLm1lc3NhZ2VcbiAgfVxuXG4gIC8vIOagueaNrumUmeivr+exu+Wei+i/lOWbnuacrOWcsOWMlueahOWPi+Wlvea2iOaBr1xuICBzd2l0Y2ggKGVycm9yUmVzcG9uc2UuZXJyb3JUeXBlKSB7XG4gICAgY2FzZSBQcm9jZXNzaW5nRXJyb3JUeXBlLlZBTElEQVRJT05fRVJST1I6XG4gICAgICByZXR1cm4gJ+i+k+WFpeagvOW8j+mUmeivr++8jOivt+ajgOafpeWQjumHjeivlSdcblxuICAgIGNhc2UgUHJvY2Vzc2luZ0Vycm9yVHlwZS5BSV9HRU5FUkFUSU9OX0VSUk9SOlxuICAgICAgcmV0dXJuICdBSSDlpITnkIblpLHotKXvvIzns7vnu5/lsIboh6rliqjph43or5XjgILlpoLmnpzpl67popjmjIHnu63vvIzor7fogZTns7vmlK/mjIEnXG5cbiAgICBjYXNlIFByb2Nlc3NpbmdFcnJvclR5cGUuTkVUV09SS19FUlJPUjpcbiAgICAgIHJldHVybiAn572R57uc6L+e5o6l5aSx6LSl77yM6K+35qOA5p+l572R57uc6L+e5o6l5ZCO6YeN6K+VJ1xuXG4gICAgY2FzZSBQcm9jZXNzaW5nRXJyb3JUeXBlLkRBVEFCQVNFX0VSUk9SOlxuICAgICAgcmV0dXJuICfmlbDmja7mnI3liqHmmoLml7bkuI3lj6/nlKjvvIzor7fnqI3lkI7ph43or5UnXG5cbiAgICBjYXNlIFByb2Nlc3NpbmdFcnJvclR5cGUuQlVTSU5FU1NfTE9HSUNfRVJST1I6XG4gICAgICByZXR1cm4gJ+WkhOeQhuWksei0pe+8jOivt+ajgOafpei+k+WFpeaYr+WQpuato+ehridcblxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gZXJyb3JSZXNwb25zZS5tZXNzYWdlIHx8ICflpITnkIblpLHotKXvvIzor7fnqI3lkI7ph43or5UnXG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==