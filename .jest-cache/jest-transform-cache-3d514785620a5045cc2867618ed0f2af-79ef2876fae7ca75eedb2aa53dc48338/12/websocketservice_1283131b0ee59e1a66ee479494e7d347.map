{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\websocket.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\websocket.service.ts"],"sourcesContent":["// ============================================================================\n// WebSocket通信服务集成\n// 集成 VCPToolBox 的实时通信能力到创世星环\n// ============================================================================\n\nimport { Injectable, Logger, type OnModuleDestroy, type OnModuleInit } from '@nestjs/common'\nimport type { ConfigService } from '@nestjs/config'\nimport {\n  type WSMessage,\n  webSocketCommunication,\n} from '../../../apps/vcptoolbox/src/modules/communication/WebSocketCommunication'\n\n@Injectable()\nexport class WebSocketService implements OnModuleInit, OnModuleDestroy {\n  private readonly logger = new Logger(WebSocketService.name)\n  private serverStarted = false\n\n  constructor(private configService: ConfigService) {}\n\n  async onModuleInit() {\n    await this.initializeWebSocketServer()\n    this.setupEventHandlers()\n    this.logger.log('WebSocket通信服务已初始化')\n  }\n\n  async onModuleDestroy() {\n    if (this.serverStarted) {\n      await webSocketCommunication.stop()\n      this.logger.log('WebSocket通信服务已停止')\n    }\n  }\n\n  // ==================== 服务器管理 ====================\n\n  /**\n   * 初始化WebSocket服务器\n   */\n  private async initializeWebSocketServer(): Promise<void> {\n    try {\n      const port = this.configService.get('WEBSOCKET_PORT', 8080)\n      const host = this.configService.get('WEBSOCKET_HOST', 'localhost')\n\n      await webSocketCommunication.start()\n      this.serverStarted = true\n\n      this.logger.log(`WebSocket服务器启动成功: ws://${host}:${port}`)\n    } catch (error) {\n      this.logger.error('WebSocket服务器启动失败:', error)\n      throw error\n    }\n  }\n\n  /**\n   * 设置事件处理器\n   */\n  private setupEventHandlers(): void {\n    // 监听连接事件\n    webSocketCommunication.on('clientConnected', (client: any) => {\n      this.logger.debug(`客户端已连接: ${client.id}`)\n      this.handleClientConnected(client)\n    })\n\n    webSocketCommunication.on('clientDisconnected', (client: any) => {\n      this.logger.debug(`客户端已断开: ${client.id}`)\n      this.handleClientDisconnected(client)\n    })\n\n    webSocketCommunication.on(\n      'messageReceived',\n      (data: { recipientId: string; message: WSMessage }) => {\n        this.handleMessageReceived(data.recipientId, data.message)\n      }\n    )\n\n    webSocketCommunication.on('broadcastSent', (data: { message: WSMessage; sender: any }) => {\n      this.logger.debug(`广播消息已发送: ${data.message.action}`)\n    })\n\n    // 监听服务器事件\n    webSocketCommunication.on('serverError', (error: Error) => {\n      this.logger.error('WebSocket服务器错误:', error)\n    })\n  }\n\n  // ==================== 客户端管理 ====================\n\n  /**\n   * 处理客户端连接\n   */\n  private async handleClientConnected(client: any): Promise<void> {\n    // 可以在这里执行额外的连接初始化逻辑\n    // 比如验证用户身份、设置默认订阅等\n    this.logger.log(`新客户端连接: ${client.id} (${client.metadata.ip})`)\n  }\n\n  /**\n   * 处理客户端断开\n   */\n  private async handleClientDisconnected(client: any): Promise<void> {\n    this.logger.log(`客户端断开连接: ${client.id}`)\n  }\n\n  /**\n   * 处理接收到的消息\n   */\n  private async handleMessageReceived(recipientId: string, message: WSMessage): Promise<void> {\n    // 根据消息类型路由到相应的处理逻辑\n    switch (message.action) {\n      case 'narrative.update':\n        await this.handleNarrativeUpdate(recipientId, message)\n        break\n      case 'agent.status':\n        await this.handleAgentStatusUpdate(recipientId, message)\n        break\n      case 'collaboration.invite':\n        await this.handleCollaborationInvite(recipientId, message)\n        break\n      default:\n        this.logger.debug(`接收到消息: ${message.action} -> ${recipientId}`)\n    }\n  }\n\n  // ==================== 叙事专用消息处理 ====================\n\n  /**\n   * 处理叙事更新消息\n   */\n  private async handleNarrativeUpdate(recipientId: string, message: WSMessage): Promise<void> {\n    // 处理实时叙事协作更新\n    const { storyId, content, authorId } = message.payload\n\n    this.logger.debug(`叙事更新: 故事 ${storyId} 由 ${authorId} 更新`)\n\n    // 可以在这里触发其他协作参与者的实时更新\n    // 比如广播给所有协作者\n    await this.broadcastToStoryCollaborators(\n      storyId,\n      {\n        type: 'event',\n        action: 'narrative.collaborative_update',\n        payload: {\n          storyId,\n          content,\n          authorId,\n          timestamp: new Date(),\n        },\n        timestamp: new Date(),\n        source: 'system',\n      },\n      [recipientId]\n    ) // 排除发送者自己\n  }\n\n  /**\n   * 处理Agent状态更新\n   */\n  private async handleAgentStatusUpdate(recipientId: string, message: WSMessage): Promise<void> {\n    const { agentId, status, currentTask } = message.payload\n\n    this.logger.debug(`Agent状态更新: ${agentId} -> ${status}`)\n\n    // 广播Agent状态变化\n    await this.broadcastToAgents({\n      type: 'event',\n      action: 'agent.status_changed',\n      payload: {\n        agentId,\n        status,\n        currentTask,\n        timestamp: new Date(),\n      },\n      timestamp: new Date(),\n      source: 'system',\n    })\n  }\n\n  /**\n   * 处理协作邀请\n   */\n  private async handleCollaborationInvite(recipientId: string, message: WSMessage): Promise<void> {\n    const { storyId, inviterId, inviteeId, role } = message.payload\n\n    this.logger.debug(`协作邀请: ${inviterId} 邀请 ${inviteeId} 加入故事 ${storyId}`)\n\n    // 发送邀请通知给被邀请者\n    const success = webSocketCommunication.sendToAgent(inviteeId, {\n      type: 'event',\n      action: 'collaboration.invited',\n      payload: {\n        storyId,\n        inviterId,\n        role,\n        timestamp: new Date(),\n      },\n      timestamp: new Date(),\n      source: 'system',\n    })\n\n    if (success) {\n      this.logger.debug(`协作邀请已发送给: ${inviteeId}`)\n    } else {\n      this.logger.warn(`协作邀请发送失败，被邀请者不在线: ${inviteeId}`)\n    }\n  }\n\n  // ==================== 公共接口 ====================\n\n  /**\n   * 向特定Agent发送消息\n   */\n  async sendToAgent(agentId: string, message: Partial<WSMessage>): Promise<boolean> {\n    return webSocketCommunication.sendToAgent(agentId, {\n      id: `msg-${Date.now()}`,\n      type: message.type || 'event',\n      action: message.action || 'message',\n      payload: message.payload || {},\n      timestamp: new Date(),\n      source: 'system',\n      ...message,\n    })\n  }\n\n  /**\n   * 广播到所有Agent\n   */\n  async broadcastToAgents(message: Partial<WSMessage>): Promise<number> {\n    return webSocketCommunication.broadcastToAgents({\n      id: `broadcast-${Date.now()}`,\n      type: message.type || 'event',\n      action: message.action || 'broadcast',\n      payload: message.payload || {},\n      timestamp: new Date(),\n      source: 'system',\n      ...message,\n    })\n  }\n\n  /**\n   * 广播到故事协作者\n   */\n  async broadcastToStoryCollaborators(\n    storyId: string,\n    message: Partial<WSMessage>,\n    excludeClientIds: string[] = []\n  ): Promise<void> {\n    // 这里应该从数据库获取故事的协作者列表\n    // 暂时模拟广播到所有连接的客户端\n    await this.broadcastToAgents(message)\n  }\n\n  /**\n   * 创建协作房间\n   */\n  async createCollaborationRoom(storyId: string, participants: string[]): Promise<string | null> {\n    // 这里应该创建专门的协作房间\n    // 暂时返回null表示未实现\n    this.logger.debug(`创建协作房间: ${storyId} 参与者: ${participants.join(', ')}`)\n    return null\n  }\n\n  /**\n   * 加入协作房间\n   */\n  async joinCollaborationRoom(roomId: string, agentId: string): Promise<boolean> {\n    // 这里应该实现加入协作房间的逻辑\n    this.logger.debug(`Agent ${agentId} 加入房间: ${roomId}`)\n    return true\n  }\n\n  /**\n   * 发送实时编辑更新\n   */\n  async sendRealtimeEdit(storyId: string, agentId: string, editData: any): Promise<void> {\n    await this.broadcastToStoryCollaborators(\n      storyId,\n      {\n        type: 'event',\n        action: 'realtime.edit',\n        payload: {\n          storyId,\n          agentId,\n          editData,\n          timestamp: new Date(),\n        },\n      },\n      [agentId]\n    ) // 排除自己\n  }\n\n  /**\n   * 发送AI生成进度\n   */\n  async sendGenerationProgress(\n    storyId: string,\n    agentId: string,\n    progress: number,\n    status: string\n  ): Promise<void> {\n    await this.broadcastToStoryCollaborators(storyId, {\n      type: 'event',\n      action: 'generation.progress',\n      payload: {\n        storyId,\n        agentId,\n        progress,\n        status,\n        timestamp: new Date(),\n      },\n    })\n  }\n\n  /**\n   * 发送Agent协作状态\n   */\n  async sendAgentCollaborationStatus(storyId: string, collaborationData: any): Promise<void> {\n    await this.broadcastToAgents({\n      type: 'event',\n      action: 'agent.collaboration_status',\n      payload: {\n        storyId,\n        collaborationData,\n        timestamp: new Date(),\n      },\n    })\n  }\n\n  // ==================== 统计和监控 ====================\n\n  /**\n   * 获取WebSocket统计信息\n   */\n  getWebSocketStats(): any {\n    if (!this.serverStarted) {\n      return { status: 'stopped' }\n    }\n\n    return {\n      status: 'running',\n      ...webSocketCommunication.getServerStats(),\n    }\n  }\n\n  /**\n   * 获取活跃协作会话\n   */\n  getActiveCollaborationSessions(): any[] {\n    // 这里应该返回活跃的协作会话信息\n    // 暂时返回空数组\n    return []\n  }\n\n  /**\n   * 健康检查\n   */\n  async healthCheck(): Promise<{ status: string; details?: any }> {\n    if (!this.serverStarted) {\n      return { status: 'error', details: 'WebSocket server not started' }\n    }\n\n    try {\n      const stats = this.getWebSocketStats()\n      return {\n        status: 'healthy',\n        details: stats,\n      }\n    } catch (error) {\n      return {\n        status: 'error',\n        details: error instanceof Error ? error.message : String(error),\n      }\n    }\n  }\n}\n"],"version":3}