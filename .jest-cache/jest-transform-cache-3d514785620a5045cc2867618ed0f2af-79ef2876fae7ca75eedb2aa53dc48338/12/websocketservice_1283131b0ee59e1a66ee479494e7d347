95760c67555cfd4f260e48a15dda0514
"use strict";
// ============================================================================
// WebSocket通信服务集成
// 集成 VCPToolBox 的实时通信能力到创世星环
// ============================================================================
var __esDecorate = (this && this.__esDecorate) || function (ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {
    function accept(f) { if (f !== void 0 && typeof f !== "function") throw new TypeError("Function expected"); return f; }
    var kind = contextIn.kind, key = kind === "getter" ? "get" : kind === "setter" ? "set" : "value";
    var target = !descriptorIn && ctor ? contextIn["static"] ? ctor : ctor.prototype : null;
    var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});
    var _, done = false;
    for (var i = decorators.length - 1; i >= 0; i--) {
        var context = {};
        for (var p in contextIn) context[p] = p === "access" ? {} : contextIn[p];
        for (var p in contextIn.access) context.access[p] = contextIn.access[p];
        context.addInitializer = function (f) { if (done) throw new TypeError("Cannot add initializers after decoration has completed"); extraInitializers.push(accept(f || null)); };
        var result = (0, decorators[i])(kind === "accessor" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);
        if (kind === "accessor") {
            if (result === void 0) continue;
            if (result === null || typeof result !== "object") throw new TypeError("Object expected");
            if (_ = accept(result.get)) descriptor.get = _;
            if (_ = accept(result.set)) descriptor.set = _;
            if (_ = accept(result.init)) initializers.unshift(_);
        }
        else if (_ = accept(result)) {
            if (kind === "field") initializers.unshift(_);
            else descriptor[key] = _;
        }
    }
    if (target) Object.defineProperty(target, contextIn.name, descriptor);
    done = true;
};
var __runInitializers = (this && this.__runInitializers) || function (thisArg, initializers, value) {
    var useValue = arguments.length > 2;
    for (var i = 0; i < initializers.length; i++) {
        value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);
    }
    return useValue ? value : void 0;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketService = void 0;
const common_1 = require("@nestjs/common");
const WebSocketCommunication_1 = require("../../../apps/vcptoolbox/src/modules/communication/WebSocketCommunication");
let WebSocketService = (() => {
    let _classDecorators = [(0, common_1.Injectable)()];
    let _classDescriptor;
    let _classExtraInitializers = [];
    let _classThis;
    var WebSocketService = class {
        static { _classThis = this; }
        static {
            const _metadata = typeof Symbol === "function" && Symbol.metadata ? Object.create(null) : void 0;
            __esDecorate(null, _classDescriptor = { value: _classThis }, _classDecorators, { kind: "class", name: _classThis.name, metadata: _metadata }, null, _classExtraInitializers);
            WebSocketService = _classThis = _classDescriptor.value;
            if (_metadata) Object.defineProperty(_classThis, Symbol.metadata, { enumerable: true, configurable: true, writable: true, value: _metadata });
            __runInitializers(_classThis, _classExtraInitializers);
        }
        configService;
        logger = new common_1.Logger(WebSocketService.name);
        serverStarted = false;
        constructor(configService) {
            this.configService = configService;
        }
        async onModuleInit() {
            await this.initializeWebSocketServer();
            this.setupEventHandlers();
            this.logger.log('WebSocket通信服务已初始化');
        }
        async onModuleDestroy() {
            if (this.serverStarted) {
                await WebSocketCommunication_1.webSocketCommunication.stop();
                this.logger.log('WebSocket通信服务已停止');
            }
        }
        // ==================== 服务器管理 ====================
        /**
         * 初始化WebSocket服务器
         */
        async initializeWebSocketServer() {
            try {
                const port = this.configService.get('WEBSOCKET_PORT', 8080);
                const host = this.configService.get('WEBSOCKET_HOST', 'localhost');
                await WebSocketCommunication_1.webSocketCommunication.start();
                this.serverStarted = true;
                this.logger.log(`WebSocket服务器启动成功: ws://${host}:${port}`);
            }
            catch (error) {
                this.logger.error('WebSocket服务器启动失败:', error);
                throw error;
            }
        }
        /**
         * 设置事件处理器
         */
        setupEventHandlers() {
            // 监听连接事件
            WebSocketCommunication_1.webSocketCommunication.on('clientConnected', (client) => {
                this.logger.debug(`客户端已连接: ${client.id}`);
                this.handleClientConnected(client);
            });
            WebSocketCommunication_1.webSocketCommunication.on('clientDisconnected', (client) => {
                this.logger.debug(`客户端已断开: ${client.id}`);
                this.handleClientDisconnected(client);
            });
            WebSocketCommunication_1.webSocketCommunication.on('messageReceived', (data) => {
                this.handleMessageReceived(data.recipientId, data.message);
            });
            WebSocketCommunication_1.webSocketCommunication.on('broadcastSent', (data) => {
                this.logger.debug(`广播消息已发送: ${data.message.action}`);
            });
            // 监听服务器事件
            WebSocketCommunication_1.webSocketCommunication.on('serverError', (error) => {
                this.logger.error('WebSocket服务器错误:', error);
            });
        }
        // ==================== 客户端管理 ====================
        /**
         * 处理客户端连接
         */
        async handleClientConnected(client) {
            // 可以在这里执行额外的连接初始化逻辑
            // 比如验证用户身份、设置默认订阅等
            this.logger.log(`新客户端连接: ${client.id} (${client.metadata.ip})`);
        }
        /**
         * 处理客户端断开
         */
        async handleClientDisconnected(client) {
            this.logger.log(`客户端断开连接: ${client.id}`);
        }
        /**
         * 处理接收到的消息
         */
        async handleMessageReceived(recipientId, message) {
            // 根据消息类型路由到相应的处理逻辑
            switch (message.action) {
                case 'narrative.update':
                    await this.handleNarrativeUpdate(recipientId, message);
                    break;
                case 'agent.status':
                    await this.handleAgentStatusUpdate(recipientId, message);
                    break;
                case 'collaboration.invite':
                    await this.handleCollaborationInvite(recipientId, message);
                    break;
                default:
                    this.logger.debug(`接收到消息: ${message.action} -> ${recipientId}`);
            }
        }
        // ==================== 叙事专用消息处理 ====================
        /**
         * 处理叙事更新消息
         */
        async handleNarrativeUpdate(recipientId, message) {
            // 处理实时叙事协作更新
            const { storyId, content, authorId } = message.payload;
            this.logger.debug(`叙事更新: 故事 ${storyId} 由 ${authorId} 更新`);
            // 可以在这里触发其他协作参与者的实时更新
            // 比如广播给所有协作者
            await this.broadcastToStoryCollaborators(storyId, {
                type: 'event',
                action: 'narrative.collaborative_update',
                payload: {
                    storyId,
                    content,
                    authorId,
                    timestamp: new Date(),
                },
                timestamp: new Date(),
                source: 'system',
            }, [recipientId]); // 排除发送者自己
        }
        /**
         * 处理Agent状态更新
         */
        async handleAgentStatusUpdate(recipientId, message) {
            const { agentId, status, currentTask } = message.payload;
            this.logger.debug(`Agent状态更新: ${agentId} -> ${status}`);
            // 广播Agent状态变化
            await this.broadcastToAgents({
                type: 'event',
                action: 'agent.status_changed',
                payload: {
                    agentId,
                    status,
                    currentTask,
                    timestamp: new Date(),
                },
                timestamp: new Date(),
                source: 'system',
            });
        }
        /**
         * 处理协作邀请
         */
        async handleCollaborationInvite(recipientId, message) {
            const { storyId, inviterId, inviteeId, role } = message.payload;
            this.logger.debug(`协作邀请: ${inviterId} 邀请 ${inviteeId} 加入故事 ${storyId}`);
            // 发送邀请通知给被邀请者
            const success = WebSocketCommunication_1.webSocketCommunication.sendToAgent(inviteeId, {
                type: 'event',
                action: 'collaboration.invited',
                payload: {
                    storyId,
                    inviterId,
                    role,
                    timestamp: new Date(),
                },
                timestamp: new Date(),
                source: 'system',
            });
            if (success) {
                this.logger.debug(`协作邀请已发送给: ${inviteeId}`);
            }
            else {
                this.logger.warn(`协作邀请发送失败，被邀请者不在线: ${inviteeId}`);
            }
        }
        // ==================== 公共接口 ====================
        /**
         * 向特定Agent发送消息
         */
        async sendToAgent(agentId, message) {
            return WebSocketCommunication_1.webSocketCommunication.sendToAgent(agentId, {
                id: `msg-${Date.now()}`,
                type: message.type || 'event',
                action: message.action || 'message',
                payload: message.payload || {},
                timestamp: new Date(),
                source: 'system',
                ...message,
            });
        }
        /**
         * 广播到所有Agent
         */
        async broadcastToAgents(message) {
            return WebSocketCommunication_1.webSocketCommunication.broadcastToAgents({
                id: `broadcast-${Date.now()}`,
                type: message.type || 'event',
                action: message.action || 'broadcast',
                payload: message.payload || {},
                timestamp: new Date(),
                source: 'system',
                ...message,
            });
        }
        /**
         * 广播到故事协作者
         */
        async broadcastToStoryCollaborators(storyId, message, excludeClientIds = []) {
            // 这里应该从数据库获取故事的协作者列表
            // 暂时模拟广播到所有连接的客户端
            await this.broadcastToAgents(message);
        }
        /**
         * 创建协作房间
         */
        async createCollaborationRoom(storyId, participants) {
            // 这里应该创建专门的协作房间
            // 暂时返回null表示未实现
            this.logger.debug(`创建协作房间: ${storyId} 参与者: ${participants.join(', ')}`);
            return null;
        }
        /**
         * 加入协作房间
         */
        async joinCollaborationRoom(roomId, agentId) {
            // 这里应该实现加入协作房间的逻辑
            this.logger.debug(`Agent ${agentId} 加入房间: ${roomId}`);
            return true;
        }
        /**
         * 发送实时编辑更新
         */
        async sendRealtimeEdit(storyId, agentId, editData) {
            await this.broadcastToStoryCollaborators(storyId, {
                type: 'event',
                action: 'realtime.edit',
                payload: {
                    storyId,
                    agentId,
                    editData,
                    timestamp: new Date(),
                },
            }, [agentId]); // 排除自己
        }
        /**
         * 发送AI生成进度
         */
        async sendGenerationProgress(storyId, agentId, progress, status) {
            await this.broadcastToStoryCollaborators(storyId, {
                type: 'event',
                action: 'generation.progress',
                payload: {
                    storyId,
                    agentId,
                    progress,
                    status,
                    timestamp: new Date(),
                },
            });
        }
        /**
         * 发送Agent协作状态
         */
        async sendAgentCollaborationStatus(storyId, collaborationData) {
            await this.broadcastToAgents({
                type: 'event',
                action: 'agent.collaboration_status',
                payload: {
                    storyId,
                    collaborationData,
                    timestamp: new Date(),
                },
            });
        }
        // ==================== 统计和监控 ====================
        /**
         * 获取WebSocket统计信息
         */
        getWebSocketStats() {
            if (!this.serverStarted) {
                return { status: 'stopped' };
            }
            return {
                status: 'running',
                ...WebSocketCommunication_1.webSocketCommunication.getServerStats(),
            };
        }
        /**
         * 获取活跃协作会话
         */
        getActiveCollaborationSessions() {
            // 这里应该返回活跃的协作会话信息
            // 暂时返回空数组
            return [];
        }
        /**
         * 健康检查
         */
        async healthCheck() {
            if (!this.serverStarted) {
                return { status: 'error', details: 'WebSocket server not started' };
            }
            try {
                const stats = this.getWebSocketStats();
                return {
                    status: 'healthy',
                    details: stats,
                };
            }
            catch (error) {
                return {
                    status: 'error',
                    details: error instanceof Error ? error.message : String(error),
                };
            }
        }
    };
    return WebSocketService = _classThis;
})();
exports.WebSocketService = WebSocketService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFx2Y3BcXHdlYnNvY2tldC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQSwrRUFBK0U7QUFDL0Usa0JBQWtCO0FBQ2xCLDZCQUE2QjtBQUM3QiwrRUFBK0U7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFL0UsMkNBQTRGO0FBRTVGLHNIQUdrRjtJQUdyRSxnQkFBZ0I7NEJBRDVCLElBQUEsbUJBQVUsR0FBRTs7Ozs7Ozs7WUFDYiw2S0F1V0M7OztZQXZXWSx1REFBZ0I7O1FBSVAsYUFBYTtRQUhoQixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDbkQsYUFBYSxHQUFHLEtBQUssQ0FBQTtRQUU3QixZQUFvQixhQUE0QjtZQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUFHLENBQUM7UUFFcEQsS0FBSyxDQUFDLFlBQVk7WUFDaEIsTUFBTSxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQTtZQUN0QyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQTtZQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO1FBQ3RDLENBQUM7UUFFRCxLQUFLLENBQUMsZUFBZTtZQUNuQixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDdkIsTUFBTSwrQ0FBc0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtnQkFDbkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtZQUNyQyxDQUFDO1FBQ0gsQ0FBQztRQUVELGtEQUFrRDtRQUVsRDs7V0FFRztRQUNLLEtBQUssQ0FBQyx5QkFBeUI7WUFDckMsSUFBSSxDQUFDO2dCQUNILE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLElB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QkFBaUIsRUFBRSxDQUFBO2dCQUN0QyxPQUFPO29CQUNMLE1BQU0sRUFBRSxTQUFTO29CQUNqQixPQUFPLEVBQUUsS0FBSztpQkFDZixDQUFBO1lBQ0gsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2YsT0FBTztvQkFDTCxNQUFNLEVBQUUsT0FBTztvQkFDZixPQUFPLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztpQkFDaEUsQ0FBQTtZQUNILENBQUM7UUFDSCxDQUFDOzs7O0FBdFdVLDRDQUFnQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xccGFja2FnZXNcXGNvbW1vbi1iYWNrZW5kXFxzcmNcXHZjcFxcd2Vic29ja2V0LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gV2ViU29ja2V06YCa5L+h5pyN5Yqh6ZuG5oiQXG4vLyDpm4bmiJAgVkNQVG9vbEJveCDnmoTlrp7ml7bpgJrkv6Hog73lipvliLDliJvkuJbmmJ/njq9cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyLCB0eXBlIE9uTW9kdWxlRGVzdHJveSwgdHlwZSBPbk1vZHVsZUluaXQgfSBmcm9tICdAbmVzdGpzL2NvbW1vbidcbmltcG9ydCB0eXBlIHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJ1xuaW1wb3J0IHtcbiAgdHlwZSBXU01lc3NhZ2UsXG4gIHdlYlNvY2tldENvbW11bmljYXRpb24sXG59IGZyb20gJy4uLy4uLy4uL2FwcHMvdmNwdG9vbGJveC9zcmMvbW9kdWxlcy9jb21tdW5pY2F0aW9uL1dlYlNvY2tldENvbW11bmljYXRpb24nXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBXZWJTb2NrZXRTZXJ2aWNlIGltcGxlbWVudHMgT25Nb2R1bGVJbml0LCBPbk1vZHVsZURlc3Ryb3kge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoV2ViU29ja2V0U2VydmljZS5uYW1lKVxuICBwcml2YXRlIHNlcnZlclN0YXJ0ZWQgPSBmYWxzZVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSkge31cblxuICBhc3luYyBvbk1vZHVsZUluaXQoKSB7XG4gICAgYXdhaXQgdGhpcy5pbml0aWFsaXplV2ViU29ja2V0U2VydmVyKClcbiAgICB0aGlzLnNldHVwRXZlbnRIYW5kbGVycygpXG4gICAgdGhpcy5sb2dnZXIubG9nKCdXZWJTb2NrZXTpgJrkv6HmnI3liqHlt7LliJ3lp4vljJYnKVxuICB9XG5cbiAgYXN5bmMgb25Nb2R1bGVEZXN0cm95KCkge1xuICAgIGlmICh0aGlzLnNlcnZlclN0YXJ0ZWQpIHtcbiAgICAgIGF3YWl0IHdlYlNvY2tldENvbW11bmljYXRpb24uc3RvcCgpXG4gICAgICB0aGlzLmxvZ2dlci5sb2coJ1dlYlNvY2tldOmAmuS/oeacjeWKoeW3suWBnOatoicpXG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT0g5pyN5Yqh5Zmo566h55CGID09PT09PT09PT09PT09PT09PT09XG5cbiAgLyoqXG4gICAqIOWIneWni+WMlldlYlNvY2tldOacjeWKoeWZqFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBpbml0aWFsaXplV2ViU29ja2V0U2VydmVyKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwb3J0ID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldCgnV0VCU09DS0VUX1BPUlQnLCA4MDgwKVxuICAgICAgY29uc3QgaG9zdCA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQoJ1dFQlNPQ0tFVF9IT1NUJywgJ2xvY2FsaG9zdCcpXG5cbiAgICAgIGF3YWl0IHdlYlNvY2tldENvbW11bmljYXRpb24uc3RhcnQoKVxuICAgICAgdGhpcy5zZXJ2ZXJTdGFydGVkID0gdHJ1ZVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFdlYlNvY2tldOacjeWKoeWZqOWQr+WKqOaIkOWKnzogd3M6Ly8ke2hvc3R9OiR7cG9ydH1gKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignV2ViU29ja2V05pyN5Yqh5Zmo5ZCv5Yqo5aSx6LSlOicsIGVycm9yKVxuICAgICAgdGhyb3cgZXJyb3JcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6K6+572u5LqL5Lu25aSE55CG5ZmoXG4gICAqL1xuICBwcml2YXRlIHNldHVwRXZlbnRIYW5kbGVycygpOiB2b2lkIHtcbiAgICAvLyDnm5HlkKzov57mjqXkuovku7ZcbiAgICB3ZWJTb2NrZXRDb21tdW5pY2F0aW9uLm9uKCdjbGllbnRDb25uZWN0ZWQnLCAoY2xpZW50OiBhbnkpID0+IHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGDlrqLmiLfnq6/lt7Lov57mjqU6ICR7Y2xpZW50LmlkfWApXG4gICAgICB0aGlzLmhhbmRsZUNsaWVudENvbm5lY3RlZChjbGllbnQpXG4gICAgfSlcblxuICAgIHdlYlNvY2tldENvbW11bmljYXRpb24ub24oJ2NsaWVudERpc2Nvbm5lY3RlZCcsIChjbGllbnQ6IGFueSkgPT4ge1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYOWuouaIt+err+W3suaWreW8gDogJHtjbGllbnQuaWR9YClcbiAgICAgIHRoaXMuaGFuZGxlQ2xpZW50RGlzY29ubmVjdGVkKGNsaWVudClcbiAgICB9KVxuXG4gICAgd2ViU29ja2V0Q29tbXVuaWNhdGlvbi5vbihcbiAgICAgICdtZXNzYWdlUmVjZWl2ZWQnLFxuICAgICAgKGRhdGE6IHsgcmVjaXBpZW50SWQ6IHN0cmluZzsgbWVzc2FnZTogV1NNZXNzYWdlIH0pID0+IHtcbiAgICAgICAgdGhpcy5oYW5kbGVNZXNzYWdlUmVjZWl2ZWQoZGF0YS5yZWNpcGllbnRJZCwgZGF0YS5tZXNzYWdlKVxuICAgICAgfVxuICAgIClcblxuICAgIHdlYlNvY2tldENvbW11bmljYXRpb24ub24oJ2Jyb2FkY2FzdFNlbnQnLCAoZGF0YTogeyBtZXNzYWdlOiBXU01lc3NhZ2U7IHNlbmRlcjogYW55IH0pID0+IHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGDlub/mkq3mtojmga/lt7Llj5HpgIE6ICR7ZGF0YS5tZXNzYWdlLmFjdGlvbn1gKVxuICAgIH0pXG5cbiAgICAvLyDnm5HlkKzmnI3liqHlmajkuovku7ZcbiAgICB3ZWJTb2NrZXRDb21tdW5pY2F0aW9uLm9uKCdzZXJ2ZXJFcnJvcicsIChlcnJvcjogRXJyb3IpID0+IHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdXZWJTb2NrZXTmnI3liqHlmajplJnor686JywgZXJyb3IpXG4gICAgfSlcbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09IOWuouaIt+err+euoeeQhiA9PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiDlpITnkIblrqLmiLfnq6/ov57mjqVcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgaGFuZGxlQ2xpZW50Q29ubmVjdGVkKGNsaWVudDogYW55KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8g5Y+v5Lul5Zyo6L+Z6YeM5omn6KGM6aKd5aSW55qE6L+e5o6l5Yid5aeL5YyW6YC76L6RXG4gICAgLy8g5q+U5aaC6aqM6K+B55So5oi36Lqr5Lu944CB6K6+572u6buY6K6k6K6i6ZiF562JXG4gICAgdGhpcy5sb2dnZXIubG9nKGDmlrDlrqLmiLfnq6/ov57mjqU6ICR7Y2xpZW50LmlkfSAoJHtjbGllbnQubWV0YWRhdGEuaXB9KWApXG4gIH1cblxuICAvKipcbiAgICog5aSE55CG5a6i5oi356uv5pat5byAXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGhhbmRsZUNsaWVudERpc2Nvbm5lY3RlZChjbGllbnQ6IGFueSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMubG9nZ2VyLmxvZyhg5a6i5oi356uv5pat5byA6L+e5o6lOiAke2NsaWVudC5pZH1gKVxuICB9XG5cbiAgLyoqXG4gICAqIOWkhOeQhuaOpeaUtuWIsOeahOa2iOaBr1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBoYW5kbGVNZXNzYWdlUmVjZWl2ZWQocmVjaXBpZW50SWQ6IHN0cmluZywgbWVzc2FnZTogV1NNZXNzYWdlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8g5qC55o2u5raI5oGv57G75Z6L6Lev55Sx5Yiw55u45bqU55qE5aSE55CG6YC76L6RXG4gICAgc3dpdGNoIChtZXNzYWdlLmFjdGlvbikge1xuICAgICAgY2FzZSAnbmFycmF0aXZlLnVwZGF0ZSc6XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlTmFycmF0aXZlVXBkYXRlKHJlY2lwaWVudElkLCBtZXNzYWdlKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnYWdlbnQuc3RhdHVzJzpcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVBZ2VudFN0YXR1c1VwZGF0ZShyZWNpcGllbnRJZCwgbWVzc2FnZSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ2NvbGxhYm9yYXRpb24uaW52aXRlJzpcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVDb2xsYWJvcmF0aW9uSW52aXRlKHJlY2lwaWVudElkLCBtZXNzYWdlKVxuICAgICAgICBicmVha1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYOaOpeaUtuWIsOa2iOaBrzogJHttZXNzYWdlLmFjdGlvbn0gLT4gJHtyZWNpcGllbnRJZH1gKVxuICAgIH1cbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09IOWPmeS6i+S4k+eUqOa2iOaBr+WkhOeQhiA9PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiDlpITnkIblj5nkuovmm7TmlrDmtojmga9cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgaGFuZGxlTmFycmF0aXZlVXBkYXRlKHJlY2lwaWVudElkOiBzdHJpbmcsIG1lc3NhZ2U6IFdTTWVzc2FnZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIOWkhOeQhuWunuaXtuWPmeS6i+WNj+S9nOabtOaWsFxuICAgIGNvbnN0IHsgc3RvcnlJZCwgY29udGVudCwgYXV0aG9ySWQgfSA9IG1lc3NhZ2UucGF5bG9hZFxuXG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYOWPmeS6i+abtOaWsDog5pWF5LqLICR7c3RvcnlJZH0g55SxICR7YXV0aG9ySWR9IOabtOaWsGApXG5cbiAgICAvLyDlj6/ku6XlnKjov5nph4zop6blj5Hlhbbku5bljY/kvZzlj4LkuI7ogIXnmoTlrp7ml7bmm7TmlrBcbiAgICAvLyDmr5TlpoLlub/mkq3nu5nmiYDmnInljY/kvZzogIVcbiAgICBhd2FpdCB0aGlzLmJyb2FkY2FzdFRvU3RvcnlDb2xsYWJvcmF0b3JzKFxuICAgICAgc3RvcnlJZCxcbiAgICAgIHtcbiAgICAgICAgdHlwZTogJ2V2ZW50JyxcbiAgICAgICAgYWN0aW9uOiAnbmFycmF0aXZlLmNvbGxhYm9yYXRpdmVfdXBkYXRlJyxcbiAgICAgICAgcGF5bG9hZDoge1xuICAgICAgICAgIHN0b3J5SWQsXG4gICAgICAgICAgY29udGVudCxcbiAgICAgICAgICBhdXRob3JJZCxcbiAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIH0sXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgc291cmNlOiAnc3lzdGVtJyxcbiAgICAgIH0sXG4gICAgICBbcmVjaXBpZW50SWRdXG4gICAgKSAvLyDmjpLpmaTlj5HpgIHogIXoh6rlt7FcbiAgfVxuXG4gIC8qKlxuICAgKiDlpITnkIZBZ2VudOeKtuaAgeabtOaWsFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBoYW5kbGVBZ2VudFN0YXR1c1VwZGF0ZShyZWNpcGllbnRJZDogc3RyaW5nLCBtZXNzYWdlOiBXU01lc3NhZ2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB7IGFnZW50SWQsIHN0YXR1cywgY3VycmVudFRhc2sgfSA9IG1lc3NhZ2UucGF5bG9hZFxuXG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYEFnZW5054q25oCB5pu05pawOiAke2FnZW50SWR9IC0+ICR7c3RhdHVzfWApXG5cbiAgICAvLyDlub/mkq1BZ2VudOeKtuaAgeWPmOWMllxuICAgIGF3YWl0IHRoaXMuYnJvYWRjYXN0VG9BZ2VudHMoe1xuICAgICAgdHlwZTogJ2V2ZW50JyxcbiAgICAgIGFjdGlvbjogJ2FnZW50LnN0YXR1c19jaGFuZ2VkJyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgYWdlbnRJZCxcbiAgICAgICAgc3RhdHVzLFxuICAgICAgICBjdXJyZW50VGFzayxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgfSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIHNvdXJjZTogJ3N5c3RlbScsXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiDlpITnkIbljY/kvZzpgoDor7dcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgaGFuZGxlQ29sbGFib3JhdGlvbkludml0ZShyZWNpcGllbnRJZDogc3RyaW5nLCBtZXNzYWdlOiBXU01lc3NhZ2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB7IHN0b3J5SWQsIGludml0ZXJJZCwgaW52aXRlZUlkLCByb2xlIH0gPSBtZXNzYWdlLnBheWxvYWRcblxuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGDljY/kvZzpgoDor7c6ICR7aW52aXRlcklkfSDpgoDor7cgJHtpbnZpdGVlSWR9IOWKoOWFpeaVheS6iyAke3N0b3J5SWR9YClcblxuICAgIC8vIOWPkemAgemCgOivt+mAmuefpee7meiiq+mCgOivt+iAhVxuICAgIGNvbnN0IHN1Y2Nlc3MgPSB3ZWJTb2NrZXRDb21tdW5pY2F0aW9uLnNlbmRUb0FnZW50KGludml0ZWVJZCwge1xuICAgICAgdHlwZTogJ2V2ZW50JyxcbiAgICAgIGFjdGlvbjogJ2NvbGxhYm9yYXRpb24uaW52aXRlZCcsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIHN0b3J5SWQsXG4gICAgICAgIGludml0ZXJJZCxcbiAgICAgICAgcm9sZSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgfSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIHNvdXJjZTogJ3N5c3RlbScsXG4gICAgfSlcblxuICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1Zyhg5Y2P5L2c6YKA6K+35bey5Y+R6YCB57uZOiAke2ludml0ZWVJZH1gKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKGDljY/kvZzpgoDor7flj5HpgIHlpLHotKXvvIzooqvpgoDor7fogIXkuI3lnKjnur86ICR7aW52aXRlZUlkfWApXG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT0g5YWs5YWx5o6l5Y+jID09PT09PT09PT09PT09PT09PT09XG5cbiAgLyoqXG4gICAqIOWQkeeJueWumkFnZW505Y+R6YCB5raI5oGvXG4gICAqL1xuICBhc3luYyBzZW5kVG9BZ2VudChhZ2VudElkOiBzdHJpbmcsIG1lc3NhZ2U6IFBhcnRpYWw8V1NNZXNzYWdlPik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB3ZWJTb2NrZXRDb21tdW5pY2F0aW9uLnNlbmRUb0FnZW50KGFnZW50SWQsIHtcbiAgICAgIGlkOiBgbXNnLSR7RGF0ZS5ub3coKX1gLFxuICAgICAgdHlwZTogbWVzc2FnZS50eXBlIHx8ICdldmVudCcsXG4gICAgICBhY3Rpb246IG1lc3NhZ2UuYWN0aW9uIHx8ICdtZXNzYWdlJyxcbiAgICAgIHBheWxvYWQ6IG1lc3NhZ2UucGF5bG9hZCB8fCB7fSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIHNvdXJjZTogJ3N5c3RlbScsXG4gICAgICAuLi5tZXNzYWdlLFxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICog5bm/5pKt5Yiw5omA5pyJQWdlbnRcbiAgICovXG4gIGFzeW5jIGJyb2FkY2FzdFRvQWdlbnRzKG1lc3NhZ2U6IFBhcnRpYWw8V1NNZXNzYWdlPik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgcmV0dXJuIHdlYlNvY2tldENvbW11bmljYXRpb24uYnJvYWRjYXN0VG9BZ2VudHMoe1xuICAgICAgaWQ6IGBicm9hZGNhc3QtJHtEYXRlLm5vdygpfWAsXG4gICAgICB0eXBlOiBtZXNzYWdlLnR5cGUgfHwgJ2V2ZW50JyxcbiAgICAgIGFjdGlvbjogbWVzc2FnZS5hY3Rpb24gfHwgJ2Jyb2FkY2FzdCcsXG4gICAgICBwYXlsb2FkOiBtZXNzYWdlLnBheWxvYWQgfHwge30sXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICBzb3VyY2U6ICdzeXN0ZW0nLFxuICAgICAgLi4ubWVzc2FnZSxcbiAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIOW5v+aSreWIsOaVheS6i+WNj+S9nOiAhVxuICAgKi9cbiAgYXN5bmMgYnJvYWRjYXN0VG9TdG9yeUNvbGxhYm9yYXRvcnMoXG4gICAgc3RvcnlJZDogc3RyaW5nLFxuICAgIG1lc3NhZ2U6IFBhcnRpYWw8V1NNZXNzYWdlPixcbiAgICBleGNsdWRlQ2xpZW50SWRzOiBzdHJpbmdbXSA9IFtdXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIOi/memHjOW6lOivpeS7juaVsOaNruW6k+iOt+WPluaVheS6i+eahOWNj+S9nOiAheWIl+ihqFxuICAgIC8vIOaaguaXtuaooeaLn+W5v+aSreWIsOaJgOaciei/nuaOpeeahOWuouaIt+err1xuICAgIGF3YWl0IHRoaXMuYnJvYWRjYXN0VG9BZ2VudHMobWVzc2FnZSlcbiAgfVxuXG4gIC8qKlxuICAgKiDliJvlu7rljY/kvZzmiL/pl7RcbiAgICovXG4gIGFzeW5jIGNyZWF0ZUNvbGxhYm9yYXRpb25Sb29tKHN0b3J5SWQ6IHN0cmluZywgcGFydGljaXBhbnRzOiBzdHJpbmdbXSk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIC8vIOi/memHjOW6lOivpeWIm+W7uuS4k+mXqOeahOWNj+S9nOaIv+mXtFxuICAgIC8vIOaaguaXtui/lOWbnm51bGzooajnpLrmnKrlrp7njrBcbiAgICB0aGlzLmxvZ2dlci5kZWJ1Zyhg5Yib5bu65Y2P5L2c5oi/6Ze0OiAke3N0b3J5SWR9IOWPguS4juiAhTogJHtwYXJ0aWNpcGFudHMuam9pbignLCAnKX1gKVxuICAgIHJldHVybiBudWxsXG4gIH1cblxuICAvKipcbiAgICog5Yqg5YWl5Y2P5L2c5oi/6Ze0XG4gICAqL1xuICBhc3luYyBqb2luQ29sbGFib3JhdGlvblJvb20ocm9vbUlkOiBzdHJpbmcsIGFnZW50SWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vIOi/memHjOW6lOivpeWunueOsOWKoOWFpeWNj+S9nOaIv+mXtOeahOmAu+i+kVxuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBBZ2VudCAke2FnZW50SWR9IOWKoOWFpeaIv+mXtDogJHtyb29tSWR9YClcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgLyoqXG4gICAqIOWPkemAgeWunuaXtue8lui+keabtOaWsFxuICAgKi9cbiAgYXN5bmMgc2VuZFJlYWx0aW1lRWRpdChzdG9yeUlkOiBzdHJpbmcsIGFnZW50SWQ6IHN0cmluZywgZWRpdERhdGE6IGFueSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuYnJvYWRjYXN0VG9TdG9yeUNvbGxhYm9yYXRvcnMoXG4gICAgICBzdG9yeUlkLFxuICAgICAge1xuICAgICAgICB0eXBlOiAnZXZlbnQnLFxuICAgICAgICBhY3Rpb246ICdyZWFsdGltZS5lZGl0JyxcbiAgICAgICAgcGF5bG9hZDoge1xuICAgICAgICAgIHN0b3J5SWQsXG4gICAgICAgICAgYWdlbnRJZCxcbiAgICAgICAgICBlZGl0RGF0YSxcbiAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgW2FnZW50SWRdXG4gICAgKSAvLyDmjpLpmaToh6rlt7FcbiAgfVxuXG4gIC8qKlxuICAgKiDlj5HpgIFBSeeUn+aIkOi/m+W6plxuICAgKi9cbiAgYXN5bmMgc2VuZEdlbmVyYXRpb25Qcm9ncmVzcyhcbiAgICBzdG9yeUlkOiBzdHJpbmcsXG4gICAgYWdlbnRJZDogc3RyaW5nLFxuICAgIHByb2dyZXNzOiBudW1iZXIsXG4gICAgc3RhdHVzOiBzdHJpbmdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5icm9hZGNhc3RUb1N0b3J5Q29sbGFib3JhdG9ycyhzdG9yeUlkLCB7XG4gICAgICB0eXBlOiAnZXZlbnQnLFxuICAgICAgYWN0aW9uOiAnZ2VuZXJhdGlvbi5wcm9ncmVzcycsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIHN0b3J5SWQsXG4gICAgICAgIGFnZW50SWQsXG4gICAgICAgIHByb2dyZXNzLFxuICAgICAgICBzdGF0dXMsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIH0sXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiDlj5HpgIFBZ2VudOWNj+S9nOeKtuaAgVxuICAgKi9cbiAgYXN5bmMgc2VuZEFnZW50Q29sbGFib3JhdGlvblN0YXR1cyhzdG9yeUlkOiBzdHJpbmcsIGNvbGxhYm9yYXRpb25EYXRhOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmJyb2FkY2FzdFRvQWdlbnRzKHtcbiAgICAgIHR5cGU6ICdldmVudCcsXG4gICAgICBhY3Rpb246ICdhZ2VudC5jb2xsYWJvcmF0aW9uX3N0YXR1cycsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIHN0b3J5SWQsXG4gICAgICAgIGNvbGxhYm9yYXRpb25EYXRhLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgIH0pXG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PSDnu5/orqHlkoznm5HmjqcgPT09PT09PT09PT09PT09PT09PT1cblxuICAvKipcbiAgICog6I635Y+WV2ViU29ja2V057uf6K6h5L+h5oGvXG4gICAqL1xuICBnZXRXZWJTb2NrZXRTdGF0cygpOiBhbnkge1xuICAgIGlmICghdGhpcy5zZXJ2ZXJTdGFydGVkKSB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6ICdzdG9wcGVkJyB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1czogJ3J1bm5pbmcnLFxuICAgICAgLi4ud2ViU29ja2V0Q29tbXVuaWNhdGlvbi5nZXRTZXJ2ZXJTdGF0cygpLFxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bmtLvot4PljY/kvZzkvJror51cbiAgICovXG4gIGdldEFjdGl2ZUNvbGxhYm9yYXRpb25TZXNzaW9ucygpOiBhbnlbXSB7XG4gICAgLy8g6L+Z6YeM5bqU6K+l6L+U5Zue5rS76LeD55qE5Y2P5L2c5Lya6K+d5L+h5oGvXG4gICAgLy8g5pqC5pe26L+U5Zue56m65pWw57uEXG4gICAgcmV0dXJuIFtdXG4gIH1cblxuICAvKipcbiAgICog5YGl5bq35qOA5p+lXG4gICAqL1xuICBhc3luYyBoZWFsdGhDaGVjaygpOiBQcm9taXNlPHsgc3RhdHVzOiBzdHJpbmc7IGRldGFpbHM/OiBhbnkgfT4ge1xuICAgIGlmICghdGhpcy5zZXJ2ZXJTdGFydGVkKSB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6ICdlcnJvcicsIGRldGFpbHM6ICdXZWJTb2NrZXQgc2VydmVyIG5vdCBzdGFydGVkJyB9XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0YXRzID0gdGhpcy5nZXRXZWJTb2NrZXRTdGF0cygpXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXM6ICdoZWFsdGh5JyxcbiAgICAgICAgZGV0YWlsczogc3RhdHMsXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1czogJ2Vycm9yJyxcbiAgICAgICAgZGV0YWlsczogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9