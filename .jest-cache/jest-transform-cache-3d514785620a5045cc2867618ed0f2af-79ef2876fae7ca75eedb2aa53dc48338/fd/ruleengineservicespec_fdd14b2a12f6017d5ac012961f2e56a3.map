{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\__tests__\\rule-engine.service.spec.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\__tests__\\rule-engine.service.spec.ts"],"sourcesContent":["// 文件路径: apps/logic-agent/src/__tests__/rule-engine.service.spec.ts\n\nimport { BadRequestException } from '@nestjs/common'\nimport { Test, type TestingModule } from '@nestjs/testing'\nimport type { Character, Prisma, PrismaClient } from '@prisma/client'\nimport { type DirectiveSet, PrismaService } from '@tuheg/common-backend'\nimport { type DeepMockProxy, mockDeep } from 'jest-mock-extended'\nimport { RuleEngineService } from '../rule-engine.service'\n\ndescribe('RuleEngineService', () => {\n  let service: RuleEngineService\n  let prismaMock: DeepMockProxy<PrismaService>\n\n  const MOCK_GAME_ID = 'test-game-id'\n  const MOCK_CHARACTER: Character = {\n    id: 'char-id',\n    gameId: MOCK_GAME_ID,\n    name: 'Kael',\n    hp: 100,\n    maxHp: 100,\n    mp: 50,\n    maxMp: 50,\n    status: 'Normal',\n    card: {} as Prisma.JsonObject,\n  }\n\n  beforeEach(async () => {\n    prismaMock = {\n      $transaction: jest.fn().mockImplementation(async (fn: any) => {\n        return await fn(prismaMock)\n      }),\n      character: {\n        findUniqueOrThrow: jest.fn(),\n        update: jest.fn(),\n      },\n    } as any\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [RuleEngineService, { provide: PrismaService, useValue: prismaMock }],\n    }).compile()\n\n    service = module.get<RuleEngineService>(RuleEngineService)\n\n    // Manually set prisma to ensure it's available\n    ;(service as any).prisma = prismaMock\n  })\n\n  afterEach(() => {\n    jest.clearAllMocks()\n  })\n\n  it('should be defined', () => {\n    expect(service).toBeDefined()\n  })\n\n  it('should do nothing if directives array is empty', async () => {\n    await service.execute(MOCK_GAME_ID, [])\n    expect(prismaMock.$transaction).not.toHaveBeenCalled()\n  })\n\n  describe('Character Updates', () => {\n    beforeEach(() => {\n      prismaMock.character.findUniqueOrThrow.mockResolvedValue(MOCK_CHARACTER)\n    })\n\n    it('should correctly apply a single \"decrement\" hp directive', async () => {\n      const directives: DirectiveSet = [\n        {\n          op: 'update_character',\n          targetId: 'player',\n          payload: { hp: { op: 'decrement', value: 10 } },\n        },\n      ]\n      await service.execute(MOCK_GAME_ID, directives)\n      expect(prismaMock.character.update).toHaveBeenCalledWith({\n        where: { gameId: MOCK_GAME_ID },\n        data: { hp: 90 },\n      })\n    })\n\n    it('should correctly apply multiple directives in one transaction', async () => {\n      const directives: DirectiveSet = [\n        {\n          op: 'update_character',\n          targetId: 'player',\n          payload: {\n            hp: { op: 'increment', value: 5 },\n            mp: { op: 'set', value: 42 },\n            status: { op: 'set', value: 'Energized' },\n          },\n        },\n      ]\n      await service.execute(MOCK_GAME_ID, directives)\n      expect(prismaMock.character.update).toHaveBeenCalledWith({\n        where: { gameId: MOCK_GAME_ID },\n        data: {\n          hp: 105,\n          mp: 42,\n          status: 'Energized',\n        },\n      })\n    })\n\n    it('should handle string \"append\" and \"prepend\" operations', async () => {\n      const initialCharacter = { ...MOCK_CHARACTER }\n      prismaMock.character.findUniqueOrThrow.mockResolvedValue(initialCharacter)\n\n      const prependDirective: DirectiveSet = [\n        {\n          op: 'update_character',\n          targetId: 'player',\n          payload: { status: { op: 'prepend', value: 'Slightly ' } },\n        },\n      ]\n      await service.execute(MOCK_GAME_ID, prependDirective)\n      expect(prismaMock.character.update).toHaveBeenCalledWith({\n        where: { gameId: MOCK_GAME_ID },\n        data: { status: 'Slightly Normal' },\n      })\n\n      const appendedCharacter = {\n        ...initialCharacter,\n        status: 'Slightly Normal',\n      }\n      prismaMock.character.findUniqueOrThrow.mockResolvedValue(appendedCharacter)\n\n      const appendDirective: DirectiveSet = [\n        {\n          op: 'update_character',\n          targetId: 'player',\n          payload: { status: { op: 'append', value: ' and Confused' } },\n        },\n      ]\n      await service.execute(MOCK_GAME_ID, appendDirective)\n      expect(prismaMock.character.update).toHaveBeenCalledWith({\n        where: { gameId: MOCK_GAME_ID },\n        data: { status: 'Slightly Normal and Confused' },\n      })\n    })\n  })\n\n  describe('Error Handling', () => {\n    it('should re-throw transaction failures as a RuleEngineExecutionException', async () => {\n      const dbError = new Error('Database connection lost')\n      prismaMock.$transaction.mockRejectedValue(dbError)\n      const directives: DirectiveSet = [\n        {\n          op: 'update_character',\n          targetId: 'player',\n          payload: { hp: { op: 'decrement', value: 10 } },\n        },\n      ]\n      await expect(service.execute(MOCK_GAME_ID, directives)).rejects.toThrow(\n        'Rule engine transaction failed: Database connection lost'\n      )\n    })\n\n    it('should throw BadRequestException for an unknown operation', async () => {\n      const directives: DirectiveSet = [\n        {\n          op: 'unknown_operation', // 使用一个未知的操作\n          targetId: 'player',\n          payload: {},\n        } as any, // Type assertion to bypass type checking\n      ]\n      await expect(service.execute(MOCK_GAME_ID, directives)).rejects.toThrow(BadRequestException)\n    })\n  })\n})\n"],"version":3}