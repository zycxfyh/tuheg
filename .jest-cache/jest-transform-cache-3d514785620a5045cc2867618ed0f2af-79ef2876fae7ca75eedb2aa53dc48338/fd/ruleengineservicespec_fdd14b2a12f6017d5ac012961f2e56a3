6054267d82ee0c46e9cca42bfbbd34e7
"use strict";
// 文件路径: apps/logic-agent/src/__tests__/rule-engine.service.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const common_backend_1 = require("@tuheg/common-backend");
const rule_engine_service_1 = require("../rule-engine.service");
describe('RuleEngineService', () => {
    let service;
    let prismaMock;
    const MOCK_GAME_ID = 'test-game-id';
    const MOCK_CHARACTER = {
        id: 'char-id',
        gameId: MOCK_GAME_ID,
        name: 'Kael',
        hp: 100,
        maxHp: 100,
        mp: 50,
        maxMp: 50,
        status: 'Normal',
        card: {},
    };
    beforeEach(async () => {
        prismaMock = {
            $transaction: jest.fn().mockImplementation(async (fn) => {
                return await fn(prismaMock);
            }),
            character: {
                findUniqueOrThrow: jest.fn(),
                update: jest.fn(),
            },
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [rule_engine_service_1.RuleEngineService, { provide: common_backend_1.PrismaService, useValue: prismaMock }],
        }).compile();
        service = module.get(rule_engine_service_1.RuleEngineService);
        service.prisma = prismaMock;
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    it('should do nothing if directives array is empty', async () => {
        await service.execute(MOCK_GAME_ID, []);
        expect(prismaMock.$transaction).not.toHaveBeenCalled();
    });
    describe('Character Updates', () => {
        beforeEach(() => {
            prismaMock.character.findUniqueOrThrow.mockResolvedValue(MOCK_CHARACTER);
        });
        it('should correctly apply a single "decrement" hp directive', async () => {
            const directives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { hp: { op: 'decrement', value: 10 } },
                },
            ];
            await service.execute(MOCK_GAME_ID, directives);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: { hp: 90 },
            });
        });
        it('should correctly apply multiple directives in one transaction', async () => {
            const directives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: {
                        hp: { op: 'increment', value: 5 },
                        mp: { op: 'set', value: 42 },
                        status: { op: 'set', value: 'Energized' },
                    },
                },
            ];
            await service.execute(MOCK_GAME_ID, directives);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: {
                    hp: 105,
                    mp: 42,
                    status: 'Energized',
                },
            });
        });
        it('should handle string "append" and "prepend" operations', async () => {
            const initialCharacter = { ...MOCK_CHARACTER };
            prismaMock.character.findUniqueOrThrow.mockResolvedValue(initialCharacter);
            const prependDirective = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { status: { op: 'prepend', value: 'Slightly ' } },
                },
            ];
            await service.execute(MOCK_GAME_ID, prependDirective);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: { status: 'Slightly Normal' },
            });
            const appendedCharacter = {
                ...initialCharacter,
                status: 'Slightly Normal',
            };
            prismaMock.character.findUniqueOrThrow.mockResolvedValue(appendedCharacter);
            const appendDirective = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { status: { op: 'append', value: ' and Confused' } },
                },
            ];
            await service.execute(MOCK_GAME_ID, appendDirective);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: { status: 'Slightly Normal and Confused' },
            });
        });
    });
    describe('Error Handling', () => {
        it('should re-throw transaction failures as a RuleEngineExecutionException', async () => {
            const dbError = new Error('Database connection lost');
            prismaMock.$transaction.mockRejectedValue(dbError);
            const directives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { hp: { op: 'decrement', value: 10 } },
                },
            ];
            await expect(service.execute(MOCK_GAME_ID, directives)).rejects.toThrow('Rule engine transaction failed: Database connection lost');
        });
        it('should throw BadRequestException for an unknown operation', async () => {
            const directives = [
                {
                    op: 'unknown_operation', // 使用一个未知的操作
                    targetId: 'player',
                    payload: {},
                },
            ];
            await expect(service.execute(MOCK_GAME_ID, directives)).rejects.toThrow(common_1.BadRequestException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xccnVsZS1lbmdpbmUuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxtRUFBbUU7O0FBRW5FLDJDQUFvRDtBQUNwRCw2Q0FBMEQ7QUFFMUQsMERBQXdFO0FBRXhFLGdFQUEwRDtBQUUxRCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO0lBQ2pDLElBQUksT0FBMEIsQ0FBQTtJQUM5QixJQUFJLFVBQXdDLENBQUE7SUFFNUMsTUFBTSxZQUFZLEdBQUcsY0FBYyxDQUFBO0lBQ25DLE1BQU0sY0FBYyxHQUFjO1FBQ2hDLEVBQUUsRUFBRSxTQUFTO1FBQ2IsTUFBTSxFQUFFLFlBQVk7UUFDcEIsSUFBSSxFQUFFLE1BQU07UUFDWixFQUFFLEVBQUUsR0FBRztRQUNQLEtBQUssRUFBRSxHQUFHO1FBQ1YsRUFBRSxFQUFFLEVBQUU7UUFDTixLQUFLLEVBQUUsRUFBRTtRQUNULE1BQU0sRUFBRSxRQUFRO1FBQ2hCLElBQUksRUFBRSxFQUF1QjtLQUM5QixDQUFBO0lBRUQsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLFVBQVUsR0FBRztZQUNYLFlBQVksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLEVBQU8sRUFBRSxFQUFFO2dCQUMzRCxPQUFPLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQzdCLENBQUMsQ0FBQztZQUNGLFNBQVMsRUFBRTtnQkFDVCxpQkFBaUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUM1QixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNsQjtTQUNLLENBQUE7UUFFUixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFLENBQUMsdUNBQWlCLEVBQUUsRUFBRSxPQUFPLEVBQUUsOEJB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LENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsNEJBQW1CLENBQUMsQ0FBQTtRQUM5RixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xccnVsZS1lbmdpbmUuc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogYXBwcy9sb2dpYy1hZ2VudC9zcmMvX190ZXN0c19fL3J1bGUtZW5naW5lLnNlcnZpY2Uuc3BlYy50c1xuXG5pbXBvcnQgeyBCYWRSZXF1ZXN0RXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nXG5pbXBvcnQgeyBUZXN0LCB0eXBlIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnXG5pbXBvcnQgdHlwZSB7IENoYXJhY3RlciwgUHJpc21hLCBQcmlzbWFDbGllbnQgfSBmcm9tICdAcHJpc21hL2NsaWVudCdcbmltcG9ydCB7IHR5cGUgRGlyZWN0aXZlU2V0LCBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnQHR1aGVnL2NvbW1vbi1iYWNrZW5kJ1xuaW1wb3J0IHsgdHlwZSBEZWVwTW9ja1Byb3h5LCBtb2NrRGVlcCB9IGZyb20gJ2plc3QtbW9jay1leHRlbmRlZCdcbmltcG9ydCB7IFJ1bGVFbmdpbmVTZXJ2aWNlIH0gZnJvbSAnLi4vcnVsZS1lbmdpbmUuc2VydmljZSdcblxuZGVzY3JpYmUoJ1J1bGVFbmdpbmVTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogUnVsZUVuZ2luZVNlcnZpY2VcbiAgbGV0IHByaXNtYU1vY2s6IERlZXBNb2NrUHJveHk8UHJpc21hU2VydmljZT5cblxuICBjb25zdCBNT0NLX0dBTUVfSUQgPSAndGVzdC1nYW1lLWlkJ1xuICBjb25zdCBNT0NLX0NIQVJBQ1RFUjogQ2hhcmFjdGVyID0ge1xuICAgIGlkOiAnY2hhci1pZCcsXG4gICAgZ2FtZUlkOiBNT0NLX0dBTUVfSUQsXG4gICAgbmFtZTogJ0thZWwnLFxuICAgIGhwOiAxMDAsXG4gICAgbWF4SHA6IDEwMCxcbiAgICBtcDogNTAsXG4gICAgbWF4TXA6IDUwLFxuICAgIHN0YXR1czogJ05vcm1hbCcsXG4gICAgY2FyZDoge30gYXMgUHJpc21hLkpzb25PYmplY3QsXG4gIH1cblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBwcmlzbWFNb2NrID0ge1xuICAgICAgJHRyYW5zYWN0aW9uOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChmbjogYW55KSA9PiB7XG4gICAgICAgIHJldHVybiBhd2FpdCBmbihwcmlzbWFNb2NrKVxuICAgICAgfSksXG4gICAgICBjaGFyYWN0ZXI6IHtcbiAgICAgICAgZmluZFVuaXF1ZU9yVGhyb3c6IGplc3QuZm4oKSxcbiAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgIH0gYXMgYW55XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbUnVsZUVuZ2luZVNlcnZpY2UsIHsgcHJvdmlkZTogUHJpc21hU2VydmljZSwgdXNlVmFsdWU6IHByaXNtYU1vY2sgfV0sXG4gICAgfSkuY29tcGlsZSgpXG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxSdWxlRW5naW5lU2VydmljZT4oUnVsZUVuZ2luZVNlcnZpY2UpXG5cbiAgICAvLyBNYW51YWxseSBzZXQgcHJpc21hIHRvIGVuc3VyZSBpdCdzIGF2YWlsYWJsZVxuICAgIDsoc2VydmljZSBhcyBhbnkpLnByaXNtYSA9IHByaXNtYU1vY2tcbiAgfSlcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpXG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpXG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBkbyBub3RoaW5nIGlmIGRpcmVjdGl2ZXMgYXJyYXkgaXMgZW1wdHknLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgc2VydmljZS5leGVjdXRlKE1PQ0tfR0FNRV9JRCwgW10pXG4gICAgZXhwZWN0KHByaXNtYU1vY2suJHRyYW5zYWN0aW9uKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ0NoYXJhY3RlciBVcGRhdGVzJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgcHJpc21hTW9jay5jaGFyYWN0ZXIuZmluZFVuaXF1ZU9yVGhyb3cubW9ja1Jlc29sdmVkVmFsdWUoTU9DS19DSEFSQUNURVIpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgY29ycmVjdGx5IGFwcGx5IGEgc2luZ2xlIFwiZGVjcmVtZW50XCIgaHAgZGlyZWN0aXZlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZGlyZWN0aXZlczogRGlyZWN0aXZlU2V0ID0gW1xuICAgICAgICB7XG4gICAgICAgICAgb3A6ICd1cGRhdGVfY2hhcmFjdGVyJyxcbiAgICAgICAgICB0YXJnZXRJZDogJ3BsYXllcicsXG4gICAgICAgICAgcGF5bG9hZDogeyBocDogeyBvcDogJ2RlY3JlbWVudCcsIHZhbHVlOiAxMCB9IH0sXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgICBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGUoTU9DS19HQU1FX0lELCBkaXJlY3RpdmVzKVxuICAgICAgZXhwZWN0KHByaXNtYU1vY2suY2hhcmFjdGVyLnVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICB3aGVyZTogeyBnYW1lSWQ6IE1PQ0tfR0FNRV9JRCB9LFxuICAgICAgICBkYXRhOiB7IGhwOiA5MCB9LFxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgYXBwbHkgbXVsdGlwbGUgZGlyZWN0aXZlcyBpbiBvbmUgdHJhbnNhY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkaXJlY3RpdmVzOiBEaXJlY3RpdmVTZXQgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBvcDogJ3VwZGF0ZV9jaGFyYWN0ZXInLFxuICAgICAgICAgIHRhcmdldElkOiAncGxheWVyJyxcbiAgICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgICBocDogeyBvcDogJ2luY3JlbWVudCcsIHZhbHVlOiA1IH0sXG4gICAgICAgICAgICBtcDogeyBvcDogJ3NldCcsIHZhbHVlOiA0MiB9LFxuICAgICAgICAgICAgc3RhdHVzOiB7IG9wOiAnc2V0JywgdmFsdWU6ICdFbmVyZ2l6ZWQnIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF1cbiAgICAgIGF3YWl0IHNlcnZpY2UuZXhlY3V0ZShNT0NLX0dBTUVfSUQsIGRpcmVjdGl2ZXMpXG4gICAgICBleHBlY3QocHJpc21hTW9jay5jaGFyYWN0ZXIudXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHdoZXJlOiB7IGdhbWVJZDogTU9DS19HQU1FX0lEIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBocDogMTA1LFxuICAgICAgICAgIG1wOiA0MixcbiAgICAgICAgICBzdGF0dXM6ICdFbmVyZ2l6ZWQnLFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc3RyaW5nIFwiYXBwZW5kXCIgYW5kIFwicHJlcGVuZFwiIG9wZXJhdGlvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbml0aWFsQ2hhcmFjdGVyID0geyAuLi5NT0NLX0NIQVJBQ1RFUiB9XG4gICAgICBwcmlzbWFNb2NrLmNoYXJhY3Rlci5maW5kVW5pcXVlT3JUaHJvdy5tb2NrUmVzb2x2ZWRWYWx1ZShpbml0aWFsQ2hhcmFjdGVyKVxuXG4gICAgICBjb25zdCBwcmVwZW5kRGlyZWN0aXZlOiBEaXJlY3RpdmVTZXQgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBvcDogJ3VwZGF0ZV9jaGFyYWN0ZXInLFxuICAgICAgICAgIHRhcmdldElkOiAncGxheWVyJyxcbiAgICAgICAgICBwYXlsb2FkOiB7IHN0YXR1czogeyBvcDogJ3ByZXBlbmQnLCB2YWx1ZTogJ1NsaWdodGx5ICcgfSB9LFxuICAgICAgICB9LFxuICAgICAgXVxuICAgICAgYXdhaXQgc2VydmljZS5leGVjdXRlKE1PQ0tfR0FNRV9JRCwgcHJlcGVuZERpcmVjdGl2ZSlcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLmNoYXJhY3Rlci51cGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgd2hlcmU6IHsgZ2FtZUlkOiBNT0NLX0dBTUVfSUQgfSxcbiAgICAgICAgZGF0YTogeyBzdGF0dXM6ICdTbGlnaHRseSBOb3JtYWwnIH0sXG4gICAgICB9KVxuXG4gICAgICBjb25zdCBhcHBlbmRlZENoYXJhY3RlciA9IHtcbiAgICAgICAgLi4uaW5pdGlhbENoYXJhY3RlcixcbiAgICAgICAgc3RhdHVzOiAnU2xpZ2h0bHkgTm9ybWFsJyxcbiAgICAgIH1cbiAgICAgIHByaXNtYU1vY2suY2hhcmFjdGVyLmZpbmRVbmlxdWVPclRocm93Lm1vY2tSZXNvbHZlZFZhbHVlKGFwcGVuZGVkQ2hhcmFjdGVyKVxuXG4gICAgICBjb25zdCBhcHBlbmREaXJlY3RpdmU6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndXBkYXRlX2NoYXJhY3RlcicsXG4gICAgICAgICAgdGFyZ2V0SWQ6ICdwbGF5ZXInLFxuICAgICAgICAgIHBheWxvYWQ6IHsgc3RhdHVzOiB7IG9wOiAnYXBwZW5kJywgdmFsdWU6ICcgYW5kIENvbmZ1c2VkJyB9IH0sXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgICBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGUoTU9DS19HQU1FX0lELCBhcHBlbmREaXJlY3RpdmUpXG4gICAgICBleHBlY3QocHJpc21hTW9jay5jaGFyYWN0ZXIudXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHdoZXJlOiB7IGdhbWVJZDogTU9DS19HQU1FX0lEIH0sXG4gICAgICAgIGRhdGE6IHsgc3RhdHVzOiAnU2xpZ2h0bHkgTm9ybWFsIGFuZCBDb25mdXNlZCcgfSxcbiAgICAgIH0pXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnRXJyb3IgSGFuZGxpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZS10aHJvdyB0cmFuc2FjdGlvbiBmYWlsdXJlcyBhcyBhIFJ1bGVFbmdpbmVFeGVjdXRpb25FeGNlcHRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkYkVycm9yID0gbmV3IEVycm9yKCdEYXRhYmFzZSBjb25uZWN0aW9uIGxvc3QnKVxuICAgICAgcHJpc21hTW9jay4kdHJhbnNhY3Rpb24ubW9ja1JlamVjdGVkVmFsdWUoZGJFcnJvcilcbiAgICAgIGNvbnN0IGRpcmVjdGl2ZXM6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndXBkYXRlX2NoYXJhY3RlcicsXG4gICAgICAgICAgdGFyZ2V0SWQ6ICdwbGF5ZXInLFxuICAgICAgICAgIHBheWxvYWQ6IHsgaHA6IHsgb3A6ICdkZWNyZW1lbnQnLCB2YWx1ZTogMTAgfSB9LFxuICAgICAgICB9LFxuICAgICAgXVxuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuZXhlY3V0ZShNT0NLX0dBTUVfSUQsIGRpcmVjdGl2ZXMpKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAgICdSdWxlIGVuZ2luZSB0cmFuc2FjdGlvbiBmYWlsZWQ6IERhdGFiYXNlIGNvbm5lY3Rpb24gbG9zdCdcbiAgICAgIClcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBCYWRSZXF1ZXN0RXhjZXB0aW9uIGZvciBhbiB1bmtub3duIG9wZXJhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRpcmVjdGl2ZXM6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndW5rbm93bl9vcGVyYXRpb24nLCAvLyDkvb/nlKjkuIDkuKrmnKrnn6XnmoTmk43kvZxcbiAgICAgICAgICB0YXJnZXRJZDogJ3BsYXllcicsXG4gICAgICAgICAgcGF5bG9hZDoge30sXG4gICAgICAgIH0gYXMgYW55LCAvLyBUeXBlIGFzc2VydGlvbiB0byBieXBhc3MgdHlwZSBjaGVja2luZ1xuICAgICAgXVxuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuZXhlY3V0ZShNT0NLX0dBTUVfSUQsIGRpcmVjdGl2ZXMpKS5yZWplY3RzLnRvVGhyb3coQmFkUmVxdWVzdEV4Y2VwdGlvbilcbiAgICB9KVxuICB9KVxufSlcbiJdLCJ2ZXJzaW9uIjozfQ==