d29c682592373162f2b8eba065ade092
"use strict";
/**
 * Jest 全局测试设置
 * 配置测试环境的快速失败机制和最佳实践
 */
// Mock ESM modules that cause issues in Jest
jest.mock('langfuse', () => ({
    Langfuse: jest.fn().mockImplementation(() => ({
        trace: jest.fn(),
        generation: jest.fn(),
        span: jest.fn(),
        score: jest.fn(),
        shutdownAsync: jest.fn().mockResolvedValue(undefined),
    })),
}));
// 设置更严格的超时
// @ts-expect-error - Jest is available globally in test environment
jest.setTimeout(30000);
// 全局错误处理 - 任何未处理的错误都会导致测试失败
process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason);
    // 在测试环境中，让未处理的promise rejection导致测试失败
    throw new Error(`Unhandled promise rejection: ${reason}`);
});
process.on('uncaughtException', (error) => {
    console.error('Uncaught Exception:', error);
    // 在测试环境中，让未处理的异常导致测试失败
    throw error;
});
// 配置控制台警告 - 将console.error转换为测试失败
const originalConsoleError = console.error;
console.error = (...args) => {
    originalConsoleError(...args);
    // 在CI环境中，将console.error转换为测试失败
    if (process.env.CI) {
        throw new Error(`Console error detected: ${args.join(' ')}`);
    }
};
// Mock 全局对象以防止意外的网络调用
global.fetch = jest.fn(() => Promise.reject(new Error('fetch should be mocked in tests')));
global.Request = jest.fn();
global.Response = jest.fn();
// 设置环境变量用于测试
process.env.NODE_ENV = 'test';
process.env.JWT_SECRET = 'test-jwt-secret-for-testing-only';
process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test_db';
// 补齐缺失的环境变量
process.env.ENCRYPTION_KEY = 'test-encryption-key-32-characters-long';
process.env.ENCRYPTION_SALT = 'test-encryption-salt-16-chars';
process.env.ENCRYPTION_USE_SALT = 'false';
process.env.ENCRYPTION_ALGORITHM = 'aes-256-gcm';
process.env.CLERK_SECRET_KEY = 'test-clerk-secret-key';
process.env.CLERK_PUBLISHABLE_KEY = 'test-clerk-publishable-key';
process.env.CLERK_WEBHOOK_SECRET_KEY = 'test-clerk-webhook-secret';
process.env.RABBITMQ_URL = 'amqp://localhost:5672';
process.env.REDIS_URL = 'redis://localhost:6379';
process.env.SENTRY_DSN = 'https://test@test.ingest.sentry.io/test';
process.env.SENTRY_ENVIRONMENT = 'test';
process.env.SENTRY_TRACES_SAMPLE_RATE = '0.1';
process.env.QDRANT_URL = 'http://localhost:6333';
process.env.QDRANT_API_KEY = 'test-qdrant-api-key';
process.env.FALLBACK_API_KEY = 'test-fallback-api-key';
process.env.FALLBACK_MODEL_ID = 'deepseek-chat';
process.env.FALLBACK_BASE_URL = 'https://api.deepseek.com';
process.env.DB_CONNECTION_LIMIT = '20';
process.env.DB_POOL_TIMEOUT = '20';
process.env.DB_IDLE_TIMEOUT = '300';
process.env.JWT_EXPIRATION_SECONDS = '3600';
process.env.BACKEND_GATEWAY_PORT = '3000';
process.env.CREATION_AGENT_HTTP_PORT = '8080';
process.env.LOGIC_AGENT_HTTP_PORT = '8081';
process.env.NARRATIVE_AGENT_HTTP_PORT = '8082';
// 清理函数 - 在每个测试后运行
afterEach(() => {
    // 重置所有mock
    jest.clearAllMocks();
    // 清理任何可能的文件系统更改（如果适用）
    // 注意：实际的文件系统操作应该在集成测试中进行
    // 检查是否有未处理的异步操作
    if (jest.getTimerCount() > 0) {
        console.warn(`Warning: ${jest.getTimerCount()} timers still active after test`);
    }
});
afterAll(async () => {
    // 清理测试资源
    jest.clearAllMocks();
}, 5000);
// 自定义匹配器
expect.extend({
    toBeValidDate(received) {
        const pass = received instanceof Date && !Number.isNaN(received.getTime());
        if (pass) {
            return {
                message: () => `expected ${received} not to be a valid date`,
                pass: true,
            };
        }
        else {
            return {
                message: () => `expected ${received} to be a valid date`,
                pass: false,
            };
        }
    },
    toBeValidUUID(received) {
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        const pass = typeof received === 'string' && uuidRegex.test(received);
        if (pass) {
            return {
                message: () => `expected ${received} not to be a valid UUID`,
                pass: true,
            };
        }
        else {
            return {
                message: () => `expected ${received} to be a valid UUID`,
                pass: false,
            };
        }
    },
});
// 内存使用监控
if (process.env.CI) {
    const initialMemory = process.memoryUsage();
    const memoryThreshold = 500 * 1024 * 1024; // 500MB
    afterEach(() => {
        const currentMemory = process.memoryUsage();
        const memoryIncrease = currentMemory.heapUsed - initialMemory.heapUsed;
        if (memoryIncrease > memoryThreshold) {
            console.warn(`Warning: Memory usage increased by ${Math.round(memoryIncrease / 1024 / 1024)}MB`);
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHRlc3RzXFxzZXR1cC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHO0FBbUNILDZDQUE2QztBQUM3QyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzNCLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUM1QyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNoQixVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNyQixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNmLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2hCLGFBQWEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO0tBQ3RELENBQUMsQ0FBQztDQUNKLENBQUMsQ0FBQyxDQUFBO0FBMUNILFdBQVc7QUFDWCxvRUFBb0U7QUFDcEUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUV0Qiw0QkFBNEI7QUFDNUIsT0FBTyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsRUFBRTtJQUNuRCxPQUFPLENBQUMsS0FBSyxDQUFDLHlCQUF5QixFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDcEUsc0NBQXNDO0lBQ3RDLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLE1BQU0sRUFBRSxDQUFDLENBQUE7QUFDM0QsQ0FBQyxDQUFDLENBQUE7QUFFRixPQUFPLENBQUMsRUFBRSxDQUFDLG1CQUFtQixFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7SUFDeEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLENBQUMsQ0FBQTtJQUMzQyx1QkFBdUI7SUFD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cyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xcdGVzdHNcXHNldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSmVzdCDlhajlsYDmtYvor5Xorr7nva5cbiAqIOmFjee9rua1i+ivleeOr+Wig+eahOW/q+mAn+Wksei0peacuuWItuWSjOacgOS9s+Wunui3tVxuICovXG5cbi8vIOiuvue9ruabtOS4peagvOeahOi2heaXtlxuLy8gQHRzLWV4cGVjdC1lcnJvciAtIEplc3QgaXMgYXZhaWxhYmxlIGdsb2JhbGx5IGluIHRlc3QgZW52aXJvbm1lbnRcbmplc3Quc2V0VGltZW91dCgzMDAwMClcblxuLy8g5YWo5bGA6ZSZ6K+v5aSE55CGIC0g5Lu75L2V5pyq5aSE55CG55qE6ZSZ6K+v6YO95Lya5a+86Ie05rWL6K+V5aSx6LSlXG5wcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCAocmVhc29uLCBwcm9taXNlKSA9PiB7XG4gIGNvbnNvbGUuZXJyb3IoJ1VuaGFuZGxlZCBSZWplY3Rpb24gYXQ6JywgcHJvbWlzZSwgJ3JlYXNvbjonLCByZWFzb24pXG4gIC8vIOWcqOa1i+ivleeOr+Wig+S4re+8jOiuqeacquWkhOeQhueahHByb21pc2UgcmVqZWN0aW9u5a+86Ie05rWL6K+V5aSx6LSlXG4gIHRocm93IG5ldyBFcnJvcihgVW5oYW5kbGVkIHByb21pc2UgcmVqZWN0aW9uOiAke3JlYXNvbn1gKVxufSlcblxucHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCAoZXJyb3IpID0+IHtcbiAgY29uc29sZS5lcnJvcignVW5jYXVnaHQgRXhjZXB0aW9uOicsIGVycm9yKVxuICAvLyDlnKjmtYvor5Xnjq/looPkuK3vvIzorqnmnKrlpITnkIbnmoTlvILluLjlr7zoh7TmtYvor5XlpLHotKVcbiAgdGhyb3cgZXJyb3Jcbn0pXG5cbi8vIOmFjee9ruaOp+WItuWPsOitpuWRiiAtIOWwhmNvbnNvbGUuZXJyb3LovazmjaLkuLrmtYvor5XlpLHotKVcbmNvbnN0IG9yaWdpbmFsQ29uc29sZUVycm9yID0gY29uc29sZS5lcnJvclxuY29uc29sZS5lcnJvciA9ICguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICBvcmlnaW5hbENvbnNvbGVFcnJvciguLi5hcmdzKVxuICAvLyDlnKhDSeeOr+Wig+S4re+8jOWwhmNvbnNvbGUuZXJyb3LovazmjaLkuLrmtYvor5XlpLHotKVcbiAgaWYgKHByb2Nlc3MuZW52LkNJKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb25zb2xlIGVycm9yIGRldGVjdGVkOiAke2FyZ3Muam9pbignICcpfWApXG4gIH1cbn1cblxuLy8gTW9jayDlhajlsYDlr7nosaHku6XpmLLmraLmhI/lpJbnmoTnvZHnu5zosIPnlKhcbmdsb2JhbC5mZXRjaCA9IGplc3QuZm4oKCkgPT4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdmZXRjaCBzaG91bGQgYmUgbW9ja2VkIGluIHRlc3RzJykpKVxuXG5nbG9iYWwuUmVxdWVzdCA9IGplc3QuZm4oKVxuZ2xvYmFsLlJlc3BvbnNlID0gamVzdC5mbigpXG5cbi8vIE1vY2sgRVNNIG1vZHVsZXMgdGhhdCBjYXVzZSBpc3N1ZXMgaW4gSmVzdFxuamVzdC5tb2NrKCdsYW5nZnVzZScsICgpID0+ICh7XG4gIExhbmdmdXNlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gICAgdHJhY2U6IGplc3QuZm4oKSxcbiAgICBnZW5lcmF0aW9uOiBqZXN0LmZuKCksXG4gICAgc3BhbjogamVzdC5mbigpLFxuICAgIHNjb3JlOiBqZXN0LmZuKCksXG4gICAgc2h1dGRvd25Bc3luYzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gIH0pKSxcbn0pKVxuXG4vLyDorr7nva7njq/looPlj5jph4/nlKjkuo7mtYvor5VcbnByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnXG5wcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gJ3Rlc3Qtand0LXNlY3JldC1mb3ItdGVzdGluZy1vbmx5J1xucHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMID0gJ3Bvc3RncmVzcWw6Ly90ZXN0OnRlc3RAbG9jYWxob3N0OjU0MzIvdGVzdF9kYidcblxuLy8g6KGl6b2Q57y65aSx55qE546v5aKD5Y+Y6YePXG5wcm9jZXNzLmVudi5FTkNSWVBUSU9OX0tFWSA9ICd0ZXN0LWVuY3J5cHRpb24ta2V5LTMyLWNoYXJhY3RlcnMtbG9uZydcbnByb2Nlc3MuZW52LkVOQ1JZUFRJT05fU0FMVCA9ICd0ZXN0LWVuY3J5cHRpb24tc2FsdC0xNi1jaGFycydcbnByb2Nlc3MuZW52LkVOQ1JZUFRJT05fVVNFX1NBTFQgPSAnZmFsc2UnXG5wcm9jZXNzLmVudi5FTkNSWVBUSU9OX0FMR09SSVRITSA9ICdhZXMtMjU2LWdjbSdcbnByb2Nlc3MuZW52LkNMRVJLX1NFQ1JFVF9LRVkgPSAndGVzdC1jbGVyay1zZWNyZXQta2V5J1xucHJvY2Vzcy5lbnYuQ0xFUktfUFVCTElTSEFCTEVfS0VZID0gJ3Rlc3QtY2xlcmstcHVibGlzaGFibGUta2V5J1xucHJvY2Vzcy5lbnYuQ0xFUktfV0VCSE9PS19TRUNSRVRfS0VZID0gJ3Rlc3QtY2xlcmstd2ViaG9vay1zZWNyZXQnXG5wcm9jZXNzLmVudi5SQUJCSVRNUV9VUkwgPSAnYW1xcDovL2xvY2FsaG9zdDo1NjcyJ1xucHJvY2Vzcy5lbnYuUkVESVNfVVJMID0gJ3JlZGlzOi8vbG9jYWxob3N0OjYzNzknXG5wcm9jZXNzLmVudi5TRU5UUllfRFNOID0gJ2h0dHBzOi8vdGVzdEB0ZXN0LmluZ2VzdC5zZW50cnkuaW8vdGVzdCdcbnByb2Nlc3MuZW52LlNFTlRSWV9FTlZJUk9OTUVOVCA9ICd0ZXN0J1xucHJvY2Vzcy5lbnYuU0VOVFJZX1RSQUNFU19TQU1QTEVfUkFURSA9ICcwLjEnXG5wcm9jZXNzLmVudi5RRFJBTlRfVVJMID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6NjMzMydcbnByb2Nlc3MuZW52LlFEUkFOVF9BUElfS0VZID0gJ3Rlc3QtcWRyYW50LWFwaS1rZXknXG5wcm9jZXNzLmVudi5GQUxMQkFDS19BUElfS0VZID0gJ3Rlc3QtZmFsbGJhY2stYXBpLWtleSdcbnByb2Nlc3MuZW52LkZBTExCQUNLX01PREVMX0lEID0gJ2RlZXBzZWVrLWNoYXQnXG5wcm9jZXNzLmVudi5GQUxMQkFDS19CQVNFX1VSTCA9ICdodHRwczovL2FwaS5kZWVwc2Vlay5jb20nXG5wcm9jZXNzLmVudi5EQl9DT05ORUNUSU9OX0xJTUlUID0gJzIwJ1xucHJvY2Vzcy5lbnYuREJfUE9PTF9USU1FT1VUID0gJzIwJ1xucHJvY2Vzcy5lbnYuREJfSURMRV9USU1FT1VUID0gJzMwMCdcbnByb2Nlc3MuZW52LkpXVF9FWFBJUkFUSU9OX1NFQ09ORFMgPSAnMzYwMCdcbnByb2Nlc3MuZW52LkJBQ0tFTkRfR0FURVdBWV9QT1JUID0gJzMwMDAnXG5wcm9jZXNzLmVudi5DUkVBVElPTl9BR0VOVF9IVFRQX1BPUlQgPSAnODA4MCdcbnByb2Nlc3MuZW52LkxPR0lDX0FHRU5UX0hUVFBfUE9SVCA9ICc4MDgxJ1xucHJvY2Vzcy5lbnYuTkFSUkFUSVZFX0FHRU5UX0hUVFBfUE9SVCA9ICc4MDgyJ1xuXG4vLyDmuIXnkIblh73mlbAgLSDlnKjmr4/kuKrmtYvor5XlkI7ov5DooYxcbmFmdGVyRWFjaCgoKSA9PiB7XG4gIC8vIOmHjee9ruaJgOaciW1vY2tcbiAgamVzdC5jbGVhckFsbE1vY2tzKClcblxuICAvLyDmuIXnkIbku7vkvZXlj6/og73nmoTmlofku7bns7vnu5/mm7TmlLnvvIjlpoLmnpzpgILnlKjvvIlcbiAgLy8g5rOo5oSP77ya5a6e6ZmF55qE5paH5Lu257O757uf5pON5L2c5bqU6K+l5Zyo6ZuG5oiQ5rWL6K+V5Lit6L+b6KGMXG5cbiAgLy8g5qOA5p+l5piv5ZCm5pyJ5pyq5aSE55CG55qE5byC5q2l5pON5L2cXG4gIGlmIChqZXN0LmdldFRpbWVyQ291bnQoKSA+IDApIHtcbiAgICBjb25zb2xlLndhcm4oYFdhcm5pbmc6ICR7amVzdC5nZXRUaW1lckNvdW50KCl9IHRpbWVycyBzdGlsbCBhY3RpdmUgYWZ0ZXIgdGVzdGApXG4gIH1cbn0pXG5cbmFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgLy8g5riF55CG5rWL6K+V6LWE5rqQXG4gIGplc3QuY2xlYXJBbGxNb2NrcygpXG59LCA1MDAwKVxuXG4vLyDoh6rlrprkuYnljLnphY3lmahcbmV4cGVjdC5leHRlbmQoe1xuICB0b0JlVmFsaWREYXRlKHJlY2VpdmVkOiBhbnkpIHtcbiAgICBjb25zdCBwYXNzID0gcmVjZWl2ZWQgaW5zdGFuY2VvZiBEYXRlICYmICFOdW1iZXIuaXNOYU4ocmVjZWl2ZWQuZ2V0VGltZSgpKVxuICAgIGlmIChwYXNzKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBtZXNzYWdlOiAoKSA9PiBgZXhwZWN0ZWQgJHtyZWNlaXZlZH0gbm90IHRvIGJlIGEgdmFsaWQgZGF0ZWAsXG4gICAgICAgIHBhc3M6IHRydWUsXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG1lc3NhZ2U6ICgpID0+IGBleHBlY3RlZCAke3JlY2VpdmVkfSB0byBiZSBhIHZhbGlkIGRhdGVgLFxuICAgICAgICBwYXNzOiBmYWxzZSxcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgdG9CZVZhbGlkVVVJRChyZWNlaXZlZDogYW55KSB7XG4gICAgY29uc3QgdXVpZFJlZ2V4ID0gL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS1bMS01XVswLTlhLWZdezN9LVs4OWFiXVswLTlhLWZdezN9LVswLTlhLWZdezEyfSQvaVxuICAgIGNvbnN0IHBhc3MgPSB0eXBlb2YgcmVjZWl2ZWQgPT09ICdzdHJpbmcnICYmIHV1aWRSZWdleC50ZXN0KHJlY2VpdmVkKVxuICAgIGlmIChwYXNzKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBtZXNzYWdlOiAoKSA9PiBgZXhwZWN0ZWQgJHtyZWNlaXZlZH0gbm90IHRvIGJlIGEgdmFsaWQgVVVJRGAsXG4gICAgICAgIHBhc3M6IHRydWUsXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG1lc3NhZ2U6ICgpID0+IGBleHBlY3RlZCAke3JlY2VpdmVkfSB0byBiZSBhIHZhbGlkIFVVSURgLFxuICAgICAgICBwYXNzOiBmYWxzZSxcbiAgICAgIH1cbiAgICB9XG4gIH0sXG59KVxuXG4vLyDlr7zlh7rnsbvlnovku6Xkvr/lnKjmtYvor5XkuK3kvb/nlKhcbmRlY2xhcmUgZ2xvYmFsIHtcbiAgbmFtZXNwYWNlIGplc3Qge1xuICAgIGludGVyZmFjZSBNYXRjaGVyczxSPiB7XG4gICAgICB0b0JlVmFsaWREYXRlKCk6IFJcbiAgICAgIHRvQmVWYWxpZFVVSUQoKTogUlxuICAgIH1cbiAgfVxufVxuXG4vLyDlhoXlrZjkvb/nlKjnm5HmjqdcbmlmIChwcm9jZXNzLmVudi5DSSkge1xuICBjb25zdCBpbml0aWFsTWVtb3J5ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpXG4gIGNvbnN0IG1lbW9yeVRocmVzaG9sZCA9IDUwMCAqIDEwMjQgKiAxMDI0IC8vIDUwME1CXG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBjb25zdCBjdXJyZW50TWVtb3J5ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpXG4gICAgY29uc3QgbWVtb3J5SW5jcmVhc2UgPSBjdXJyZW50TWVtb3J5LmhlYXBVc2VkIC0gaW5pdGlhbE1lbW9yeS5oZWFwVXNlZFxuXG4gICAgaWYgKG1lbW9yeUluY3JlYXNlID4gbWVtb3J5VGhyZXNob2xkKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBXYXJuaW5nOiBNZW1vcnkgdXNhZ2UgaW5jcmVhc2VkIGJ5ICR7TWF0aC5yb3VuZChtZW1vcnlJbmNyZWFzZSAvIDEwMjQgLyAxMDI0KX1NQmBcbiAgICAgIClcbiAgICB9XG4gIH0pXG59XG4iXSwidmVyc2lvbiI6M30=