{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\vcp-protocol.service.ts","mappings":";AAAA,+EAA+E;AAC/E,cAAc;AACd,6BAA6B;AAC7B,+EAA+E;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE/E,2CAAsE;AAEtE,gGAQuE;IAG1D,kBAAkB;4BAD9B,IAAA,mBAAU,GAAE;;;;;;;;YACb,6KAghBC;;;YAhhBY,uDAAkB;;QAGT,aAAa;QAFhB,MAAM,GAAG,IAAI,eAAM,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAA;QAE7D,YAAoB,aAA4B;YAA5B,kBAAa,GAAb,aAAa,CAAe;QAAG,CAAC;QAEpD,KAAK,CAAC,YAAY;YAChB,MAAM,IAAI,CAAC,qBAAqB,EAAE,CAAA;YAClC,IAAI,CAAC,qBAAqB,EAAE,CAAA;YAC5B,IAAI,CAAC,uBAAuB,EAAE,CAAA;YAC9B,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,aAAa,CAAC,CAAA;QAChC,CAAC;QAED,kDAAkD;QAElD;;WAEG;QACK,KAAK,CAAC,qBAAqB;YACjC,YAAY;YACZ,yBAAW,CAAC,EAAE,CAAC,SAAS,EAAE,CAAC,OAAmB,EAAE,EAAE;gBAChD,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,YAAY,OAAO,CAAC,MAAM,EAAE,CAAC,CAAA;YACjD,CAAC,CAAC,CAAA;YAEF,yBAAW,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,KAAY,EAAE,EAAE;gBACvC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,UAAU,EAAE,KAAK,CAAC,CAAA;YACtC,CAAC,CAAC,CAAA;YAEF,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,aAAa,CAAC,CAAA;QAChC,CAAC;QAED;;WAEG;QACK,qBAAqB;YAC3B,YAAY;YACZ,yBAAW,CAAC,SAAS,CAAC,gBAAgB,EAAE,CAAC,OAAmB,EAAE,EAAE;gBAC9D,IAAI,CAAC,wBAAwB,CAAC,OAAO,CAAC,CAAA;YACxC,CAAC,CAAC,CAAA;YAEF,yBAAW,CAAC,SAAS,CAAC,qBAAqB,EAAE,CAAC,OAAmB,EAAE,EAAE;gBACnE,IAAI,CAAC,6BAA6B,CAAC,OAAO,CAAC,CAAA;YAC7C,CAAC,CAAC,CAAA;YAEF,yBAAW,CAAC,SAAS,CAAC,sBAAsB,EAAE,CAAC,OAAmB,EAAE,EAAE;gBACpE,IAAI,CAAC,8BAA8B,CAAC,OAAO,CAAC,CAAA;YAC9C,CAAC,CAAC,CAAA;QACJ,CAAC;QAED;;WAEG;QACK,uBAAuB;YAC7B,WAAW;YACX,yBAAW,CAAC,gBAAgB,CAAC;gBAC3B,EAAE,EAAE,YAAY;gBAChB,IAAI,EAAE,SAAS;gBACf,GAAG,EAAE,uBAAuB;gBAC5B,YAAY,EAAE,CAAC,iBAAiB,EAAE,kBAAkB,EAAE,UAAU,CAAC;gBACjE,MAAM,EAAE,QAAQ;gBAChB,QAAQ,EAAE;oBACR,OAAO,EAAE,OAAO;oBAChB,WAAW,EAAE,QAAQ;oBACrB,MAAM,EAAE,QAAQ;oBAChB,QAAQ,EAAE,IAAI,IAAI,EAAE;iBACrB;aACF,CAAC,CAAA;YAEF,WAAW;YACX,yBAAW,CAAC,gBAAgB,CAAC;gBAC3B,EAAE,EAAE,gBAAgB;gBACpB,IAAI,EAAE,SAAS;gBACf,GAAG,EAAE,2BAA2B;gBAChC,YAAY,EAAE,CAAC,aAAa,EAAE,cAAc,EAAE,eAAe,CAAC;gBAC9D,MAAM,EAAE,QAAQ;gBAChB,QAAQ,EAAE;oBACR,OAAO,EAAE,OAAO;oBAChB,WAAW,EAAE,QAAQ;oBACrB,MAAM,EAAE,QAAQ;oBAChB,QAAQ,EAAE,IAAI,IAAI,EAAE;iBACrB;aACF,CAAC,CAAA;YAEF,WAAW;YACX,yBAAW,CAAC,gBAAgB,CAAC;gBAC3B,EAAE,EAAE,cAAc;gBAClB,IAAI,EAAE,SAAS;gBACf,GAAG,EAAE,yBAAyB;gBAC9B,YAAY,EAAE,CAAC,aAAa,EAAE,eAAe,EAAE,WAAW,CAAC;gBAC3D,MAAM,EAAE,QAAQ;gBAChB,QAAQ,EAAE;oBACR,OAAO,EAAE,OAAO;oBAChB,WAAW,EAAE,QAAQ;oBACrB,MAAM,EAAE,QAAQ;oBAChB,QAAQ,EAAE,IAAI,IAAI,EAAE;iBACrB;aACF,CAAC,CAAA;YAEF,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,SAAS,CAAC,CAAA;QAC5B,CAAC;QAED,kDAAkD;QAElD;;WAEG;QACK,KAAK,CAAC,wBAAwB,CAAC,OAAmB;YACxD,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,OAAO,CAAC,OAAO,CAAA;YAClD,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,WAAW,MAAM,MAAM,MAAM,EAAE,CAAC,CAAA;YAElD,kBAAkB;YAClB,IAAI,MAAM,KAAK,OAAO,EAAE,CAAC;gBACvB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,MAAM,EAAE,EAAE,MAAM,CAAC,CAAA;YAC/C,CAAC;QACH,CAAC;QAED;;WAEG;QACK,KAAK,CAAC,6BAA6B,CAAC,OAAmB;YAC7D,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,OAAO,EAAE,GAAG,OAAO,CAAC,OAAO,CAAA;YACpD,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,cAAc,OAAO,MAAM,MAAM,EAAE,CAAC,CAAA;YAEtD,YAAY;QACd,CAAC;QAED;;WAEG;QACK,KAAK,CAAC,8BAA8B,CAAC,OAAmB;YAC9D,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,MAAM,EAAE,GAAG,OAAO,CAAC,OAAO,CAAA;YACrD,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,WAAW,OAAO,MAAM,QAAQ,OAAO,MAAM,EAAE,CAAC,CAAA;YAElE,WAAW;QACb,CAAC;QAED,mDAAmD;QAEnD;;WAEG;QACH,KAAK,CAAC,oBAAoB,CACxB,MAAc,EACd,UAKI,EAAE;YAEN,MAAM,OAAO,GAAmB;gBAC9B,MAAM,EAAE,OAAO,CAAC,IAAI,KAAK,OAAO,CAAC,CAAC,CAAC,iBAAiB,CAAC,CAAC,CAAC,gBAAgB;gBACvE,MAAM,EAAE,UAAU;gBAClB,UAAU,EAAE;oBACV,MAAM;oBACN,KAAK,EAAE,OAAO,CAAC,KAAK,IAAI,OAAO;oBAC/B,WAAW,EAAE,OAAO,CAAC,WAAW,IAAI,GAAG;oBACvC,SAAS,EAAE,OAAO,CAAC,SAAS,IAAI,IAAI;iBACrC;gBACD,OAAO,EAAE;oBACP,OAAO,EAAE,KAAK,EAAE,QAAQ;oBACxB,KAAK,EAAE,IAAI;iBACZ;aACF,CAAA;YAED,IAAI,CAAC;gBACH,MAAM,QAAQ,GAAG,MAAM,yBAAW,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAA;gBACpD,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,aAAa,OAAO,CAAC,MAAM,EAAE,CAAC,CAAA;gBAC9C,OAAO,QAAQ,CAAA;YACjB,CAAC;YAAC,OAAO,KAAU,EAAE,CAAC;gBACpB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,aAAa,OAAO,CAAC,MAAM,EAAE,EAAE,KAAK,CAAC,CAAA;gBACvD,MAAM,KAAK,CAAA;YACb,CAAC;QACH,CAAC;QAED;;WAEG;QACH,KAAK,CAAC,gBAAgB,CAAC,OAAe,EAAE,YAAoB;YAC1D,MAAM,OAAO,GAAmB;gBAC9B,MAAM,EAAE,kBAAkB;gBAC1B,MAAM,EAAE,SAAS;gBACjB,UAAU,EAAE;oBACV,OAAO;oBACP,IAAI,EAAE,YAAY;iBACnB;gBACD,OAAO,EAAE;oBACP,OAAO,EAAE,KAAK;oBACd,KAAK,EAAE,KAAK;iBACb;aACF,CAAA;YAED,MAAM,QAAQ,GAAG,MAAM,yBAAW,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAA;YACpD,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,aAAa,YAAY,EAAE,CAAC,CAAA;YAC5C,OAAO,QAAQ,CAAA;QACjB,CAAC;QAED;;WAEG;QACH,KAAK,CAAC,mBAAmB,CAAC,IAAY,EAAE,cAAsB;YAC5D,MAAM,OAAO,GAAmB;gBAC9B,MAAM,EAAE,YAAY;gBACpB,MAAM,EAAE,WAAW;gBACnB,UAAU,EAAE;oBACV,IAAI;oBACJ,cAAc;iBACf;aACF,CAAA;YAED,MAAM,QAAQ,GAAG,MAAM,yBAAW,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAA;YACpD,OAAO,QAAQ,CAAC,MAAM,EAAE,cAAc,IAAI,IAAI,CAAA;QAChD,CAAC;QAED,mDAAmD;QAEnD;;WAEG;QACH,KAAK,CAAC,UAAU,CAAC,GAAW,EAAE,QAAwC,QAAQ;YAC5E,MAAM,SAAS,GAAuB;gBACpC,SAAS,EAAE,MAAM;gBACjB,KAAK;gBACL,UAAU,EAAE,EAAE,GAAG,EAAE;aACpB,CAAA;YAED,MAAM,OAAO,GAAe;gBAC1B,EAAE,EAAE,eAAe,IAAI,CAAC,GAAG,EAAE,EAAE;gBAC/B,OAAO,EAAE,KAAK;gBACd,IAAI,EAAE,SAAS;gBACf,MAAM,EAAE,aAAa;gBACrB,OAAO,EAAE,SAAS;gBAClB,QAAQ,EAAE;oBACR,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,sBAAsB;oBAC9B,QAAQ,EAAE,QAAQ;iBACnB;gBACD,QAAQ,EAAE;oBACR,WAAW,EAAE,CAAC,aAAa,CAAC;iBAC7B;aACF,CAAA;YAED,MAAM,QAAQ,GAAG,MAAM,yBAAW,CAAC,WAAW,CAAC,OAAO,CAAC,CAAA;YACvD,OAAO,QAAQ,CAAA;QACjB,CAAC;QAED;;WAEG;QACH,KAAK,CAAC,WAAW,CACf,GAAW,EACX,KAAU,EACV,QAAwC,QAAQ;YAEhD,MAAM,SAAS,GAAuB;gBACpC,SAAS,EAAE,OAAO;gBAClB,KAAK;gBACL,UAAU,EAAE,EAAE,GAAG,EAAE,KAAK,EAAE;aAC3B,CAAA;YAED,MAAM,OAAO,GAAe;gBAC1B,EAAE,EAAE,gBAAgB,IAAI,CAAC,GAAG,EAAE,EAAE;gBAChC,OAAO,EAAE,KAAK;gBACd,IAAI,EAAE,SAAS;gBACf,MAAM,EAAE,cAAc;gBACtB,OAAO,EAAE,SAAS;gBAClB,QAAQ,EAAE;oBACR,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,sBAAsB;oBAC9B,QAAQ,EAAE,QAAQ;iBACnB;gBACD,QAAQ,EAAE;oBACR,WAAW,EAAE,CAAC,cAAc,CAAC;iBAC9B;aACF,CAAA;YAED,MAAM,yBAAW,CAAC,WAAW,CAAC,OAAO,CAAC,CAAA;QACxC,CAAC;QAED;;WAEG;QACH,KAAK,CAAC,YAAY,CAAC,KAAa,EAAE,IAAe;YAC/C,MAAM,SAAS,GAAuB;gBACpC,SAAS,EAAE,QAAQ;gBACnB,KAAK,EAAE,QAAQ;gBACf,UAAU,EAAE;oBACV,KAAK;oBACL,IAAI;oBACJ,KAAK,EAAE,EAAE;iBACV;aACF,CAAA;YAED,MAAM,OAAO,GAAe;gBAC1B,EAAE,EAAE,iBAAiB,IAAI,CAAC,GAAG,EAAE,EAAE;gBACjC,OAAO,EAAE,KAAK;gBACd,IAAI,EAAE,SAAS;gBACf,MAAM,EAAE,eAAe;gBACvB,OAAO,EAAE,SAAS;gBAClB,QAAQ,EAAE;oBACR,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,sBAAsB;oBAC9B,QAAQ,EAAE,QAAQ;iBACnB;gBACD,QAAQ,EAAE;oBACR,WAAW,EAAE,CAAC,aAAa,CAAC;iBAC7B;aACF,CAAA;YAED,MAAM,QAAQ,GAAG,MAAM,yBAAW,CAAC,WAAW,CAAC,OAAO,CAAC,CAAA;YACvD,OAAO,QAAQ,EAAE,OAAO,IAAI,EAAE,CAAA;QAChC,CAAC;QAED,mDAAmD;QAEnD;;WAEG;QACH,KAAK,CAAC,UAAU,CACd,QAAa,EACb,OAAkD;YAElD,MAAM,SAAS,GAAqB;gBAClC,SAAS,EAAE,QAAQ;gBACnB,IAAI,EAAE,OAAO,EAAE,QAAQ,IAAI,UAAU,IAAI,CAAC,GAAG,EAAE,EAAE;gBACjD,IAAI,EAAE,QAAQ;gBACd,OAAO,EAAE;oBACP,QAAQ,EAAE,OAAO,EAAE,QAAQ;iBAC5B;aACF,CAAA;YAED,MAAM,OAAO,GAAe;gBAC1B,EAAE,EAAE,eAAe,IAAI,CAAC,GAAG,EAAE,EAAE;gBAC/B,OAAO,EAAE,KAAK;gBACd,IAAI,EAAE,SAAS;gBACf,MAAM,EAAE,aAAa;gBACrB,OAAO,EAAE,SAAS;gBAClB,QAAQ,EAAE;oBACR,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,sBAAsB;oBAC9B,QAAQ,EAAE,QAAQ;iBACnB;gBACD,QAAQ,EAAE;oBACR,WAAW,EAAE,CAAC,aAAa,CAAC;iBAC7B;aACF,CAAA;YAED,MAAM,QAAQ,GAAG,MAAM,yBAAW,CAAC,WAAW,CAAC,OAAO,CAAC,CAAA;YACvD,OAAO,QAAQ,CAAA;QACjB,CAAC;QAED;;WAEG;QACH,KAAK,CAAC,YAAY,CAAC,MAAc;YAC/B,MAAM,SAAS,GAAqB;gBAClC,SAAS,EAAE,UAAU;gBACrB,IAAI,EAAE,MAAM;aACb,CAAA;YAED,MAAM,OAAO,GAAe;gBAC1B,EAAE,EAAE,iBAAiB,IAAI,CAAC,GAAG,EAAE,EAAE;gBACjC,OAAO,EAAE,KAAK;gBACd,IAAI,EAAE,SAAS;gBACf,MAAM,EAAE,eAAe;gBACvB,OAAO,EAAE,SAAS;gBAClB,QAAQ,EAAE;oBACR,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,sBAAsB;oBAC9B,QAAQ,EAAE,QAAQ;iBACnB;gBACD,QAAQ,EAAE;oBACR,WAAW,EAAE,CAAC,eAAe,CAAC;iBAC/B;aACF,CAAA;YAED,MAAM,QAAQ,GAAG,MAAM,yBAAW,CAAC,WAAW,CAAC,OAAO,CAAC,CAAA;YACvD,OAAO,QAAQ,EAAE,IAAI,CAAA;QACvB,CAAC;QAED,mDAAmD;QAEnD;;WAEG;QACH,KAAK,CAAC,0BAA0B,CAAC,OAAe,EAAE,MAAc,EAAE,OAAY;YAC5E,MAAM,OAAO,GAAe;gBAC1B,EAAE,EAAE,iBAAiB,IAAI,CAAC,GAAG,EAAE,EAAE;gBACjC,OAAO,EAAE,KAAK;gBACd,IAAI,EAAE,SAAS;gBACf,MAAM,EAAE,oBAAoB;gBAC5B,OAAO,EAAE;oBACP,OAAO;oBACP,MAAM;oBACN,OAAO;oBACP,OAAO,EAAE;wBACP,KAAK,EAAE,IAAI;wBACX,QAAQ,EAAE,MAAM;qBACjB;iBACF;gBACD,QAAQ,EAAE;oBACR,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,mBAAmB;oBAC3B,QAAQ,EAAE,MAAM;iBACjB;gBACD,QAAQ,EAAE;oBACR,WAAW,EAAE,CAAC,oBAAoB,CAAC;iBACpC;aACF,CAAA;YAED,MAAM,QAAQ,GAAG,MAAM,yBAAW,CAAC,WAAW,CAAC,OAAO,CAAC,CAAA;YACvD,OAAO,QAAQ,EAAE,MAAM,IAAI,OAAO,CAAC,EAAE,CAAA;QACvC,CAAC;QAED;;WAEG;QACH,KAAK,CAAC,yBAAyB,CAC7B,eAAuB,EACvB,QAAkB,EAClB,IAAS;YAET,MAAM,OAAO,GAAe;gBAC1B,EAAE,EAAE,iBAAiB,IAAI,CAAC,GAAG,EAAE,EAAE;gBACjC,OAAO,EAAE,KAAK;gBACd,IAAI,EAAE,SAAS;gBACf,MAAM,EAAE,mBAAmB;gBAC3B,OAAO,EAAE;oBACP,eAAe;oBACf,QAAQ;oBACR,IAAI;oBACJ,QAAQ,EAAE,UAAU,EAAE,OAAO;iBAC9B;gBACD,QAAQ,EAAE;oBACR,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,uBAAuB;oBAC/B,QAAQ,EAAE,QAAQ;iBACnB;gBACD,QAAQ,EAAE;oBACR,WAAW,EAAE,CAAC,mBAAmB,CAAC;iBACnC;aACF,CAAA;YAED,MAAM,QAAQ,GAAG,MAAM,yBAAW,CAAC,WAAW,CAAC,OAAO,CAAC,CAAA;YACvD,OAAO,QAAQ,EAAE,eAAe,IAAI,eAAe,CAAA;QACrD,CAAC;QAED;;WAEG;QACH,KAAK,CAAC,oBAAoB,CAAC,SAAiB,EAAE,SAAc;YAC1D,MAAM,OAAO,GAAe;gBAC1B,EAAE,EAAE,gBAAgB,IAAI,CAAC,GAAG,EAAE,EAAE;gBAChC,OAAO,EAAE,KAAK;gBACd,IAAI,EAAE,OAAO;gBACb,MAAM,EAAE,UAAU,SAAS,EAAE;gBAC7B,OAAO,EAAE,SAAS;gBAClB,QAAQ,EAAE;oBACR,SAAS,EAAE,IAAI,IAAI,EAAE;oBACrB,MAAM,EAAE,QAAQ;oBAChB,QAAQ,EAAE,QAAQ;iBACnB;gBACD,QAAQ,EAAE;oBACR,WAAW,EAAE,CAAC,kBAAkB,CAAC;iBAClC;aACF,CAAA;YAED,MAAM,yBAAW,CAAC,WAAW,CAAC,OAAO,CAAC,CAAA;QACxC,CAAC;QAED,iDAAiD;QAEjD;;WAEG;QACH,qBAAqB,CAAC,UAAmB;YACvC,OAAO,yBAAW,CAAC,aAAa,CAAC,UAAU,CAAC,CAAA;QAC9C,CAAC;QAED;;WAEG;QACH,gBAAgB,CAAC,QAAqB;YACpC,yBAAW,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAA;YACtC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,aAAa,QAAQ,CAAC,EAAE,EAAE,CAAC,CAAA;QAC7C,CAAC;QAED;;WAEG;QACH,kBAAkB,CAAC,UAAkB;YACnC,yBAAW,CAAC,kBAAkB,CAAC,UAAU,CAAC,CAAA;YAC1C,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,UAAU,UAAU,EAAE,CAAC,CAAA;QACzC,CAAC;QAED,kDAAkD;QAElD;;WAEG;QACH,gBAAgB;YACd,OAAO,yBAAW,CAAC,QAAQ,EAAE,CAAA;QAC/B,CAAC;QAED;;WAEG;QACH,KAAK,CAAC,WAAW;YACf,IAAI,CAAC;gBACH,MAAM,KAAK,GAAG,IAAI,CAAC,gBAAgB,EAAE,CAAA;gBACrC,OAAO;oBACL,MAAM,EAAE,SAAS;oBACjB,OAAO,EAAE,KAAK;iBACf,CAAA;YACH,CAAC;YAAC,OAAO,KAAU,EAAE,CAAC;gBACpB,OAAO;oBACL,MAAM,EAAE,OAAO;oBACf,OAAO,EAAE,KAAK,CAAC,OAAO;iBACvB,CAAA;YACH,CAAC;QACH,CAAC;QAED;;WAEG;QACH,KAAK,CAAC,mBAAmB;YACvB,gBAAgB;YAChB,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,aAAa,CAAC,CAAA;QAChC,CAAC;;;;AA/gBU,gDAAkB","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\vcp-protocol.service.ts"],"sourcesContent":["// ============================================================================\n// VCP协议核心服务集成\n// 集成 VCPToolBox 的统一交互标准到创世星环\n// ============================================================================\n\nimport { Injectable, Logger, type OnModuleInit } from '@nestjs/common'\nimport { ConfigService } from '@nestjs/config'\nimport {\n  type VCPEndpoint,\n  type VCPFileOperation,\n  type VCPMemoryOperation,\n  type VCPMessage,\n  type VCPToolRequest,\n  type VCPToolResponse,\n  vcpProtocol,\n} from '../../../apps/vcptoolbox/src/modules/communication/VCPProtocol'\n\n@Injectable()\nexport class VCPProtocolService implements OnModuleInit {\n  private readonly logger = new Logger(VCPProtocolService.name)\n\n  constructor(private configService: ConfigService) {}\n\n  async onModuleInit() {\n    await this.initializeVCPProtocol()\n    this.setupProtocolHandlers()\n    this.registerSystemEndpoints()\n    this.logger.log('VCP协议服务已初始化')\n  }\n\n  // ==================== 协议初始化 ====================\n\n  /**\n   * 初始化VCP协议\n   */\n  private async initializeVCPProtocol(): Promise<void> {\n    // 设置协议事件监听器\n    vcpProtocol.on('message', (message: VCPMessage) => {\n      this.logger.debug(`VCP消息接收: ${message.action}`)\n    })\n\n    vcpProtocol.on('error', (error: Error) => {\n      this.logger.error('VCP协议错误:', error)\n    })\n\n    this.logger.log('VCP协议核心已初始化')\n  }\n\n  /**\n   * 设置协议处理器\n   */\n  private setupProtocolHandlers(): void {\n    // 订阅重要的协议事件\n    vcpProtocol.subscribe('tool.execution', (message: VCPMessage) => {\n      this.handleToolExecutionEvent(message)\n    })\n\n    vcpProtocol.subscribe('agent.collaboration', (message: VCPMessage) => {\n      this.handleAgentCollaborationEvent(message)\n    })\n\n    vcpProtocol.subscribe('narrative.generation', (message: VCPMessage) => {\n      this.handleNarrativeGenerationEvent(message)\n    })\n  }\n\n  /**\n   * 注册系统端点\n   */\n  private registerSystemEndpoints(): void {\n    // 注册AI服务端点\n    vcpProtocol.registerEndpoint({\n      id: 'ai-service',\n      type: 'service',\n      url: 'internal://ai-service',\n      capabilities: ['text-generation', 'image-generation', 'analysis'],\n      status: 'online',\n      metadata: {\n        version: '1.0.0',\n        description: 'AI服务端点',\n        author: 'system',\n        lastSeen: new Date(),\n      },\n    })\n\n    // 注册记忆服务端点\n    vcpProtocol.registerEndpoint({\n      id: 'memory-service',\n      type: 'service',\n      url: 'internal://memory-service',\n      capabilities: ['memory-read', 'memory-write', 'memory-search'],\n      status: 'online',\n      metadata: {\n        version: '1.0.0',\n        description: '记忆服务端点',\n        author: 'system',\n        lastSeen: new Date(),\n      },\n    })\n\n    // 注册文件服务端点\n    vcpProtocol.registerEndpoint({\n      id: 'file-service',\n      type: 'service',\n      url: 'internal://file-service',\n      capabilities: ['file-upload', 'file-download', 'file-list'],\n      status: 'online',\n      metadata: {\n        version: '1.0.0',\n        description: '文件服务端点',\n        author: 'system',\n        lastSeen: new Date(),\n      },\n    })\n\n    this.logger.log('系统端点已注册')\n  }\n\n  // ==================== 事件处理器 ====================\n\n  /**\n   * 处理工具执行事件\n   */\n  private async handleToolExecutionEvent(message: VCPMessage): Promise<void> {\n    const { toolId, status, result } = message.payload\n    this.logger.debug(`工具执行事件: ${toolId} - ${status}`)\n\n    // 可以在这里添加监控、日志记录等\n    if (status === 'error') {\n      this.logger.warn(`工具执行失败: ${toolId}`, result)\n    }\n  }\n\n  /**\n   * 处理Agent协作事件\n   */\n  private async handleAgentCollaborationEvent(message: VCPMessage): Promise<void> {\n    const { agentId, action, context } = message.payload\n    this.logger.debug(`Agent协作事件: ${agentId} - ${action}`)\n\n    // 处理协作相关的逻辑\n  }\n\n  /**\n   * 处理叙事生成事件\n   */\n  private async handleNarrativeGenerationEvent(message: VCPMessage): Promise<void> {\n    const { storyId, progress, status } = message.payload\n    this.logger.debug(`叙事生成事件: ${storyId} - ${progress}% - ${status}`)\n\n    // 处理叙事生成进度\n  }\n\n  // ==================== 工具集成接口 ====================\n\n  /**\n   * 调用AI生成工具\n   */\n  async callAIGenerationTool(\n    prompt: string,\n    options: {\n      model?: string\n      temperature?: number\n      maxTokens?: number\n      type?: 'text' | 'image' | 'audio'\n    } = {}\n  ): Promise<VCPToolResponse> {\n    const request: VCPToolRequest = {\n      toolId: options.type === 'image' ? 'image-generator' : 'text-generator',\n      action: 'generate',\n      parameters: {\n        prompt,\n        model: options.model || 'gpt-4',\n        temperature: options.temperature || 0.7,\n        maxTokens: options.maxTokens || 1000,\n      },\n      options: {\n        timeout: 60000, // 60秒超时\n        async: true,\n      },\n    }\n\n    try {\n      const response = await vcpProtocol.callTool(request)\n      this.logger.log(`AI工具调用成功: ${request.toolId}`)\n      return response\n    } catch (error: any) {\n      this.logger.error(`AI工具调用失败: ${request.toolId}`, error)\n      throw error\n    }\n  }\n\n  /**\n   * 调用分析工具\n   */\n  async callAnalysisTool(content: string, analysisType: string): Promise<VCPToolResponse> {\n    const request: VCPToolRequest = {\n      toolId: 'content-analyzer',\n      action: 'analyze',\n      parameters: {\n        content,\n        type: analysisType,\n      },\n      options: {\n        timeout: 30000,\n        async: false,\n      },\n    }\n\n    const response = await vcpProtocol.callTool(request)\n    this.logger.log(`分析工具调用成功: ${analysisType}`)\n    return response\n  }\n\n  /**\n   * 调用翻译工具\n   */\n  async callTranslationTool(text: string, targetLanguage: string): Promise<string> {\n    const request: VCPToolRequest = {\n      toolId: 'translator',\n      action: 'translate',\n      parameters: {\n        text,\n        targetLanguage,\n      },\n    }\n\n    const response = await vcpProtocol.callTool(request)\n    return response.result?.translatedText || text\n  }\n\n  // ==================== 记忆操作接口 ====================\n\n  /**\n   * 读取记忆\n   */\n  async readMemory(key: string, scope: 'agent' | 'session' | 'global' = 'global'): Promise<any> {\n    const operation: VCPMemoryOperation = {\n      operation: 'read',\n      scope,\n      parameters: { key },\n    }\n\n    const message: VCPMessage = {\n      id: `memory-read-${Date.now()}`,\n      version: '1.0',\n      type: 'request',\n      action: 'memory.read',\n      payload: operation,\n      metadata: {\n        timestamp: new Date(),\n        source: 'vcp-protocol-service',\n        priority: 'normal',\n      },\n      security: {\n        permissions: ['memory.read'],\n      },\n    }\n\n    const response = await vcpProtocol.sendMessage(message)\n    return response\n  }\n\n  /**\n   * 写入记忆\n   */\n  async writeMemory(\n    key: string,\n    value: any,\n    scope: 'agent' | 'session' | 'global' = 'global'\n  ): Promise<void> {\n    const operation: VCPMemoryOperation = {\n      operation: 'write',\n      scope,\n      parameters: { key, value },\n    }\n\n    const message: VCPMessage = {\n      id: `memory-write-${Date.now()}`,\n      version: '1.0',\n      type: 'request',\n      action: 'memory.write',\n      payload: operation,\n      metadata: {\n        timestamp: new Date(),\n        source: 'vcp-protocol-service',\n        priority: 'normal',\n      },\n      security: {\n        permissions: ['memory.write'],\n      },\n    }\n\n    await vcpProtocol.sendMessage(message)\n  }\n\n  /**\n   * 搜索记忆\n   */\n  async searchMemory(query: string, tags?: string[]): Promise<any[]> {\n    const operation: VCPMemoryOperation = {\n      operation: 'search',\n      scope: 'global',\n      parameters: {\n        query,\n        tags,\n        limit: 10,\n      },\n    }\n\n    const message: VCPMessage = {\n      id: `memory-search-${Date.now()}`,\n      version: '1.0',\n      type: 'request',\n      action: 'memory.search',\n      payload: operation,\n      metadata: {\n        timestamp: new Date(),\n        source: 'vcp-protocol-service',\n        priority: 'normal',\n      },\n      security: {\n        permissions: ['memory.read'],\n      },\n    }\n\n    const response = await vcpProtocol.sendMessage(message)\n    return response?.results || []\n  }\n\n  // ==================== 文件操作接口 ====================\n\n  /**\n   * 上传文件\n   */\n  async uploadFile(\n    fileData: any,\n    options?: { mimeType?: string; filename?: string }\n  ): Promise<any> {\n    const operation: VCPFileOperation = {\n      operation: 'upload',\n      path: options?.filename || `upload-${Date.now()}`,\n      data: fileData,\n      options: {\n        mimeType: options?.mimeType,\n      },\n    }\n\n    const message: VCPMessage = {\n      id: `file-upload-${Date.now()}`,\n      version: '1.0',\n      type: 'request',\n      action: 'file.upload',\n      payload: operation,\n      metadata: {\n        timestamp: new Date(),\n        source: 'vcp-protocol-service',\n        priority: 'normal',\n      },\n      security: {\n        permissions: ['file.upload'],\n      },\n    }\n\n    const response = await vcpProtocol.sendMessage(message)\n    return response\n  }\n\n  /**\n   * 下载文件\n   */\n  async downloadFile(fileId: string): Promise<any> {\n    const operation: VCPFileOperation = {\n      operation: 'download',\n      path: fileId,\n    }\n\n    const message: VCPMessage = {\n      id: `file-download-${Date.now()}`,\n      version: '1.0',\n      type: 'request',\n      action: 'file.download',\n      payload: operation,\n      metadata: {\n        timestamp: new Date(),\n        source: 'vcp-protocol-service',\n        priority: 'normal',\n      },\n      security: {\n        permissions: ['file.download'],\n      },\n    }\n\n    const response = await vcpProtocol.sendMessage(message)\n    return response?.data\n  }\n\n  // ==================== 叙事专用接口 ====================\n\n  /**\n   * 发送叙事生成请求\n   */\n  async requestNarrativeGeneration(storyId: string, prompt: string, context: any): Promise<string> {\n    const message: VCPMessage = {\n      id: `narrative-gen-${Date.now()}`,\n      version: '1.0',\n      type: 'request',\n      action: 'narrative.generate',\n      payload: {\n        storyId,\n        prompt,\n        context,\n        options: {\n          async: true,\n          priority: 'high',\n        },\n      },\n      metadata: {\n        timestamp: new Date(),\n        source: 'narrative-service',\n        priority: 'high',\n      },\n      security: {\n        permissions: ['narrative.generate'],\n      },\n    }\n\n    const response = await vcpProtocol.sendMessage(message)\n    return response?.taskId || message.id\n  }\n\n  /**\n   * 发送Agent协作请求\n   */\n  async requestAgentCollaboration(\n    collaborationId: string,\n    agentIds: string[],\n    task: any\n  ): Promise<string> {\n    const message: VCPMessage = {\n      id: `collaboration-${Date.now()}`,\n      version: '1.0',\n      type: 'request',\n      action: 'agent.collaborate',\n      payload: {\n        collaborationId,\n        agentIds,\n        task,\n        strategy: 'parallel', // 并行协作\n      },\n      metadata: {\n        timestamp: new Date(),\n        source: 'collaboration-service',\n        priority: 'normal',\n      },\n      security: {\n        permissions: ['agent.collaborate'],\n      },\n    }\n\n    const response = await vcpProtocol.sendMessage(message)\n    return response?.collaborationId || collaborationId\n  }\n\n  /**\n   * 广播系统事件\n   */\n  async broadcastSystemEvent(eventType: string, eventData: any): Promise<void> {\n    const message: VCPMessage = {\n      id: `system-event-${Date.now()}`,\n      version: '1.0',\n      type: 'event',\n      action: `system.${eventType}`,\n      payload: eventData,\n      metadata: {\n        timestamp: new Date(),\n        source: 'system',\n        priority: 'normal',\n      },\n      security: {\n        permissions: ['system.broadcast'],\n      },\n    }\n\n    await vcpProtocol.sendMessage(message)\n  }\n\n  // ==================== 端点管理 ====================\n\n  /**\n   * 获取可用端点\n   */\n  getAvailableEndpoints(capability?: string): VCPEndpoint[] {\n    return vcpProtocol.findEndpoints(capability)\n  }\n\n  /**\n   * 注册自定义端点\n   */\n  registerEndpoint(endpoint: VCPEndpoint): void {\n    vcpProtocol.registerEndpoint(endpoint)\n    this.logger.log(`自定义端点已注册: ${endpoint.id}`)\n  }\n\n  /**\n   * 注销端点\n   */\n  unregisterEndpoint(endpointId: string): void {\n    vcpProtocol.unregisterEndpoint(endpointId)\n    this.logger.log(`端点已注销: ${endpointId}`)\n  }\n\n  // ==================== 监控和统计 ====================\n\n  /**\n   * 获取协议统计信息\n   */\n  getProtocolStats(): any {\n    return vcpProtocol.getStats()\n  }\n\n  /**\n   * 健康检查\n   */\n  async healthCheck(): Promise<{ status: string; details?: any }> {\n    try {\n      const stats = this.getProtocolStats()\n      return {\n        status: 'healthy',\n        details: stats,\n      }\n    } catch (error: any) {\n      return {\n        status: 'error',\n        details: error.message,\n      }\n    }\n  }\n\n  /**\n   * 清理过期任务\n   */\n  async cleanupExpiredTasks(): Promise<void> {\n    // 清理VCP协议中的过期任务\n    this.logger.log('VCP协议任务清理完成')\n  }\n}\n"],"version":3}