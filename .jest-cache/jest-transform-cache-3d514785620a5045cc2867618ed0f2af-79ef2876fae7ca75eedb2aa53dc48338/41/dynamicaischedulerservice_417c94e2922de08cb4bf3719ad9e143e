92ddad574d14df3fbd9f48213b703b42
"use strict";
// 文件路径: packages/common-backend/src/ai/dynamic-ai-scheduler.service.ts
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var DynamicAiSchedulerService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DynamicAiSchedulerService = void 0;
const common_1 = require("@nestjs/common");
let DynamicAiSchedulerService = DynamicAiSchedulerService_1 = class DynamicAiSchedulerService {
    prisma;
    aiProviderFactory;
    configService;
    logger = new common_1.Logger(DynamicAiSchedulerService_1.name);
    constructor(prisma, aiProviderFactory, configService) {
        this.prisma = prisma;
        this.aiProviderFactory = aiProviderFactory;
        this.configService = configService;
    }
    async getProviderForRole(user, role) {
        this.logger.debug(`[Scheduler] New request for role: "${role}" from user ${user.id}`);
        // [!] 核心改造 1: 查询逻辑翻译
        // 我们不再查询一个字符串数组，而是查询一个关系。
        // 我们要找的是：一个 AiConfiguration，它的 'roles' 关系中，
        // 'some' (至少有一个) Role 的 'name' 字段等于我们想要的 'role'。
        const dedicatedConfig = await this.prisma.aiConfiguration.findFirst({
            where: {
                ownerId: user.id,
                roles: {
                    some: {
                        name: role, // 这就是新的、正确的 Prisma 关系查询语法
                    },
                },
            },
        });
        if (dedicatedConfig) {
            this.logger.log(`[Scheduler] Priority 1 (Dedicated): Found dedicated config "${dedicatedConfig.provider}/${dedicatedConfig.modelId}" for role "${role}".`);
            return this.aiProviderFactory.createProvider(dedicatedConfig);
        }
        this.logger.debug(`[Scheduler] Priority 1 (Dedicated): No dedicated AI found for role "${role}".`);
        // 优先级 2: 征用逻辑保持不变
        const anyUserConfig = await this.prisma.aiConfiguration.findFirst({
            where: { ownerId: user.id },
            orderBy: { createdAt: 'asc' },
        });
        if (anyUserConfig) {
            this.logger.log(`[Scheduler] Priority 2 (Requisition): Requisitioning general-purpose AI "${anyUserConfig.provider}/${anyUserConfig.modelId}" for role "${role}".`);
            return this.aiProviderFactory.createProvider(anyUserConfig);
        }
        this.logger.debug(`[Scheduler] Priority 2 (Requisition): User has no AI configurations at all.`);
        // 优先级 3: 后备逻辑保持不变，但模拟对象结构需要改变
        this.logger.warn(`[Scheduler] Priority 3 (System Fallback): Falling back to system default AI for role "${role}".`);
        try {
            return this.createFallbackProvider();
        }
        catch (error) {
            this.logger.error(`[Scheduler] CRITICAL FAILURE: System fallback AI failed to initialize.`, error instanceof Error ? error.stack : undefined);
            throw new common_1.InternalServerErrorException('AI processing failed: No AI is available or configured correctly.');
        }
    }
    createFallbackProvider() {
        try {
            // 优先使用专门的DeepSeek配置，如果没有则使用后备配置
            const apiKey = this.configService.get('DEEPSEEK_API_KEY') ||
                this.configService.getOrThrow('FALLBACK_API_KEY');
            const modelId = this.configService.get('FALLBACK_MODEL_ID', 'deepseek-chat');
            const baseUrlFromEnv = this.configService.get('DEEPSEEK_BASE_URL') ||
                this.configService.get('FALLBACK_BASE_URL');
            // [!] 核心改造 2: 模拟对象结构翻译
            // 新的 AiConfiguration 类型没有 `assignedRoles` 字段。
            // 我们创建一个不包含任何角色信息的、纯粹的配置对象。
            // 注意：这个模拟对象缺少 'roles' 属性，所以我们需要告诉 TypeScript
            // 它符合 AiConfiguration 的形状（通过类型断言 as AiConfiguration）。
            const fallbackConfig = {
                id: 'system-fallback',
                provider: 'DeepSeek',
                apiKey,
                baseUrl: baseUrlFromEnv ?? null,
                modelId,
                ownerId: 'system',
                createdAt: new Date(),
                updatedAt: new Date(),
            }; // 类型断言，表示我们确信这个对象的结构是兼容的
            return this.aiProviderFactory.createProvider(fallbackConfig);
        }
        catch (error) {
            this.logger.error('System fallback AI configuration is missing or invalid. Check your .env file for FALLBACK_... variables.', error);
            throw new Error('System default AI is not configured.');
        }
    }
};
exports.DynamicAiSchedulerService = DynamicAiSchedulerService;
exports.DynamicAiSchedulerService = DynamicAiSchedulerService = DynamicAiSchedulerService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object, Object, Object])
], DynamicAiSchedulerService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxhaVxcZHluYW1pYy1haS1zY2hlZHVsZXIuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiO0FBQUEsdUVBQXVFOzs7Ozs7Ozs7Ozs7O0FBRXZFLDJDQUFpRjtBQVExRSxJQUFNLHlCQUF5QixpQ0FBL0IsTUFBTSx5QkFBeUI7SUFJakI7SUFDQTtJQUNBO0lBTEYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLDJCQUF5QixDQUFDLElBQUksQ0FBQyxDQUFBO0lBRXBFLFlBQ21CLE1BQXFCLEVBQ3JCLGlCQUFvQyxFQUNwQyxhQUE0QjtRQUY1QixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsa0JBQWEsR0FBYixhQUFhLENBQWU7SUFDNUMsQ0FBQztJQUVHLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxJQUFVLEVBQUUsSUFBWTtRQUN0RCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsSUFBSSxlQUFlLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBRXJGLHFCQUFxQjtRQUNyQiwwQkFBMEI7UUFDMUIsNENBQTRDO1FBQzVDLGlEQUFpRDtRQUNqRCxNQUFNLGVBQWUsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQztZQUNsRSxLQUFLLEVBQUU7Z0JBQ0wsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFO2dCQUNoQixLQUFLLEVBQUU7b0JBQ0wsSUFBSSxFQUFFO3dCQUNKLElBQUksRUFBRSxJQUFJLEVBQUUsMEJBQTBCO3FCQUN2QztpQkFDRjthQUNGO1NBQ0YsQ0FBQyxDQUFBO1FBRUYsSUFBSSxlQUFlLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYiwrREFBK0QsZUFBZSxDQUFDLFFBQVEsSUFBSSxlQUFlLENBQUMsT0FB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Q0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBdEdZLDhEQUF5QjtvQ0FBekIseUJBQXlCO0lBRHJDLElBQUEsbUJBQVUsR0FBRTs7R0FDQSx5QkFBeUIsQ0FzR3JDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxwYWNrYWdlc1xcY29tbW9uLWJhY2tlbmRcXHNyY1xcYWlcXGR5bmFtaWMtYWktc2NoZWR1bGVyLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8g5paH5Lu26Lev5b6EOiBwYWNrYWdlcy9jb21tb24tYmFja2VuZC9zcmMvYWkvZHluYW1pYy1haS1zY2hlZHVsZXIuc2VydmljZS50c1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uLCBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbidcbmltcG9ydCB0eXBlIHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJ1xuaW1wb3J0IHR5cGUgeyBBaUNvbmZpZ3VyYXRpb24sIFVzZXIgfSBmcm9tICdAcHJpc21hL2NsaWVudCdcbmltcG9ydCB0eXBlIHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3ByaXNtYS9wcmlzbWEuc2VydmljZSdcbmltcG9ydCB0eXBlIHsgQWlQcm92aWRlciwgQWlSb2xlIH0gZnJvbSAnLi4vdHlwZXMvYWktcHJvdmlkZXJzLnR5cGVzJ1xuaW1wb3J0IHR5cGUgeyBBaVByb3ZpZGVyRmFjdG9yeSB9IGZyb20gJy4vYWktcHJvdmlkZXIuZmFjdG9yeSdcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoRHluYW1pY0FpU2NoZWR1bGVyU2VydmljZS5uYW1lKVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWlQcm92aWRlckZhY3Rvcnk6IEFpUHJvdmlkZXJGYWN0b3J5LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZVxuICApIHt9XG5cbiAgcHVibGljIGFzeW5jIGdldFByb3ZpZGVyRm9yUm9sZSh1c2VyOiBVc2VyLCByb2xlOiBBaVJvbGUpOiBQcm9taXNlPEFpUHJvdmlkZXI+IHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgW1NjaGVkdWxlcl0gTmV3IHJlcXVlc3QgZm9yIHJvbGU6IFwiJHtyb2xlfVwiIGZyb20gdXNlciAke3VzZXIuaWR9YClcblxuICAgIC8vIFshXSDmoLjlv4PmlLnpgKAgMTog5p+l6K+i6YC76L6R57+76K+RXG4gICAgLy8g5oiR5Lus5LiN5YaN5p+l6K+i5LiA5Liq5a2X56ym5Liy5pWw57uE77yM6ICM5piv5p+l6K+i5LiA5Liq5YWz57O744CCXG4gICAgLy8g5oiR5Lus6KaB5om+55qE5piv77ya5LiA5LiqIEFpQ29uZmlndXJhdGlvbu+8jOWug+eahCAncm9sZXMnIOWFs+ezu+S4re+8jFxuICAgIC8vICdzb21lJyAo6Iez5bCR5pyJ5LiA5LiqKSBSb2xlIOeahCAnbmFtZScg5a2X5q61562J5LqO5oiR5Lus5oOz6KaB55qEICdyb2xlJ+OAglxuICAgIGNvbnN0IGRlZGljYXRlZENvbmZpZyA9IGF3YWl0IHRoaXMucHJpc21hLmFpQ29uZmlndXJhdGlvbi5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgb3duZXJJZDogdXNlci5pZCxcbiAgICAgICAgcm9sZXM6IHtcbiAgICAgICAgICBzb21lOiB7XG4gICAgICAgICAgICBuYW1lOiByb2xlLCAvLyDov5nlsLHmmK/mlrDnmoTjgIHmraPnoa7nmoQgUHJpc21hIOWFs+ezu+afpeivouivreazlVxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pXG5cbiAgICBpZiAoZGVkaWNhdGVkQ29uZmlnKSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBbU2NoZWR1bGVyXSBQcmlvcml0eSAxIChEZWRpY2F0ZWQpOiBGb3VuZCBkZWRpY2F0ZWQgY29uZmlnIFwiJHtkZWRpY2F0ZWRDb25maWcucHJvdmlkZXJ9LyR7ZGVkaWNhdGVkQ29uZmlnLm1vZGVsSWR9XCIgZm9yIHJvbGUgXCIke3JvbGV9XCIuYFxuICAgICAgKVxuICAgICAgcmV0dXJuIHRoaXMuYWlQcm92aWRlckZhY3RvcnkuY3JlYXRlUHJvdmlkZXIoZGVkaWNhdGVkQ29uZmlnKVxuICAgIH1cbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBbU2NoZWR1bGVyXSBQcmlvcml0eSAxIChEZWRpY2F0ZWQpOiBObyBkZWRpY2F0ZWQgQUkgZm91bmQgZm9yIHJvbGUgXCIke3JvbGV9XCIuYFxuICAgIClcblxuICAgIC8vIOS8mOWFiOe6pyAyOiDlvoHnlKjpgLvovpHkv53mjIHkuI3lj5hcbiAgICBjb25zdCBhbnlVc2VyQ29uZmlnID0gYXdhaXQgdGhpcy5wcmlzbWEuYWlDb25maWd1cmF0aW9uLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZTogeyBvd25lcklkOiB1c2VyLmlkIH0sXG4gICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2FzYycgfSxcbiAgICB9KVxuXG4gICAgaWYgKGFueVVzZXJDb25maWcpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYFtTY2hlZHVsZXJdIFByaW9yaXR5IDIgKFJlcXVpc2l0aW9uKTogUmVxdWlzaXRpb25pbmcgZ2VuZXJhbC1wdXJwb3NlIEFJIFwiJHthbnlVc2VyQ29uZmlnLnByb3ZpZGVyfS8ke2FueVVzZXJDb25maWcubW9kZWxJZH1cIiBmb3Igcm9sZSBcIiR7cm9sZX1cIi5gXG4gICAgICApXG4gICAgICByZXR1cm4gdGhpcy5haVByb3ZpZGVyRmFjdG9yeS5jcmVhdGVQcm92aWRlcihhbnlVc2VyQ29uZmlnKVxuICAgIH1cbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgW1NjaGVkdWxlcl0gUHJpb3JpdHkgMiAoUmVxdWlzaXRpb24pOiBVc2VyIGhhcyBubyBBSSBjb25maWd1cmF0aW9ucyBhdCBhbGwuYClcblxuICAgIC8vIOS8mOWFiOe6pyAzOiDlkI7lpIfpgLvovpHkv53mjIHkuI3lj5jvvIzkvYbmqKHmi5/lr7nosaHnu5PmnoTpnIDopoHmlLnlj5hcbiAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgYFtTY2hlZHVsZXJdIFByaW9yaXR5IDMgKFN5c3RlbSBGYWxsYmFjayk6IEZhbGxpbmcgYmFjayB0byBzeXN0ZW0gZGVmYXVsdCBBSSBmb3Igcm9sZSBcIiR7cm9sZX1cIi5gXG4gICAgKVxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gdGhpcy5jcmVhdGVGYWxsYmFja1Byb3ZpZGVyKClcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBbU2NoZWR1bGVyXSBDUklUSUNBTCBGQUlMVVJFOiBTeXN0ZW0gZmFsbGJhY2sgQUkgZmFpbGVkIHRvIGluaXRpYWxpemUuYCxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogdW5kZWZpbmVkXG4gICAgICApXG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0FJIHByb2Nlc3NpbmcgZmFpbGVkOiBObyBBSSBpcyBhdmFpbGFibGUgb3IgY29uZmlndXJlZCBjb3JyZWN0bHkuJ1xuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRmFsbGJhY2tQcm92aWRlcigpOiBBaVByb3ZpZGVyIHtcbiAgICB0cnkge1xuICAgICAgLy8g5LyY5YWI5L2/55So5LiT6Zeo55qERGVlcFNlZWvphY3nva7vvIzlpoLmnpzmsqHmnInliJnkvb/nlKjlkI7lpIfphY3nva5cbiAgICAgIGNvbnN0IGFwaUtleSA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignREVFUFNFRUtfQVBJX0tFWScpIHx8XG4gICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0T3JUaHJvdzxzdHJpbmc+KCdGQUxMQkFDS19BUElfS0VZJylcbiAgICAgIGNvbnN0IG1vZGVsSWQgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0ZBTExCQUNLX01PREVMX0lEJywgJ2RlZXBzZWVrLWNoYXQnKVxuICAgICAgY29uc3QgYmFzZVVybEZyb21FbnYgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0RFRVBTRUVLX0JBU0VfVVJMJykgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdGQUxMQkFDS19CQVNFX1VSTCcpXG5cbiAgICAgIC8vIFshXSDmoLjlv4PmlLnpgKAgMjog5qih5ouf5a+56LGh57uT5p6E57+76K+RXG4gICAgICAvLyDmlrDnmoQgQWlDb25maWd1cmF0aW9uIOexu+Wei+ayoeaciSBgYXNzaWduZWRSb2xlc2Ag5a2X5q6144CCXG4gICAgICAvLyDmiJHku6zliJvlu7rkuIDkuKrkuI3ljIXlkKvku7vkvZXop5LoibLkv6Hmga/nmoTjgIHnuq/nsrnnmoTphY3nva7lr7nosaHjgIJcbiAgICAgIC8vIOazqOaEj++8mui/meS4quaooeaLn+Wvueixoee8uuWwkSAncm9sZXMnIOWxnuaAp++8jOaJgOS7peaIkeS7rOmcgOimgeWRiuiviSBUeXBlU2NyaXB0XG4gICAgICAvLyDlroPnrKblkIggQWlDb25maWd1cmF0aW9uIOeahOW9oueKtu+8iOmAmui/h+exu+Wei+aWreiogCBhcyBBaUNvbmZpZ3VyYXRpb27vvInjgIJcbiAgICAgIGNvbnN0IGZhbGxiYWNrQ29uZmlnID0ge1xuICAgICAgICBpZDogJ3N5c3RlbS1mYWxsYmFjaycsXG4gICAgICAgIHByb3ZpZGVyOiAnRGVlcFNlZWsnLFxuICAgICAgICBhcGlLZXksXG4gICAgICAgIGJhc2VVcmw6IGJhc2VVcmxGcm9tRW52ID8/IG51bGwsXG4gICAgICAgIG1vZGVsSWQsXG4gICAgICAgIG93bmVySWQ6ICdzeXN0ZW0nLFxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH0gYXMgQWlDb25maWd1cmF0aW9uIC8vIOexu+Wei+aWreiogO+8jOihqOekuuaIkeS7rOehruS/oei/meS4quWvueixoeeahOe7k+aehOaYr+WFvOWuueeahFxuXG4gICAgICByZXR1cm4gdGhpcy5haVByb3ZpZGVyRmFjdG9yeS5jcmVhdGVQcm92aWRlcihmYWxsYmFja0NvbmZpZylcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICdTeXN0ZW0gZmFsbGJhY2sgQUkgY29uZmlndXJhdGlvbiBpcyBtaXNzaW5nIG9yIGludmFsaWQuIENoZWNrIHlvdXIgLmVudiBmaWxlIGZvciBGQUxMQkFDS18uLi4gdmFyaWFibGVzLicsXG4gICAgICAgIGVycm9yXG4gICAgICApXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N5c3RlbSBkZWZhdWx0IEFJIGlzIG5vdCBjb25maWd1cmVkLicpXG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=