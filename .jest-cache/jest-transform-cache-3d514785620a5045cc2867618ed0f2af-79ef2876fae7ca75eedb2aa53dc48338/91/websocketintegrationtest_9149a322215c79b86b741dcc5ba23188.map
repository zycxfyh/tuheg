{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\vcptoolbox\\src\\integration-tests\\websocket-integration.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\vcptoolbox\\src\\integration-tests\\websocket-integration.test.ts"],"sourcesContent":["// ============================================================================\r\n// WebSocket通信集成测试\r\n// 验证 VCPToolBox WebSocket通信的正确集成\r\n// ============================================================================\r\n\r\nimport { Test, TestingModule } from '@nestjs/testing'\r\nimport { ConfigService } from '@nestjs/config'\r\nimport { WebSocketService } from '../../../../packages/common-backend/src/vcp/websocket.service'\r\n\r\ndescribe('WebSocketService Integration', () => {\r\n  let service: WebSocketService\r\n  let configService: ConfigService\r\n\r\n  beforeEach(async () => {\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        WebSocketService,\r\n        {\r\n          provide: ConfigService,\r\n          useValue: {\r\n            get: jest.fn((key: string, defaultValue?: any) => {\r\n              const config = {\r\n                WEBSOCKET_PORT: 8081, // 使用不同端口避免冲突\r\n                WEBSOCKET_HOST: 'localhost',\r\n                WEBSOCKET_HEARTBEAT_INTERVAL: 30000,\r\n                WEBSOCKET_CONNECTION_TIMEOUT: 300000\r\n              }\r\n              return config[key] || defaultValue\r\n            })\r\n          }\r\n        }\r\n      ]\r\n    }).compile()\r\n\r\n    service = module.get<WebSocketService>(WebSocketService)\r\n    configService = module.get<ConfigService>(ConfigService)\r\n  })\r\n\r\n  afterEach(async () => {\r\n    // 清理资源\r\n    try {\r\n      await (service as any).onModuleDestroy()\r\n    } catch (error) {\r\n      // 忽略清理错误\r\n    }\r\n  })\r\n\r\n  it('应该能获取WebSocket统计信息', () => {\r\n    const stats = service.getWebSocketStats()\r\n\r\n    expect(stats).toHaveProperty('status')\r\n    // 在测试环境中服务器可能没有启动，所以状态可能是'stopped'\r\n    expect(['running', 'stopped']).toContain(stats.status)\r\n  })\r\n\r\n  it('应该能执行健康检查', async () => {\r\n    const health = await service.healthCheck()\r\n\r\n    expect(health).toHaveProperty('status')\r\n    expect(['healthy', 'error']).toContain(health.status)\r\n\r\n    if (health.status === 'error') {\r\n      expect(health).toHaveProperty('details')\r\n    }\r\n  })\r\n\r\n  it('应该能处理Agent消息发送（模拟）', async () => {\r\n    // 测试发送到不存在的Agent，应该返回false\r\n    const result = await service.sendToAgent('non-existent-agent', {\r\n      action: 'test',\r\n      payload: { message: 'test' }\r\n    })\r\n\r\n    // 在没有实际WebSocket连接的情况下，应该返回false\r\n    expect(result).toBe(false)\r\n  })\r\n\r\n  it('应该能处理广播消息（模拟）', async () => {\r\n    const result = await service.broadcastToAgents({\r\n      action: 'test-broadcast',\r\n      payload: { message: 'broadcast test' }\r\n    })\r\n\r\n    // 在没有连接的情况下，广播应该影响0个客户端\r\n    expect(result).toBe(0)\r\n  })\r\n\r\n  it('应该能处理协作房间操作（模拟）', async () => {\r\n    const roomId = await service.createCollaborationRoom('test-story-123', ['agent1', 'agent2'])\r\n    // 当前实现返回null\r\n    expect(roomId).toBeNull()\r\n\r\n    const joinResult = await service.joinCollaborationRoom('test-room', 'test-agent')\r\n    expect(joinResult).toBe(true)\r\n  })\r\n\r\n  it('应该能处理实时编辑更新（模拟）', async () => {\r\n    // 这应该不会抛出错误，即使没有实际的WebSocket连接\r\n    await expect(service.sendRealtimeEdit('story-123', 'agent-456', {\r\n      type: 'text',\r\n      content: '新的内容',\r\n      position: { line: 1, column: 10 }\r\n    })).resolves.not.toThrow()\r\n  })\r\n\r\n  it('应该能处理AI生成进度（模拟）', async () => {\r\n    await expect(service.sendGenerationProgress('story-123', 'agent-456', 75, 'generating')).resolves.not.toThrow()\r\n  })\r\n\r\n  it('应该能处理Agent协作状态（模拟）', async () => {\r\n    await expect(service.sendAgentCollaborationStatus('story-123', {\r\n      agents: ['agent1', 'agent2'],\r\n      status: 'active',\r\n      progress: 60\r\n    })).resolves.not.toThrow()\r\n  })\r\n\r\n  it('应该能获取活跃协作会话（模拟）', () => {\r\n    const sessions = service.getActiveCollaborationSessions()\r\n    expect(Array.isArray(sessions)).toBe(true)\r\n    // 当前实现返回空数组\r\n    expect(sessions).toHaveLength(0)\r\n  })\r\n\r\n  it('应该正确配置WebSocket参数', () => {\r\n    expect(configService.get).toHaveBeenCalledWith('WEBSOCKET_PORT', 8080)\r\n    expect(configService.get).toHaveBeenCalledWith('WEBSOCKET_HOST', 'localhost')\r\n  })\r\n})\r\n"],"version":3}