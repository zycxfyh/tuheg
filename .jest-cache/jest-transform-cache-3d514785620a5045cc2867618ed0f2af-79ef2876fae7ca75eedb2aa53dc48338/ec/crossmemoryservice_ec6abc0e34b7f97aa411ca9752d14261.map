{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\cross-memory.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\cross-memory.service.ts"],"sourcesContent":["// ============================================================================\r\n// 跨记忆网络服务集成\r\n// 集成 VCPToolBox 的智能记忆共享和联想能力\r\n// ============================================================================\r\n\r\nimport { Injectable, Logger, OnModuleInit } from '@nestjs/common'\r\nimport { ConfigService } from '@nestjs/config'\r\nimport {\r\n  crossMemoryNetwork,\r\n  MemoryEntry,\r\n  MemoryQuery,\r\n  MemorySearchResult\r\n} from '../../../apps/vcptoolbox/src/modules/storage/CrossMemoryNetwork'\r\n\r\n@Injectable()\r\nexport class CrossMemoryService implements OnModuleInit {\r\n  private readonly logger = new Logger(CrossMemoryService.name)\r\n\r\n  constructor(private configService: ConfigService) {}\r\n\r\n  async onModuleInit() {\r\n    await this.initializeMemorySystem()\r\n    this.setupMemoryMaintenance()\r\n    this.logger.log('跨记忆网络服务已初始化')\r\n  }\r\n\r\n  // ==================== 记忆系统初始化 ====================\r\n\r\n  /**\r\n   * 初始化记忆系统\r\n   */\r\n  private async initializeMemorySystem(): Promise<void> {\r\n    // 设置记忆网络参数\r\n    const similarityThreshold = this.configService.get('MEMORY_SIMILARITY_THRESHOLD', 0.7)\r\n    const maxConnections = this.configService.get('MEMORY_MAX_CONNECTIONS', 10)\r\n    const decayRate = this.configService.get('MEMORY_DECAY_RATE', 0.95)\r\n\r\n    // 重新配置记忆网络（如果需要）\r\n    // 注意：crossMemoryNetwork 已经在模块中初始化，这里可以设置参数\r\n\r\n    // 创建系统初始记忆\r\n    await this.createSystemMemories()\r\n\r\n    this.logger.log('记忆系统参数已配置')\r\n  }\r\n\r\n  /**\r\n   * 创建系统初始记忆\r\n   */\r\n  private async createSystemMemories(): Promise<void> {\r\n    const systemMemories: Omit<MemoryEntry, 'id' | 'fingerprint' | 'metadata'>[] = [\r\n      {\r\n        agentId: 'system',\r\n        type: 'knowledge',\r\n        content: {\r\n          topic: 'narrative_basics',\r\n          information: '叙事创作的基本要素包括人物、情节、设定和主题'\r\n        },\r\n        tags: ['narrative', 'basics', 'knowledge', 'system'],\r\n        importance: 0.9,\r\n        connections: []\r\n      },\r\n      {\r\n        agentId: 'system',\r\n        type: 'experience',\r\n        content: {\r\n          event: 'system_initialization',\r\n          outcome: '记忆系统成功初始化',\r\n          lessons: '记忆系统对于AI创作至关重要'\r\n        },\r\n        tags: ['system', 'initialization', 'experience'],\r\n        importance: 0.8,\r\n        connections: []\r\n      },\r\n      {\r\n        agentId: 'system',\r\n        type: 'knowledge',\r\n        content: {\r\n          topic: 'collaboration_patterns',\r\n          information: '有效的Agent协作需要明确的角色分工和通信协议'\r\n        },\r\n        tags: ['collaboration', 'patterns', 'knowledge', 'system'],\r\n        importance: 0.85,\r\n        connections: []\r\n      }\r\n    ]\r\n\r\n    for (const memory of systemMemories) {\r\n      try {\r\n        await crossMemoryNetwork.addMemory(memory)\r\n      } catch (error) {\r\n        this.logger.warn(`创建系统记忆失败: ${memory.content}`, error)\r\n      }\r\n    }\r\n\r\n    this.logger.log('系统初始记忆已创建')\r\n  }\r\n\r\n  /**\r\n   * 设置记忆维护任务\r\n   */\r\n  private setupMemoryMaintenance(): void {\r\n    // 定期应用记忆衰减\r\n    setInterval(() => {\r\n      try {\r\n        crossMemoryNetwork.applyMemoryDecay()\r\n      } catch (error) {\r\n        this.logger.error('记忆衰减应用失败:', error)\r\n      }\r\n    }, 60 * 60 * 1000) // 每小时执行一次\r\n\r\n    // 定期清理和优化记忆网络\r\n    setInterval(() => {\r\n      this.optimizeMemoryNetwork()\r\n    }, 24 * 60 * 60 * 1000) // 每天执行一次\r\n  }\r\n\r\n  // ==================== 记忆管理接口 ====================\r\n\r\n  /**\r\n   * 添加记忆\r\n   */\r\n  async addMemory(memoryData: Omit<MemoryEntry, 'id' | 'fingerprint' | 'metadata'>): Promise<string> {\r\n    try {\r\n      const memoryId = await crossMemoryNetwork.addMemory(memoryData)\r\n      this.logger.debug(`记忆已添加: ${memoryId}`)\r\n      return memoryId\r\n    } catch (error: any) {\r\n      this.logger.error('添加记忆失败:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取记忆\r\n   */\r\n  async getMemory(memoryId: string): Promise<MemoryEntry | null> {\r\n    try {\r\n      return crossMemoryNetwork.getMemory(memoryId)\r\n    } catch (error: any) {\r\n      this.logger.warn(`获取记忆失败 ${memoryId}:`, error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 更新记忆\r\n   */\r\n  async updateMemory(memoryId: string, updates: Partial<Omit<MemoryEntry, 'id' | 'fingerprint' | 'metadata'>>): Promise<boolean> {\r\n    try {\r\n      const success = crossMemoryNetwork.updateMemory(memoryId, updates)\r\n      if (success) {\r\n        this.logger.debug(`记忆已更新: ${memoryId}`)\r\n      }\r\n      return success\r\n    } catch (error: any) {\r\n      this.logger.error(`更新记忆失败 ${memoryId}:`, error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 删除记忆\r\n   */\r\n  async deleteMemory(memoryId: string): Promise<boolean> {\r\n    try {\r\n      const success = crossMemoryNetwork.deleteMemory(memoryId)\r\n      if (success) {\r\n        this.logger.debug(`记忆已删除: ${memoryId}`)\r\n      }\r\n      return success\r\n    } catch (error: any) {\r\n      this.logger.error(`删除记忆失败 ${memoryId}:`, error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 查询记忆\r\n   */\r\n  async queryMemories(query: MemoryQuery): Promise<MemorySearchResult[]> {\r\n    try {\r\n      return await crossMemoryNetwork.queryMemories(query)\r\n    } catch (error: any) {\r\n      this.logger.error('查询记忆失败:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 更新记忆重要性\r\n   */\r\n  async updateMemoryImportance(memoryId: string, importance: number): Promise<boolean> {\r\n    try {\r\n      const success = crossMemoryNetwork.updateMemoryImportance(memoryId, importance)\r\n      if (success) {\r\n        this.logger.debug(`记忆重要性已更新: ${memoryId} = ${importance}`)\r\n      }\r\n      return success\r\n    } catch (error: any) {\r\n      this.logger.error(`更新记忆重要性失败 ${memoryId}:`, error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  // ==================== 叙事专用记忆接口 ====================\r\n\r\n  /**\r\n   * 添加故事记忆\r\n   */\r\n  async addStoryMemory(storyId: string, agentId: string, content: any, type: MemoryEntry['type'] = 'experience'): Promise<string> {\r\n    const memoryData = {\r\n      agentId,\r\n      type,\r\n      content: {\r\n        storyId,\r\n        ...content\r\n      },\r\n      tags: ['story', storyId, type, agentId],\r\n      importance: this.calculateStoryMemoryImportance(content, type),\r\n      connections: []\r\n    }\r\n\r\n    return await this.addMemory(memoryData)\r\n  }\r\n\r\n  /**\r\n   * 查询故事相关记忆\r\n   */\r\n  async queryStoryMemories(storyId: string, agentId?: string, limit: number = 20): Promise<MemorySearchResult[]> {\r\n    const query: MemoryQuery = {\r\n      tags: ['story', storyId],\r\n      limit,\r\n      sortBy: 'recency'\r\n    }\r\n\r\n    if (agentId) {\r\n      query.agentId = agentId\r\n    }\r\n\r\n    return await this.queryMemories(query)\r\n  }\r\n\r\n  /**\r\n   * 添加角色记忆\r\n   */\r\n  async addCharacterMemory(characterId: string, agentId: string, content: any): Promise<string> {\r\n    const memoryData = {\r\n      agentId,\r\n      type: 'experience',\r\n      content: {\r\n        characterId,\r\n        ...content\r\n      },\r\n      tags: ['character', characterId, 'development', agentId],\r\n      importance: this.calculateCharacterMemoryImportance(content),\r\n      connections: []\r\n    }\r\n\r\n    return await this.addMemory(memoryData)\r\n  }\r\n\r\n  /**\r\n   * 查询角色相关记忆\r\n   */\r\n  async queryCharacterMemories(characterId: string, limit: number = 15): Promise<MemorySearchResult[]> {\r\n    return await this.queryMemories({\r\n      tags: ['character', characterId],\r\n      limit,\r\n      sortBy: 'importance'\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 添加创作模式记忆\r\n   */\r\n  async addCreativePattern(patternType: string, agentId: string, pattern: any, success: boolean): Promise<string> {\r\n    const memoryData = {\r\n      agentId,\r\n      type: success ? 'experience' : 'knowledge',\r\n      content: {\r\n        patternType,\r\n        pattern,\r\n        success,\r\n        lessons: success ? '有效的创作模式' : '需要改进的创作模式'\r\n      },\r\n      tags: ['creative-pattern', patternType, success ? 'success' : 'failure', agentId],\r\n      importance: success ? 0.8 : 0.6,\r\n      connections: []\r\n    }\r\n\r\n    return await this.addMemory(memoryData)\r\n  }\r\n\r\n  /**\r\n   * 查找相似创作模式\r\n   */\r\n  async findSimilarCreativePatterns(patternType: string, currentPattern: any, limit: number = 5): Promise<MemorySearchResult[]> {\r\n    // 简化的模式匹配，实际应该使用更复杂的相似度算法\r\n    const query: MemoryQuery = {\r\n      tags: ['creative-pattern', patternType, 'success'],\r\n      limit,\r\n      sortBy: 'importance'\r\n    }\r\n\r\n    const results = await this.queryMemories(query)\r\n\r\n    // 进一步过滤相似模式\r\n    return results.filter(result => {\r\n      const pattern = result.memory.content.pattern\r\n      return this.calculatePatternSimilarity(currentPattern, pattern) > 0.7\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 添加用户偏好记忆\r\n   */\r\n  async addUserPreference(userId: string, preferenceType: string, preference: any): Promise<string> {\r\n    const memoryData = {\r\n      agentId: 'user-preference-agent',\r\n      type: 'knowledge',\r\n      content: {\r\n        userId,\r\n        preferenceType,\r\n        preference,\r\n        context: 'user_preference'\r\n      },\r\n      tags: ['user-preference', userId, preferenceType],\r\n      importance: 0.9, // 用户偏好很重要\r\n      connections: []\r\n    }\r\n\r\n    return await this.addMemory(memoryData)\r\n  }\r\n\r\n  /**\r\n   * 获取用户偏好\r\n   */\r\n  async getUserPreferences(userId: string, preferenceType?: string): Promise<any[]> {\r\n    const query: MemoryQuery = {\r\n      tags: ['user-preference', userId],\r\n      sortBy: 'recency',\r\n      limit: 50\r\n    }\r\n\r\n    if (preferenceType) {\r\n      query.tags!.push(preferenceType)\r\n    }\r\n\r\n    const results = await this.queryMemories(query)\r\n    return results.map(result => ({\r\n      type: result.memory.content.preferenceType,\r\n      preference: result.memory.content.preference,\r\n      timestamp: result.memory.metadata.createdAt,\r\n      confidence: result.memory.metadata.confidence\r\n    }))\r\n  }\r\n\r\n  // ==================== 智能联想接口 ====================\r\n\r\n  /**\r\n   * 查找相关记忆\r\n   */\r\n  async findRelatedMemories(memoryId: string, limit: number = 10): Promise<MemoryEntry[]> {\r\n    try {\r\n      return await crossMemoryNetwork.findRelatedMemories(memoryId, limit)\r\n    } catch (error: any) {\r\n      this.logger.warn(`查找相关记忆失败 ${memoryId}:`, error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 基于内容的智能搜索\r\n   */\r\n  async intelligentSearch(query: string, context: {\r\n    userId?: string\r\n    storyId?: string\r\n    agentId?: string\r\n    tags?: string[]\r\n  } = {}, limit: number = 20): Promise<MemorySearchResult[]> {\r\n    const searchQuery: MemoryQuery = {\r\n      content: query,\r\n      fuzzy: true,\r\n      limit,\r\n      sortBy: 'relevance'\r\n    }\r\n\r\n    // 添加上下文过滤\r\n    if (context.userId) {\r\n      searchQuery.tags = (searchQuery.tags || []).concat(['user', context.userId])\r\n    }\r\n    if (context.storyId) {\r\n      searchQuery.tags = (searchQuery.tags || []).concat(['story', context.storyId])\r\n    }\r\n    if (context.agentId) {\r\n      searchQuery.agentId = context.agentId\r\n    }\r\n    if (context.tags) {\r\n      searchQuery.tags = (searchQuery.tags || []).concat(context.tags)\r\n    }\r\n\r\n    return await this.queryMemories(searchQuery)\r\n  }\r\n\r\n  /**\r\n   * 获取创作灵感\r\n   */\r\n  async getCreativeInspiration(storyId: string, theme: string, limit: number = 10): Promise<MemorySearchResult[]> {\r\n    // 查找与主题相关的成功创作经验\r\n    const inspirationQuery: MemoryQuery = {\r\n      tags: ['creative-pattern', 'success'],\r\n      content: theme,\r\n      fuzzy: true,\r\n      limit,\r\n      sortBy: 'importance'\r\n    }\r\n\r\n    const results = await this.queryMemories(inspirationQuery)\r\n\r\n    // 补充一些通用的创作知识\r\n    const generalKnowledge = await this.queryMemories({\r\n      tags: ['narrative', 'knowledge'],\r\n      limit: 5\r\n    })\r\n\r\n    return [...results, ...generalKnowledge].slice(0, limit)\r\n  }\r\n\r\n  // ==================== Agent协作记忆 ====================\r\n\r\n  /**\r\n   * 记录Agent协作经验\r\n   */\r\n  async recordCollaborationExperience(collaborationId: string, agents: string[], outcome: any): Promise<string> {\r\n    const memoryData = {\r\n      agentId: 'collaboration-agent',\r\n      type: 'experience',\r\n      content: {\r\n        collaborationId,\r\n        agents,\r\n        outcome,\r\n        effectiveness: this.evaluateCollaborationEffectiveness(outcome),\r\n        lessons: this.extractCollaborationLessons(outcome)\r\n      },\r\n      tags: ['collaboration', 'experience', collaborationId, ...agents],\r\n      importance: 0.7,\r\n      connections: []\r\n    }\r\n\r\n    return await this.addMemory(memoryData)\r\n  }\r\n\r\n  /**\r\n   * 获取Agent协作历史\r\n   */\r\n  async getCollaborationHistory(agentId: string, limit: number = 10): Promise<MemorySearchResult[]> {\r\n    return await this.queryMemories({\r\n      tags: ['collaboration', agentId],\r\n      limit,\r\n      sortBy: 'recency'\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 学习最优协作模式\r\n   */\r\n  async learnOptimalCollaborationPatterns(): Promise<any[]> {\r\n    const successfulCollaborations = await this.queryMemories({\r\n      tags: ['collaboration', 'experience'],\r\n      content: 'success',\r\n      fuzzy: true,\r\n      limit: 50\r\n    })\r\n\r\n    // 分析协作模式\r\n    const patterns = this.analyzeCollaborationPatterns(successfulCollaborations)\r\n    return patterns\r\n  }\r\n\r\n  // ==================== 辅助方法 ====================\r\n\r\n  /**\r\n   * 计算故事记忆重要性\r\n   */\r\n  private calculateStoryMemoryImportance(content: any, type: MemoryEntry['type']): number {\r\n    let importance = 0.5\r\n\r\n    switch (type) {\r\n      case 'experience':\r\n        importance = 0.7\r\n        break\r\n      case 'knowledge':\r\n        importance = 0.8\r\n        break\r\n      case 'event':\r\n        importance = 0.6\r\n        break\r\n    }\r\n\r\n    // 根据内容调整重要性\r\n    if (content.keyMoment) importance += 0.2\r\n    if (content.conflict) importance += 0.1\r\n    if (content.resolution) importance += 0.1\r\n\r\n    return Math.min(1, importance)\r\n  }\r\n\r\n  /**\r\n   * 计算角色记忆重要性\r\n   */\r\n  private calculateCharacterMemoryImportance(content: any): number {\r\n    let importance = 0.6\r\n\r\n    if (content.personalityChange) importance += 0.2\r\n    if (content.relationshipChange) importance += 0.15\r\n    if (content.keyDecision) importance += 0.1\r\n\r\n    return Math.min(1, importance)\r\n  }\r\n\r\n  /**\r\n   * 计算模式相似度\r\n   */\r\n  private calculatePatternSimilarity(pattern1: any, pattern2: any): number {\r\n    // 简化的相似度计算\r\n    if (JSON.stringify(pattern1) === JSON.stringify(pattern2)) return 1.0\r\n\r\n    // 检查共同属性\r\n    const keys1 = Object.keys(pattern1)\r\n    const keys2 = Object.keys(pattern2)\r\n    const commonKeys = keys1.filter(key => keys2.includes(key))\r\n\r\n    if (commonKeys.length === 0) return 0\r\n\r\n    let similarity = commonKeys.length / Math.max(keys1.length, keys2.length)\r\n\r\n    // 检查共同值\r\n    for (const key of commonKeys) {\r\n      if (pattern1[key] === pattern2[key]) {\r\n        similarity += 0.1\r\n      }\r\n    }\r\n\r\n    return Math.min(1, similarity)\r\n  }\r\n\r\n  /**\r\n   * 评估协作有效性\r\n   */\r\n  private evaluateCollaborationEffectiveness(outcome: any): number {\r\n    // 简化的有效性评估\r\n    let effectiveness = 0.5\r\n\r\n    if (outcome.success) effectiveness += 0.3\r\n    if (outcome.quality > 0.8) effectiveness += 0.2\r\n    if (outcome.timeEfficiency > 0.7) effectiveness += 0.1\r\n\r\n    return Math.min(1, effectiveness)\r\n  }\r\n\r\n  /**\r\n   * 提取协作经验教训\r\n   */\r\n  private extractCollaborationLessons(outcome: any): string[] {\r\n    const lessons: string[] = []\r\n\r\n    if (outcome.communicationIssues) {\r\n      lessons.push('改善沟通机制')\r\n    }\r\n    if (outcome.roleConflicts) {\r\n      lessons.push('明确角色分工')\r\n    }\r\n    if (outcome.timeDelays) {\r\n      lessons.push('优化时间管理')\r\n    }\r\n\r\n    return lessons\r\n  }\r\n\r\n  /**\r\n   * 分析协作模式\r\n   */\r\n  private analyzeCollaborationPatterns(collaborations: MemorySearchResult[]): any[] {\r\n    // 简化的模式分析\r\n    const patterns: any[] = []\r\n\r\n    for (const collab of collaborations) {\r\n      const pattern = {\r\n        agentCount: collab.memory.content.agents?.length || 0,\r\n        effectiveness: collab.memory.content.effectiveness || 0.5,\r\n        keyFactors: collab.memory.content.lessons || []\r\n      }\r\n      patterns.push(pattern)\r\n    }\r\n\r\n    return patterns.sort((a, b) => b.effectiveness - a.effectiveness)\r\n  }\r\n\r\n  /**\r\n   * 优化记忆网络\r\n   */\r\n  private async optimizeMemoryNetwork(): Promise<void> {\r\n    try {\r\n      // 清理低重要性记忆\r\n      const stats = crossMemoryNetwork.getStats()\r\n      this.logger.debug(`记忆网络状态: ${stats.totalMemories} 记忆, ${stats.totalConnections} 连接`)\r\n\r\n      // 这里可以添加更复杂的优化逻辑\r\n      // 比如合并相似记忆、重建连接等\r\n\r\n    } catch (error) {\r\n      this.logger.error('记忆网络优化失败:', error)\r\n    }\r\n  }\r\n\r\n  // ==================== 统计和监控 ====================\r\n\r\n  /**\r\n   * 获取记忆统计信息\r\n   */\r\n  getMemoryStats(): any {\r\n    try {\r\n      return crossMemoryNetwork.getStats()\r\n    } catch (error) {\r\n      this.logger.error('获取记忆统计失败:', error)\r\n      return {\r\n        totalMemories: 0,\r\n        totalConnections: 0,\r\n        agentCount: 0,\r\n        memoryTypes: {},\r\n        averageImportance: 0\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 健康检查\r\n   */\r\n  async healthCheck(): Promise<{ status: string, details?: any }> {\r\n    try {\r\n      const stats = this.getMemoryStats()\r\n      return {\r\n        status: 'healthy',\r\n        details: stats\r\n      }\r\n    } catch (error: any) {\r\n      return {\r\n        status: 'error',\r\n        details: error.message\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 导出记忆数据\r\n   */\r\n  async exportMemoryData(): Promise<any> {\r\n    try {\r\n      return crossMemoryNetwork.exportMemoryNetwork()\r\n    } catch (error) {\r\n      this.logger.error('导出记忆数据失败:', error)\r\n      return { memories: [], connections: {} }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 导入记忆数据\r\n   */\r\n  async importMemoryData(data: any): Promise<void> {\r\n    try {\r\n      crossMemoryNetwork.importMemoryNetwork(data)\r\n      this.logger.log('记忆数据导入成功')\r\n    } catch (error) {\r\n      this.logger.error('导入记忆数据失败:', error)\r\n      throw error\r\n    }\r\n  }\r\n}\r\n"],"version":3}