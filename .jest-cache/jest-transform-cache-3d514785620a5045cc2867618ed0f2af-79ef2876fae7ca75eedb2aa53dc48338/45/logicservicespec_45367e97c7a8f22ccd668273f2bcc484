5888bd8d1fde92139fa9b97c45c8e794
"use strict";
// 文件路径: apps/logic-agent/src/__tests__/logic.service.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
// [核心] 模拟 @tuheg/ai-domain 模块，特别是 callAiWithGuard 函数
jest.mock('@tuheg/ai-domain', () => ({
    ...jest.requireActual('@tuheg/ai-domain'), // 保留其他真实导出
    callAiWithGuard: jest.fn(), // 将 callAiWithGuard 替换为一个 Jest 模拟函数
}));
const testing_1 = require("@nestjs/testing");
const infrastructure_1 = require("@tuheg/infrastructure");
const jest_mock_extended_1 = require("jest-mock-extended");
const logic_service_1 = require("../logic.service");
const rule_engine_service_1 = require("../rule-engine.service");
describe('LogicService', () => {
    let logicService;
    let ruleEngineService;
    let eventBusService;
    // 将模拟函数类型化，便于在测试中进行类型提示
    const mockedCallAiWithGuard = callAiWithGuard;
    beforeEach(async () => {
        // 使用 jest-mock-extended 创建所有依赖的深度模拟对象
        const eventBusMock = (0, jest_mock_extended_1.mock)();
        const prismaMock = (0, jest_mock_extended_1.mock)();
        const schedulerMock = (0, jest_mock_extended_1.mock)();
        schedulerMock.getProviderForRole.mockResolvedValue({
            model: { invoke: jest.fn().mockResolvedValue('mock response') },
        });
        const promptManagerMock = (0, jest_mock_extended_1.mock)();
        const promptInjectionGuardMock = (0, jest_mock_extended_1.mock)();
        promptInjectionGuardMock.checkInput.mockResolvedValue({
            allowed: true,
            score: 0.1,
            threshold: 0.7,
            reason: 'passed',
        });
        const ruleEngineMock = (0, jest_mock_extended_1.mock)({
            // 模拟 execute 方法为一个空的 resolved Promise
            execute: jest.fn().mockResolvedValue(undefined),
        });
        const module = await testing_1.Test.createTestingModule({
            providers: [
                logic_service_1.LogicService,
                // 提供真实的 RuleEngineService，但其依赖 PrismaService 是模拟的
                rule_engine_service_1.RuleEngineService,
                { provide: EventBusService, useValue: eventBusMock },
                { provide: PrismaService, useValue: prismaMock },
                { provide: infrastructure_1.DynamicAiSchedulerService, useValue: schedulerMock },
                { provide: PromptManagerService, useValue: promptManagerMock },
                { provide: PromptInjectionGuard, useValue: promptInjectionGuardMock },
            ],
        })
            // 覆盖 RuleEngineService 的实例，以便我们可以监视它的方法
            .overrideProvider(rule_engine_service_1.RuleEngineService)
            .useValue(ruleEngineMock)
            .compile();
        logicService = module.get(logic_service_1.LogicService);
        ruleEngineService = module.get(rule_engine_service_1.RuleEngineService);
        eventBusService = module.get(EventBusService);
        // 在每个测试前重置模拟函数的状态
        mockedCallAiWithGuard.mockClear();
        eventBusService.publish.mockClear();
        ruleEngineService.execute.mockClear();
    });
    it('should be defined', () => {
        expect(logicService).toBeDefined();
    });
    describe('processLogic', () => {
        it('should correctly process a player action, execute directives, and publish a completion event', async () => {
            // 1. 准备 (Arrange)
            const mockJobData = {
                gameId: 'test-game-id',
                userId: 'test-user-id',
                playerAction: { type: 'command', payload: 'test command' },
                gameStateSnapshot: {}, // 在此测试中我们不关心快照的具体内容
            };
            const mockDirectives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { hp: { op: 'decrement', value: 10 } },
                },
            ];
            // 设置 callAiWithGuard 的模拟行为：当它被调用时，返回我们预设的指令集
            mockedCallAiWithGuard.mockResolvedValue(mockDirectives);
            // 2. 行动 (Act)
            await logicService.processLogic(mockJobData);
            // 3. 断言 (Assert)
            // 验证AI护栏函数是否被调用过1次
            expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1);
            // 验证 RuleEngineService 的 execute 方法是否被调用，并且传入了正确的 gameId 和 AI 生成的指令
            expect(ruleEngineService.execute).toHaveBeenCalledTimes(1);
            expect(ruleEngineService.execute).toHaveBeenCalledWith(mockJobData.gameId, mockDirectives);
            // 验证 EventBusService 的 publish 方法是否被调用，以通知下一个微服务
            expect(eventBusService.publish).toHaveBeenCalledTimes(1);
            expect(eventBusService.publish).toHaveBeenCalledWith('LOGIC_PROCESSING_COMPLETE', {
                gameId: mockJobData.gameId,
                userId: mockJobData.userId,
                playerAction: mockJobData.playerAction,
            });
        });
        it('should throw an error if AI guard fails', async () => {
            // 1. 准备 (Arrange)
            const mockJobData = {};
            const errorMessage = 'AI failed to generate valid data';
            // 设置 callAiWithGuard 的模拟行为：当它被调用时，抛出一个错误
            mockedCallAiWithGuard.mockRejectedValue(new Error(errorMessage));
            // 2. & 3. 行动与断言 (Act & Assert)
            // 验证当 generateDirectives 失败时，processLogic 会向上抛出异常
            await expect(logicService.processLogic(mockJobData)).rejects.toThrow(expect.objectContaining({
                message: expect.stringContaining(errorMessage),
            }));
            // 验证在这种失败情况下，RuleEngine 和 EventBus 都不会被调用
            expect(ruleEngineService.execute).not.toHaveBeenCalled();
            expect(eventBusService.publish).not.toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcbG9naWMuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSw2REFBNkQ7O0FBZTdELHFEQUFxRDtBQUNyRCxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDbkMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDLEVBQUUsV0FBVztJQUN0RCxlQUFlLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLG9DQUFvQztDQUNqRSxDQUFDLENBQUMsQ0FBQTtBQWpCSCw2Q0FBMEQ7QUFPMUQsMERBQTJHO0FBRTNHLDJEQUF5RDtBQUN6RCxvREFBK0M7QUFDL0MsZ0VBQTBEO0FBUTFELFFBQVEsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO0lBQzVCLElBQUksWUFBMEIsQ0FBQTtJQUM5QixJQUFJLGlCQUFvQyxDQUFBO0lBQ3hDLElBQUksZUFBMkMsQ0FBQTtJQUUvQyx3QkFBd0I7SUFDeEIsTUFBTSxxQkFBcUIsR0FBRyxlQUE0QixDQUFBO0lBRTFELFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixzQ0FBc0M7UUFDdEMsTUFBTSxZQUFZLEdBQUcsSUFBQSx5QkFBSSxHQUFtQixDQUFBO1FBQzVDLE1BQU0sVUFBVSxHQUFHLElBQUEseUJBQUksR0FBaUIsQ0FBQTtRQUN4QyxNQUFNLGFBQWEsR0FBRyxJQUFBLHlCQUFJLEdBQTZCLENBQUE7UUFDdkQsYUFBYSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDO1lBQ2pELEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsZUFBZSxDQUFDLEVBQVM7U0FDdkUsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxpQkFBaUIsR0FBRyxJQUFBLHlCQUFJLEdBQXdCLENBQUE7UUFDdEQsTUFB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QU0sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtZQUN4RCxNQUFNLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1FBQ3hELENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xcYXBwc1xcbG9naWMtYWdlbnRcXHNyY1xcX190ZXN0c19fXFxsb2dpYy5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8g5paH5Lu26Lev5b6EOiBhcHBzL2xvZ2ljLWFnZW50L3NyYy9fX3Rlc3RzX18vbG9naWMuc2VydmljZS5zcGVjLnRzXG5cbmltcG9ydCB7IFRlc3QsIHR5cGUgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZydcbmltcG9ydCB0eXBlIHtcbiAgY2FsbEFpV2l0aEd1YXJkLFxuICBEaXJlY3RpdmVTZXQsXG4gIFByb21wdEluamVjdGlvbkd1YXJkLFxuICBQcm9tcHRNYW5hZ2VyU2VydmljZSxcbn0gZnJvbSAnQHR1aGVnL2FpLWRvbWFpbidcbmltcG9ydCB7IER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2UsIHR5cGUgRXZlbnRCdXNTZXJ2aWNlLCB0eXBlIFByaXNtYVNlcnZpY2UgfSBmcm9tICdAdHVoZWcvaW5mcmFzdHJ1Y3R1cmUnXG5pbXBvcnQgdHlwZSB7IEdhbWVBY3Rpb25Kb2JEYXRhIH0gZnJvbSAnQHR1aGVnL2FpLWRvbWFpbidcbmltcG9ydCB7IHR5cGUgTW9ja1Byb3h5LCBtb2NrIH0gZnJvbSAnamVzdC1tb2NrLWV4dGVuZGVkJ1xuaW1wb3J0IHsgTG9naWNTZXJ2aWNlIH0gZnJvbSAnLi4vbG9naWMuc2VydmljZSdcbmltcG9ydCB7IFJ1bGVFbmdpbmVTZXJ2aWNlIH0gZnJvbSAnLi4vcnVsZS1lbmdpbmUuc2VydmljZSdcblxuLy8gW+aguOW/g10g5qih5oufIEB0dWhlZy9haS1kb21haW4g5qih5Z2X77yM54m55Yir5pivIGNhbGxBaVdpdGhHdWFyZCDlh73mlbBcbmplc3QubW9jaygnQHR1aGVnL2FpLWRvbWFpbicsICgpID0+ICh7XG4gIC4uLmplc3QucmVxdWlyZUFjdHVhbCgnQHR1aGVnL2FpLWRvbWFpbicpLCAvLyDkv53nlZnlhbbku5bnnJ/lrp7lr7zlh7pcbiAgY2FsbEFpV2l0aEd1YXJkOiBqZXN0LmZuKCksIC8vIOWwhiBjYWxsQWlXaXRoR3VhcmQg5pu/5o2i5Li65LiA5LiqIEplc3Qg5qih5ouf5Ye95pWwXG59KSlcblxuZGVzY3JpYmUoJ0xvZ2ljU2VydmljZScsICgpID0+IHtcbiAgbGV0IGxvZ2ljU2VydmljZTogTG9naWNTZXJ2aWNlXG4gIGxldCBydWxlRW5naW5lU2VydmljZTogUnVsZUVuZ2luZVNlcnZpY2VcbiAgbGV0IGV2ZW50QnVzU2VydmljZTogTW9ja1Byb3h5PEV2ZW50QnVzU2VydmljZT5cblxuICAvLyDlsIbmqKHmi5/lh73mlbDnsbvlnovljJbvvIzkvr/kuo7lnKjmtYvor5XkuK3ov5vooYznsbvlnovmj5DnpLpcbiAgY29uc3QgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkID0gY2FsbEFpV2l0aEd1YXJkIGFzIGplc3QuTW9ja1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIOS9v+eUqCBqZXN0LW1vY2stZXh0ZW5kZWQg5Yib5bu65omA5pyJ5L6d6LWW55qE5rex5bqm5qih5ouf5a+56LGhXG4gICAgY29uc3QgZXZlbnRCdXNNb2NrID0gbW9jazxFdmVudEJ1c1NlcnZpY2U+KClcbiAgICBjb25zdCBwcmlzbWFNb2NrID0gbW9jazxQcmlzbWFTZXJ2aWNlPigpXG4gICAgY29uc3Qgc2NoZWR1bGVyTW9jayA9IG1vY2s8RHluYW1pY0FpU2NoZWR1bGVyU2VydmljZT4oKVxuICAgIHNjaGVkdWxlck1vY2suZ2V0UHJvdmlkZXJGb3JSb2xlLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgIG1vZGVsOiB7IGludm9rZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKCdtb2NrIHJlc3BvbnNlJykgfSBhcyBhbnksXG4gICAgfSlcbiAgICBjb25zdCBwcm9tcHRNYW5hZ2VyTW9jayA9IG1vY2s8UHJvbXB0TWFuYWdlclNlcnZpY2U+KClcbiAgICBjb25zdCBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2sgPSBtb2NrPFByb21wdEluamVjdGlvbkd1YXJkPigpXG4gICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmNoZWNrSW5wdXQubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgYWxsb3dlZDogdHJ1ZSxcbiAgICAgIHNjb3JlOiAwLjEsXG4gICAgICB0aHJlc2hvbGQ6IDAuNyxcbiAgICAgIHJlYXNvbjogJ3Bhc3NlZCcsXG4gICAgfSlcbiAgICBjb25zdCBydWxlRW5naW5lTW9jayA9IG1vY2s8UnVsZUVuZ2luZVNlcnZpY2U+KHtcbiAgICAgIC8vIOaooeaLnyBleGVjdXRlIOaWueazleS4uuS4gOS4quepuueahCByZXNvbHZlZCBQcm9taXNlXG4gICAgICBleGVjdXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICB9KVxuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBMb2dpY1NlcnZpY2UsXG4gICAgICAgIC8vIOaPkOS+m+ecn+WunueahCBSdWxlRW5naW5lU2VydmljZe+8jOS9huWFtuS+nei1liBQcmlzbWFTZXJ2aWNlIOaYr+aooeaLn+eahFxuICAgICAgICBSdWxlRW5naW5lU2VydmljZSxcbiAgICAgICAgeyBwcm92aWRlOiBFdmVudEJ1c1NlcnZpY2UsIHVzZVZhbHVlOiBldmVudEJ1c01vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQcmlzbWFTZXJ2aWNlLCB1c2VWYWx1ZTogcHJpc21hTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2UsIHVzZVZhbHVlOiBzY2hlZHVsZXJNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogUHJvbXB0TWFuYWdlclNlcnZpY2UsIHVzZVZhbHVlOiBwcm9tcHRNYW5hZ2VyTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IFByb21wdEluamVjdGlvbkd1YXJkLCB1c2VWYWx1ZTogcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrIH0sXG4gICAgICBdLFxuICAgIH0pXG4gICAgICAvLyDopobnm5YgUnVsZUVuZ2luZVNlcnZpY2Ug55qE5a6e5L6L77yM5Lul5L6/5oiR5Lus5Y+v5Lul55uR6KeG5a6D55qE5pa55rOVXG4gICAgICAub3ZlcnJpZGVQcm92aWRlcihSdWxlRW5naW5lU2VydmljZSlcbiAgICAgIC51c2VWYWx1ZShydWxlRW5naW5lTW9jaylcbiAgICAgIC5jb21waWxlKClcblxuICAgIGxvZ2ljU2VydmljZSA9IG1vZHVsZS5nZXQ8TG9naWNTZXJ2aWNlPihMb2dpY1NlcnZpY2UpXG4gICAgcnVsZUVuZ2luZVNlcnZpY2UgPSBtb2R1bGUuZ2V0PFJ1bGVFbmdpbmVTZXJ2aWNlPihSdWxlRW5naW5lU2VydmljZSlcbiAgICBldmVudEJ1c1NlcnZpY2UgPSBtb2R1bGUuZ2V0KEV2ZW50QnVzU2VydmljZSlcblxuICAgIC8vIOWcqOavj+S4qua1i+ivleWJjemHjee9ruaooeaLn+WHveaVsOeahOeKtuaAgVxuICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrQ2xlYXIoKVxuICAgIGV2ZW50QnVzU2VydmljZS5wdWJsaXNoLm1vY2tDbGVhcigpXG4gICAgOyhydWxlRW5naW5lU2VydmljZS5leGVjdXRlIGFzIGplc3QuTW9jaykubW9ja0NsZWFyKClcbiAgfSlcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KGxvZ2ljU2VydmljZSkudG9CZURlZmluZWQoKVxuICB9KVxuXG4gIGRlc2NyaWJlKCdwcm9jZXNzTG9naWMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgcHJvY2VzcyBhIHBsYXllciBhY3Rpb24sIGV4ZWN1dGUgZGlyZWN0aXZlcywgYW5kIHB1Ymxpc2ggYSBjb21wbGV0aW9uIGV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gMS4g5YeG5aSHIChBcnJhbmdlKVxuICAgICAgY29uc3QgbW9ja0pvYkRhdGE6IEdhbWVBY3Rpb25Kb2JEYXRhID0ge1xuICAgICAgICBnYW1lSWQ6ICd0ZXN0LWdhbWUtaWQnLFxuICAgICAgICB1c2VySWQ6ICd0ZXN0LXVzZXItaWQnLFxuICAgICAgICBwbGF5ZXJBY3Rpb246IHsgdHlwZTogJ2NvbW1hbmQnLCBwYXlsb2FkOiAndGVzdCBjb21tYW5kJyB9LFxuICAgICAgICBnYW1lU3RhdGVTbmFwc2hvdDoge30gYXMgYW55LCAvLyDlnKjmraTmtYvor5XkuK3miJHku6zkuI3lhbPlv4Plv6vnhafnmoTlhbfkvZPlhoXlrrlcbiAgICAgIH1cblxuICAgICAgY29uc3QgbW9ja0RpcmVjdGl2ZXM6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndXBkYXRlX2NoYXJhY3RlcicsXG4gICAgICAgICAgdGFyZ2V0SWQ6ICdwbGF5ZXInLFxuICAgICAgICAgIHBheWxvYWQ6IHsgaHA6IHsgb3A6ICdkZWNyZW1lbnQnLCB2YWx1ZTogMTAgfSB9LFxuICAgICAgICB9LFxuICAgICAgXVxuXG4gICAgICAvLyDorr7nva4gY2FsbEFpV2l0aEd1YXJkIOeahOaooeaLn+ihjOS4uu+8muW9k+Wug+iiq+iwg+eUqOaXtu+8jOi/lOWbnuaIkeS7rOmihOiuvueahOaMh+S7pOmbhlxuICAgICAgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tEaXJlY3RpdmVzKVxuXG4gICAgICAvLyAyLiDooYzliqggKEFjdClcbiAgICAgIGF3YWl0IGxvZ2ljU2VydmljZS5wcm9jZXNzTG9naWMobW9ja0pvYkRhdGEpXG5cbiAgICAgIC8vIDMuIOaWreiogCAoQXNzZXJ0KVxuICAgICAgLy8g6aqM6K+BQUnmiqTmoI/lh73mlbDmmK/lkKbooqvosIPnlKjov4cx5qyhXG4gICAgICBleHBlY3QobW9ja2VkQ2FsbEFpV2l0aEd1YXJkKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSlcblxuICAgICAgLy8g6aqM6K+BIFJ1bGVFbmdpbmVTZXJ2aWNlIOeahCBleGVjdXRlIOaWueazleaYr+WQpuiiq+iwg+eUqO+8jOW5tuS4lOS8oOWFpeS6huato+ehrueahCBnYW1lSWQg5ZKMIEFJIOeUn+aIkOeahOaMh+S7pFxuICAgICAgZXhwZWN0KHJ1bGVFbmdpbmVTZXJ2aWNlLmV4ZWN1dGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKVxuICAgICAgZXhwZWN0KHJ1bGVFbmdpbmVTZXJ2aWNlLmV4ZWN1dGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKG1vY2tKb2JEYXRhLmdhbWVJZCwgbW9ja0RpcmVjdGl2ZXMpXG5cbiAgICAgIC8vIOmqjOivgSBFdmVudEJ1c1NlcnZpY2Ug55qEIHB1Ymxpc2gg5pa55rOV5piv5ZCm6KKr6LCD55So77yM5Lul6YCa55+l5LiL5LiA5Liq5b6u5pyN5YqhXG4gICAgICBleHBlY3QoZXZlbnRCdXNTZXJ2aWNlLnB1Ymxpc2gpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKVxuICAgICAgZXhwZWN0KGV2ZW50QnVzU2VydmljZS5wdWJsaXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnTE9HSUNfUFJPQ0VTU0lOR19DT01QTEVURScsIHtcbiAgICAgICAgZ2FtZUlkOiBtb2NrSm9iRGF0YS5nYW1lSWQsXG4gICAgICAgIHVzZXJJZDogbW9ja0pvYkRhdGEudXNlcklkLFxuICAgICAgICBwbGF5ZXJBY3Rpb246IG1vY2tKb2JEYXRhLnBsYXllckFjdGlvbixcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3IgaWYgQUkgZ3VhcmQgZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyAxLiDlh4blpIcgKEFycmFuZ2UpXG4gICAgICBjb25zdCBtb2NrSm9iRGF0YTogR2FtZUFjdGlvbkpvYkRhdGEgPSB7fSBhcyBhbnlcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9ICdBSSBmYWlsZWQgdG8gZ2VuZXJhdGUgdmFsaWQgZGF0YSdcbiAgICAgIC8vIOiuvue9riBjYWxsQWlXaXRoR3VhcmQg55qE5qih5ouf6KGM5Li677ya5b2T5a6D6KKr6LCD55So5pe277yM5oqb5Ye65LiA5Liq6ZSZ6K+vXG4gICAgICBtb2NrZWRDYWxsQWlXaXRoR3VhcmQubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKGVycm9yTWVzc2FnZSkpXG5cbiAgICAgIC8vIDIuICYgMy4g6KGM5Yqo5LiO5pat6KiAIChBY3QgJiBBc3NlcnQpXG4gICAgICAvLyDpqozor4HlvZMgZ2VuZXJhdGVEaXJlY3RpdmVzIOWksei0peaXtu+8jHByb2Nlc3NMb2dpYyDkvJrlkJHkuIrmipvlh7rlvILluLhcbiAgICAgIGF3YWl0IGV4cGVjdChsb2dpY1NlcnZpY2UucHJvY2Vzc0xvZ2ljKG1vY2tKb2JEYXRhKSkucmVqZWN0cy50b1Rocm93KFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgbWVzc2FnZTogZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoZXJyb3JNZXNzYWdlKSxcbiAgICAgICAgfSlcbiAgICAgIClcblxuICAgICAgLy8g6aqM6K+B5Zyo6L+Z56eN5aSx6LSl5oOF5Ya15LiL77yMUnVsZUVuZ2luZSDlkowgRXZlbnRCdXMg6YO95LiN5Lya6KKr6LCD55SoXG4gICAgICBleHBlY3QocnVsZUVuZ2luZVNlcnZpY2UuZXhlY3V0ZSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgICAgZXhwZWN0KGV2ZW50QnVzU2VydmljZS5wdWJsaXNoKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgfSlcbiAgfSlcbn0pXG4iXSwidmVyc2lvbiI6M30=