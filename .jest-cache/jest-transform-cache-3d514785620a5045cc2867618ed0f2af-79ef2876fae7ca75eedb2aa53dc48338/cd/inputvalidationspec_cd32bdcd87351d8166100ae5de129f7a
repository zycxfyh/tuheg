42507e5c8ded1745804798bf4638feb3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const zod_1 = require("zod");
const create_ai_settings_dto_1 = require("./create-ai-settings.dto");
const submit_action_dto_1 = require("./submit-action.dto");
const update_ai_settings_dto_1 = require("./update-ai-settings.dto");
describe('AI settings validation schemas', () => {
    const basePayload = {
        provider: 'OpenAI',
        apiKey: 'sk-VALIDKEY_1234567890',
        modelId: 'gpt-4o-mini',
        baseUrl: 'https://api.openai.com/v1',
        roles: ['narrative_synthesis', 'logic_parsing'],
    };
    it('accepts a valid payload and trims fields', () => {
        const result = create_ai_settings_dto_1.createAiSettingsSchema.parse({
            ...basePayload,
            apiKey: '  sk-VALIDKEY_1234567890  ',
            modelId: ' gpt-4o-mini ',
            roles: [' narrative_synthesis ', 'logic_parsing'],
        });
        expect(result.apiKey).toBe('sk-VALIDKEY_1234567890');
        expect(result.modelId).toBe('gpt-4o-mini');
        expect(result.roles).toEqual(['narrative_synthesis', 'logic_parsing']);
    });
    it('rejects unknown providers', () => {
        expect(() => create_ai_settings_dto_1.createAiSettingsSchema.parse({
            ...basePayload,
            provider: 'Unknown',
        })).toThrow(zod_1.ZodError);
    });
    it('rejects API keys with spaces or invalid characters', () => {
        expect(() => create_ai_settings_dto_1.createAiSettingsSchema.parse({
            ...basePayload,
            apiKey: 'sk invalid key',
        })).toThrow('API key contains invalid characters.');
    });
    it('rejects role names with forbidden characters', () => {
        expect(() => create_ai_settings_dto_1.createAiSettingsSchema.parse({
            ...basePayload,
            roles: ['admin', 'bad role!'],
        })).toThrow('Role name can only include letters, numbers, colon, underscore, or hyphen.');
    });
    it('allows partial updates with sanitized fields', () => {
        const result = update_ai_settings_dto_1.updateAiSettingsSchema.parse({
            apiKey: 'sk-NEWKEY_123456789',
            roles: ['critic'],
        });
        expect(result.apiKey).toBe('sk-NEWKEY_123456789');
        expect(result.roles).toEqual(['critic']);
    });
    it('validates test connection payloads consistently', () => {
        expect(() => update_ai_settings_dto_1.testAiConnectionSchema.parse({
            provider: 'OpenAI',
            apiKey: 'sk-invalid key',
        })).toThrow('API key contains invalid characters.');
    });
});
describe('Submit action schema', () => {
    it('accepts valid command payloads', () => {
        const result = submit_action_dto_1.submitActionSchema.parse({
            type: 'command',
            payload: 'Investigate the mysterious glow.',
        });
        expect(result.payload).toBe('Investigate the mysterious glow.');
    });
    it('rejects command payloads with control characters', () => {
        expect(() => submit_action_dto_1.submitActionSchema.parse({
            type: 'command',
            payload: 'Invalid\u0007payload',
        })).toThrow('Command payload contains invalid control characters.');
    });
    it('rejects option payloads exceeding length limits', () => {
        expect(() => submit_action_dto_1.submitActionSchema.parse({
            type: 'option',
            payload: {
                dimension: 'exploration',
                check: 'perception',
                success_rate: 'high',
                text: 'x'.repeat(401),
            },
        })).toThrow('Option text must be 400 characters or fewer.');
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxkdG9cXF9fdGVzdHNfX1xcaW5wdXQtdmFsaWRhdGlvbi5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQThCO0FBQzlCLHFFQUFpRTtBQUNqRSwyREFBd0Q7QUFDeEQscUVBQXlGO0FBRXpGLFFBQVEsQ0FBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7SUFDOUMsTUFBTSxXQUFXLEdBQUc7UUFDbEIsUUFBUSxFQUFFLFFBQVE7UUFDbEIsTUFBTSxFQUFFLHdCQUF3QjtRQUNoQyxPQUFPLEVBQUUsYUFBYTtRQUN0QixPQUFPLEVBQUUsMkJBQTJCO1FBQ3BDLEtBQUssRUFBRSxDQUFDLHFCQUFxQixFQUFFLGVBQWUsQ0FBQztLQUN2QyxDQUFBO0lBRVYsRUFBRSxDQUFDLDBDQUEwQyxFQUFFLEdBQUcsRUFBRTtRQUNsRCxNQUFNLE1BQU0sR0FBRywrQ0FBc0IsQ0FBQyxLQUFLLENBQUM7WUFDMUMsR0FBRyxXQUFXO1lBQ2QsTUFBTSxFQUFFLDRCQUE0QjtZQUNwQyxPQUFPLEVBQUUsZUFBZTtZQUN4QixLQUFLLEVBQUUsQ0FBQyx1QkFBdUIsRUFBRSxlQUFlLENBQUM7U0FDbEQsQ0FBQyxDQUFBO1FBRUYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtRQUNwRCxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQTtRQUMxQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLHFCQUFxQixFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUE7SUFDeEUsQ0FBQyxDQUFDLENBQUE7SUFFRixFQUFFLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO1FBQ25DLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FDViwrQ0FBc0IsQ0FB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Q0FBQyw4Q0FBOEMsQ0FBQyxDQUFBO0lBQzNELENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxkdG9cXF9fdGVzdHNfX1xcaW5wdXQtdmFsaWRhdGlvbi5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFpvZEVycm9yIH0gZnJvbSAnem9kJ1xuaW1wb3J0IHsgY3JlYXRlQWlTZXR0aW5nc1NjaGVtYSB9IGZyb20gJy4vY3JlYXRlLWFpLXNldHRpbmdzLmR0bydcbmltcG9ydCB7IHN1Ym1pdEFjdGlvblNjaGVtYSB9IGZyb20gJy4vc3VibWl0LWFjdGlvbi5kdG8nXG5pbXBvcnQgeyB0ZXN0QWlDb25uZWN0aW9uU2NoZW1hLCB1cGRhdGVBaVNldHRpbmdzU2NoZW1hIH0gZnJvbSAnLi91cGRhdGUtYWktc2V0dGluZ3MuZHRvJ1xuXG5kZXNjcmliZSgnQUkgc2V0dGluZ3MgdmFsaWRhdGlvbiBzY2hlbWFzJywgKCkgPT4ge1xuICBjb25zdCBiYXNlUGF5bG9hZCA9IHtcbiAgICBwcm92aWRlcjogJ09wZW5BSScsXG4gICAgYXBpS2V5OiAnc2stVkFMSURLRVlfMTIzNDU2Nzg5MCcsXG4gICAgbW9kZWxJZDogJ2dwdC00by1taW5pJyxcbiAgICBiYXNlVXJsOiAnaHR0cHM6Ly9hcGkub3BlbmFpLmNvbS92MScsXG4gICAgcm9sZXM6IFsnbmFycmF0aXZlX3N5bnRoZXNpcycsICdsb2dpY19wYXJzaW5nJ10sXG4gIH0gYXMgY29uc3RcblxuICBpdCgnYWNjZXB0cyBhIHZhbGlkIHBheWxvYWQgYW5kIHRyaW1zIGZpZWxkcycsICgpID0+IHtcbiAgICBjb25zdCByZXN1bHQgPSBjcmVhdGVBaVNldHRpbmdzU2NoZW1hLnBhcnNlKHtcbiAgICAgIC4uLmJhc2VQYXlsb2FkLFxuICAgICAgYXBpS2V5OiAnICBzay1WQUxJREtFWV8xMjM0NTY3ODkwICAnLFxuICAgICAgbW9kZWxJZDogJyBncHQtNG8tbWluaSAnLFxuICAgICAgcm9sZXM6IFsnIG5hcnJhdGl2ZV9zeW50aGVzaXMgJywgJ2xvZ2ljX3BhcnNpbmcnXSxcbiAgICB9KVxuXG4gICAgZXhwZWN0KHJlc3VsdC5hcGlLZXkpLnRvQmUoJ3NrLVZBTElES0VZXzEyMzQ1Njc4OTAnKVxuICAgIGV4cGVjdChyZXN1bHQubW9kZWxJZCkudG9CZSgnZ3B0LTRvLW1pbmknKVxuICAgIGV4cGVjdChyZXN1bHQucm9sZXMpLnRvRXF1YWwoWyduYXJyYXRpdmVfc3ludGhlc2lzJywgJ2xvZ2ljX3BhcnNpbmcnXSlcbiAgfSlcblxuICBpdCgncmVqZWN0cyB1bmtub3duIHByb3ZpZGVycycsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT5cbiAgICAgIGNyZWF0ZUFpU2V0dGluZ3NTY2hlbWEucGFyc2Uoe1xuICAgICAgICAuLi5iYXNlUGF5bG9hZCxcbiAgICAgICAgcHJvdmlkZXI6ICdVbmtub3duJyxcbiAgICAgIH0pXG4gICAgKS50b1Rocm93KFpvZEVycm9yKVxuICB9KVxuXG4gIGl0KCdyZWplY3RzIEFQSSBrZXlzIHdpdGggc3BhY2VzIG9yIGludmFsaWQgY2hhcmFjdGVycycsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT5cbiAgICAgIGNyZWF0ZUFpU2V0dGluZ3NTY2hlbWEucGFyc2Uoe1xuICAgICAgICAuLi5iYXNlUGF5bG9hZCxcbiAgICAgICAgYXBpS2V5OiAnc2sgaW52YWxpZCBrZXknLFxuICAgICAgfSlcbiAgICApLnRvVGhyb3coJ0FQSSBrZXkgY29udGFpbnMgaW52YWxpZCBjaGFyYWN0ZXJzLicpXG4gIH0pXG5cbiAgaXQoJ3JlamVjdHMgcm9sZSBuYW1lcyB3aXRoIGZvcmJpZGRlbiBjaGFyYWN0ZXJzJywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PlxuICAgICAgY3JlYXRlQWlTZXR0aW5nc1NjaGVtYS5wYXJzZSh7XG4gICAgICAgIC4uLmJhc2VQYXlsb2FkLFxuICAgICAgICByb2xlczogWydhZG1pbicsICdiYWQgcm9sZSEnXSxcbiAgICAgIH0pXG4gICAgKS50b1Rocm93KCdSb2xlIG5hbWUgY2FuIG9ubHkgaW5jbHVkZSBsZXR0ZXJzLCBudW1iZXJzLCBjb2xvbiwgdW5kZXJzY29yZSwgb3IgaHlwaGVuLicpXG4gIH0pXG5cbiAgaXQoJ2FsbG93cyBwYXJ0aWFsIHVwZGF0ZXMgd2l0aCBzYW5pdGl6ZWQgZmllbGRzJywgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IHVwZGF0ZUFpU2V0dGluZ3NTY2hlbWEucGFyc2Uoe1xuICAgICAgYXBpS2V5OiAnc2stTkVXS0VZXzEyMzQ1Njc4OScsXG4gICAgICByb2xlczogWydjcml0aWMnXSxcbiAgICB9KVxuXG4gICAgZXhwZWN0KHJlc3VsdC5hcGlLZXkpLnRvQmUoJ3NrLU5FV0tFWV8xMjM0NTY3ODknKVxuICAgIGV4cGVjdChyZXN1bHQucm9sZXMpLnRvRXF1YWwoWydjcml0aWMnXSlcbiAgfSlcblxuICBpdCgndmFsaWRhdGVzIHRlc3QgY29ubmVjdGlvbiBwYXlsb2FkcyBjb25zaXN0ZW50bHknLCAoKSA9PiB7XG4gICAgZXhwZWN0KCgpID0+XG4gICAgICB0ZXN0QWlDb25uZWN0aW9uU2NoZW1hLnBhcnNlKHtcbiAgICAgICAgcHJvdmlkZXI6ICdPcGVuQUknLFxuICAgICAgICBhcGlLZXk6ICdzay1pbnZhbGlkIGtleScsXG4gICAgICB9KVxuICAgICkudG9UaHJvdygnQVBJIGtleSBjb250YWlucyBpbnZhbGlkIGNoYXJhY3RlcnMuJylcbiAgfSlcbn0pXG5cbmRlc2NyaWJlKCdTdWJtaXQgYWN0aW9uIHNjaGVtYScsICgpID0+IHtcbiAgaXQoJ2FjY2VwdHMgdmFsaWQgY29tbWFuZCBwYXlsb2FkcycsICgpID0+IHtcbiAgICBjb25zdCByZXN1bHQgPSBzdWJtaXRBY3Rpb25TY2hlbWEucGFyc2Uoe1xuICAgICAgdHlwZTogJ2NvbW1hbmQnLFxuICAgICAgcGF5bG9hZDogJ0ludmVzdGlnYXRlIHRoZSBteXN0ZXJpb3VzIGdsb3cuJyxcbiAgICB9KVxuXG4gICAgZXhwZWN0KHJlc3VsdC5wYXlsb2FkKS50b0JlKCdJbnZlc3RpZ2F0ZSB0aGUgbXlzdGVyaW91cyBnbG93LicpXG4gIH0pXG5cbiAgaXQoJ3JlamVjdHMgY29tbWFuZCBwYXlsb2FkcyB3aXRoIGNvbnRyb2wgY2hhcmFjdGVycycsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT5cbiAgICAgIHN1Ym1pdEFjdGlvblNjaGVtYS5wYXJzZSh7XG4gICAgICAgIHR5cGU6ICdjb21tYW5kJyxcbiAgICAgICAgcGF5bG9hZDogJ0ludmFsaWRcXHUwMDA3cGF5bG9hZCcsXG4gICAgICB9KVxuICAgICkudG9UaHJvdygnQ29tbWFuZCBwYXlsb2FkIGNvbnRhaW5zIGludmFsaWQgY29udHJvbCBjaGFyYWN0ZXJzLicpXG4gIH0pXG5cbiAgaXQoJ3JlamVjdHMgb3B0aW9uIHBheWxvYWRzIGV4Y2VlZGluZyBsZW5ndGggbGltaXRzJywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PlxuICAgICAgc3VibWl0QWN0aW9uU2NoZW1hLnBhcnNlKHtcbiAgICAgICAgdHlwZTogJ29wdGlvbicsXG4gICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICBkaW1lbnNpb246ICdleHBsb3JhdGlvbicsXG4gICAgICAgICAgY2hlY2s6ICdwZXJjZXB0aW9uJyxcbiAgICAgICAgICBzdWNjZXNzX3JhdGU6ICdoaWdoJyxcbiAgICAgICAgICB0ZXh0OiAneCcucmVwZWF0KDQwMSksXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICkudG9UaHJvdygnT3B0aW9uIHRleHQgbXVzdCBiZSA0MDAgY2hhcmFjdGVycyBvciBmZXdlci4nKVxuICB9KVxufSlcbiJdLCJ2ZXJzaW9uIjozfQ==