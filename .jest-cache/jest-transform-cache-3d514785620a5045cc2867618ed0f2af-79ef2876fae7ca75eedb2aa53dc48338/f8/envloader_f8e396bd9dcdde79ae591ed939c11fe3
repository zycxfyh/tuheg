5cde71e1cbed3e02b50c46ea754f8b33
"use strict";
// 文件路径: packages/common-backend/src/config/env-loader.ts
// 核心理念: 支持环境变量扩展和多环境配置
Object.defineProperty(exports, "__esModule", { value: true });
exports.EnvLoader = void 0;
const dotenv_1 = require("dotenv");
const dotenv_expand_1 = require("dotenv-expand");
const fs_1 = require("fs");
const path_1 = require("path");
/**
 * @class EnvLoader
 * @description 环境变量加载器
 * 支持环境变量扩展和多环境配置
 */
class EnvLoader {
    /**
     * @method load
     * @description 加载环境变量
     *
     * @example
     * ```typescript
     * // 加载 .env 文件
     * EnvLoader.load();
     *
     * // 加载特定环境的配置
     * EnvLoader.load({ env: 'production' });
     * ```
     */
    static load(options = {}) {
        const { env = process.env.NODE_ENV || 'development', configDir = process.cwd(), override = false, silent = false, } = options;
        // 加载顺序：
        // 1. .env (基础配置)
        // 2. .env.local (本地覆盖，不提交到 Git)
        // 3. .env.{env} (环境特定配置，如 .env.production)
        // 4. .env.{env}.local (环境特定的本地覆盖)
        const envFiles = ['.env', '.env.local', `.env.${env}`, `.env.${env}.local`];
        for (const envFile of envFiles) {
            const envPath = (0, path_1.resolve)(configDir, envFile);
            if ((0, fs_1.existsSync)(envPath)) {
                try {
                    const result = (0, dotenv_1.config)({
                        path: envPath,
                        override,
                    });
                    if (result.error && !silent) {
                        console.warn(`Failed to load ${envFile}:`, result.error.message);
                    }
                    else if (result.parsed) {
                        // 扩展环境变量（支持 ${VAR} 引用）
                        (0, dotenv_expand_1.expand)(result);
                        console.log(`✓ Loaded ${envFile}`);
                    }
                }
                catch (error) {
                    if (!silent) {
                        console.warn(`Error loading ${envFile}:`, error);
                    }
                }
            }
        }
    }
    /**
     * @method loadForApp
     * @description 为特定应用加载环境变量
     *
     * @example
     * ```typescript
     * // 为 backend-gateway 加载配置
     * EnvLoader.loadForApp('backend-gateway');
     * ```
     */
    static loadForApp(appName, options = {}) {
        const { env = process.env.NODE_ENV || 'development', configDir = process.cwd() } = options;
        // 应用特定的环境文件
        const appEnvFiles = [
            `.env.${appName}`,
            `.env.${appName}.local`,
            `.env.${appName}.${env}`,
            `.env.${appName}.${env}.local`,
        ];
        for (const envFile of appEnvFiles) {
            const envPath = (0, path_1.resolve)(configDir, envFile);
            if ((0, fs_1.existsSync)(envPath)) {
                try {
                    const result = (0, dotenv_1.config)({
                        path: envPath,
                        override: true, // 应用特定配置覆盖全局配置
                    });
                    if (result.parsed) {
                        (0, dotenv_expand_1.expand)(result);
                        console.log(`✓ Loaded ${envFile} for ${appName}`);
                    }
                }
                catch (error) {
                    console.warn(`Error loading ${envFile}:`, error);
                }
            }
        }
    }
}
exports.EnvLoader = EnvLoader;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxjb25maWdcXGVudi1sb2FkZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHlEQUF5RDtBQUN6RCx1QkFBdUI7OztBQUV2QixtQ0FBK0I7QUFDL0IsaURBQXNDO0FBQ3RDLDJCQUErQjtBQUMvQiwrQkFBOEI7QUFpQjlCOzs7O0dBSUc7QUFDSCxNQUFhLFNBQVM7SUFDcEI7Ozs7Ozs7Ozs7OztPQVlHO0lBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxVQUE0QixFQUFFO1FBQy9DLE1BQU0sRUFDSixHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksYUFBYSxFQUMzQyxTQUFTLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUN6QixRQUFRLEdBQUcsS0FBSyxFQUNoQixNQUFNLEdBQUcsS0FBSyxHQUNmLEdBQUcsT0FBTyxDQUFBO1FBRVgsUUFBUTtRQUNSLGlCQUFpQjtRQUNqQixnQ0FBZ0M7UUFDaEMsMkNBQTJDO1FBQzNDLGtDQUFrQztRQUVsQyxNQUFNLFFBQVEsR0FBRyxDQUFDLE1BQU0sRUFBRSxZQUFZLEVBQUUsUUFBUSxHQUFHLEVBQUUsRUFBRSxRQUFRLEdBQUcsUUFBUSxDQUFDLENBQUE7UUFFM0UsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUMvQixNQUFNLE9BQU8sR0FBRyxJQUFBLGNBQU8sRUFBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUE7WUFFM0MsSUFBSSxJQUFBLGVBQVUsRUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO2dCQUN4QixJQUFJLENBQUM7b0JBQ0gsTUFBTSxNQUFNLEdBQUcsSUFBQSxlQUFNLEVBQUM7d0JBQ3BCLElBQUksRUFBRSxPQUFPO3dCQUNiLFFBQVE7cUJBQ1QsQ0FBQyxDQUFBO29CQUVGLElBQUksTUFBTSxDQUFDLEtBQUssSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO3dCQUM1QixPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixPQUFPLEdBQUcsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFBO29CQUNsRSxDQUFDO3lCQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO3dCQUN6Qix1QkFBdUI7d0JBQ3ZCLElBQUEsc0JBQU0sRUFBQyxNQUFNLENBQUMsQ0FBQTt3QkFDZCxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksT0FBTyxFQUFFLENBQUMsQ0FBQTtvQkFDcEMsQ0FBQztnQkFDSCxDQUFDO2dCQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7b0JBQ2YsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO3dCQUNaLE9BQU8sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLE9BQU8sR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFBO29CQUNsRCxDQUFDO2dCQUNILENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSSxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQWUsRUFBRSxVQUE0QixFQUFFO1FBQ3RFLE1BQU0sRUFBRSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksYUFBYSxFQUFFLFNBQVMsR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsR0FBRyxPQUFPLENBQUE7UUFFMUYsWUFBWTtRQUNaLE1BQU0sV0FBVyxHQUFHO1lBQ2xCLFFBQVEsT0FBTyxFQUFFO1lBQ2pCLFFBQVEsT0FBTyxRQUFRO1lBQ3ZCLFFBQVEsT0FBTyxJQUFJLEdBQUcsRUFBRTtZQUN4QixRQUFRLE9BQU8sSUFBSSxHQUFHLFFBQVE7U0FDL0IsQ0FBQTtRQUVELEtBQUssTUFBTSxPQUFPLElBQUksV0FBVyxFQUFFLENBQUM7WUFDbEMsTUFBTSxPQUFPLEdBQUcsSUFBQSxjQUFPLEVBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFBO1lBRTNDLElBQUksSUFBQSxlQUFVLEVBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztnQkFDeEIsSUFBSSxDQUFDO29CQUNILE1BQU0sTUFBTSxHQUFHLElBQUEsZUFBTSxFQUFDO3dCQUNwQixJQUFJLEVBQUUsT0FBTzt3QkFDYixRQUFRLEVBQUUsSUFBSSxFQUFFLGVBQWU7cUJBQ2hDLENBQUMsQ0FBQTtvQkFFRixJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQzt3QkFDbEIsSUFBQSxzQkFBTSxFQUFDLE1BQU0sQ0FBQyxDQUFBO3dCQUNkLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxPQUFPLFFBQVEsT0FBTyxFQUFFLENBQUMsQ0FBQTtvQkFDbkQsQ0FBQztnQkFDSCxDQUFDO2dCQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7b0JBQ2YsT0FBTyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsT0FBTyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUE7Z0JBQ2xELENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRjtBQWpHRCw4QkFpR0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxjb25maWdcXGVudi1sb2FkZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8g5paH5Lu26Lev5b6EOiBwYWNrYWdlcy9jb21tb24tYmFja2VuZC9zcmMvY29uZmlnL2Vudi1sb2FkZXIudHNcbi8vIOaguOW/g+eQhuW/tTog5pSv5oyB546v5aKD5Y+Y6YeP5omp5bGV5ZKM5aSa546v5aKD6YWN572uXG5cbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJ2RvdGVudidcbmltcG9ydCB7IGV4cGFuZCB9IGZyb20gJ2RvdGVudi1leHBhbmQnXG5pbXBvcnQgeyBleGlzdHNTeW5jIH0gZnJvbSAnZnMnXG5pbXBvcnQgeyByZXNvbHZlIH0gZnJvbSAncGF0aCdcblxuLyoqXG4gKiBAaW50ZXJmYWNlIEVudkxvYWRlck9wdGlvbnNcbiAqIEBkZXNjcmlwdGlvbiDnjq/looPliqDovb3lmajpgInpoblcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFbnZMb2FkZXJPcHRpb25zIHtcbiAgLyoqIOeOr+Wig+WQjeensCAqL1xuICBlbnY/OiBzdHJpbmdcbiAgLyoqIOmFjee9ruebruW9lSAqL1xuICBjb25maWdEaXI/OiBzdHJpbmdcbiAgLyoqIOaYr+WQpuimhuebluW3suacieWPmOmHjyAqL1xuICBvdmVycmlkZT86IGJvb2xlYW5cbiAgLyoqIOaYr+WQpumdmem7mOWksei0pSAqL1xuICBzaWxlbnQ/OiBib29sZWFuXG59XG5cbi8qKlxuICogQGNsYXNzIEVudkxvYWRlclxuICogQGRlc2NyaXB0aW9uIOeOr+Wig+WPmOmHj+WKoOi9veWZqFxuICog5pSv5oyB546v5aKD5Y+Y6YeP5omp5bGV5ZKM5aSa546v5aKD6YWN572uXG4gKi9cbmV4cG9ydCBjbGFzcyBFbnZMb2FkZXIge1xuICAvKipcbiAgICogQG1ldGhvZCBsb2FkXG4gICAqIEBkZXNjcmlwdGlvbiDliqDovb3njq/looPlj5jph49cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBgdHlwZXNjcmlwdFxuICAgKiAvLyDliqDovb0gLmVudiDmlofku7ZcbiAgICogRW52TG9hZGVyLmxvYWQoKTtcbiAgICpcbiAgICogLy8g5Yqg6L2954m55a6a546v5aKD55qE6YWN572uXG4gICAqIEVudkxvYWRlci5sb2FkKHsgZW52OiAncHJvZHVjdGlvbicgfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBsb2FkKG9wdGlvbnM6IEVudkxvYWRlck9wdGlvbnMgPSB7fSk6IHZvaWQge1xuICAgIGNvbnN0IHtcbiAgICAgIGVudiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WIHx8ICdkZXZlbG9wbWVudCcsXG4gICAgICBjb25maWdEaXIgPSBwcm9jZXNzLmN3ZCgpLFxuICAgICAgb3ZlcnJpZGUgPSBmYWxzZSxcbiAgICAgIHNpbGVudCA9IGZhbHNlLFxuICAgIH0gPSBvcHRpb25zXG5cbiAgICAvLyDliqDovb3pobrluo/vvJpcbiAgICAvLyAxLiAuZW52ICjln7rnoYDphY3nva4pXG4gICAgLy8gMi4gLmVudi5sb2NhbCAo5pys5Zyw6KaG55uW77yM5LiN5o+Q5Lqk5YiwIEdpdClcbiAgICAvLyAzLiAuZW52LntlbnZ9ICjnjq/looPnibnlrprphY3nva7vvIzlpoIgLmVudi5wcm9kdWN0aW9uKVxuICAgIC8vIDQuIC5lbnYue2Vudn0ubG9jYWwgKOeOr+Wig+eJueWumueahOacrOWcsOimhueblilcblxuICAgIGNvbnN0IGVudkZpbGVzID0gWycuZW52JywgJy5lbnYubG9jYWwnLCBgLmVudi4ke2Vudn1gLCBgLmVudi4ke2Vudn0ubG9jYWxgXVxuXG4gICAgZm9yIChjb25zdCBlbnZGaWxlIG9mIGVudkZpbGVzKSB7XG4gICAgICBjb25zdCBlbnZQYXRoID0gcmVzb2x2ZShjb25maWdEaXIsIGVudkZpbGUpXG5cbiAgICAgIGlmIChleGlzdHNTeW5jKGVudlBhdGgpKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgcmVzdWx0ID0gY29uZmlnKHtcbiAgICAgICAgICAgIHBhdGg6IGVudlBhdGgsXG4gICAgICAgICAgICBvdmVycmlkZSxcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgaWYgKHJlc3VsdC5lcnJvciAmJiAhc2lsZW50KSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byBsb2FkICR7ZW52RmlsZX06YCwgcmVzdWx0LmVycm9yLm1lc3NhZ2UpXG4gICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQucGFyc2VkKSB7XG4gICAgICAgICAgICAvLyDmianlsZXnjq/looPlj5jph4/vvIjmlK/mjIEgJHtWQVJ9IOW8leeUqO+8iVxuICAgICAgICAgICAgZXhwYW5kKHJlc3VsdClcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGDinJMgTG9hZGVkICR7ZW52RmlsZX1gKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBpZiAoIXNpbGVudCkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBFcnJvciBsb2FkaW5nICR7ZW52RmlsZX06YCwgZXJyb3IpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgbG9hZEZvckFwcFxuICAgKiBAZGVzY3JpcHRpb24g5Li654m55a6a5bqU55So5Yqg6L29546v5aKD5Y+Y6YePXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogLy8g5Li6IGJhY2tlbmQtZ2F0ZXdheSDliqDovb3phY3nva5cbiAgICogRW52TG9hZGVyLmxvYWRGb3JBcHAoJ2JhY2tlbmQtZ2F0ZXdheScpO1xuICAgKiBgYGBcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgbG9hZEZvckFwcChhcHBOYW1lOiBzdHJpbmcsIG9wdGlvbnM6IEVudkxvYWRlck9wdGlvbnMgPSB7fSk6IHZvaWQge1xuICAgIGNvbnN0IHsgZW52ID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgfHwgJ2RldmVsb3BtZW50JywgY29uZmlnRGlyID0gcHJvY2Vzcy5jd2QoKSB9ID0gb3B0aW9uc1xuXG4gICAgLy8g5bqU55So54m55a6a55qE546v5aKD5paH5Lu2XG4gICAgY29uc3QgYXBwRW52RmlsZXMgPSBbXG4gICAgICBgLmVudi4ke2FwcE5hbWV9YCxcbiAgICAgIGAuZW52LiR7YXBwTmFtZX0ubG9jYWxgLFxuICAgICAgYC5lbnYuJHthcHBOYW1lfS4ke2Vudn1gLFxuICAgICAgYC5lbnYuJHthcHBOYW1lfS4ke2Vudn0ubG9jYWxgLFxuICAgIF1cblxuICAgIGZvciAoY29uc3QgZW52RmlsZSBvZiBhcHBFbnZGaWxlcykge1xuICAgICAgY29uc3QgZW52UGF0aCA9IHJlc29sdmUoY29uZmlnRGlyLCBlbnZGaWxlKVxuXG4gICAgICBpZiAoZXhpc3RzU3luYyhlbnZQYXRoKSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNvbmZpZyh7XG4gICAgICAgICAgICBwYXRoOiBlbnZQYXRoLFxuICAgICAgICAgICAgb3ZlcnJpZGU6IHRydWUsIC8vIOW6lOeUqOeJueWumumFjee9ruimhuebluWFqOWxgOmFjee9rlxuICAgICAgICAgIH0pXG5cbiAgICAgICAgICBpZiAocmVzdWx0LnBhcnNlZCkge1xuICAgICAgICAgICAgZXhwYW5kKHJlc3VsdClcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGDinJMgTG9hZGVkICR7ZW52RmlsZX0gZm9yICR7YXBwTmFtZX1gKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oYEVycm9yIGxvYWRpbmcgJHtlbnZGaWxlfTpgLCBlcnJvcilcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9