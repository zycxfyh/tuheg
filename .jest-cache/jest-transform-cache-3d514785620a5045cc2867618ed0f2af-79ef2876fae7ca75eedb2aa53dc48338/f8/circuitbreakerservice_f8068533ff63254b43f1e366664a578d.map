{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\resilience\\circuit-breaker.service.ts","mappings":";AAAA,0EAA0E;AAC1E,qBAAqB;;;;;;;;;;;;;AAErB,2CAAmD;AACnD,qCAA+B;AAE/B;;;GAGG;AACH,IAAY,YAOX;AAPD,WAAY,YAAY;IACtB,kBAAkB;IAClB,iCAAiB,CAAA;IACjB,uBAAuB;IACvB,6BAAa,CAAA;IACb,6BAA6B;IAC7B,uCAAuB,CAAA;AACzB,CAAC,EAPW,YAAY,4BAAZ,YAAY,QAOvB;AAsCD;;;;;GAKG;AAEI,IAAM,qBAAqB,6BAA3B,MAAM,qBAAqB;IACf,MAAM,GAAG,IAAI,eAAM,CAAC,uBAAqB,CAAC,IAAI,CAAC,CAAA;IAEhE,qBAAqB;IACb,WAAW,CAAQ;IAE3B,2CAA2C;IAC1B,QAAQ,GAAG,IAAI,GAAG,EAUhC,CAAA;IAEH;QACE,IAAI,CAAC,SAAS,EAAE,CAAA;IAClB,CAAC;IAED;;OAEG;IACK,SAAS;QACf,MAAM,QAAQ,GAAG,OAAO,CAAC,GAAG,CAAC,SAAS,CAAA;QACtC,IAAI,QAAQ,EAAE,CAAC;YACb,IAAI,CAAC;gBACH,IAAI,CAAC,WAAW,GAAG,IAAI,eAAK,CAAC,QAAQ,EAAE;oBACrC,oBAAoB,EAAE,CAAC;oBACvB,aAAa,EAAE,CAAC,KAAK,EAAE,EAAE;wBACvB,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,GAAG,EAAE,EAAE,IAAI,CAAC,CAAA;wBACxC,OAAO,KAAK,CAAA;oBACd,CAAC;iBACF,CAAC,CAAA;gBAEF,IAAI,CAAC,WAAW,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,KAAK,EAAE,EAAE;oBACrC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,uDAAuD,EAAE,KAAK,CAAC,CAAA;oBAChF,IAAI,CAAC,WAAW,GAAG,SAAS,CAAA;gBAC9B,CAAC,CAAC,CAAA;gBAEF,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,qCAAqC,CAAC,CAAA;YACxD,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,iDAAiD,EAAE,KAAK,CAAC,CAAA;YAC5E,CAAC;QACH,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,+DAA+D,CAAC,CAAA;QAClF,CAAC;IACH,CAAC;IAED;;;;;;;;;;;;OAYG;IACH,KAAK,CAAC,OAAO,CACX,IAAY,EACZ,SAA2B,EAC3B,UAAiC,EAAE;QAEnC,MAAM,EACJ,gBAAgB,GAAG,CAAC,EACpB,oBAAoB,GAAG,GAAG,EAC1B,OAAO,GAAG,IAAI,EACd,gBAAgB,GAAG,CAAC,EACpB,gBAAgB,GAAG,CAAC,GACrB,GAAG,OAAO,CAAA;QAEX,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAA;QAEnD,UAAU;QACV,IAAI,OAAO,CAAC,KAAK,KAAK,YAAY,CAAC,IAAI,EAAE,CAAC;YACxC,eAAe;YACf,MAAM,oBAAoB,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,OAAO,CAAC,eAAe,CAAA;YACjE,IAAI,oBAAoB,IAAI,OAAO,EAAE,CAAC;gBACpC,OAAO,CAAC,KAAK,GAAG,YAAY,CAAC,SAAS,CAAA;gBACtC,OAAO,CAAC,gBAAgB,GAAG,CAAC,CAAA;gBAC5B,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,oBAAoB,IAAI,6BAA6B,CAAC,CAAA;YACxE,CAAC;iBAAM,CAAC;gBACN,MAAM,IAAI,KAAK,CAAC,oBAAoB,IAAI,8BAA8B,CAAC,CAAA;YACzE,CAAC;QACH,CAAC;QAED,aAAa;QACb,IAAI,OAAO,CAAC,KAAK,KAAK,YAAY,CAAC,SAAS,EAAE,CAAC;YAC7C,IAAI,OAAO,CAAC,gBAAgB,IAAI,gBAAgB,EAAE,CAAC;gBACjD,MAAM,IAAI,KAAK,CAAC,oBAAoB,IAAI,wCAAwC,CAAC,CAAA;YACnF,CAAC;YACD,OAAO,CAAC,gBAAgB,EAAE,CAAA;QAC5B,CAAC;QAED,OAAO;QACP,IAAI,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,SAAS,EAAE,CAAA;YAEhC,KAAK;YACL,MAAM,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,OAAO,EAAE,gBAAgB,CAAC,CAAA;YACzD,OAAO,MAAM,CAAA;QACf,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,KAAK;YACL,MAAM,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,OAAO,EAAE,gBAAgB,EAAE,oBAAoB,CAAC,CAAA;YAC/E,MAAM,KAAK,CAAA;QACb,CAAC;IACH,CAAC;IAED;;;OAGG;IACK,KAAK,CAAC,kBAAkB,CAAC,IAAY;QAC3C,mCAAmC;QACnC,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YACrB,IAAI,CAAC;gBACH,MAAM,QAAQ,GAAG,mBAAmB,IAAI,EAAE,CAAA;gBAC1C,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAA;gBAErD,IAAI,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACjC,MAAM,OAAO,GAAG;wBACd,KAAK,EAAG,IAAI,CAAC,KAAsB,IAAI,YAAY,CAAC,MAAM;wBAC1D,QAAQ,EAAE,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;wBACtC,SAAS,EAAE,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC;wBACxC,eAAe,EAAE,QAAQ,CAAC,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC;wBACpD,gBAAgB,EAAE,QAAQ,CAAC,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC;wBACtD,OAAO,EAAE;4BACP,aAAa,EAAE,QAAQ,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC;4BAChD,kBAAkB,EAAE,QAAQ,CAAC,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC;4BAC1D,cAAc,EAAE,QAAQ,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC;4BAClD,WAAW,EAAE,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC;4BAC9C,KAAK,EAAG,IAAI,CAAC,KAAsB,IAAI,YAAY,CAAC,MAAM;4BAC1D,eAAe,EAAE,QAAQ,CAAC,IAAI,CAAC,eAAe,CAAC,IAAI,IAAI,CAAC,GAAG,EAAE;yBAC9D;qBACF,CAAA;oBACD,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,EAAE,OAAO,CAAC,CAAA;oBAChC,OAAO,OAAO,CAAA;gBAChB,CAAC;YACH,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,kCAAkC,IAAI,4BAA4B,EAAE,KAAK,CAAC,CAAA;YAC7F,CAAC;QACH,CAAC;QAED,wBAAwB;QACxB,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC;YAC7B,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,EAAE;gBACtB,KAAK,EAAE,YAAY,CAAC,MAAM;gBAC1B,QAAQ,EAAE,CAAC;gBACX,SAAS,EAAE,CAAC;gBACZ,eAAe,EAAE,CAAC;gBAClB,gBAAgB,EAAE,CAAC;gBACnB,OAAO,EAAE;oBACP,aAAa,EAAE,CAAC;oBAChB,kBAAkB,EAAE,CAAC;oBACrB,cAAc,EAAE,CAAC;oBACjB,WAAW,EAAE,CAAC;oBACd,KAAK,EAAE,YAAY,CAAC,MAAM;oBAC1B,eAAe,EAAE,IAAI,CAAC,GAAG,EAAE;iBAC5B;aACF,CAAC,CAAA;QACJ,CAAC;QACD,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAE,CAAA;IACjC,CAAC;IAED;;;OAGG;IACK,KAAK,CAAC,kBAAkB,CAC9B,IAAY,EACZ,OAA4D;QAE5D,IAAI,CAAC,IAAI,CAAC,WAAW;YAAE,OAAM;QAE7B,IAAI,CAAC;YACH,MAAM,QAAQ,GAAG,mBAAmB,IAAI,EAAE,CAAA;YAC1C,MAAM,IAAI,GAAG;gBACX,KAAK,EAAE,OAAO,CAAC,KAAK;gBACpB,QAAQ,EAAE,OAAO,CAAC,QAAQ,CAAC,QAAQ,EAAE;gBACrC,SAAS,EAAE,OAAO,CAAC,SAAS,CAAC,QAAQ,EAAE;gBACvC,eAAe,EAAE,OAAO,CAAC,eAAe,CAAC,QAAQ,EAAE;gBACnD,gBAAgB,EAAE,OAAO,CAAC,gBAAgB,CAAC,QAAQ,EAAE;gBACrD,aAAa,EAAE,OAAO,CAAC,OAAO,CAAC,aAAa,CAAC,QAAQ,EAAE;gBACvD,kBAAkB,EAAE,OAAO,CAAC,OAAO,CAAC,kBAAkB,CAAC,QAAQ,EAAE;gBACjE,cAAc,EAAE,OAAO,CAAC,OAAO,CAAC,cAAc,CAAC,QAAQ,EAAE;gBACzD,WAAW,EAAE,OAAO,CAAC,OAAO,CAAC,WAAW,CAAC,QAAQ,EAAE;gBACnD,eAAe,EAAE,OAAO,CAAC,OAAO,CAAC,eAAe,CAAC,QAAQ,EAAE;aAC5D,CAAA;YAED,MAAM,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAA;YAC5C,+DAA+D;YAC/D,MAAM,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAA;QAChD,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,kCAAkC,IAAI,YAAY,EAAE,KAAK,CAAC,CAAA;QAC7E,CAAC;IACH,CAAC;IAED;;;OAGG;IACK,KAAK,CAAC,aAAa,CACzB,IAAY,EACZ,OAA4D,EAC5D,gBAAwB;QAExB,OAAO,CAAC,OAAO,CAAC,aAAa,EAAE,CAAA;QAC/B,OAAO,CAAC,OAAO,CAAC,kBAAkB,EAAE,CAAA;QACpC,OAAO,CAAC,SAAS,EAAE,CAAA;QAEnB,0BAA0B;QAC1B,IAAI,OAAO,CAAC,KAAK,KAAK,YAAY,CAAC,SAAS,EAAE,CAAC;YAC7C,IAAI,OAAO,CAAC,SAAS,IAAI,gBAAgB,EAAE,CAAC;gBAC1C,OAAO,CAAC,KAAK,GAAG,YAAY,CAAC,MAAM,CAAA;gBACnC,OAAO,CAAC,QAAQ,GAAG,CAAC,CAAA;gBACpB,OAAO,CAAC,SAAS,GAAG,CAAC,CAAA;gBACrB,OAAO,CAAC,OAAO,CAAC,KAAK,GAAG,YAAY,CAAC,MAAM,CAAA;gBAC3C,OAAO,CAAC,OAAO,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;gBAC5C,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,oBAAoB,IAAI,0BAA0B,CAAC,CAAA;YACrE,CAAC;QACH,CAAC;QAED,QAAQ;QACR,OAAO,CAAC,OAAO,CAAC,WAAW;YACzB,OAAO,CAAC,OAAO,CAAC,aAAa,GAAG,CAAC;gBAC/B,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,cAAc,GAAG,OAAO,CAAC,OAAO,CAAC,aAAa;gBAChE,CAAC,CAAC,CAAC,CAAA;QAEP,YAAY;QACZ,MAAM,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE,OAAO,CAAC,CAAA;IAC9C,CAAC;IAED;;;OAGG;IACK,KAAK,CAAC,aAAa,CACzB,IAAY,EACZ,OAA4D,EAC5D,gBAAwB,EACxB,oBAA4B;QAE5B,OAAO,CAAC,OAAO,CAAC,aAAa,EAAE,CAAA;QAC/B,OAAO,CAAC,OAAO,CAAC,cAAc,EAAE,CAAA;QAChC,OAAO,CAAC,QAAQ,EAAE,CAAA;QAClB,OAAO,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;QAEpC,QAAQ;QACR,OAAO,CAAC,OAAO,CAAC,WAAW;YACzB,OAAO,CAAC,OAAO,CAAC,aAAa,GAAG,CAAC;gBAC/B,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,cAAc,GAAG,OAAO,CAAC,OAAO,CAAC,aAAa;gBAChE,CAAC,CAAC,CAAC,CAAA;QAEP,cAAc;QACd,IAAI,OAAO,CAAC,KAAK,KAAK,YAAY,CAAC,MAAM,EAAE,CAAC;YAC1C,MAAM,UAAU,GACd,OAAO,CAAC,QAAQ,IAAI,gBAAgB,IAAI,OAAO,CAAC,OAAO,CAAC,WAAW,IAAI,oBAAoB,CAAA;YAE7F,IAAI,UAAU,EAAE,CAAC;gBACf,OAAO,CAAC,KAAK,GAAG,YAAY,CAAC,IAAI,CAAA;gBACjC,OAAO,CAAC,OAAO,CAAC,KAAK,GAAG,YAAY,CAAC,IAAI,CAAA;gBACzC,OAAO,CAAC,OAAO,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;gBAC5C,IAAI,CAAC,MAAM,CAAC,IAAI,CACd,oBAAoB,IAAI,6BAA6B,OAAO,CAAC,QAAQ,mBAAmB,OAAO,CAAC,OAAO,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CACjI,CAAA;YACH,CAAC;QACH,CAAC;aAAM,IAAI,OAAO,CAAC,KAAK,KAAK,YAAY,CAAC,SAAS,EAAE,CAAC;YACpD,sBAAsB;YACtB,OAAO,CAAC,KAAK,GAAG,YAAY,CAAC,IAAI,CAAA;YACjC,OAAO,CAAC,OAAO,CAAC,KAAK,GAAG,YAAY,CAAC,IAAI,CAAA;YACzC,OAAO,CAAC,OAAO,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;YAC5C,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,oBAAoB,IAAI,2CAA2C,CAAC,CAAA;QACvF,CAAC;QAED,YAAY;QACZ,MAAM,IAAI,CAAC,kBAAkB,CAAC,IAAI,EAAE,OAAO,CAAC,CAAA;IAC9C,CAAC;IAED;;;OAGG;IACH,UAAU,CAAC,IAAY;QACrB,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAA;QACvC,OAAO,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,CAAA;IACzC,CAAC;IAED;;;OAGG;IACH,KAAK,CAAC,IAAY;QAChB,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAA;QACvC,IAAI,OAAO,EAAE,CAAC;YACZ,OAAO,CAAC,KAAK,GAAG,YAAY,CAAC,MAAM,CAAA;YACnC,OAAO,CAAC,QAAQ,GAAG,CAAC,CAAA;YACpB,OAAO,CAAC,SAAS,GAAG,CAAC,CAAA;YACrB,OAAO,CAAC,gBAAgB,GAAG,CAAC,CAAA;YAC5B,OAAO,CAAC,OAAO,GAAG;gBAChB,aAAa,EAAE,CAAC;gBAChB,kBAAkB,EAAE,CAAC;gBACrB,cAAc,EAAE,CAAC;gBACjB,WAAW,EAAE,CAAC;gBACd,KAAK,EAAE,YAAY,CAAC,MAAM;gBAC1B,eAAe,EAAE,IAAI,CAAC,GAAG,EAAE;aAC5B,CAAA;YACD,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,oBAAoB,IAAI,SAAS,CAAC,CAAA;QACpD,CAAC;IACH,CAAC;CACF,CAAA;AA5TY,sDAAqB;gCAArB,qBAAqB;IADjC,IAAA,mBAAU,GAAE;;GACA,qBAAqB,CA4TjC","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\resilience\\circuit-breaker.service.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/resilience/circuit-breaker.service.ts\n// 核心理念: 熔断器模式，防止级联故障\n\nimport { Injectable, Logger } from '@nestjs/common'\nimport { Redis } from 'ioredis'\n\n/**\n * @enum CircuitState\n * @description 熔断器状态\n */\nexport enum CircuitState {\n  /** 关闭状态：正常处理请求 */\n  CLOSED = 'closed',\n  /** 开启状态：拒绝所有请求，直接失败 */\n  OPEN = 'open',\n  /** 半开状态：允许部分请求通过，测试服务是否恢复 */\n  HALF_OPEN = 'half_open',\n}\n\n/**\n * @interface CircuitBreakerOptions\n * @description 熔断器选项\n */\nexport interface CircuitBreakerOptions {\n  /** 失败阈值（触发熔断的失败次数） */\n  failureThreshold?: number\n  /** 失败率阈值（触发熔断的失败率，0-1） */\n  failureRateThreshold?: number\n  /** 时间窗口（毫秒） */\n  timeout?: number\n  /** 半开状态允许的请求数 */\n  halfOpenRequests?: number\n  /** 半开状态成功后切换到关闭状态需要的成功次数 */\n  successThreshold?: number\n}\n\n/**\n * @interface CircuitBreakerMetrics\n * @description 熔断器指标\n */\nexport interface CircuitBreakerMetrics {\n  /** 总请求数 */\n  totalRequests: number\n  /** 成功请求数 */\n  successfulRequests: number\n  /** 失败请求数 */\n  failedRequests: number\n  /** 当前失败率 */\n  failureRate: number\n  /** 当前状态 */\n  state: CircuitState\n  /** 最后状态变更时间 */\n  lastStateChange: number\n}\n\n/**\n * @class CircuitBreakerService\n * @description 熔断器服务\n * 实现熔断器模式，防止级联故障\n * 支持 Redis 存储以实现集群一致性\n */\n@Injectable()\nexport class CircuitBreakerService {\n  private readonly logger = new Logger(CircuitBreakerService.name)\n\n  // Redis 客户端（用于分布式存储）\n  private redisClient?: Redis\n\n  // 内存存储（fallback when Redis is unavailable）\n  private readonly circuits = new Map<\n    string,\n    {\n      state: CircuitState\n      failures: number\n      successes: number\n      lastFailureTime: number\n      halfOpenRequests: number\n      metrics: CircuitBreakerMetrics\n    }\n  >()\n\n  constructor() {\n    this.initRedis()\n  }\n\n  /**\n   * 初始化 Redis 客户端\n   */\n  private initRedis(): void {\n    const redisUrl = process.env.REDIS_URL\n    if (redisUrl) {\n      try {\n        this.redisClient = new Redis(redisUrl, {\n          maxRetriesPerRequest: 3,\n          retryStrategy: (times) => {\n            const delay = Math.min(times * 50, 2000)\n            return delay\n          },\n        })\n\n        this.redisClient.on('error', (error) => {\n          this.logger.warn('Redis connection error, falling back to memory store:', error)\n          this.redisClient = undefined\n        })\n\n        this.logger.log('Circuit breaker using Redis storage')\n      } catch (error) {\n        this.logger.warn('Failed to initialize Redis, using memory store:', error)\n      }\n    } else {\n      this.logger.log('Circuit breaker using memory store (REDIS_URL not configured)')\n    }\n  }\n\n  /**\n   * @method execute\n   * @description 执行受保护的操作\n   *\n   * @example\n   * ```typescript\n   * const result = await circuitBreakerService.execute(\n   *   'ai-api',\n   *   async () => await aiService.call(),\n   *   { failureThreshold: 5, timeout: 5000 },\n   * );\n   * ```\n   */\n  async execute<T>(\n    name: string,\n    operation: () => Promise<T>,\n    options: CircuitBreakerOptions = {}\n  ): Promise<T> {\n    const {\n      failureThreshold = 5,\n      failureRateThreshold = 0.5,\n      timeout = 5000,\n      halfOpenRequests = 3,\n      successThreshold = 2,\n    } = options\n\n    const circuit = await this.getOrCreateCircuit(name)\n\n    // 检查熔断器状态\n    if (circuit.state === CircuitState.OPEN) {\n      // 检查是否可以进入半开状态\n      const timeSinceLastFailure = Date.now() - circuit.lastFailureTime\n      if (timeSinceLastFailure >= timeout) {\n        circuit.state = CircuitState.HALF_OPEN\n        circuit.halfOpenRequests = 0\n        this.logger.log(`Circuit breaker \"${name}\" transitioned to HALF_OPEN`)\n      } else {\n        throw new Error(`Circuit breaker \"${name}\" is OPEN. Request rejected.`)\n      }\n    }\n\n    // 半开状态：限制请求数\n    if (circuit.state === CircuitState.HALF_OPEN) {\n      if (circuit.halfOpenRequests >= halfOpenRequests) {\n        throw new Error(`Circuit breaker \"${name}\" is HALF_OPEN. Request limit reached.`)\n      }\n      circuit.halfOpenRequests++\n    }\n\n    // 执行操作\n    try {\n      const result = await operation()\n\n      // 成功\n      await this.recordSuccess(name, circuit, successThreshold)\n      return result\n    } catch (error) {\n      // 失败\n      await this.recordFailure(name, circuit, failureThreshold, failureRateThreshold)\n      throw error\n    }\n  }\n\n  /**\n   * @method getOrCreateCircuit\n   * @description 获取或创建熔断器\n   */\n  private async getOrCreateCircuit(name: string) {\n    // Primeiro tenta carregar do Redis\n    if (this.redisClient) {\n      try {\n        const redisKey = `circuit_breaker:${name}`\n        const data = await this.redisClient.hgetall(redisKey)\n\n        if (Object.keys(data).length > 0) {\n          const circuit = {\n            state: (data.state as CircuitState) || CircuitState.CLOSED,\n            failures: parseInt(data.failures) || 0,\n            successes: parseInt(data.successes) || 0,\n            lastFailureTime: parseInt(data.lastFailureTime) || 0,\n            halfOpenRequests: parseInt(data.halfOpenRequests) || 0,\n            metrics: {\n              totalRequests: parseInt(data.totalRequests) || 0,\n              successfulRequests: parseInt(data.successfulRequests) || 0,\n              failedRequests: parseInt(data.failedRequests) || 0,\n              failureRate: parseFloat(data.failureRate) || 0,\n              state: (data.state as CircuitState) || CircuitState.CLOSED,\n              lastStateChange: parseInt(data.lastStateChange) || Date.now(),\n            },\n          }\n          this.circuits.set(name, circuit)\n          return circuit\n        }\n      } catch (error) {\n        this.logger.warn(`Failed to load circuit breaker ${name} from Redis, using memory:`, error)\n      }\n    }\n\n    // Fallback para memória\n    if (!this.circuits.has(name)) {\n      this.circuits.set(name, {\n        state: CircuitState.CLOSED,\n        failures: 0,\n        successes: 0,\n        lastFailureTime: 0,\n        halfOpenRequests: 0,\n        metrics: {\n          totalRequests: 0,\n          successfulRequests: 0,\n          failedRequests: 0,\n          failureRate: 0,\n          state: CircuitState.CLOSED,\n          lastStateChange: Date.now(),\n        },\n      })\n    }\n    return this.circuits.get(name)!\n  }\n\n  /**\n   * @method saveCircuitToRedis\n   * @description 保存熔断器状态到 Redis\n   */\n  private async saveCircuitToRedis(\n    name: string,\n    circuit: Awaited<ReturnType<typeof this.getOrCreateCircuit>>\n  ): Promise<void> {\n    if (!this.redisClient) return\n\n    try {\n      const redisKey = `circuit_breaker:${name}`\n      const data = {\n        state: circuit.state,\n        failures: circuit.failures.toString(),\n        successes: circuit.successes.toString(),\n        lastFailureTime: circuit.lastFailureTime.toString(),\n        halfOpenRequests: circuit.halfOpenRequests.toString(),\n        totalRequests: circuit.metrics.totalRequests.toString(),\n        successfulRequests: circuit.metrics.successfulRequests.toString(),\n        failedRequests: circuit.metrics.failedRequests.toString(),\n        failureRate: circuit.metrics.failureRate.toString(),\n        lastStateChange: circuit.metrics.lastStateChange.toString(),\n      }\n\n      await this.redisClient.hmset(redisKey, data)\n      // Definir TTL de 24 horas para evitar acúmulo de dados antigos\n      await this.redisClient.expire(redisKey, 86400)\n    } catch (error) {\n      this.logger.warn(`Failed to save circuit breaker ${name} to Redis:`, error)\n    }\n  }\n\n  /**\n   * @method recordSuccess\n   * @description 记录成功\n   */\n  private async recordSuccess(\n    name: string,\n    circuit: Awaited<ReturnType<typeof this.getOrCreateCircuit>>,\n    successThreshold: number\n  ): Promise<void> {\n    circuit.metrics.totalRequests++\n    circuit.metrics.successfulRequests++\n    circuit.successes++\n\n    // 半开状态：如果成功次数达到阈值，切换到关闭状态\n    if (circuit.state === CircuitState.HALF_OPEN) {\n      if (circuit.successes >= successThreshold) {\n        circuit.state = CircuitState.CLOSED\n        circuit.failures = 0\n        circuit.successes = 0\n        circuit.metrics.state = CircuitState.CLOSED\n        circuit.metrics.lastStateChange = Date.now()\n        this.logger.log(`Circuit breaker \"${name}\" transitioned to CLOSED`)\n      }\n    }\n\n    // 更新失败率\n    circuit.metrics.failureRate =\n      circuit.metrics.totalRequests > 0\n        ? circuit.metrics.failedRequests / circuit.metrics.totalRequests\n        : 0\n\n    // 保存到 Redis\n    await this.saveCircuitToRedis(name, circuit)\n  }\n\n  /**\n   * @method recordFailure\n   * @description 记录失败\n   */\n  private async recordFailure(\n    name: string,\n    circuit: Awaited<ReturnType<typeof this.getOrCreateCircuit>>,\n    failureThreshold: number,\n    failureRateThreshold: number\n  ): Promise<void> {\n    circuit.metrics.totalRequests++\n    circuit.metrics.failedRequests++\n    circuit.failures++\n    circuit.lastFailureTime = Date.now()\n\n    // 更新失败率\n    circuit.metrics.failureRate =\n      circuit.metrics.totalRequests > 0\n        ? circuit.metrics.failedRequests / circuit.metrics.totalRequests\n        : 0\n\n    // 检查是否需要开启熔断器\n    if (circuit.state === CircuitState.CLOSED) {\n      const shouldOpen =\n        circuit.failures >= failureThreshold || circuit.metrics.failureRate >= failureRateThreshold\n\n      if (shouldOpen) {\n        circuit.state = CircuitState.OPEN\n        circuit.metrics.state = CircuitState.OPEN\n        circuit.metrics.lastStateChange = Date.now()\n        this.logger.warn(\n          `Circuit breaker \"${name}\" opened due to failures: ${circuit.failures}, failure rate: ${circuit.metrics.failureRate.toFixed(2)}`\n        )\n      }\n    } else if (circuit.state === CircuitState.HALF_OPEN) {\n      // 半开状态：如果失败，立即切换到开启状态\n      circuit.state = CircuitState.OPEN\n      circuit.metrics.state = CircuitState.OPEN\n      circuit.metrics.lastStateChange = Date.now()\n      this.logger.warn(`Circuit breaker \"${name}\" opened after failure in HALF_OPEN state`)\n    }\n\n    // 保存到 Redis\n    await this.saveCircuitToRedis(name, circuit)\n  }\n\n  /**\n   * @method getMetrics\n   * @description 获取熔断器指标\n   */\n  getMetrics(name: string): CircuitBreakerMetrics | null {\n    const circuit = this.circuits.get(name)\n    return circuit ? circuit.metrics : null\n  }\n\n  /**\n   * @method reset\n   * @description 重置熔断器\n   */\n  reset(name: string): void {\n    const circuit = this.circuits.get(name)\n    if (circuit) {\n      circuit.state = CircuitState.CLOSED\n      circuit.failures = 0\n      circuit.successes = 0\n      circuit.halfOpenRequests = 0\n      circuit.metrics = {\n        totalRequests: 0,\n        successfulRequests: 0,\n        failedRequests: 0,\n        failureRate: 0,\n        state: CircuitState.CLOSED,\n        lastStateChange: Date.now(),\n      }\n      this.logger.log(`Circuit breaker \"${name}\" reset`)\n    }\n  }\n}\n"],"version":3}