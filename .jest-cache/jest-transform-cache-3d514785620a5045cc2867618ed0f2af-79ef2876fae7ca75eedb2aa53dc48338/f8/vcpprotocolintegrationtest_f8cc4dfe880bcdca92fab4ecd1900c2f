88dde34900905d5a719d7328637d744d
"use strict";
// ============================================================================
// VCP协议核心集成测试
// 验证 VCPToolBox 协议标准的正确集成
// ============================================================================
Object.defineProperty(exports, "__esModule", { value: true });
const config_1 = require("@nestjs/config");
const testing_1 = require("@nestjs/testing");
const vcp_protocol_service_1 = require("../../../../packages/common-backend/src/vcp/vcp-protocol.service");
describe('VCPProtocolService Integration', () => {
    let service;
    let configService;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                vcp_protocol_service_1.VCPProtocolService,
                {
                    provide: config_1.ConfigService,
                    useValue: {
                        get: jest.fn((key, defaultValue) => {
                            const config = {
                                AI_PROVIDER: 'openai',
                                AI_MODEL: 'gpt-4',
                            };
                            return config[key] || defaultValue;
                        }),
                    },
                },
            ],
        }).compile();
        service = module.get(vcp_protocol_service_1.VCPProtocolService);
        configService = module.get(config_1.ConfigService);
    });
    it('应该能获取协议统计信息', () => {
        const stats = service.getProtocolStats();
        expect(stats).toHaveProperty('pendingRequests');
        expect(stats).toHaveProperty('activeEndpoints');
        expect(stats).toHaveProperty('queuedMessages');
        expect(stats).toHaveProperty('activeSubscriptions');
        expect(typeof stats.pendingRequests).toBe('number');
    });
    it('应该能执行健康检查', async () => {
        const health = await service.healthCheck();
        expect(health).toHaveProperty('status');
        expect(['healthy', 'error']).toContain(health.status);
        if (health.status === 'healthy') {
            expect(health).toHaveProperty('details');
        }
    });
    it('应该能获取可用端点', () => {
        const endpoints = service.getAvailableEndpoints();
        expect(Array.isArray(endpoints)).toBe(true);
        // 系统端点应该已经被注册
        expect(endpoints.length).toBeGreaterThan(0);
        // 检查是否有预期的端点
        const aiService = endpoints.find((ep) => ep.id === 'ai-service');
        expect(aiService).toBeDefined();
        expect(aiService?.capabilities).toContain('text-generation');
    });
    it('应该能按能力过滤端点', () => {
        const textGenEndpoints = service.getAvailableEndpoints('text-generation');
        expect(Array.isArray(textGenEndpoints)).toBe(true);
        textGenEndpoints.forEach((endpoint) => {
            expect(endpoint.capabilities).toContain('text-generation');
        });
    });
    it('应该能注册自定义端点', () => {
        const customEndpoint = {
            id: 'custom-endpoint',
            type: 'tool',
            url: 'http://custom-tool.com',
            capabilities: ['custom-analysis'],
            status: 'online',
            metadata: {
                version: '1.0.0',
                description: 'Custom analysis tool',
                author: 'test',
                lastSeen: new Date(),
            },
        };
        expect(() => {
            service.registerEndpoint(customEndpoint);
        }).not.toThrow();
        const endpoints = service.getAvailableEndpoints('custom-analysis');
        expect(endpoints.some((ep) => ep.id === 'custom-endpoint')).toBe(true);
    });
    it('应该能注销端点', () => {
        // 先注册一个端点
        const testEndpoint = {
            id: 'test-endpoint-to-remove',
            type: 'service',
            url: 'http://test.com',
            capabilities: ['test-service'],
            status: 'online',
            metadata: {
                version: '1.0.0',
                description: 'Test endpoint',
                author: 'test',
                lastSeen: new Date(),
            },
        };
        service.registerEndpoint(testEndpoint);
        // 确认端点已注册
        let endpoints = service.getAvailableEndpoints('test-service');
        expect(endpoints.some((ep) => ep.id === 'test-endpoint-to-remove')).toBe(true);
        // 注销端点
        service.unregisterEndpoint('test-endpoint-to-remove');
        // 确认端点已移除
        endpoints = service.getAvailableEndpoints('test-service');
        expect(endpoints.some((ep) => ep.id === 'test-endpoint-to-remove')).toBe(false);
    });
    it('应该能调用AI生成工具（模拟）', async () => {
        const prompt = '写一个简短的故事';
        const options = {
            model: 'gpt-4',
            temperature: 0.7,
            maxTokens: 500,
        };
        // 由于没有实际的AI服务，这可能会失败或返回模拟结果
        await expect(service.callAIGenerationTool(prompt, options)).rejects.toThrow();
    });
    it('应该能调用分析工具（模拟）', async () => {
        const content = '这是一个测试文本';
        const analysisType = 'sentiment';
        await expect(service.callAnalysisTool(content, analysisType)).rejects.toThrow();
    });
    it('应该能调用翻译工具（模拟）', async () => {
        const text = 'Hello world';
        const targetLanguage = 'zh-CN';
        const result = await service.callTranslationTool(text, targetLanguage);
        // 当前实现可能返回原文本或模拟结果
        expect(typeof result).toBe('string');
    });
    it('应该能执行记忆操作（模拟）', async () => {
        // 这些操作可能会失败，因为没有实际的后端服务
        await expect(service.readMemory('test-key')).rejects.toThrow();
        await expect(service.writeMemory('test-key', 'test-value')).rejects.toThrow();
    });
    it('应该能执行文件操作（模拟）', async () => {
        const fileData = { content: 'test file content' };
        await expect(service.uploadFile(fileData)).rejects.toThrow();
        await expect(service.downloadFile('test-file-id')).rejects.toThrow();
    });
    it('应该能发送叙事生成请求（模拟）', async () => {
        const storyId = 'test-story-123';
        const prompt = '写一个科幻故事';
        const context = { genre: 'sci-fi', length: 'short' };
        const taskId = await service.requestNarrativeGeneration(storyId, prompt, context);
        expect(typeof taskId).toBe('string');
        expect(taskId.length).toBeGreaterThan(0);
    });
    it('应该能发送Agent协作请求（模拟）', async () => {
        const collaborationId = 'test-collab-123';
        const agentIds = ['agent1', 'agent2'];
        const task = { type: 'story-writing', priority: 'high' };
        const resultId = await service.requestAgentCollaboration(collaborationId, agentIds, task);
        expect(typeof resultId).toBe('string');
    });
    it('应该能广播系统事件（模拟）', async () => {
        const eventType = 'system.maintenance';
        const eventData = { message: 'System maintenance scheduled', time: '2024-01-01T00:00:00Z' };
        // 不应该抛出错误
        await expect(service.broadcastSystemEvent(eventType, eventData)).resolves.not.toThrow();
    });
    it('应该能清理过期任务', async () => {
        // 不应该抛出错误
        await expect(service.cleanupExpiredTasks()).resolves.not.toThrow();
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXHZjcHRvb2xib3hcXHNyY1xcaW50ZWdyYXRpb24tdGVzdHNcXHZjcC1wcm90b2NvbC1pbnRlZ3JhdGlvbi50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQSwrRUFBK0U7QUFDL0UsY0FBYztBQUNkLDBCQUEwQjtBQUMxQiwrRUFBK0U7O0FBRS9FLDJDQUE4QztBQUM5Qyw2Q0FBMEQ7QUFDMUQsMkdBQXFHO0FBRXJHLFFBQVEsQ0FBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7SUFDOUMsSUFBSSxPQUEyQixDQUFBO0lBQy9CLElBQUksYUFBNEIsQ0FBQTtJQUVoQyxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCx5Q0FBa0I7Z0JBQ2xCO29CQUNFLE9BQU8sRUFBRSxzQkFBYTtvQkFDdEIsUUFBUSxFQUFFO3dCQUNSLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBVyxFQUFFLFlBQWtCLEVBQUUsRUFBRTs0QkFDL0MsTUFBTSxNQUFNLEdBQUc7Z0NBQ2IsV0FBVyxFQUFFLFFBQVE7Z0NBQ3JCLFFBQVEsRUFBRSxPQUFPOzZCQUNsQixDQUFBOzRCQUNELE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFlBQVksQ0FBQTt3QkFDcEMsQ0FBQyxDQUFDO3FCQUNIO2lCQUNGO2FBQ0Y7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUE7UUFFWixPQUFPLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBcUIseUNBQWtCLENBQUMsQ0FBQTtRQUM1RCxhQUFhLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBZ0Isc0JBQWEsQ0FBQyxDQUFBO0lBQzFELENBQUMsQ0FBQyxDQUFBO0lBRUYsRUFBRSxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUU7UUFDckIsTUFBTSxLQUFLLEdBQUcsT0FBTyxD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SUFBSSxFQUFFO1FBQ3pCLFVBQVU7UUFDVixNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDcEUsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xcYXBwc1xcdmNwdG9vbGJveFxcc3JjXFxpbnRlZ3JhdGlvbi10ZXN0c1xcdmNwLXByb3RvY29sLWludGVncmF0aW9uLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gVkNQ5Y2P6K6u5qC45b+D6ZuG5oiQ5rWL6K+VXG4vLyDpqozor4EgVkNQVG9vbEJveCDljY/orq7moIflh4bnmoTmraPnoa7pm4bmiJBcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJ1xuaW1wb3J0IHsgVGVzdCwgdHlwZSBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJ1xuaW1wb3J0IHsgVkNQUHJvdG9jb2xTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL3ZjcC92Y3AtcHJvdG9jb2wuc2VydmljZSdcblxuZGVzY3JpYmUoJ1ZDUFByb3RvY29sU2VydmljZSBJbnRlZ3JhdGlvbicsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFZDUFByb3RvY29sU2VydmljZVxuICBsZXQgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZVxuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgVkNQUHJvdG9jb2xTZXJ2aWNlLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogQ29uZmlnU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgZ2V0OiBqZXN0LmZuKChrZXk6IHN0cmluZywgZGVmYXVsdFZhbHVlPzogYW55KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgICAgICAgICAgICBBSV9QUk9WSURFUjogJ29wZW5haScsXG4gICAgICAgICAgICAgICAgQUlfTU9ERUw6ICdncHQtNCcsXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ1trZXldIHx8IGRlZmF1bHRWYWx1ZVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpXG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxWQ1BQcm90b2NvbFNlcnZpY2U+KFZDUFByb3RvY29sU2VydmljZSlcbiAgICBjb25maWdTZXJ2aWNlID0gbW9kdWxlLmdldDxDb25maWdTZXJ2aWNlPihDb25maWdTZXJ2aWNlKVxuICB9KVxuXG4gIGl0KCflupTor6Xog73ojrflj5bljY/orq7nu5/orqHkv6Hmga8nLCAoKSA9PiB7XG4gICAgY29uc3Qgc3RhdHMgPSBzZXJ2aWNlLmdldFByb3RvY29sU3RhdHMoKVxuXG4gICAgZXhwZWN0KHN0YXRzKS50b0hhdmVQcm9wZXJ0eSgncGVuZGluZ1JlcXVlc3RzJylcbiAgICBleHBlY3Qoc3RhdHMpLnRvSGF2ZVByb3BlcnR5KCdhY3RpdmVFbmRwb2ludHMnKVxuICAgIGV4cGVjdChzdGF0cykudG9IYXZlUHJvcGVydHkoJ3F1ZXVlZE1lc3NhZ2VzJylcbiAgICBleHBlY3Qoc3RhdHMpLnRvSGF2ZVByb3BlcnR5KCdhY3RpdmVTdWJzY3JpcHRpb25zJylcbiAgICBleHBlY3QodHlwZW9mIHN0YXRzLnBlbmRpbmdSZXF1ZXN0cykudG9CZSgnbnVtYmVyJylcbiAgfSlcblxuICBpdCgn5bqU6K+l6IO95omn6KGM5YGl5bq35qOA5p+lJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGhlYWx0aCA9IGF3YWl0IHNlcnZpY2UuaGVhbHRoQ2hlY2soKVxuXG4gICAgZXhwZWN0KGhlYWx0aCkudG9IYXZlUHJvcGVydHkoJ3N0YXR1cycpXG4gICAgZXhwZWN0KFsnaGVhbHRoeScsICdlcnJvciddKS50b0NvbnRhaW4oaGVhbHRoLnN0YXR1cylcblxuICAgIGlmIChoZWFsdGguc3RhdHVzID09PSAnaGVhbHRoeScpIHtcbiAgICAgIGV4cGVjdChoZWFsdGgpLnRvSGF2ZVByb3BlcnR5KCdkZXRhaWxzJylcbiAgICB9XG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveiOt+WPluWPr+eUqOerr+eCuScsICgpID0+IHtcbiAgICBjb25zdCBlbmRwb2ludHMgPSBzZXJ2aWNlLmdldEF2YWlsYWJsZUVuZHBvaW50cygpXG5cbiAgICBleHBlY3QoQXJyYXkuaXNBcnJheShlbmRwb2ludHMpKS50b0JlKHRydWUpXG4gICAgLy8g57O757uf56uv54K55bqU6K+l5bey57uP6KKr5rOo5YaMXG4gICAgZXhwZWN0KGVuZHBvaW50cy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKVxuXG4gICAgLy8g5qOA5p+l5piv5ZCm5pyJ6aKE5pyf55qE56uv54K5XG4gICAgY29uc3QgYWlTZXJ2aWNlID0gZW5kcG9pbnRzLmZpbmQoKGVwKSA9PiBlcC5pZCA9PT0gJ2FpLXNlcnZpY2UnKVxuICAgIGV4cGVjdChhaVNlcnZpY2UpLnRvQmVEZWZpbmVkKClcbiAgICBleHBlY3QoYWlTZXJ2aWNlPy5jYXBhYmlsaXRpZXMpLnRvQ29udGFpbigndGV4dC1nZW5lcmF0aW9uJylcbiAgfSlcblxuICBpdCgn5bqU6K+l6IO95oyJ6IO95Yqb6L+H5ruk56uv54K5JywgKCkgPT4ge1xuICAgIGNvbnN0IHRleHRHZW5FbmRwb2ludHMgPSBzZXJ2aWNlLmdldEF2YWlsYWJsZUVuZHBvaW50cygndGV4dC1nZW5lcmF0aW9uJylcblxuICAgIGV4cGVjdChBcnJheS5pc0FycmF5KHRleHRHZW5FbmRwb2ludHMpKS50b0JlKHRydWUpXG4gICAgdGV4dEdlbkVuZHBvaW50cy5mb3JFYWNoKChlbmRwb2ludCkgPT4ge1xuICAgICAgZXhwZWN0KGVuZHBvaW50LmNhcGFiaWxpdGllcykudG9Db250YWluKCd0ZXh0LWdlbmVyYXRpb24nKVxuICAgIH0pXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveazqOWGjOiHquWumuS5ieerr+eCuScsICgpID0+IHtcbiAgICBjb25zdCBjdXN0b21FbmRwb2ludCA9IHtcbiAgICAgIGlkOiAnY3VzdG9tLWVuZHBvaW50JyxcbiAgICAgIHR5cGU6ICd0b29sJyBhcyBjb25zdCxcbiAgICAgIHVybDogJ2h0dHA6Ly9jdXN0b20tdG9vbC5jb20nLFxuICAgICAgY2FwYWJpbGl0aWVzOiBbJ2N1c3RvbS1hbmFseXNpcyddLFxuICAgICAgc3RhdHVzOiAnb25saW5lJyBhcyBjb25zdCxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIHZlcnNpb246ICcxLjAuMCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnQ3VzdG9tIGFuYWx5c2lzIHRvb2wnLFxuICAgICAgICBhdXRob3I6ICd0ZXN0JyxcbiAgICAgICAgbGFzdFNlZW46IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgIH1cblxuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICBzZXJ2aWNlLnJlZ2lzdGVyRW5kcG9pbnQoY3VzdG9tRW5kcG9pbnQpXG4gICAgfSkubm90LnRvVGhyb3coKVxuXG4gICAgY29uc3QgZW5kcG9pbnRzID0gc2VydmljZS5nZXRBdmFpbGFibGVFbmRwb2ludHMoJ2N1c3RvbS1hbmFseXNpcycpXG4gICAgZXhwZWN0KGVuZHBvaW50cy5zb21lKChlcCkgPT4gZXAuaWQgPT09ICdjdXN0b20tZW5kcG9pbnQnKSkudG9CZSh0cnVlKVxuICB9KVxuXG4gIGl0KCflupTor6Xog73ms6jplIDnq6/ngrknLCAoKSA9PiB7XG4gICAgLy8g5YWI5rOo5YaM5LiA5Liq56uv54K5XG4gICAgY29uc3QgdGVzdEVuZHBvaW50ID0ge1xuICAgICAgaWQ6ICd0ZXN0LWVuZHBvaW50LXRvLXJlbW92ZScsXG4gICAgICB0eXBlOiAnc2VydmljZScgYXMgY29uc3QsXG4gICAgICB1cmw6ICdodHRwOi8vdGVzdC5jb20nLFxuICAgICAgY2FwYWJpbGl0aWVzOiBbJ3Rlc3Qtc2VydmljZSddLFxuICAgICAgc3RhdHVzOiAnb25saW5lJyBhcyBjb25zdCxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIHZlcnNpb246ICcxLjAuMCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnVGVzdCBlbmRwb2ludCcsXG4gICAgICAgIGF1dGhvcjogJ3Rlc3QnLFxuICAgICAgICBsYXN0U2VlbjogbmV3IERhdGUoKSxcbiAgICAgIH0sXG4gICAgfVxuXG4gICAgc2VydmljZS5yZWdpc3RlckVuZHBvaW50KHRlc3RFbmRwb2ludClcblxuICAgIC8vIOehruiupOerr+eCueW3suazqOWGjFxuICAgIGxldCBlbmRwb2ludHMgPSBzZXJ2aWNlLmdldEF2YWlsYWJsZUVuZHBvaW50cygndGVzdC1zZXJ2aWNlJylcbiAgICBleHBlY3QoZW5kcG9pbnRzLnNvbWUoKGVwKSA9PiBlcC5pZCA9PT0gJ3Rlc3QtZW5kcG9pbnQtdG8tcmVtb3ZlJykpLnRvQmUodHJ1ZSlcblxuICAgIC8vIOazqOmUgOerr+eCuVxuICAgIHNlcnZpY2UudW5yZWdpc3RlckVuZHBvaW50KCd0ZXN0LWVuZHBvaW50LXRvLXJlbW92ZScpXG5cbiAgICAvLyDnoa7orqTnq6/ngrnlt7Lnp7vpmaRcbiAgICBlbmRwb2ludHMgPSBzZXJ2aWNlLmdldEF2YWlsYWJsZUVuZHBvaW50cygndGVzdC1zZXJ2aWNlJylcbiAgICBleHBlY3QoZW5kcG9pbnRzLnNvbWUoKGVwKSA9PiBlcC5pZCA9PT0gJ3Rlc3QtZW5kcG9pbnQtdG8tcmVtb3ZlJykpLnRvQmUoZmFsc2UpXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveiwg+eUqEFJ55Sf5oiQ5bel5YW377yI5qih5ouf77yJJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHByb21wdCA9ICflhpnkuIDkuKrnroDnn63nmoTmlYXkuosnXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIG1vZGVsOiAnZ3B0LTQnLFxuICAgICAgdGVtcGVyYXR1cmU6IDAuNyxcbiAgICAgIG1heFRva2VuczogNTAwLFxuICAgIH1cblxuICAgIC8vIOeUseS6juayoeacieWunumZheeahEFJ5pyN5Yqh77yM6L+Z5Y+v6IO95Lya5aSx6LSl5oiW6L+U5Zue5qih5ouf57uT5p6cXG4gICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuY2FsbEFJR2VuZXJhdGlvblRvb2wocHJvbXB0LCBvcHRpb25zKSkucmVqZWN0cy50b1Rocm93KClcbiAgfSlcblxuICBpdCgn5bqU6K+l6IO96LCD55So5YiG5p6Q5bel5YW377yI5qih5ouf77yJJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGNvbnRlbnQgPSAn6L+Z5piv5LiA5Liq5rWL6K+V5paH5pysJ1xuICAgIGNvbnN0IGFuYWx5c2lzVHlwZSA9ICdzZW50aW1lbnQnXG5cbiAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5jYWxsQW5hbHlzaXNUb29sKGNvbnRlbnQsIGFuYWx5c2lzVHlwZSkpLnJlamVjdHMudG9UaHJvdygpXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveiwg+eUqOe/u+ivkeW3peWFt++8iOaooeaLn++8iScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB0ZXh0ID0gJ0hlbGxvIHdvcmxkJ1xuICAgIGNvbnN0IHRhcmdldExhbmd1YWdlID0gJ3poLUNOJ1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5jYWxsVHJhbnNsYXRpb25Ub29sKHRleHQsIHRhcmdldExhbmd1YWdlKVxuICAgIC8vIOW9k+WJjeWunueOsOWPr+iDvei/lOWbnuWOn+aWh+acrOaIluaooeaLn+e7k+aenFxuICAgIGV4cGVjdCh0eXBlb2YgcmVzdWx0KS50b0JlKCdzdHJpbmcnKVxuICB9KVxuXG4gIGl0KCflupTor6Xog73miafooYzorrDlv4bmk43kvZzvvIjmqKHmi5/vvIknLCBhc3luYyAoKSA9PiB7XG4gICAgLy8g6L+Z5Lqb5pON5L2c5Y+v6IO95Lya5aSx6LSl77yM5Zug5Li65rKh5pyJ5a6e6ZmF55qE5ZCO56uv5pyN5YqhXG4gICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UucmVhZE1lbW9yeSgndGVzdC1rZXknKSkucmVqZWN0cy50b1Rocm93KClcbiAgICBhd2FpdCBleHBlY3Qoc2VydmljZS53cml0ZU1lbW9yeSgndGVzdC1rZXknLCAndGVzdC12YWx1ZScpKS5yZWplY3RzLnRvVGhyb3coKVxuICB9KVxuXG4gIGl0KCflupTor6Xog73miafooYzmlofku7bmk43kvZzvvIjmqKHmi5/vvIknLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgZmlsZURhdGEgPSB7IGNvbnRlbnQ6ICd0ZXN0IGZpbGUgY29udGVudCcgfVxuXG4gICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UudXBsb2FkRmlsZShmaWxlRGF0YSkpLnJlamVjdHMudG9UaHJvdygpXG4gICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuZG93bmxvYWRGaWxlKCd0ZXN0LWZpbGUtaWQnKSkucmVqZWN0cy50b1Rocm93KClcbiAgfSlcblxuICBpdCgn5bqU6K+l6IO95Y+R6YCB5Y+Z5LqL55Sf5oiQ6K+35rGC77yI5qih5ouf77yJJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHN0b3J5SWQgPSAndGVzdC1zdG9yeS0xMjMnXG4gICAgY29uc3QgcHJvbXB0ID0gJ+WGmeS4gOS4quenkeW5u+aVheS6iydcbiAgICBjb25zdCBjb250ZXh0ID0geyBnZW5yZTogJ3NjaS1maScsIGxlbmd0aDogJ3Nob3J0JyB9XG5cbiAgICBjb25zdCB0YXNrSWQgPSBhd2FpdCBzZXJ2aWNlLnJlcXVlc3ROYXJyYXRpdmVHZW5lcmF0aW9uKHN0b3J5SWQsIHByb21wdCwgY29udGV4dClcbiAgICBleHBlY3QodHlwZW9mIHRhc2tJZCkudG9CZSgnc3RyaW5nJylcbiAgICBleHBlY3QodGFza0lkLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveWPkemAgUFnZW505Y2P5L2c6K+35rGC77yI5qih5ouf77yJJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGNvbGxhYm9yYXRpb25JZCA9ICd0ZXN0LWNvbGxhYi0xMjMnXG4gICAgY29uc3QgYWdlbnRJZHMgPSBbJ2FnZW50MScsICdhZ2VudDInXVxuICAgIGNvbnN0IHRhc2sgPSB7IHR5cGU6ICdzdG9yeS13cml0aW5nJywgcHJpb3JpdHk6ICdoaWdoJyB9XG5cbiAgICBjb25zdCByZXN1bHRJZCA9IGF3YWl0IHNlcnZpY2UucmVxdWVzdEFnZW50Q29sbGFib3JhdGlvbihjb2xsYWJvcmF0aW9uSWQsIGFnZW50SWRzLCB0YXNrKVxuICAgIGV4cGVjdCh0eXBlb2YgcmVzdWx0SWQpLnRvQmUoJ3N0cmluZycpXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveW5v+aSreezu+e7n+S6i+S7tu+8iOaooeaLn++8iScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBldmVudFR5cGUgPSAnc3lzdGVtLm1haW50ZW5hbmNlJ1xuICAgIGNvbnN0IGV2ZW50RGF0YSA9IHsgbWVzc2FnZTogJ1N5c3RlbSBtYWludGVuYW5jZSBzY2hlZHVsZWQnLCB0aW1lOiAnMjAyNC0wMS0wMVQwMDowMDowMFonIH1cblxuICAgIC8vIOS4jeW6lOivpeaKm+WHuumUmeivr1xuICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLmJyb2FkY2FzdFN5c3RlbUV2ZW50KGV2ZW50VHlwZSwgZXZlbnREYXRhKSkucmVzb2x2ZXMubm90LnRvVGhyb3coKVxuICB9KVxuXG4gIGl0KCflupTor6Xog73muIXnkIbov4fmnJ/ku7vliqEnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8g5LiN5bqU6K+l5oqb5Ye66ZSZ6K+vXG4gICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuY2xlYW51cEV4cGlyZWRUYXNrcygpKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpXG4gIH0pXG59KVxuIl0sInZlcnNpb24iOjN9