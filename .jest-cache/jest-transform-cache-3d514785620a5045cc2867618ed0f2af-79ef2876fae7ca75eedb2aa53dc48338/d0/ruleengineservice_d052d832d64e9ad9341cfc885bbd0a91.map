{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\rule-engine.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\rule-engine.service.ts"],"sourcesContent":["// 文件路径: apps/logic-agent/src/rule-engine.service.ts (已修复 unknown 类型)\n\nimport {\n  BadRequestException,\n  Injectable,\n  InternalServerErrorException,\n  Logger,\n} from '@nestjs/common'\nimport type { Prisma } from '@prisma/client'\nimport { getErrorMessage } from '@tuheg/common-backend'\n\nimport type {\n  CharacterUpdate,\n  DirectiveSet,\n  NumericOperation,\n  PrismaService,\n  StateChangeDirective,\n  StringOperation,\n} from '@tuheg/common-backend'\n\n@Injectable()\nexport class RuleEngineService {\n  private readonly logger = new Logger(RuleEngineService.name)\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  public async execute(gameId: string, directives: DirectiveSet): Promise<void> {\n    if (!directives || directives.length === 0) {\n      this.logger.warn(`RuleEngine executed with an empty directive set for game ${gameId}.`)\n      return\n    }\n\n    // [安全修复] 在执行指令前进行业务规则验证\n    this.validateDirectives(directives)\n\n    try {\n      await this.prisma.$transaction(async (tx) => {\n        const transactionClient = tx as Prisma.TransactionClient\n\n        for (const directive of directives) {\n          if (directive.op === 'update_character') {\n            await this.handleUpdateCharacter(transactionClient, gameId, directive)\n          } else {\n            throw new BadRequestException(`Unknown directive operation: ${directive.op}`)\n          }\n        }\n      })\n\n      this.logger.log(`Successfully executed ${directives.length} directives for game ${gameId}.`)\n    } catch (error: unknown) {\n      // <-- [核心修正] 明确 error 类型为 unknown\n      // 如果是BadRequestException，直接重新抛出\n      if (error instanceof BadRequestException) {\n        throw error\n      }\n\n      const errorMessage = error instanceof Error ? error instanceof Error ? error instanceof Error ? error.message : String(error) : String(error) : 'Unknown database error'\n      this.logger.error(\n        `Transaction failed during rule execution for game ${gameId}`,\n        error instanceof Error ? error.stack : error\n      )\n      throw new InternalServerErrorException(`Rule engine transaction failed: ${errorMessage}`)\n    }\n  }\n\n  private async handleUpdateCharacter(\n    tx: Prisma.TransactionClient,\n    gameId: string,\n    directive: StateChangeDirective\n  ) {\n    const character = await tx.character.findUniqueOrThrow({\n      where: { gameId },\n    })\n    const payload = directive.payload as CharacterUpdate\n    const updates: Prisma.CharacterUpdateInput = {}\n\n    if (payload.hp) {\n      updates.hp = this.applyNumericOperation(character.hp, payload.hp)\n    }\n    if (payload.mp) {\n      updates.mp = this.applyNumericOperation(character.mp, payload.mp)\n    }\n    if (payload.status) {\n      updates.status = this.applyStringOperation(character.status, payload.status)\n    }\n\n    if (Object.keys(updates).length > 0) {\n      await tx.character.update({ where: { gameId }, data: updates })\n    }\n  }\n\n  private applyNumericOperation(currentValue: number, op: NumericOperation): number {\n    switch (op.op) {\n      case 'set':\n        return op.value\n      case 'increment':\n        return currentValue + op.value\n      case 'decrement':\n        return currentValue - op.value\n    }\n  }\n\n  private applyStringOperation(currentValue: string, op: StringOperation): string {\n    switch (op.op) {\n      case 'set':\n        return op.value\n      case 'append':\n        return currentValue + op.value\n      case 'prepend':\n        return op.value + currentValue\n    }\n  }\n\n  /**\n   * [安全修复] 验证指令集中的业务规则\n   * 防止AI生成恶意或不合理的状态变更\n   */\n  private validateDirectives(directives: DirectiveSet): void {\n    for (const directive of directives) {\n      if (directive.op === 'update_character') {\n        this.validateCharacterUpdate(directive.payload as CharacterUpdate)\n      }\n      // 可以在这里添加其他操作类型的验证\n    }\n  }\n\n  /**\n   * [安全修复] 验证角色更新指令的业务规则\n   */\n  private validateCharacterUpdate(payload: CharacterUpdate): void {\n    // HP验证：不能为负数，且单次操作不能超过合理范围\n    if (payload.hp) {\n      this.validateNumericOperation(payload.hp, 'HP', -1000, 1000)\n    }\n\n    // MP验证：不能为负数，且单次操作不能超过合理范围\n    if (payload.mp) {\n      this.validateNumericOperation(payload.mp, 'MP', -1000, 1000)\n    }\n\n    // 状态字符串验证：长度限制，防止注入攻击\n    if (payload.status) {\n      this.validateStringOperation(payload.status, 'status', 500)\n    }\n  }\n\n  /**\n   * [安全修复] 验证数值操作的业务规则\n   */\n  private validateNumericOperation(\n    op: NumericOperation,\n    fieldName: string,\n    minValue: number,\n    maxValue: number\n  ): void {\n    // 检查操作值是否在合理范围内\n    if (op.value < minValue || op.value > maxValue) {\n      throw new BadRequestException(\n        `${fieldName} operation value ${op.value} is outside allowed range [${minValue}, ${maxValue}]`\n      )\n    }\n\n    // 对于set操作，检查是否会导致无效状态\n    if (op.op === 'set' && op.value < 0) {\n      throw new BadRequestException(`${fieldName} cannot be set to negative value: ${op.value}`)\n    }\n  }\n\n  /**\n   * [安全修复] 验证字符串操作的业务规则\n   */\n  private validateStringOperation(op: StringOperation, fieldName: string, maxLength: number): void {\n    // 检查字符串长度是否超过限制\n    if (op.value.length > maxLength) {\n      throw new BadRequestException(\n        `${fieldName} value is too long: ${op.value.length} characters (max: ${maxLength})`\n      )\n    }\n\n    // 检查是否包含潜在的恶意内容（基础检查）\n    const suspiciousPatterns = [\n      /<script/i,\n      /javascript:/i,\n      /on\\w+\\s*=/i,\n      /<iframe/i,\n      /<object/i,\n      /<embed/i,\n    ]\n\n    for (const pattern of suspiciousPatterns) {\n      if (pattern.test(op.value)) {\n        throw new BadRequestException(\n          `${fieldName} contains potentially malicious content: ${op.value.substring(0, 50)}...`\n        )\n      }\n    }\n  }\n}\n"],"version":3}