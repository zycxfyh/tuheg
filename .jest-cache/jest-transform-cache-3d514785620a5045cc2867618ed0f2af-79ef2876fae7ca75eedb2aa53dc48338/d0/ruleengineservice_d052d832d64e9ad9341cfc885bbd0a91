8e63172c25a6e33e68310ee7607dad1a
"use strict";
// 文件路径: apps/logic-agent/src/rule-engine.service.ts (已修复 unknown 类型)
var __esDecorate = (this && this.__esDecorate) || function (ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {
    function accept(f) { if (f !== void 0 && typeof f !== "function") throw new TypeError("Function expected"); return f; }
    var kind = contextIn.kind, key = kind === "getter" ? "get" : kind === "setter" ? "set" : "value";
    var target = !descriptorIn && ctor ? contextIn["static"] ? ctor : ctor.prototype : null;
    var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});
    var _, done = false;
    for (var i = decorators.length - 1; i >= 0; i--) {
        var context = {};
        for (var p in contextIn) context[p] = p === "access" ? {} : contextIn[p];
        for (var p in contextIn.access) context.access[p] = contextIn.access[p];
        context.addInitializer = function (f) { if (done) throw new TypeError("Cannot add initializers after decoration has completed"); extraInitializers.push(accept(f || null)); };
        var result = (0, decorators[i])(kind === "accessor" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);
        if (kind === "accessor") {
            if (result === void 0) continue;
            if (result === null || typeof result !== "object") throw new TypeError("Object expected");
            if (_ = accept(result.get)) descriptor.get = _;
            if (_ = accept(result.set)) descriptor.set = _;
            if (_ = accept(result.init)) initializers.unshift(_);
        }
        else if (_ = accept(result)) {
            if (kind === "field") initializers.unshift(_);
            else descriptor[key] = _;
        }
    }
    if (target) Object.defineProperty(target, contextIn.name, descriptor);
    done = true;
};
var __runInitializers = (this && this.__runInitializers) || function (thisArg, initializers, value) {
    var useValue = arguments.length > 2;
    for (var i = 0; i < initializers.length; i++) {
        value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);
    }
    return useValue ? value : void 0;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RuleEngineService = void 0;
const common_1 = require("@nestjs/common");
let RuleEngineService = (() => {
    let _classDecorators = [(0, common_1.Injectable)()];
    let _classDescriptor;
    let _classExtraInitializers = [];
    let _classThis;
    var RuleEngineService = class {
        static { _classThis = this; }
        static {
            const _metadata = typeof Symbol === "function" && Symbol.metadata ? Object.create(null) : void 0;
            __esDecorate(null, _classDescriptor = { value: _classThis }, _classDecorators, { kind: "class", name: _classThis.name, metadata: _metadata }, null, _classExtraInitializers);
            RuleEngineService = _classThis = _classDescriptor.value;
            if (_metadata) Object.defineProperty(_classThis, Symbol.metadata, { enumerable: true, configurable: true, writable: true, value: _metadata });
            __runInitializers(_classThis, _classExtraInitializers);
        }
        prisma;
        logger = new common_1.Logger(RuleEngineService.name);
        constructor(prisma) {
            this.prisma = prisma;
        }
        async execute(gameId, directives) {
            if (!directives || directives.length === 0) {
                this.logger.warn(`RuleEngine executed with an empty directive set for game ${gameId}.`);
                return;
            }
            // [安全修复] 在执行指令前进行业务规则验证
            this.validateDirectives(directives);
            try {
                await this.prisma.$transaction(async (tx) => {
                    const transactionClient = tx;
                    for (const directive of directives) {
                        if (directive.op === 'update_character') {
                            await this.handleUpdateCharacter(transactionClient, gameId, directive);
                        }
                        else {
                            throw new common_1.BadRequestException(`Unknown directive operation: ${directive.op}`);
                        }
                    }
                });
                this.logger.log(`Successfully executed ${directives.length} directives for game ${gameId}.`);
            }
            catch (error) {
                // <-- [核心修正] 明确 error 类型为 unknown
                // 如果是BadRequestException，直接重新抛出
                if (error instanceof common_1.BadRequestException) {
                    throw error;
                }
                const errorMessage = error instanceof Error ? error instanceof Error ? error instanceof Error ? error.message : String(error) : String(error) : 'Unknown database error';
                this.logger.error(`Transaction failed during rule execution for game ${gameId}`, error instanceof Error ? error.stack : error);
                throw new common_1.InternalServerErrorException(`Rule engine transaction failed: ${errorMessage}`);
            }
        }
        async handleUpdateCharacter(tx, gameId, directive) {
            const character = await tx.character.findUniqueOrThrow({
                where: { gameId },
            });
            const payload = directive.payload;
            const updates = {};
            if (payload.hp) {
                updates.hp = this.applyNumericOperation(character.hp, payload.hp);
            }
            if (payload.mp) {
                updates.mp = this.applyNumericOperation(character.mp, payload.mp);
            }
            if (payload.status) {
                updates.status = this.applyStringOperation(character.status, payload.status);
            }
            if (Object.keys(updates).length > 0) {
                await tx.character.update({ where: { gameId }, data: updates });
            }
        }
        applyNumericOperation(currentValue, op) {
            switch (op.op) {
                case 'set':
                    return op.value;
                case 'increment':
                    return currentValue + op.value;
                case 'decrement':
                    return currentValue - op.value;
            }
        }
        applyStringOperation(currentValue, op) {
            switch (op.op) {
                case 'set':
                    return op.value;
                case 'append':
                    return currentValue + op.value;
                case 'prepend':
                    return op.value + currentValue;
            }
        }
        /**
         * [安全修复] 验证指令集中的业务规则
         * 防止AI生成恶意或不合理的状态变更
         */
        validateDirectives(directives) {
            for (const directive of directives) {
                if (directive.op === 'update_character') {
                    this.validateCharacterUpdate(directive.payload);
                }
                // 可以在这里添加其他操作类型的验证
            }
        }
        /**
         * [安全修复] 验证角色更新指令的业务规则
         */
        validateCharacterUpdate(payload) {
            // HP验证：不能为负数，且单次操作不能超过合理范围
            if (payload.hp) {
                this.validateNumericOperation(payload.hp, 'HP', -1000, 1000);
            }
            // MP验证：不能为负数，且单次操作不能超过合理范围
            if (payload.mp) {
                this.validateNumericOperation(payload.mp, 'MP', -1000, 1000);
            }
            // 状态字符串验证：长度限制，防止注入攻击
            if (payload.status) {
                this.validateStringOperation(payload.status, 'status', 500);
            }
        }
        /**
         * [安全修复] 验证数值操作的业务规则
         */
        validateNumericOperation(op, fieldName, minValue, maxValue) {
            // 检查操作值是否在合理范围内
            if (op.value < minValue || op.value > maxValue) {
                throw new common_1.BadRequestException(`${fieldName} operation value ${op.value} is outside allowed range [${minValue}, ${maxValue}]`);
            }
            // 对于set操作，检查是否会导致无效状态
            if (op.op === 'set' && op.value < 0) {
                throw new common_1.BadRequestException(`${fieldName} cannot be set to negative value: ${op.value}`);
            }
        }
        /**
         * [安全修复] 验证字符串操作的业务规则
         */
        validateStringOperation(op, fieldName, maxLength) {
            // 检查字符串长度是否超过限制
            if (op.value.length > maxLength) {
                throw new common_1.BadRequestException(`${fieldName} value is too long: ${op.value.length} characters (max: ${maxLength})`);
            }
            // 检查是否包含潜在的恶意内容（基础检查）
            const suspiciousPatterns = [
                /<script/i,
                /javascript:/i,
                /on\w+\s*=/i,
                /<iframe/i,
                /<object/i,
                /<embed/i,
            ];
            for (const pattern of suspiciousPatterns) {
                if (pattern.test(op.value)) {
                    throw new common_1.BadRequestException(`${fieldName} contains potentially malicious content: ${op.value.substring(0, 50)}...`);
                }
            }
        }
    };
    return RuleEngineService = _classThis;
})();
exports.RuleEngineService = RuleEngineService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXHJ1bGUtZW5naW5lLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHFFQUFxRTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVyRSwyQ0FLdUI7SUFjVixpQkFBaUI7NEJBRDdCLElBQUEsbUJBQVUsR0FBRTs7Ozs7Ozs7WUFDYiw2S0FnTEM7OztZQWhMWSx1REFBaUI7O1FBR0MsTUFBTTtRQUZsQixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFNUQsWUFBNkIsTUFBcUI7WUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUFHLENBQUM7UUFFL0MsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFjLEVBQUUsVUFBd0I7WUFDM0QsSUFBSSxDQUFDLFVBQVUsSUFBSSxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUMzQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyw0REFBNEQsTUFBTSxHQUFHLENBQUMsQ0FBQTtnQkFDdkYsT0FBTTtZQUNSLENBQUM7WUFFRCx3QkFBd0I7WUFDeEIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBRW5DLElBQUksQ0FBQztnQkFDSCxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRTtvQkFDMUMsTUFBTSxpQkFBaUIsR0FBRyxFQUE4QixDQUFBO29CQUV4RCxLQUFLLE1BQU0sU0FBUyxJQUFJLFVBQVUsRUFBRSxDQUFDO3dCQUNuQyxJQUFJLFNBQVMsQ0FBQyxFQUFFLEtBQUssa0JBQWtCLEVBQUUsQ0FBQzs0QkFDeEMsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFBO3dCQUN4RSxDQUFDOzZCQUFNLENB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VixVQUFVO2dCQUNWLFNBQVM7YUFDVixDQUFBO1lBRUQsS0FBSyxNQUFNLE9BQU8sSUFBSSxrQkFBa0IsRUFBRSxDQUFDO2dCQUN6QyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7b0JBQzNCLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsR0FBRyxTQUFTLDRDQUE0QyxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FDdkYsQ0FBQTtnQkFDSCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7Ozs7QUEvS1UsOENBQWlCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxhcHBzXFxsb2dpYy1hZ2VudFxcc3JjXFxydWxlLWVuZ2luZS5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogYXBwcy9sb2dpYy1hZ2VudC9zcmMvcnVsZS1lbmdpbmUuc2VydmljZS50cyAo5bey5L+u5aSNIHVua25vd24g57G75Z6LKVxuXG5pbXBvcnQge1xuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBJbmplY3RhYmxlLFxuICBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uLFxuICBMb2dnZXIsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJ1xuaW1wb3J0IHR5cGUgeyBQcmlzbWEgfSBmcm9tICdAcHJpc21hL2NsaWVudCdcbmltcG9ydCB7IGdldEVycm9yTWVzc2FnZSB9IGZyb20gJ0B0dWhlZy9jb21tb24tYmFja2VuZCdcblxuaW1wb3J0IHR5cGUge1xuICBDaGFyYWN0ZXJVcGRhdGUsXG4gIERpcmVjdGl2ZVNldCxcbiAgTnVtZXJpY09wZXJhdGlvbixcbiAgUHJpc21hU2VydmljZSxcbiAgU3RhdGVDaGFuZ2VEaXJlY3RpdmUsXG4gIFN0cmluZ09wZXJhdGlvbixcbn0gZnJvbSAnQHR1aGVnL2NvbW1vbi1iYWNrZW5kJ1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUnVsZUVuZ2luZVNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoUnVsZUVuZ2luZVNlcnZpY2UubmFtZSlcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSkge31cblxuICBwdWJsaWMgYXN5bmMgZXhlY3V0ZShnYW1lSWQ6IHN0cmluZywgZGlyZWN0aXZlczogRGlyZWN0aXZlU2V0KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFkaXJlY3RpdmVzIHx8IGRpcmVjdGl2ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKGBSdWxlRW5naW5lIGV4ZWN1dGVkIHdpdGggYW4gZW1wdHkgZGlyZWN0aXZlIHNldCBmb3IgZ2FtZSAke2dhbWVJZH0uYClcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIC8vIFvlronlhajkv67lpI1dIOWcqOaJp+ihjOaMh+S7pOWJjei/m+ihjOS4muWKoeinhOWImemqjOivgVxuICAgIHRoaXMudmFsaWRhdGVEaXJlY3RpdmVzKGRpcmVjdGl2ZXMpXG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEuJHRyYW5zYWN0aW9uKGFzeW5jICh0eCkgPT4ge1xuICAgICAgICBjb25zdCB0cmFuc2FjdGlvbkNsaWVudCA9IHR4IGFzIFByaXNtYS5UcmFuc2FjdGlvbkNsaWVudFxuXG4gICAgICAgIGZvciAoY29uc3QgZGlyZWN0aXZlIG9mIGRpcmVjdGl2ZXMpIHtcbiAgICAgICAgICBpZiAoZGlyZWN0aXZlLm9wID09PSAndXBkYXRlX2NoYXJhY3RlcicpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlVXBkYXRlQ2hhcmFjdGVyKHRyYW5zYWN0aW9uQ2xpZW50LCBnYW1lSWQsIGRpcmVjdGl2ZSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oYFVua25vd24gZGlyZWN0aXZlIG9wZXJhdGlvbjogJHtkaXJlY3RpdmUub3B9YClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgU3VjY2Vzc2Z1bGx5IGV4ZWN1dGVkICR7ZGlyZWN0aXZlcy5sZW5ndGh9IGRpcmVjdGl2ZXMgZm9yIGdhbWUgJHtnYW1lSWR9LmApXG4gICAgfSBjYXRjaCAoZXJyb3I6IHVua25vd24pIHtcbiAgICAgIC8vIDwtLSBb5qC45b+D5L+u5q2jXSDmmI7noa4gZXJyb3Ig57G75Z6L5Li6IHVua25vd25cbiAgICAgIC8vIOWmguaenOaYr0JhZFJlcXVlc3RFeGNlcHRpb27vvIznm7TmjqXph43mlrDmipvlh7pcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEJhZFJlcXVlc3RFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3JcbiAgICAgIH1cblxuICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcikgOiBTdHJpbmcoZXJyb3IpIDogJ1Vua25vd24gZGF0YWJhc2UgZXJyb3InXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYFRyYW5zYWN0aW9uIGZhaWxlZCBkdXJpbmcgcnVsZSBleGVjdXRpb24gZm9yIGdhbWUgJHtnYW1lSWR9YCxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogZXJyb3JcbiAgICAgIClcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKGBSdWxlIGVuZ2luZSB0cmFuc2FjdGlvbiBmYWlsZWQ6ICR7ZXJyb3JNZXNzYWdlfWApXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBoYW5kbGVVcGRhdGVDaGFyYWN0ZXIoXG4gICAgdHg6IFByaXNtYS5UcmFuc2FjdGlvbkNsaWVudCxcbiAgICBnYW1lSWQ6IHN0cmluZyxcbiAgICBkaXJlY3RpdmU6IFN0YXRlQ2hhbmdlRGlyZWN0aXZlXG4gICkge1xuICAgIGNvbnN0IGNoYXJhY3RlciA9IGF3YWl0IHR4LmNoYXJhY3Rlci5maW5kVW5pcXVlT3JUaHJvdyh7XG4gICAgICB3aGVyZTogeyBnYW1lSWQgfSxcbiAgICB9KVxuICAgIGNvbnN0IHBheWxvYWQgPSBkaXJlY3RpdmUucGF5bG9hZCBhcyBDaGFyYWN0ZXJVcGRhdGVcbiAgICBjb25zdCB1cGRhdGVzOiBQcmlzbWEuQ2hhcmFjdGVyVXBkYXRlSW5wdXQgPSB7fVxuXG4gICAgaWYgKHBheWxvYWQuaHApIHtcbiAgICAgIHVwZGF0ZXMuaHAgPSB0aGlzLmFwcGx5TnVtZXJpY09wZXJhdGlvbihjaGFyYWN0ZXIuaHAsIHBheWxvYWQuaHApXG4gICAgfVxuICAgIGlmIChwYXlsb2FkLm1wKSB7XG4gICAgICB1cGRhdGVzLm1wID0gdGhpcy5hcHBseU51bWVyaWNPcGVyYXRpb24oY2hhcmFjdGVyLm1wLCBwYXlsb2FkLm1wKVxuICAgIH1cbiAgICBpZiAocGF5bG9hZC5zdGF0dXMpIHtcbiAgICAgIHVwZGF0ZXMuc3RhdHVzID0gdGhpcy5hcHBseVN0cmluZ09wZXJhdGlvbihjaGFyYWN0ZXIuc3RhdHVzLCBwYXlsb2FkLnN0YXR1cylcbiAgICB9XG5cbiAgICBpZiAoT2JqZWN0LmtleXModXBkYXRlcykubGVuZ3RoID4gMCkge1xuICAgICAgYXdhaXQgdHguY2hhcmFjdGVyLnVwZGF0ZSh7IHdoZXJlOiB7IGdhbWVJZCB9LCBkYXRhOiB1cGRhdGVzIH0pXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhcHBseU51bWVyaWNPcGVyYXRpb24oY3VycmVudFZhbHVlOiBudW1iZXIsIG9wOiBOdW1lcmljT3BlcmF0aW9uKTogbnVtYmVyIHtcbiAgICBzd2l0Y2ggKG9wLm9wKSB7XG4gICAgICBjYXNlICdzZXQnOlxuICAgICAgICByZXR1cm4gb3AudmFsdWVcbiAgICAgIGNhc2UgJ2luY3JlbWVudCc6XG4gICAgICAgIHJldHVybiBjdXJyZW50VmFsdWUgKyBvcC52YWx1ZVxuICAgICAgY2FzZSAnZGVjcmVtZW50JzpcbiAgICAgICAgcmV0dXJuIGN1cnJlbnRWYWx1ZSAtIG9wLnZhbHVlXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhcHBseVN0cmluZ09wZXJhdGlvbihjdXJyZW50VmFsdWU6IHN0cmluZywgb3A6IFN0cmluZ09wZXJhdGlvbik6IHN0cmluZyB7XG4gICAgc3dpdGNoIChvcC5vcCkge1xuICAgICAgY2FzZSAnc2V0JzpcbiAgICAgICAgcmV0dXJuIG9wLnZhbHVlXG4gICAgICBjYXNlICdhcHBlbmQnOlxuICAgICAgICByZXR1cm4gY3VycmVudFZhbHVlICsgb3AudmFsdWVcbiAgICAgIGNhc2UgJ3ByZXBlbmQnOlxuICAgICAgICByZXR1cm4gb3AudmFsdWUgKyBjdXJyZW50VmFsdWVcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogW+WuieWFqOS/ruWkjV0g6aqM6K+B5oyH5Luk6ZuG5Lit55qE5Lia5Yqh6KeE5YiZXG4gICAqIOmYsuatokFJ55Sf5oiQ5oG25oSP5oiW5LiN5ZCI55CG55qE54q25oCB5Y+Y5pu0XG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlRGlyZWN0aXZlcyhkaXJlY3RpdmVzOiBEaXJlY3RpdmVTZXQpOiB2b2lkIHtcbiAgICBmb3IgKGNvbnN0IGRpcmVjdGl2ZSBvZiBkaXJlY3RpdmVzKSB7XG4gICAgICBpZiAoZGlyZWN0aXZlLm9wID09PSAndXBkYXRlX2NoYXJhY3RlcicpIHtcbiAgICAgICAgdGhpcy52YWxpZGF0ZUNoYXJhY3RlclVwZGF0ZShkaXJlY3RpdmUucGF5bG9hZCBhcyBDaGFyYWN0ZXJVcGRhdGUpXG4gICAgICB9XG4gICAgICAvLyDlj6/ku6XlnKjov5nph4zmt7vliqDlhbbku5bmk43kvZznsbvlnovnmoTpqozor4FcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogW+WuieWFqOS/ruWkjV0g6aqM6K+B6KeS6Imy5pu05paw5oyH5Luk55qE5Lia5Yqh6KeE5YiZXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlQ2hhcmFjdGVyVXBkYXRlKHBheWxvYWQ6IENoYXJhY3RlclVwZGF0ZSk6IHZvaWQge1xuICAgIC8vIEhQ6aqM6K+B77ya5LiN6IO95Li66LSf5pWw77yM5LiU5Y2V5qyh5pON5L2c5LiN6IO96LaF6L+H5ZCI55CG6IyD5Zu0XG4gICAgaWYgKHBheWxvYWQuaHApIHtcbiAgICAgIHRoaXMudmFsaWRhdGVOdW1lcmljT3BlcmF0aW9uKHBheWxvYWQuaHAsICdIUCcsIC0xMDAwLCAxMDAwKVxuICAgIH1cblxuICAgIC8vIE1Q6aqM6K+B77ya5LiN6IO95Li66LSf5pWw77yM5LiU5Y2V5qyh5pON5L2c5LiN6IO96LaF6L+H5ZCI55CG6IyD5Zu0XG4gICAgaWYgKHBheWxvYWQubXApIHtcbiAgICAgIHRoaXMudmFsaWRhdGVOdW1lcmljT3BlcmF0aW9uKHBheWxvYWQubXAsICdNUCcsIC0xMDAwLCAxMDAwKVxuICAgIH1cblxuICAgIC8vIOeKtuaAgeWtl+espuS4sumqjOivge+8mumVv+W6pumZkOWItu+8jOmYsuatouazqOWFpeaUu+WHu1xuICAgIGlmIChwYXlsb2FkLnN0YXR1cykge1xuICAgICAgdGhpcy52YWxpZGF0ZVN0cmluZ09wZXJhdGlvbihwYXlsb2FkLnN0YXR1cywgJ3N0YXR1cycsIDUwMClcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogW+WuieWFqOS/ruWkjV0g6aqM6K+B5pWw5YC85pON5L2c55qE5Lia5Yqh6KeE5YiZXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlTnVtZXJpY09wZXJhdGlvbihcbiAgICBvcDogTnVtZXJpY09wZXJhdGlvbixcbiAgICBmaWVsZE5hbWU6IHN0cmluZyxcbiAgICBtaW5WYWx1ZTogbnVtYmVyLFxuICAgIG1heFZhbHVlOiBudW1iZXJcbiAgKTogdm9pZCB7XG4gICAgLy8g5qOA5p+l5pON5L2c5YC85piv5ZCm5Zyo5ZCI55CG6IyD5Zu05YaFXG4gICAgaWYgKG9wLnZhbHVlIDwgbWluVmFsdWUgfHwgb3AudmFsdWUgPiBtYXhWYWx1ZSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGAke2ZpZWxkTmFtZX0gb3BlcmF0aW9uIHZhbHVlICR7b3AudmFsdWV9IGlzIG91dHNpZGUgYWxsb3dlZCByYW5nZSBbJHttaW5WYWx1ZX0sICR7bWF4VmFsdWV9XWBcbiAgICAgIClcbiAgICB9XG5cbiAgICAvLyDlr7nkuo5zZXTmk43kvZzvvIzmo4Dmn6XmmK/lkKbkvJrlr7zoh7Tml6DmlYjnirbmgIFcbiAgICBpZiAob3Aub3AgPT09ICdzZXQnICYmIG9wLnZhbHVlIDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oYCR7ZmllbGROYW1lfSBjYW5ub3QgYmUgc2V0IHRvIG5lZ2F0aXZlIHZhbHVlOiAke29wLnZhbHVlfWApXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFvlronlhajkv67lpI1dIOmqjOivgeWtl+espuS4suaTjeS9nOeahOS4muWKoeinhOWImVxuICAgKi9cbiAgcHJpdmF0ZSB2YWxpZGF0ZVN0cmluZ09wZXJhdGlvbihvcDogU3RyaW5nT3BlcmF0aW9uLCBmaWVsZE5hbWU6IHN0cmluZywgbWF4TGVuZ3RoOiBudW1iZXIpOiB2b2lkIHtcbiAgICAvLyDmo4Dmn6XlrZfnrKbkuLLplb/luqbmmK/lkKbotoXov4fpmZDliLZcbiAgICBpZiAob3AudmFsdWUubGVuZ3RoID4gbWF4TGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgYCR7ZmllbGROYW1lfSB2YWx1ZSBpcyB0b28gbG9uZzogJHtvcC52YWx1ZS5sZW5ndGh9IGNoYXJhY3RlcnMgKG1heDogJHttYXhMZW5ndGh9KWBcbiAgICAgIClcbiAgICB9XG5cbiAgICAvLyDmo4Dmn6XmmK/lkKbljIXlkKvmvZzlnKjnmoTmgbbmhI/lhoXlrrnvvIjln7rnoYDmo4Dmn6XvvIlcbiAgICBjb25zdCBzdXNwaWNpb3VzUGF0dGVybnMgPSBbXG4gICAgICAvPHNjcmlwdC9pLFxuICAgICAgL2phdmFzY3JpcHQ6L2ksXG4gICAgICAvb25cXHcrXFxzKj0vaSxcbiAgICAgIC88aWZyYW1lL2ksXG4gICAgICAvPG9iamVjdC9pLFxuICAgICAgLzxlbWJlZC9pLFxuICAgIF1cblxuICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiBzdXNwaWNpb3VzUGF0dGVybnMpIHtcbiAgICAgIGlmIChwYXR0ZXJuLnRlc3Qob3AudmFsdWUpKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgIGAke2ZpZWxkTmFtZX0gY29udGFpbnMgcG90ZW50aWFsbHkgbWFsaWNpb3VzIGNvbnRlbnQ6ICR7b3AudmFsdWUuc3Vic3RyaW5nKDAsIDUwKX0uLi5gXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==