90cd28647cedefdc668b8f2757d3b4c3
"use strict";
// ============================================================================
// WebSocket通信集成测试
// 验证 VCPToolBox WebSocket通信的正确集成
// ============================================================================
Object.defineProperty(exports, "__esModule", { value: true });
const config_1 = require("@nestjs/config");
const testing_1 = require("@nestjs/testing");
const websocket_service_1 = require("../../../../packages/common-backend/src/vcp/websocket.service");
describe('WebSocketService Integration', () => {
    let service;
    let configService;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                websocket_service_1.WebSocketService,
                {
                    provide: config_1.ConfigService,
                    useValue: {
                        get: jest.fn((key, defaultValue) => {
                            const config = {
                                WEBSOCKET_PORT: 8081, // 使用不同端口避免冲突
                                WEBSOCKET_HOST: 'localhost',
                                WEBSOCKET_HEARTBEAT_INTERVAL: 30000,
                                WEBSOCKET_CONNECTION_TIMEOUT: 300000,
                            };
                            return config[key] || defaultValue;
                        }),
                    },
                },
            ],
        }).compile();
        service = module.get(websocket_service_1.WebSocketService);
        configService = module.get(config_1.ConfigService);
    });
    afterEach(async () => {
        // 清理资源
        try {
            await service.onModuleDestroy();
        }
        catch (error) {
            // 忽略清理错误
        }
    });
    it('应该能获取WebSocket统计信息', () => {
        const stats = service.getWebSocketStats();
        expect(stats).toHaveProperty('status');
        // 在测试环境中服务器可能没有启动，所以状态可能是'stopped'
        expect(['running', 'stopped']).toContain(stats.status);
    });
    it('应该能执行健康检查', async () => {
        const health = await service.healthCheck();
        expect(health).toHaveProperty('status');
        expect(['healthy', 'error']).toContain(health.status);
        if (health.status === 'error') {
            expect(health).toHaveProperty('details');
        }
    });
    it('应该能处理Agent消息发送（模拟）', async () => {
        // 测试发送到不存在的Agent，应该返回false
        const result = await service.sendToAgent('non-existent-agent', {
            action: 'test',
            payload: { message: 'test' },
        });
        // 在没有实际WebSocket连接的情况下，应该返回false
        expect(result).toBe(false);
    });
    it('应该能处理广播消息（模拟）', async () => {
        const result = await service.broadcastToAgents({
            action: 'test-broadcast',
            payload: { message: 'broadcast test' },
        });
        // 在没有连接的情况下，广播应该影响0个客户端
        expect(result).toBe(0);
    });
    it('应该能处理协作房间操作（模拟）', async () => {
        const roomId = await service.createCollaborationRoom('test-story-123', ['agent1', 'agent2']);
        // 当前实现返回null
        expect(roomId).toBeNull();
        const joinResult = await service.joinCollaborationRoom('test-room', 'test-agent');
        expect(joinResult).toBe(true);
    });
    it('应该能处理实时编辑更新（模拟）', async () => {
        // 这应该不会抛出错误，即使没有实际的WebSocket连接
        await expect(service.sendRealtimeEdit('story-123', 'agent-456', {
            type: 'text',
            content: '新的内容',
            position: { line: 1, column: 10 },
        })).resolves.not.toThrow();
    });
    it('应该能处理AI生成进度（模拟）', async () => {
        await expect(service.sendGenerationProgress('story-123', 'agent-456', 75, 'generating')).resolves.not.toThrow();
    });
    it('应该能处理Agent协作状态（模拟）', async () => {
        await expect(service.sendAgentCollaborationStatus('story-123', {
            agents: ['agent1', 'agent2'],
            status: 'active',
            progress: 60,
        })).resolves.not.toThrow();
    });
    it('应该能获取活跃协作会话（模拟）', () => {
        const sessions = service.getActiveCollaborationSessions();
        expect(Array.isArray(sessions)).toBe(true);
        // 当前实现返回空数组
        expect(sessions).toHaveLength(0);
    });
    it('应该正确配置WebSocket参数', () => {
        expect(configService.get).toHaveBeenCalledWith('WEBSOCKET_PORT', 8080);
        expect(configService.get).toHaveBeenCalledWith('WEBSOCKET_HOST', 'localhost');
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXHZjcHRvb2xib3hcXHNyY1xcaW50ZWdyYXRpb24tdGVzdHNcXHdlYnNvY2tldC1pbnRlZ3JhdGlvbi50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQSwrRUFBK0U7QUFDL0Usa0JBQWtCO0FBQ2xCLGlDQUFpQztBQUNqQywrRUFBK0U7O0FBRS9FLDJDQUE4QztBQUM5Qyw2Q0FBMEQ7QUFDMUQscUdBQWdHO0FBRWhHLFFBQVEsQ0FBQyw4QkFBOEIsRUFBRSxHQUFHLEVBQUU7SUFDNUMsSUFBSSxPQUF5QixDQUFBO0lBQzdCLElBQUksYUFBNEIsQ0FBQTtJQUVoQyxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCxvQ0FBZ0I7Z0JBQ2hCO29CQUNFLE9BQU8sRUFBRSxzQkFBYTtvQkFDdEIsUUFBUSxFQUFFO3dCQUNSLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBVyxFQUFFLFlBQWtCLEVBQUUsRUFBRTs0QkFDL0MsTUFBTSxNQUFNLEdBQUc7Z0NBQ2IsY0FBYyxFQUFFLElBQUksRUFBRSxhQUFhO2dDQUNuQyxjQUFjLEVBQUUsV0FBVztnQ0FDM0IsNEJBQTRCLEVBQUUsS0FBSztnQ0FDbkMsNEJBQTRCLEVBQUUsTUFBTTs2QkFDckMsQ0FBQTs0QkFDRCxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxZQUFZLENBQUE7d0JBQ3BDLENBQUMsQ0FBQztxQkFDSDtpQkFDRjthQUNGO1NBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBRVosT0FBTyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQW1CLG9DQUFnQixDQUFDLENBQUE7UUFDeEQsYUFBYSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQWdCLHNCQUFhLENBQUMsQ0FBQTtJQUMxRCxDQUFDLENBQUMsQ0FBQTtJQUVG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QUU7UUFDM0IsTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUN0RSxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLGdCQUFnQixFQUFFLFdBQVcsQ0FBQyxDQUFBO0lBQy9FLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXHZjcHRvb2xib3hcXHNyY1xcaW50ZWdyYXRpb24tdGVzdHNcXHdlYnNvY2tldC1pbnRlZ3JhdGlvbi50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFdlYlNvY2tldOmAmuS/oembhuaIkOa1i+ivlVxuLy8g6aqM6K+BIFZDUFRvb2xCb3ggV2ViU29ja2V06YCa5L+h55qE5q2j56Gu6ZuG5oiQXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZydcbmltcG9ydCB7IFRlc3QsIHR5cGUgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZydcbmltcG9ydCB7IFdlYlNvY2tldFNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi8uLi9wYWNrYWdlcy9jb21tb24tYmFja2VuZC9zcmMvdmNwL3dlYnNvY2tldC5zZXJ2aWNlJ1xuXG5kZXNjcmliZSgnV2ViU29ja2V0U2VydmljZSBJbnRlZ3JhdGlvbicsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFdlYlNvY2tldFNlcnZpY2VcbiAgbGV0IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2VcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIFdlYlNvY2tldFNlcnZpY2UsXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBDb25maWdTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgICBnZXQ6IGplc3QuZm4oKGtleTogc3RyaW5nLCBkZWZhdWx0VmFsdWU/OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgY29uZmlnID0ge1xuICAgICAgICAgICAgICAgIFdFQlNPQ0tFVF9QT1JUOiA4MDgxLCAvLyDkvb/nlKjkuI3lkIznq6/lj6Ppgb/lhY3lhrLnqoFcbiAgICAgICAgICAgICAgICBXRUJTT0NLRVRfSE9TVDogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgICAgICAgV0VCU09DS0VUX0hFQVJUQkVBVF9JTlRFUlZBTDogMzAwMDAsXG4gICAgICAgICAgICAgICAgV0VCU09DS0VUX0NPTk5FQ1RJT05fVElNRU9VVDogMzAwMDAwLFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiBjb25maWdba2V5XSB8fCBkZWZhdWx0VmFsdWVcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKVxuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8V2ViU29ja2V0U2VydmljZT4oV2ViU29ja2V0U2VydmljZSlcbiAgICBjb25maWdTZXJ2aWNlID0gbW9kdWxlLmdldDxDb25maWdTZXJ2aWNlPihDb25maWdTZXJ2aWNlKVxuICB9KVxuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgLy8g5riF55CG6LWE5rqQXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IChzZXJ2aWNlIGFzIGFueSkub25Nb2R1bGVEZXN0cm95KClcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8g5b+955Wl5riF55CG6ZSZ6K+vXG4gICAgfVxuICB9KVxuXG4gIGl0KCflupTor6Xog73ojrflj5ZXZWJTb2NrZXTnu5/orqHkv6Hmga8nLCAoKSA9PiB7XG4gICAgY29uc3Qgc3RhdHMgPSBzZXJ2aWNlLmdldFdlYlNvY2tldFN0YXRzKClcblxuICAgIGV4cGVjdChzdGF0cykudG9IYXZlUHJvcGVydHkoJ3N0YXR1cycpXG4gICAgLy8g5Zyo5rWL6K+V546v5aKD5Lit5pyN5Yqh5Zmo5Y+v6IO95rKh5pyJ5ZCv5Yqo77yM5omA5Lul54q25oCB5Y+v6IO95pivJ3N0b3BwZWQnXG4gICAgZXhwZWN0KFsncnVubmluZycsICdzdG9wcGVkJ10pLnRvQ29udGFpbihzdGF0cy5zdGF0dXMpXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveaJp+ihjOWBpeW6t+ajgOafpScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBzZXJ2aWNlLmhlYWx0aENoZWNrKClcblxuICAgIGV4cGVjdChoZWFsdGgpLnRvSGF2ZVByb3BlcnR5KCdzdGF0dXMnKVxuICAgIGV4cGVjdChbJ2hlYWx0aHknLCAnZXJyb3InXSkudG9Db250YWluKGhlYWx0aC5zdGF0dXMpXG5cbiAgICBpZiAoaGVhbHRoLnN0YXR1cyA9PT0gJ2Vycm9yJykge1xuICAgICAgZXhwZWN0KGhlYWx0aCkudG9IYXZlUHJvcGVydHkoJ2RldGFpbHMnKVxuICAgIH1cbiAgfSlcblxuICBpdCgn5bqU6K+l6IO95aSE55CGQWdlbnTmtojmga/lj5HpgIHvvIjmqKHmi5/vvIknLCBhc3luYyAoKSA9PiB7XG4gICAgLy8g5rWL6K+V5Y+R6YCB5Yiw5LiN5a2Y5Zyo55qEQWdlbnTvvIzlupTor6Xov5Tlm55mYWxzZVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2Uuc2VuZFRvQWdlbnQoJ25vbi1leGlzdGVudC1hZ2VudCcsIHtcbiAgICAgIGFjdGlvbjogJ3Rlc3QnLFxuICAgICAgcGF5bG9hZDogeyBtZXNzYWdlOiAndGVzdCcgfSxcbiAgICB9KVxuXG4gICAgLy8g5Zyo5rKh5pyJ5a6e6ZmFV2ViU29ja2V06L+e5o6l55qE5oOF5Ya15LiL77yM5bqU6K+l6L+U5ZueZmFsc2VcbiAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKVxuICB9KVxuXG4gIGl0KCflupTor6Xog73lpITnkIblub/mkq3mtojmga/vvIjmqKHmi5/vvIknLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5icm9hZGNhc3RUb0FnZW50cyh7XG4gICAgICBhY3Rpb246ICd0ZXN0LWJyb2FkY2FzdCcsXG4gICAgICBwYXlsb2FkOiB7IG1lc3NhZ2U6ICdicm9hZGNhc3QgdGVzdCcgfSxcbiAgICB9KVxuXG4gICAgLy8g5Zyo5rKh5pyJ6L+e5o6l55qE5oOF5Ya15LiL77yM5bm/5pKt5bqU6K+l5b2x5ZONMOS4quWuouaIt+err1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoMClcbiAgfSlcblxuICBpdCgn5bqU6K+l6IO95aSE55CG5Y2P5L2c5oi/6Ze05pON5L2c77yI5qih5ouf77yJJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJvb21JZCA9IGF3YWl0IHNlcnZpY2UuY3JlYXRlQ29sbGFib3JhdGlvblJvb20oJ3Rlc3Qtc3RvcnktMTIzJywgWydhZ2VudDEnLCAnYWdlbnQyJ10pXG4gICAgLy8g5b2T5YmN5a6e546w6L+U5ZuebnVsbFxuICAgIGV4cGVjdChyb29tSWQpLnRvQmVOdWxsKClcblxuICAgIGNvbnN0IGpvaW5SZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmpvaW5Db2xsYWJvcmF0aW9uUm9vbSgndGVzdC1yb29tJywgJ3Rlc3QtYWdlbnQnKVxuICAgIGV4cGVjdChqb2luUmVzdWx0KS50b0JlKHRydWUpXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveWkhOeQhuWunuaXtue8lui+keabtOaWsO+8iOaooeaLn++8iScsIGFzeW5jICgpID0+IHtcbiAgICAvLyDov5nlupTor6XkuI3kvJrmipvlh7rplJnor6/vvIzljbPkvb/msqHmnInlrp7pmYXnmoRXZWJTb2NrZXTov57mjqVcbiAgICBhd2FpdCBleHBlY3QoXG4gICAgICBzZXJ2aWNlLnNlbmRSZWFsdGltZUVkaXQoJ3N0b3J5LTEyMycsICdhZ2VudC00NTYnLCB7XG4gICAgICAgIHR5cGU6ICd0ZXh0JyxcbiAgICAgICAgY29udGVudDogJ+aWsOeahOWGheWuuScsXG4gICAgICAgIHBvc2l0aW9uOiB7IGxpbmU6IDEsIGNvbHVtbjogMTAgfSxcbiAgICAgIH0pXG4gICAgKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveWkhOeQhkFJ55Sf5oiQ6L+b5bqm77yI5qih5ouf77yJJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGV4cGVjdChcbiAgICAgIHNlcnZpY2Uuc2VuZEdlbmVyYXRpb25Qcm9ncmVzcygnc3RvcnktMTIzJywgJ2FnZW50LTQ1NicsIDc1LCAnZ2VuZXJhdGluZycpXG4gICAgKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeiDveWkhOeQhkFnZW505Y2P5L2c54q25oCB77yI5qih5ouf77yJJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGV4cGVjdChcbiAgICAgIHNlcnZpY2Uuc2VuZEFnZW50Q29sbGFib3JhdGlvblN0YXR1cygnc3RvcnktMTIzJywge1xuICAgICAgICBhZ2VudHM6IFsnYWdlbnQxJywgJ2FnZW50MiddLFxuICAgICAgICBzdGF0dXM6ICdhY3RpdmUnLFxuICAgICAgICBwcm9ncmVzczogNjAsXG4gICAgICB9KVxuICAgICkucmVzb2x2ZXMubm90LnRvVGhyb3coKVxuICB9KVxuXG4gIGl0KCflupTor6Xog73ojrflj5bmtLvot4PljY/kvZzkvJror53vvIjmqKHmi5/vvIknLCAoKSA9PiB7XG4gICAgY29uc3Qgc2Vzc2lvbnMgPSBzZXJ2aWNlLmdldEFjdGl2ZUNvbGxhYm9yYXRpb25TZXNzaW9ucygpXG4gICAgZXhwZWN0KEFycmF5LmlzQXJyYXkoc2Vzc2lvbnMpKS50b0JlKHRydWUpXG4gICAgLy8g5b2T5YmN5a6e546w6L+U5Zue56m65pWw57uEXG4gICAgZXhwZWN0KHNlc3Npb25zKS50b0hhdmVMZW5ndGgoMClcbiAgfSlcblxuICBpdCgn5bqU6K+l5q2j56Gu6YWN572uV2ViU29ja2V05Y+C5pWwJywgKCkgPT4ge1xuICAgIGV4cGVjdChjb25maWdTZXJ2aWNlLmdldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ1dFQlNPQ0tFVF9QT1JUJywgODA4MClcbiAgICBleHBlY3QoY29uZmlnU2VydmljZS5nZXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdXRUJTT0NLRVRfSE9TVCcsICdsb2NhbGhvc3QnKVxuICB9KVxufSlcbiJdLCJ2ZXJzaW9uIjozfQ==