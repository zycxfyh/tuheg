d19fa7e63ba5e0961919a64d860b10d2
"use strict";
// 文件路径: apps/narrative-agent/src/__tests__/narrative.service.spec.ts
// 描述: NarrativeService 的单元测试套件，涵盖叙事生成逻辑和错误处理
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('@tuheg/common-backend', () => ({
    ...jest.requireActual('@tuheg/common-backend'),
    callAiWithGuard: jest.fn(),
}));
const axios_1 = require("@nestjs/axios");
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const common_backend_1 = require("@tuheg/common-backend");
const jest_mock_extended_1 = require("jest-mock-extended");
const narrative_service_1 = require("./narrative.service");
describe('NarrativeService', () => {
    let service;
    let prismaMock;
    let schedulerMock;
    let promptManagerMock;
    let httpServiceMock;
    let eventBusMock;
    let contextSummarizerMock;
    let memoryHierarchyMock;
    let promptInjectionGuardMock;
    const mockedCallAiWithGuard = common_backend_1.callAiWithGuard;
    const MOCK_CHAT_MODEL = {};
    const MOCK_PAYLOAD = {
        gameId: 'game-123',
        userId: 'user-abc',
        playerAction: { type: 'command', payload: 'Look around' },
        executedDirectives: [],
        correlationId: 'test-narrative-corr-id',
    };
    const MOCK_GAME_STATE = {
        id: MOCK_PAYLOAD.gameId,
        character: { id: 'char-1', name: 'Hero' },
        worldBook: { id: 'wb-1', entries: {} },
    };
    const MOCK_AI_RESPONSE = {
        narrative: 'You look around and see a vast, empty room.',
        options: [],
    };
    beforeEach(async () => {
        prismaMock = (0, jest_mock_extended_1.mockDeep)();
        schedulerMock = (0, jest_mock_extended_1.mockDeep)();
        promptManagerMock = (0, jest_mock_extended_1.mockDeep)();
        httpServiceMock = (0, jest_mock_extended_1.mockDeep)();
        eventBusMock = (0, jest_mock_extended_1.mockDeep)();
        contextSummarizerMock = (0, jest_mock_extended_1.mockDeep)();
        memoryHierarchyMock = (0, jest_mock_extended_1.mockDeep)();
        promptInjectionGuardMock = (0, jest_mock_extended_1.mockDeep)();
        const guardSafeResult = {
            allowed: true,
            score: 0.1,
            threshold: 0.75,
            reason: 'passed',
        };
        promptInjectionGuardMock.checkInput.mockResolvedValue(guardSafeResult);
        memoryHierarchyMock.getActiveMemories.mockResolvedValue([]);
        // Mock HttpService post method to return an Observable
        const mockObservable = {
            pipe: jest.fn().mockReturnThis(),
            subscribe: jest.fn().mockImplementation((observer) => {
                // Simulate successful HTTP response
                if (observer.next) {
                    observer.next({ data: 'success' });
                }
                if (observer.complete) {
                    observer.complete();
                }
                return { unsubscribe: jest.fn() };
            }),
            toPromise: jest.fn().mockResolvedValue({ data: 'success' }),
        };
        httpServiceMock.post.mockReturnValue(mockObservable);
        const module = await testing_1.Test.createTestingModule({
            providers: [
                narrative_service_1.NarrativeService,
                { provide: common_backend_1.PrismaService, useValue: prismaMock },
                { provide: common_backend_1.DynamicAiSchedulerService, useValue: schedulerMock },
                { provide: common_backend_1.PromptManagerService, useValue: promptManagerMock },
                { provide: axios_1.HttpService, useValue: httpServiceMock },
                { provide: common_backend_1.EventBusService, useValue: eventBusMock },
                { provide: common_backend_1.ContextSummarizerService, useValue: contextSummarizerMock },
                { provide: common_backend_1.MemoryHierarchyService, useValue: memoryHierarchyMock },
                { provide: common_backend_1.PromptInjectionGuard, useValue: promptInjectionGuardMock },
            ],
        }).compile();
        service = module.get(narrative_service_1.NarrativeService);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('processNarrative (Happy Path)', () => {
        beforeEach(() => {
            prismaMock.game.findUniqueOrThrow.mockResolvedValue(MOCK_GAME_STATE);
            // 模拟3次AI调用都成功
            mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE);
            promptManagerMock.getPrompt.mockReturnValue('A mock prompt');
            schedulerMock.getProviderForRole.mockResolvedValue({
                model: MOCK_CHAT_MODEL,
            });
        });
        it('should generate narrative and publish a completion event', async () => {
            await service.processNarrative(MOCK_PAYLOAD);
            expect(prismaMock.game.findUniqueOrThrow).toHaveBeenCalledWith({
                where: { id: MOCK_PAYLOAD.gameId },
                include: { character: true, worldBook: true },
            });
            expect(promptInjectionGuardMock.checkInput).toHaveBeenCalledWith(JSON.stringify(MOCK_PAYLOAD.playerAction), {
                userId: MOCK_PAYLOAD.userId,
            });
            expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1);
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {
                userId: MOCK_PAYLOAD.userId,
                event: 'processing_completed',
                data: expect.objectContaining({
                    message: 'AI response received.',
                    progression: MOCK_AI_RESPONSE,
                }),
            });
        });
    });
    describe('processNarrative (Error Handling)', () => {
        it('should handle NotFoundException and send failure via gateway', async () => {
            prismaMock.game.findUniqueOrThrow.mockRejectedValue(new common_1.NotFoundException());
            await service.processNarrative(MOCK_PAYLOAD);
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {
                userId: MOCK_PAYLOAD.userId,
                event: 'processing_failed',
                data: expect.objectContaining({
                    message: 'An error occurred during narrative generation.',
                    error: 'Not Found',
                }),
            });
        });
        it('should handle AI error and send failure via gateway', async () => {
            const aiError = new common_backend_1.AiGenerationException('AI failed');
            prismaMock.game.findUniqueOrThrow.mockResolvedValue(MOCK_GAME_STATE);
            // [核心修复] 即使在失败场景下，我们也要先告诉 schedulerMock 该做什么
            schedulerMock.getProviderForRole.mockResolvedValue({
                model: MOCK_CHAT_MODEL,
            });
            promptManagerMock.getPrompt.mockReturnValue('A mock prompt');
            // 然后，我们再模拟 AI 调用本身失败
            mockedCallAiWithGuard.mockRejectedValueOnce(aiError);
            await service.processNarrative(MOCK_PAYLOAD);
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {
                userId: MOCK_PAYLOAD.userId,
                event: 'processing_failed',
                data: expect.objectContaining({
                    message: 'An error occurred during narrative generation.',
                    error: 'AI failed',
                }),
            });
        });
        it('should reject promptly when prompt injection guard blocks input', async () => {
            promptInjectionGuardMock.checkInput.mockResolvedValueOnce({
                allowed: false,
                score: 0.98,
                threshold: 0.75,
                reason: 'threshold-exceeded',
                inputPreview: 'malicious',
            });
            await service.processNarrative(MOCK_PAYLOAD);
            expect(mockedCallAiWithGuard).not.toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {
                userId: MOCK_PAYLOAD.userId,
                event: 'processing_failed',
                data: expect.objectContaining({
                    message: 'An error occurred during narrative generation.',
                }),
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXG5hcnJhdGl2ZS1hZ2VudFxcc3JjXFxfX3Rlc3RzX19cXG5hcnJhdGl2ZS5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHFFQUFxRTtBQUNyRSw2Q0FBNkM7O0FBdUI3QyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDeEMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLHVCQUF1QixDQUFDO0lBQzlDLGVBQWUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0NBQzNCLENBQUMsQ0FBQyxDQUFBO0FBdkJILHlDQUEyQztBQUMzQywyQ0FBa0Q7QUFDbEQsNkNBQTBEO0FBRTFELDBEQVk4QjtBQUM5QiwyREFBaUU7QUFDakUsMkRBQXNEO0FBT3RELFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7SUFDaEMsSUFBSSxPQUF5QixDQUFBO0lBQzdCLElBQUksVUFBdUMsQ0FBQTtJQUMzQyxJQUFJLGFBQXVELENBQUE7SUFDM0QsSUFBSSxpQkFBc0QsQ0FBQTtJQUMxRCxJQUFJLGVBQTJDLENBQUE7SUFDL0MsSUFBSSxZQUE0QyxDQUFBO0lBQ2hELElBQUkscUJBQThELENBQUE7SUFDbEUsSUFBSSxtQkFBMEQsQ0FBQTtJQUM5RCxJQUFJLHdCQUE2RCxDQUFBO0lBQ2pFLE1BQU0scUJBQXFCLEdBQUcsZ0NBQTRCLENBQUE7SUFFMUQsTUFBTSxlQUFlLEdBQUcsRUFBOEIsQ0FBQTtJQUN0RCxNQUFNLFlBQVksR0FBOEI7UUFDOUMsTUFBTSxFQUFFLFVBQVU7UUFDbEIsTUFBTSxFQUFFLFVBQVU7UUFDbEIsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFO1FBQ3pELGtCQUFrQixFQUFFLEVBQUU7UUFDdEIsYUFBYSxFQUFFLHdCQUF3QjtLQUN4QyxDQUFBO0lBRUQsTUFBTSxlQUFlLEdBQUc7UUFDdEIs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LEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLElBQUk7Z0JBQ1gsU0FBUyxFQUFFLElBQUk7Z0JBQ2YsTUFBTSxFQUFFLG9CQUFvQjtnQkFDNUIsWUFBWSxFQUFFLFdBQVc7YUFDMUIsQ0FBQyxDQUFBO1lBRUYsTUFBTSxPQUFPLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUE7WUFFNUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLENBQUE7WUFDcEQsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxhQUFhLEVBQUU7Z0JBQy9ELE1BQU0sRUFBRSxZQUFZLENBQUMsTUFBTTtnQkFDM0IsS0FBSyxFQUFFLG1CQUFtQjtnQkFDMUIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDNUIsT0FBTyxFQUFFLGdEQUFnRDtpQkFDMUQsQ0FBQzthQUNILENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xcYXBwc1xcbmFycmF0aXZlLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcbmFycmF0aXZlLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyDmlofku7bot6/lvoQ6IGFwcHMvbmFycmF0aXZlLWFnZW50L3NyYy9fX3Rlc3RzX18vbmFycmF0aXZlLnNlcnZpY2Uuc3BlYy50c1xuLy8g5o+P6L+wOiBOYXJyYXRpdmVTZXJ2aWNlIOeahOWNleWFg+a1i+ivleWll+S7tu+8jOa2teebluWPmeS6i+eUn+aIkOmAu+i+keWSjOmUmeivr+WkhOeQhlxuXG5pbXBvcnQgdHlwZSB7IEJhc2VDaGF0TW9kZWwgfSBmcm9tICdAbGFuZ2NoYWluL2NvcmUvbGFuZ3VhZ2VfbW9kZWxzL2NoYXRfbW9kZWxzJ1xuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2F4aW9zJ1xuaW1wb3J0IHsgTm90Rm91bmRFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbidcbmltcG9ydCB7IFRlc3QsIHR5cGUgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZydcbmltcG9ydCB0eXBlIHsgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQge1xuICBBaUdlbmVyYXRpb25FeGNlcHRpb24sXG4gIENvbnRleHRTdW1tYXJpemVyU2VydmljZSxcbiAgY2FsbEFpV2l0aEd1YXJkLFxuICBEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlLFxuICBFdmVudEJ1c1NlcnZpY2UsXG4gIE1lbW9yeUhpZXJhcmNoeVNlcnZpY2UsXG4gIHR5cGUgTmFycmF0aXZlUmVuZGVyaW5nUGF5bG9hZCxcbiAgUHJpc21hU2VydmljZSxcbiAgdHlwZSBQcm9tcHRJbmplY3Rpb25DaGVja1Jlc3VsdCxcbiAgUHJvbXB0SW5qZWN0aW9uR3VhcmQsXG4gIFByb21wdE1hbmFnZXJTZXJ2aWNlLFxufSBmcm9tICdAdHVoZWcvY29tbW9uLWJhY2tlbmQnXG5pbXBvcnQgeyB0eXBlIERlZXBNb2NrUHJveHksIG1vY2tEZWVwIH0gZnJvbSAnamVzdC1tb2NrLWV4dGVuZGVkJ1xuaW1wb3J0IHsgTmFycmF0aXZlU2VydmljZSB9IGZyb20gJy4vbmFycmF0aXZlLnNlcnZpY2UnXG5cbmplc3QubW9jaygnQHR1aGVnL2NvbW1vbi1iYWNrZW5kJywgKCkgPT4gKHtcbiAgLi4uamVzdC5yZXF1aXJlQWN0dWFsKCdAdHVoZWcvY29tbW9uLWJhY2tlbmQnKSxcbiAgY2FsbEFpV2l0aEd1YXJkOiBqZXN0LmZuKCksXG59KSlcblxuZGVzY3JpYmUoJ05hcnJhdGl2ZVNlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBOYXJyYXRpdmVTZXJ2aWNlXG4gIGxldCBwcmlzbWFNb2NrOiBEZWVwTW9ja1Byb3h5PFByaXNtYUNsaWVudD5cbiAgbGV0IHNjaGVkdWxlck1vY2s6IERlZXBNb2NrUHJveHk8RHluYW1pY0FpU2NoZWR1bGVyU2VydmljZT5cbiAgbGV0IHByb21wdE1hbmFnZXJNb2NrOiBEZWVwTW9ja1Byb3h5PFByb21wdE1hbmFnZXJTZXJ2aWNlPlxuICBsZXQgaHR0cFNlcnZpY2VNb2NrOiBEZWVwTW9ja1Byb3h5PEh0dHBTZXJ2aWNlPlxuICBsZXQgZXZlbnRCdXNNb2NrOiBEZWVwTW9ja1Byb3h5PEV2ZW50QnVzU2VydmljZT5cbiAgbGV0IGNvbnRleHRTdW1tYXJpemVyTW9jazogRGVlcE1vY2tQcm94eTxDb250ZXh0U3VtbWFyaXplclNlcnZpY2U+XG4gIGxldCBtZW1vcnlIaWVyYXJjaHlNb2NrOiBEZWVwTW9ja1Byb3h5PE1lbW9yeUhpZXJhcmNoeVNlcnZpY2U+XG4gIGxldCBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2s6IERlZXBNb2NrUHJveHk8UHJvbXB0SW5qZWN0aW9uR3VhcmQ+XG4gIGNvbnN0IG1vY2tlZENhbGxBaVdpdGhHdWFyZCA9IGNhbGxBaVdpdGhHdWFyZCBhcyBqZXN0Lk1vY2tcblxuICBjb25zdCBNT0NLX0NIQVRfTU9ERUwgPSB7fSBhcyB1bmtub3duIGFzIEJhc2VDaGF0TW9kZWxcbiAgY29uc3QgTU9DS19QQVlMT0FEOiBOYXJyYXRpdmVSZW5kZXJpbmdQYXlsb2FkID0ge1xuICAgIGdhbWVJZDogJ2dhbWUtMTIzJyxcbiAgICB1c2VySWQ6ICd1c2VyLWFiYycsXG4gICAgcGxheWVyQWN0aW9uOiB7IHR5cGU6ICdjb21tYW5kJywgcGF5bG9hZDogJ0xvb2sgYXJvdW5kJyB9LFxuICAgIGV4ZWN1dGVkRGlyZWN0aXZlczogW10sXG4gICAgY29ycmVsYXRpb25JZDogJ3Rlc3QtbmFycmF0aXZlLWNvcnItaWQnLFxuICB9XG5cbiAgY29uc3QgTU9DS19HQU1FX1NUQVRFID0ge1xuICAgIGlkOiBNT0NLX1BBWUxPQUQuZ2FtZUlkLFxuICAgIGNoYXJhY3RlcjogeyBpZDogJ2NoYXItMScsIG5hbWU6ICdIZXJvJyB9LFxuICAgIHdvcmxkQm9vazogeyBpZDogJ3diLTEnLCBlbnRyaWVzOiB7fSB9LFxuICB9XG5cbiAgY29uc3QgTU9DS19BSV9SRVNQT05TRSA9IHtcbiAgICBuYXJyYXRpdmU6ICdZb3UgbG9vayBhcm91bmQgYW5kIHNlZSBhIHZhc3QsIGVtcHR5IHJvb20uJyxcbiAgICBvcHRpb25zOiBbXSxcbiAgfVxuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIHByaXNtYU1vY2sgPSBtb2NrRGVlcDxQcmlzbWFDbGllbnQ+KClcbiAgICBzY2hlZHVsZXJNb2NrID0gbW9ja0RlZXA8RHluYW1pY0FpU2NoZWR1bGVyU2VydmljZT4oKVxuICAgIHByb21wdE1hbmFnZXJNb2NrID0gbW9ja0RlZXA8UHJvbXB0TWFuYWdlclNlcnZpY2U+KClcbiAgICBodHRwU2VydmljZU1vY2sgPSBtb2NrRGVlcDxIdHRwU2VydmljZT4oKVxuICAgIGV2ZW50QnVzTW9jayA9IG1vY2tEZWVwPEV2ZW50QnVzU2VydmljZT4oKVxuICAgIGNvbnRleHRTdW1tYXJpemVyTW9jayA9IG1vY2tEZWVwPENvbnRleHRTdW1tYXJpemVyU2VydmljZT4oKVxuICAgIG1lbW9yeUhpZXJhcmNoeU1vY2sgPSBtb2NrRGVlcDxNZW1vcnlIaWVyYXJjaHlTZXJ2aWNlPigpXG4gICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrID0gbW9ja0RlZXA8UHJvbXB0SW5qZWN0aW9uR3VhcmQ+KClcblxuICAgIGNvbnN0IGd1YXJkU2FmZVJlc3VsdDogUHJvbXB0SW5qZWN0aW9uQ2hlY2tSZXN1bHQgPSB7XG4gICAgICBhbGxvd2VkOiB0cnVlLFxuICAgICAgc2NvcmU6IDAuMSxcbiAgICAgIHRocmVzaG9sZDogMC43NSxcbiAgICAgIHJlYXNvbjogJ3Bhc3NlZCcsXG4gICAgfVxuICAgIHByb21wdEluamVjdGlvbkd1YXJkTW9jay5jaGVja0lucHV0Lm1vY2tSZXNvbHZlZFZhbHVlKGd1YXJkU2FmZVJlc3VsdClcbiAgICBtZW1vcnlIaWVyYXJjaHlNb2NrLmdldEFjdGl2ZU1lbW9yaWVzLm1vY2tSZXNvbHZlZFZhbHVlKFtdKVxuXG4gICAgLy8gTW9jayBIdHRwU2VydmljZSBwb3N0IG1ldGhvZCB0byByZXR1cm4gYW4gT2JzZXJ2YWJsZVxuICAgIGNvbnN0IG1vY2tPYnNlcnZhYmxlID0ge1xuICAgICAgcGlwZTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBzdWJzY3JpYmU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKG9ic2VydmVyKSA9PiB7XG4gICAgICAgIC8vIFNpbXVsYXRlIHN1Y2Nlc3NmdWwgSFRUUCByZXNwb25zZVxuICAgICAgICBpZiAob2JzZXJ2ZXIubmV4dCkge1xuICAgICAgICAgIG9ic2VydmVyLm5leHQoeyBkYXRhOiAnc3VjY2VzcycgfSlcbiAgICAgICAgfVxuICAgICAgICBpZiAob2JzZXJ2ZXIuY29tcGxldGUpIHtcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgdW5zdWJzY3JpYmU6IGplc3QuZm4oKSB9XG4gICAgICB9KSxcbiAgICAgIHRvUHJvbWlzZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgZGF0YTogJ3N1Y2Nlc3MnIH0pLFxuICAgIH1cbiAgICBodHRwU2VydmljZU1vY2sucG9zdC5tb2NrUmV0dXJuVmFsdWUobW9ja09ic2VydmFibGUgYXMgYW55KVxuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBOYXJyYXRpdmVTZXJ2aWNlLFxuICAgICAgICB7IHByb3ZpZGU6IFByaXNtYVNlcnZpY2UsIHVzZVZhbHVlOiBwcmlzbWFNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogRHluYW1pY0FpU2NoZWR1bGVyU2VydmljZSwgdXNlVmFsdWU6IHNjaGVkdWxlck1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQcm9tcHRNYW5hZ2VyU2VydmljZSwgdXNlVmFsdWU6IHByb21wdE1hbmFnZXJNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogSHR0cFNlcnZpY2UsIHVzZVZhbHVlOiBodHRwU2VydmljZU1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBFdmVudEJ1c1NlcnZpY2UsIHVzZVZhbHVlOiBldmVudEJ1c01vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBDb250ZXh0U3VtbWFyaXplclNlcnZpY2UsIHVzZVZhbHVlOiBjb250ZXh0U3VtbWFyaXplck1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBNZW1vcnlIaWVyYXJjaHlTZXJ2aWNlLCB1c2VWYWx1ZTogbWVtb3J5SGllcmFyY2h5TW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IFByb21wdEluamVjdGlvbkd1YXJkLCB1c2VWYWx1ZTogcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKVxuXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8TmFycmF0aXZlU2VydmljZT4oTmFycmF0aXZlU2VydmljZSlcbiAgfSlcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpXG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3Byb2Nlc3NOYXJyYXRpdmUgKEhhcHB5IFBhdGgpJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgcHJpc21hTW9jay5nYW1lLmZpbmRVbmlxdWVPclRocm93Lm1vY2tSZXNvbHZlZFZhbHVlKE1PQ0tfR0FNRV9TVEFURSBhcyBuZXZlcilcbiAgICAgIC8vIOaooeaLnzPmrKFBSeiwg+eUqOmDveaIkOWKn1xuICAgICAgbW9ja2VkQ2FsbEFpV2l0aEd1YXJkLm1vY2tSZXNvbHZlZFZhbHVlKE1PQ0tfQUlfUkVTUE9OU0UpXG4gICAgICBwcm9tcHRNYW5hZ2VyTW9jay5nZXRQcm9tcHQubW9ja1JldHVyblZhbHVlKCdBIG1vY2sgcHJvbXB0JylcbiAgICAgIHNjaGVkdWxlck1vY2suZ2V0UHJvdmlkZXJGb3JSb2xlLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgbW9kZWw6IE1PQ0tfQ0hBVF9NT0RFTCxcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgbmFycmF0aXZlIGFuZCBwdWJsaXNoIGEgY29tcGxldGlvbiBldmVudCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHNlcnZpY2UucHJvY2Vzc05hcnJhdGl2ZShNT0NLX1BBWUxPQUQpXG5cbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLmdhbWUuZmluZFVuaXF1ZU9yVGhyb3cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IE1PQ0tfUEFZTE9BRC5nYW1lSWQgfSxcbiAgICAgICAgaW5jbHVkZTogeyBjaGFyYWN0ZXI6IHRydWUsIHdvcmxkQm9vazogdHJ1ZSB9LFxuICAgICAgfSlcbiAgICAgIGV4cGVjdChwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2suY2hlY2tJbnB1dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KE1PQ0tfUEFZTE9BRC5wbGF5ZXJBY3Rpb24pLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICB9XG4gICAgICApXG4gICAgICBleHBlY3QobW9ja2VkQ2FsbEFpV2l0aEd1YXJkKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSlcbiAgICAgIGV4cGVjdChldmVudEJ1c01vY2sucHVibGlzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ05PVElGWV9VU0VSJywge1xuICAgICAgICB1c2VySWQ6IE1PQ0tfUEFZTE9BRC51c2VySWQsXG4gICAgICAgIGV2ZW50OiAncHJvY2Vzc2luZ19jb21wbGV0ZWQnLFxuICAgICAgICBkYXRhOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgbWVzc2FnZTogJ0FJIHJlc3BvbnNlIHJlY2VpdmVkLicsXG4gICAgICAgICAgcHJvZ3Jlc3Npb246IE1PQ0tfQUlfUkVTUE9OU0UsXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdwcm9jZXNzTmFycmF0aXZlIChFcnJvciBIYW5kbGluZyknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgTm90Rm91bmRFeGNlcHRpb24gYW5kIHNlbmQgZmFpbHVyZSB2aWEgZ2F0ZXdheScsIGFzeW5jICgpID0+IHtcbiAgICAgIHByaXNtYU1vY2suZ2FtZS5maW5kVW5pcXVlT3JUaHJvdy5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgTm90Rm91bmRFeGNlcHRpb24oKSlcbiAgICAgIGF3YWl0IHNlcnZpY2UucHJvY2Vzc05hcnJhdGl2ZShNT0NLX1BBWUxPQUQpXG4gICAgICBleHBlY3QoZXZlbnRCdXNNb2NrLnB1Ymxpc2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdOT1RJRllfVVNFUicsIHtcbiAgICAgICAgdXNlcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICBldmVudDogJ3Byb2Nlc3NpbmdfZmFpbGVkJyxcbiAgICAgICAgZGF0YTogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgbmFycmF0aXZlIGdlbmVyYXRpb24uJyxcbiAgICAgICAgICBlcnJvcjogJ05vdCBGb3VuZCcsXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgQUkgZXJyb3IgYW5kIHNlbmQgZmFpbHVyZSB2aWEgZ2F0ZXdheScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGFpRXJyb3IgPSBuZXcgQWlHZW5lcmF0aW9uRXhjZXB0aW9uKCdBSSBmYWlsZWQnKVxuICAgICAgcHJpc21hTW9jay5nYW1lLmZpbmRVbmlxdWVPclRocm93Lm1vY2tSZXNvbHZlZFZhbHVlKE1PQ0tfR0FNRV9TVEFURSBhcyBuZXZlcilcblxuICAgICAgLy8gW+aguOW/g+S/ruWkjV0g5Y2z5L2/5Zyo5aSx6LSl5Zy65pmv5LiL77yM5oiR5Lus5Lmf6KaB5YWI5ZGK6K+JIHNjaGVkdWxlck1vY2sg6K+l5YGa5LuA5LmIXG4gICAgICBzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIG1vZGVsOiBNT0NLX0NIQVRfTU9ERUwsXG4gICAgICB9KVxuICAgICAgcHJvbXB0TWFuYWdlck1vY2suZ2V0UHJvbXB0Lm1vY2tSZXR1cm5WYWx1ZSgnQSBtb2NrIHByb21wdCcpXG5cbiAgICAgIC8vIOeEtuWQju+8jOaIkeS7rOWGjeaooeaLnyBBSSDosIPnlKjmnKzouqvlpLHotKVcbiAgICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UoYWlFcnJvcilcblxuICAgICAgYXdhaXQgc2VydmljZS5wcm9jZXNzTmFycmF0aXZlKE1PQ0tfUEFZTE9BRClcblxuICAgICAgZXhwZWN0KGV2ZW50QnVzTW9jay5wdWJsaXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnTk9USUZZX1VTRVInLCB7XG4gICAgICAgIHVzZXJJZDogTU9DS19QQVlMT0FELnVzZXJJZCxcbiAgICAgICAgZXZlbnQ6ICdwcm9jZXNzaW5nX2ZhaWxlZCcsXG4gICAgICAgIGRhdGE6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQW4gZXJyb3Igb2NjdXJyZWQgZHVyaW5nIG5hcnJhdGl2ZSBnZW5lcmF0aW9uLicsXG4gICAgICAgICAgZXJyb3I6ICdBSSBmYWlsZWQnLFxuICAgICAgICB9KSxcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgcmVqZWN0IHByb21wdGx5IHdoZW4gcHJvbXB0IGluamVjdGlvbiBndWFyZCBibG9ja3MgaW5wdXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2suY2hlY2tJbnB1dC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgICBhbGxvd2VkOiBmYWxzZSxcbiAgICAgICAgc2NvcmU6IDAuOTgsXG4gICAgICAgIHRocmVzaG9sZDogMC43NSxcbiAgICAgICAgcmVhc29uOiAndGhyZXNob2xkLWV4Y2VlZGVkJyxcbiAgICAgICAgaW5wdXRQcmV2aWV3OiAnbWFsaWNpb3VzJyxcbiAgICAgIH0pXG5cbiAgICAgIGF3YWl0IHNlcnZpY2UucHJvY2Vzc05hcnJhdGl2ZShNT0NLX1BBWUxPQUQpXG5cbiAgICAgIGV4cGVjdChtb2NrZWRDYWxsQWlXaXRoR3VhcmQpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChldmVudEJ1c01vY2sucHVibGlzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ05PVElGWV9VU0VSJywge1xuICAgICAgICB1c2VySWQ6IE1PQ0tfUEFZTE9BRC51c2VySWQsXG4gICAgICAgIGV2ZW50OiAncHJvY2Vzc2luZ19mYWlsZWQnLFxuICAgICAgICBkYXRhOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgbWVzc2FnZTogJ0FuIGVycm9yIG9jY3VycmVkIGR1cmluZyBuYXJyYXRpdmUgZ2VuZXJhdGlvbi4nLFxuICAgICAgICB9KSxcbiAgICAgIH0pXG4gICAgfSlcbiAgfSlcbn0pXG4iXSwidmVyc2lvbiI6M30=