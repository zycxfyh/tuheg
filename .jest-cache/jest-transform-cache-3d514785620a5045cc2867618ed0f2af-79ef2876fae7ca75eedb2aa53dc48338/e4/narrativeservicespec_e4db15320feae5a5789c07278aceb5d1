1d72f0435fd24a786de778f8b9580cfb
"use strict";
// 文件路径: apps/narrative-agent/src/__tests__/narrative.service.spec.ts
// 描述: NarrativeService 的单元测试套件，涵盖叙事生成逻辑和错误处理
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('@tuheg/common-backend', () => ({
    ...jest.requireActual('@tuheg/common-backend'),
    callAiWithGuard: jest.fn(),
}));
const axios_1 = require("@nestjs/axios");
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const common_backend_1 = require("@tuheg/common-backend");
const jest_mock_extended_1 = require("jest-mock-extended");
const narrative_service_1 = require("../narrative.service");
describe('NarrativeService', () => {
    let service;
    let prismaMock;
    let schedulerMock;
    let promptManagerMock;
    let httpServiceMock;
    let eventBusMock;
    let contextSummarizerMock;
    let memoryHierarchyMock;
    let promptInjectionGuardMock;
    const mockedCallAiWithGuard = common_backend_1.callAiWithGuard;
    const MOCK_CHAT_MODEL = {};
    const MOCK_PAYLOAD = {
        gameId: 'game-123',
        userId: 'user-abc',
        playerAction: { type: 'command', payload: 'Look around' },
        executedDirectives: [],
        correlationId: 'test-narrative-corr-id',
    };
    const MOCK_GAME_STATE = {
        id: MOCK_PAYLOAD.gameId,
        character: { id: 'char-1', name: 'Hero' },
        worldBook: { id: 'wb-1', entries: {} },
    };
    const MOCK_AI_RESPONSE = {
        narrative: 'You look around and see a vast, empty room.',
        options: [],
    };
    beforeEach(async () => {
        prismaMock = (0, jest_mock_extended_1.mockDeep)();
        schedulerMock = (0, jest_mock_extended_1.mockDeep)();
        promptManagerMock = (0, jest_mock_extended_1.mockDeep)();
        httpServiceMock = (0, jest_mock_extended_1.mockDeep)();
        eventBusMock = (0, jest_mock_extended_1.mockDeep)();
        contextSummarizerMock = (0, jest_mock_extended_1.mockDeep)();
        memoryHierarchyMock = (0, jest_mock_extended_1.mockDeep)();
        promptInjectionGuardMock = (0, jest_mock_extended_1.mockDeep)();
        const guardSafeResult = {
            allowed: true,
            score: 0.1,
            threshold: 0.75,
            reason: 'passed',
        };
        promptInjectionGuardMock.checkInput.mockResolvedValue(guardSafeResult);
        memoryHierarchyMock.getActiveMemories.mockResolvedValue([]);
        // Mock HttpService post method to return an Observable
        const mockObservable = {
            pipe: jest.fn().mockReturnThis(),
            subscribe: jest.fn().mockImplementation((observer) => {
                // Simulate successful HTTP response
                if (observer.next) {
                    observer.next({ data: 'success' });
                }
                if (observer.complete) {
                    observer.complete();
                }
                return { unsubscribe: jest.fn() };
            }),
            toPromise: jest.fn().mockResolvedValue({ data: 'success' }),
        };
        httpServiceMock.post.mockReturnValue(mockObservable);
        const module = await testing_1.Test.createTestingModule({
            providers: [
                narrative_service_1.NarrativeService,
                { provide: common_backend_1.PrismaService, useValue: prismaMock },
                { provide: common_backend_1.DynamicAiSchedulerService, useValue: schedulerMock },
                { provide: common_backend_1.PromptManagerService, useValue: promptManagerMock },
                { provide: axios_1.HttpService, useValue: httpServiceMock },
                { provide: common_backend_1.EventBusService, useValue: eventBusMock },
                { provide: common_backend_1.ContextSummarizerService, useValue: contextSummarizerMock },
                { provide: common_backend_1.MemoryHierarchyService, useValue: memoryHierarchyMock },
                { provide: common_backend_1.PromptInjectionGuard, useValue: promptInjectionGuardMock },
            ],
        }).compile();
        service = module.get(narrative_service_1.NarrativeService);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('processNarrative (Happy Path)', () => {
        beforeEach(() => {
            prismaMock.game.findUniqueOrThrow.mockResolvedValue(MOCK_GAME_STATE);
            // 模拟3次AI调用都成功
            mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE);
            promptManagerMock.getPrompt.mockReturnValue('A mock prompt');
            schedulerMock.getProviderForRole.mockResolvedValue({
                model: MOCK_CHAT_MODEL,
            });
        });
        it('should generate narrative and publish a completion event', async () => {
            await service.processNarrative(MOCK_PAYLOAD);
            expect(prismaMock.game.findUniqueOrThrow).toHaveBeenCalledWith({
                where: { id: MOCK_PAYLOAD.gameId },
                include: { character: true, worldBook: true },
            });
            expect(promptInjectionGuardMock.checkInput).toHaveBeenCalledWith(JSON.stringify(MOCK_PAYLOAD.playerAction), {
                userId: MOCK_PAYLOAD.userId,
            });
            expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1);
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {
                userId: MOCK_PAYLOAD.userId,
                event: 'processing_completed',
                data: expect.objectContaining({
                    message: 'AI response received.',
                    progression: MOCK_AI_RESPONSE,
                }),
            });
        });
    });
    describe('processNarrative (Error Handling)', () => {
        it('should handle NotFoundException and send failure via gateway', async () => {
            prismaMock.game.findUniqueOrThrow.mockRejectedValue(new common_1.NotFoundException());
            await service.processNarrative(MOCK_PAYLOAD);
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {
                userId: MOCK_PAYLOAD.userId,
                event: 'processing_failed',
                data: expect.objectContaining({
                    message: 'An error occurred during narrative generation.',
                    error: 'Not Found',
                }),
            });
        });
        it('should handle AI error and send failure via gateway', async () => {
            const aiError = new common_backend_1.AiGenerationException('AI failed');
            prismaMock.game.findUniqueOrThrow.mockResolvedValue(MOCK_GAME_STATE);
            // [核心修复] 即使在失败场景下，我们也要先告诉 schedulerMock 该做什么
            schedulerMock.getProviderForRole.mockResolvedValue({
                model: MOCK_CHAT_MODEL,
            });
            promptManagerMock.getPrompt.mockReturnValue('A mock prompt');
            // 然后，我们再模拟 AI 调用本身失败
            mockedCallAiWithGuard.mockRejectedValueOnce(aiError);
            await service.processNarrative(MOCK_PAYLOAD);
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {
                userId: MOCK_PAYLOAD.userId,
                event: 'processing_failed',
                data: expect.objectContaining({
                    message: 'An error occurred during narrative generation.',
                    error: 'AI failed',
                }),
            });
        });
        it('should reject promptly when prompt injection guard blocks input', async () => {
            promptInjectionGuardMock.checkInput.mockResolvedValueOnce({
                allowed: false,
                score: 0.98,
                threshold: 0.75,
                reason: 'threshold-exceeded',
                inputPreview: 'malicious',
            });
            await service.processNarrative(MOCK_PAYLOAD);
            expect(mockedCallAiWithGuard).not.toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', {
                userId: MOCK_PAYLOAD.userId,
                event: 'processing_failed',
                data: expect.objectContaining({
                    message: 'An error occurred during narrative generation.',
                }),
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXG5hcnJhdGl2ZS1hZ2VudFxcc3JjXFxfX3Rlc3RzX19cXG5hcnJhdGl2ZS5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHFFQUFxRTtBQUNyRSw2Q0FBNkM7O0FBdUI3QyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDeEMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLHVCQUF1QixDQUFDO0lBQzlDLGVBQWUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0NBQzNCLENBQUMsQ0FBQyxDQUFBO0FBdkJILHlDQUEyQztBQUMzQywyQ0FBa0Q7QUFDbEQsNkNBQTBEO0FBRTFELDBEQVk4QjtBQUM5QiwyREFBaUU7QUFDakUsNERBQXVEO0FBT3ZELFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7SUFDaEMsSUFBSSxPQUF5QixDQUFBO0lBQzdCLElBQUksVUFBdUMsQ0FBQTtJQUMzQyxJQUFJLGFBQXVELENBQUE7SUFDM0QsSUFBSSxpQkFBc0QsQ0FBQTtJQUMxRCxJQUFJLGVBQTJDLENBQUE7SUFDL0MsSUFBSSxZQUE0QyxDQUFBO0lBQ2hELElBQUkscUJBQThELENBQUE7SUFDbEUsSUFBSSxtQkFBMEQsQ0FBQTtJQUM5RCxJQUFJLHdCQUE2RCxDQUFBO0lBQ2pFLE1BQU0scUJBQXFCLEdBQUcsZ0NBQTRCLENBQUE7SUFFMUQsTUFBTSxlQUFlLEdBQUcsRUFBOEIsQ0FBQTtJQUN0RCxNQUFNLFlBQVksR0FBOEI7UUFDOUMsTUFBTSxFQUFFLFVBQVU7UUFDbEIsTUFBTSxFQUFFLFVBQVU7UUFDbEIsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFO1FBQ3pELGtCQUFrQixFQUFFLEVBQUU7UUFDdEIsYUFBYSxFQUFFLHdCQUF3QjtLQUN4QyxDQUFBO0lBRUQsTUFBTSxlQUFlLEdBQUc7UUFDdEIsRUFBRSxFQUFFLFlBQVksQ0FBQyxNQUFNO1FBQ3ZCLFNBQVMsRUFBRSxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRTtRQUN6QyxTQUFTLEVBQUUsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUU7S0FDdkMsQ0FBQTtJQUVELE1BQU0sZ0JBQWdCLEdBQUc7UUFDdkIsU0FBUyxFQUFFLDZDQUE2QztRQUN4RCxPQUFPLEVBQUUsRUFBRTtLQUNaLENBQUE7SUFFRCxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsVUFBVSxHQUFHLElBQUEsNkJBQVEsR0FBZ0IsQ0FBQTtRQUNyQyxhQUFhLEdBQUcsSUFBQSw2QkFBUSxHQUE2QixDQUFBO1FBQ3JELGlCQUFpQixHQUFHLElBQUEsNkJBQVEsR0FBd0IsQ0FBQTtRQUNwRCxlQUFlLEdBQUcsSUFBQSw2QkFBUSxHQUFlLENBQUE7UUFDekMsWUFBWSxHQUFHLElBQUEsNkJBQVEsR0FBbUIsQ0FBQTtRQUMxQyxxQkFBcUIsR0FBRyxJQUFBLDZCQUFRLEdBQTRCLENBQUE7UUFDNUQsbUJBQW1CLEdBQUcsSUFBQSw2QkFBUSxHQUEwQixDQUFBO1FBQ3hELHdCQUF3QixHQUFHLElBQUEsNkJBQVEsR0FBd0IsQ0FBQTtRQUUzRCxNQUFNLGVBQWUsR0FBK0I7WUFDbEQsT0FBTyxFQUFFLElBQUk7WUFDYixLQUFLLEVBQUUsR0FBRztZQUNWLFNBQVMsRUFBRSxJQUFJO1lBQ2YsTUFBTSxFQUFFLFFBQVE7U0FDakIsQ0FBQTtRQUNELHdCQUF3QixDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQUMsQ0FBQTtRQUN0RSxtQkFBbUIsQ0FBQyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUUzRCx1REFBdUQ7UUFDdkQsTUFBTSxjQUFjLEdBQUc7WUFDckIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7WUFDaEMsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO2dCQUNuRCxvQ0FBb0M7Z0JBQ3BDLElBQUksUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO29CQUNsQixRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUE7Z0JBQ3BDLENBQUM7Z0JBQ0QsSUFBSSxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7b0JBQ3RCLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtnQkFDckIsQ0FBQztnQkFDRCxPQUFPLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFBO1lBQ25DLENBQUMsQ0FBQztZQUNGLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUM7U0FDNUQsQ0FBQTtRQUNELGVBQWUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGNBQXFCLENBQUMsQ0FBQTtRQUUzRCxNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULG9DQUFnQjtnQkFDaEIsRUFBRSxPQUFPLEVBQUUsOEJBQWEsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFO2dCQUNoRCxFQUFFLE9BQU8sRUFBRSwwQ0FBeUIsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFO2dCQUMvRCxFQUFFLE9BQU8sRUFBRSxxQ0FBb0IsRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUU7Z0JBQzlELEVBQUUsT0FBTyxFQUFFLG1CQUFXLEVBQUUsUUFBUSxFQUFFLGVBQWUsRUFBRTtnQkFDbkQsRUFBRSxPQUFPLEVBQUUsZ0NBQWUsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFO2dCQUNwRCxFQUFFLE9BQU8sRUFBRSx5Q0FBd0IsRUFBRSxRQUFRLEVBQUUscUJBQXFCLEVBQUU7Z0JBQ3RFLEVBQUUsT0FBTyxFQUFFLHVDQUFzQixFQUFFLFFBQVEsRUFBRSxtQkFBbUIsRUFBRTtnQkFDbEUsRUFBRSxPQUFPLEVBQUUscUNBQW9CLEVBQUUsUUFBUSxFQUFFLHdCQUF3QixFQUFFO2FBQ3RFO1NBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBRVosT0FBTyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQW1CLG9DQUFnQixDQUFDLENBQUE7SUFDMUQsQ0FBQyxDQUFDLENBQUE7SUFFRixTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO0lBQ3RCLENBQUMsQ0FBQyxDQUFBO0lBRUYsRUFBRSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRTtRQUMzQixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUE7SUFDL0IsQ0FBQyxDQUFDLENBQUE7SUFFRixRQUFRLENBQUMsK0JBQStCLEVBQUUsR0FBRyxFQUFFO1FBQzdDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxVQUFVLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLGVBQXdCLENBQUMsQ0FBQTtZQUM3RSxjQUFjO1lBQ2QscUJBQXFCLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtZQUN6RCxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxDQUFBO1lBQzVELGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FBQztnQkFDakQsS0FBSyxFQUFFLGVBQWU7YUFDdkIsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7UUFFRixFQUFFLENBQUMsMERBQTBELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDeEUsTUFBTSxPQUFPLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUE7WUFFNUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQztnQkFDN0QsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLFlBQVksQ0FBQyxNQUFNLEVBQUU7Z0JBQ2xDLE9BQU8sRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRTthQUM5QyxDQUFDLENBQUE7WUFDRixNQUFNLENBQUMsd0JBQXdCLENBQUMsVUFBVSxDQUFDLENBQUMsb0JBQW9CLENBQzlELElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxFQUN6QztnQkFDRSxNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07YUFDNUIsQ0FDRixDQUFBO1lBQ0QsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDdEQsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxhQUFhLEVBQUU7Z0JBQy9ELE1BQU0sRUFBRSxZQUFZLENBQUMsTUFBTTtnQkFDM0IsS0FBSyxFQUFFLHNCQUFzQjtnQkFDN0IsSUFBSSxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDNUIsT0FBTyxFQUFFLHVCQUF1QjtvQkFDaEMsV0FBVyxFQUFFLGdCQUFnQjtpQkFDOUIsQ0FBQzthQUNILENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7SUFFRixRQUFRLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxFQUFFO1FBQ2pELEVBQUUsQ0FBQyw4REFBOEQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM1RSxVQUFVLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLElBQUksMEJBQWlCLEVBQUUsQ0FBQyxDQUFBO1lBQzVFLE1BQU0sT0FBTyxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFBO1lBQzVDLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsb0JBQW9CLENBQUMsYUFBYSxFQUFFO2dCQUMvRCxNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07Z0JBQzNCLEtBQUssRUFBRSxtQkFBbUI7Z0JBQzFCLElBQUksRUFBRSxNQUFNLENBQUMsZ0JBQWdCLENBQUM7b0JBQzVCLE9BQU8sRUFBRSxnREFBZ0Q7b0JBQ3pELEtBQUssRUFBRSxXQUFXO2lCQUNuQixDQUFDO2FBQ0gsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7UUFFRixFQUFFLENBQUMscURBQXFELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDbkUsTUFBTSxPQUFPLEdBQUcsSUFBSSxzQ0FBcUIsQ0FBQyxXQUFXLENBQUMsQ0FBQTtZQUN0RCxVQUFVLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLGVBQXdCLENBQUMsQ0FBQTtZQUU3RSw2Q0FBNkM7WUFDN0MsYUFBYSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDO2dCQUNqRCxLQUFLLEVBQUUsZUFBZTthQUN2QixDQUFDLENBQUE7WUFDRixpQkFBaUIsQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxDQUFBO1lBRTVELHFCQUFxQjtZQUNyQixxQkFBcUIsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUVwRCxNQUFNLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsQ0FBQTtZQUU1QyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLGFBQWEsRUFBRTtnQkFDL0QsTUFBTSxFQUFFLFlBQVksQ0FBQyxNQUFNO2dCQUMzQixLQUFLLEVBQUUsbUJBQW1CO2dCQUMxQixJQUFJLEVBQUUsTUFBTSxDQUFDLGdCQUFnQixDQUFDO29CQUM1QixPQUFPLEVBQUUsZ0RBQWdEO29CQUN6RCxLQUFLLEVBQUUsV0FBVztpQkFDbkIsQ0FBQzthQUNILENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO1FBRUYsRUFBRSxDQUFDLGlFQUFpRSxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQy9FLHdCQUF3QixDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQztnQkFDeEQsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLElBQUk7Z0JBQ1gsU0FBUyxFQUFFLElBQUk7Z0JBQ2YsTUFBTSxFQUFFLG9CQUFvQjtnQkFDNUIsWUFBWSxFQUFFLFdBQVc7YUFDMUIsQ0FBQyxDQUFBO1lBRUYsTUFBTSxPQUFPLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUE7WUFFNUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLENBQUE7WUFDcEQsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxhQUFhLEVBQUU7Z0JBQy9ELE1BQU0sRUFBRSxZQUFZLENBQUMsTUFBTTtnQkFDM0IsS0FBSyxFQUFFLG1CQUFtQjtnQkFDMUIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDNUIsT0FBTyxFQUFFLGdEQUFnRDtpQkFDMUQsQ0FBQzthQUNILENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xcYXBwc1xcbmFycmF0aXZlLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcbmFycmF0aXZlLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyDmlofku7bot6/lvoQ6IGFwcHMvbmFycmF0aXZlLWFnZW50L3NyYy9fX3Rlc3RzX18vbmFycmF0aXZlLnNlcnZpY2Uuc3BlYy50c1xuLy8g5o+P6L+wOiBOYXJyYXRpdmVTZXJ2aWNlIOeahOWNleWFg+a1i+ivleWll+S7tu+8jOa2teebluWPmeS6i+eUn+aIkOmAu+i+keWSjOmUmeivr+WkhOeQhlxuXG5pbXBvcnQgdHlwZSB7IEJhc2VDaGF0TW9kZWwgfSBmcm9tICdAbGFuZ2NoYWluL2NvcmUvbGFuZ3VhZ2VfbW9kZWxzL2NoYXRfbW9kZWxzJ1xuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2F4aW9zJ1xuaW1wb3J0IHsgTm90Rm91bmRFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbidcbmltcG9ydCB7IFRlc3QsIHR5cGUgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZydcbmltcG9ydCB0eXBlIHsgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQge1xuICBBaUdlbmVyYXRpb25FeGNlcHRpb24sXG4gIENvbnRleHRTdW1tYXJpemVyU2VydmljZSxcbiAgY2FsbEFpV2l0aEd1YXJkLFxuICBEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlLFxuICBFdmVudEJ1c1NlcnZpY2UsXG4gIE1lbW9yeUhpZXJhcmNoeVNlcnZpY2UsXG4gIHR5cGUgTmFycmF0aXZlUmVuZGVyaW5nUGF5bG9hZCxcbiAgUHJpc21hU2VydmljZSxcbiAgdHlwZSBQcm9tcHRJbmplY3Rpb25DaGVja1Jlc3VsdCxcbiAgUHJvbXB0SW5qZWN0aW9uR3VhcmQsXG4gIFByb21wdE1hbmFnZXJTZXJ2aWNlLFxufSBmcm9tICdAdHVoZWcvY29tbW9uLWJhY2tlbmQnXG5pbXBvcnQgeyB0eXBlIERlZXBNb2NrUHJveHksIG1vY2tEZWVwIH0gZnJvbSAnamVzdC1tb2NrLWV4dGVuZGVkJ1xuaW1wb3J0IHsgTmFycmF0aXZlU2VydmljZSB9IGZyb20gJy4uL25hcnJhdGl2ZS5zZXJ2aWNlJ1xuXG5qZXN0Lm1vY2soJ0B0dWhlZy9jb21tb24tYmFja2VuZCcsICgpID0+ICh7XG4gIC4uLmplc3QucmVxdWlyZUFjdHVhbCgnQHR1aGVnL2NvbW1vbi1iYWNrZW5kJyksXG4gIGNhbGxBaVdpdGhHdWFyZDogamVzdC5mbigpLFxufSkpXG5cbmRlc2NyaWJlKCdOYXJyYXRpdmVTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogTmFycmF0aXZlU2VydmljZVxuICBsZXQgcHJpc21hTW9jazogRGVlcE1vY2tQcm94eTxQcmlzbWFDbGllbnQ+XG4gIGxldCBzY2hlZHVsZXJNb2NrOiBEZWVwTW9ja1Byb3h5PER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2U+XG4gIGxldCBwcm9tcHRNYW5hZ2VyTW9jazogRGVlcE1vY2tQcm94eTxQcm9tcHRNYW5hZ2VyU2VydmljZT5cbiAgbGV0IGh0dHBTZXJ2aWNlTW9jazogRGVlcE1vY2tQcm94eTxIdHRwU2VydmljZT5cbiAgbGV0IGV2ZW50QnVzTW9jazogRGVlcE1vY2tQcm94eTxFdmVudEJ1c1NlcnZpY2U+XG4gIGxldCBjb250ZXh0U3VtbWFyaXplck1vY2s6IERlZXBNb2NrUHJveHk8Q29udGV4dFN1bW1hcml6ZXJTZXJ2aWNlPlxuICBsZXQgbWVtb3J5SGllcmFyY2h5TW9jazogRGVlcE1vY2tQcm94eTxNZW1vcnlIaWVyYXJjaHlTZXJ2aWNlPlxuICBsZXQgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrOiBEZWVwTW9ja1Byb3h5PFByb21wdEluamVjdGlvbkd1YXJkPlxuICBjb25zdCBtb2NrZWRDYWxsQWlXaXRoR3VhcmQgPSBjYWxsQWlXaXRoR3VhcmQgYXMgamVzdC5Nb2NrXG5cbiAgY29uc3QgTU9DS19DSEFUX01PREVMID0ge30gYXMgdW5rbm93biBhcyBCYXNlQ2hhdE1vZGVsXG4gIGNvbnN0IE1PQ0tfUEFZTE9BRDogTmFycmF0aXZlUmVuZGVyaW5nUGF5bG9hZCA9IHtcbiAgICBnYW1lSWQ6ICdnYW1lLTEyMycsXG4gICAgdXNlcklkOiAndXNlci1hYmMnLFxuICAgIHBsYXllckFjdGlvbjogeyB0eXBlOiAnY29tbWFuZCcsIHBheWxvYWQ6ICdMb29rIGFyb3VuZCcgfSxcbiAgICBleGVjdXRlZERpcmVjdGl2ZXM6IFtdLFxuICAgIGNvcnJlbGF0aW9uSWQ6ICd0ZXN0LW5hcnJhdGl2ZS1jb3JyLWlkJyxcbiAgfVxuXG4gIGNvbnN0IE1PQ0tfR0FNRV9TVEFURSA9IHtcbiAgICBpZDogTU9DS19QQVlMT0FELmdhbWVJZCxcbiAgICBjaGFyYWN0ZXI6IHsgaWQ6ICdjaGFyLTEnLCBuYW1lOiAnSGVybycgfSxcbiAgICB3b3JsZEJvb2s6IHsgaWQ6ICd3Yi0xJywgZW50cmllczoge30gfSxcbiAgfVxuXG4gIGNvbnN0IE1PQ0tfQUlfUkVTUE9OU0UgPSB7XG4gICAgbmFycmF0aXZlOiAnWW91IGxvb2sgYXJvdW5kIGFuZCBzZWUgYSB2YXN0LCBlbXB0eSByb29tLicsXG4gICAgb3B0aW9uczogW10sXG4gIH1cblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBwcmlzbWFNb2NrID0gbW9ja0RlZXA8UHJpc21hQ2xpZW50PigpXG4gICAgc2NoZWR1bGVyTW9jayA9IG1vY2tEZWVwPER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2U+KClcbiAgICBwcm9tcHRNYW5hZ2VyTW9jayA9IG1vY2tEZWVwPFByb21wdE1hbmFnZXJTZXJ2aWNlPigpXG4gICAgaHR0cFNlcnZpY2VNb2NrID0gbW9ja0RlZXA8SHR0cFNlcnZpY2U+KClcbiAgICBldmVudEJ1c01vY2sgPSBtb2NrRGVlcDxFdmVudEJ1c1NlcnZpY2U+KClcbiAgICBjb250ZXh0U3VtbWFyaXplck1vY2sgPSBtb2NrRGVlcDxDb250ZXh0U3VtbWFyaXplclNlcnZpY2U+KClcbiAgICBtZW1vcnlIaWVyYXJjaHlNb2NrID0gbW9ja0RlZXA8TWVtb3J5SGllcmFyY2h5U2VydmljZT4oKVxuICAgIHByb21wdEluamVjdGlvbkd1YXJkTW9jayA9IG1vY2tEZWVwPFByb21wdEluamVjdGlvbkd1YXJkPigpXG5cbiAgICBjb25zdCBndWFyZFNhZmVSZXN1bHQ6IFByb21wdEluamVjdGlvbkNoZWNrUmVzdWx0ID0ge1xuICAgICAgYWxsb3dlZDogdHJ1ZSxcbiAgICAgIHNjb3JlOiAwLjEsXG4gICAgICB0aHJlc2hvbGQ6IDAuNzUsXG4gICAgICByZWFzb246ICdwYXNzZWQnLFxuICAgIH1cbiAgICBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2suY2hlY2tJbnB1dC5tb2NrUmVzb2x2ZWRWYWx1ZShndWFyZFNhZmVSZXN1bHQpXG4gICAgbWVtb3J5SGllcmFyY2h5TW9jay5nZXRBY3RpdmVNZW1vcmllcy5tb2NrUmVzb2x2ZWRWYWx1ZShbXSlcblxuICAgIC8vIE1vY2sgSHR0cFNlcnZpY2UgcG9zdCBtZXRob2QgdG8gcmV0dXJuIGFuIE9ic2VydmFibGVcbiAgICBjb25zdCBtb2NrT2JzZXJ2YWJsZSA9IHtcbiAgICAgIHBpcGU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgc3Vic2NyaWJlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChvYnNlcnZlcikgPT4ge1xuICAgICAgICAvLyBTaW11bGF0ZSBzdWNjZXNzZnVsIEhUVFAgcmVzcG9uc2VcbiAgICAgICAgaWYgKG9ic2VydmVyLm5leHQpIHtcbiAgICAgICAgICBvYnNlcnZlci5uZXh0KHsgZGF0YTogJ3N1Y2Nlc3MnIH0pXG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9ic2VydmVyLmNvbXBsZXRlKSB7XG4gICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7IHVuc3Vic2NyaWJlOiBqZXN0LmZuKCkgfVxuICAgICAgfSksXG4gICAgICB0b1Byb21pc2U6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGRhdGE6ICdzdWNjZXNzJyB9KSxcbiAgICB9XG4gICAgaHR0cFNlcnZpY2VNb2NrLnBvc3QubW9ja1JldHVyblZhbHVlKG1vY2tPYnNlcnZhYmxlIGFzIGFueSlcblxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgTmFycmF0aXZlU2VydmljZSxcbiAgICAgICAgeyBwcm92aWRlOiBQcmlzbWFTZXJ2aWNlLCB1c2VWYWx1ZTogcHJpc21hTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2UsIHVzZVZhbHVlOiBzY2hlZHVsZXJNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogUHJvbXB0TWFuYWdlclNlcnZpY2UsIHVzZVZhbHVlOiBwcm9tcHRNYW5hZ2VyTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IEh0dHBTZXJ2aWNlLCB1c2VWYWx1ZTogaHR0cFNlcnZpY2VNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogRXZlbnRCdXNTZXJ2aWNlLCB1c2VWYWx1ZTogZXZlbnRCdXNNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogQ29udGV4dFN1bW1hcml6ZXJTZXJ2aWNlLCB1c2VWYWx1ZTogY29udGV4dFN1bW1hcml6ZXJNb2NrIH0sXG4gICAgICAgIHsgcHJvdmlkZTogTWVtb3J5SGllcmFyY2h5U2VydmljZSwgdXNlVmFsdWU6IG1lbW9yeUhpZXJhcmNoeU1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQcm9tcHRJbmplY3Rpb25HdWFyZCwgdXNlVmFsdWU6IHByb21wdEluamVjdGlvbkd1YXJkTW9jayB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKClcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PE5hcnJhdGl2ZVNlcnZpY2U+KE5hcnJhdGl2ZVNlcnZpY2UpXG4gIH0pXG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKVxuICB9KVxuXG4gIGl0KCdzaG91bGQgYmUgZGVmaW5lZCcsICgpID0+IHtcbiAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKVxuICB9KVxuXG4gIGRlc2NyaWJlKCdwcm9jZXNzTmFycmF0aXZlIChIYXBweSBQYXRoKScsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIHByaXNtYU1vY2suZ2FtZS5maW5kVW5pcXVlT3JUaHJvdy5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0dBTUVfU1RBVEUgYXMgbmV2ZXIpXG4gICAgICAvLyDmqKHmi58z5qyhQUnosIPnlKjpg73miJDlip9cbiAgICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0FJX1JFU1BPTlNFKVxuICAgICAgcHJvbXB0TWFuYWdlck1vY2suZ2V0UHJvbXB0Lm1vY2tSZXR1cm5WYWx1ZSgnQSBtb2NrIHByb21wdCcpXG4gICAgICBzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIG1vZGVsOiBNT0NLX0NIQVRfTU9ERUwsXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIG5hcnJhdGl2ZSBhbmQgcHVibGlzaCBhIGNvbXBsZXRpb24gZXZlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzZXJ2aWNlLnByb2Nlc3NOYXJyYXRpdmUoTU9DS19QQVlMT0FEKVxuXG4gICAgICBleHBlY3QocHJpc21hTW9jay5nYW1lLmZpbmRVbmlxdWVPclRocm93KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBNT0NLX1BBWUxPQUQuZ2FtZUlkIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgY2hhcmFjdGVyOiB0cnVlLCB3b3JsZEJvb2s6IHRydWUgfSxcbiAgICAgIH0pXG4gICAgICBleHBlY3QocHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmNoZWNrSW5wdXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBKU09OLnN0cmluZ2lmeShNT0NLX1BBWUxPQUQucGxheWVyQWN0aW9uKSxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJJZDogTU9DS19QQVlMT0FELnVzZXJJZCxcbiAgICAgICAgfVxuICAgICAgKVxuICAgICAgZXhwZWN0KG1vY2tlZENhbGxBaVdpdGhHdWFyZCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpXG4gICAgICBleHBlY3QoZXZlbnRCdXNNb2NrLnB1Ymxpc2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdOT1RJRllfVVNFUicsIHtcbiAgICAgICAgdXNlcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICBldmVudDogJ3Byb2Nlc3NpbmdfY29tcGxldGVkJyxcbiAgICAgICAgZGF0YTogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBSSByZXNwb25zZSByZWNlaXZlZC4nLFxuICAgICAgICAgIHByb2dyZXNzaW9uOiBNT0NLX0FJX1JFU1BPTlNFLFxuICAgICAgICB9KSxcbiAgICAgIH0pXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgncHJvY2Vzc05hcnJhdGl2ZSAoRXJyb3IgSGFuZGxpbmcpJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIE5vdEZvdW5kRXhjZXB0aW9uIGFuZCBzZW5kIGZhaWx1cmUgdmlhIGdhdGV3YXknLCBhc3luYyAoKSA9PiB7XG4gICAgICBwcmlzbWFNb2NrLmdhbWUuZmluZFVuaXF1ZU9yVGhyb3cubW9ja1JlamVjdGVkVmFsdWUobmV3IE5vdEZvdW5kRXhjZXB0aW9uKCkpXG4gICAgICBhd2FpdCBzZXJ2aWNlLnByb2Nlc3NOYXJyYXRpdmUoTU9DS19QQVlMT0FEKVxuICAgICAgZXhwZWN0KGV2ZW50QnVzTW9jay5wdWJsaXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnTk9USUZZX1VTRVInLCB7XG4gICAgICAgIHVzZXJJZDogTU9DS19QQVlMT0FELnVzZXJJZCxcbiAgICAgICAgZXZlbnQ6ICdwcm9jZXNzaW5nX2ZhaWxlZCcsXG4gICAgICAgIGRhdGE6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBtZXNzYWdlOiAnQW4gZXJyb3Igb2NjdXJyZWQgZHVyaW5nIG5hcnJhdGl2ZSBnZW5lcmF0aW9uLicsXG4gICAgICAgICAgZXJyb3I6ICdOb3QgRm91bmQnLFxuICAgICAgICB9KSxcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIEFJIGVycm9yIGFuZCBzZW5kIGZhaWx1cmUgdmlhIGdhdGV3YXknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhaUVycm9yID0gbmV3IEFpR2VuZXJhdGlvbkV4Y2VwdGlvbignQUkgZmFpbGVkJylcbiAgICAgIHByaXNtYU1vY2suZ2FtZS5maW5kVW5pcXVlT3JUaHJvdy5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0dBTUVfU1RBVEUgYXMgbmV2ZXIpXG5cbiAgICAgIC8vIFvmoLjlv4Pkv67lpI1dIOWNs+S9v+WcqOWksei0peWcuuaZr+S4i++8jOaIkeS7rOS5n+imgeWFiOWRiuiviSBzY2hlZHVsZXJNb2NrIOivpeWBmuS7gOS5iFxuICAgICAgc2NoZWR1bGVyTW9jay5nZXRQcm92aWRlckZvclJvbGUubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBtb2RlbDogTU9DS19DSEFUX01PREVMLFxuICAgICAgfSlcbiAgICAgIHByb21wdE1hbmFnZXJNb2NrLmdldFByb21wdC5tb2NrUmV0dXJuVmFsdWUoJ0EgbW9jayBwcm9tcHQnKVxuXG4gICAgICAvLyDnhLblkI7vvIzmiJHku6zlho3mqKHmi58gQUkg6LCD55So5pys6Lqr5aSx6LSlXG4gICAgICBtb2NrZWRDYWxsQWlXaXRoR3VhcmQubW9ja1JlamVjdGVkVmFsdWVPbmNlKGFpRXJyb3IpXG5cbiAgICAgIGF3YWl0IHNlcnZpY2UucHJvY2Vzc05hcnJhdGl2ZShNT0NLX1BBWUxPQUQpXG5cbiAgICAgIGV4cGVjdChldmVudEJ1c01vY2sucHVibGlzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ05PVElGWV9VU0VSJywge1xuICAgICAgICB1c2VySWQ6IE1PQ0tfUEFZTE9BRC51c2VySWQsXG4gICAgICAgIGV2ZW50OiAncHJvY2Vzc2luZ19mYWlsZWQnLFxuICAgICAgICBkYXRhOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgbWVzc2FnZTogJ0FuIGVycm9yIG9jY3VycmVkIGR1cmluZyBuYXJyYXRpdmUgZ2VuZXJhdGlvbi4nLFxuICAgICAgICAgIGVycm9yOiAnQUkgZmFpbGVkJyxcbiAgICAgICAgfSksXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCBwcm9tcHRseSB3aGVuIHByb21wdCBpbmplY3Rpb24gZ3VhcmQgYmxvY2tzIGlucHV0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmNoZWNrSW5wdXQubW9ja1Jlc29sdmVkVmFsdWVPbmNlKHtcbiAgICAgICAgYWxsb3dlZDogZmFsc2UsXG4gICAgICAgIHNjb3JlOiAwLjk4LFxuICAgICAgICB0aHJlc2hvbGQ6IDAuNzUsXG4gICAgICAgIHJlYXNvbjogJ3RocmVzaG9sZC1leGNlZWRlZCcsXG4gICAgICAgIGlucHV0UHJldmlldzogJ21hbGljaW91cycsXG4gICAgICB9KVxuXG4gICAgICBhd2FpdCBzZXJ2aWNlLnByb2Nlc3NOYXJyYXRpdmUoTU9DS19QQVlMT0FEKVxuXG4gICAgICBleHBlY3QobW9ja2VkQ2FsbEFpV2l0aEd1YXJkKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgICBleHBlY3QoZXZlbnRCdXNNb2NrLnB1Ymxpc2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdOT1RJRllfVVNFUicsIHtcbiAgICAgICAgdXNlcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICBldmVudDogJ3Byb2Nlc3NpbmdfZmFpbGVkJyxcbiAgICAgICAgZGF0YTogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIG1lc3NhZ2U6ICdBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgbmFycmF0aXZlIGdlbmVyYXRpb24uJyxcbiAgICAgICAgfSksXG4gICAgICB9KVxuICAgIH0pXG4gIH0pXG59KVxuIl0sInZlcnNpb24iOjN9