2a54c19c8cf9070b9937510d1f9ed229
"use strict";
// 文件路径: apps/narrative-agent/src/narrative.service.ts (已优化 AI 调用链)
var __esDecorate = (this && this.__esDecorate) || function (ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {
    function accept(f) { if (f !== void 0 && typeof f !== "function") throw new TypeError("Function expected"); return f; }
    var kind = contextIn.kind, key = kind === "getter" ? "get" : kind === "setter" ? "set" : "value";
    var target = !descriptorIn && ctor ? contextIn["static"] ? ctor : ctor.prototype : null;
    var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});
    var _, done = false;
    for (var i = decorators.length - 1; i >= 0; i--) {
        var context = {};
        for (var p in contextIn) context[p] = p === "access" ? {} : contextIn[p];
        for (var p in contextIn.access) context.access[p] = contextIn.access[p];
        context.addInitializer = function (f) { if (done) throw new TypeError("Cannot add initializers after decoration has completed"); extraInitializers.push(accept(f || null)); };
        var result = (0, decorators[i])(kind === "accessor" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);
        if (kind === "accessor") {
            if (result === void 0) continue;
            if (result === null || typeof result !== "object") throw new TypeError("Object expected");
            if (_ = accept(result.get)) descriptor.get = _;
            if (_ = accept(result.set)) descriptor.set = _;
            if (_ = accept(result.init)) initializers.unshift(_);
        }
        else if (_ = accept(result)) {
            if (kind === "field") initializers.unshift(_);
            else descriptor[key] = _;
        }
    }
    if (target) Object.defineProperty(target, contextIn.name, descriptor);
    done = true;
};
var __runInitializers = (this && this.__runInitializers) || function (thisArg, initializers, value) {
    var useValue = arguments.length > 2;
    for (var i = 0; i < initializers.length; i++) {
        value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);
    }
    return useValue ? value : void 0;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NarrativeService = void 0;
const common_1 = require("@nestjs/common");
const common_backend_1 = require("@tuheg/common-backend");
const zod_1 = require("zod");
// --- Zod Schemas for AI I/O ---
// [!] 核心改造：合并 Synthesizer 和 Critic 的 Schema，因为它们的最终输出结构是一样的。
const progressionResponseSchema = zod_1.z.object({
    narrative: zod_1.z.string().describe('对玩家行动结果的生动叙事描述'),
    options: zod_1.z
        .array(zod_1.z.object({
        dimension: zod_1.z.string(),
        check: zod_1.z.string(),
        success_rate: zod_1.z.string(),
        text: zod_1.z.string(),
    }))
        .nullable(),
});
let NarrativeService = (() => {
    let _classDecorators = [(0, common_1.Injectable)()];
    let _classDescriptor;
    let _classExtraInitializers = [];
    let _classThis;
    var NarrativeService = class {
        static { _classThis = this; }
        static {
            const _metadata = typeof Symbol === "function" && Symbol.metadata ? Object.create(null) : void 0;
            __esDecorate(null, _classDescriptor = { value: _classThis }, _classDecorators, { kind: "class", name: _classThis.name, metadata: _metadata }, null, _classExtraInitializers);
            NarrativeService = _classThis = _classDescriptor.value;
            if (_metadata) Object.defineProperty(_classThis, Symbol.metadata, { enumerable: true, configurable: true, writable: true, value: _metadata });
            __runInitializers(_classThis, _classExtraInitializers);
        }
        scheduler;
        prisma;
        promptManager;
        eventBus;
        promptInjectionGuard;
        logger = new common_1.Logger(NarrativeService.name);
        constructor(scheduler, prisma, promptManager, eventBus, promptInjectionGuard) {
            this.scheduler = scheduler;
            this.prisma = prisma;
            this.promptManager = promptManager;
            this.eventBus = eventBus;
            this.promptInjectionGuard = promptInjectionGuard;
        }
        async processNarrative(payload) {
            this.logger.log(`Processing narrative for game ${payload.gameId}`);
            const pseudoUser = { id: payload.userId };
            try {
                // Security check: Validate input against prompt injection
                const securityCheck = await this.promptInjectionGuard.checkInput(JSON.stringify(payload.playerAction), {
                    userId: payload.userId,
                });
                if (!securityCheck.allowed) {
                    throw new common_backend_1.PromptInjectionDetectedException('Input failed security validation', {
                        score: securityCheck.score,
                        threshold: securityCheck.threshold,
                        preview: securityCheck.inputPreview,
                    });
                }
                const gameState = await this.prisma.game.findUniqueOrThrow({
                    where: { id: payload.gameId },
                    include: { character: true, worldBook: true },
                });
                // [!] 核心改造：默认流程简化为单次 AI 调用
                // 我们直接调用“叙事合成器”，并相信它在大多数情况下能产出足够好的结果。
                const finalProgression = await this.synthesizeNarrative(gameState, payload.playerAction, pseudoUser);
                this.logger.log(`[Synthesizer] Generated final progression for game ${payload.gameId}.`);
                // [!] 核心改造：注释掉并保留审查家（Critic）的调用逻辑，以备将来使用。
                // 未来的优化可以在这里加入一个判断逻辑，例如：
                // if (this.needsCriticReview(finalProgression, gameState)) {
                //   this.logger.log(`[Critic] Draft requires review. Engaging Critic Agent...`);
                //   finalProgression = await this.reviewWithCritic(...);
                // }
                // const draft = await this.synthesizeNarrative(
                //   gameState,
                //   payload.playerAction,
                //   pseudoUser,
                // );
                // this.logger.log(`[Synthesizer] Generated draft for game ${payload.gameId}.`);
                // const finalProgression = await this.reviewWithCritic(
                //   gameState,
                //   payload.playerAction,
                //   draft,
                //   pseudoUser,
                // );
                // this.logger.log(`[Critic] Reviewed and finalized progression for game ${payload.gameId}.`);
                // [安全修复] 验证AI生成的叙事内容
                this.validateProgressionResponse(finalProgression);
                // 发送最终结果的逻辑保持不变
                await this.eventBus.publish('NOTIFY_USER', {
                    userId: payload.userId,
                    event: 'processing_completed',
                    data: {
                        message: 'AI response received.',
                        progression: finalProgression,
                    },
                });
                this.logger.log(`Successfully sent final narrative to user ${payload.userId} via event bus.`);
            }
            catch (error) {
                let errorMessage = 'An unknown error occurred in narrative processing';
                if (error instanceof Error) {
                    errorMessage = error instanceof Error ? error instanceof Error ? error.message : String(error) : String(error);
                }
                this.logger.error(`Failed to process narrative for game ${payload.gameId}: ${errorMessage}`, error instanceof Error ? error.stack : undefined, error instanceof common_backend_1.AiGenerationException ? error.details : undefined);
                try {
                    await this.eventBus.publish('NOTIFY_USER', {
                        userId: payload.userId,
                        event: 'processing_failed',
                        data: {
                            message: 'An error occurred during narrative generation.',
                            error: errorMessage,
                        },
                    });
                }
                catch (eventBusError) {
                    this.logger.error('CRITICAL: Failed to even send the error message via event bus.', eventBusError);
                }
            }
        }
        /**
         * 专门用于在所有重试都失败后的最终失败通知
         * 这个方法确保即使消息被发送到DLQ，用户也能收到失败通知
         */
        async notifyNarrativeFailure(userId, gameId, error) {
            let errorMessage = 'An unknown error occurred during narrative processing';
            if (error instanceof Error) {
                errorMessage = error instanceof Error ? error instanceof Error ? error.message : String(error) : String(error);
            }
            try {
                await this.eventBus.publish('NOTIFY_USER', {
                    userId: userId,
                    event: 'processing_failed',
                    data: {
                        message: 'Failed to process narrative after all retry attempts.',
                        error: errorMessage,
                        gameId: gameId,
                        finalFailure: true, // 标记这是最终失败，不再重试
                    },
                });
                this.logger.log(`Sent final narrative failure notification to user ${userId} for game ${gameId}`);
            }
            catch (eventBusError) {
                this.logger.error(`CRITICAL: Failed to send final narrative failure notification to user ${userId} for game ${gameId}`, eventBusError);
            }
        }
        // --- AI Agent Methods ---
        /**
         * 叙事合成器 (Synthesizer)
         * [!] 核心改造：此方法现在负责直接生成最终结果。
         */
        async synthesizeNarrative(currentState, playerAction, user) {
            const provider = await this.scheduler.getProviderForRole(user, 'narrative_synthesis');
            // [!] 核心改造：我们现在使用一个更全面的 Prompt，期望它能一步到位产出高质量内容。
            // 在旧代码中，这里使用的是 '00_persona_and_framework.md'，现在改为 '02_narrative_engine.md'
            const systemPrompt = this.promptManager.getPrompt('02_narrative_engine.md');
            // 构造完整的提示文本
            const prompt = `${systemPrompt}\n# 渲染任务\n你的任务是根据世界状态和玩家行动，生成一段叙事和后续选项。\n请返回JSON格式的响应，包含narration和options字段。\n---\n当前世界状态:\n\`\`\`json\n${JSON.stringify(currentState)}\n\`\`\`\n---\n玩家行动:\n\`\`\`json\n${JSON.stringify(playerAction)}\n\`\`\``;
            return (0, common_backend_1.callAiWithGuard)(provider, prompt, progressionResponseSchema, 40000 // 40秒超时，叙事生成任务适中复杂度
            );
        }
        /**
         * [安全修复] 验证AI生成的叙事响应内容
         * 防止AI生成过长或包含恶意内容的叙事文本
         */
        validateProgressionResponse(response) {
            // 验证叙事文本长度
            const maxNarrativeLength = 10000; // 10KB上限
            if (response.narrative.length > maxNarrativeLength) {
                throw new Error(`Generated narrative is too long: ${response.narrative.length} characters (max: ${maxNarrativeLength})`);
            }
            // 验证叙事文本是否包含恶意内容
            this.validateTextContent(response.narrative, 'narrative');
            // 验证选项（如果存在）
            if (response.options) {
                const maxOptions = 10; // 最大选项数量
                if (response.options.length > maxOptions) {
                    throw new Error(`Too many options generated: ${response.options.length} (max: ${maxOptions})`);
                }
                for (const option of response.options) {
                    // 验证每个选项字段的长度
                    if (option.text.length > 500) {
                        throw new Error(`Option text is too long: ${option.text.length} characters (max: 500)`);
                    }
                    // 验证选项文本是否包含恶意内容
                    this.validateTextContent(option.text, 'option text');
                }
            }
        }
        /**
         * [安全修复] 验证文本内容是否包含潜在的恶意内容
         */
        validateTextContent(text, fieldName) {
            // 检查是否包含潜在的恶意内容
            const suspiciousPatterns = [
                /<script/i,
                /javascript:/i,
                /on\w+\s*=/i,
                /<iframe/i,
                /<object/i,
                /<embed/i,
                /<link/i,
                /<meta/i,
                /<style/i,
            ];
            for (const pattern of suspiciousPatterns) {
                if (pattern.test(text)) {
                    throw new Error(`${fieldName} contains potentially malicious content: ${text.substring(0, 50)}...`);
                }
            }
        }
    };
    return NarrativeService = _classThis;
})();
exports.NarrativeService = NarrativeService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXG5hcnJhdGl2ZS1hZ2VudFxcc3JjXFxuYXJyYXRpdmUuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiO0FBQUEsbUVBQW1FOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBSW5FLDJDQUFtRDtBQUVuRCwwREFVOEI7QUFDOUIsNkJBQXVCO0FBRXZCLGlDQUFpQztBQUVqQyw2REFBNkQ7QUFDN0QsTUFBTSx5QkFBeUIsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3pDLFNBQVMsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDO0lBQ2hELE9BQU8sRUFBRSxPQUFDO1NBQ1AsS0FBSyxDQUNKLE9BQUMsQ0FBQyxNQUFNLENBQUM7UUFDUCxTQUFTLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRTtRQUNyQixLQUFLLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRTtRQUNqQixZQUFZLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRTtRQUN4QixJQUFJLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRTtLQUNqQixDQUFDLENBQ0g7U0FDQSxRQUFRLEVBQUU7Q0FDZCxDQUFDLENBQUE7SUFJVyxnQkFBZ0I7NEJBRDVCLElBQUEsbUJBQVUsR0FBRTs7Ozs7Ozs7WUFDYiw2S0F5T0M7OztZQXpPWSx1REFBZ0I7O1FBSVIsU0FBUztRQUNULE1BQU07UUFDTixhQUFhO1FBQ2IsUUFBUTtRQUNSLG9CQUFvQjtRQVB0QixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFM0QsWUFDbUIsU0FBb0MsRUFDcEMsTUFBcUIsRUFDckIsYUFBbUMsRUFDbkMsUUFBeUIsRUFDekIsb0JBQTBDO1lBSjFDLGNBQVMsR0FBVCxTQUFTLENBQTJCO1lBQ3BDLFdBQU0sR0FBTixNQUFNLENBQWU7WUFDckIsa0JBQWEsR0FBYixhQUFhLENBQXNCO1lB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RCxpQkFBaUI7b0JBQ2pCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFBO2dCQUN0RCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFFRDs7V0FFRztRQUNLLG1CQUFtQixDQUFDLElBQVksRUFBRSxTQUFpQjtZQUN6RCxnQkFBZ0I7WUFDaEIsTUFBTSxrQkFBa0IsR0FBRztnQkFDekIsVUFBVTtnQkFDVixjQUFjO2dCQUNkLFlBQVk7Z0JBQ1osVUFBVTtnQkFDVixVQUFVO2dCQUNWLFNBQVM7Z0JBQ1QsUUFBUTtnQkFDUixRQUFRO2dCQUNSLFNBQVM7YUFDVixDQUFBO1lBRUQsS0FBSyxNQUFNLE9BQU8sSUFBSSxrQkFBa0IsRUFBRSxDQUFDO2dCQUN6QyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztvQkFDdkIsTUFBTSxJQUFJLEtBQUssQ0FDYixHQUFHLFNBQVMsNENBQTRDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQ25GLENBQUE7Z0JBQ0gsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDOzs7O0FBeE9VLDRDQUFnQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xcYXBwc1xcbmFycmF0aXZlLWFnZW50XFxzcmNcXG5hcnJhdGl2ZS5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogYXBwcy9uYXJyYXRpdmUtYWdlbnQvc3JjL25hcnJhdGl2ZS5zZXJ2aWNlLnRzICjlt7LkvJjljJYgQUkg6LCD55So6ZO+KVxuXG5pbXBvcnQgeyBTdHJ1Y3R1cmVkT3V0cHV0UGFyc2VyIH0gZnJvbSAnQGxhbmdjaGFpbi9jb3JlL291dHB1dF9wYXJzZXJzJ1xuaW1wb3J0IHsgUHJvbXB0VGVtcGxhdGUgfSBmcm9tICdAbGFuZ2NoYWluL2NvcmUvcHJvbXB0cydcbmltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJ1xuaW1wb3J0IHR5cGUgeyBVc2VyIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQge1xuICBBaUdlbmVyYXRpb25FeGNlcHRpb24sXG4gIGNhbGxBaVdpdGhHdWFyZCxcbiAgdHlwZSBEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlLFxuICB0eXBlIEV2ZW50QnVzU2VydmljZSxcbiAgdHlwZSBMb2dpY0NvbXBsZXRlUGF5bG9hZCxcbiAgdHlwZSBQcmlzbWFTZXJ2aWNlLFxuICBQcm9tcHRJbmplY3Rpb25EZXRlY3RlZEV4Y2VwdGlvbixcbiAgdHlwZSBQcm9tcHRJbmplY3Rpb25HdWFyZCxcbiAgdHlwZSBQcm9tcHRNYW5hZ2VyU2VydmljZSxcbn0gZnJvbSAnQHR1aGVnL2NvbW1vbi1iYWNrZW5kJ1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCdcblxuLy8gLS0tIFpvZCBTY2hlbWFzIGZvciBBSSBJL08gLS0tXG5cbi8vIFshXSDmoLjlv4PmlLnpgKDvvJrlkIjlubYgU3ludGhlc2l6ZXIg5ZKMIENyaXRpYyDnmoQgU2NoZW1h77yM5Zug5Li65a6D5Lus55qE5pyA57uI6L6T5Ye657uT5p6E5piv5LiA5qC355qE44CCXG5jb25zdCBwcm9ncmVzc2lvblJlc3BvbnNlU2NoZW1hID0gei5vYmplY3Qoe1xuICBuYXJyYXRpdmU6IHouc3RyaW5nKCkuZGVzY3JpYmUoJ+WvueeOqeWutuihjOWKqOe7k+aenOeahOeUn+WKqOWPmeS6i+aPj+i/sCcpLFxuICBvcHRpb25zOiB6XG4gICAgLmFycmF5KFxuICAgICAgei5vYmplY3Qoe1xuICAgICAgICBkaW1lbnNpb246IHouc3RyaW5nKCksXG4gICAgICAgIGNoZWNrOiB6LnN0cmluZygpLFxuICAgICAgICBzdWNjZXNzX3JhdGU6IHouc3RyaW5nKCksXG4gICAgICAgIHRleHQ6IHouc3RyaW5nKCksXG4gICAgICB9KVxuICAgIClcbiAgICAubnVsbGFibGUoKSxcbn0pXG50eXBlIFByb2dyZXNzaW9uUmVzcG9uc2UgPSB6LmluZmVyPHR5cGVvZiBwcm9ncmVzc2lvblJlc3BvbnNlU2NoZW1hPlxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTmFycmF0aXZlU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihOYXJyYXRpdmVTZXJ2aWNlLm5hbWUpXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBzY2hlZHVsZXI6IER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9tcHRNYW5hZ2VyOiBQcm9tcHRNYW5hZ2VyU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50QnVzOiBFdmVudEJ1c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9tcHRJbmplY3Rpb25HdWFyZDogUHJvbXB0SW5qZWN0aW9uR3VhcmRcbiAgKSB7fVxuXG4gIHB1YmxpYyBhc3luYyBwcm9jZXNzTmFycmF0aXZlKHBheWxvYWQ6IExvZ2ljQ29tcGxldGVQYXlsb2FkKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5sb2dnZXIubG9nKGBQcm9jZXNzaW5nIG5hcnJhdGl2ZSBmb3IgZ2FtZSAke3BheWxvYWQuZ2FtZUlkfWApXG4gICAgY29uc3QgcHNldWRvVXNlciA9IHsgaWQ6IHBheWxvYWQudXNlcklkIH0gYXMgVXNlclxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFNlY3VyaXR5IGNoZWNrOiBWYWxpZGF0ZSBpbnB1dCBhZ2FpbnN0IHByb21wdCBpbmplY3Rpb25cbiAgICAgIGNvbnN0IHNlY3VyaXR5Q2hlY2sgPSBhd2FpdCB0aGlzLnByb21wdEluamVjdGlvbkd1YXJkLmNoZWNrSW5wdXQoXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHBheWxvYWQucGxheWVyQWN0aW9uKSxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJJZDogcGF5bG9hZC51c2VySWQsXG4gICAgICAgIH1cbiAgICAgIClcblxuICAgICAgaWYgKCFzZWN1cml0eUNoZWNrLmFsbG93ZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IFByb21wdEluamVjdGlvbkRldGVjdGVkRXhjZXB0aW9uKCdJbnB1dCBmYWlsZWQgc2VjdXJpdHkgdmFsaWRhdGlvbicsIHtcbiAgICAgICAgICBzY29yZTogc2VjdXJpdHlDaGVjay5zY29yZSxcbiAgICAgICAgICB0aHJlc2hvbGQ6IHNlY3VyaXR5Q2hlY2sudGhyZXNob2xkLFxuICAgICAgICAgIHByZXZpZXc6IHNlY3VyaXR5Q2hlY2suaW5wdXRQcmV2aWV3LFxuICAgICAgICB9KVxuICAgICAgfVxuXG4gICAgICBjb25zdCBnYW1lU3RhdGUgPSBhd2FpdCB0aGlzLnByaXNtYS5nYW1lLmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHBheWxvYWQuZ2FtZUlkIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgY2hhcmFjdGVyOiB0cnVlLCB3b3JsZEJvb2s6IHRydWUgfSxcbiAgICAgIH0pXG5cbiAgICAgIC8vIFshXSDmoLjlv4PmlLnpgKDvvJrpu5jorqTmtYHnqIvnroDljJbkuLrljZXmrKEgQUkg6LCD55SoXG4gICAgICAvLyDmiJHku6znm7TmjqXosIPnlKjigJzlj5nkuovlkIjmiJDlmajigJ3vvIzlubbnm7jkv6HlroPlnKjlpKflpJrmlbDmg4XlhrXkuIvog73kuqflh7rotrPlpJ/lpb3nmoTnu5PmnpzjgIJcbiAgICAgIGNvbnN0IGZpbmFsUHJvZ3Jlc3Npb24gPSBhd2FpdCB0aGlzLnN5bnRoZXNpemVOYXJyYXRpdmUoXG4gICAgICAgIGdhbWVTdGF0ZSxcbiAgICAgICAgcGF5bG9hZC5wbGF5ZXJBY3Rpb24sXG4gICAgICAgIHBzZXVkb1VzZXJcbiAgICAgIClcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgW1N5bnRoZXNpemVyXSBHZW5lcmF0ZWQgZmluYWwgcHJvZ3Jlc3Npb24gZm9yIGdhbWUgJHtwYXlsb2FkLmdhbWVJZH0uYClcblxuICAgICAgLy8gWyFdIOaguOW/g+aUuemAoO+8muazqOmHiuaOieW5tuS/neeVmeWuoeafpeWutu+8iENyaXRpY++8ieeahOiwg+eUqOmAu+i+ke+8jOS7peWkh+WwhuadpeS9v+eUqOOAglxuICAgICAgLy8g5pyq5p2l55qE5LyY5YyW5Y+v5Lul5Zyo6L+Z6YeM5Yqg5YWl5LiA5Liq5Yik5pat6YC76L6R77yM5L6L5aaC77yaXG4gICAgICAvLyBpZiAodGhpcy5uZWVkc0NyaXRpY1JldmlldyhmaW5hbFByb2dyZXNzaW9uLCBnYW1lU3RhdGUpKSB7XG4gICAgICAvLyAgIHRoaXMubG9nZ2VyLmxvZyhgW0NyaXRpY10gRHJhZnQgcmVxdWlyZXMgcmV2aWV3LiBFbmdhZ2luZyBDcml0aWMgQWdlbnQuLi5gKTtcbiAgICAgIC8vICAgZmluYWxQcm9ncmVzc2lvbiA9IGF3YWl0IHRoaXMucmV2aWV3V2l0aENyaXRpYyguLi4pO1xuICAgICAgLy8gfVxuXG4gICAgICAvLyBjb25zdCBkcmFmdCA9IGF3YWl0IHRoaXMuc3ludGhlc2l6ZU5hcnJhdGl2ZShcbiAgICAgIC8vICAgZ2FtZVN0YXRlLFxuICAgICAgLy8gICBwYXlsb2FkLnBsYXllckFjdGlvbixcbiAgICAgIC8vICAgcHNldWRvVXNlcixcbiAgICAgIC8vICk7XG4gICAgICAvLyB0aGlzLmxvZ2dlci5sb2coYFtTeW50aGVzaXplcl0gR2VuZXJhdGVkIGRyYWZ0IGZvciBnYW1lICR7cGF5bG9hZC5nYW1lSWR9LmApO1xuICAgICAgLy8gY29uc3QgZmluYWxQcm9ncmVzc2lvbiA9IGF3YWl0IHRoaXMucmV2aWV3V2l0aENyaXRpYyhcbiAgICAgIC8vICAgZ2FtZVN0YXRlLFxuICAgICAgLy8gICBwYXlsb2FkLnBsYXllckFjdGlvbixcbiAgICAgIC8vICAgZHJhZnQsXG4gICAgICAvLyAgIHBzZXVkb1VzZXIsXG4gICAgICAvLyApO1xuICAgICAgLy8gdGhpcy5sb2dnZXIubG9nKGBbQ3JpdGljXSBSZXZpZXdlZCBhbmQgZmluYWxpemVkIHByb2dyZXNzaW9uIGZvciBnYW1lICR7cGF5bG9hZC5nYW1lSWR9LmApO1xuXG4gICAgICAvLyBb5a6J5YWo5L+u5aSNXSDpqozor4FBSeeUn+aIkOeahOWPmeS6i+WGheWuuVxuICAgICAgdGhpcy52YWxpZGF0ZVByb2dyZXNzaW9uUmVzcG9uc2UoZmluYWxQcm9ncmVzc2lvbilcblxuICAgICAgLy8g5Y+R6YCB5pyA57uI57uT5p6c55qE6YC76L6R5L+d5oyB5LiN5Y+YXG4gICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLnB1Ymxpc2goJ05PVElGWV9VU0VSJywge1xuICAgICAgICB1c2VySWQ6IHBheWxvYWQudXNlcklkLFxuICAgICAgICBldmVudDogJ3Byb2Nlc3NpbmdfY29tcGxldGVkJyxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIG1lc3NhZ2U6ICdBSSByZXNwb25zZSByZWNlaXZlZC4nLFxuICAgICAgICAgIHByb2dyZXNzaW9uOiBmaW5hbFByb2dyZXNzaW9uLFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgU3VjY2Vzc2Z1bGx5IHNlbnQgZmluYWwgbmFycmF0aXZlIHRvIHVzZXIgJHtwYXlsb2FkLnVzZXJJZH0gdmlhIGV2ZW50IGJ1cy5gKVxuICAgIH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG4gICAgICBsZXQgZXJyb3JNZXNzYWdlID0gJ0FuIHVua25vd24gZXJyb3Igb2NjdXJyZWQgaW4gbmFycmF0aXZlIHByb2Nlc3NpbmcnXG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICBlcnJvck1lc3NhZ2UgPSBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpIDogU3RyaW5nKGVycm9yKVxuICAgICAgfVxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gcHJvY2VzcyBuYXJyYXRpdmUgZm9yIGdhbWUgJHtwYXlsb2FkLmdhbWVJZH06ICR7ZXJyb3JNZXNzYWdlfWAsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBBaUdlbmVyYXRpb25FeGNlcHRpb24gPyBlcnJvci5kZXRhaWxzIDogdW5kZWZpbmVkXG4gICAgICApXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLnB1Ymxpc2goJ05PVElGWV9VU0VSJywge1xuICAgICAgICAgIHVzZXJJZDogcGF5bG9hZC51c2VySWQsXG4gICAgICAgICAgZXZlbnQ6ICdwcm9jZXNzaW5nX2ZhaWxlZCcsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgbWVzc2FnZTogJ0FuIGVycm9yIG9jY3VycmVkIGR1cmluZyBuYXJyYXRpdmUgZ2VuZXJhdGlvbi4nLFxuICAgICAgICAgICAgZXJyb3I6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgICAgfSBjYXRjaCAoZXZlbnRCdXNFcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAnQ1JJVElDQUw6IEZhaWxlZCB0byBldmVuIHNlbmQgdGhlIGVycm9yIG1lc3NhZ2UgdmlhIGV2ZW50IGJ1cy4nLFxuICAgICAgICAgIGV2ZW50QnVzRXJyb3JcbiAgICAgICAgKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDkuJPpl6jnlKjkuo7lnKjmiYDmnInph43or5Xpg73lpLHotKXlkI7nmoTmnIDnu4jlpLHotKXpgJrnn6VcbiAgICog6L+Z5Liq5pa55rOV56Gu5L+d5Y2z5L2/5raI5oGv6KKr5Y+R6YCB5YiwRExR77yM55So5oi35Lmf6IO95pS25Yiw5aSx6LSl6YCa55+lXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgbm90aWZ5TmFycmF0aXZlRmFpbHVyZShcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBnYW1lSWQ6IHN0cmluZyxcbiAgICBlcnJvcjogdW5rbm93blxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBsZXQgZXJyb3JNZXNzYWdlID0gJ0FuIHVua25vd24gZXJyb3Igb2NjdXJyZWQgZHVyaW5nIG5hcnJhdGl2ZSBwcm9jZXNzaW5nJ1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICBlcnJvck1lc3NhZ2UgPSBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpIDogU3RyaW5nKGVycm9yKVxuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLnB1Ymxpc2goJ05PVElGWV9VU0VSJywge1xuICAgICAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICAgICAgZXZlbnQ6ICdwcm9jZXNzaW5nX2ZhaWxlZCcsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIHByb2Nlc3MgbmFycmF0aXZlIGFmdGVyIGFsbCByZXRyeSBhdHRlbXB0cy4nLFxuICAgICAgICAgIGVycm9yOiBlcnJvck1lc3NhZ2UsXG4gICAgICAgICAgZ2FtZUlkOiBnYW1lSWQsXG4gICAgICAgICAgZmluYWxGYWlsdXJlOiB0cnVlLCAvLyDmoIforrDov5nmmK/mnIDnu4jlpLHotKXvvIzkuI3lho3ph43or5VcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBTZW50IGZpbmFsIG5hcnJhdGl2ZSBmYWlsdXJlIG5vdGlmaWNhdGlvbiB0byB1c2VyICR7dXNlcklkfSBmb3IgZ2FtZSAke2dhbWVJZH1gXG4gICAgICApXG4gICAgfSBjYXRjaCAoZXZlbnRCdXNFcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBDUklUSUNBTDogRmFpbGVkIHRvIHNlbmQgZmluYWwgbmFycmF0aXZlIGZhaWx1cmUgbm90aWZpY2F0aW9uIHRvIHVzZXIgJHt1c2VySWR9IGZvciBnYW1lICR7Z2FtZUlkfWAsXG4gICAgICAgIGV2ZW50QnVzRXJyb3JcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICAvLyAtLS0gQUkgQWdlbnQgTWV0aG9kcyAtLS1cblxuICAvKipcbiAgICog5Y+Z5LqL5ZCI5oiQ5ZmoIChTeW50aGVzaXplcilcbiAgICogWyFdIOaguOW/g+aUuemAoO+8muatpOaWueazleeOsOWcqOi0n+i0o+ebtOaOpeeUn+aIkOacgOe7iOe7k+aenOOAglxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBzeW50aGVzaXplTmFycmF0aXZlKFxuICAgIGN1cnJlbnRTdGF0ZTogb2JqZWN0LFxuICAgIHBsYXllckFjdGlvbjogdW5rbm93bixcbiAgICB1c2VyOiBVc2VyXG4gICk6IFByb21pc2U8UHJvZ3Jlc3Npb25SZXNwb25zZT4ge1xuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgdGhpcy5zY2hlZHVsZXIuZ2V0UHJvdmlkZXJGb3JSb2xlKHVzZXIsICduYXJyYXRpdmVfc3ludGhlc2lzJylcbiAgICAvLyBbIV0g5qC45b+D5pS56YCg77ya5oiR5Lus546w5Zyo5L2/55So5LiA5Liq5pu05YWo6Z2i55qEIFByb21wdO+8jOacn+acm+Wug+iDveS4gOatpeWIsOS9jeS6p+WHuumrmOi0qOmHj+WGheWuueOAglxuICAgIC8vIOWcqOaXp+S7o+eggeS4re+8jOi/memHjOS9v+eUqOeahOaYryAnMDBfcGVyc29uYV9hbmRfZnJhbWV3b3JrLm1kJ++8jOeOsOWcqOaUueS4uiAnMDJfbmFycmF0aXZlX2VuZ2luZS5tZCdcbiAgICBjb25zdCBzeXN0ZW1Qcm9tcHQgPSB0aGlzLnByb21wdE1hbmFnZXIuZ2V0UHJvbXB0KCcwMl9uYXJyYXRpdmVfZW5naW5lLm1kJylcblxuICAgIC8vIOaehOmAoOWujOaVtOeahOaPkOekuuaWh+acrFxuICAgIGNvbnN0IHByb21wdCA9IGAke3N5c3RlbVByb21wdH1cXG4jIOa4suafk+S7u+WKoVxcbuS9oOeahOS7u+WKoeaYr+agueaNruS4lueVjOeKtuaAgeWSjOeOqeWutuihjOWKqO+8jOeUn+aIkOS4gOauteWPmeS6i+WSjOWQjue7remAiemhueOAglxcbuivt+i/lOWbnkpTT07moLzlvI/nmoTlk43lupTvvIzljIXlkKtuYXJyYXRpb27lkoxvcHRpb25z5a2X5q6144CCXFxuLS0tXFxu5b2T5YmN5LiW55WM54q25oCBOlxcblxcYFxcYFxcYGpzb25cXG4ke0pTT04uc3RyaW5naWZ5KGN1cnJlbnRTdGF0ZSl9XFxuXFxgXFxgXFxgXFxuLS0tXFxu546p5a626KGM5YqoOlxcblxcYFxcYFxcYGpzb25cXG4ke0pTT04uc3RyaW5naWZ5KHBsYXllckFjdGlvbil9XFxuXFxgXFxgXFxgYFxuXG4gICAgcmV0dXJuIGNhbGxBaVdpdGhHdWFyZChcbiAgICAgIHByb3ZpZGVyLFxuICAgICAgcHJvbXB0LFxuICAgICAgcHJvZ3Jlc3Npb25SZXNwb25zZVNjaGVtYSxcbiAgICAgIDQwMDAwIC8vIDQw56eS6LaF5pe277yM5Y+Z5LqL55Sf5oiQ5Lu75Yqh6YCC5Lit5aSN5p2C5bqmXG4gICAgKVxuICB9XG5cbiAgLyoqXG4gICAqIFvlronlhajkv67lpI1dIOmqjOivgUFJ55Sf5oiQ55qE5Y+Z5LqL5ZON5bqU5YaF5a65XG4gICAqIOmYsuatokFJ55Sf5oiQ6L+H6ZW/5oiW5YyF5ZCr5oG25oSP5YaF5a6555qE5Y+Z5LqL5paH5pysXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlUHJvZ3Jlc3Npb25SZXNwb25zZShyZXNwb25zZTogUHJvZ3Jlc3Npb25SZXNwb25zZSk6IHZvaWQge1xuICAgIC8vIOmqjOivgeWPmeS6i+aWh+acrOmVv+W6plxuICAgIGNvbnN0IG1heE5hcnJhdGl2ZUxlbmd0aCA9IDEwMDAwIC8vIDEwS0LkuIrpmZBcbiAgICBpZiAocmVzcG9uc2UubmFycmF0aXZlLmxlbmd0aCA+IG1heE5hcnJhdGl2ZUxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgR2VuZXJhdGVkIG5hcnJhdGl2ZSBpcyB0b28gbG9uZzogJHtyZXNwb25zZS5uYXJyYXRpdmUubGVuZ3RofSBjaGFyYWN0ZXJzIChtYXg6ICR7bWF4TmFycmF0aXZlTGVuZ3RofSlgXG4gICAgICApXG4gICAgfVxuXG4gICAgLy8g6aqM6K+B5Y+Z5LqL5paH5pys5piv5ZCm5YyF5ZCr5oG25oSP5YaF5a65XG4gICAgdGhpcy52YWxpZGF0ZVRleHRDb250ZW50KHJlc3BvbnNlLm5hcnJhdGl2ZSwgJ25hcnJhdGl2ZScpXG5cbiAgICAvLyDpqozor4HpgInpobnvvIjlpoLmnpzlrZjlnKjvvIlcbiAgICBpZiAocmVzcG9uc2Uub3B0aW9ucykge1xuICAgICAgY29uc3QgbWF4T3B0aW9ucyA9IDEwIC8vIOacgOWkp+mAiemhueaVsOmHj1xuICAgICAgaWYgKHJlc3BvbnNlLm9wdGlvbnMubGVuZ3RoID4gbWF4T3B0aW9ucykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYFRvbyBtYW55IG9wdGlvbnMgZ2VuZXJhdGVkOiAke3Jlc3BvbnNlLm9wdGlvbnMubGVuZ3RofSAobWF4OiAke21heE9wdGlvbnN9KWBcbiAgICAgICAgKVxuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IG9wdGlvbiBvZiByZXNwb25zZS5vcHRpb25zKSB7XG4gICAgICAgIC8vIOmqjOivgeavj+S4qumAiemhueWtl+auteeahOmVv+W6plxuICAgICAgICBpZiAob3B0aW9uLnRleHQubGVuZ3RoID4gNTAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gdGV4dCBpcyB0b28gbG9uZzogJHtvcHRpb24udGV4dC5sZW5ndGh9IGNoYXJhY3RlcnMgKG1heDogNTAwKWApXG4gICAgICAgIH1cblxuICAgICAgICAvLyDpqozor4HpgInpobnmlofmnKzmmK/lkKbljIXlkKvmgbbmhI/lhoXlrrlcbiAgICAgICAgdGhpcy52YWxpZGF0ZVRleHRDb250ZW50KG9wdGlvbi50ZXh0LCAnb3B0aW9uIHRleHQnKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBb5a6J5YWo5L+u5aSNXSDpqozor4HmlofmnKzlhoXlrrnmmK/lkKbljIXlkKvmvZzlnKjnmoTmgbbmhI/lhoXlrrlcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVUZXh0Q29udGVudCh0ZXh0OiBzdHJpbmcsIGZpZWxkTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgLy8g5qOA5p+l5piv5ZCm5YyF5ZCr5r2c5Zyo55qE5oG25oSP5YaF5a65XG4gICAgY29uc3Qgc3VzcGljaW91c1BhdHRlcm5zID0gW1xuICAgICAgLzxzY3JpcHQvaSxcbiAgICAgIC9qYXZhc2NyaXB0Oi9pLFxuICAgICAgL29uXFx3K1xccyo9L2ksXG4gICAgICAvPGlmcmFtZS9pLFxuICAgICAgLzxvYmplY3QvaSxcbiAgICAgIC88ZW1iZWQvaSxcbiAgICAgIC88bGluay9pLFxuICAgICAgLzxtZXRhL2ksXG4gICAgICAvPHN0eWxlL2ksXG4gICAgXVxuXG4gICAgZm9yIChjb25zdCBwYXR0ZXJuIG9mIHN1c3BpY2lvdXNQYXR0ZXJucykge1xuICAgICAgaWYgKHBhdHRlcm4udGVzdCh0ZXh0KSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYCR7ZmllbGROYW1lfSBjb250YWlucyBwb3RlbnRpYWxseSBtYWxpY2lvdXMgY29udGVudDogJHt0ZXh0LnN1YnN0cmluZygwLCA1MCl9Li4uYFxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=