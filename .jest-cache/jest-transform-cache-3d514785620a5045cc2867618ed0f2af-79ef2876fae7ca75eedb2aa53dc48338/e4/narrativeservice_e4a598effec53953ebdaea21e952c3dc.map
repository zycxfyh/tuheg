{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\narrative-agent\\src\\narrative.service.ts","mappings":";AAAA,mEAAmE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAInE,2CAAmD;AAEnD,0DAU8B;AAC9B,6BAAuB;AAEvB,iCAAiC;AAEjC,6DAA6D;AAC7D,MAAM,yBAAyB,GAAG,OAAC,CAAC,MAAM,CAAC;IACzC,SAAS,EAAE,OAAC,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,gBAAgB,CAAC;IAChD,OAAO,EAAE,OAAC;SACP,KAAK,CACJ,OAAC,CAAC,MAAM,CAAC;QACP,SAAS,EAAE,OAAC,CAAC,MAAM,EAAE;QACrB,KAAK,EAAE,OAAC,CAAC,MAAM,EAAE;QACjB,YAAY,EAAE,OAAC,CAAC,MAAM,EAAE;QACxB,IAAI,EAAE,OAAC,CAAC,MAAM,EAAE;KACjB,CAAC,CACH;SACA,QAAQ,EAAE;CACd,CAAC,CAAA;IAIW,gBAAgB;4BAD5B,IAAA,mBAAU,GAAE;;;;;;;;YACb,6KAyOC;;;YAzOY,uDAAgB;;QAIR,SAAS;QACT,MAAM;QACN,aAAa;QACb,QAAQ;QACR,oBAAoB;QAPtB,MAAM,GAAG,IAAI,eAAM,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAA;QAE3D,YACmB,SAAoC,EACpC,MAAqB,EACrB,aAAmC,EACnC,QAAyB,EACzB,oBAA0C;YAJ1C,cAAS,GAAT,SAAS,CAA2B;YACpC,WAAM,GAAN,MAAM,CAAe;YACrB,kBAAa,GAAb,aAAa,CAAsB;YACnC,aAAQ,GAAR,QAAQ,CAAiB;YACzB,yBAAoB,GAApB,oBAAoB,CAAsB;QAC1D,CAAC;QAEG,KAAK,CAAC,gBAAgB,CAAC,OAA6B;YACzD,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,iCAAiC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAA;YAClE,MAAM,UAAU,GAAG,EAAE,EAAE,EAAE,OAAO,CAAC,MAAM,EAAU,CAAA;YAEjD,IAAI,CAAC;gBACH,0DAA0D;gBAC1D,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,oBAAoB,CAAC,UAAU,CAC9D,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,YAAY,CAAC,EACpC;oBACE,MAAM,EAAE,OAAO,CAAC,MAAM;iBACvB,CACF,CAAA;gBAED,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,CAAC;oBAC3B,MAAM,IAAI,iDAAgC,CAAC,kCAAkC,EAAE;wBAC7E,KAAK,EAAE,aAAa,CAAC,KAAK;wBAC1B,SAAS,EAAE,aAAa,CAAC,SAAS;wBAClC,OAAO,EAAE,aAAa,CAAC,YAAY;qBACpC,CAAC,CAAA;gBACJ,CAAC;gBAED,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,iBAAiB,CAAC;oBACzD,KAAK,EAAE,EAAE,EAAE,EAAE,OAAO,CAAC,MAAM,EAAE;oBAC7B,OAAO,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,SAAS,EAAE,IAAI,EAAE;iBAC9C,CAAC,CAAA;gBAEF,2BAA2B;gBAC3B,sCAAsC;gBACtC,MAAM,gBAAgB,GAAG,MAAM,IAAI,CAAC,mBAAmB,CACrD,SAAS,EACT,OAAO,CAAC,YAAY,EACpB,UAAU,CACX,CAAA;gBACD,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,sDAAsD,OAAO,CAAC,MAAM,GAAG,CAAC,CAAA;gBAExF,0CAA0C;gBAC1C,yBAAyB;gBACzB,6DAA6D;gBAC7D,iFAAiF;gBACjF,yDAAyD;gBACzD,IAAI;gBAEJ,gDAAgD;gBAChD,eAAe;gBACf,0BAA0B;gBAC1B,gBAAgB;gBAChB,KAAK;gBACL,gFAAgF;gBAChF,wDAAwD;gBACxD,eAAe;gBACf,0BAA0B;gBAC1B,WAAW;gBACX,gBAAgB;gBAChB,KAAK;gBACL,8FAA8F;gBAE9F,qBAAqB;gBACrB,IAAI,CAAC,2BAA2B,CAAC,gBAAgB,CAAC,CAAA;gBAElD,gBAAgB;gBAChB,MAAM,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,aAAa,EAAE;oBACzC,MAAM,EAAE,OAAO,CAAC,MAAM;oBACtB,KAAK,EAAE,sBAAsB;oBAC7B,IAAI,EAAE;wBACJ,OAAO,EAAE,uBAAuB;wBAChC,WAAW,EAAE,gBAAgB;qBAC9B;iBACF,CAAC,CAAA;gBACF,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,6CAA6C,OAAO,CAAC,MAAM,iBAAiB,CAAC,CAAA;YAC/F,CAAC;YAAC,OAAO,KAAc,EAAE,CAAC;gBACxB,IAAI,YAAY,GAAG,mDAAmD,CAAA;gBACtE,IAAI,KAAK,YAAY,KAAK,EAAE,CAAC;oBAC3B,YAAY,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAA;gBAChH,CAAC;gBACD,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,wCAAwC,OAAO,CAAC,MAAM,KAAK,YAAY,EAAE,EACzE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,EAChD,KAAK,YAAY,sCAAqB,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,SAAS,CACnE,CAAA;gBACD,IAAI,CAAC;oBACH,MAAM,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,aAAa,EAAE;wBACzC,MAAM,EAAE,OAAO,CAAC,MAAM;wBACtB,KAAK,EAAE,mBAAmB;wBAC1B,IAAI,EAAE;4BACJ,OAAO,EAAE,gDAAgD;4BACzD,KAAK,EAAE,YAAY;yBACpB;qBACF,CAAC,CAAA;gBACJ,CAAC;gBAAC,OAAO,aAAa,EAAE,CAAC;oBACvB,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,gEAAgE,EAChE,aAAa,CACd,CAAA;gBACH,CAAC;YACH,CAAC;QACH,CAAC;QAED;;;WAGG;QACI,KAAK,CAAC,sBAAsB,CACjC,MAAc,EACd,MAAc,EACd,KAAc;YAEd,IAAI,YAAY,GAAG,uDAAuD,CAAA;YAC1E,IAAI,KAAK,YAAY,KAAK,EAAE,CAAC;gBAC3B,YAAY,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAA;YAChH,CAAC;YAED,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,aAAa,EAAE;oBACzC,MAAM,EAAE,MAAM;oBACd,KAAK,EAAE,mBAAmB;oBAC1B,IAAI,EAAE;wBACJ,OAAO,EAAE,uDAAuD;wBAChE,KAAK,EAAE,YAAY;wBACnB,MAAM,EAAE,MAAM;wBACd,YAAY,EAAE,IAAI,EAAE,gBAAgB;qBACrC;iBACF,CAAC,CAAA;gBACF,IAAI,CAAC,MAAM,CAAC,GAAG,CACb,qDAAqD,MAAM,aAAa,MAAM,EAAE,CACjF,CAAA;YACH,CAAC;YAAC,OAAO,aAAa,EAAE,CAAC;gBACvB,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,yEAAyE,MAAM,aAAa,MAAM,EAAE,EACpG,aAAa,CACd,CAAA;YACH,CAAC;QACH,CAAC;QAED,2BAA2B;QAE3B;;;WAGG;QACK,KAAK,CAAC,mBAAmB,CAC/B,YAAoB,EACpB,YAAqB,EACrB,IAAU;YAEV,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,kBAAkB,CAAC,IAAI,EAAE,qBAAqB,CAAC,CAAA;YACrF,gDAAgD;YAChD,2EAA2E;YAC3E,MAAM,YAAY,GAAG,IAAI,CAAC,aAAa,CAAC,SAAS,CAAC,wBAAwB,CAAC,CAAA;YAE3E,YAAY;YACZ,MAAM,MAAM,GAAG,GAAG,YAAY,2GAA2G,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,qCAAqC,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,UAAU,CAAA;YAEhP,OAAO,IAAA,gCAAe,EACpB,QAAQ,EACR,MAAM,EACN,yBAAyB,EACzB,KAAK,CAAC,oBAAoB;aAC3B,CAAA;QACH,CAAC;QAED;;;WAGG;QACK,2BAA2B,CAAC,QAA6B;YAC/D,WAAW;YACX,MAAM,kBAAkB,GAAG,KAAK,CAAA,CAAC,SAAS;YAC1C,IAAI,QAAQ,CAAC,SAAS,CAAC,MAAM,GAAG,kBAAkB,EAAE,CAAC;gBACnD,MAAM,IAAI,KAAK,CACb,oCAAoC,QAAQ,CAAC,SAAS,CAAC,MAAM,qBAAqB,kBAAkB,GAAG,CACxG,CAAA;YACH,CAAC;YAED,iBAAiB;YACjB,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,SAAS,EAAE,WAAW,CAAC,CAAA;YAEzD,aAAa;YACb,IAAI,QAAQ,CAAC,OAAO,EAAE,CAAC;gBACrB,MAAM,UAAU,GAAG,EAAE,CAAA,CAAC,SAAS;gBAC/B,IAAI,QAAQ,CAAC,OAAO,CAAC,MAAM,GAAG,UAAU,EAAE,CAAC;oBACzC,MAAM,IAAI,KAAK,CACb,+BAA+B,QAAQ,CAAC,OAAO,CAAC,MAAM,UAAU,UAAU,GAAG,CAC9E,CAAA;gBACH,CAAC;gBAED,KAAK,MAAM,MAAM,IAAI,QAAQ,CAAC,OAAO,EAAE,CAAC;oBACtC,cAAc;oBACd,IAAI,MAAM,CAAC,IAAI,CAAC,MAAM,GAAG,GAAG,EAAE,CAAC;wBAC7B,MAAM,IAAI,KAAK,CAAC,4BAA4B,MAAM,CAAC,IAAI,CAAC,MAAM,wBAAwB,CAAC,CAAA;oBACzF,CAAC;oBAED,iBAAiB;oBACjB,IAAI,CAAC,mBAAmB,CAAC,MAAM,CAAC,IAAI,EAAE,aAAa,CAAC,CAAA;gBACtD,CAAC;YACH,CAAC;QACH,CAAC;QAED;;WAEG;QACK,mBAAmB,CAAC,IAAY,EAAE,SAAiB;YACzD,gBAAgB;YAChB,MAAM,kBAAkB,GAAG;gBACzB,UAAU;gBACV,cAAc;gBACd,YAAY;gBACZ,UAAU;gBACV,UAAU;gBACV,SAAS;gBACT,QAAQ;gBACR,QAAQ;gBACR,SAAS;aACV,CAAA;YAED,KAAK,MAAM,OAAO,IAAI,kBAAkB,EAAE,CAAC;gBACzC,IAAI,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC;oBACvB,MAAM,IAAI,KAAK,CACb,GAAG,SAAS,4CAA4C,IAAI,CAAC,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,KAAK,CACnF,CAAA;gBACH,CAAC;YACH,CAAC;QACH,CAAC;;;;AAxOU,4CAAgB","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\narrative-agent\\src\\narrative.service.ts"],"sourcesContent":["// 文件路径: apps/narrative-agent/src/narrative.service.ts (已优化 AI 调用链)\n\nimport { StructuredOutputParser } from '@langchain/core/output_parsers'\nimport { PromptTemplate } from '@langchain/core/prompts'\nimport { Injectable, Logger } from '@nestjs/common'\nimport type { User } from '@prisma/client'\nimport {\n  AiGenerationException,\n  callAiWithGuard,\n  type DynamicAiSchedulerService,\n  type EventBusService,\n  type LogicCompletePayload,\n  type PrismaService,\n  PromptInjectionDetectedException,\n  type PromptInjectionGuard,\n  type PromptManagerService,\n} from '@tuheg/common-backend'\nimport { z } from 'zod'\n\n// --- Zod Schemas for AI I/O ---\n\n// [!] 核心改造：合并 Synthesizer 和 Critic 的 Schema，因为它们的最终输出结构是一样的。\nconst progressionResponseSchema = z.object({\n  narrative: z.string().describe('对玩家行动结果的生动叙事描述'),\n  options: z\n    .array(\n      z.object({\n        dimension: z.string(),\n        check: z.string(),\n        success_rate: z.string(),\n        text: z.string(),\n      })\n    )\n    .nullable(),\n})\ntype ProgressionResponse = z.infer<typeof progressionResponseSchema>\n\n@Injectable()\nexport class NarrativeService {\n  private readonly logger = new Logger(NarrativeService.name)\n\n  constructor(\n    private readonly scheduler: DynamicAiSchedulerService,\n    private readonly prisma: PrismaService,\n    private readonly promptManager: PromptManagerService,\n    private readonly eventBus: EventBusService,\n    private readonly promptInjectionGuard: PromptInjectionGuard\n  ) {}\n\n  public async processNarrative(payload: LogicCompletePayload): Promise<void> {\n    this.logger.log(`Processing narrative for game ${payload.gameId}`)\n    const pseudoUser = { id: payload.userId } as User\n\n    try {\n      // Security check: Validate input against prompt injection\n      const securityCheck = await this.promptInjectionGuard.checkInput(\n        JSON.stringify(payload.playerAction),\n        {\n          userId: payload.userId,\n        }\n      )\n\n      if (!securityCheck.allowed) {\n        throw new PromptInjectionDetectedException('Input failed security validation', {\n          score: securityCheck.score,\n          threshold: securityCheck.threshold,\n          preview: securityCheck.inputPreview,\n        })\n      }\n\n      const gameState = await this.prisma.game.findUniqueOrThrow({\n        where: { id: payload.gameId },\n        include: { character: true, worldBook: true },\n      })\n\n      // [!] 核心改造：默认流程简化为单次 AI 调用\n      // 我们直接调用“叙事合成器”，并相信它在大多数情况下能产出足够好的结果。\n      const finalProgression = await this.synthesizeNarrative(\n        gameState,\n        payload.playerAction,\n        pseudoUser\n      )\n      this.logger.log(`[Synthesizer] Generated final progression for game ${payload.gameId}.`)\n\n      // [!] 核心改造：注释掉并保留审查家（Critic）的调用逻辑，以备将来使用。\n      // 未来的优化可以在这里加入一个判断逻辑，例如：\n      // if (this.needsCriticReview(finalProgression, gameState)) {\n      //   this.logger.log(`[Critic] Draft requires review. Engaging Critic Agent...`);\n      //   finalProgression = await this.reviewWithCritic(...);\n      // }\n\n      // const draft = await this.synthesizeNarrative(\n      //   gameState,\n      //   payload.playerAction,\n      //   pseudoUser,\n      // );\n      // this.logger.log(`[Synthesizer] Generated draft for game ${payload.gameId}.`);\n      // const finalProgression = await this.reviewWithCritic(\n      //   gameState,\n      //   payload.playerAction,\n      //   draft,\n      //   pseudoUser,\n      // );\n      // this.logger.log(`[Critic] Reviewed and finalized progression for game ${payload.gameId}.`);\n\n      // [安全修复] 验证AI生成的叙事内容\n      this.validateProgressionResponse(finalProgression)\n\n      // 发送最终结果的逻辑保持不变\n      await this.eventBus.publish('NOTIFY_USER', {\n        userId: payload.userId,\n        event: 'processing_completed',\n        data: {\n          message: 'AI response received.',\n          progression: finalProgression,\n        },\n      })\n      this.logger.log(`Successfully sent final narrative to user ${payload.userId} via event bus.`)\n    } catch (error: unknown) {\n      let errorMessage = 'An unknown error occurred in narrative processing'\n      if (error instanceof Error) {\n        errorMessage = error instanceof Error ? error instanceof Error ? error.message : String(error) : String(error)\n      }\n      this.logger.error(\n        `Failed to process narrative for game ${payload.gameId}: ${errorMessage}`,\n        error instanceof Error ? error.stack : undefined,\n        error instanceof AiGenerationException ? error.details : undefined\n      )\n      try {\n        await this.eventBus.publish('NOTIFY_USER', {\n          userId: payload.userId,\n          event: 'processing_failed',\n          data: {\n            message: 'An error occurred during narrative generation.',\n            error: errorMessage,\n          },\n        })\n      } catch (eventBusError) {\n        this.logger.error(\n          'CRITICAL: Failed to even send the error message via event bus.',\n          eventBusError\n        )\n      }\n    }\n  }\n\n  /**\n   * 专门用于在所有重试都失败后的最终失败通知\n   * 这个方法确保即使消息被发送到DLQ，用户也能收到失败通知\n   */\n  public async notifyNarrativeFailure(\n    userId: string,\n    gameId: string,\n    error: unknown\n  ): Promise<void> {\n    let errorMessage = 'An unknown error occurred during narrative processing'\n    if (error instanceof Error) {\n      errorMessage = error instanceof Error ? error instanceof Error ? error.message : String(error) : String(error)\n    }\n\n    try {\n      await this.eventBus.publish('NOTIFY_USER', {\n        userId: userId,\n        event: 'processing_failed',\n        data: {\n          message: 'Failed to process narrative after all retry attempts.',\n          error: errorMessage,\n          gameId: gameId,\n          finalFailure: true, // 标记这是最终失败，不再重试\n        },\n      })\n      this.logger.log(\n        `Sent final narrative failure notification to user ${userId} for game ${gameId}`\n      )\n    } catch (eventBusError) {\n      this.logger.error(\n        `CRITICAL: Failed to send final narrative failure notification to user ${userId} for game ${gameId}`,\n        eventBusError\n      )\n    }\n  }\n\n  // --- AI Agent Methods ---\n\n  /**\n   * 叙事合成器 (Synthesizer)\n   * [!] 核心改造：此方法现在负责直接生成最终结果。\n   */\n  private async synthesizeNarrative(\n    currentState: object,\n    playerAction: unknown,\n    user: User\n  ): Promise<ProgressionResponse> {\n    const provider = await this.scheduler.getProviderForRole(user, 'narrative_synthesis')\n    // [!] 核心改造：我们现在使用一个更全面的 Prompt，期望它能一步到位产出高质量内容。\n    // 在旧代码中，这里使用的是 '00_persona_and_framework.md'，现在改为 '02_narrative_engine.md'\n    const systemPrompt = this.promptManager.getPrompt('02_narrative_engine.md')\n\n    // 构造完整的提示文本\n    const prompt = `${systemPrompt}\\n# 渲染任务\\n你的任务是根据世界状态和玩家行动，生成一段叙事和后续选项。\\n请返回JSON格式的响应，包含narration和options字段。\\n---\\n当前世界状态:\\n\\`\\`\\`json\\n${JSON.stringify(currentState)}\\n\\`\\`\\`\\n---\\n玩家行动:\\n\\`\\`\\`json\\n${JSON.stringify(playerAction)}\\n\\`\\`\\``\n\n    return callAiWithGuard(\n      provider,\n      prompt,\n      progressionResponseSchema,\n      40000 // 40秒超时，叙事生成任务适中复杂度\n    )\n  }\n\n  /**\n   * [安全修复] 验证AI生成的叙事响应内容\n   * 防止AI生成过长或包含恶意内容的叙事文本\n   */\n  private validateProgressionResponse(response: ProgressionResponse): void {\n    // 验证叙事文本长度\n    const maxNarrativeLength = 10000 // 10KB上限\n    if (response.narrative.length > maxNarrativeLength) {\n      throw new Error(\n        `Generated narrative is too long: ${response.narrative.length} characters (max: ${maxNarrativeLength})`\n      )\n    }\n\n    // 验证叙事文本是否包含恶意内容\n    this.validateTextContent(response.narrative, 'narrative')\n\n    // 验证选项（如果存在）\n    if (response.options) {\n      const maxOptions = 10 // 最大选项数量\n      if (response.options.length > maxOptions) {\n        throw new Error(\n          `Too many options generated: ${response.options.length} (max: ${maxOptions})`\n        )\n      }\n\n      for (const option of response.options) {\n        // 验证每个选项字段的长度\n        if (option.text.length > 500) {\n          throw new Error(`Option text is too long: ${option.text.length} characters (max: 500)`)\n        }\n\n        // 验证选项文本是否包含恶意内容\n        this.validateTextContent(option.text, 'option text')\n      }\n    }\n  }\n\n  /**\n   * [安全修复] 验证文本内容是否包含潜在的恶意内容\n   */\n  private validateTextContent(text: string, fieldName: string): void {\n    // 检查是否包含潜在的恶意内容\n    const suspiciousPatterns = [\n      /<script/i,\n      /javascript:/i,\n      /on\\w+\\s*=/i,\n      /<iframe/i,\n      /<object/i,\n      /<embed/i,\n      /<link/i,\n      /<meta/i,\n      /<style/i,\n    ]\n\n    for (const pattern of suspiciousPatterns) {\n      if (pattern.test(text)) {\n        throw new Error(\n          `${fieldName} contains potentially malicious content: ${text.substring(0, 50)}...`\n        )\n      }\n    }\n  }\n}\n"],"version":3}