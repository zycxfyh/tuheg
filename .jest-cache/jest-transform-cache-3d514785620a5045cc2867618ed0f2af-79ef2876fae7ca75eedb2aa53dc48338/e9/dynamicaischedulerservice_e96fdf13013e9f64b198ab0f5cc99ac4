5a3d49d34ae52c8354ad5093e21b1e44
"use strict";
// 文件路径: packages/common-backend/src/ai/dynamic-ai-scheduler.service.ts
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var DynamicAiSchedulerService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DynamicAiSchedulerService = void 0;
const common_1 = require("@nestjs/common");
let DynamicAiSchedulerService = DynamicAiSchedulerService_1 = class DynamicAiSchedulerService {
    prisma;
    aiProviderFactory;
    configService;
    logger = new common_1.Logger(DynamicAiSchedulerService_1.name);
    constructor(prisma, aiProviderFactory, configService) {
        this.prisma = prisma;
        this.aiProviderFactory = aiProviderFactory;
        this.configService = configService;
    }
    async getProviderForRole(user, role) {
        this.logger.debug(`[Scheduler] New request for role: "${role}" from user ${user.id}`);
        // [!] 核心改造 1: 查询逻辑翻译
        // 我们不再查询一个字符串数组，而是查询一个关系。
        // 我们要找的是：一个 AiConfiguration，它的 'roles' 关系中，
        // 'some' (至少有一个) Role 的 'name' 字段等于我们想要的 'role'。
        const dedicatedConfig = await this.prisma.aiConfiguration.findFirst({
            where: {
                ownerId: user.id,
                roles: {
                    some: {
                        name: role, // 这就是新的、正确的 Prisma 关系查询语法
                    },
                },
            },
        });
        if (dedicatedConfig) {
            this.logger.log(`[Scheduler] Priority 1 (Dedicated): Found dedicated config "${dedicatedConfig.provider}/${dedicatedConfig.modelId}" for role "${role}".`);
            return this.aiProviderFactory.createProvider(dedicatedConfig);
        }
        this.logger.debug(`[Scheduler] Priority 1 (Dedicated): No dedicated AI found for role "${role}".`);
        // 优先级 2: 征用逻辑保持不变
        const anyUserConfig = await this.prisma.aiConfiguration.findFirst({
            where: { ownerId: user.id },
            orderBy: { createdAt: 'asc' },
        });
        if (anyUserConfig) {
            this.logger.log(`[Scheduler] Priority 2 (Requisition): Requisitioning general-purpose AI "${anyUserConfig.provider}/${anyUserConfig.modelId}" for role "${role}".`);
            return this.aiProviderFactory.createProvider(anyUserConfig);
        }
        this.logger.debug(`[Scheduler] Priority 2 (Requisition): User has no AI configurations at all.`);
        // 优先级 3: 后备逻辑保持不变，但模拟对象结构需要改变
        this.logger.warn(`[Scheduler] Priority 3 (System Fallback): Falling back to system default AI for role "${role}".`);
        try {
            return this.createFallbackProvider();
        }
        catch (error) {
            this.logger.error(`[Scheduler] CRITICAL FAILURE: System fallback AI failed to initialize.`, error instanceof Error ? error.stack : undefined);
            throw new common_1.InternalServerErrorException('AI processing failed: No AI is available or configured correctly.');
        }
    }
    createFallbackProvider() {
        try {
            // 优先使用专门的DeepSeek配置，如果没有则使用后备配置
            const apiKey = this.configService.get('DEEPSEEK_API_KEY') ||
                this.configService.getOrThrow('FALLBACK_API_KEY');
            const modelId = this.configService.get('FALLBACK_MODEL_ID', 'deepseek-chat');
            const baseUrlFromEnv = this.configService.get('DEEPSEEK_BASE_URL') ||
                this.configService.get('FALLBACK_BASE_URL');
            // [!] 核心改造 2: 模拟对象结构翻译
            // 新的 AiConfiguration 类型没有 `assignedRoles` 字段。
            // 我们创建一个不包含任何角色信息的、纯粹的配置对象。
            // 注意：这个模拟对象缺少 'roles' 属性，所以我们需要告诉 TypeScript
            // 它符合 AiConfiguration 的形状（通过类型断言 as AiConfiguration）。
            const fallbackConfig = {
                id: 'system-fallback',
                provider: 'DeepSeek',
                apiKey,
                baseUrl: baseUrlFromEnv ?? null,
                modelId,
                ownerId: 'system',
                createdAt: new Date(),
                updatedAt: new Date(),
            }; // 类型断言，表示我们确信这个对象的结构是兼容的
            return this.aiProviderFactory.createProvider(fallbackConfig);
        }
        catch (error) {
            this.logger.error('System fallback AI configuration is missing or invalid. Check your .env file for FALLBACK_... variables.', error);
            throw new Error('System default AI is not configured.');
        }
    }
};
exports.DynamicAiSchedulerService = DynamicAiSchedulerService;
exports.DynamicAiSchedulerService = DynamicAiSchedulerService = DynamicAiSchedulerService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object, Object, Object])
], DynamicAiSchedulerService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxhaVxcZHluYW1pYy1haS1zY2hlZHVsZXIuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiO0FBQUEsdUVBQXVFOzs7Ozs7Ozs7Ozs7O0FBRXZFLDJDQUFpRjtBQVExRSxJQUFNLHlCQUF5QixpQ0FBL0IsTUFBTSx5QkFBeUI7SUFJakI7SUFDQTtJQUNBO0lBTEYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLDJCQUF5QixDQUFDLElBQUksQ0FBQyxDQUFBO0lBRXBFLFlBQ21CLE1BQXFCLEVBQ3JCLGlCQUFvQyxFQUNwQyxhQUE0QjtRQUY1QixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsa0JBQWEsR0FBYixhQUFhLENBQWU7SUFDNUMsQ0FBQztJQUVHLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxJQUFVLEVBQUUsSUFBWTtRQUN0RCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsSUFBSSxlQUFlLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBRXJGLHFCQUFxQjtRQUNyQiwwQkFBMEI7UUFDMUIsNENBQTRDO1FBQzVDLGlEQUFpRDtRQUNqRCxNQUFNLGVBQWUsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQztZQUNsRSxLQUFLLEVBQUU7Z0JBQ0wsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFO2dCQUNoQixLQUFLLEVBQUU7b0JBQ0wsSUFBSSxFQUFFO3dCQUNKLElBQUksRUFBRSxJQUFJLEVBQUUsMEJBQTBCO3FCQUN2QztpQkFDRjthQUNGO1NBQ0YsQ0FBQyxDQUFBO1FBRUYsSUFBSSxlQUFlLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYiwrREFBK0QsZUFBZSxDQUFDLFFBQVEsSUFBSSxlQUFlLENBQUMsT0FB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LENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQXhHWSw4REFBeUI7b0NBQXpCLHlCQUF5QjtJQURyQyxJQUFBLG1CQUFVLEdBQUU7O0dBQ0EseUJBQXlCLENBd0dyQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xccGFja2FnZXNcXGNvbW1vbi1iYWNrZW5kXFxzcmNcXGFpXFxkeW5hbWljLWFpLXNjaGVkdWxlci5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL2FpL2R5bmFtaWMtYWktc2NoZWR1bGVyLnNlcnZpY2UudHNcblxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbiwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nXG5pbXBvcnQgdHlwZSB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZydcbmltcG9ydCB0eXBlIHsgQWlDb25maWd1cmF0aW9uLCBVc2VyIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQgdHlwZSB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi9wcmlzbWEvcHJpc21hLnNlcnZpY2UnXG5pbXBvcnQgdHlwZSB7IEFpUHJvdmlkZXIsIEFpUm9sZSB9IGZyb20gJy4uL3R5cGVzL2FpLXByb3ZpZGVycy50eXBlcydcbmltcG9ydCB0eXBlIHsgQWlQcm92aWRlckZhY3RvcnkgfSBmcm9tICcuL2FpLXByb3ZpZGVyLmZhY3RvcnknXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2UubmFtZSlcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFpUHJvdmlkZXJGYWN0b3J5OiBBaVByb3ZpZGVyRmFjdG9yeSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2VcbiAgKSB7fVxuXG4gIHB1YmxpYyBhc3luYyBnZXRQcm92aWRlckZvclJvbGUodXNlcjogVXNlciwgcm9sZTogQWlSb2xlKTogUHJvbWlzZTxBaVByb3ZpZGVyPiB7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYFtTY2hlZHVsZXJdIE5ldyByZXF1ZXN0IGZvciByb2xlOiBcIiR7cm9sZX1cIiBmcm9tIHVzZXIgJHt1c2VyLmlkfWApXG5cbiAgICAvLyBbIV0g5qC45b+D5pS56YCgIDE6IOafpeivoumAu+i+kee/u+ivkVxuICAgIC8vIOaIkeS7rOS4jeWGjeafpeivouS4gOS4quWtl+espuS4suaVsOe7hO+8jOiAjOaYr+afpeivouS4gOS4quWFs+ezu+OAglxuICAgIC8vIOaIkeS7rOimgeaJvueahOaYr++8muS4gOS4qiBBaUNvbmZpZ3VyYXRpb27vvIzlroPnmoQgJ3JvbGVzJyDlhbPns7vkuK3vvIxcbiAgICAvLyAnc29tZScgKOiHs+WwkeacieS4gOS4qikgUm9sZSDnmoQgJ25hbWUnIOWtl+auteetieS6juaIkeS7rOaDs+imgeeahCAncm9sZSfjgIJcbiAgICBjb25zdCBkZWRpY2F0ZWRDb25maWcgPSBhd2FpdCB0aGlzLnByaXNtYS5haUNvbmZpZ3VyYXRpb24uZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIG93bmVySWQ6IHVzZXIuaWQsXG4gICAgICAgIHJvbGVzOiB7XG4gICAgICAgICAgc29tZToge1xuICAgICAgICAgICAgbmFtZTogcm9sZSwgLy8g6L+Z5bCx5piv5paw55qE44CB5q2j56Gu55qEIFByaXNtYSDlhbPns7vmn6Xor6Lor63ms5VcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KVxuXG4gICAgaWYgKGRlZGljYXRlZENvbmZpZykge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgW1NjaGVkdWxlcl0gUHJpb3JpdHkgMSAoRGVkaWNhdGVkKTogRm91bmQgZGVkaWNhdGVkIGNvbmZpZyBcIiR7ZGVkaWNhdGVkQ29uZmlnLnByb3ZpZGVyfS8ke2RlZGljYXRlZENvbmZpZy5tb2RlbElkfVwiIGZvciByb2xlIFwiJHtyb2xlfVwiLmBcbiAgICAgIClcbiAgICAgIHJldHVybiB0aGlzLmFpUHJvdmlkZXJGYWN0b3J5LmNyZWF0ZVByb3ZpZGVyKGRlZGljYXRlZENvbmZpZylcbiAgICB9XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICBgW1NjaGVkdWxlcl0gUHJpb3JpdHkgMSAoRGVkaWNhdGVkKTogTm8gZGVkaWNhdGVkIEFJIGZvdW5kIGZvciByb2xlIFwiJHtyb2xlfVwiLmBcbiAgICApXG5cbiAgICAvLyDkvJjlhYjnuqcgMjog5b6B55So6YC76L6R5L+d5oyB5LiN5Y+YXG4gICAgY29uc3QgYW55VXNlckNvbmZpZyA9IGF3YWl0IHRoaXMucHJpc21hLmFpQ29uZmlndXJhdGlvbi5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHsgb3duZXJJZDogdXNlci5pZCB9LFxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdhc2MnIH0sXG4gICAgfSlcblxuICAgIGlmIChhbnlVc2VyQ29uZmlnKSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBbU2NoZWR1bGVyXSBQcmlvcml0eSAyIChSZXF1aXNpdGlvbik6IFJlcXVpc2l0aW9uaW5nIGdlbmVyYWwtcHVycG9zZSBBSSBcIiR7YW55VXNlckNvbmZpZy5wcm92aWRlcn0vJHthbnlVc2VyQ29uZmlnLm1vZGVsSWR9XCIgZm9yIHJvbGUgXCIke3JvbGV9XCIuYFxuICAgICAgKVxuICAgICAgcmV0dXJuIHRoaXMuYWlQcm92aWRlckZhY3RvcnkuY3JlYXRlUHJvdmlkZXIoYW55VXNlckNvbmZpZylcbiAgICB9XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYFtTY2hlZHVsZXJdIFByaW9yaXR5IDIgKFJlcXVpc2l0aW9uKTogVXNlciBoYXMgbm8gQUkgY29uZmlndXJhdGlvbnMgYXQgYWxsLmApXG5cbiAgICAvLyDkvJjlhYjnuqcgMzog5ZCO5aSH6YC76L6R5L+d5oyB5LiN5Y+Y77yM5L2G5qih5ouf5a+56LGh57uT5p6E6ZyA6KaB5pS55Y+YXG4gICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgIGBbU2NoZWR1bGVyXSBQcmlvcml0eSAzIChTeXN0ZW0gRmFsbGJhY2spOiBGYWxsaW5nIGJhY2sgdG8gc3lzdGVtIGRlZmF1bHQgQUkgZm9yIHJvbGUgXCIke3JvbGV9XCIuYFxuICAgIClcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRmFsbGJhY2tQcm92aWRlcigpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgW1NjaGVkdWxlcl0gQ1JJVElDQUwgRkFJTFVSRTogU3lzdGVtIGZhbGxiYWNrIEFJIGZhaWxlZCB0byBpbml0aWFsaXplLmAsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZFxuICAgICAgKVxuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdBSSBwcm9jZXNzaW5nIGZhaWxlZDogTm8gQUkgaXMgYXZhaWxhYmxlIG9yIGNvbmZpZ3VyZWQgY29ycmVjdGx5LidcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUZhbGxiYWNrUHJvdmlkZXIoKTogQWlQcm92aWRlciB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIOS8mOWFiOS9v+eUqOS4k+mXqOeahERlZXBTZWVr6YWN572u77yM5aaC5p6c5rKh5pyJ5YiZ5L2/55So5ZCO5aSH6YWN572uXG4gICAgICBjb25zdCBhcGlLZXkgPVxuICAgICAgICB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0RFRVBTRUVLX0FQSV9LRVknKSB8fFxuICAgICAgICB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0T3JUaHJvdzxzdHJpbmc+KCdGQUxMQkFDS19BUElfS0VZJylcbiAgICAgIGNvbnN0IG1vZGVsSWQgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0ZBTExCQUNLX01PREVMX0lEJywgJ2RlZXBzZWVrLWNoYXQnKVxuICAgICAgY29uc3QgYmFzZVVybEZyb21FbnYgPVxuICAgICAgICB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0RFRVBTRUVLX0JBU0VfVVJMJykgfHxcbiAgICAgICAgdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdGQUxMQkFDS19CQVNFX1VSTCcpXG5cbiAgICAgIC8vIFshXSDmoLjlv4PmlLnpgKAgMjog5qih5ouf5a+56LGh57uT5p6E57+76K+RXG4gICAgICAvLyDmlrDnmoQgQWlDb25maWd1cmF0aW9uIOexu+Wei+ayoeaciSBgYXNzaWduZWRSb2xlc2Ag5a2X5q6144CCXG4gICAgICAvLyDmiJHku6zliJvlu7rkuIDkuKrkuI3ljIXlkKvku7vkvZXop5LoibLkv6Hmga/nmoTjgIHnuq/nsrnnmoTphY3nva7lr7nosaHjgIJcbiAgICAgIC8vIOazqOaEj++8mui/meS4quaooeaLn+Wvueixoee8uuWwkSAncm9sZXMnIOWxnuaAp++8jOaJgOS7peaIkeS7rOmcgOimgeWRiuiviSBUeXBlU2NyaXB0XG4gICAgICAvLyDlroPnrKblkIggQWlDb25maWd1cmF0aW9uIOeahOW9oueKtu+8iOmAmui/h+exu+Wei+aWreiogCBhcyBBaUNvbmZpZ3VyYXRpb27vvInjgIJcbiAgICAgIGNvbnN0IGZhbGxiYWNrQ29uZmlnID0ge1xuICAgICAgICBpZDogJ3N5c3RlbS1mYWxsYmFjaycsXG4gICAgICAgIHByb3ZpZGVyOiAnRGVlcFNlZWsnLFxuICAgICAgICBhcGlLZXksXG4gICAgICAgIGJhc2VVcmw6IGJhc2VVcmxGcm9tRW52ID8/IG51bGwsXG4gICAgICAgIG1vZGVsSWQsXG4gICAgICAgIG93bmVySWQ6ICdzeXN0ZW0nLFxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH0gYXMgQWlDb25maWd1cmF0aW9uIC8vIOexu+Wei+aWreiogO+8jOihqOekuuaIkeS7rOehruS/oei/meS4quWvueixoeeahOe7k+aehOaYr+WFvOWuueeahFxuXG4gICAgICByZXR1cm4gdGhpcy5haVByb3ZpZGVyRmFjdG9yeS5jcmVhdGVQcm92aWRlcihmYWxsYmFja0NvbmZpZylcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICdTeXN0ZW0gZmFsbGJhY2sgQUkgY29uZmlndXJhdGlvbiBpcyBtaXNzaW5nIG9yIGludmFsaWQuIENoZWNrIHlvdXIgLmVudiBmaWxlIGZvciBGQUxMQkFDS18uLi4gdmFyaWFibGVzLicsXG4gICAgICAgIGVycm9yXG4gICAgICApXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N5c3RlbSBkZWZhdWx0IEFJIGlzIG5vdCBjb25maWd1cmVkLicpXG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=