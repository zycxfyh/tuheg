{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\reactive\\event-stream.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\reactive\\event-stream.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/reactive/event-stream.ts\n// 核心理念: 响应式数据流，使用 Observable 处理异步事件\n\nimport { Injectable, Logger } from '@nestjs/common'\nimport { catchError, mergeMap, type Observable, Subject } from 'rxjs'\n\n/**\n * @interface EventStreamConfig\n * @description 事件流配置\n */\nexport interface EventStreamConfig {\n  /** 事件名称 */\n  eventName: string\n  /** 是否自动重试 */\n  autoRetry?: boolean\n  /** 最大重试次数 */\n  maxRetries?: number\n  /** 重试延迟（毫秒） */\n  retryDelay?: number\n}\n\n/**\n * @class EventStream\n * @description RxJS 风格的事件流处理器\n * 用于处理异步事件流，支持操作符组合和错误处理\n */\n@Injectable()\nexport class EventStream {\n  private readonly logger = new Logger(EventStream.name)\n  private readonly streams = new Map<string, Subject<any>>()\n\n  /**\n   * @method createStream\n   * @description 创建事件流\n   */\n  public createStream<T = unknown>(eventName: string): Observable<T> {\n    if (!this.streams.has(eventName)) {\n      this.streams.set(eventName, new Subject<any>())\n    }\n\n    return this.streams.get(eventName) as Observable<T>\n  }\n\n  /**\n   * @method emit\n   * @description 发送事件到流\n   */\n  public emit<T = unknown>(eventName: string, data: T): void {\n    const stream = this.streams.get(eventName)\n    if (stream) {\n      stream.next(data)\n      this.logger.debug(`Emitted event \"${eventName}\"`)\n    } else {\n      this.logger.warn(`Stream \"${eventName}\" not found`)\n    }\n  }\n\n  /**\n   * @method subscribe\n   * @description 订阅事件流\n   */\n  public subscribe<T = unknown>(\n    eventName: string,\n    handler: (data: T) => void | Promise<void>,\n    config?: EventStreamConfig\n  ): () => void {\n    const stream = this.createStream<T>(eventName)\n\n    const subscription = stream.subscribe({\n      next: async (data) => {\n        try {\n          await handler(data)\n        } catch (error) {\n          this.logger.error(\n            `Error handling event \"${eventName}\":`,\n            error instanceof Error ? error.message : String(error)\n          )\n\n          if (config?.autoRetry) {\n            await this.retryHandler(eventName, handler, data, config)\n          }\n        }\n      },\n      error: (error) => {\n        this.logger.error(\n          `Stream error for \"${eventName}\":`,\n          error instanceof Error ? error.message : String(error)\n        )\n      },\n    })\n\n    return () => subscription.unsubscribe()\n  }\n\n  /**\n   * @method pipe\n   * @description 管道操作符（简化版）\n   */\n  public pipe<T, R>(eventName: string, transform: (data: T) => R | Promise<R>): Observable<R> {\n    const stream = this.createStream<T>(eventName)\n\n    return stream.pipe(\n      mergeMap(async (data) => {\n        try {\n          return await transform(data)\n        } catch (error) {\n          this.logger.error(\n            `Error in pipe for \"${eventName}\":`,\n            error instanceof Error ? error.message : String(error)\n          )\n          throw error\n        }\n      }),\n      catchError((error) => {\n        this.logger.error(\n          `Pipe error for \"${eventName}\":`,\n          error instanceof Error ? error.message : String(error)\n        )\n        throw error\n      })\n    )\n  }\n\n  /**\n   * @method retryHandler\n   * @description 重试处理器\n   */\n  private async retryHandler<T>(\n    eventName: string,\n    handler: (data: T) => void | Promise<void>,\n    data: T,\n    config: EventStreamConfig\n  ): Promise<void> {\n    const maxRetries = config.maxRetries ?? 3\n    const retryDelay = config.retryDelay ?? 1000\n\n    for (let attempt = 1; attempt <= maxRetries; attempt++) {\n      await new Promise((resolve) => setTimeout(resolve, retryDelay * attempt))\n\n      try {\n        await handler(data)\n        this.logger.log(`Successfully retried event \"${eventName}\" after ${attempt} attempts`)\n        return\n      } catch (error) {\n        if (attempt === maxRetries) {\n          this.logger.error(\n            `Failed to handle event \"${eventName}\" after ${maxRetries} attempts`,\n            error instanceof Error ? error.message : String(error)\n          )\n          throw error\n        }\n      }\n    }\n  }\n\n  /**\n   * @method close\n   * @description 关闭事件流\n   */\n  public close(eventName: string): void {\n    const stream = this.streams.get(eventName)\n    if (stream) {\n      stream.complete()\n      this.streams.delete(eventName)\n      this.logger.debug(`Closed stream \"${eventName}\"`)\n    }\n  }\n\n  /**\n   * @method closeAll\n   * @description 关闭所有事件流\n   */\n  public closeAll(): void {\n    for (const [eventName, stream] of this.streams.entries()) {\n      stream.complete()\n      this.logger.debug(`Closed stream \"${eventName}\"`)\n    }\n    this.streams.clear()\n  }\n}\n"],"version":3}