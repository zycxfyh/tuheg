2739d01560862d7012e8a342161bfb69
"use strict";
// 文件路径: packages/narrative-domain/src/dto/submit-action.dto.ts
Object.defineProperty(exports, "__esModule", { value: true });
exports.submitActionSchema = void 0;
const zod_1 = require("zod");
// 自定义验证函数：检查控制字符
const noControlCharacters = (value) => {
    // 检查是否包含控制字符（除了制表符、换行符、回车符）
    // 使用字符码检查来避免ESLint的正则表达式控制字符规则
    for (let i = 0; i < value.length; i++) {
        const charCode = value.charCodeAt(i);
        // 排除制表符(\t=9)、换行符(\n=10)、回车符(\r=13)
        if ((charCode >= 0 && charCode <= 8) ||
            (charCode >= 11 && charCode <= 12) ||
            (charCode >= 14 && charCode <= 31) ||
            charCode === 127) {
            return false;
        }
    }
    return true;
};
// 自定义验证函数：检查字符串长度
const maxLength400 = (value) => value.length <= 400;
/**
 * @name submitActionSchema
 * @description [联邦法律] 定义了玩家提交一个"行动"时，其数据包的标准格式。
 */
exports.submitActionSchema = zod_1.z
    .object({
    // 'type' 字段区分了不同的行动种类
    type: zod_1.z.enum(['option', 'command', 'meta']),
    // 'payload' 载荷可以是任何东西，具体结构由type决定
    payload: zod_1.z.any(),
})
    .superRefine((data, ctx) => {
    // 根据type进行不同的验证
    if (data.type === 'command') {
        // command类型的payload应该是字符串，且不能包含控制字符
        if (typeof data.payload !== 'string') {
            ctx.addIssue({
                code: zod_1.z.ZodIssueCode.custom,
                message: 'Command payload must be a string.',
                path: ['payload'],
            });
            return;
        }
        if (!noControlCharacters(data.payload)) {
            ctx.addIssue({
                code: zod_1.z.ZodIssueCode.custom,
                message: 'Command payload contains invalid control characters.',
                path: ['payload'],
            });
        }
    }
    else if (data.type === 'option') {
        // option类型的payload应该是一个对象，包含text字段
        if (typeof data.payload !== 'object' || data.payload === null) {
            ctx.addIssue({
                code: zod_1.z.ZodIssueCode.custom,
                message: 'Option payload must be an object.',
                path: ['payload'],
            });
            return;
        }
        const payload = data.payload;
        if (typeof payload.text !== 'string') {
            ctx.addIssue({
                code: zod_1.z.ZodIssueCode.custom,
                message: 'Option payload text must be a string.',
                path: ['payload', 'text'],
            });
            return;
        }
        if (!maxLength400(payload.text)) {
            ctx.addIssue({
                code: zod_1.z.ZodIssueCode.custom,
                message: 'Option text must be 400 characters or fewer.',
                path: ['payload', 'text'],
            });
        }
    }
    // meta类型暂不进行额外验证
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxuYXJyYXRpdmUtZG9tYWluXFxzcmNcXGR0b1xcc3VibWl0LWFjdGlvbi5kdG8udHMiLCJtYXBwaW5ncyI6IjtBQUFBLCtEQUErRDs7O0FBRS9ELDZCQUF1QjtBQUV2QixpQkFBaUI7QUFDakIsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLEtBQWEsRUFBRSxFQUFFO0lBQzVDLDRCQUE0QjtJQUM1QiwrQkFBK0I7SUFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUN0QyxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3BDLG9DQUFvQztRQUNwQyxJQUNFLENBQUMsUUFBUSxJQUFJLENBQUMsSUFBSSxRQUFRLElBQUksQ0FBQyxDQUFDO1lBQ2hDLENBQUMsUUFBUSxJQUFJLEVBQUUsSUFBSSxRQUFRLElBQUksRUFBRSxDQUFDO1lBQ2xDLENBQUMsUUFBUSxJQUFJLEVBQUUsSUFBSSxRQUFRLElBQUksRUFBRSxDQUFDO1lBQ2xDLFFBQVEsS0FBSyxHQUFHLEVBQ2hCLENBQUM7WUFDRCxPQUFPLEtBQUssQ0FBQTtRQUNkLENBQUM7SUFDSCxDQUFDO0lBQ0QsT0FBTyxJQUFJLENBQUE7QUFDYixDQUFDLENBQUE7QUFFRCxrQkFBa0I7QUFDbEIsTUFBTSxZQUFZLEdBQUcsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFBO0FBRTNEOzs7R0FHRztBQUNVLFFBQUEsa0JBQWtCLEdBQUcsT0FBQztLQUNoQyxNQUFNLENBQUM7SUFDTixzQkFBc0I7SUFDdEIsSUFBSSxFQUFFLE9BQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzNDLGtDQUFrQztJQUNsQyxPQUFPLEVBQUUsT0FBQyxDQUFDLEdBQUcsRUFBRTtDQUNqQixDQUFDO0tBQ0QsV0FBVyxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQ3pCLGdCQUFnQjtJQUNoQixJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDNUIsb0NBQW9DO1FBQ3BDLElBQUksT0FBTyxJQUFJLENBQUMsT0FBTyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ3JDLEdBQUcsQ0FBQyxRQUFRLENBQUM7Z0JBQ1gsSUFBSSxFQUFFLE9BQUMsQ0FBQyxZQUFZLENBQUMsTUFBTTtnQkFDM0IsT0FBTyxFQUFFLG1DQUFtQztnQkFDNUMsSUFBSSxFQUFFLENBQUMsU0FBUyxDQUFDO2FBQ2xCLENBQUMsQ0FBQTtZQUNGLE9BQU07UUFDUixDQUFDO1FBRUQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ3ZDLEdBQUcsQ0FBQyxRQUFRLENBQUM7Z0JBQ1gsSUFBSSxFQUFFLE9BQUMsQ0FBQyxZQUFZLENBQUMsTUFBTTtnQkFDM0IsT0FBTyxFQUFFLHNEQUFzRDtnQkFDL0QsSUFBSSxFQUFFLENBQUMsU0FBUyxDQUFDO2FBQ2xCLENBQUMsQ0FBQTtRQUNKLENBQUM7SUFDSCxDQUFDO1NBQU0sSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQ2xDLG1DQUFtQztRQUNuQyxJQUFJLE9BQU8sSUFBSSxDQUFDLE9BQU8sS0FBSyxRQUFRLElBQUksSUFBSSxDQUFDLE9BQU8sS0FBSyxJQUFJLEVBQUUsQ0FBQztZQUM5RCxHQUFHLENBQUMsUUFBUSxDQUFDO2dCQUNYLElBQUksRUFBRSxPQUFDLENBQUMsWUFBWSxDQUFDLE1BQU07Z0JBQzNCLE9BQU8sRUFBRSxtQ0FBbUM7Z0JBQzVDLElBQUksRUFBRSxDQUFDLFNBQVMsQ0FBQzthQUNsQixDQUFDLENBQUE7WUFDRixPQUFNO1FBQ1IsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFjLENBQUE7UUFDbkMsSUFBSSxPQUFPLE9BQU8sQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDckMsR0FBRyxDQUFDLFFBQVEsQ0FBQztnQkFDWCxJQUFJLEVBQUUsT0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNO2dCQUMzQixPQUFPLEVBQUUsdUNBQXVDO2dCQUNoRCxJQUFJLEVBQUUsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDO2FBQzFCLENBQUMsQ0FBQTtZQUNGLE9BQU07UUFDUixDQUFDO1FBRUQsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNoQyxHQUFHLENBQUMsUUFBUSxDQUFDO2dCQUNYLElBQUksRUFBRSxPQUFDLENBQUMsWUFBWSxDQUFDLE1BQU07Z0JBQzNCLE9BQU8sRUFBRSw4Q0FBOEM7Z0JBQ3ZELElBQUksRUFBRSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUM7YUFDMUIsQ0FBQyxDQUFBO1FBQ0osQ0FBQztJQUNILENBQUM7SUFDRCxpQkFBaUI7QUFDbkIsQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxuYXJyYXRpdmUtZG9tYWluXFxzcmNcXGR0b1xcc3VibWl0LWFjdGlvbi5kdG8udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8g5paH5Lu26Lev5b6EOiBwYWNrYWdlcy9uYXJyYXRpdmUtZG9tYWluL3NyYy9kdG8vc3VibWl0LWFjdGlvbi5kdG8udHNcblxuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCdcblxuLy8g6Ieq5a6a5LmJ6aqM6K+B5Ye95pWw77ya5qOA5p+l5o6n5Yi25a2X56ymXG5jb25zdCBub0NvbnRyb2xDaGFyYWN0ZXJzID0gKHZhbHVlOiBzdHJpbmcpID0+IHtcbiAgLy8g5qOA5p+l5piv5ZCm5YyF5ZCr5o6n5Yi25a2X56ym77yI6Zmk5LqG5Yi26KGo56ym44CB5o2i6KGM56ym44CB5Zue6L2m56ym77yJXG4gIC8vIOS9v+eUqOWtl+espueggeajgOafpeadpemBv+WFjUVTTGludOeahOato+WImeihqOi+vuW8j+aOp+WItuWtl+espuinhOWImVxuICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgY2hhckNvZGUgPSB2YWx1ZS5jaGFyQ29kZUF0KGkpXG4gICAgLy8g5o6S6Zmk5Yi26KGo56ymKFxcdD05KeOAgeaNouihjOespihcXG49MTAp44CB5Zue6L2m56ymKFxccj0xMylcbiAgICBpZiAoXG4gICAgICAoY2hhckNvZGUgPj0gMCAmJiBjaGFyQ29kZSA8PSA4KSB8fFxuICAgICAgKGNoYXJDb2RlID49IDExICYmIGNoYXJDb2RlIDw9IDEyKSB8fFxuICAgICAgKGNoYXJDb2RlID49IDE0ICYmIGNoYXJDb2RlIDw9IDMxKSB8fFxuICAgICAgY2hhckNvZGUgPT09IDEyN1xuICAgICkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9XG4gIHJldHVybiB0cnVlXG59XG5cbi8vIOiHquWumuS5iemqjOivgeWHveaVsO+8muajgOafpeWtl+espuS4sumVv+W6plxuY29uc3QgbWF4TGVuZ3RoNDAwID0gKHZhbHVlOiBzdHJpbmcpID0+IHZhbHVlLmxlbmd0aCA8PSA0MDBcblxuLyoqXG4gKiBAbmFtZSBzdWJtaXRBY3Rpb25TY2hlbWFcbiAqIEBkZXNjcmlwdGlvbiBb6IGU6YKm5rOV5b6LXSDlrprkuYnkuobnjqnlrrbmj5DkuqTkuIDkuKpcIuihjOWKqFwi5pe277yM5YW25pWw5o2u5YyF55qE5qCH5YeG5qC85byP44CCXG4gKi9cbmV4cG9ydCBjb25zdCBzdWJtaXRBY3Rpb25TY2hlbWEgPSB6XG4gIC5vYmplY3Qoe1xuICAgIC8vICd0eXBlJyDlrZfmrrXljLrliIbkuobkuI3lkIznmoTooYzliqjnp43nsbtcbiAgICB0eXBlOiB6LmVudW0oWydvcHRpb24nLCAnY29tbWFuZCcsICdtZXRhJ10pLFxuICAgIC8vICdwYXlsb2FkJyDovb3ojbflj6/ku6XmmK/ku7vkvZXkuJzopb/vvIzlhbfkvZPnu5PmnoTnlLF0eXBl5Yaz5a6aXG4gICAgcGF5bG9hZDogei5hbnkoKSxcbiAgfSlcbiAgLnN1cGVyUmVmaW5lKChkYXRhLCBjdHgpID0+IHtcbiAgICAvLyDmoLnmja50eXBl6L+b6KGM5LiN5ZCM55qE6aqM6K+BXG4gICAgaWYgKGRhdGEudHlwZSA9PT0gJ2NvbW1hbmQnKSB7XG4gICAgICAvLyBjb21tYW5k57G75Z6L55qEcGF5bG9hZOW6lOivpeaYr+Wtl+espuS4su+8jOS4lOS4jeiDveWMheWQq+aOp+WItuWtl+esplxuICAgICAgaWYgKHR5cGVvZiBkYXRhLnBheWxvYWQgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGN0eC5hZGRJc3N1ZSh7XG4gICAgICAgICAgY29kZTogei5ab2RJc3N1ZUNvZGUuY3VzdG9tLFxuICAgICAgICAgIG1lc3NhZ2U6ICdDb21tYW5kIHBheWxvYWQgbXVzdCBiZSBhIHN0cmluZy4nLFxuICAgICAgICAgIHBhdGg6IFsncGF5bG9hZCddLFxuICAgICAgICB9KVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgaWYgKCFub0NvbnRyb2xDaGFyYWN0ZXJzKGRhdGEucGF5bG9hZCkpIHtcbiAgICAgICAgY3R4LmFkZElzc3VlKHtcbiAgICAgICAgICBjb2RlOiB6LlpvZElzc3VlQ29kZS5jdXN0b20sXG4gICAgICAgICAgbWVzc2FnZTogJ0NvbW1hbmQgcGF5bG9hZCBjb250YWlucyBpbnZhbGlkIGNvbnRyb2wgY2hhcmFjdGVycy4nLFxuICAgICAgICAgIHBhdGg6IFsncGF5bG9hZCddLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZGF0YS50eXBlID09PSAnb3B0aW9uJykge1xuICAgICAgLy8gb3B0aW9u57G75Z6L55qEcGF5bG9hZOW6lOivpeaYr+S4gOS4quWvueixoe+8jOWMheWQq3RleHTlrZfmrrVcbiAgICAgIGlmICh0eXBlb2YgZGF0YS5wYXlsb2FkICE9PSAnb2JqZWN0JyB8fCBkYXRhLnBheWxvYWQgPT09IG51bGwpIHtcbiAgICAgICAgY3R4LmFkZElzc3VlKHtcbiAgICAgICAgICBjb2RlOiB6LlpvZElzc3VlQ29kZS5jdXN0b20sXG4gICAgICAgICAgbWVzc2FnZTogJ09wdGlvbiBwYXlsb2FkIG11c3QgYmUgYW4gb2JqZWN0LicsXG4gICAgICAgICAgcGF0aDogWydwYXlsb2FkJ10sXG4gICAgICAgIH0pXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBjb25zdCBwYXlsb2FkID0gZGF0YS5wYXlsb2FkIGFzIGFueVxuICAgICAgaWYgKHR5cGVvZiBwYXlsb2FkLnRleHQgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGN0eC5hZGRJc3N1ZSh7XG4gICAgICAgICAgY29kZTogei5ab2RJc3N1ZUNvZGUuY3VzdG9tLFxuICAgICAgICAgIG1lc3NhZ2U6ICdPcHRpb24gcGF5bG9hZCB0ZXh0IG11c3QgYmUgYSBzdHJpbmcuJyxcbiAgICAgICAgICBwYXRoOiBbJ3BheWxvYWQnLCAndGV4dCddLFxuICAgICAgICB9KVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgaWYgKCFtYXhMZW5ndGg0MDAocGF5bG9hZC50ZXh0KSkge1xuICAgICAgICBjdHguYWRkSXNzdWUoe1xuICAgICAgICAgIGNvZGU6IHouWm9kSXNzdWVDb2RlLmN1c3RvbSxcbiAgICAgICAgICBtZXNzYWdlOiAnT3B0aW9uIHRleHQgbXVzdCBiZSA0MDAgY2hhcmFjdGVycyBvciBmZXdlci4nLFxuICAgICAgICAgIHBhdGg6IFsncGF5bG9hZCcsICd0ZXh0J10sXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfVxuICAgIC8vIG1ldGHnsbvlnovmmoLkuI3ov5vooYzpop3lpJbpqozor4FcbiAgfSlcblxuZXhwb3J0IHR5cGUgU3VibWl0QWN0aW9uRHRvID0gei5pbmZlcjx0eXBlb2Ygc3VibWl0QWN0aW9uU2NoZW1hPiJdLCJ2ZXJzaW9uIjozfQ==