{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\errors\\error-classification.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\errors\\error-classification.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/errors/error-classification.ts\n// 职责: 统一错误分类和错误响应格式，用于 RabbitMQ 消息处理\n//\n// 核心功能:\n// 1. 将错误分类为可重试 vs 不可重试\n// 2. 生成统一的错误响应格式\n// 3. 提供错误码和建议操作\n\nimport { ZodError } from 'zod'\nimport { AiGenerationException } from '../exceptions/ai-exception'\nimport { PromptInjectionDetectedException } from './prompt-injection-detected.exception'\n\n/**\n * 错误类型枚举\n */\nexport enum ProcessingErrorType {\n  /** 验证错误 - 不可重试（消息格式错误） */\n  VALIDATION_ERROR = 'VALIDATION_ERROR',\n  /** AI 生成错误 - 可重试（AI 可能临时故障） */\n  AI_GENERATION_ERROR = 'AI_GENERATION_ERROR',\n  /** 业务逻辑错误 - 不可重试（数据冲突等） */\n  BUSINESS_LOGIC_ERROR = 'BUSINESS_LOGIC_ERROR',\n  /** 网络错误 - 可重试（临时网络问题） */\n  NETWORK_ERROR = 'NETWORK_ERROR',\n  /** 数据库错误 - 可重试（连接问题等） */\n  DATABASE_ERROR = 'DATABASE_ERROR',\n  /** 未知错误 - 默认可重试（保守策略） */\n  UNKNOWN_ERROR = 'UNKNOWN_ERROR',\n}\n\n/**\n * 错误响应格式\n */\nexport interface ProcessingErrorResponse {\n  /** 错误类型 */\n  errorType: ProcessingErrorType\n  /** 是否可重试 */\n  retryable: boolean\n  /** 错误码 */\n  errorCode: string\n  /** 用户友好的错误消息 */\n  message: string\n  /** 详细错误信息（仅用于日志） */\n  details?: unknown\n  /** 建议的用户操作 */\n  suggestedAction?: string\n}\n\n/**\n * 分类处理错误并生成统一的错误响应\n *\n * @param error - 捕获的错误\n * @param context - 上下文信息（可选）\n * @returns 标准化的错误响应\n *\n * @remarks\n * 分类规则：\n * - ZodError → VALIDATION_ERROR (不可重试)\n * - AiGenerationException → AI_GENERATION_ERROR (可重试)\n * - 网络错误 → NETWORK_ERROR (可重试)\n * - 数据库连接错误 → DATABASE_ERROR (可重试)\n * - 其他业务逻辑错误 → BUSINESS_LOGIC_ERROR (不可重试)\n */\nexport function classifyProcessingError(\n  error: unknown,\n  context?: { operation?: string; gameId?: string; userId?: string }\n): ProcessingErrorResponse {\n  // context 参数保留用于未来扩展（如基于上下文的错误分类）\n  void context // 标记为已使用，避免 lint 错误\n  // Zod 验证错误 - 不可重试（消息格式错误）\n  if (error instanceof ZodError) {\n    return {\n      errorType: ProcessingErrorType.VALIDATION_ERROR,\n      retryable: false,\n      errorCode: 'INVALID_MESSAGE_FORMAT',\n      message: 'Message validation failed. The message format is incorrect.',\n      details: error.issues,\n      suggestedAction: 'Check the message format and resend with correct structure.',\n    }\n  }\n\n  if (error instanceof PromptInjectionDetectedException) {\n    return {\n      errorType: ProcessingErrorType.VALIDATION_ERROR,\n      retryable: false,\n      errorCode: 'PROMPT_INJECTION_DETECTED',\n      message: 'Potential prompt injection detected. The input has been rejected.',\n      details: error.details,\n      suggestedAction:\n        'Revise the input to remove system override or malicious patterns before retrying.',\n    }\n  }\n\n  // AI 生成错误 - 可重试\n  if (error instanceof AiGenerationException) {\n    return {\n      errorType: ProcessingErrorType.AI_GENERATION_ERROR,\n      retryable: true,\n      errorCode: 'AI_GENERATION_FAILED',\n      message: 'AI failed to generate valid output. The operation can be retried.',\n      details: error.details,\n      suggestedAction:\n        'Retry the operation. If the issue persists, check AI provider configuration.',\n    }\n  }\n\n  // 网络错误 - 可重试\n  if (error instanceof Error) {\n    const errorMessage = error.message.toLowerCase()\n    const errorName = error.name.toLowerCase()\n\n    if (\n      errorName.includes('network') ||\n      errorMessage.includes('econnrefused') ||\n      errorMessage.includes('etimedout') ||\n      errorMessage.includes('enotfound') ||\n      errorMessage.includes('socket') ||\n      errorMessage.includes('timeout') ||\n      errorMessage.includes('connection')\n    ) {\n      return {\n        errorType: ProcessingErrorType.NETWORK_ERROR,\n        retryable: true,\n        errorCode: 'NETWORK_CONNECTION_FAILED',\n        message: 'Network connection failed. The operation can be retried.',\n        details: error.message,\n        suggestedAction: 'Retry the operation. Check network connectivity if the issue persists.',\n      }\n    }\n\n    // 数据库错误 - 可重试\n    if (\n      errorName.includes('prisma') ||\n      errorMessage.includes('database') ||\n      errorMessage.includes('connection') ||\n      errorMessage.includes('query')\n    ) {\n      return {\n        errorType: ProcessingErrorType.DATABASE_ERROR,\n        retryable: true,\n        errorCode: 'DATABASE_OPERATION_FAILED',\n        message: 'Database operation failed. The operation can be retried.',\n        details: error.message,\n        suggestedAction: 'Retry the operation. Check database connection if the issue persists.',\n      }\n    }\n\n    // 业务逻辑错误（特定错误名称）\n    if (\n      errorName.includes('business') ||\n      errorName.includes('logic') ||\n      errorMessage.includes('business logic') ||\n      errorMessage.includes('conflict') ||\n      errorMessage.includes('duplicate')\n    ) {\n      return {\n        errorType: ProcessingErrorType.BUSINESS_LOGIC_ERROR,\n        retryable: false,\n        errorCode: 'BUSINESS_RULE_VIOLATION',\n        message: 'Business logic validation failed. The operation cannot be retried.',\n        details: error.message,\n        suggestedAction: 'Review the request data and ensure it complies with business rules.',\n      }\n    }\n  }\n\n  // 默认：未知错误 - 保守策略（可重试）\n  return {\n    errorType: ProcessingErrorType.UNKNOWN_ERROR,\n    retryable: true,\n    errorCode: 'UNKNOWN_ERROR',\n    message: 'An unexpected error occurred. The operation can be retried.',\n    details: error instanceof Error ? error.message : String(error),\n    suggestedAction: 'Retry the operation. Contact support if the issue persists.',\n  }\n}\n\n/**\n * 判断错误是否应该重试\n *\n * @param error - 错误对象\n * @returns 是否应该重试\n */\nexport function shouldRetryError(error: unknown): boolean {\n  const classification = classifyProcessingError(error)\n  return classification.retryable\n}\n\n/**\n * 获取分类后的错误的人类可读消息\n *\n * @param error - 错误对象\n * @returns 用户友好的错误消息\n */\nexport function getClassifiedErrorMessage(error: unknown): string {\n  const classification = classifyProcessingError(error)\n  return classification.message\n}\n\n// ProcessingErrorResponse 已经在上面定义并导出，不需要重复导出\n"],"version":3}