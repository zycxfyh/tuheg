c9df5f4c58d88e9244a9385c29c5577f
"use strict";
/**
 * Jest 全局测试设置
 * 配置测试环境的快速失败机制和最佳实践
 */
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
// Mock ESM modules that cause issues in Jest
globals_1.jest.mock('langfuse', () => ({
    Langfuse: globals_1.jest.fn().mockImplementation(() => ({
        trace: globals_1.jest.fn(),
        generation: globals_1.jest.fn(),
        span: globals_1.jest.fn(),
        score: globals_1.jest.fn(),
        shutdownAsync: globals_1.jest.fn().mockResolvedValue(undefined),
    })),
}));
// 设置更严格的超时
globals_1.jest.setTimeout(30000);
// 全局错误处理 - 任何未处理的错误都会导致测试失败
process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason);
    // 在测试环境中，让未处理的promise rejection导致测试失败
    throw new Error(`Unhandled promise rejection: ${reason}`);
});
process.on('uncaughtException', (error) => {
    console.error('Uncaught Exception:', error);
    // 在测试环境中，让未处理的异常导致测试失败
    throw error;
});
// 配置控制台警告 - 将console.error转换为测试失败
const originalConsoleError = console.error;
console.error = (...args) => {
    originalConsoleError(...args);
    // 在CI环境中，将console.error转换为测试失败
    if (process.env.CI) {
        throw new Error(`Console error detected: ${args.join(' ')}`);
    }
};
// Mock 全局对象以防止意外的网络调用
global.fetch = globals_1.jest.fn(() => Promise.reject(new Error('fetch should be mocked in tests')));
global.Request = globals_1.jest.fn();
global.Response = globals_1.jest.fn();
// 设置环境变量用于测试
process.env.NODE_ENV = 'test';
process.env.JWT_SECRET = 'test-jwt-secret-for-testing-only';
process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test_db';
// 补齐缺失的环境变量
process.env.ENCRYPTION_KEY = 'test-encryption-key-32-characters-long';
process.env.ENCRYPTION_SALT = 'test-encryption-salt-16-chars';
process.env.ENCRYPTION_USE_SALT = 'false';
process.env.ENCRYPTION_ALGORITHM = 'aes-256-gcm';
process.env.CLERK_SECRET_KEY = 'test-clerk-secret-key';
process.env.CLERK_PUBLISHABLE_KEY = 'test-clerk-publishable-key';
process.env.CLERK_WEBHOOK_SECRET_KEY = 'test-clerk-webhook-secret';
process.env.RABBITMQ_URL = 'amqp://localhost:5672';
process.env.REDIS_URL = 'redis://localhost:6379';
process.env.SENTRY_DSN = 'https://test@test.ingest.sentry.io/test';
process.env.SENTRY_ENVIRONMENT = 'test';
process.env.SENTRY_TRACES_SAMPLE_RATE = '0.1';
process.env.QDRANT_URL = 'http://localhost:6333';
process.env.QDRANT_API_KEY = 'test-qdrant-api-key';
process.env.FALLBACK_API_KEY = 'test-fallback-api-key';
process.env.FALLBACK_MODEL_ID = 'deepseek-chat';
process.env.FALLBACK_BASE_URL = 'https://api.deepseek.com';
process.env.DB_CONNECTION_LIMIT = '20';
process.env.DB_POOL_TIMEOUT = '20';
process.env.DB_IDLE_TIMEOUT = '300';
process.env.JWT_EXPIRATION_SECONDS = '3600';
process.env.BACKEND_GATEWAY_PORT = '3000';
process.env.CREATION_AGENT_HTTP_PORT = '8080';
process.env.LOGIC_AGENT_HTTP_PORT = '8081';
process.env.NARRATIVE_AGENT_HTTP_PORT = '8082';
// 清理函数 - 在每个测试后运行
afterEach(() => {
    // 重置所有mock
    globals_1.jest.clearAllMocks();
    // 清理任何可能的文件系统更改（如果适用）
    // 注意：实际的文件系统操作应该在集成测试中进行
    // 检查是否有未处理的异步操作
    if (globals_1.jest.getTimerCount() > 0) {
        console.warn(`Warning: ${globals_1.jest.getTimerCount()} timers still active after test`);
    }
});
afterAll(async () => {
    // 等待所有异步操作完成
    await new Promise(resolve => setImmediate(resolve));
    // 强制退出以防止Jest挂起
    setTimeout(() => {
        console.warn('Test suite did not exit cleanly, forcing exit');
        process.exit(0);
    }, 5000);
});
// 自定义匹配器
expect.extend({
    toBeValidDate(received) {
        const pass = received instanceof Date && !isNaN(received.getTime());
        if (pass) {
            return {
                message: () => `expected ${received} not to be a valid date`,
                pass: true,
            };
        }
        else {
            return {
                message: () => `expected ${received} to be a valid date`,
                pass: false,
            };
        }
    },
    toBeValidUUID(received) {
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        const pass = typeof received === 'string' && uuidRegex.test(received);
        if (pass) {
            return {
                message: () => `expected ${received} not to be a valid UUID`,
                pass: true,
            };
        }
        else {
            return {
                message: () => `expected ${received} to be a valid UUID`,
                pass: false,
            };
        }
    },
});
// 内存使用监控
if (process.env.CI) {
    const initialMemory = process.memoryUsage();
    const memoryThreshold = 500 * 1024 * 1024; // 500MB
    afterEach(() => {
        const currentMemory = process.memoryUsage();
        const memoryIncrease = currentMemory.heapUsed - initialMemory.heapUsed;
        if (memoryIncrease > memoryThreshold) {
            console.warn(`Warning: Memory usage increased by ${Math.round(memoryIncrease / 1024 / 1024)}MB`);
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LEdBQUcsZUFBZSxFQUFFLENBQUM7WUFDckMsT0FBTyxDQUFDLElBQUksQ0FBQyxzQ0FBc0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRyxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFx0ZXN0c1xcc2V0dXAudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEplc3Qg5YWo5bGA5rWL6K+V6K6+572uXHJcbiAqIOmFjee9rua1i+ivleeOr+Wig+eahOW/q+mAn+Wksei0peacuuWItuWSjOacgOS9s+Wunui3tVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IGplc3QgfSBmcm9tICdAamVzdC9nbG9iYWxzJztcclxuXHJcbi8vIOiuvue9ruabtOS4peagvOeahOi2heaXtlxyXG5qZXN0LnNldFRpbWVvdXQoMzAwMDApO1xyXG5cclxuLy8g5YWo5bGA6ZSZ6K+v5aSE55CGIC0g5Lu75L2V5pyq5aSE55CG55qE6ZSZ6K+v6YO95Lya5a+86Ie05rWL6K+V5aSx6LSlXHJcbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChyZWFzb24sIHByb21pc2UpID0+IHtcclxuICBjb25zb2xlLmVycm9yKCdVbmhhbmRsZWQgUmVqZWN0aW9uIGF0OicsIHByb21pc2UsICdyZWFzb246JywgcmVhc29uKTtcclxuICAvLyDlnKjmtYvor5Xnjq/looPkuK3vvIzorqnmnKrlpITnkIbnmoRwcm9taXNlIHJlamVjdGlvbuWvvOiHtOa1i+ivleWksei0pVxyXG4gIHRocm93IG5ldyBFcnJvcihgVW5oYW5kbGVkIHByb21pc2UgcmVqZWN0aW9uOiAke3JlYXNvbn1gKTtcclxufSk7XHJcblxyXG5wcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIChlcnJvcikgPT4ge1xyXG4gIGNvbnNvbGUuZXJyb3IoJ1VuY2F1Z2h0IEV4Y2VwdGlvbjonLCBlcnJvcik7XHJcbiAgLy8g5Zyo5rWL6K+V546v5aKD5Lit77yM6K6p5pyq5aSE55CG55qE5byC5bi45a+86Ie05rWL6K+V5aSx6LSlXHJcbiAgdGhyb3cgZXJyb3I7XHJcbn0pO1xyXG5cclxuLy8g6YWN572u5o6n5Yi25Y+w6K2m5ZGKIC0g5bCGY29uc29sZS5lcnJvcui9rOaNouS4uua1i+ivleWksei0pVxyXG5jb25zdCBvcmlnaW5hbENvbnNvbGVFcnJvciA9IGNvbnNvbGUuZXJyb3I7XHJcbmNvbnNvbGUuZXJyb3IgPSAoLi4uYXJnczogYW55W10pID0+IHtcclxuICBvcmlnaW5hbENvbnNvbGVFcnJvciguLi5hcmdzKTtcclxuICAvLyDlnKhDSeeOr+Wig+S4re+8jOWwhmNvbnNvbGUuZXJyb3LovazmjaLkuLrmtYvor5XlpLHotKVcclxuICBpZiAocHJvY2Vzcy5lbnYuQ0kpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihgQ29uc29sZSBlcnJvciBkZXRlY3RlZDogJHthcmdzLmpvaW4oJyAnKX1gKTtcclxuICB9XHJcbn07XHJcblxyXG4vLyBNb2NrIOWFqOWxgOWvueixoeS7pemYsuatouaEj+WklueahOe9kee7nOiwg+eUqFxyXG5nbG9iYWwuZmV0Y2ggPSBqZXN0LmZuKCgpID0+XHJcbiAgUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdmZXRjaCBzaG91bGQgYmUgbW9ja2VkIGluIHRlc3RzJykpXHJcbik7XHJcblxyXG5nbG9iYWwuUmVxdWVzdCA9IGplc3QuZm4oKTtcclxuZ2xvYmFsLlJlc3BvbnNlID0gamVzdC5mbigpO1xyXG5cclxuLy8gTW9jayBFU00gbW9kdWxlcyB0aGF0IGNhdXNlIGlzc3VlcyBpbiBKZXN0XHJcbmplc3QubW9jaygnbGFuZ2Z1c2UnLCAoKSA9PiAoe1xyXG4gIExhbmdmdXNlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XHJcbiAgICB0cmFjZTogamVzdC5mbigpLFxyXG4gICAgZ2VuZXJhdGlvbjogamVzdC5mbigpLFxyXG4gICAgc3BhbjogamVzdC5mbigpLFxyXG4gICAgc2NvcmU6IGplc3QuZm4oKSxcclxuICAgIHNodXRkb3duQXN5bmM6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxyXG4gIH0pKSxcclxufSkpO1xyXG5cclxuLy8g6K6+572u546v5aKD5Y+Y6YeP55So5LqO5rWL6K+VXHJcbnByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnO1xyXG5wcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gJ3Rlc3Qtand0LXNlY3JldC1mb3ItdGVzdGluZy1vbmx5JztcclxucHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMID0gJ3Bvc3RncmVzcWw6Ly90ZXN0OnRlc3RAbG9jYWxob3N0OjU0MzIvdGVzdF9kYic7XHJcblxyXG4vLyDooaXpvZDnvLrlpLHnmoTnjq/looPlj5jph49cclxucHJvY2Vzcy5lbnYuRU5DUllQVElPTl9LRVkgPSAndGVzdC1lbmNyeXB0aW9uLWtleS0zMi1jaGFyYWN0ZXJzLWxvbmcnO1xyXG5wcm9jZXNzLmVudi5FTkNSWVBUSU9OX1NBTFQgPSAndGVzdC1lbmNyeXB0aW9uLXNhbHQtMTYtY2hhcnMnO1xyXG5wcm9jZXNzLmVudi5FTkNSWVBUSU9OX1VTRV9TQUxUID0gJ2ZhbHNlJztcclxucHJvY2Vzcy5lbnYuRU5DUllQVElPTl9BTEdPUklUSE0gPSAnYWVzLTI1Ni1nY20nO1xyXG5wcm9jZXNzLmVudi5DTEVSS19TRUNSRVRfS0VZID0gJ3Rlc3QtY2xlcmstc2VjcmV0LWtleSc7XHJcbnByb2Nlc3MuZW52LkNMRVJLX1BVQkxJU0hBQkxFX0tFWSA9ICd0ZXN0LWNsZXJrLXB1Ymxpc2hhYmxlLWtleSc7XHJcbnByb2Nlc3MuZW52LkNMRVJLX1dFQkhPT0tfU0VDUkVUX0tFWSA9ICd0ZXN0LWNsZXJrLXdlYmhvb2stc2VjcmV0JztcclxucHJvY2Vzcy5lbnYuUkFCQklUTVFfVVJMID0gJ2FtcXA6Ly9sb2NhbGhvc3Q6NTY3Mic7XHJcbnByb2Nlc3MuZW52LlJFRElTX1VSTCA9ICdyZWRpczovL2xvY2FsaG9zdDo2Mzc5JztcclxucHJvY2Vzcy5lbnYuU0VOVFJZX0RTTiA9ICdodHRwczovL3Rlc3RAdGVzdC5pbmdlc3Quc2VudHJ5LmlvL3Rlc3QnO1xyXG5wcm9jZXNzLmVudi5TRU5UUllfRU5WSVJPTk1FTlQgPSAndGVzdCc7XHJcbnByb2Nlc3MuZW52LlNFTlRSWV9UUkFDRVNfU0FNUExFX1JBVEUgPSAnMC4xJztcclxucHJvY2Vzcy5lbnYuUURSQU5UX1VSTCA9ICdodHRwOi8vbG9jYWxob3N0OjYzMzMnO1xyXG5wcm9jZXNzLmVudi5RRFJBTlRfQVBJX0tFWSA9ICd0ZXN0LXFkcmFudC1hcGkta2V5JztcclxucHJvY2Vzcy5lbnYuRkFMTEJBQ0tfQVBJX0tFWSA9ICd0ZXN0LWZhbGxiYWNrLWFwaS1rZXknO1xyXG5wcm9jZXNzLmVudi5GQUxMQkFDS19NT0RFTF9JRCA9ICdkZWVwc2Vlay1jaGF0JztcclxucHJvY2Vzcy5lbnYuRkFMTEJBQ0tfQkFTRV9VUkwgPSAnaHR0cHM6Ly9hcGkuZGVlcHNlZWsuY29tJztcclxucHJvY2Vzcy5lbnYuREJfQ09OTkVDVElPTl9MSU1JVCA9ICcyMCc7XHJcbnByb2Nlc3MuZW52LkRCX1BPT0xfVElNRU9VVCA9ICcyMCc7XHJcbnByb2Nlc3MuZW52LkRCX0lETEVfVElNRU9VVCA9ICczMDAnO1xyXG5wcm9jZXNzLmVudi5KV1RfRVhQSVJBVElPTl9TRUNPTkRTID0gJzM2MDAnO1xyXG5wcm9jZXNzLmVudi5CQUNLRU5EX0dBVEVXQVlfUE9SVCA9ICczMDAwJztcclxucHJvY2Vzcy5lbnYuQ1JFQVRJT05fQUdFTlRfSFRUUF9QT1JUID0gJzgwODAnO1xyXG5wcm9jZXNzLmVudi5MT0dJQ19BR0VOVF9IVFRQX1BPUlQgPSAnODA4MSc7XHJcbnByb2Nlc3MuZW52Lk5BUlJBVElWRV9BR0VOVF9IVFRQX1BPUlQgPSAnODA4Mic7XHJcblxyXG4vLyDmuIXnkIblh73mlbAgLSDlnKjmr4/kuKrmtYvor5XlkI7ov5DooYxcclxuYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAvLyDph43nva7miYDmnIltb2NrXHJcbiAgamVzdC5jbGVhckFsbE1vY2tzKCk7XHJcblxyXG4gIC8vIOa4heeQhuS7u+S9leWPr+iDveeahOaWh+S7tuezu+e7n+abtOaUue+8iOWmguaenOmAgueUqO+8iVxyXG4gIC8vIOazqOaEj++8muWunumZheeahOaWh+S7tuezu+e7n+aTjeS9nOW6lOivpeWcqOmbhuaIkOa1i+ivleS4rei/m+ihjFxyXG5cclxuICAvLyDmo4Dmn6XmmK/lkKbmnInmnKrlpITnkIbnmoTlvILmraXmk43kvZxcclxuICBpZiAoamVzdC5nZXRUaW1lckNvdW50KCkgPiAwKSB7XHJcbiAgICBjb25zb2xlLndhcm4oYFdhcm5pbmc6ICR7amVzdC5nZXRUaW1lckNvdW50KCl9IHRpbWVycyBzdGlsbCBhY3RpdmUgYWZ0ZXIgdGVzdGApO1xyXG4gIH1cclxufSk7XHJcblxyXG5hZnRlckFsbChhc3luYyAoKSA9PiB7XHJcbiAgLy8g562J5b6F5omA5pyJ5byC5q2l5pON5L2c5a6M5oiQXHJcbiAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRJbW1lZGlhdGUocmVzb2x2ZSkpO1xyXG5cclxuICAvLyDlvLrliLbpgIDlh7rku6XpmLLmraJKZXN05oyC6LW3XHJcbiAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICBjb25zb2xlLndhcm4oJ1Rlc3Qgc3VpdGUgZGlkIG5vdCBleGl0IGNsZWFubHksIGZvcmNpbmcgZXhpdCcpO1xyXG4gICAgcHJvY2Vzcy5leGl0KDApO1xyXG4gIH0sIDUwMDApO1xyXG59KTtcclxuXHJcbi8vIOiHquWumuS5ieWMuemFjeWZqFxyXG5leHBlY3QuZXh0ZW5kKHtcclxuICB0b0JlVmFsaWREYXRlKHJlY2VpdmVkOiBhbnkpIHtcclxuICAgIGNvbnN0IHBhc3MgPSByZWNlaXZlZCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJlY2VpdmVkLmdldFRpbWUoKSk7XHJcbiAgICBpZiAocGFzcykge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIG1lc3NhZ2U6ICgpID0+IGBleHBlY3RlZCAke3JlY2VpdmVkfSBub3QgdG8gYmUgYSB2YWxpZCBkYXRlYCxcclxuICAgICAgICBwYXNzOiB0cnVlLFxyXG4gICAgICB9O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBtZXNzYWdlOiAoKSA9PiBgZXhwZWN0ZWQgJHtyZWNlaXZlZH0gdG8gYmUgYSB2YWxpZCBkYXRlYCxcclxuICAgICAgICBwYXNzOiBmYWxzZSxcclxuICAgICAgfTtcclxuICAgIH1cclxuICB9LFxyXG5cclxuICB0b0JlVmFsaWRVVUlEKHJlY2VpdmVkOiBhbnkpIHtcclxuICAgIGNvbnN0IHV1aWRSZWdleCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzEtNV1bMC05YS1mXXszfS1bODlhYl1bMC05YS1mXXszfS1bMC05YS1mXXsxMn0kL2k7XHJcbiAgICBjb25zdCBwYXNzID0gdHlwZW9mIHJlY2VpdmVkID09PSAnc3RyaW5nJyAmJiB1dWlkUmVnZXgudGVzdChyZWNlaXZlZCk7XHJcbiAgICBpZiAocGFzcykge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIG1lc3NhZ2U6ICgpID0+IGBleHBlY3RlZCAke3JlY2VpdmVkfSBub3QgdG8gYmUgYSB2YWxpZCBVVUlEYCxcclxuICAgICAgICBwYXNzOiB0cnVlLFxyXG4gICAgICB9O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBtZXNzYWdlOiAoKSA9PiBgZXhwZWN0ZWQgJHtyZWNlaXZlZH0gdG8gYmUgYSB2YWxpZCBVVUlEYCxcclxuICAgICAgICBwYXNzOiBmYWxzZSxcclxuICAgICAgfTtcclxuICAgIH1cclxuICB9LFxyXG59KTtcclxuXHJcbi8vIOWvvOWHuuexu+Wei+S7peS+v+WcqOa1i+ivleS4reS9v+eUqFxyXG5kZWNsYXJlIGdsb2JhbCB7XHJcbiAgbmFtZXNwYWNlIGplc3Qge1xyXG4gICAgaW50ZXJmYWNlIE1hdGNoZXJzPFI+IHtcclxuICAgICAgdG9CZVZhbGlkRGF0ZSgpOiBSO1xyXG4gICAgICB0b0JlVmFsaWRVVUlEKCk6IFI7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vLyDlhoXlrZjkvb/nlKjnm5HmjqdcclxuaWYgKHByb2Nlc3MuZW52LkNJKSB7XHJcbiAgY29uc3QgaW5pdGlhbE1lbW9yeSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKTtcclxuICBjb25zdCBtZW1vcnlUaHJlc2hvbGQgPSA1MDAgKiAxMDI0ICogMTAyNDsgLy8gNTAwTUJcclxuXHJcbiAgYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAgIGNvbnN0IGN1cnJlbnRNZW1vcnkgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7XHJcbiAgICBjb25zdCBtZW1vcnlJbmNyZWFzZSA9IGN1cnJlbnRNZW1vcnkuaGVhcFVzZWQgLSBpbml0aWFsTWVtb3J5LmhlYXBVc2VkO1xyXG5cclxuICAgIGlmIChtZW1vcnlJbmNyZWFzZSA+IG1lbW9yeVRocmVzaG9sZCkge1xyXG4gICAgICBjb25zb2xlLndhcm4oYFdhcm5pbmc6IE1lbW9yeSB1c2FnZSBpbmNyZWFzZWQgYnkgJHtNYXRoLnJvdW5kKG1lbW9yeUluY3JlYXNlIC8gMTAyNCAvIDEwMjQpfU1CYCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuIl0sInZlcnNpb24iOjN9