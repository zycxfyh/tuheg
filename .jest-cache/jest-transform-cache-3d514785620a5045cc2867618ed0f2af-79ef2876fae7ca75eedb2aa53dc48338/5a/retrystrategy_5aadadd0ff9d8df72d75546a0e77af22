d729e6ecbd119d542ab48f13a7b420a1
"use strict";
// 文件路径: packages/common-backend/src/ai/retry-strategy.ts
// 职责: 智能重试策略，根据错误类型决定是否重试，并实现指数退避
//
// 设计理念:
// - 不同的错误类型有不同的可重试性
// - 可重试错误：网络错误、超时、临时性 API 错误（429, 503）
// - 不可重试错误：认证失败、参数错误、业务逻辑错误
// - 验证错误：可以重试，但需要反馈错误信息给 AI
//
// 退避策略:
// - 指数退避：每次重试的延迟时间递增
// - 添加随机抖动（jitter）避免雷群效应
// - 最大延迟限制，避免等待时间过长
Object.defineProperty(exports, "__esModule", { value: true });
exports.DEFAULT_RETRY_CONFIG = exports.ErrorCategory = void 0;
exports.classifyError = classifyError;
exports.calculateRetryDelay = calculateRetryDelay;
exports.getRecommendedDelay = getRecommendedDelay;
exports.delay = delay;
/**
 * 错误类型分类
 */
var ErrorCategory;
(function (ErrorCategory) {
    /** 网络错误（连接失败、超时等）- 可重试 */
    ErrorCategory["NETWORK"] = "network";
    /** 临时性 API 错误（429 限流、503 服务不可用等）- 可重试 */
    ErrorCategory["TEMPORARY_API_ERROR"] = "temporary_api_error";
    /** JSON 格式错误 - 可重试（自动修复） */
    ErrorCategory["JSON_PARSE_ERROR"] = "json_parse_error";
    /** Schema 验证错误 - 可重试（带错误反馈） */
    ErrorCategory["VALIDATION_ERROR"] = "validation_error";
    /** 认证错误（401, 403）- 不可重试 */
    ErrorCategory["AUTHENTICATION_ERROR"] = "authentication_error";
    /** 参数错误（400）- 不可重试 */
    ErrorCategory["INVALID_REQUEST"] = "invalid_request";
    /** 业务逻辑错误 - 不可重试 */
    ErrorCategory["BUSINESS_LOGIC_ERROR"] = "business_logic_error";
    /** 未知错误 - 默认可重试 */
    ErrorCategory["UNKNOWN"] = "unknown";
})(ErrorCategory || (exports.ErrorCategory = ErrorCategory = {}));
/** 默认重试配置 */
exports.DEFAULT_RETRY_CONFIG = {
    maxRetries: 2,
    initialDelayMs: 500,
    maxDelayMs: 5000,
    backoffMultiplier: 2,
    enableJitter: true,
    jitterRatio: 0.2,
};
/**
 * 分类错误并决定是否应该重试
 *
 * @param error - 要分类的错误
 * @param validationFeedback - 如果是验证错误，提供格式化后的反馈信息
 * @returns 错误分类结果
 *
 * @remarks
 * 分类规则：
 * - 网络错误（ECONNREFUSED, ETIMEDOUT, ENOTFOUND 等）→ 可重试
 * - HTTP 429 (Rate Limit) → 可重试，延迟较长
 * - HTTP 503 (Service Unavailable) → 可重试
 * - HTTP 401/403 → 不可重试（认证问题）
 * - HTTP 400 → 不可重试（参数问题）
 * - JSON 解析错误 → 可重试（自动修复）
 * - Zod 验证错误 → 可重试（带反馈）
 * - 其他错误 → 默认可重试（保守策略）
 */
function classifyError(error, validationFeedback) {
    // Zod 验证错误
    if (error && typeof error === 'object' && 'issues' in error) {
        return {
            category: ErrorCategory.VALIDATION_ERROR,
            shouldRetry: true,
            message: 'Schema validation failed',
            hasFeedback: true,
            feedback: validationFeedback || undefined,
        };
    }
    // Error 对象
    if (error instanceof Error) {
        const errorMessage = error.message.toLowerCase();
        const errorName = error.name.toLowerCase();
        // 网络错误
        if (errorName.includes('network') ||
            errorMessage.includes('econnrefused') ||
            errorMessage.includes('etimedout') ||
            errorMessage.includes('enotfound') ||
            errorMessage.includes('socket') ||
            errorMessage.includes('timeout') ||
            errorMessage.includes('connection')) {
            return {
                category: ErrorCategory.NETWORK,
                shouldRetry: true,
                message: `Network error: ${error.message}`,
                hasFeedback: false,
            };
        }
        // HTTP 错误（如果有 status 属性）
        const statusCode = error.status ||
            error.statusCode;
        if (statusCode) {
            if (statusCode === 429) {
                return {
                    category: ErrorCategory.TEMPORARY_API_ERROR,
                    shouldRetry: true,
                    message: 'Rate limit exceeded (429)',
                    hasFeedback: false,
                };
            }
            if (statusCode === 503 || statusCode === 502 || statusCode === 504) {
                return {
                    category: ErrorCategory.TEMPORARY_API_ERROR,
                    shouldRetry: true,
                    message: `Service unavailable (${statusCode})`,
                    hasFeedback: false,
                };
            }
            if (statusCode === 401 || statusCode === 403) {
                return {
                    category: ErrorCategory.AUTHENTICATION_ERROR,
                    shouldRetry: false,
                    message: `Authentication failed (${statusCode})`,
                    hasFeedback: false,
                };
            }
            if (statusCode === 400) {
                return {
                    category: ErrorCategory.INVALID_REQUEST,
                    shouldRetry: false,
                    message: `Invalid request (${statusCode})`,
                    hasFeedback: false,
                };
            }
        }
        // JSON 解析错误
        if (errorName.includes('json') ||
            errorName.includes('syntax') ||
            errorMessage.includes('json') ||
            errorMessage.includes('parse')) {
            return {
                category: ErrorCategory.JSON_PARSE_ERROR,
                shouldRetry: true,
                message: `JSON parse error: ${error.message}`,
                hasFeedback: false,
            };
        }
        // 业务逻辑错误（特定错误名称）
        if (errorName.includes('business') ||
            errorName.includes('logic') ||
            errorMessage.includes('business logic')) {
            return {
                category: ErrorCategory.BUSINESS_LOGIC_ERROR,
                shouldRetry: false,
                message: `Business logic error: ${error.message}`,
                hasFeedback: false,
            };
        }
    }
    // 字符串错误
    if (typeof error === 'string') {
        const lowerError = error.toLowerCase();
        if (lowerError.includes('timeout') || lowerError.includes('network')) {
            return {
                category: ErrorCategory.NETWORK,
                shouldRetry: true,
                message: `Network error: ${error}`,
                hasFeedback: false,
            };
        }
    }
    // 默认：未知错误，保守策略（可重试）
    return {
        category: ErrorCategory.UNKNOWN,
        shouldRetry: true,
        message: error instanceof Error ? error.message : String(error),
        hasFeedback: false,
    };
}
/**
 * 计算重试延迟时间（指数退避 + 抖动）
 *
 * @param attemptNumber - 当前尝试次数（从 0 开始，0 是第一次尝试）
 * @param config - 重试配置
 * @returns 延迟时间（毫秒）
 *
 * @remarks
 * 公式：
 * - baseDelay = initialDelayMs * (backoffMultiplier ^ attemptNumber)
 * - delay = min(baseDelay, maxDelayMs)
 * - if enableJitter: delay = delay * (1 + random(-jitterRatio, +jitterRatio))
 *
 * 示例（initialDelayMs=500, backoffMultiplier=2, maxDelayMs=5000）:
 * - attempt 0: 500ms
 * - attempt 1: 1000ms (500 * 2)
 * - attempt 2: 2000ms (500 * 4)
 * - attempt 3: 4000ms (500 * 8)
 * - attempt 4: 5000ms (500 * 16, capped at maxDelayMs)
 */
function calculateRetryDelay(attemptNumber, config = exports.DEFAULT_RETRY_CONFIG) {
    // 计算基础延迟（指数退避）
    const baseDelay = Math.min(config.initialDelayMs * config.backoffMultiplier ** attemptNumber, config.maxDelayMs);
    // 添加随机抖动（如果启用）
    if (config.enableJitter) {
        const jitter = baseDelay * config.jitterRatio * (Math.random() - 0.5) * 2;
        return Math.max(0, Math.round(baseDelay + jitter));
    }
    return Math.round(baseDelay);
}
/**
 * 根据错误类别获取建议的延迟时间
 *
 * @param category - 错误类别
 * @param attemptNumber - 当前尝试次数
 * @param config - 重试配置
 * @returns 建议的延迟时间（毫秒）
 *
 * @remarks
 * 不同错误类型的特殊处理：
 * - Rate Limit (429): 使用更长的初始延迟
 * - Network Error: 标准指数退避
 * - Validation Error: 较短延迟（AI 修复应该很快）
 */
function getRecommendedDelay(category, attemptNumber, config = exports.DEFAULT_RETRY_CONFIG) {
    // Rate Limit 错误需要更长的延迟
    if (category === ErrorCategory.TEMPORARY_API_ERROR) {
        const rateLimitConfig = {
            ...config,
            initialDelayMs: 2000, // Rate limit 需要更长延迟
            maxDelayMs: 10000,
        };
        return calculateRetryDelay(attemptNumber, rateLimitConfig);
    }
    // 验证错误使用较短延迟（AI 应该能快速修复）
    if (category === ErrorCategory.VALIDATION_ERROR) {
        const validationConfig = {
            ...config,
            initialDelayMs: 200, // 验证错误修复应该很快
        };
        return calculateRetryDelay(attemptNumber, validationConfig);
    }
    // 其他错误使用标准延迟
    return calculateRetryDelay(attemptNumber, config);
}
/**
 * 延迟函数（Promise 包装的 setTimeout）
 *
 * @param ms - 延迟毫秒数
 * @returns Promise，在指定时间后 resolve
 */
function delay(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxhaS1kb21haW5cXHNyY1xcYWlcXHJldHJ5LXN0cmF0ZWd5LnRzIiwibWFwcGluZ3MiOiI7QUFBQSx5REFBeUQ7QUFDekQsa0NBQWtDO0FBQ2xDLEVBQUU7QUFDRixRQUFRO0FBQ1Isb0JBQW9CO0FBQ3BCLHVDQUF1QztBQUN2Qyw0QkFBNEI7QUFDNUIsNEJBQTRCO0FBQzVCLEVBQUU7QUFDRixRQUFRO0FBQ1IscUJBQXFCO0FBQ3JCLHlCQUF5QjtBQUN6QixvQkFBb0I7OztBQXNGcEIsc0NBNkhDO0FBc0JELGtEQWlCQztBQWdCRCxrREEwQkM7QUFRRCxzQkFFQztBQTVTRDs7R0FFRztBQUNILElBQVksYUFpQlg7QUFqQkQsV0FBWSxhQUFhO0lBQ3ZCLDBCQUEwQjtJQUMxQixvQ0FBbUIsQ0FBQTtJQUNuQix5Q0FBeUM7SUFDekMsNERBQTJDLENBQUE7SUFDM0MsNEJBQTRCO0lBQzVCLHNEQUFxQyxDQUFBO0lBQ3JDLCtCQUErQjtJQUMvQixzREFBcUMsQ0FBQTtJQUNyQywyQkFBMkI7SUFDM0IsOERBQTZDLENBQUE7SUFDN0Msc0JBQXNCO0lBQ3RCLG9EQUFtQyxDQUFBO0lBQ25DLG9CQUFvQjtJQUNwQiw4REFBNkMsQ0FBQTtJQUM3QyxtQkFBbUI7SUFDbkIsb0NBQW1CLENBQUE7QUFDckIsQ0FBQyxFQWpCVyxhQUFhLDZCQUFiLGFBQWEsUUFpQnhCO0FBb0NELGFBQWE7QUFDQSxRQUFBLG9CQUFvQixHQUFnQjtJQUMvQyxVQUFVLEVBQUUsQ0FBQztJQUNiLGNBQWMsRUFBRSxHQUFHO0lBQ25CLFVBQVUsRUFBRSxJQUFJO0lBQ2hCLGlCQUFpQixFQUFFLENBQUM7SUFDcEIsWUFBWSxFQUFFLElBQUk7SUFDbEIsV0FBVyxFQUFFLEdBQUc7Q0FDakIsQ0FBQTtBQUVEOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRztBQUNILFNBQWdCLGFBQWEsQ0FBQyxLQUFjLEVBQUUsa0JBQTJCO0lBQ3ZFLFdBQVc7SUFDWCxJ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QUFFLEtBQUs7U0FDbEIsQ0FBQTtRQUNELE9BQU8sbUJBQW1CLENBQUMsYUFBYSxFQUFFLGVBQWUsQ0FBQyxDQUFBO0lBQzVELENBQUM7SUFFRCx5QkFBeUI7SUFDekIsSUFBSSxRQUFRLEtBQUssYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDaEQsTUFBTSxnQkFBZ0IsR0FBRztZQUN2QixHQUFHLE1BQU07WUFDVCxjQUFjLEVBQUUsR0FBRyxFQUFFLGFBQWE7U0FDbkMsQ0FBQTtRQUNELE9BQU8sbUJBQW1CLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLENBQUE7SUFDN0QsQ0FBQztJQUVELGFBQWE7SUFDYixPQUFPLG1CQUFtQixDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUMsQ0FBQTtBQUNuRCxDQUFDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixLQUFLLENBQUMsRUFBVTtJQUM5QixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7QUFDMUQsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xccGFja2FnZXNcXGFpLWRvbWFpblxcc3JjXFxhaVxccmV0cnktc3RyYXRlZ3kudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8g5paH5Lu26Lev5b6EOiBwYWNrYWdlcy9jb21tb24tYmFja2VuZC9zcmMvYWkvcmV0cnktc3RyYXRlZ3kudHNcbi8vIOiBjOi0ozog5pm66IO96YeN6K+V562W55Wl77yM5qC55o2u6ZSZ6K+v57G75Z6L5Yaz5a6a5piv5ZCm6YeN6K+V77yM5bm25a6e546w5oyH5pWw6YCA6YG/XG4vL1xuLy8g6K6+6K6h55CG5b+1OlxuLy8gLSDkuI3lkIznmoTplJnor6/nsbvlnovmnInkuI3lkIznmoTlj6/ph43or5XmgKdcbi8vIC0g5Y+v6YeN6K+V6ZSZ6K+v77ya572R57uc6ZSZ6K+v44CB6LaF5pe244CB5Li05pe25oCnIEFQSSDplJnor6/vvIg0MjksIDUwM++8iVxuLy8gLSDkuI3lj6/ph43or5XplJnor6/vvJrorqTor4HlpLHotKXjgIHlj4LmlbDplJnor6/jgIHkuJrliqHpgLvovpHplJnor69cbi8vIC0g6aqM6K+B6ZSZ6K+v77ya5Y+v5Lul6YeN6K+V77yM5L2G6ZyA6KaB5Y+N6aaI6ZSZ6K+v5L+h5oGv57uZIEFJXG4vL1xuLy8g6YCA6YG/562W55WlOlxuLy8gLSDmjIfmlbDpgIDpgb/vvJrmr4/mrKHph43or5XnmoTlu7bov5/ml7bpl7TpgJLlop5cbi8vIC0g5re75Yqg6ZqP5py65oqW5Yqo77yIaml0dGVy77yJ6YG/5YWN6Zu3576k5pWI5bqUXG4vLyAtIOacgOWkp+W7tui/n+mZkOWItu+8jOmBv+WFjeetieW+heaXtumXtOi/h+mVv1xuXG4vKipcbiAqIOmUmeivr+exu+Wei+WIhuexu1xuICovXG5leHBvcnQgZW51bSBFcnJvckNhdGVnb3J5IHtcbiAgLyoqIOe9kee7nOmUmeivr++8iOi/nuaOpeWksei0peOAgei2heaXtuetie+8iS0g5Y+v6YeN6K+VICovXG4gIE5FVFdPUksgPSAnbmV0d29yaycsXG4gIC8qKiDkuLTml7bmgKcgQVBJIOmUmeivr++8iDQyOSDpmZDmtYHjgIE1MDMg5pyN5Yqh5LiN5Y+v55So562J77yJLSDlj6/ph43or5UgKi9cbiAgVEVNUE9SQVJZX0FQSV9FUlJPUiA9ICd0ZW1wb3JhcnlfYXBpX2Vycm9yJyxcbiAgLyoqIEpTT04g5qC85byP6ZSZ6K+vIC0g5Y+v6YeN6K+V77yI6Ieq5Yqo5L+u5aSN77yJICovXG4gIEpTT05fUEFSU0VfRVJST1IgPSAnanNvbl9wYXJzZV9lcnJvcicsXG4gIC8qKiBTY2hlbWEg6aqM6K+B6ZSZ6K+vIC0g5Y+v6YeN6K+V77yI5bim6ZSZ6K+v5Y+N6aaI77yJICovXG4gIFZBTElEQVRJT05fRVJST1IgPSAndmFsaWRhdGlvbl9lcnJvcicsXG4gIC8qKiDorqTor4HplJnor6/vvIg0MDEsIDQwM++8iS0g5LiN5Y+v6YeN6K+VICovXG4gIEFVVEhFTlRJQ0FUSU9OX0VSUk9SID0gJ2F1dGhlbnRpY2F0aW9uX2Vycm9yJyxcbiAgLyoqIOWPguaVsOmUmeivr++8iDQwMO+8iS0g5LiN5Y+v6YeN6K+VICovXG4gIElOVkFMSURfUkVRVUVTVCA9ICdpbnZhbGlkX3JlcXVlc3QnLFxuICAvKiog5Lia5Yqh6YC76L6R6ZSZ6K+vIC0g5LiN5Y+v6YeN6K+VICovXG4gIEJVU0lORVNTX0xPR0lDX0VSUk9SID0gJ2J1c2luZXNzX2xvZ2ljX2Vycm9yJyxcbiAgLyoqIOacquefpemUmeivryAtIOm7mOiupOWPr+mHjeivlSAqL1xuICBVTktOT1dOID0gJ3Vua25vd24nLFxufVxuXG4vKipcbiAqIOmUmeivr+WIhuexu+e7k+aenFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEVycm9yQ2xhc3NpZmljYXRpb24ge1xuICAvKiog6ZSZ6K+v57G75YirICovXG4gIGNhdGVnb3J5OiBFcnJvckNhdGVnb3J5XG4gIC8qKiDmmK/lkKblupTor6Xph43or5UgKi9cbiAgc2hvdWxkUmV0cnk6IGJvb2xlYW5cbiAgLyoqIOmUmeivr+a2iOaBryAqL1xuICBtZXNzYWdlOiBzdHJpbmdcbiAgLyoqIOaYr+WQpuWMheWQq+mUmeivr+WPjemmiOS/oeaBr++8iOeUqOS6juS8oOmAkue7mSBBSe+8iSAqL1xuICBoYXNGZWVkYmFjazogYm9vbGVhblxuICAvKiog6ZSZ6K+v5Y+N6aaI5L+h5oGv77yI5aaC5p6c6YCC55So77yJICovXG4gIGZlZWRiYWNrPzogc3RyaW5nXG59XG5cbi8qKlxuICog6YeN6K+V6YWN572uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUmV0cnlDb25maWcge1xuICAvKiog5pyA5aSn6YeN6K+V5qyh5pWw77yI5LiN5YyF5ous5Yid5aeL5bCd6K+V77yJICovXG4gIG1heFJldHJpZXM6IG51bWJlclxuICAvKiog5Yid5aeL5bu26L+f77yI5q+r56eS77yJICovXG4gIGluaXRpYWxEZWxheU1zOiBudW1iZXJcbiAgLyoqIOacgOWkp+W7tui/n++8iOavq+enku+8iSAqL1xuICBtYXhEZWxheU1zOiBudW1iZXJcbiAgLyoqIOaMh+aVsOmAgOmBv+eahOW6leaVsO+8iOm7mOiupCAy77yJICovXG4gIGJhY2tvZmZNdWx0aXBsaWVyOiBudW1iZXJcbiAgLyoqIOaYr+WQpuWQr+eUqOmaj+acuuaKluWKqCAqL1xuICBlbmFibGVKaXR0ZXI6IGJvb2xlYW5cbiAgLyoqIOaKluWKqOeZvuWIhuavlO+8iDAtMe+8jOm7mOiupCAwLjIg5Y2zIMKxMjAl77yJICovXG4gIGppdHRlclJhdGlvOiBudW1iZXJcbn1cblxuLyoqIOm7mOiupOmHjeivlemFjee9riAqL1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfUkVUUllfQ09ORklHOiBSZXRyeUNvbmZpZyA9IHtcbiAgbWF4UmV0cmllczogMixcbiAgaW5pdGlhbERlbGF5TXM6IDUwMCxcbiAgbWF4RGVsYXlNczogNTAwMCxcbiAgYmFja29mZk11bHRpcGxpZXI6IDIsXG4gIGVuYWJsZUppdHRlcjogdHJ1ZSxcbiAgaml0dGVyUmF0aW86IDAuMixcbn1cblxuLyoqXG4gKiDliIbnsbvplJnor6/lubblhrPlrprmmK/lkKblupTor6Xph43or5VcbiAqXG4gKiBAcGFyYW0gZXJyb3IgLSDopoHliIbnsbvnmoTplJnor69cbiAqIEBwYXJhbSB2YWxpZGF0aW9uRmVlZGJhY2sgLSDlpoLmnpzmmK/pqozor4HplJnor6/vvIzmj5DkvpvmoLzlvI/ljJblkI7nmoTlj43ppojkv6Hmga9cbiAqIEByZXR1cm5zIOmUmeivr+WIhuexu+e7k+aenFxuICpcbiAqIEByZW1hcmtzXG4gKiDliIbnsbvop4TliJnvvJpcbiAqIC0g572R57uc6ZSZ6K+v77yIRUNPTk5SRUZVU0VELCBFVElNRURPVVQsIEVOT1RGT1VORCDnrYnvvInihpIg5Y+v6YeN6K+VXG4gKiAtIEhUVFAgNDI5IChSYXRlIExpbWl0KSDihpIg5Y+v6YeN6K+V77yM5bu26L+f6L6D6ZW/XG4gKiAtIEhUVFAgNTAzIChTZXJ2aWNlIFVuYXZhaWxhYmxlKSDihpIg5Y+v6YeN6K+VXG4gKiAtIEhUVFAgNDAxLzQwMyDihpIg5LiN5Y+v6YeN6K+V77yI6K6k6K+B6Zeu6aKY77yJXG4gKiAtIEhUVFAgNDAwIOKGkiDkuI3lj6/ph43or5XvvIjlj4LmlbDpl67popjvvIlcbiAqIC0gSlNPTiDop6PmnpDplJnor68g4oaSIOWPr+mHjeivle+8iOiHquWKqOS/ruWkje+8iVxuICogLSBab2Qg6aqM6K+B6ZSZ6K+vIOKGkiDlj6/ph43or5XvvIjluKblj43ppojvvIlcbiAqIC0g5YW25LuW6ZSZ6K+vIOKGkiDpu5jorqTlj6/ph43or5XvvIjkv53lrojnrZbnlaXvvIlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNsYXNzaWZ5RXJyb3IoZXJyb3I6IHVua25vd24sIHZhbGlkYXRpb25GZWVkYmFjaz86IHN0cmluZyk6IEVycm9yQ2xhc3NpZmljYXRpb24ge1xuICAvLyBab2Qg6aqM6K+B6ZSZ6K+vXG4gIGlmIChlcnJvciAmJiB0eXBlb2YgZXJyb3IgPT09ICdvYmplY3QnICYmICdpc3N1ZXMnIGluIGVycm9yKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNhdGVnb3J5OiBFcnJvckNhdGVnb3J5LlZBTElEQVRJT05fRVJST1IsXG4gICAgICBzaG91bGRSZXRyeTogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6ICdTY2hlbWEgdmFsaWRhdGlvbiBmYWlsZWQnLFxuICAgICAgaGFzRmVlZGJhY2s6IHRydWUsXG4gICAgICBmZWVkYmFjazogdmFsaWRhdGlvbkZlZWRiYWNrIHx8IHVuZGVmaW5lZCxcbiAgICB9XG4gIH1cblxuICAvLyBFcnJvciDlr7nosaFcbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlLnRvTG93ZXJDYXNlKClcbiAgICBjb25zdCBlcnJvck5hbWUgPSBlcnJvci5uYW1lLnRvTG93ZXJDYXNlKClcblxuICAgIC8vIOe9kee7nOmUmeivr1xuICAgIGlmIChcbiAgICAgIGVycm9yTmFtZS5pbmNsdWRlcygnbmV0d29yaycpIHx8XG4gICAgICBlcnJvck1lc3NhZ2UuaW5jbHVkZXMoJ2Vjb25ucmVmdXNlZCcpIHx8XG4gICAgICBlcnJvck1lc3NhZ2UuaW5jbHVkZXMoJ2V0aW1lZG91dCcpIHx8XG4gICAgICBlcnJvck1lc3NhZ2UuaW5jbHVkZXMoJ2Vub3Rmb3VuZCcpIHx8XG4gICAgICBlcnJvck1lc3NhZ2UuaW5jbHVkZXMoJ3NvY2tldCcpIHx8XG4gICAgICBlcnJvck1lc3NhZ2UuaW5jbHVkZXMoJ3RpbWVvdXQnKSB8fFxuICAgICAgZXJyb3JNZXNzYWdlLmluY2x1ZGVzKCdjb25uZWN0aW9uJylcbiAgICApIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNhdGVnb3J5OiBFcnJvckNhdGVnb3J5Lk5FVFdPUkssXG4gICAgICAgIHNob3VsZFJldHJ5OiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiBgTmV0d29yayBlcnJvcjogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGhhc0ZlZWRiYWNrOiBmYWxzZSxcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBIVFRQIOmUmeivr++8iOWmguaenOaciSBzdGF0dXMg5bGe5oCn77yJXG4gICAgY29uc3Qgc3RhdHVzQ29kZSA9XG4gICAgICAoZXJyb3IgYXMgeyBzdGF0dXM/OiBudW1iZXI7IHN0YXR1c0NvZGU/OiBudW1iZXIgfSkuc3RhdHVzIHx8XG4gICAgICAoZXJyb3IgYXMgeyBzdGF0dXM/OiBudW1iZXI7IHN0YXR1c0NvZGU/OiBudW1iZXIgfSkuc3RhdHVzQ29kZVxuXG4gICAgaWYgKHN0YXR1c0NvZGUpIHtcbiAgICAgIGlmIChzdGF0dXNDb2RlID09PSA0MjkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjYXRlZ29yeTogRXJyb3JDYXRlZ29yeS5URU1QT1JBUllfQVBJX0VSUk9SLFxuICAgICAgICAgIHNob3VsZFJldHJ5OiB0cnVlLFxuICAgICAgICAgIG1lc3NhZ2U6ICdSYXRlIGxpbWl0IGV4Y2VlZGVkICg0MjkpJyxcbiAgICAgICAgICBoYXNGZWVkYmFjazogZmFsc2UsXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChzdGF0dXNDb2RlID09PSA1MDMgfHwgc3RhdHVzQ29kZSA9PT0gNTAyIHx8IHN0YXR1c0NvZGUgPT09IDUwNCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNhdGVnb3J5OiBFcnJvckNhdGVnb3J5LlRFTVBPUkFSWV9BUElfRVJST1IsXG4gICAgICAgICAgc2hvdWxkUmV0cnk6IHRydWUsXG4gICAgICAgICAgbWVzc2FnZTogYFNlcnZpY2UgdW5hdmFpbGFibGUgKCR7c3RhdHVzQ29kZX0pYCxcbiAgICAgICAgICBoYXNGZWVkYmFjazogZmFsc2UsXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChzdGF0dXNDb2RlID09PSA0MDEgfHwgc3RhdHVzQ29kZSA9PT0gNDAzKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY2F0ZWdvcnk6IEVycm9yQ2F0ZWdvcnkuQVVUSEVOVElDQVRJT05fRVJST1IsXG4gICAgICAgICAgc2hvdWxkUmV0cnk6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6IGBBdXRoZW50aWNhdGlvbiBmYWlsZWQgKCR7c3RhdHVzQ29kZX0pYCxcbiAgICAgICAgICBoYXNGZWVkYmFjazogZmFsc2UsXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChzdGF0dXNDb2RlID09PSA0MDApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjYXRlZ29yeTogRXJyb3JDYXRlZ29yeS5JTlZBTElEX1JFUVVFU1QsXG4gICAgICAgICAgc2hvdWxkUmV0cnk6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIHJlcXVlc3QgKCR7c3RhdHVzQ29kZX0pYCxcbiAgICAgICAgICBoYXNGZWVkYmFjazogZmFsc2UsXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBKU09OIOino+aekOmUmeivr1xuICAgIGlmIChcbiAgICAgIGVycm9yTmFtZS5pbmNsdWRlcygnanNvbicpIHx8XG4gICAgICBlcnJvck5hbWUuaW5jbHVkZXMoJ3N5bnRheCcpIHx8XG4gICAgICBlcnJvck1lc3NhZ2UuaW5jbHVkZXMoJ2pzb24nKSB8fFxuICAgICAgZXJyb3JNZXNzYWdlLmluY2x1ZGVzKCdwYXJzZScpXG4gICAgKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjYXRlZ29yeTogRXJyb3JDYXRlZ29yeS5KU09OX1BBUlNFX0VSUk9SLFxuICAgICAgICBzaG91bGRSZXRyeTogdHJ1ZSxcbiAgICAgICAgbWVzc2FnZTogYEpTT04gcGFyc2UgZXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBoYXNGZWVkYmFjazogZmFsc2UsXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8g5Lia5Yqh6YC76L6R6ZSZ6K+v77yI54m55a6a6ZSZ6K+v5ZCN56ew77yJXG4gICAgaWYgKFxuICAgICAgZXJyb3JOYW1lLmluY2x1ZGVzKCdidXNpbmVzcycpIHx8XG4gICAgICBlcnJvck5hbWUuaW5jbHVkZXMoJ2xvZ2ljJykgfHxcbiAgICAgIGVycm9yTWVzc2FnZS5pbmNsdWRlcygnYnVzaW5lc3MgbG9naWMnKVxuICAgICkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgY2F0ZWdvcnk6IEVycm9yQ2F0ZWdvcnkuQlVTSU5FU1NfTE9HSUNfRVJST1IsXG4gICAgICAgIHNob3VsZFJldHJ5OiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogYEJ1c2luZXNzIGxvZ2ljIGVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICAgaGFzRmVlZGJhY2s6IGZhbHNlLFxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIOWtl+espuS4sumUmeivr1xuICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykge1xuICAgIGNvbnN0IGxvd2VyRXJyb3IgPSBlcnJvci50b0xvd2VyQ2FzZSgpXG4gICAgaWYgKGxvd2VyRXJyb3IuaW5jbHVkZXMoJ3RpbWVvdXQnKSB8fCBsb3dlckVycm9yLmluY2x1ZGVzKCduZXR3b3JrJykpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNhdGVnb3J5OiBFcnJvckNhdGVnb3J5Lk5FVFdPUkssXG4gICAgICAgIHNob3VsZFJldHJ5OiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiBgTmV0d29yayBlcnJvcjogJHtlcnJvcn1gLFxuICAgICAgICBoYXNGZWVkYmFjazogZmFsc2UsXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8g6buY6K6k77ya5pyq55+l6ZSZ6K+v77yM5L+d5a6I562W55Wl77yI5Y+v6YeN6K+V77yJXG4gIHJldHVybiB7XG4gICAgY2F0ZWdvcnk6IEVycm9yQ2F0ZWdvcnkuVU5LTk9XTixcbiAgICBzaG91bGRSZXRyeTogdHJ1ZSxcbiAgICBtZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgaGFzRmVlZGJhY2s6IGZhbHNlLFxuICB9XG59XG5cbi8qKlxuICog6K6h566X6YeN6K+V5bu26L+f5pe26Ze077yI5oyH5pWw6YCA6YG/ICsg5oqW5Yqo77yJXG4gKlxuICogQHBhcmFtIGF0dGVtcHROdW1iZXIgLSDlvZPliY3lsJ3or5XmrKHmlbDvvIjku44gMCDlvIDlp4vvvIwwIOaYr+esrOS4gOasoeWwneivle+8iVxuICogQHBhcmFtIGNvbmZpZyAtIOmHjeivlemFjee9rlxuICogQHJldHVybnMg5bu26L+f5pe26Ze077yI5q+r56eS77yJXG4gKlxuICogQHJlbWFya3NcbiAqIOWFrOW8j++8mlxuICogLSBiYXNlRGVsYXkgPSBpbml0aWFsRGVsYXlNcyAqIChiYWNrb2ZmTXVsdGlwbGllciBeIGF0dGVtcHROdW1iZXIpXG4gKiAtIGRlbGF5ID0gbWluKGJhc2VEZWxheSwgbWF4RGVsYXlNcylcbiAqIC0gaWYgZW5hYmxlSml0dGVyOiBkZWxheSA9IGRlbGF5ICogKDEgKyByYW5kb20oLWppdHRlclJhdGlvLCAraml0dGVyUmF0aW8pKVxuICpcbiAqIOekuuS+i++8iGluaXRpYWxEZWxheU1zPTUwMCwgYmFja29mZk11bHRpcGxpZXI9MiwgbWF4RGVsYXlNcz01MDAw77yJOlxuICogLSBhdHRlbXB0IDA6IDUwMG1zXG4gKiAtIGF0dGVtcHQgMTogMTAwMG1zICg1MDAgKiAyKVxuICogLSBhdHRlbXB0IDI6IDIwMDBtcyAoNTAwICogNClcbiAqIC0gYXR0ZW1wdCAzOiA0MDAwbXMgKDUwMCAqIDgpXG4gKiAtIGF0dGVtcHQgNDogNTAwMG1zICg1MDAgKiAxNiwgY2FwcGVkIGF0IG1heERlbGF5TXMpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVSZXRyeURlbGF5KFxuICBhdHRlbXB0TnVtYmVyOiBudW1iZXIsXG4gIGNvbmZpZzogUmV0cnlDb25maWcgPSBERUZBVUxUX1JFVFJZX0NPTkZJR1xuKTogbnVtYmVyIHtcbiAgLy8g6K6h566X5Z+656GA5bu26L+f77yI5oyH5pWw6YCA6YG/77yJXG4gIGNvbnN0IGJhc2VEZWxheSA9IE1hdGgubWluKFxuICAgIGNvbmZpZy5pbml0aWFsRGVsYXlNcyAqIGNvbmZpZy5iYWNrb2ZmTXVsdGlwbGllciAqKiBhdHRlbXB0TnVtYmVyLFxuICAgIGNvbmZpZy5tYXhEZWxheU1zXG4gIClcblxuICAvLyDmt7vliqDpmo/mnLrmipbliqjvvIjlpoLmnpzlkK/nlKjvvIlcbiAgaWYgKGNvbmZpZy5lbmFibGVKaXR0ZXIpIHtcbiAgICBjb25zdCBqaXR0ZXIgPSBiYXNlRGVsYXkgKiBjb25maWcuaml0dGVyUmF0aW8gKiAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyXG4gICAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgucm91bmQoYmFzZURlbGF5ICsgaml0dGVyKSlcbiAgfVxuXG4gIHJldHVybiBNYXRoLnJvdW5kKGJhc2VEZWxheSlcbn1cblxuLyoqXG4gKiDmoLnmja7plJnor6/nsbvliKvojrflj5blu7rorq7nmoTlu7bov5/ml7bpl7RcbiAqXG4gKiBAcGFyYW0gY2F0ZWdvcnkgLSDplJnor6/nsbvliKtcbiAqIEBwYXJhbSBhdHRlbXB0TnVtYmVyIC0g5b2T5YmN5bCd6K+V5qyh5pWwXG4gKiBAcGFyYW0gY29uZmlnIC0g6YeN6K+V6YWN572uXG4gKiBAcmV0dXJucyDlu7rorq7nmoTlu7bov5/ml7bpl7TvvIjmr6vnp5LvvIlcbiAqXG4gKiBAcmVtYXJrc1xuICog5LiN5ZCM6ZSZ6K+v57G75Z6L55qE54m55q6K5aSE55CG77yaXG4gKiAtIFJhdGUgTGltaXQgKDQyOSk6IOS9v+eUqOabtOmVv+eahOWIneWni+W7tui/n1xuICogLSBOZXR3b3JrIEVycm9yOiDmoIflh4bmjIfmlbDpgIDpgb9cbiAqIC0gVmFsaWRhdGlvbiBFcnJvcjog6L6D55+t5bu26L+f77yIQUkg5L+u5aSN5bqU6K+l5b6I5b+r77yJXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRSZWNvbW1lbmRlZERlbGF5KFxuICBjYXRlZ29yeTogRXJyb3JDYXRlZ29yeSxcbiAgYXR0ZW1wdE51bWJlcjogbnVtYmVyLFxuICBjb25maWc6IFJldHJ5Q29uZmlnID0gREVGQVVMVF9SRVRSWV9DT05GSUdcbik6IG51bWJlciB7XG4gIC8vIFJhdGUgTGltaXQg6ZSZ6K+v6ZyA6KaB5pu06ZW/55qE5bu26L+fXG4gIGlmIChjYXRlZ29yeSA9PT0gRXJyb3JDYXRlZ29yeS5URU1QT1JBUllfQVBJX0VSUk9SKSB7XG4gICAgY29uc3QgcmF0ZUxpbWl0Q29uZmlnID0ge1xuICAgICAgLi4uY29uZmlnLFxuICAgICAgaW5pdGlhbERlbGF5TXM6IDIwMDAsIC8vIFJhdGUgbGltaXQg6ZyA6KaB5pu06ZW/5bu26L+fXG4gICAgICBtYXhEZWxheU1zOiAxMDAwMCxcbiAgICB9XG4gICAgcmV0dXJuIGNhbGN1bGF0ZVJldHJ5RGVsYXkoYXR0ZW1wdE51bWJlciwgcmF0ZUxpbWl0Q29uZmlnKVxuICB9XG5cbiAgLy8g6aqM6K+B6ZSZ6K+v5L2/55So6L6D55+t5bu26L+f77yIQUkg5bqU6K+l6IO95b+r6YCf5L+u5aSN77yJXG4gIGlmIChjYXRlZ29yeSA9PT0gRXJyb3JDYXRlZ29yeS5WQUxJREFUSU9OX0VSUk9SKSB7XG4gICAgY29uc3QgdmFsaWRhdGlvbkNvbmZpZyA9IHtcbiAgICAgIC4uLmNvbmZpZyxcbiAgICAgIGluaXRpYWxEZWxheU1zOiAyMDAsIC8vIOmqjOivgemUmeivr+S/ruWkjeW6lOivpeW+iOW/q1xuICAgIH1cbiAgICByZXR1cm4gY2FsY3VsYXRlUmV0cnlEZWxheShhdHRlbXB0TnVtYmVyLCB2YWxpZGF0aW9uQ29uZmlnKVxuICB9XG5cbiAgLy8g5YW25LuW6ZSZ6K+v5L2/55So5qCH5YeG5bu26L+fXG4gIHJldHVybiBjYWxjdWxhdGVSZXRyeURlbGF5KGF0dGVtcHROdW1iZXIsIGNvbmZpZylcbn1cblxuLyoqXG4gKiDlu7bov5/lh73mlbDvvIhQcm9taXNlIOWMheijheeahCBzZXRUaW1lb3V077yJXG4gKlxuICogQHBhcmFtIG1zIC0g5bu26L+f5q+r56eS5pWwXG4gKiBAcmV0dXJucyBQcm9taXNl77yM5Zyo5oyH5a6a5pe26Ze05ZCOIHJlc29sdmVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRlbGF5KG1zOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSlcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==