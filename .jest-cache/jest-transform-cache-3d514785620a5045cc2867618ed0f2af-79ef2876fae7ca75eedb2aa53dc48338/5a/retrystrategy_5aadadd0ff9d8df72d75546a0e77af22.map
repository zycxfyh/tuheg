{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\ai-domain\\src\\ai\\retry-strategy.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\ai-domain\\src\\ai\\retry-strategy.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/ai/retry-strategy.ts\n// 职责: 智能重试策略，根据错误类型决定是否重试，并实现指数退避\n//\n// 设计理念:\n// - 不同的错误类型有不同的可重试性\n// - 可重试错误：网络错误、超时、临时性 API 错误（429, 503）\n// - 不可重试错误：认证失败、参数错误、业务逻辑错误\n// - 验证错误：可以重试，但需要反馈错误信息给 AI\n//\n// 退避策略:\n// - 指数退避：每次重试的延迟时间递增\n// - 添加随机抖动（jitter）避免雷群效应\n// - 最大延迟限制，避免等待时间过长\n\n/**\n * 错误类型分类\n */\nexport enum ErrorCategory {\n  /** 网络错误（连接失败、超时等）- 可重试 */\n  NETWORK = 'network',\n  /** 临时性 API 错误（429 限流、503 服务不可用等）- 可重试 */\n  TEMPORARY_API_ERROR = 'temporary_api_error',\n  /** JSON 格式错误 - 可重试（自动修复） */\n  JSON_PARSE_ERROR = 'json_parse_error',\n  /** Schema 验证错误 - 可重试（带错误反馈） */\n  VALIDATION_ERROR = 'validation_error',\n  /** 认证错误（401, 403）- 不可重试 */\n  AUTHENTICATION_ERROR = 'authentication_error',\n  /** 参数错误（400）- 不可重试 */\n  INVALID_REQUEST = 'invalid_request',\n  /** 业务逻辑错误 - 不可重试 */\n  BUSINESS_LOGIC_ERROR = 'business_logic_error',\n  /** 未知错误 - 默认可重试 */\n  UNKNOWN = 'unknown',\n}\n\n/**\n * 错误分类结果\n */\nexport interface ErrorClassification {\n  /** 错误类别 */\n  category: ErrorCategory\n  /** 是否应该重试 */\n  shouldRetry: boolean\n  /** 错误消息 */\n  message: string\n  /** 是否包含错误反馈信息（用于传递给 AI） */\n  hasFeedback: boolean\n  /** 错误反馈信息（如果适用） */\n  feedback?: string\n}\n\n/**\n * 重试配置\n */\nexport interface RetryConfig {\n  /** 最大重试次数（不包括初始尝试） */\n  maxRetries: number\n  /** 初始延迟（毫秒） */\n  initialDelayMs: number\n  /** 最大延迟（毫秒） */\n  maxDelayMs: number\n  /** 指数退避的底数（默认 2） */\n  backoffMultiplier: number\n  /** 是否启用随机抖动 */\n  enableJitter: boolean\n  /** 抖动百分比（0-1，默认 0.2 即 ±20%） */\n  jitterRatio: number\n}\n\n/** 默认重试配置 */\nexport const DEFAULT_RETRY_CONFIG: RetryConfig = {\n  maxRetries: 2,\n  initialDelayMs: 500,\n  maxDelayMs: 5000,\n  backoffMultiplier: 2,\n  enableJitter: true,\n  jitterRatio: 0.2,\n}\n\n/**\n * 分类错误并决定是否应该重试\n *\n * @param error - 要分类的错误\n * @param validationFeedback - 如果是验证错误，提供格式化后的反馈信息\n * @returns 错误分类结果\n *\n * @remarks\n * 分类规则：\n * - 网络错误（ECONNREFUSED, ETIMEDOUT, ENOTFOUND 等）→ 可重试\n * - HTTP 429 (Rate Limit) → 可重试，延迟较长\n * - HTTP 503 (Service Unavailable) → 可重试\n * - HTTP 401/403 → 不可重试（认证问题）\n * - HTTP 400 → 不可重试（参数问题）\n * - JSON 解析错误 → 可重试（自动修复）\n * - Zod 验证错误 → 可重试（带反馈）\n * - 其他错误 → 默认可重试（保守策略）\n */\nexport function classifyError(error: unknown, validationFeedback?: string): ErrorClassification {\n  // Zod 验证错误\n  if (error && typeof error === 'object' && 'issues' in error) {\n    return {\n      category: ErrorCategory.VALIDATION_ERROR,\n      shouldRetry: true,\n      message: 'Schema validation failed',\n      hasFeedback: true,\n      feedback: validationFeedback || undefined,\n    }\n  }\n\n  // Error 对象\n  if (error instanceof Error) {\n    const errorMessage = error.message.toLowerCase()\n    const errorName = error.name.toLowerCase()\n\n    // 网络错误\n    if (\n      errorName.includes('network') ||\n      errorMessage.includes('econnrefused') ||\n      errorMessage.includes('etimedout') ||\n      errorMessage.includes('enotfound') ||\n      errorMessage.includes('socket') ||\n      errorMessage.includes('timeout') ||\n      errorMessage.includes('connection')\n    ) {\n      return {\n        category: ErrorCategory.NETWORK,\n        shouldRetry: true,\n        message: `Network error: ${error.message}`,\n        hasFeedback: false,\n      }\n    }\n\n    // HTTP 错误（如果有 status 属性）\n    const statusCode =\n      (error as { status?: number; statusCode?: number }).status ||\n      (error as { status?: number; statusCode?: number }).statusCode\n\n    if (statusCode) {\n      if (statusCode === 429) {\n        return {\n          category: ErrorCategory.TEMPORARY_API_ERROR,\n          shouldRetry: true,\n          message: 'Rate limit exceeded (429)',\n          hasFeedback: false,\n        }\n      }\n      if (statusCode === 503 || statusCode === 502 || statusCode === 504) {\n        return {\n          category: ErrorCategory.TEMPORARY_API_ERROR,\n          shouldRetry: true,\n          message: `Service unavailable (${statusCode})`,\n          hasFeedback: false,\n        }\n      }\n      if (statusCode === 401 || statusCode === 403) {\n        return {\n          category: ErrorCategory.AUTHENTICATION_ERROR,\n          shouldRetry: false,\n          message: `Authentication failed (${statusCode})`,\n          hasFeedback: false,\n        }\n      }\n      if (statusCode === 400) {\n        return {\n          category: ErrorCategory.INVALID_REQUEST,\n          shouldRetry: false,\n          message: `Invalid request (${statusCode})`,\n          hasFeedback: false,\n        }\n      }\n    }\n\n    // JSON 解析错误\n    if (\n      errorName.includes('json') ||\n      errorName.includes('syntax') ||\n      errorMessage.includes('json') ||\n      errorMessage.includes('parse')\n    ) {\n      return {\n        category: ErrorCategory.JSON_PARSE_ERROR,\n        shouldRetry: true,\n        message: `JSON parse error: ${error.message}`,\n        hasFeedback: false,\n      }\n    }\n\n    // 业务逻辑错误（特定错误名称）\n    if (\n      errorName.includes('business') ||\n      errorName.includes('logic') ||\n      errorMessage.includes('business logic')\n    ) {\n      return {\n        category: ErrorCategory.BUSINESS_LOGIC_ERROR,\n        shouldRetry: false,\n        message: `Business logic error: ${error.message}`,\n        hasFeedback: false,\n      }\n    }\n  }\n\n  // 字符串错误\n  if (typeof error === 'string') {\n    const lowerError = error.toLowerCase()\n    if (lowerError.includes('timeout') || lowerError.includes('network')) {\n      return {\n        category: ErrorCategory.NETWORK,\n        shouldRetry: true,\n        message: `Network error: ${error}`,\n        hasFeedback: false,\n      }\n    }\n  }\n\n  // 默认：未知错误，保守策略（可重试）\n  return {\n    category: ErrorCategory.UNKNOWN,\n    shouldRetry: true,\n    message: error instanceof Error ? error.message : String(error),\n    hasFeedback: false,\n  }\n}\n\n/**\n * 计算重试延迟时间（指数退避 + 抖动）\n *\n * @param attemptNumber - 当前尝试次数（从 0 开始，0 是第一次尝试）\n * @param config - 重试配置\n * @returns 延迟时间（毫秒）\n *\n * @remarks\n * 公式：\n * - baseDelay = initialDelayMs * (backoffMultiplier ^ attemptNumber)\n * - delay = min(baseDelay, maxDelayMs)\n * - if enableJitter: delay = delay * (1 + random(-jitterRatio, +jitterRatio))\n *\n * 示例（initialDelayMs=500, backoffMultiplier=2, maxDelayMs=5000）:\n * - attempt 0: 500ms\n * - attempt 1: 1000ms (500 * 2)\n * - attempt 2: 2000ms (500 * 4)\n * - attempt 3: 4000ms (500 * 8)\n * - attempt 4: 5000ms (500 * 16, capped at maxDelayMs)\n */\nexport function calculateRetryDelay(\n  attemptNumber: number,\n  config: RetryConfig = DEFAULT_RETRY_CONFIG\n): number {\n  // 计算基础延迟（指数退避）\n  const baseDelay = Math.min(\n    config.initialDelayMs * config.backoffMultiplier ** attemptNumber,\n    config.maxDelayMs\n  )\n\n  // 添加随机抖动（如果启用）\n  if (config.enableJitter) {\n    const jitter = baseDelay * config.jitterRatio * (Math.random() - 0.5) * 2\n    return Math.max(0, Math.round(baseDelay + jitter))\n  }\n\n  return Math.round(baseDelay)\n}\n\n/**\n * 根据错误类别获取建议的延迟时间\n *\n * @param category - 错误类别\n * @param attemptNumber - 当前尝试次数\n * @param config - 重试配置\n * @returns 建议的延迟时间（毫秒）\n *\n * @remarks\n * 不同错误类型的特殊处理：\n * - Rate Limit (429): 使用更长的初始延迟\n * - Network Error: 标准指数退避\n * - Validation Error: 较短延迟（AI 修复应该很快）\n */\nexport function getRecommendedDelay(\n  category: ErrorCategory,\n  attemptNumber: number,\n  config: RetryConfig = DEFAULT_RETRY_CONFIG\n): number {\n  // Rate Limit 错误需要更长的延迟\n  if (category === ErrorCategory.TEMPORARY_API_ERROR) {\n    const rateLimitConfig = {\n      ...config,\n      initialDelayMs: 2000, // Rate limit 需要更长延迟\n      maxDelayMs: 10000,\n    }\n    return calculateRetryDelay(attemptNumber, rateLimitConfig)\n  }\n\n  // 验证错误使用较短延迟（AI 应该能快速修复）\n  if (category === ErrorCategory.VALIDATION_ERROR) {\n    const validationConfig = {\n      ...config,\n      initialDelayMs: 200, // 验证错误修复应该很快\n    }\n    return calculateRetryDelay(attemptNumber, validationConfig)\n  }\n\n  // 其他错误使用标准延迟\n  return calculateRetryDelay(attemptNumber, config)\n}\n\n/**\n * 延迟函数（Promise 包装的 setTimeout）\n *\n * @param ms - 延迟毫秒数\n * @returns Promise，在指定时间后 resolve\n */\nexport function delay(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms))\n}\n"],"version":3}