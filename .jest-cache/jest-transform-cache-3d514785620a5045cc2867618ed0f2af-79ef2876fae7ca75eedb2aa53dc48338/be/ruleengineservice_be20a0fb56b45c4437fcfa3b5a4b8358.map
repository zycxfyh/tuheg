{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\rule-engine.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\logic-agent\\src\\rule-engine.service.ts"],"sourcesContent":["// 文件路径: apps/logic-agent/src/rule-engine.service.ts (企业级规则引擎)\n//\n// 核心功能:\n// 1. 动态规则加载和热更新\n// 2. 规则性能监控和优化\n// 3. 规则缓存和预编译\n// 4. 并发规则执行优化\n// 5. 规则依赖管理和冲突检测\n// 6. 自适应规则执行策略\n\nimport {\n  BadRequestException,\n  Injectable,\n  InternalServerErrorException,\n  Logger,\n  OnModuleInit,\n  OnModuleDestroy,\n} from '@nestjs/common'\nimport type { Prisma } from '@prisma/client'\nimport type {\n  DirectiveSet,\n  NumericOperation,\n  StateChangeDirective,\n  StringOperation,\n} from '@tuheg/ai-domain'\nimport type {\n  CharacterUpdate,\n  PrismaService,\n  CacheService,\n} from '@tuheg/infrastructure'\nimport * as fs from 'fs'\nimport * as path from 'path'\nimport { EventEmitter } from 'events'\n\n/**\n * 规则执行策略\n */\nexport enum RuleExecutionStrategy {\n  /** 串行执行 */\n  SEQUENTIAL = 'sequential',\n  /** 并行执行 */\n  PARALLEL = 'parallel',\n  /** 条件执行 */\n  CONDITIONAL = 'conditional',\n  /** 自适应执行 */\n  ADAPTIVE = 'adaptive'\n}\n\n/**\n * 规则优先级\n */\nexport enum RulePriority {\n  LOW = 1,\n  MEDIUM = 5,\n  HIGH = 10,\n  CRITICAL = 15\n}\n\n/**\n * 规则元数据\n */\nexport interface RuleMetadata {\n  id: string\n  name: string\n  description?: string\n  version: string\n  priority: RulePriority\n  tags: string[]\n  dependencies: string[]\n  conditions?: RuleCondition[]\n  timeout?: number\n  retryCount?: number\n  enabled: boolean\n  lastModified: Date\n  performanceMetrics: RulePerformanceMetrics\n}\n\n/**\n * 规则条件\n */\nexport interface RuleCondition {\n  type: 'field_exists' | 'field_equals' | 'field_range' | 'custom'\n  field: string\n  operator: string\n  value: any\n  negate?: boolean\n}\n\n/**\n * 规则执行上下文\n */\nexport interface RuleExecutionContext {\n  gameId: string\n  directive: StateChangeDirective\n  payload: any\n  previousState?: any\n  executionOrder: number\n  startTime: number\n  timeout?: number\n}\n\n/**\n * 规则执行结果\n */\nexport interface RuleExecutionResult {\n  success: boolean\n  executionTime: number\n  error?: Error\n  skipped?: boolean\n  reason?: string\n  metadata?: Record<string, any>\n}\n\n/**\n * 规则性能指标\n */\nexport interface RulePerformanceMetrics {\n  totalExecutions: number\n  successfulExecutions: number\n  failedExecutions: number\n  averageExecutionTime: number\n  p95ExecutionTime: number\n  lastExecutionTime: number\n  errorRate: number\n  cacheHitRate: number\n}\n\n/**\n * 规则定义\n */\nexport interface RuleDefinition {\n  metadata: RuleMetadata\n  validate: (context: RuleExecutionContext) => Promise<boolean>\n  execute: (context: RuleExecutionContext) => Promise<RuleExecutionResult>\n  rollback?: (context: RuleExecutionContext) => Promise<void>\n}\n\n/**\n * 规则引擎配置\n */\nexport interface RuleEngineConfig {\n  enableDynamicLoading: boolean\n  rulesDirectory: string\n  cacheEnabled: boolean\n  parallelExecutionLimit: number\n  defaultTimeout: number\n  enablePerformanceMonitoring: boolean\n  enableRuleHotReload: boolean\n}\n\n@Injectable()\nexport class RuleEngineService extends EventEmitter implements OnModuleInit, OnModuleDestroy {\n  private readonly logger = new Logger(RuleEngineService.name)\n\n  // 规则存储\n  private rules = new Map<string, RuleDefinition>()\n  private ruleMetadata = new Map<string, RuleMetadata>()\n\n  // 规则依赖图\n  private dependencyGraph = new Map<string, Set<string>>()\n\n  // 执行队列和并发控制\n  private executionQueue: Array<{\n    context: RuleExecutionContext\n    rule: RuleDefinition\n    resolve: (result: RuleExecutionResult) => void\n    reject: (error: Error) => void\n  }> = []\n  private activeExecutions = 0\n\n  // 配置\n  private config: RuleEngineConfig = {\n    enableDynamicLoading: true,\n    rulesDirectory: path.join(process.cwd(), 'rules'),\n    cacheEnabled: true,\n    parallelExecutionLimit: 3,\n    defaultTimeout: 5000,\n    enablePerformanceMonitoring: true,\n    enableRuleHotReload: true\n  }\n\n  // 文件监听器\n  private fileWatcher?: fs.FSWatcher\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly cacheService: CacheService\n  ) {\n    super()\n\n    // 设置事件监听器限制\n    this.setMaxListeners(50)\n  }\n\n  /**\n   * 模块初始化\n   */\n  async onModuleInit(): Promise<void> {\n    this.logger.log('初始化规则引擎...')\n\n    // 加载内置规则\n    await this.loadBuiltInRules()\n\n    // 动态加载外部规则\n    if (this.config.enableDynamicLoading) {\n      await this.loadDynamicRules()\n\n      // 设置文件监听器进行热重载\n      if (this.config.enableRuleHotReload) {\n        this.setupFileWatcher()\n      }\n    }\n\n    // 构建依赖图\n    this.buildDependencyGraph()\n\n    // 预热常用规则\n    await this.warmupRules()\n\n    this.logger.log(`规则引擎初始化完成，共加载 ${this.rules.size} 个规则`)\n  }\n\n  /**\n   * 模块销毁\n   */\n  async onModuleDestroy(): Promise<void> {\n    this.logger.log('关闭规则引擎...')\n\n    // 停止文件监听\n    if (this.fileWatcher) {\n      this.fileWatcher.close()\n    }\n\n    // 等待所有执行完成\n    while (this.activeExecutions > 0) {\n      await new Promise(resolve => setTimeout(resolve, 100))\n    }\n\n    this.logger.log('规则引擎已关闭')\n  }\n\n  /**\n   * 智能规则执行 - 支持多策略并发执行\n   */\n  public async execute(gameId: string, directives: DirectiveSet): Promise<void> {\n    const executionId = `exec_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n    const startTime = Date.now()\n\n    this.logger.log(`开始执行规则集 ${executionId}: ${directives.length} 个指令`)\n\n    if (!directives || directives.length === 0) {\n      this.logger.warn(`规则集为空，跳过执行`)\n      return\n    }\n\n    // [安全修复] 在执行指令前进行业务规则验证\n    this.validateDirectives(directives)\n\n    // 获取游戏当前状态（用于规则上下文）\n    const gameState = await this.getGameState(gameId)\n\n    try {\n      // 选择执行策略\n      const strategy = this.selectExecutionStrategy(directives, gameState)\n\n      // 构建规则执行上下文\n      const executionContexts = directives.map((directive, index) => ({\n        gameId,\n        directive,\n        payload: directive.payload,\n        previousState: gameState,\n        executionOrder: index,\n        startTime: Date.now(),\n        timeout: directive.timeout || this.config.defaultTimeout\n      }))\n\n      // 执行规则\n      const results = await this.executeRulesWithStrategy(executionContexts, strategy)\n\n      // 处理结果\n      await this.processExecutionResults(results, executionContexts)\n\n      const totalTime = Date.now() - startTime\n      this.logger.log(`规则集 ${executionId} 执行完成: ${results.filter(r => r.success).length}/${results.length} 成功，总耗时 ${totalTime}ms`)\n\n      // 发送完成事件\n      this.emit('executionCompleted', {\n        executionId,\n        gameId,\n        results,\n        totalTime,\n        strategy\n      })\n\n    } catch (error: unknown) {\n      const totalTime = Date.now() - startTime\n\n      if (error instanceof BadRequestException) {\n        throw error\n      }\n\n      const errorMessage = error instanceof Error ? error.message : 'Unknown database error'\n\n      this.logger.error(\n        `规则执行失败 ${executionId}: ${errorMessage}`,\n        error instanceof Error ? error.stack : error\n      )\n\n      // 发送失败事件\n      this.emit('executionFailed', {\n        executionId,\n        gameId,\n        error: errorMessage,\n        totalTime\n      })\n\n      throw new InternalServerErrorException(`Rule engine execution failed: ${errorMessage}`)\n    }\n  }\n\n  /**\n   * 根据指令和状态选择最优执行策略\n   */\n  private selectExecutionStrategy(directives: DirectiveSet, gameState: any): RuleExecutionStrategy {\n    // 简单的策略选择逻辑（可以基于机器学习优化）\n    if (directives.length === 1) {\n      return RuleExecutionStrategy.SEQUENTIAL\n    }\n\n    // 检查是否有依赖关系\n    const hasDependencies = directives.some(d =>\n      this.dependencyGraph.has(d.op) && this.dependencyGraph.get(d.op)!.size > 0\n    )\n\n    if (hasDependencies) {\n      return RuleExecutionStrategy.SEQUENTIAL\n    }\n\n    // 检查是否所有指令都是独立的\n    const allIndependent = directives.every(d => !this.hasRuleConflicts(d, directives))\n\n    if (allIndependent && directives.length <= this.config.parallelExecutionLimit) {\n      return RuleExecutionStrategy.PARALLEL\n    }\n\n    return RuleExecutionStrategy.ADAPTIVE\n  }\n\n  /**\n   * 使用指定策略执行规则\n   */\n  private async executeRulesWithStrategy(\n    contexts: RuleExecutionContext[],\n    strategy: RuleExecutionStrategy\n  ): Promise<RuleExecutionResult[]> {\n    switch (strategy) {\n      case RuleExecutionStrategy.SEQUENTIAL:\n        return this.executeSequentially(contexts)\n\n      case RuleExecutionStrategy.PARALLEL:\n        return this.executeInParallel(contexts)\n\n      case RuleExecutionStrategy.CONDITIONAL:\n        return this.executeConditionally(contexts)\n\n      case RuleExecutionStrategy.ADAPTIVE:\n        return this.executeAdaptively(contexts)\n\n      default:\n        return this.executeSequentially(contexts)\n    }\n  }\n\n  /**\n   * 串行执行规则\n   */\n  private async executeSequentially(contexts: RuleExecutionContext[]): Promise<RuleExecutionResult[]> {\n    const results: RuleExecutionResult[] = []\n\n    for (const context of contexts) {\n      const result = await this.executeSingleRule(context)\n      results.push(result)\n\n      // 如果关键规则失败，可能需要回滚\n      if (!result.success && this.isCriticalRule(context.directive)) {\n        await this.rollbackFailedExecution(results, contexts)\n        break\n      }\n    }\n\n    return results\n  }\n\n  /**\n   * 并行执行规则\n   */\n  private async executeInParallel(contexts: RuleExecutionContext[]): Promise<RuleExecutionResult[]> {\n    const promises = contexts.map(context => this.executeSingleRule(context))\n    return Promise.all(promises)\n  }\n\n  /**\n   * 条件执行规则\n   */\n  private async executeConditionally(contexts: RuleExecutionContext[]): Promise<RuleExecutionResult[]> {\n    const results: RuleExecutionResult[] = []\n\n    for (const context of contexts) {\n      // 检查前置条件\n      const shouldExecute = await this.checkExecutionConditions(context)\n\n      if (shouldExecute) {\n        const result = await this.executeSingleRule(context)\n        results.push(result)\n      } else {\n        results.push({\n          success: true,\n          executionTime: 0,\n          skipped: true,\n          reason: '条件不满足，跳过执行'\n        })\n      }\n    }\n\n    return results\n  }\n\n  /**\n   * 自适应执行规则\n   */\n  private async executeAdaptively(contexts: RuleExecutionContext[]): Promise<RuleExecutionResult[]> {\n    // 基于性能指标动态调整执行策略\n    const batches = this.createExecutionBatches(contexts)\n\n    const results: RuleExecutionResult[] = []\n\n    for (const batch of batches) {\n      if (batch.length === 1) {\n        // 单规则串行执行\n        results.push(...await this.executeSequentially(batch))\n      } else {\n        // 批量并行执行\n        results.push(...await this.executeInParallel(batch))\n      }\n\n      // 检查是否有失败的规则需要特殊处理\n      const failedResults = results.filter(r => !r.success)\n      if (failedResults.length > 0) {\n        this.logger.warn(`批次执行中有 ${failedResults.length} 个规则失败，调整策略`)\n        // 可以在这里实现更复杂的自适应逻辑\n      }\n    }\n\n    return results\n  }\n\n  /**\n   * 执行单个规则\n   */\n  private async executeSingleRule(context: RuleExecutionContext): Promise<RuleExecutionResult> {\n    const rule = this.rules.get(context.directive.op)\n\n    if (!rule) {\n      return {\n        success: false,\n        executionTime: 0,\n        error: new Error(`未找到规则: ${context.directive.op}`)\n      }\n    }\n\n    const startTime = Date.now()\n\n    try {\n      // 验证规则条件\n      const isValid = await rule.validate(context)\n      if (!isValid) {\n        return {\n          success: true,\n          executionTime: Date.now() - startTime,\n          skipped: true,\n          reason: '规则验证失败'\n        }\n      }\n\n      // 执行规则（带超时控制）\n      const result = await this.executeWithTimeout(rule.execute(context), context.timeout)\n\n      const executionTime = Date.now() - startTime\n\n      // 更新性能指标\n      this.updateRuleMetrics(rule.metadata.id, executionTime, result.success)\n\n      return {\n        ...result,\n        executionTime\n      }\n\n    } catch (error) {\n      const executionTime = Date.now() - startTime\n\n      this.updateRuleMetrics(rule.metadata.id, executionTime, false)\n\n      return {\n        success: false,\n        executionTime,\n        error: error instanceof Error ? error : new Error(String(error))\n      }\n    }\n  }\n\n  /**\n   * 获取游戏当前状态\n   */\n  private async getGameState(gameId: string): Promise<any> {\n    try {\n      const game = await this.prisma.game.findUnique({\n        where: { id: gameId },\n        include: {\n          characters: true,\n          world: true\n        }\n      })\n\n      return game || {}\n    } catch (error) {\n      this.logger.warn(`无法获取游戏状态 ${gameId}:`, error)\n      return {}\n    }\n  }\n\n  /**\n   * 处理执行结果\n   */\n  private async processExecutionResults(\n    results: RuleExecutionResult[],\n    contexts: RuleExecutionContext[]\n  ): Promise<void> {\n    // 使用数据库事务执行所有成功的规则\n    const successfulContexts = contexts.filter((_, index) => results[index].success)\n\n    if (successfulContexts.length > 0) {\n      await this.prisma.$transaction(async (tx) => {\n        for (const context of successfulContexts) {\n          await this.handleUpdateCharacter(tx, context.gameId, context.directive)\n        }\n      })\n    }\n\n    // 记录失败的规则\n    const failedResults = results.filter(r => !r.success)\n    if (failedResults.length > 0) {\n      this.logger.warn(`规则执行失败: ${failedResults.length} 个规则失败`)\n      failedResults.forEach((result, index) => {\n        if (result.error) {\n          this.logger.error(`规则失败: ${result.error.message}`)\n        }\n      })\n    }\n  }\n\n  /**\n   * 执行带超时的操作\n   */\n  private async executeWithTimeout<T>(\n    promise: Promise<T>,\n    timeoutMs?: number\n  ): Promise<T> {\n    const timeout = timeoutMs || this.config.defaultTimeout\n\n    return new Promise((resolve, reject) => {\n      const timeoutId = setTimeout(() => {\n        reject(new Error(`规则执行超时: ${timeout}ms`))\n      }, timeout)\n\n      promise\n        .then(resolve)\n        .catch(reject)\n        .finally(() => clearTimeout(timeoutId))\n    })\n  }\n\n  /**\n   * 检查规则冲突\n   */\n  private hasRuleConflicts(directive: StateChangeDirective, allDirectives: DirectiveSet): boolean {\n    // 检查是否有其他指令修改相同的字段\n    return allDirectives.some(other =>\n      other !== directive &&\n      other.op === directive.op &&\n      this.haveConflictingFields(directive.payload, other.payload)\n    )\n  }\n\n  /**\n   * 检查字段冲突\n   */\n  private haveConflictingFields(payload1: any, payload2: any): boolean {\n    const fields1 = Object.keys(payload1 || {})\n    const fields2 = Object.keys(payload2 || {})\n\n    return fields1.some(field => fields2.includes(field))\n  }\n\n  /**\n   * 检查是否为关键规则\n   */\n  private isCriticalRule(directive: StateChangeDirective): boolean {\n    return directive.op === 'update_character' // 可以扩展更多关键规则\n  }\n\n  /**\n   * 检查执行条件\n   */\n  private async checkExecutionConditions(context: RuleExecutionContext): Promise<boolean> {\n    const rule = this.rules.get(context.directive.op)\n    if (!rule?.metadata.conditions) {\n      return true\n    }\n\n    // 检查所有条件\n    for (const condition of rule.metadata.conditions) {\n      if (!(await this.evaluateCondition(condition, context))) {\n        return false\n      }\n    }\n\n    return true\n  }\n\n  /**\n   * 评估单个条件\n   */\n  private async evaluateCondition(condition: RuleCondition, context: RuleExecutionContext): Promise<boolean> {\n    const value = this.getNestedValue(context.payload, condition.field)\n    let result = false\n\n    switch (condition.type) {\n      case 'field_exists':\n        result = value !== undefined\n        break\n      case 'field_equals':\n        result = value === condition.value\n        break\n      case 'field_range':\n        const numValue = Number(value)\n        const [min, max] = condition.value as [number, number]\n        result = numValue >= min && numValue <= max\n        break\n      case 'custom':\n        // 可以在这里实现自定义条件逻辑\n        result = true\n        break\n    }\n\n    return condition.negate ? !result : result\n  }\n\n  /**\n   * 获取嵌套对象值\n   */\n  private getNestedValue(obj: any, path: string): any {\n    return path.split('.').reduce((current, key) => current?.[key], obj)\n  }\n\n  /**\n   * 创建执行批次\n   */\n  private createExecutionBatches(contexts: RuleExecutionContext[]): RuleExecutionContext[][] {\n    const batches: RuleExecutionContext[][] = []\n    const batchSize = Math.min(this.config.parallelExecutionLimit, contexts.length)\n\n    for (let i = 0; i < contexts.length; i += batchSize) {\n      batches.push(contexts.slice(i, i + batchSize))\n    }\n\n    return batches\n  }\n\n  /**\n   * 回滚失败的执行\n   */\n  private async rollbackFailedExecution(\n    results: RuleExecutionResult[],\n    contexts: RuleExecutionContext[]\n  ): Promise<void> {\n    this.logger.warn('执行关键规则失败，开始回滚...')\n\n    // 找出需要回滚的规则\n    const rollbackPromises = contexts\n      .filter((_, index) => results[index].success)\n      .map(async (context) => {\n        const rule = this.rules.get(context.directive.op)\n        if (rule?.rollback) {\n          try {\n            await rule.rollback(context)\n          } catch (error) {\n            this.logger.error(`回滚失败 ${context.directive.op}:`, error)\n          }\n        }\n      })\n\n    await Promise.allSettled(rollbackPromises)\n    this.logger.log('回滚完成')\n  }\n\n  /**\n   * 更新规则性能指标\n   */\n  private updateRuleMetrics(ruleId: string, executionTime: number, success: boolean): void {\n    const metadata = this.ruleMetadata.get(ruleId)\n    if (!metadata) return\n\n    const metrics = metadata.performanceMetrics\n\n    metrics.totalExecutions++\n    metrics.lastExecutionTime = executionTime\n\n    if (success) {\n      metrics.successfulExecutions++\n    } else {\n      metrics.failedExecutions++\n    }\n\n    // 更新平均执行时间\n    const totalTime = metrics.averageExecutionTime * (metrics.totalExecutions - 1) + executionTime\n    metrics.averageExecutionTime = totalTime / metrics.totalExecutions\n\n    // 更新错误率\n    metrics.errorRate = metrics.failedExecutions / metrics.totalExecutions\n\n    // 更新P95执行时间（简化的计算）\n    metrics.p95ExecutionTime = Math.max(metrics.p95ExecutionTime, executionTime)\n  }\n\n  /**\n   * 加载内置规则\n   */\n  private async loadBuiltInRules(): Promise<void> {\n    const builtInRules: RuleDefinition[] = [\n      {\n        metadata: {\n          id: 'update_character',\n          name: '角色更新规则',\n          description: '处理角色属性更新',\n          version: '1.0.0',\n          priority: RulePriority.HIGH,\n          tags: ['character', 'update'],\n          dependencies: [],\n          enabled: true,\n          lastModified: new Date(),\n          performanceMetrics: this.createEmptyMetrics()\n        },\n        validate: async (context) => {\n          const payload = context.payload as CharacterUpdate\n          return !!(payload.hp || payload.mp || payload.status)\n        },\n        execute: async (context) => {\n          // 这里会调用数据库操作\n          return { success: true, executionTime: 0 }\n        }\n      }\n    ]\n\n    for (const rule of builtInRules) {\n      this.registerRule(rule)\n    }\n  }\n\n  /**\n   * 加载动态规则\n   */\n  private async loadDynamicRules(): Promise<void> {\n    // 创建规则目录（如果不存在）\n    if (!fs.existsSync(this.config.rulesDirectory)) {\n      fs.mkdirSync(this.config.rulesDirectory, { recursive: true })\n    }\n\n    // 扫描规则文件\n    const ruleFiles = fs.readdirSync(this.config.rulesDirectory)\n      .filter(file => file.endsWith('.rule.js') || file.endsWith('.rule.ts'))\n\n    for (const file of ruleFiles) {\n      try {\n        const filePath = path.join(this.config.rulesDirectory, file)\n        const ruleModule = require(filePath)\n\n        if (ruleModule.default && this.isValidRuleDefinition(ruleModule.default)) {\n          this.registerRule(ruleModule.default)\n        }\n      } catch (error) {\n        this.logger.error(`加载规则文件失败 ${file}:`, error)\n      }\n    }\n  }\n\n  /**\n   * 注册规则\n   */\n  private registerRule(rule: RuleDefinition): void {\n    this.rules.set(rule.metadata.id, rule)\n    this.ruleMetadata.set(rule.metadata.id, rule.metadata)\n\n    this.logger.debug(`已注册规则: ${rule.metadata.name} (${rule.metadata.id})`)\n  }\n\n  /**\n   * 验证规则定义\n   */\n  private isValidRuleDefinition(obj: any): obj is RuleDefinition {\n    return obj &&\n           obj.metadata &&\n           obj.metadata.id &&\n           typeof obj.validate === 'function' &&\n           typeof obj.execute === 'function'\n  }\n\n  /**\n   * 构建依赖图\n   */\n  private buildDependencyGraph(): void {\n    this.dependencyGraph.clear()\n\n    for (const rule of this.rules.values()) {\n      for (const dep of rule.metadata.dependencies) {\n        if (!this.dependencyGraph.has(dep)) {\n          this.dependencyGraph.set(dep, new Set())\n        }\n        this.dependencyGraph.get(dep)!.add(rule.metadata.id)\n      }\n    }\n  }\n\n  /**\n   * 预热规则\n   */\n  private async warmupRules(): Promise<void> {\n    // 预加载常用规则到缓存\n    const commonRuleIds = ['update_character']\n\n    for (const ruleId of commonRuleIds) {\n      if (this.rules.has(ruleId)) {\n        const rule = this.rules.get(ruleId)!\n        // 可以在这里进行预编译或其他预热操作\n        this.logger.debug(`规则预热: ${rule.metadata.name}`)\n      }\n    }\n  }\n\n  /**\n   * 设置文件监听器\n   */\n  private setupFileWatcher(): void {\n    this.fileWatcher = fs.watch(this.config.rulesDirectory, (eventType, filename) => {\n      if (filename && (filename.endsWith('.rule.js') || filename.endsWith('.rule.ts'))) {\n        this.logger.log(`检测到规则文件变化: ${filename}, 重新加载...`)\n        this.loadDynamicRules().then(() => {\n          this.buildDependencyGraph()\n        }).catch(error => {\n          this.logger.error('重新加载规则失败:', error)\n        })\n      }\n    })\n  }\n\n  /**\n   * 创建空的性能指标\n   */\n  private createEmptyMetrics(): RulePerformanceMetrics {\n    return {\n      totalExecutions: 0,\n      successfulExecutions: 0,\n      failedExecutions: 0,\n      averageExecutionTime: 0,\n      p95ExecutionTime: 0,\n      lastExecutionTime: 0,\n      errorRate: 0,\n      cacheHitRate: 0\n    }\n  }\n\n  private async handleUpdateCharacter(\n    tx: Prisma.TransactionClient,\n    gameId: string,\n    directive: StateChangeDirective\n  ) {\n    const character = await tx.character.findUniqueOrThrow({\n      where: { gameId },\n    })\n    const payload = directive.payload as CharacterUpdate\n    const updates: Prisma.CharacterUpdateInput = {}\n\n    if (payload.hp) {\n      updates.hp = this.applyNumericOperation(character.hp, payload.hp)\n    }\n    if (payload.mp) {\n      updates.mp = this.applyNumericOperation(character.mp, payload.mp)\n    }\n    if (payload.status) {\n      updates.status = this.applyStringOperation(character.status, payload.status)\n    }\n\n    if (Object.keys(updates).length > 0) {\n      await tx.character.update({ where: { gameId }, data: updates })\n    }\n  }\n\n  private applyNumericOperation(currentValue: number, op: NumericOperation): number {\n    switch (op.op) {\n      case 'set':\n        return op.value\n      case 'increment':\n        return currentValue + op.value\n      case 'decrement':\n        return currentValue - op.value\n    }\n  }\n\n  private applyStringOperation(currentValue: string, op: StringOperation): string {\n    switch (op.op) {\n      case 'set':\n        return op.value\n      case 'append':\n        return currentValue + op.value\n      case 'prepend':\n        return op.value + currentValue\n    }\n  }\n\n  /**\n   * [安全修复] 验证指令集中的业务规则\n   * 防止AI生成恶意或不合理的状态变更\n   */\n  private validateDirectives(directives: DirectiveSet): void {\n    for (const directive of directives) {\n      if (directive.op === 'update_character') {\n        this.validateCharacterUpdate(directive.payload as CharacterUpdate)\n      }\n      // 可以在这里添加其他操作类型的验证\n    }\n  }\n\n  /**\n   * [安全修复] 验证角色更新指令的业务规则\n   */\n  private validateCharacterUpdate(payload: CharacterUpdate): void {\n    // HP验证：不能为负数，且单次操作不能超过合理范围\n    if (payload.hp) {\n      this.validateNumericOperation(payload.hp, 'HP', -1000, 1000)\n    }\n\n    // MP验证：不能为负数，且单次操作不能超过合理范围\n    if (payload.mp) {\n      this.validateNumericOperation(payload.mp, 'MP', -1000, 1000)\n    }\n\n    // 状态字符串验证：长度限制，防止注入攻击\n    if (payload.status) {\n      this.validateStringOperation(payload.status, 'status', 500)\n    }\n  }\n\n  /**\n   * [安全修复] 验证数值操作的业务规则\n   */\n  private validateNumericOperation(\n    op: NumericOperation,\n    fieldName: string,\n    minValue: number,\n    maxValue: number\n  ): void {\n    // 检查操作值是否在合理范围内\n    if (op.value < minValue || op.value > maxValue) {\n      throw new BadRequestException(\n        `${fieldName} operation value ${op.value} is outside allowed range [${minValue}, ${maxValue}]`\n      )\n    }\n\n    // 对于set操作，检查是否会导致无效状态\n    if (op.op === 'set' && op.value < 0) {\n      throw new BadRequestException(`${fieldName} cannot be set to negative value: ${op.value}`)\n    }\n  }\n\n  /**\n   * [安全修复] 验证字符串操作的业务规则\n   */\n  private validateStringOperation(op: StringOperation, fieldName: string, maxLength: number): void {\n    // 检查字符串长度是否超过限制\n    if (op.value.length > maxLength) {\n      throw new BadRequestException(\n        `${fieldName} value is too long: ${op.value.length} characters (max: ${maxLength})`\n      )\n    }\n\n    // 检查是否包含潜在的恶意内容（基础检查）\n    const suspiciousPatterns = [\n      /<script/i,\n      /javascript:/i,\n      /on\\w+\\s*=/i,\n      /<iframe/i,\n      /<object/i,\n      /<embed/i,\n    ]\n\n    for (const pattern of suspiciousPatterns) {\n      if (pattern.test(op.value)) {\n        throw new BadRequestException(\n          `${fieldName} contains potentially malicious content: ${op.value.substring(0, 50)}...`\n        )\n      }\n    }\n  }\n\n  // === 规则管理API ===\n\n  /**\n   * 获取所有已注册规则\n   */\n  getRegisteredRules(): Array<{ id: string; metadata: RuleMetadata }> {\n    return Array.from(this.rules.entries()).map(([id, rule]) => ({\n      id,\n      metadata: rule.metadata\n    }))\n  }\n\n  /**\n   * 获取规则性能统计\n   */\n  getRulePerformanceStats(): Array<{\n    ruleId: string\n    name: string\n    metrics: RulePerformanceMetrics\n  }> {\n    return Array.from(this.ruleMetadata.entries()).map(([id, metadata]) => ({\n      ruleId: id,\n      name: metadata.name,\n      metrics: metadata.performanceMetrics\n    }))\n  }\n\n  /**\n   * 获取引擎整体统计\n   */\n  getEngineStats(): {\n    totalRules: number\n    activeRules: number\n    executionQueueLength: number\n    activeExecutions: number\n    uptime: number\n  } {\n    const startTime = (this as any).startTime || Date.now()\n    const uptime = Date.now() - startTime\n\n    return {\n      totalRules: this.rules.size,\n      activeRules: Array.from(this.ruleMetadata.values()).filter(m => m.enabled).length,\n      executionQueueLength: this.executionQueue.length,\n      activeExecutions: this.activeExecutions,\n      uptime\n    }\n  }\n\n  /**\n   * 动态启用/禁用规则\n   */\n  async toggleRule(ruleId: string, enabled: boolean): Promise<void> {\n    const metadata = this.ruleMetadata.get(ruleId)\n    if (!metadata) {\n      throw new BadRequestException(`规则不存在: ${ruleId}`)\n    }\n\n    metadata.enabled = enabled\n    this.logger.log(`规则 ${ruleId} 已${enabled ? '启用' : '禁用'}`)\n\n    // 发送规则状态变更事件\n    this.emit('ruleToggled', { ruleId, enabled })\n  }\n\n  /**\n   * 重新加载规则\n   */\n  async reloadRules(): Promise<void> {\n    this.logger.log('开始重新加载规则...')\n\n    // 清除现有规则\n    this.rules.clear()\n    this.ruleMetadata.clear()\n\n    // 重新加载\n    await this.loadBuiltInRules()\n    await this.loadDynamicRules()\n    this.buildDependencyGraph()\n\n    this.logger.log(`规则重新加载完成，共加载 ${this.rules.size} 个规则`)\n\n    // 发送重新加载事件\n    this.emit('rulesReloaded', { totalRules: this.rules.size })\n  }\n\n  /**\n   * 创建自定义规则\n   */\n  async createCustomRule(ruleDefinition: Omit<RuleDefinition, 'metadata'> & {\n    metadata: Omit<RuleMetadata, 'performanceMetrics' | 'lastModified'>\n  }): Promise<string> {\n    const ruleId = `custom_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n\n    const completeMetadata: RuleMetadata = {\n      ...ruleDefinition.metadata,\n      id: ruleId,\n      performanceMetrics: this.createEmptyMetrics(),\n      lastModified: new Date()\n    }\n\n    const rule: RuleDefinition = {\n      ...ruleDefinition,\n      metadata: completeMetadata\n    }\n\n    this.registerRule(rule)\n    this.buildDependencyGraph()\n\n    this.logger.log(`创建自定义规则: ${completeMetadata.name} (${ruleId})`)\n\n    // 发送规则创建事件\n    this.emit('ruleCreated', { ruleId, metadata: completeMetadata })\n\n    return ruleId\n  }\n\n  /**\n   * 删除自定义规则\n   */\n  async deleteCustomRule(ruleId: string): Promise<void> {\n    if (!ruleId.startsWith('custom_')) {\n      throw new BadRequestException('只能删除自定义规则')\n    }\n\n    if (!this.rules.has(ruleId)) {\n      throw new BadRequestException(`规则不存在: ${ruleId}`)\n    }\n\n    this.rules.delete(ruleId)\n    this.ruleMetadata.delete(ruleId)\n    this.buildDependencyGraph()\n\n    this.logger.log(`删除自定义规则: ${ruleId}`)\n\n    // 发送规则删除事件\n    this.emit('ruleDeleted', { ruleId })\n  }\n\n  /**\n   * 导出规则配置\n   */\n  exportRules(): Array<{ metadata: RuleMetadata; definition: string }> {\n    return Array.from(this.rules.entries()).map(([id, rule]) => ({\n      metadata: rule.metadata,\n      definition: `\nexport default {\n  metadata: ${JSON.stringify(rule.metadata, null, 2)},\n  validate: ${rule.validate.toString()},\n  execute: ${rule.execute.toString()},\n  rollback: ${rule.rollback?.toString() || 'undefined'}\n}`\n    }))\n  }\n}\n"],"version":3}