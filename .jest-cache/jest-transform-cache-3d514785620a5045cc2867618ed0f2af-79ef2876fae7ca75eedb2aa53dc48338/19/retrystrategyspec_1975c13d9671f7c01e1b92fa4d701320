e777d41fca899a216cfc7f1ebacf2e1b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const zod_1 = require("zod");
const retry_strategy_ts_1 = require("./retry-strategy.ts");
describe('retry-strategy', () => {
    describe('classifyError', () => {
        it('should classify network errors as retryable', () => {
            const error = new Error('ECONNREFUSED');
            const classification = (0, retry_strategy_ts_1.classifyError)(error);
            expect(classification.category).toBe(retry_strategy_ts_1.ErrorCategory.NETWORK);
            expect(classification.shouldRetry).toBe(true);
        });
        it('should classify timeout errors as retryable', () => {
            const error = new Error('ETIMEDOUT');
            const classification = (0, retry_strategy_ts_1.classifyError)(error);
            expect(classification.category).toBe(retry_strategy_ts_1.ErrorCategory.NETWORK);
            expect(classification.shouldRetry).toBe(true);
        });
        it('should classify 429 rate limit errors as retryable', () => {
            const error = Object.assign(new Error('Rate limit exceeded'), {
                status: 429,
            });
            const classification = (0, retry_strategy_ts_1.classifyError)(error);
            expect(classification.category).toBe(retry_strategy_ts_1.ErrorCategory.TEMPORARY_API_ERROR);
            expect(classification.shouldRetry).toBe(true);
        });
        it('should classify 503 errors as retryable', () => {
            const error = Object.assign(new Error('Service unavailable'), {
                statusCode: 503,
            });
            const classification = (0, retry_strategy_ts_1.classifyError)(error);
            expect(classification.category).toBe(retry_strategy_ts_1.ErrorCategory.TEMPORARY_API_ERROR);
            expect(classification.shouldRetry).toBe(true);
        });
        it('should classify 401/403 errors as non-retryable', () => {
            const error401 = Object.assign(new Error('Unauthorized'), {
                status: 401,
            });
            const classification401 = (0, retry_strategy_ts_1.classifyError)(error401);
            expect(classification401.category).toBe(retry_strategy_ts_1.ErrorCategory.AUTHENTICATION_ERROR);
            expect(classification401.shouldRetry).toBe(false);
            const error403 = Object.assign(new Error('Forbidden'), { status: 403 });
            const classification403 = (0, retry_strategy_ts_1.classifyError)(error403);
            expect(classification403.category).toBe(retry_strategy_ts_1.ErrorCategory.AUTHENTICATION_ERROR);
            expect(classification403.shouldRetry).toBe(false);
        });
        it('should classify 400 errors as non-retryable', () => {
            const error = Object.assign(new Error('Bad request'), { status: 400 });
            const classification = (0, retry_strategy_ts_1.classifyError)(error);
            expect(classification.category).toBe(retry_strategy_ts_1.ErrorCategory.INVALID_REQUEST);
            expect(classification.shouldRetry).toBe(false);
        });
        it('should classify Zod validation errors as retryable with feedback', () => {
            const schema = zod_1.z.object({ name: zod_1.z.string() });
            const result = schema.safeParse({});
            expect(result.success).toBe(false);
            if (!result.success) {
                const classification = (0, retry_strategy_ts_1.classifyError)(result.error, 'Field name is required');
                expect(classification.category).toBe(retry_strategy_ts_1.ErrorCategory.VALIDATION_ERROR);
                expect(classification.shouldRetry).toBe(true);
                expect(classification.hasFeedback).toBe(true);
                expect(classification.feedback).toBeDefined();
            }
        });
        it('should classify JSON parse errors as retryable', () => {
            const error = new SyntaxError('Unexpected token in JSON');
            const classification = (0, retry_strategy_ts_1.classifyError)(error);
            expect(classification.category).toBe(retry_strategy_ts_1.ErrorCategory.JSON_PARSE_ERROR);
            expect(classification.shouldRetry).toBe(true);
        });
        it('should classify unknown errors as retryable (conservative)', () => {
            const error = new Error('Some unknown error');
            const classification = (0, retry_strategy_ts_1.classifyError)(error);
            expect(classification.category).toBe(retry_strategy_ts_1.ErrorCategory.UNKNOWN);
            expect(classification.shouldRetry).toBe(true);
        });
    });
    describe('calculateRetryDelay', () => {
        it('should calculate exponential backoff', () => {
            const config = { ...retry_strategy_ts_1.DEFAULT_RETRY_CONFIG, enableJitter: false };
            expect((0, retry_strategy_ts_1.calculateRetryDelay)(0, config)).toBe(500); // 500 * 2^0
            expect((0, retry_strategy_ts_1.calculateRetryDelay)(1, config)).toBe(1000); // 500 * 2^1
            expect((0, retry_strategy_ts_1.calculateRetryDelay)(2, config)).toBe(2000); // 500 * 2^2
            expect((0, retry_strategy_ts_1.calculateRetryDelay)(3, config)).toBe(4000); // 500 * 2^3
        });
        it('should cap delay at maxDelayMs', () => {
            const config = {
                ...retry_strategy_ts_1.DEFAULT_RETRY_CONFIG,
                maxDelayMs: 1000,
                enableJitter: false,
            };
            expect((0, retry_strategy_ts_1.calculateRetryDelay)(0, config)).toBe(500);
            expect((0, retry_strategy_ts_1.calculateRetryDelay)(1, config)).toBe(1000);
            expect((0, retry_strategy_ts_1.calculateRetryDelay)(10, config)).toBe(1000); // Capped
        });
        it('should apply jitter when enabled', () => {
            const config = { ...retry_strategy_ts_1.DEFAULT_RETRY_CONFIG, enableJitter: true };
            const delayMs = (0, retry_strategy_ts_1.calculateRetryDelay)(1, config);
            // Jitter should add randomness (though exact values are random)
            expect(delayMs).toBeGreaterThan(0);
            expect(delayMs).toBeLessThanOrEqual(1200); // 1000 * 1.2 (max with 20% jitter)
            // Verify multiple calls produce different values (due to jitter)
            const delays = Array.from({ length: 5 }, () => (0, retry_strategy_ts_1.calculateRetryDelay)(1, config));
            const uniqueDelays = new Set(delays);
            // At least some values should be different (jitter adds randomness)
            expect(uniqueDelays.size).toBeGreaterThan(1);
        });
        it('should never return negative delay', () => {
            const config = { ...retry_strategy_ts_1.DEFAULT_RETRY_CONFIG, enableJitter: true };
            for (let i = 0; i < 10; i++) {
                const delayMs = (0, retry_strategy_ts_1.calculateRetryDelay)(i, config);
                expect(delayMs).toBeGreaterThanOrEqual(0);
            }
        });
    });
    describe('getRecommendedDelay', () => {
        it('should use longer delay for rate limit errors', () => {
            const rateLimitDelay = (0, retry_strategy_ts_1.getRecommendedDelay)(retry_strategy_ts_1.ErrorCategory.TEMPORARY_API_ERROR, 0, retry_strategy_ts_1.DEFAULT_RETRY_CONFIG);
            const networkDelay = (0, retry_strategy_ts_1.getRecommendedDelay)(retry_strategy_ts_1.ErrorCategory.NETWORK, 0, retry_strategy_ts_1.DEFAULT_RETRY_CONFIG);
            // Rate limit should have longer initial delay (2000 vs 500)
            expect(rateLimitDelay).toBeGreaterThan(networkDelay);
        });
        it('should use shorter delay for validation errors', () => {
            const validationDelay = (0, retry_strategy_ts_1.getRecommendedDelay)(retry_strategy_ts_1.ErrorCategory.VALIDATION_ERROR, 0, retry_strategy_ts_1.DEFAULT_RETRY_CONFIG);
            const networkDelay = (0, retry_strategy_ts_1.getRecommendedDelay)(retry_strategy_ts_1.ErrorCategory.NETWORK, 0, retry_strategy_ts_1.DEFAULT_RETRY_CONFIG);
            // Validation errors should have shorter delay (200 vs 500)
            expect(validationDelay).toBeLessThan(networkDelay);
        });
        it('should use standard delay for network errors', () => {
            const delayMs = (0, retry_strategy_ts_1.getRecommendedDelay)(retry_strategy_ts_1.ErrorCategory.NETWORK, 0, retry_strategy_ts_1.DEFAULT_RETRY_CONFIG);
            // With jitter enabled, delay can range from 400ms to 600ms (Â±20% of 500ms)
            expect(delayMs).toBeGreaterThanOrEqual(400);
            expect(delayMs).toBeLessThanOrEqual(600);
        });
    });
    describe('delay', () => {
        it('should delay for specified milliseconds', async () => {
            const start = Date.now();
            await (0, retry_strategy_ts_1.delay)(100);
            const elapsed = Date.now() - start;
            // Should be at least 100ms (may be slightly more due to scheduling)
            expect(elapsed).toBeGreaterThanOrEqual(90);
            expect(elapsed).toBeLessThan(150); // Allow some overhead
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxhaVxcX190ZXN0c19fXFxyZXRyeS1zdHJhdGVneS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQXVCO0FBQ3ZCLDJEQU80QjtBQUU1QixRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzlCLFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO1FBQzdCLEVBQUUsQ0FBQyw2Q0FBNkMsRUFBRSxHQUFHLEVBQUU7WUFDckQsTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUE7WUFDdkMsTUFBTSxjQUFjLEdBQUcsSUFBQSxpQ0FBYSxFQUFDLEtBQUssQ0FBQyxDQUFBO1lBQzNDLE1BQU0sQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLGlDQUFhLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDM0QsTUFBTSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDL0MsQ0FBQyxDQUFDLENBQUE7UUFFRixFQUFFLENBQUMsNkNBQTZDLEVBQUUsR0FBRyxFQUFFO1lBQ3JELE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFBO1lBQ3BDLE1BQU0sY0FBYyxHQUFHLElBQUEsaUNBQWEsRUFBQyxLQUFLLENBQUMsQ0FBQTtZQUMzQyxNQUFNLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQ0FBYSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQzNELE1BQU0sQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQy9DLENBQUMsQ0FBQyxDQUFBO1FBRUYsRUFBRSxDQUFDLG9EQUFvRCxFQUFFLEdBQUcsRUFBRTtZQUM1RCxNQUFNLEtBQUssR0FBRyxNQUFNLENB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IiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxwYWNrYWdlc1xcY29tbW9uLWJhY2tlbmRcXHNyY1xcYWlcXF9fdGVzdHNfX1xccmV0cnktc3RyYXRlZ3kuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB6IH0gZnJvbSAnem9kJ1xuaW1wb3J0IHtcbiAgY2FsY3VsYXRlUmV0cnlEZWxheSxcbiAgY2xhc3NpZnlFcnJvcixcbiAgREVGQVVMVF9SRVRSWV9DT05GSUcsXG4gIGRlbGF5LFxuICBFcnJvckNhdGVnb3J5LFxuICBnZXRSZWNvbW1lbmRlZERlbGF5LFxufSBmcm9tICcuL3JldHJ5LXN0cmF0ZWd5LnRzJ1xuXG5kZXNjcmliZSgncmV0cnktc3RyYXRlZ3knLCAoKSA9PiB7XG4gIGRlc2NyaWJlKCdjbGFzc2lmeUVycm9yJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2xhc3NpZnkgbmV0d29yayBlcnJvcnMgYXMgcmV0cnlhYmxlJywgKCkgPT4ge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ0VDT05OUkVGVVNFRCcpXG4gICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IGNsYXNzaWZ5RXJyb3IoZXJyb3IpXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb24uY2F0ZWdvcnkpLnRvQmUoRXJyb3JDYXRlZ29yeS5ORVRXT1JLKVxuICAgICAgZXhwZWN0KGNsYXNzaWZpY2F0aW9uLnNob3VsZFJldHJ5KS50b0JlKHRydWUpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgY2xhc3NpZnkgdGltZW91dCBlcnJvcnMgYXMgcmV0cnlhYmxlJywgKCkgPT4ge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ0VUSU1FRE9VVCcpXG4gICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IGNsYXNzaWZ5RXJyb3IoZXJyb3IpXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb24uY2F0ZWdvcnkpLnRvQmUoRXJyb3JDYXRlZ29yeS5ORVRXT1JLKVxuICAgICAgZXhwZWN0KGNsYXNzaWZpY2F0aW9uLnNob3VsZFJldHJ5KS50b0JlKHRydWUpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgY2xhc3NpZnkgNDI5IHJhdGUgbGltaXQgZXJyb3JzIGFzIHJldHJ5YWJsZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0gT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IoJ1JhdGUgbGltaXQgZXhjZWVkZWQnKSwge1xuICAgICAgICBzdGF0dXM6IDQyOSxcbiAgICAgIH0pXG4gICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IGNsYXNzaWZ5RXJyb3IoZXJyb3IpXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb24uY2F0ZWdvcnkpLnRvQmUoRXJyb3JDYXRlZ29yeS5URU1QT1JBUllfQVBJX0VSUk9SKVxuICAgICAgZXhwZWN0KGNsYXNzaWZpY2F0aW9uLnNob3VsZFJldHJ5KS50b0JlKHRydWUpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgY2xhc3NpZnkgNTAzIGVycm9ycyBhcyByZXRyeWFibGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IE9iamVjdC5hc3NpZ24obmV3IEVycm9yKCdTZXJ2aWNlIHVuYXZhaWxhYmxlJyksIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNTAzLFxuICAgICAgfSlcbiAgICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uID0gY2xhc3NpZnlFcnJvcihlcnJvcilcbiAgICAgIGV4cGVjdChjbGFzc2lmaWNhdGlvbi5jYXRlZ29yeSkudG9CZShFcnJvckNhdGVnb3J5LlRFTVBPUkFSWV9BUElfRVJST1IpXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb24uc2hvdWxkUmV0cnkpLnRvQmUodHJ1ZSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjbGFzc2lmeSA0MDEvNDAzIGVycm9ycyBhcyBub24tcmV0cnlhYmxlJywgKCkgPT4ge1xuICAgICAgY29uc3QgZXJyb3I0MDEgPSBPYmplY3QuYXNzaWduKG5ldyBFcnJvcignVW5hdXRob3JpemVkJyksIHtcbiAgICAgICAgc3RhdHVzOiA0MDEsXG4gICAgICB9KVxuICAgICAgY29uc3QgY2xhc3NpZmljYXRpb240MDEgPSBjbGFzc2lmeUVycm9yKGVycm9yNDAxKVxuICAgICAgZXhwZWN0KGNsYXNzaWZpY2F0aW9uNDAxLmNhdGVnb3J5KS50b0JlKEVycm9yQ2F0ZWdvcnkuQVVUSEVOVElDQVRJT05fRVJST1IpXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb240MDEuc2hvdWxkUmV0cnkpLnRvQmUoZmFsc2UpXG5cbiAgICAgIGNvbnN0IGVycm9yNDAzID0gT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IoJ0ZvcmJpZGRlbicpLCB7IHN0YXR1czogNDAzIH0pXG4gICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbjQwMyA9IGNsYXNzaWZ5RXJyb3IoZXJyb3I0MDMpXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb240MDMuY2F0ZWdvcnkpLnRvQmUoRXJyb3JDYXRlZ29yeS5BVVRIRU5USUNBVElPTl9FUlJPUilcbiAgICAgIGV4cGVjdChjbGFzc2lmaWNhdGlvbjQwMy5zaG91bGRSZXRyeSkudG9CZShmYWxzZSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjbGFzc2lmeSA0MDAgZXJyb3JzIGFzIG5vbi1yZXRyeWFibGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IE9iamVjdC5hc3NpZ24obmV3IEVycm9yKCdCYWQgcmVxdWVzdCcpLCB7IHN0YXR1czogNDAwIH0pXG4gICAgICBjb25zdCBjbGFzc2lmaWNhdGlvbiA9IGNsYXNzaWZ5RXJyb3IoZXJyb3IpXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb24uY2F0ZWdvcnkpLnRvQmUoRXJyb3JDYXRlZ29yeS5JTlZBTElEX1JFUVVFU1QpXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb24uc2hvdWxkUmV0cnkpLnRvQmUoZmFsc2UpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgY2xhc3NpZnkgWm9kIHZhbGlkYXRpb24gZXJyb3JzIGFzIHJldHJ5YWJsZSB3aXRoIGZlZWRiYWNrJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2NoZW1hID0gei5vYmplY3QoeyBuYW1lOiB6LnN0cmluZygpIH0pXG4gICAgICBjb25zdCByZXN1bHQgPSBzY2hlbWEuc2FmZVBhcnNlKHt9KVxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKGZhbHNlKVxuXG4gICAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uID0gY2xhc3NpZnlFcnJvcihyZXN1bHQuZXJyb3IsICdGaWVsZCBuYW1lIGlzIHJlcXVpcmVkJylcbiAgICAgICAgZXhwZWN0KGNsYXNzaWZpY2F0aW9uLmNhdGVnb3J5KS50b0JlKEVycm9yQ2F0ZWdvcnkuVkFMSURBVElPTl9FUlJPUilcbiAgICAgICAgZXhwZWN0KGNsYXNzaWZpY2F0aW9uLnNob3VsZFJldHJ5KS50b0JlKHRydWUpXG4gICAgICAgIGV4cGVjdChjbGFzc2lmaWNhdGlvbi5oYXNGZWVkYmFjaykudG9CZSh0cnVlKVxuICAgICAgICBleHBlY3QoY2xhc3NpZmljYXRpb24uZmVlZGJhY2spLnRvQmVEZWZpbmVkKClcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjbGFzc2lmeSBKU09OIHBhcnNlIGVycm9ycyBhcyByZXRyeWFibGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBTeW50YXhFcnJvcignVW5leHBlY3RlZCB0b2tlbiBpbiBKU09OJylcbiAgICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uID0gY2xhc3NpZnlFcnJvcihlcnJvcilcbiAgICAgIGV4cGVjdChjbGFzc2lmaWNhdGlvbi5jYXRlZ29yeSkudG9CZShFcnJvckNhdGVnb3J5LkpTT05fUEFSU0VfRVJST1IpXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb24uc2hvdWxkUmV0cnkpLnRvQmUodHJ1ZSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjbGFzc2lmeSB1bmtub3duIGVycm9ycyBhcyByZXRyeWFibGUgKGNvbnNlcnZhdGl2ZSknLCAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignU29tZSB1bmtub3duIGVycm9yJylcbiAgICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uID0gY2xhc3NpZnlFcnJvcihlcnJvcilcbiAgICAgIGV4cGVjdChjbGFzc2lmaWNhdGlvbi5jYXRlZ29yeSkudG9CZShFcnJvckNhdGVnb3J5LlVOS05PV04pXG4gICAgICBleHBlY3QoY2xhc3NpZmljYXRpb24uc2hvdWxkUmV0cnkpLnRvQmUodHJ1ZSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdjYWxjdWxhdGVSZXRyeURlbGF5JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2FsY3VsYXRlIGV4cG9uZW50aWFsIGJhY2tvZmYnLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWcgPSB7IC4uLkRFRkFVTFRfUkVUUllfQ09ORklHLCBlbmFibGVKaXR0ZXI6IGZhbHNlIH1cblxuICAgICAgZXhwZWN0KGNhbGN1bGF0ZVJldHJ5RGVsYXkoMCwgY29uZmlnKSkudG9CZSg1MDApIC8vIDUwMCAqIDJeMFxuICAgICAgZXhwZWN0KGNhbGN1bGF0ZVJldHJ5RGVsYXkoMSwgY29uZmlnKSkudG9CZSgxMDAwKSAvLyA1MDAgKiAyXjFcbiAgICAgIGV4cGVjdChjYWxjdWxhdGVSZXRyeURlbGF5KDIsIGNvbmZpZykpLnRvQmUoMjAwMCkgLy8gNTAwICogMl4yXG4gICAgICBleHBlY3QoY2FsY3VsYXRlUmV0cnlEZWxheSgzLCBjb25maWcpKS50b0JlKDQwMDApIC8vIDUwMCAqIDJeM1xuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIGNhcCBkZWxheSBhdCBtYXhEZWxheU1zJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnID0ge1xuICAgICAgICAuLi5ERUZBVUxUX1JFVFJZX0NPTkZJRyxcbiAgICAgICAgbWF4RGVsYXlNczogMTAwMCxcbiAgICAgICAgZW5hYmxlSml0dGVyOiBmYWxzZSxcbiAgICAgIH1cblxuICAgICAgZXhwZWN0KGNhbGN1bGF0ZVJldHJ5RGVsYXkoMCwgY29uZmlnKSkudG9CZSg1MDApXG4gICAgICBleHBlY3QoY2FsY3VsYXRlUmV0cnlEZWxheSgxLCBjb25maWcpKS50b0JlKDEwMDApXG4gICAgICBleHBlY3QoY2FsY3VsYXRlUmV0cnlEZWxheSgxMCwgY29uZmlnKSkudG9CZSgxMDAwKSAvLyBDYXBwZWRcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBhcHBseSBqaXR0ZXIgd2hlbiBlbmFibGVkJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnID0geyAuLi5ERUZBVUxUX1JFVFJZX0NPTkZJRywgZW5hYmxlSml0dGVyOiB0cnVlIH1cbiAgICAgIGNvbnN0IGRlbGF5TXMgPSBjYWxjdWxhdGVSZXRyeURlbGF5KDEsIGNvbmZpZylcblxuICAgICAgLy8gSml0dGVyIHNob3VsZCBhZGQgcmFuZG9tbmVzcyAodGhvdWdoIGV4YWN0IHZhbHVlcyBhcmUgcmFuZG9tKVxuICAgICAgZXhwZWN0KGRlbGF5TXMpLnRvQmVHcmVhdGVyVGhhbigwKVxuICAgICAgZXhwZWN0KGRlbGF5TXMpLnRvQmVMZXNzVGhhbk9yRXF1YWwoMTIwMCkgLy8gMTAwMCAqIDEuMiAobWF4IHdpdGggMjAlIGppdHRlcilcblxuICAgICAgLy8gVmVyaWZ5IG11bHRpcGxlIGNhbGxzIHByb2R1Y2UgZGlmZmVyZW50IHZhbHVlcyAoZHVlIHRvIGppdHRlcilcbiAgICAgIGNvbnN0IGRlbGF5cyA9IEFycmF5LmZyb20oeyBsZW5ndGg6IDUgfSwgKCkgPT4gY2FsY3VsYXRlUmV0cnlEZWxheSgxLCBjb25maWcpKVxuICAgICAgY29uc3QgdW5pcXVlRGVsYXlzID0gbmV3IFNldChkZWxheXMpXG4gICAgICAvLyBBdCBsZWFzdCBzb21lIHZhbHVlcyBzaG91bGQgYmUgZGlmZmVyZW50IChqaXR0ZXIgYWRkcyByYW5kb21uZXNzKVxuICAgICAgZXhwZWN0KHVuaXF1ZURlbGF5cy5zaXplKS50b0JlR3JlYXRlclRoYW4oMSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBuZXZlciByZXR1cm4gbmVnYXRpdmUgZGVsYXknLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWcgPSB7IC4uLkRFRkFVTFRfUkVUUllfQ09ORklHLCBlbmFibGVKaXR0ZXI6IHRydWUgfVxuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwOyBpKyspIHtcbiAgICAgICAgY29uc3QgZGVsYXlNcyA9IGNhbGN1bGF0ZVJldHJ5RGVsYXkoaSwgY29uZmlnKVxuICAgICAgICBleHBlY3QoZGVsYXlNcykudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgwKVxuICAgICAgfVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ2dldFJlY29tbWVuZGVkRGVsYXknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB1c2UgbG9uZ2VyIGRlbGF5IGZvciByYXRlIGxpbWl0IGVycm9ycycsICgpID0+IHtcbiAgICAgIGNvbnN0IHJhdGVMaW1pdERlbGF5ID0gZ2V0UmVjb21tZW5kZWREZWxheShcbiAgICAgICAgRXJyb3JDYXRlZ29yeS5URU1QT1JBUllfQVBJX0VSUk9SLFxuICAgICAgICAwLFxuICAgICAgICBERUZBVUxUX1JFVFJZX0NPTkZJR1xuICAgICAgKVxuICAgICAgY29uc3QgbmV0d29ya0RlbGF5ID0gZ2V0UmVjb21tZW5kZWREZWxheShFcnJvckNhdGVnb3J5Lk5FVFdPUkssIDAsIERFRkFVTFRfUkVUUllfQ09ORklHKVxuXG4gICAgICAvLyBSYXRlIGxpbWl0IHNob3VsZCBoYXZlIGxvbmdlciBpbml0aWFsIGRlbGF5ICgyMDAwIHZzIDUwMClcbiAgICAgIGV4cGVjdChyYXRlTGltaXREZWxheSkudG9CZUdyZWF0ZXJUaGFuKG5ldHdvcmtEZWxheSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCB1c2Ugc2hvcnRlciBkZWxheSBmb3IgdmFsaWRhdGlvbiBlcnJvcnMnLCAoKSA9PiB7XG4gICAgICBjb25zdCB2YWxpZGF0aW9uRGVsYXkgPSBnZXRSZWNvbW1lbmRlZERlbGF5KFxuICAgICAgICBFcnJvckNhdGVnb3J5LlZBTElEQVRJT05fRVJST1IsXG4gICAgICAgIDAsXG4gICAgICAgIERFRkFVTFRfUkVUUllfQ09ORklHXG4gICAgICApXG4gICAgICBjb25zdCBuZXR3b3JrRGVsYXkgPSBnZXRSZWNvbW1lbmRlZERlbGF5KEVycm9yQ2F0ZWdvcnkuTkVUV09SSywgMCwgREVGQVVMVF9SRVRSWV9DT05GSUcpXG5cbiAgICAgIC8vIFZhbGlkYXRpb24gZXJyb3JzIHNob3VsZCBoYXZlIHNob3J0ZXIgZGVsYXkgKDIwMCB2cyA1MDApXG4gICAgICBleHBlY3QodmFsaWRhdGlvbkRlbGF5KS50b0JlTGVzc1RoYW4obmV0d29ya0RlbGF5KVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIHVzZSBzdGFuZGFyZCBkZWxheSBmb3IgbmV0d29yayBlcnJvcnMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBkZWxheU1zID0gZ2V0UmVjb21tZW5kZWREZWxheShFcnJvckNhdGVnb3J5Lk5FVFdPUkssIDAsIERFRkFVTFRfUkVUUllfQ09ORklHKVxuXG4gICAgICAvLyBXaXRoIGppdHRlciBlbmFibGVkLCBkZWxheSBjYW4gcmFuZ2UgZnJvbSA0MDBtcyB0byA2MDBtcyAowrEyMCUgb2YgNTAwbXMpXG4gICAgICBleHBlY3QoZGVsYXlNcykudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCg0MDApXG4gICAgICBleHBlY3QoZGVsYXlNcykudG9CZUxlc3NUaGFuT3JFcXVhbCg2MDApXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnZGVsYXknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBkZWxheSBmb3Igc3BlY2lmaWVkIG1pbGxpc2Vjb25kcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKVxuICAgICAgYXdhaXQgZGVsYXkoMTAwKVxuICAgICAgY29uc3QgZWxhcHNlZCA9IERhdGUubm93KCkgLSBzdGFydFxuXG4gICAgICAvLyBTaG91bGQgYmUgYXQgbGVhc3QgMTAwbXMgKG1heSBiZSBzbGlnaHRseSBtb3JlIGR1ZSB0byBzY2hlZHVsaW5nKVxuICAgICAgZXhwZWN0KGVsYXBzZWQpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoOTApXG4gICAgICBleHBlY3QoZWxhcHNlZCkudG9CZUxlc3NUaGFuKDE1MCkgLy8gQWxsb3cgc29tZSBvdmVyaGVhZFxuICAgIH0pXG4gIH0pXG59KVxuIl0sInZlcnNpb24iOjN9