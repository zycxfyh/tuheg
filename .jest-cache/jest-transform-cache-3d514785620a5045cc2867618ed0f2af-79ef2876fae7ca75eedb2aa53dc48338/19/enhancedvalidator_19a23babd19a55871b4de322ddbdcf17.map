{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\validation\\enhanced-validator.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\validation\\enhanced-validator.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/validation/enhanced-validator.ts\n// 核心理念: 类型即文档，运行时验证，友好的错误消息\n\nimport type { ZodError, ZodSchema } from 'zod'\nimport { z } from 'zod'\n\n/**\n * @interface ValidationResult\n * @description 验证结果\n */\nexport interface ValidationResult<T> {\n  /** 验证是否成功 */\n  success: boolean\n  /** 验证后的数据（如果成功） */\n  data?: T\n  /** 验证错误（如果失败） */\n  errors?: ValidationError[]\n}\n\n/**\n * @interface ValidationError\n * @description 验证错误详情\n */\nexport interface ValidationError {\n  /** 字段路径 */\n  path: (string | number)[]\n  /** 错误消息 */\n  message: string\n  /** 错误代码 */\n  code: string\n  /** 期望的类型或值 */\n  expected?: string\n  /** 实际收到的值 */\n  received?: unknown\n  /** 嵌套错误（如果有） */\n  nested?: ValidationError[]\n}\n\n/**\n * @class EnhancedValidator\n * @description 增强的验证器，提供 Pydantic 风格的友好错误消息\n */\nexport class EnhancedValidator {\n  /**\n   * @method validate\n   * @description 验证数据\n   * @param schema - Zod schema\n   * @param data - 要验证的数据\n   * @returns 验证结果\n   */\n  public static validate<T>(schema: ZodSchema<T>, data: unknown): ValidationResult<T> {\n    try {\n      const parsed = schema.parse(data)\n      return {\n        success: true,\n        data: parsed,\n      }\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return {\n          success: false,\n          errors: EnhancedValidator.formatZodErrors(error),\n        }\n      }\n\n      return {\n        success: false,\n        errors: [\n          {\n            path: [],\n            message: error instanceof Error ? error.message : String(error),\n            code: 'UNKNOWN_ERROR',\n          },\n        ],\n      }\n    }\n  }\n\n  /**\n   * @method validateAsync\n   * @description 异步验证数据（支持异步验证规则）\n   * @param schema - Zod schema\n   * @param data - 要验证的数据\n   * @returns 验证结果 Promise\n   */\n  public static async validateAsync<T>(\n    schema: ZodSchema<T>,\n    data: unknown\n  ): Promise<ValidationResult<T>> {\n    try {\n      const parsed = await schema.parseAsync(data)\n      return {\n        success: true,\n        data: parsed,\n      }\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return {\n          success: false,\n          errors: EnhancedValidator.formatZodErrors(error),\n        }\n      }\n\n      return {\n        success: false,\n        errors: [\n          {\n            path: [],\n            message: error instanceof Error ? error.message : String(error),\n            code: 'UNKNOWN_ERROR',\n          },\n        ],\n      }\n    }\n  }\n\n  /**\n   * @method safeParse\n   * @description 安全解析（不抛出异常）\n   * @param schema - Zod schema\n   * @param data - 要验证的数据\n   * @returns 验证结果\n   */\n  public static safeParse<T>(schema: ZodSchema<T>, data: unknown): ValidationResult<T> {\n    const result = schema.safeParse(data)\n\n    if (result.success) {\n      return {\n        success: true,\n        data: result.data,\n      }\n    }\n\n    return {\n      success: false,\n      errors: EnhancedValidator.formatZodErrors(result.error),\n    }\n  }\n\n  /**\n   * @method formatZodErrors\n   * @description 格式化 Zod 错误为友好的错误消息\n   */\n  private static formatZodErrors(error: ZodError): ValidationError[] {\n    return error.errors.map((err) => {\n      const validationError: ValidationError = {\n        path: err.path,\n        message: EnhancedValidator.formatErrorMessage(err),\n        code: err.code,\n      }\n\n      // 添加类型信息\n      if (err.code === 'invalid_type') {\n        validationError.expected = err.expected\n        validationError.received = err.received\n      }\n\n      // 添加约束信息\n      if (err.code === 'too_small' || err.code === 'too_big') {\n        const constraintErr = err as { minimum?: number; maximum?: number; received?: unknown }\n        validationError.expected = `minimum: ${constraintErr.minimum ?? 'N/A'}, maximum: ${constraintErr.maximum ?? 'N/A'}`\n        validationError.received = constraintErr.received\n      }\n\n      return validationError\n    })\n  }\n\n  /**\n   * @method formatErrorMessage\n   * @description 格式化错误消息，使其更友好\n   */\n  private static formatErrorMessage(err: z.ZodIssue): string {\n    const path = err.path.length > 0 ? err.path.join('.') : 'root'\n\n    switch (err.code) {\n      case 'invalid_type':\n        return `${path}: 期望类型 \"${err.expected}\"，但收到类型 \"${err.received}\"`\n\n      case 'invalid_string':\n        if (err.validation === 'email') {\n          return `${path}: 无效的电子邮件地址`\n        }\n        if (err.validation === 'url') {\n          return `${path}: 无效的 URL`\n        }\n        if (err.validation === 'uuid') {\n          return `${path}: 无效的 UUID`\n        }\n        return `${path}: 字符串验证失败`\n\n      case 'too_small':\n        if (err.type === 'string') {\n          return `${path}: 字符串长度至少为 ${err.minimum} 个字符`\n        }\n        if (err.type === 'number') {\n          return `${path}: 数值必须大于或等于 ${err.minimum}`\n        }\n        if (err.type === 'array') {\n          return `${path}: 数组至少需要 ${err.minimum} 个元素`\n        }\n        return `${path}: 值太小（最小: ${err.minimum}）`\n\n      case 'too_big':\n        if (err.type === 'string') {\n          return `${path}: 字符串长度不能超过 ${err.maximum} 个字符`\n        }\n        if (err.type === 'number') {\n          return `${path}: 数值不能超过 ${err.maximum}`\n        }\n        if (err.type === 'array') {\n          return `${path}: 数组最多只能包含 ${err.maximum} 个元素`\n        }\n        return `${path}: 值太大（最大: ${err.maximum}）`\n\n      case 'invalid_enum_value':\n        return `${path}: 无效的枚举值。允许的值: ${err.options?.join(', ') ?? 'N/A'}`\n\n      case 'invalid_literal':\n        return `${path}: 必须是字面量值 \"${err.expected}\"`\n\n      case 'unrecognized_keys':\n        return `${path}: 未知的键: ${err.keys.join(', ')}`\n\n      case 'invalid_union':\n        return `${path}: 值不匹配任何联合类型选项`\n\n      case 'invalid_date':\n        return `${path}: 无效的日期格式`\n\n      case 'custom':\n        return err.message ?? `${path}: 自定义验证失败`\n\n      default:\n        return err.message ?? `${path}: 验证失败`\n    }\n  }\n\n  /**\n   * @method formatErrorsAsString\n   * @description 将错误格式化为字符串（用于日志或用户消息）\n   */\n  public static formatErrorsAsString(errors: ValidationError[]): string {\n    return errors\n      .map((err) => {\n        const path = err.path.length > 0 ? err.path.join('.') : 'root'\n        let message = `${path}: ${err.message}`\n\n        if (err.expected) {\n          message += ` (期望: ${err.expected})`\n        }\n\n        if (err.received !== undefined) {\n          message += ` (收到: ${JSON.stringify(err.received)})`\n        }\n\n        return message\n      })\n      .join('\\n')\n  }\n}\n"],"version":3}