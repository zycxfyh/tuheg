4fd99ac15b59a3dbf2befec69fb019c9
"use strict";
// 文件路径: apps/creation-agent/src/__tests__/creation.service.spec.ts
// 描述: CreationService 的单元测试，专注于世界生成逻辑和数据库交互
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('@tuheg/common-backend', () => ({
    ...jest.requireActual('@tuheg/common-backend'),
    callAiWithGuard: jest.fn(),
}));
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const common_backend_1 = require("@tuheg/common-backend");
const jest_mock_extended_1 = require("jest-mock-extended");
const creation_service_1 = require("./creation.service");
describe('CreationService', () => {
    let service;
    let prismaMock;
    let schedulerMock;
    let promptManagerMock;
    let eventBusMock;
    let promptInjectionGuardMock;
    const mockedCallAiWithGuard = common_backend_1.callAiWithGuard;
    const MOCK_CHAT_MODEL = {};
    const MOCK_PAYLOAD = {
        userId: 'user-123',
        concept: 'A cyberpunk city ruled by sentient cats.',
    };
    const MOCK_AI_RESPONSE = {
        gameName: 'Neko-Kyoto Prime',
        character: {
            name: 'Jax',
            card: {
                coreIdentity: 'A rogue street samurai cat',
                personality: ['cynical', 'agile'],
                appearance: 'A sleek black cat with a robotic eye.',
            },
        },
        worldBook: [{ key: 'Neko-Kyoto', content: { description: 'The main city.' } }],
    };
    beforeEach(async () => {
        prismaMock = (0, jest_mock_extended_1.mockDeep)();
        schedulerMock = (0, jest_mock_extended_1.mockDeep)();
        promptManagerMock = (0, jest_mock_extended_1.mockDeep)();
        eventBusMock = (0, jest_mock_extended_1.mockDeep)();
        promptInjectionGuardMock = (0, jest_mock_extended_1.mockDeep)();
        promptInjectionGuardMock.ensureSafeOrThrow.mockResolvedValue(undefined);
        const module = await testing_1.Test.createTestingModule({
            providers: [
                creation_service_1.CreationService,
                { provide: common_backend_1.PrismaService, useValue: prismaMock },
                { provide: common_backend_1.DynamicAiSchedulerService, useValue: schedulerMock },
                { provide: common_backend_1.PromptManagerService, useValue: promptManagerMock },
                { provide: common_backend_1.EventBusService, useValue: eventBusMock },
                { provide: common_backend_1.PromptInjectionGuard, useValue: promptInjectionGuardMock },
            ],
        }).compile();
        service = module.get(creation_service_1.CreationService);
        prismaMock.$transaction.mockImplementation((fn) => fn(prismaMock));
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('Happy Path', () => {
        it('should create a new world, save it, and publish completion event', async () => {
            schedulerMock.getProviderForRole.mockResolvedValue({ model: MOCK_CHAT_MODEL });
            promptManagerMock.getPrompt.mockReturnValue('persona prompt');
            mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE);
            const mockGame = {
                id: 'game-456',
                name: MOCK_AI_RESPONSE.gameName,
                ownerId: MOCK_PAYLOAD.userId,
                createdAt: new Date(),
                updatedAt: new Date(),
            };
            prismaMock.game.create.mockResolvedValue(mockGame);
            await service.createNewWorld(MOCK_PAYLOAD);
            expect(promptInjectionGuardMock.ensureSafeOrThrow).toHaveBeenCalledWith(MOCK_PAYLOAD.concept, {
                userId: MOCK_PAYLOAD.userId,
            });
            expect(mockedCallAiWithGuard).toHaveBeenCalledTimes(1);
            expect(prismaMock.$transaction).toHaveBeenCalledTimes(1);
            expect(prismaMock.game.create).toHaveBeenCalled();
            expect(prismaMock.character.create).toHaveBeenCalled();
            expect(prismaMock.worldBookEntry.createMany).toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_completed',
            }));
        });
    });
    describe('Error Handling', () => {
        it('should throw and publish failure event if AI generation fails', async () => {
            const aiError = new common_backend_1.AiGenerationException('AI failed');
            schedulerMock.getProviderForRole.mockResolvedValue({ model: MOCK_CHAT_MODEL });
            promptManagerMock.getPrompt.mockReturnValue('persona prompt');
            mockedCallAiWithGuard.mockRejectedValue(aiError);
            try {
                await service.createNewWorld(MOCK_PAYLOAD);
                fail('Expected createNewWorld to throw');
            }
            catch (error) {
                expect(error).toBeInstanceOf(common_1.InternalServerErrorException);
            }
            expect(prismaMock.$transaction).not.toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_failed',
                userId: MOCK_PAYLOAD.userId,
            }));
        });
        it('should throw and publish failure event if database transaction fails', async () => {
            const dbError = new Error('DB connection lost');
            schedulerMock.getProviderForRole.mockResolvedValue({ model: MOCK_CHAT_MODEL });
            promptManagerMock.getPrompt.mockReturnValue('persona prompt');
            mockedCallAiWithGuard.mockResolvedValue(MOCK_AI_RESPONSE);
            prismaMock.$transaction.mockRejectedValue(dbError);
            try {
                await service.createNewWorld(MOCK_PAYLOAD);
                fail('Expected createNewWorld to throw');
            }
            catch (error) {
                expect(error).toBe(dbError);
            }
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_failed',
                userId: MOCK_PAYLOAD.userId,
            }));
        });
        it('should propagate prompt injection errors before invoking AI', async () => {
            const guardError = new common_backend_1.PromptInjectionDetectedException('blocked', {
                score: 0.95,
                threshold: 0.75,
            });
            promptInjectionGuardMock.ensureSafeOrThrow.mockRejectedValueOnce(guardError);
            try {
                await service.createNewWorld(MOCK_PAYLOAD);
                fail('Expected createNewWorld to throw');
            }
            catch (error) {
                expect(error).toBeInstanceOf(common_backend_1.PromptInjectionDetectedException);
            }
            expect(mockedCallAiWithGuard).not.toHaveBeenCalled();
            expect(prismaMock.$transaction).not.toHaveBeenCalled();
            expect(eventBusMock.publish).toHaveBeenCalledWith('NOTIFY_USER', expect.objectContaining({
                event: 'creation_failed',
                userId: MOCK_PAYLOAD.userId,
            }));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGNyZWF0aW9uLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xcY3JlYXRpb24uc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxtRUFBbUU7QUFDbkUsNENBQTRDOztBQW1CNUMsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQztJQUM5QyxlQUFlLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUMzQixDQUFDLENBQUMsQ0FBQTtBQW5CSCwyQ0FBNkQ7QUFDN0QsNkNBQTBEO0FBRTFELDBEQVM4QjtBQUM5QiwyREFBaUU7QUFDakUseURBQW9EO0FBT3BELFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7SUFDL0IsSUFBSSxPQUF3QixDQUFBO0lBQzVCLElBQUksVUFBdUMsQ0FBQTtJQUMzQyxJQUFJLGFBQXVELENBQUE7SUFDM0QsSUFBSSxpQkFBc0QsQ0FBQTtJQUMxRCxJQUFJLFlBQTRDLENBQUE7SUFDaEQsSUFBSSx3QkFBNkQsQ0FBQTtJQUNqRSxNQUFNLHFCQUFxQixHQUFHLGdDQUE0QixDQUFBO0lBRTFELE1BQU0sZUFBZSxHQUFHLEVBQThCLENBQUE7SUFFdEQsTUFBTSxZQUFZLEdBQUc7UUFDbkIsTUFBTSxFQUFFLFVBQVU7UUFDbEIsT0FBTyxFQUFFLDBDQUEwQztLQUNwRCxDQUFBO0lBRUQsTUFBTSxnQkFBZ0IsR0FBRztRQUN2QixRQUFRLEVBQUUsa0JBQWtCO1FBQzVCLFNBQVMsRUFBRTtZQUNULElBQUksRUFBRSxLQUFLO1lBQ1gsSUFBSSxFQUFFO2dCQUNKLFlBQVksRUFBRSw0QkFBNEI7Z0JBQzFDLFdBQVcsRUFBRSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUM7Z0JBQ2pDLFVBQVUsRUFBRSx1Q0FBdUM7YUFDcEQ7U0FDRjtRQUNELFNBQVMsRUFBRSxDQUFD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XSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xcYXBwc1xcY3JlYXRpb24tYWdlbnRcXHNyY1xcX190ZXN0c19fXFxjcmVhdGlvbi5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8g5paH5Lu26Lev5b6EOiBhcHBzL2NyZWF0aW9uLWFnZW50L3NyYy9fX3Rlc3RzX18vY3JlYXRpb24uc2VydmljZS5zcGVjLnRzXG4vLyDmj4/ov7A6IENyZWF0aW9uU2VydmljZSDnmoTljZXlhYPmtYvor5XvvIzkuJPms6jkuo7kuJbnlYznlJ/miJDpgLvovpHlkozmlbDmja7lupPkuqTkupJcblxuaW1wb3J0IHR5cGUgeyBCYXNlQ2hhdE1vZGVsIH0gZnJvbSAnQGxhbmdjaGFpbi9jb3JlL2xhbmd1YWdlX21vZGVscy9jaGF0X21vZGVscydcbmltcG9ydCB7IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbidcbmltcG9ydCB7IFRlc3QsIHR5cGUgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZydcbmltcG9ydCB0eXBlIHsgR2FtZSwgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQge1xuICBBaUdlbmVyYXRpb25FeGNlcHRpb24sXG4gIGNhbGxBaVdpdGhHdWFyZCxcbiAgRHluYW1pY0FpU2NoZWR1bGVyU2VydmljZSxcbiAgRXZlbnRCdXNTZXJ2aWNlLFxuICBQcmlzbWFTZXJ2aWNlLFxuICBQcm9tcHRJbmplY3Rpb25EZXRlY3RlZEV4Y2VwdGlvbixcbiAgUHJvbXB0SW5qZWN0aW9uR3VhcmQsXG4gIFByb21wdE1hbmFnZXJTZXJ2aWNlLFxufSBmcm9tICdAdHVoZWcvY29tbW9uLWJhY2tlbmQnXG5pbXBvcnQgeyB0eXBlIERlZXBNb2NrUHJveHksIG1vY2tEZWVwIH0gZnJvbSAnamVzdC1tb2NrLWV4dGVuZGVkJ1xuaW1wb3J0IHsgQ3JlYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9jcmVhdGlvbi5zZXJ2aWNlJ1xuXG5qZXN0Lm1vY2soJ0B0dWhlZy9jb21tb24tYmFja2VuZCcsICgpID0+ICh7XG4gIC4uLmplc3QucmVxdWlyZUFjdHVhbCgnQHR1aGVnL2NvbW1vbi1iYWNrZW5kJyksXG4gIGNhbGxBaVdpdGhHdWFyZDogamVzdC5mbigpLFxufSkpXG5cbmRlc2NyaWJlKCdDcmVhdGlvblNlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBDcmVhdGlvblNlcnZpY2VcbiAgbGV0IHByaXNtYU1vY2s6IERlZXBNb2NrUHJveHk8UHJpc21hQ2xpZW50PlxuICBsZXQgc2NoZWR1bGVyTW9jazogRGVlcE1vY2tQcm94eTxEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlPlxuICBsZXQgcHJvbXB0TWFuYWdlck1vY2s6IERlZXBNb2NrUHJveHk8UHJvbXB0TWFuYWdlclNlcnZpY2U+XG4gIGxldCBldmVudEJ1c01vY2s6IERlZXBNb2NrUHJveHk8RXZlbnRCdXNTZXJ2aWNlPlxuICBsZXQgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrOiBEZWVwTW9ja1Byb3h5PFByb21wdEluamVjdGlvbkd1YXJkPlxuICBjb25zdCBtb2NrZWRDYWxsQWlXaXRoR3VhcmQgPSBjYWxsQWlXaXRoR3VhcmQgYXMgamVzdC5Nb2NrXG5cbiAgY29uc3QgTU9DS19DSEFUX01PREVMID0ge30gYXMgdW5rbm93biBhcyBCYXNlQ2hhdE1vZGVsXG5cbiAgY29uc3QgTU9DS19QQVlMT0FEID0ge1xuICAgIHVzZXJJZDogJ3VzZXItMTIzJyxcbiAgICBjb25jZXB0OiAnQSBjeWJlcnB1bmsgY2l0eSBydWxlZCBieSBzZW50aWVudCBjYXRzLicsXG4gIH1cblxuICBjb25zdCBNT0NLX0FJX1JFU1BPTlNFID0ge1xuICAgIGdhbWVOYW1lOiAnTmVrby1LeW90byBQcmltZScsXG4gICAgY2hhcmFjdGVyOiB7XG4gICAgICBuYW1lOiAnSmF4JyxcbiAgICAgIGNhcmQ6IHtcbiAgICAgICAgY29yZUlkZW50aXR5OiAnQSByb2d1ZSBzdHJlZXQgc2FtdXJhaSBjYXQnLFxuICAgICAgICBwZXJzb25hbGl0eTogWydjeW5pY2FsJywgJ2FnaWxlJ10sXG4gICAgICAgIGFwcGVhcmFuY2U6ICdBIHNsZWVrIGJsYWNrIGNhdCB3aXRoIGEgcm9ib3RpYyBleWUuJyxcbiAgICAgIH0sXG4gICAgfSxcbiAgICB3b3JsZEJvb2s6IFt7IGtleTogJ05la28tS3lvdG8nLCBjb250ZW50OiB7IGRlc2NyaXB0aW9uOiAnVGhlIG1haW4gY2l0eS4nIH0gfV0sXG4gIH1cblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBwcmlzbWFNb2NrID0gbW9ja0RlZXA8UHJpc21hQ2xpZW50PigpXG4gICAgc2NoZWR1bGVyTW9jayA9IG1vY2tEZWVwPER5bmFtaWNBaVNjaGVkdWxlclNlcnZpY2U+KClcbiAgICBwcm9tcHRNYW5hZ2VyTW9jayA9IG1vY2tEZWVwPFByb21wdE1hbmFnZXJTZXJ2aWNlPigpXG4gICAgZXZlbnRCdXNNb2NrID0gbW9ja0RlZXA8RXZlbnRCdXNTZXJ2aWNlPigpXG4gICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrID0gbW9ja0RlZXA8UHJvbXB0SW5qZWN0aW9uR3VhcmQ+KClcbiAgICBwcm9tcHRJbmplY3Rpb25HdWFyZE1vY2suZW5zdXJlU2FmZU9yVGhyb3cubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKVxuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBDcmVhdGlvblNlcnZpY2UsXG4gICAgICAgIHsgcHJvdmlkZTogUHJpc21hU2VydmljZSwgdXNlVmFsdWU6IHByaXNtYU1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBEeW5hbWljQWlTY2hlZHVsZXJTZXJ2aWNlLCB1c2VWYWx1ZTogc2NoZWR1bGVyTW9jayB9LFxuICAgICAgICB7IHByb3ZpZGU6IFByb21wdE1hbmFnZXJTZXJ2aWNlLCB1c2VWYWx1ZTogcHJvbXB0TWFuYWdlck1vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBFdmVudEJ1c1NlcnZpY2UsIHVzZVZhbHVlOiBldmVudEJ1c01vY2sgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQcm9tcHRJbmplY3Rpb25HdWFyZCwgdXNlVmFsdWU6IHByb21wdEluamVjdGlvbkd1YXJkTW9jayB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKClcblxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PENyZWF0aW9uU2VydmljZT4oQ3JlYXRpb25TZXJ2aWNlKVxuXG4gICAgcHJpc21hTW9jay4kdHJhbnNhY3Rpb24ubW9ja0ltcGxlbWVudGF0aW9uKChmbjogYW55KSA9PiBmbihwcmlzbWFNb2NrKSlcbiAgfSlcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpXG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ0hhcHB5IFBhdGgnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYSBuZXcgd29ybGQsIHNhdmUgaXQsIGFuZCBwdWJsaXNoIGNvbXBsZXRpb24gZXZlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IG1vZGVsOiBNT0NLX0NIQVRfTU9ERUwgfSlcbiAgICAgIHByb21wdE1hbmFnZXJNb2NrLmdldFByb21wdC5tb2NrUmV0dXJuVmFsdWUoJ3BlcnNvbmEgcHJvbXB0JylcbiAgICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrUmVzb2x2ZWRWYWx1ZShNT0NLX0FJX1JFU1BPTlNFKVxuICAgICAgY29uc3QgbW9ja0dhbWU6IEdhbWUgPSB7XG4gICAgICAgIGlkOiAnZ2FtZS00NTYnLFxuICAgICAgICBuYW1lOiBNT0NLX0FJX1JFU1BPTlNFLmdhbWVOYW1lLFxuICAgICAgICBvd25lcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH1cbiAgICAgIHByaXNtYU1vY2suZ2FtZS5jcmVhdGUubW9ja1Jlc29sdmVkVmFsdWUobW9ja0dhbWUpXG5cbiAgICAgIGF3YWl0IHNlcnZpY2UuY3JlYXRlTmV3V29ybGQoTU9DS19QQVlMT0FEKVxuXG4gICAgICBleHBlY3QocHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmVuc3VyZVNhZmVPclRocm93KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgTU9DS19QQVlMT0FELmNvbmNlcHQsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VySWQ6IE1PQ0tfUEFZTE9BRC51c2VySWQsXG4gICAgICAgIH1cbiAgICAgIClcbiAgICAgIGV4cGVjdChtb2NrZWRDYWxsQWlXaXRoR3VhcmQpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKVxuICAgICAgZXhwZWN0KHByaXNtYU1vY2suJHRyYW5zYWN0aW9uKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSlcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLmdhbWUuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLmNoYXJhY3Rlci5jcmVhdGUpLnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgICAgZXhwZWN0KHByaXNtYU1vY2sud29ybGRCb29rRW50cnkuY3JlYXRlTWFueSkudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgICBleHBlY3QoZXZlbnRCdXNNb2NrLnB1Ymxpc2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnTk9USUZZX1VTRVInLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgZXZlbnQ6ICdjcmVhdGlvbl9jb21wbGV0ZWQnLFxuICAgICAgICB9KVxuICAgICAgKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ0Vycm9yIEhhbmRsaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdGhyb3cgYW5kIHB1Ymxpc2ggZmFpbHVyZSBldmVudCBpZiBBSSBnZW5lcmF0aW9uIGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYWlFcnJvciA9IG5ldyBBaUdlbmVyYXRpb25FeGNlcHRpb24oJ0FJIGZhaWxlZCcpXG4gICAgICBzY2hlZHVsZXJNb2NrLmdldFByb3ZpZGVyRm9yUm9sZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IG1vZGVsOiBNT0NLX0NIQVRfTU9ERUwgfSlcbiAgICAgIHByb21wdE1hbmFnZXJNb2NrLmdldFByb21wdC5tb2NrUmV0dXJuVmFsdWUoJ3BlcnNvbmEgcHJvbXB0JylcbiAgICAgIG1vY2tlZENhbGxBaVdpdGhHdWFyZC5tb2NrUmVqZWN0ZWRWYWx1ZShhaUVycm9yKVxuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZU5ld1dvcmxkKE1PQ0tfUEFZTE9BRClcbiAgICAgICAgZmFpbCgnRXhwZWN0ZWQgY3JlYXRlTmV3V29ybGQgdG8gdGhyb3cnKVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgZXhwZWN0KGVycm9yKS50b0JlSW5zdGFuY2VPZihJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKVxuICAgICAgfVxuXG4gICAgICBleHBlY3QocHJpc21hTW9jay4kdHJhbnNhY3Rpb24pLm5vdC50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChldmVudEJ1c01vY2sucHVibGlzaCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdOT1RJRllfVVNFUicsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBldmVudDogJ2NyZWF0aW9uX2ZhaWxlZCcsXG4gICAgICAgICAgdXNlcklkOiBNT0NLX1BBWUxPQUQudXNlcklkLFxuICAgICAgICB9KVxuICAgICAgKVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGFuZCBwdWJsaXNoIGZhaWx1cmUgZXZlbnQgaWYgZGF0YWJhc2UgdHJhbnNhY3Rpb24gZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkYkVycm9yID0gbmV3IEVycm9yKCdEQiBjb25uZWN0aW9uIGxvc3QnKVxuICAgICAgc2NoZWR1bGVyTW9jay5nZXRQcm92aWRlckZvclJvbGUubW9ja1Jlc29sdmVkVmFsdWUoeyBtb2RlbDogTU9DS19DSEFUX01PREVMIH0pXG4gICAgICBwcm9tcHRNYW5hZ2VyTW9jay5nZXRQcm9tcHQubW9ja1JldHVyblZhbHVlKCdwZXJzb25hIHByb21wdCcpXG4gICAgICBtb2NrZWRDYWxsQWlXaXRoR3VhcmQubW9ja1Jlc29sdmVkVmFsdWUoTU9DS19BSV9SRVNQT05TRSlcbiAgICAgIHByaXNtYU1vY2suJHRyYW5zYWN0aW9uLm1vY2tSZWplY3RlZFZhbHVlKGRiRXJyb3IpXG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHNlcnZpY2UuY3JlYXRlTmV3V29ybGQoTU9DS19QQVlMT0FEKVxuICAgICAgICBmYWlsKCdFeHBlY3RlZCBjcmVhdGVOZXdXb3JsZCB0byB0aHJvdycpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBleHBlY3QoZXJyb3IpLnRvQmUoZGJFcnJvcilcbiAgICAgIH1cblxuICAgICAgZXhwZWN0KGV2ZW50QnVzTW9jay5wdWJsaXNoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ05PVElGWV9VU0VSJyxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGV2ZW50OiAnY3JlYXRpb25fZmFpbGVkJyxcbiAgICAgICAgICB1c2VySWQ6IE1PQ0tfUEFZTE9BRC51c2VySWQsXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgcHJvcGFnYXRlIHByb21wdCBpbmplY3Rpb24gZXJyb3JzIGJlZm9yZSBpbnZva2luZyBBSScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGd1YXJkRXJyb3IgPSBuZXcgUHJvbXB0SW5qZWN0aW9uRGV0ZWN0ZWRFeGNlcHRpb24oJ2Jsb2NrZWQnLCB7XG4gICAgICAgIHNjb3JlOiAwLjk1LFxuICAgICAgICB0aHJlc2hvbGQ6IDAuNzUsXG4gICAgICB9KVxuICAgICAgcHJvbXB0SW5qZWN0aW9uR3VhcmRNb2NrLmVuc3VyZVNhZmVPclRocm93Lm1vY2tSZWplY3RlZFZhbHVlT25jZShndWFyZEVycm9yKVxuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZU5ld1dvcmxkKE1PQ0tfUEFZTE9BRClcbiAgICAgICAgZmFpbCgnRXhwZWN0ZWQgY3JlYXRlTmV3V29ybGQgdG8gdGhyb3cnKVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgZXhwZWN0KGVycm9yKS50b0JlSW5zdGFuY2VPZihQcm9tcHRJbmplY3Rpb25EZXRlY3RlZEV4Y2VwdGlvbilcbiAgICAgIH1cblxuICAgICAgZXhwZWN0KG1vY2tlZENhbGxBaVdpdGhHdWFyZCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgICAgZXhwZWN0KHByaXNtYU1vY2suJHRyYW5zYWN0aW9uKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgICBleHBlY3QoZXZlbnRCdXNNb2NrLnB1Ymxpc2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnTk9USUZZX1VTRVInLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgZXZlbnQ6ICdjcmVhdGlvbl9mYWlsZWQnLFxuICAgICAgICAgIHVzZXJJZDogTU9DS19QQVlMT0FELnVzZXJJZCxcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICB9KVxuICB9KVxufSlcbiJdLCJ2ZXJzaW9uIjozfQ==