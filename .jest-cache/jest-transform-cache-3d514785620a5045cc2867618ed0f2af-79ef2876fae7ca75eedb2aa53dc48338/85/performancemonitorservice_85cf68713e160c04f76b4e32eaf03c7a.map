{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\observability\\performance-monitor.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\observability\\performance-monitor.service.ts"],"sourcesContent":["// æ–‡ä»¶è·¯å¾„: packages/common-backend/src/observability/performance-monitor.service.ts\n// èŒè´£: æ€§èƒ½ç›‘æ§æœåŠ¡ï¼Œå®ç°SLAæŒ‡æ ‡æ”¶é›†å’Œå‘Šè­¦\n\nimport { Injectable, Logger } from '@nestjs/common'\nimport { Cron, CronExpression } from '@nestjs/schedule'\nimport * as os from 'os'\nimport {\n  getSLATarget,\n  isPerformanceHealthy,\n  PERFORMANCE_CONFIG,\n  type ServiceSLAs,\n} from '../config/performance-config'\n\n/**\n * @interface PerformanceMetrics\n * @description æ€§èƒ½æŒ‡æ ‡æ•°æ®ç»“æ„\n */\nexport interface PerformanceMetrics {\n  timestamp: number\n  service: keyof ServiceSLAs\n  responseTime: {\n    p50: number\n    p95: number\n    p99: number\n    avg: number\n  }\n  errorRate: number\n  availability: number\n  throughput: number\n  system: {\n    cpuUsage: number\n    memoryUsage: number\n    activeConnections: number\n  }\n}\n\n/**\n * @interface AlertCondition\n * @description å‘Šè­¦æ¡ä»¶\n */\nexport interface AlertCondition {\n  service: keyof ServiceSLAs\n  metric: string\n  threshold: number\n  currentValue: number\n  level: 'warning' | 'critical' | 'emergency' | 'healthy'\n  timestamp: number\n}\n\n/**\n * @service PerformanceMonitorService\n * @description æ€§èƒ½ç›‘æ§æœåŠ¡\n */\n@Injectable()\nexport class PerformanceMonitorService {\n  private readonly logger = new Logger(PerformanceMonitorService.name)\n\n  // æŒ‡æ ‡å­˜å‚¨ (å†…å­˜ä¸­ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Redisæˆ–æ•°æ®åº“)\n  private readonly metrics: PerformanceMetrics[] = []\n  private readonly alerts: AlertCondition[] = []\n\n  // è®¡æ•°å™¨\n  private requestCount = 0\n  private errorCount = 0\n  private responseTimes: number[] = []\n\n  constructor() {\n    this.logger.log('PerformanceMonitorService initialized with SLA targets')\n  }\n\n  /**\n   * @method recordRequest\n   * @description è®°å½•APIè¯·æ±‚\n   */\n  recordRequest(_service: keyof ServiceSLAs, responseTime: number, isError = false): void {\n    this.requestCount++\n    this.responseTimes.push(responseTime)\n\n    if (isError) {\n      this.errorCount++\n    }\n\n    // ä¿æŒæœ€è¿‘1000ä¸ªå“åº”æ—¶é—´çš„è®°å½•\n    if (this.responseTimes.length > 1000) {\n      this.responseTimes.shift()\n    }\n  }\n\n  /**\n   * @method collectMetrics\n   * @description æ”¶é›†å½“å‰æ€§èƒ½æŒ‡æ ‡\n   */\n  @Cron(CronExpression.EVERY_MINUTE)\n  async collectMetrics(): Promise<void> {\n    try {\n      const metrics = await this.gatherCurrentMetrics()\n      this.metrics.push(metrics)\n\n      // ä¿æŒæœ€è¿‘24å°æ—¶çš„æ•°æ®\n      const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000\n      this.metrics.splice(\n        0,\n        this.metrics.findIndex((m) => m.timestamp < oneDayAgo)\n      )\n\n      // æ£€æŸ¥SLAåˆè§„æ€§\n      await this.checkSLAViolations(metrics)\n\n      this.logger.debug(`Performance metrics collected: ${JSON.stringify(metrics)}`)\n    } catch (error) {\n      this.logger.error('Failed to collect performance metrics:', error)\n    }\n  }\n\n  /**\n   * @method checkSLAViolations\n   * @description æ£€æŸ¥SLAè¿è§„\n   */\n  @Cron(CronExpression.EVERY_5_MINUTES)\n  async checkSLAViolations(metrics: PerformanceMetrics): Promise<void> {\n    const sla = getSLATarget(metrics.service)\n\n    // æ£€æŸ¥å“åº”æ—¶é—´\n    const rtHealth = isPerformanceHealthy(metrics.service, 'responseTime', metrics.responseTime.p95)\n    if (!rtHealth.healthy) {\n      await this.createAlert({\n        service: metrics.service,\n        metric: 'responseTime',\n        threshold: sla.responseTime.p95,\n        currentValue: metrics.responseTime.p95,\n        level: rtHealth.level,\n        timestamp: Date.now(),\n      })\n    }\n\n    // æ£€æŸ¥é”™è¯¯ç‡\n    const erHealth = isPerformanceHealthy(metrics.service, 'errorRate', metrics.errorRate)\n    if (!erHealth.healthy) {\n      await this.createAlert({\n        service: metrics.service,\n        metric: 'errorRate',\n        threshold: sla.errorRate,\n        currentValue: metrics.errorRate,\n        level: erHealth.level,\n        timestamp: Date.now(),\n      })\n    }\n\n    // æ£€æŸ¥å¯ç”¨æ€§\n    const avHealth = isPerformanceHealthy(metrics.service, 'availability', metrics.availability)\n    if (!avHealth.healthy) {\n      await this.createAlert({\n        service: metrics.service,\n        metric: 'availability',\n        threshold: sla.availability,\n        currentValue: metrics.availability,\n        level: avHealth.level,\n        timestamp: Date.now(),\n      })\n    }\n  }\n\n  /**\n   * @method createAlert\n   * @description åˆ›å»ºå‘Šè­¦\n   */\n  private async createAlert(alert: AlertCondition): Promise<void> {\n    this.alerts.push(alert)\n\n    // ä¿æŒæœ€è¿‘100ä¸ªå‘Šè­¦\n    if (this.alerts.length > 100) {\n      this.alerts.shift()\n    }\n\n    // å‘é€å‘Šè­¦é€šçŸ¥ (è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€Slackç­‰)\n    this.logger.warn(\n      `ğŸš¨ Performance Alert: ${alert.service} ${alert.metric} ${alert.level} - ${alert.currentValue} > ${alert.threshold}`\n    )\n\n    // TODO: é›†æˆSentryæˆ–å…¶ä»–å‘Šè­¦ç³»ç»Ÿ\n  }\n\n  /**\n   * @method gatherCurrentMetrics\n   * @description æ”¶é›†å½“å‰ç³»ç»ŸæŒ‡æ ‡\n   */\n  private async gatherCurrentMetrics(): Promise<PerformanceMetrics> {\n    // è®¡ç®—å“åº”æ—¶é—´ç™¾åˆ†ä½æ•°\n    const sortedTimes = [...this.responseTimes].sort((a, b) => a - b)\n    const p50 = this.calculatePercentile(sortedTimes, 50)\n    const p95 = this.calculatePercentile(sortedTimes, 95)\n    const p99 = this.calculatePercentile(sortedTimes, 99)\n    const avg = this.responseTimes.reduce((a, b) => a + b, 0) / this.responseTimes.length\n\n    // è®¡ç®—é”™è¯¯ç‡\n    const errorRate = this.requestCount > 0 ? (this.errorCount / this.requestCount) * 100 : 0\n\n    // ç³»ç»ŸæŒ‡æ ‡\n    const cpuUsage = (os.loadavg()[0] / os.cpus().length) * 100\n    const memoryUsage = ((os.totalmem() - os.freemem()) / os.totalmem()) * 100\n\n    // æ¨¡æ‹Ÿæ´»è·ƒè¿æ¥æ•° (ç”Ÿäº§ç¯å¢ƒéœ€è¦ä»WebSocketç½‘å…³è·å–)\n    const activeConnections = 0 // TODO: é›†æˆWebSocketè¿æ¥è®¡æ•°\n\n    return {\n      timestamp: Date.now(),\n      service: 'api', // é»˜è®¤ç›‘æ§APIæœåŠ¡\n      responseTime: { p50, p95, p99, avg },\n      errorRate,\n      availability: 99.9, // TODO: è®¡ç®—çœŸå®å¯ç”¨æ€§\n      throughput: this.requestCount,\n      system: {\n        cpuUsage,\n        memoryUsage,\n        activeConnections,\n      },\n    }\n  }\n\n  /**\n   * @method calculatePercentile\n   * @description è®¡ç®—ç™¾åˆ†ä½æ•°\n   */\n  private calculatePercentile(sortedArray: number[], percentile: number): number {\n    if (sortedArray.length === 0) return 0\n\n    const index = (percentile / 100) * (sortedArray.length - 1)\n    const lower = Math.floor(index)\n    const upper = Math.ceil(index)\n\n    if (lower === upper) {\n      return sortedArray[lower]\n    }\n\n    return sortedArray[lower] + (sortedArray[upper] - sortedArray[lower]) * (index - lower)\n  }\n\n  /**\n   * @method getMetrics\n   * @description è·å–æ€§èƒ½æŒ‡æ ‡\n   */\n  getMetrics(hours: number = 1): PerformanceMetrics[] {\n    const cutoff = Date.now() - hours * 60 * 60 * 1000\n    return this.metrics.filter((m) => m.timestamp >= cutoff)\n  }\n\n  /**\n   * @method getAlerts\n   * @description è·å–å‘Šè­¦åˆ—è¡¨\n   */\n  getAlerts(hours: number = 24): AlertCondition[] {\n    const cutoff = Date.now() - hours * 60 * 60 * 1000\n    return this.alerts.filter((a) => a.timestamp >= cutoff)\n  }\n\n  /**\n   * @method getSLASummary\n   * @description è·å–SLAæ‘˜è¦\n   */\n  getSLASummary(): Record<\n    keyof ServiceSLAs,\n    {\n      target: any\n      current: any\n      status: 'healthy' | 'warning' | 'critical' | 'emergency'\n    }\n  > {\n    const summary = {} as any\n    const services = Object.keys(PERFORMANCE_CONFIG.slas) as (keyof ServiceSLAs)[]\n\n    for (const service of services) {\n      const recentMetrics = this.getMetrics(1).filter((m) => m.service === service)\n      const latest = recentMetrics[recentMetrics.length - 1]\n\n      if (latest) {\n        const sla = getSLATarget(service)\n        const rtHealth = isPerformanceHealthy(service, 'responseTime', latest.responseTime.p95)\n        const erHealth = isPerformanceHealthy(service, 'errorRate', latest.errorRate)\n\n        summary[service] = {\n          target: sla,\n          current: {\n            responseTime: latest.responseTime,\n            errorRate: latest.errorRate,\n            availability: latest.availability,\n          },\n          status: rtHealth.healthy && erHealth.healthy ? 'healthy' : rtHealth.level,\n        }\n      } else {\n        summary[service] = {\n          target: getSLATarget(service),\n          current: null,\n          status: 'healthy' as const,\n        }\n      }\n    }\n\n    return summary\n  }\n\n  /**\n   * @method resetCounters\n   * @description é‡ç½®è®¡æ•°å™¨ (ç”¨äºæµ‹è¯•)\n   */\n  resetCounters(): void {\n    this.requestCount = 0\n    this.errorCount = 0\n    this.responseTimes = []\n  }\n}\n"],"version":3}