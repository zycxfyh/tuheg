1db46fb4cf0b26f83ec4954b32141506
"use strict";
// Êñá‰ª∂Ë∑ØÂæÑ: packages/common-backend/src/observability/performance-monitor.service.ts
// ËÅåË¥£: ÊÄßËÉΩÁõëÊéßÊúçÂä°ÔºåÂÆûÁé∞SLAÊåáÊ†áÊî∂ÈõÜÂíåÂëäË≠¶
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var PerformanceMonitorService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PerformanceMonitorService = void 0;
const common_1 = require("@nestjs/common");
const schedule_1 = require("@nestjs/schedule");
const os = __importStar(require("os"));
const performance_config_1 = require("../config/performance-config");
/**
 * @service PerformanceMonitorService
 * @description ÊÄßËÉΩÁõëÊéßÊúçÂä°
 */
let PerformanceMonitorService = PerformanceMonitorService_1 = class PerformanceMonitorService {
    logger = new common_1.Logger(PerformanceMonitorService_1.name);
    // ÊåáÊ†áÂ≠òÂÇ® (ÂÜÖÂ≠ò‰∏≠ÔºåÁîü‰∫ßÁéØÂ¢ÉÂª∫ËÆÆ‰ΩøÁî®RedisÊàñÊï∞ÊçÆÂ∫ì)
    metrics = [];
    alerts = [];
    // ËÆ°Êï∞Âô®
    requestCount = 0;
    errorCount = 0;
    responseTimes = [];
    constructor() {
        this.logger.log('PerformanceMonitorService initialized with SLA targets');
    }
    /**
     * @method recordRequest
     * @description ËÆ∞ÂΩïAPIËØ∑Ê±Ç
     */
    recordRequest(_service, responseTime, isError = false) {
        this.requestCount++;
        this.responseTimes.push(responseTime);
        if (isError) {
            this.errorCount++;
        }
        // ‰øùÊåÅÊúÄËøë1000‰∏™ÂìçÂ∫îÊó∂Èó¥ÁöÑËÆ∞ÂΩï
        if (this.responseTimes.length > 1000) {
            this.responseTimes.shift();
        }
    }
    /**
     * @method collectMetrics
     * @description Êî∂ÈõÜÂΩìÂâçÊÄßËÉΩÊåáÊ†á
     */
    async collectMetrics() {
        try {
            const metrics = await this.gatherCurrentMetrics();
            this.metrics.push(metrics);
            // ‰øùÊåÅÊúÄËøë24Â∞èÊó∂ÁöÑÊï∞ÊçÆ
            const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000;
            this.metrics.splice(0, this.metrics.findIndex((m) => m.timestamp < oneDayAgo));
            // Ê£ÄÊü•SLAÂêàËßÑÊÄß
            await this.checkSLAViolations(metrics);
            this.logger.debug(`Performance metrics collected: ${JSON.stringify(metrics)}`);
        }
        catch (error) {
            this.logger.error('Failed to collect performance metrics:', error);
        }
    }
    /**
     * @method checkSLAViolations
     * @description Ê£ÄÊü•SLAËøùËßÑ
     */
    async checkSLAViolations(metrics) {
        const sla = (0, performance_config_1.getSLATarget)(metrics.service);
        // Ê£ÄÊü•ÂìçÂ∫îÊó∂Èó¥
        const rtHealth = (0, performance_config_1.isPerformanceHealthy)(metrics.service, 'responseTime', metrics.responseTime.p95);
        if (!rtHealth.healthy) {
            await this.createAlert({
                service: metrics.service,
                metric: 'responseTime',
                threshold: sla.responseTime.p95,
                currentValue: metrics.responseTime.p95,
                level: rtHealth.level,
                timestamp: Date.now(),
            });
        }
        // Ê£ÄÊü•ÈîôËØØÁéá
        const erHealth = (0, performance_config_1.isPerformanceHealthy)(metrics.service, 'errorRate', metrics.errorRate);
        if (!erHealth.healthy) {
            await this.createAlert({
                service: metrics.service,
                metric: 'errorRate',
                threshold: sla.errorRate,
                currentValue: metrics.errorRate,
                level: erHealth.level,
                timestamp: Date.now(),
            });
        }
        // Ê£ÄÊü•ÂèØÁî®ÊÄß
        const avHealth = (0, performance_config_1.isPerformanceHealthy)(metrics.service, 'availability', metrics.availability);
        if (!avHealth.healthy) {
            await this.createAlert({
                service: metrics.service,
                metric: 'availability',
                threshold: sla.availability,
                currentValue: metrics.availability,
                level: avHealth.level,
                timestamp: Date.now(),
            });
        }
    }
    /**
     * @method createAlert
     * @description ÂàõÂª∫ÂëäË≠¶
     */
    async createAlert(alert) {
        this.alerts.push(alert);
        // ‰øùÊåÅÊúÄËøë100‰∏™ÂëäË≠¶
        if (this.alerts.length > 100) {
            this.alerts.shift();
        }
        // ÂèëÈÄÅÂëäË≠¶ÈÄöÁü• (ËøôÈáåÂèØ‰ª•ÈõÜÊàêÈÇÆ‰ª∂„ÄÅSlackÁ≠â)
        this.logger.warn(`üö® Performance Alert: ${alert.service} ${alert.metric} ${alert.level} - ${alert.currentValue} > ${alert.threshold}`);
        // TODO: ÈõÜÊàêSentryÊàñÂÖ∂‰ªñÂëäË≠¶Á≥ªÁªü
    }
    /**
     * @method gatherCurrentMetrics
     * @description Êî∂ÈõÜÂΩìÂâçÁ≥ªÁªüÊåáÊ†á
     */
    async gatherCurrentMetrics() {
        // ËÆ°ÁÆóÂìçÂ∫îÊó∂Èó¥ÁôæÂàÜ‰ΩçÊï∞
        const sortedTimes = [...this.responseTimes].sort((a, b) => a - b);
        const p50 = this.calculatePercentile(sortedTimes, 50);
        const p95 = this.calculatePercentile(sortedTimes, 95);
        const p99 = this.calculatePercentile(sortedTimes, 99);
        const avg = this.responseTimes.reduce((a, b) => a + b, 0) / this.responseTimes.length;
        // ËÆ°ÁÆóÈîôËØØÁéá
        const errorRate = this.requestCount > 0 ? (this.errorCount / this.requestCount) * 100 : 0;
        // Á≥ªÁªüÊåáÊ†á
        const cpuUsage = (os.loadavg()[0] / os.cpus().length) * 100;
        const memoryUsage = ((os.totalmem() - os.freemem()) / os.totalmem()) * 100;
        // Ê®°ÊãüÊ¥ªË∑ÉËøûÊé•Êï∞ (Áîü‰∫ßÁéØÂ¢ÉÈúÄË¶Å‰ªéWebSocketÁΩëÂÖ≥Ëé∑Âèñ)
        const activeConnections = 0; // TODO: ÈõÜÊàêWebSocketËøûÊé•ËÆ°Êï∞
        return {
            timestamp: Date.now(),
            service: 'api', // ÈªòËÆ§ÁõëÊéßAPIÊúçÂä°
            responseTime: { p50, p95, p99, avg },
            errorRate,
            availability: 99.9, // TODO: ËÆ°ÁÆóÁúüÂÆûÂèØÁî®ÊÄß
            throughput: this.requestCount,
            system: {
                cpuUsage,
                memoryUsage,
                activeConnections,
            },
        };
    }
    /**
     * @method calculatePercentile
     * @description ËÆ°ÁÆóÁôæÂàÜ‰ΩçÊï∞
     */
    calculatePercentile(sortedArray, percentile) {
        if (sortedArray.length === 0)
            return 0;
        const index = (percentile / 100) * (sortedArray.length - 1);
        const lower = Math.floor(index);
        const upper = Math.ceil(index);
        if (lower === upper) {
            return sortedArray[lower];
        }
        return sortedArray[lower] + (sortedArray[upper] - sortedArray[lower]) * (index - lower);
    }
    /**
     * @method getMetrics
     * @description Ëé∑ÂèñÊÄßËÉΩÊåáÊ†á
     */
    getMetrics(hours = 1) {
        const cutoff = Date.now() - hours * 60 * 60 * 1000;
        return this.metrics.filter((m) => m.timestamp >= cutoff);
    }
    /**
     * @method getAlerts
     * @description Ëé∑ÂèñÂëäË≠¶ÂàóË°®
     */
    getAlerts(hours = 24) {
        const cutoff = Date.now() - hours * 60 * 60 * 1000;
        return this.alerts.filter((a) => a.timestamp >= cutoff);
    }
    /**
     * @method getSLASummary
     * @description Ëé∑ÂèñSLAÊëòË¶Å
     */
    getSLASummary() {
        const summary = {};
        const services = Object.keys(performance_config_1.PERFORMANCE_CONFIG.slas);
        for (const service of services) {
            const recentMetrics = this.getMetrics(1).filter((m) => m.service === service);
            const latest = recentMetrics[recentMetrics.length - 1];
            if (latest) {
                const sla = (0, performance_config_1.getSLATarget)(service);
                const rtHealth = (0, performance_config_1.isPerformanceHealthy)(service, 'responseTime', latest.responseTime.p95);
                const erHealth = (0, performance_config_1.isPerformanceHealthy)(service, 'errorRate', latest.errorRate);
                summary[service] = {
                    target: sla,
                    current: {
                        responseTime: latest.responseTime,
                        errorRate: latest.errorRate,
                        availability: latest.availability,
                    },
                    status: rtHealth.healthy && erHealth.healthy ? 'healthy' : rtHealth.level,
                };
            }
            else {
                summary[service] = {
                    target: (0, performance_config_1.getSLATarget)(service),
                    current: null,
                    status: 'healthy',
                };
            }
        }
        return summary;
    }
    /**
     * @method resetCounters
     * @description ÈáçÁΩÆËÆ°Êï∞Âô® (Áî®‰∫éÊµãËØï)
     */
    resetCounters() {
        this.requestCount = 0;
        this.errorCount = 0;
        this.responseTimes = [];
    }
};
exports.PerformanceMonitorService = PerformanceMonitorService;
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_MINUTE),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", typeof (_a = typeof Promise !== "undefined" && Promise) === "function" ? _a : Object)
], PerformanceMonitorService.prototype, "collectMetrics", null);
__decorate([
    (0, schedule_1.Cron)(schedule_1.CronExpression.EVERY_5_MINUTES),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", typeof (_b = typeof Promise !== "undefined" && Promise) === "function" ? _b : Object)
], PerformanceMonitorService.prototype, "checkSLAViolations", null);
exports.PerformanceMonitorService = PerformanceMonitorService = PerformanceMonitorService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [])
], PerformanceMonitorService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxvYnNlcnZhYmlsaXR5XFxwZXJmb3JtYW5jZS1tb25pdG9yLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBLGlGQUFpRjtBQUNqRiwwQkFBMEI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRTFCLDJDQUFtRDtBQUNuRCwrQ0FBdUQ7QUFDdkQsdUNBQXdCO0FBQ3hCLHFFQUtxQztBQXNDckM7OztHQUdHO0FBRUksSUFBTSx5QkFBeUIsaUNBQS9CLE1BQU0seUJBQXlCO0lBQ25CLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQywyQkFBeUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUVwRSwrQkFBK0I7SUFDZCxPQUFPLEdBQXlCLEVBQUUsQ0FBQTtJQUNsQyxNQUFNLEdBQXFCLEVBQUUsQ0FBQTtJQUU5QyxNQUFNO0lBQ0UsWUFBWSxHQUFHLENBQUMsQ0FBQTtJQUNoQixVQUFVLEdBQUcsQ0FBQyxDQUFBO0lBQ2QsYUFBYSxHQUFhLEVBQUUsQ0FBQTtJQUVwQztRQUNFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHdEQUF3RCxDQUFDLENBQUE7SUFDM0UsQ0FBQztJQUVEOzs7T0FHRztJQUNILGFBQWEsQ0FBQyxRQUEyQixFQUFFLFlBQW9CLEVBQUUsT0FBTyxHQUFHLEtBQUs7UUFDOUUsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO1FBQ25CLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBRXJDLElBQUksT0FBTyxFQUFFLENBQUM7WUFDWixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7UUFDbkIsQ0FBQztRQUVELG1CQUFtQjtRQUNuQixJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLElBQUksRUFBRSxDQUFDO1lBQ3JDLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDNUIsQ0FBQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFFRyxBQUFOLEtBQUssQ0FBQyxjQUFjO1FBQ2xCLElBQUksQ0FBQztZQUNILE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUE7WUFDakQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7WUFFMUIsY0FBYztZQUNkLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUE7WUFDbEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQ2pCLENBQUMsRUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsQ0FDdkQsQ0FBQTtZQUVELFdBQVc7WUFDWCxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUV0QyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDaEYsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyx3Q0FBd0MsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUNwRSxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUVHLEFBQU4sS0FBSyxDQUFDLGtCQUFrQixDQUFDLE9BQTJCO1FBQ2xELE1BQU0sR0FBRyxHQUFHLElBQUEsaUNBQVksRUFBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUE7UUFFekMsU0FBUztRQUNULE1BQU0sUUFBUSxHQUFHLElBQUEseUNBQW9CLEVBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUNoRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3RCLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQztnQkFDckIsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPO2dCQUN4QixNQUFNLEVBQUUsY0FBYztnQkFDdEIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRztnQkFDL0IsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZLENBQUMsR0FBRztnQkFDdEMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLO2dCQUNyQixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTthQUN0QixDQUFDLENBQUE7UUFDSixDQUFDO1FBRUQsUUFBUTtRQUNSLE1BQU0sUUFBUSxHQUFHLElBQUEseUNBQW9CLEVBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3RGLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDdEIsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDO2dCQUNyQixPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU87Z0JBQ3hCLE1BQU0sRUFBRSxXQUFXO2dCQUNuQixTQUFTLEVBQUUsR0FBRyxDQUFDLFNBQVM7Z0JBQ3hCLFlBQVksRUFBRSxPQUFPLENBQUMsU0FBUztnQkFDL0IsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLO2dCQUNyQixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTthQUN0QixDQUFDLENBQUE7UUFDSixDQUFDO1FBRUQsUUFBUTtRQUNSLE1BQU0sUUFBUSxHQUFHLElBQUEseUNBQW9CLEVBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBQzVGLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDdEIsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDO2dCQUNyQixPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU87Z0JBQ3hCLE1BQU0sRUFBRSxjQUFjO2dCQUN0QixTQUFTLEVBQUUsR0FBRyxDQUFDLFlBQVk7Z0JBQzNCLFlBQVksRUFBRSxPQUFPLENBQUMsWUFBWTtnQkFDbEMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLO2dCQUNyQixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTthQUN0QixDQUFDLENBQUE7UUFDSixDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNLLEtBQUssQ0FBQyxXQUFXLENBQUMsS0FBcUI7UUFDN0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7UUFFdkIsYUFBYTtRQUNiLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDN0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQTtRQUNyQixDQUFDO1FBRUQsMkJBQTJCO1FBQzNCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNkLHlCQUF5QixLQUFLLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDLEtBQUssTUFBTSxLQUFLLENBQUMsWUFBWSxNQUFNLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FDckgsQ0FBQTtRQUVELHdCQUF3QjtJQUMxQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssS0FBSyxDQUFDLG9CQUFvQjtRQUNoQyxhQUFhO1FBQ2IsTUFBTSxXQUFXLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7UUFDakUsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNyRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQ3JELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFDckQsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFBO1FBRXJGLFFBQVE7UUFDUixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUV6RixPQUFPO1FBQ1AsTUFBTSxRQUFRLEdBQUcsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsQ0FBQTtRQUMzRCxNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQTtRQUUxRSxpQ0FBaUM7UUFDakMsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLENBQUEsQ0FBQyx3QkFBd0I7UUFFcEQsT0FBTztZQUNMLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ3JCLE9BQU8sRUFBRSxLQUFLLEVBQUUsWUFBWTtZQUM1QixZQUFZLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7WUFDcEMsU0FBUztZQUNULFlBQVksRUFBRSxJQUFJLEVBQUUsZ0JBQWdCO1lBQ3BDLFVBQVUsRUFBRSxJQUFJLENBQUMsWUFBWTtZQUM3QixNQUFNLEVBQUU7Z0JBQ04sUUFBUTtnQkFDUixXQUFXO2dCQUNYLGlCQUFpQjthQUNsQjtTQUNGLENBQUE7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssbUJBQW1CLENBQUMsV0FBcUIsRUFBRSxVQUFrQjtRQUNuRSxJQUFJLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQztZQUFFLE9BQU8sQ0FBQyxDQUFBO1FBRXRDLE1BQU0sS0FBSyxHQUFHLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUMzRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQy9CLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7UUFFOUIsSUFBSSxLQUFLLEtBQUssS0FBSyxFQUFFLENBQUM7WUFDcEIsT0FBTyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDM0IsQ0FBQztRQUVELE9BQU8sV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFBO0lBQ3pGLENBQUM7SUFFRDs7O09BR0c7SUFDSCxVQUFVLENBQUMsUUFBZ0IsQ0FBQztRQUMxQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFBO1FBQ2xELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLENBQUE7SUFDMUQsQ0FBQztJQUVEOzs7T0FHRztJQUNILFNBQVMsQ0FBQyxRQUFnQixFQUFFO1FBQzFCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUE7UUFDbEQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsSUFBSSxNQUFNLENBQUMsQ0FBQTtJQUN6RCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsYUFBYTtRQVFYLE1BQU0sT0FBTyxHQUFHLEVBQVMsQ0FBQTtRQUN6QixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLHVDQUFrQixDQUFDLElBQUksQ0FBMEIsQ0FBQTtRQUU5RSxLQUFLLE1BQU0sT0FBTyxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQy9CLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxLQUFLLE9BQU8sQ0FBQyxDQUFBO1lBQzdFLE1BQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFBO1lBRXRELElBQUksTUFBTSxFQUFFLENBQUM7Z0JBQ1gsTUFBTSxHQUFHLEdBQUcsSUFBQSxpQ0FBWSxFQUFDLE9BQU8sQ0FBQyxDQUFBO2dCQUNqQyxNQUFNLFFBQVEsR0FBRyxJQUFBLHlDQUFvQixFQUFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDdkYsTUFBTSxRQUFRLEdBQUcsSUFBQSx5Q0FBb0IsRUFBQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQTtnQkFFN0UsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHO29CQUNqQixNQUFNLEVBQUUsR0FBRztvQkFDWCxPQUFPLEVBQUU7d0JBQ1AsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZO3dCQUNqQyxTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVM7d0JBQzNCLFlBQVksRUFBRSxNQUFNLENBQUMsWUFBWTtxQkFDbEM7b0JBQ0QsTUFBTSxFQUFFLFFBQVEsQ0FBQyxPQUFPLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSztpQkFDMUUsQ0FBQTtZQUNILENBQUM7aUJBQU0sQ0FBQztnQkFDTixPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUc7b0JBQ2pCLE1BQU0sRUFBRSxJQUFBLGlDQUFZLEVBQUMsT0FBTyxDQUFDO29CQUM3QixPQUFPLEVBQUUsSUFBSTtvQkFDYixNQUFNLEVBQUUsU0FBa0I7aUJBQzNCLENBQUE7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFBO0lBQ2hCLENBQUM7SUFFRDs7O09BR0c7SUFDSCxhQUFhO1FBQ1gsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUE7UUFDckIsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUE7UUFDbkIsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUE7SUFDekIsQ0FBQztDQUNGLENBQUE7QUEvUFksOERBQXlCO0FBdUM5QjtJQURMLElBQUEsZUFBSSxFQUFDLHlCQUFjLENBQUMsWUFBWSxDQUFDOzs7d0RBQ1YsT0FBTyxvQkFBUCxPQUFPOytEQW1COUI7QUFPSztJQURMLElBQUEsZUFBSSxFQUFDLHlCQUFjLENBQUMsZUFBZSxDQUFDOzs7d0RBQ2tCLE9BQU8sb0JBQVAsT0FBTzttRUF5QzdEO29DQTFHVSx5QkFBeUI7SUFEckMsSUFBQSxtQkFBVSxHQUFFOztHQUNBLHlCQUF5QixDQStQckMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxvYnNlcnZhYmlsaXR5XFxwZXJmb3JtYW5jZS1tb25pdG9yLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8g5paH5Lu26Lev5b6EOiBwYWNrYWdlcy9jb21tb24tYmFja2VuZC9zcmMvb2JzZXJ2YWJpbGl0eS9wZXJmb3JtYW5jZS1tb25pdG9yLnNlcnZpY2UudHNcbi8vIOiBjOi0ozog5oCn6IO955uR5o6n5pyN5Yqh77yM5a6e546wU0xB5oyH5qCH5pS26ZuG5ZKM5ZGK6K2mXG5cbmltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJ1xuaW1wb3J0IHsgQ3JvbiwgQ3JvbkV4cHJlc3Npb24gfSBmcm9tICdAbmVzdGpzL3NjaGVkdWxlJ1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnXG5pbXBvcnQge1xuICBnZXRTTEFUYXJnZXQsXG4gIGlzUGVyZm9ybWFuY2VIZWFsdGh5LFxuICBQRVJGT1JNQU5DRV9DT05GSUcsXG4gIHR5cGUgU2VydmljZVNMQXMsXG59IGZyb20gJy4uL2NvbmZpZy9wZXJmb3JtYW5jZS1jb25maWcnXG5cbi8qKlxuICogQGludGVyZmFjZSBQZXJmb3JtYW5jZU1ldHJpY3NcbiAqIEBkZXNjcmlwdGlvbiDmgKfog73mjIfmoIfmlbDmja7nu5PmnoRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBQZXJmb3JtYW5jZU1ldHJpY3Mge1xuICB0aW1lc3RhbXA6IG51bWJlclxuICBzZXJ2aWNlOiBrZXlvZiBTZXJ2aWNlU0xBc1xuICByZXNwb25zZVRpbWU6IHtcbiAgICBwNTA6IG51bWJlclxuICAgIHA5NTogbnVtYmVyXG4gICAgcDk5OiBudW1iZXJcbiAgICBhdmc6IG51bWJlclxuICB9XG4gIGVycm9yUmF0ZTogbnVtYmVyXG4gIGF2YWlsYWJpbGl0eTogbnVtYmVyXG4gIHRocm91Z2hwdXQ6IG51bWJlclxuICBzeXN0ZW06IHtcbiAgICBjcHVVc2FnZTogbnVtYmVyXG4gICAgbWVtb3J5VXNhZ2U6IG51bWJlclxuICAgIGFjdGl2ZUNvbm5lY3Rpb25zOiBudW1iZXJcbiAgfVxufVxuXG4vKipcbiAqIEBpbnRlcmZhY2UgQWxlcnRDb25kaXRpb25cbiAqIEBkZXNjcmlwdGlvbiDlkYrorabmnaHku7ZcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBbGVydENvbmRpdGlvbiB7XG4gIHNlcnZpY2U6IGtleW9mIFNlcnZpY2VTTEFzXG4gIG1ldHJpYzogc3RyaW5nXG4gIHRocmVzaG9sZDogbnVtYmVyXG4gIGN1cnJlbnRWYWx1ZTogbnVtYmVyXG4gIGxldmVsOiAnd2FybmluZycgfCAnY3JpdGljYWwnIHwgJ2VtZXJnZW5jeScgfCAnaGVhbHRoeSdcbiAgdGltZXN0YW1wOiBudW1iZXJcbn1cblxuLyoqXG4gKiBAc2VydmljZSBQZXJmb3JtYW5jZU1vbml0b3JTZXJ2aWNlXG4gKiBAZGVzY3JpcHRpb24g5oCn6IO955uR5o6n5pyN5YqhXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQZXJmb3JtYW5jZU1vbml0b3JTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFBlcmZvcm1hbmNlTW9uaXRvclNlcnZpY2UubmFtZSlcblxuICAvLyDmjIfmoIflrZjlgqggKOWGheWtmOS4re+8jOeUn+S6p+eOr+Wig+W7uuiuruS9v+eUqFJlZGlz5oiW5pWw5o2u5bqTKVxuICBwcml2YXRlIHJlYWRvbmx5IG1ldHJpY3M6IFBlcmZvcm1hbmNlTWV0cmljc1tdID0gW11cbiAgcHJpdmF0ZSByZWFkb25seSBhbGVydHM6IEFsZXJ0Q29uZGl0aW9uW10gPSBbXVxuXG4gIC8vIOiuoeaVsOWZqFxuICBwcml2YXRlIHJlcXVlc3RDb3VudCA9IDBcbiAgcHJpdmF0ZSBlcnJvckNvdW50ID0gMFxuICBwcml2YXRlIHJlc3BvbnNlVGltZXM6IG51bWJlcltdID0gW11cblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmxvZ2dlci5sb2coJ1BlcmZvcm1hbmNlTW9uaXRvclNlcnZpY2UgaW5pdGlhbGl6ZWQgd2l0aCBTTEEgdGFyZ2V0cycpXG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCByZWNvcmRSZXF1ZXN0XG4gICAqIEBkZXNjcmlwdGlvbiDorrDlvZVBUEnor7fmsYJcbiAgICovXG4gIHJlY29yZFJlcXVlc3QoX3NlcnZpY2U6IGtleW9mIFNlcnZpY2VTTEFzLCByZXNwb25zZVRpbWU6IG51bWJlciwgaXNFcnJvciA9IGZhbHNlKTogdm9pZCB7XG4gICAgdGhpcy5yZXF1ZXN0Q291bnQrK1xuICAgIHRoaXMucmVzcG9uc2VUaW1lcy5wdXNoKHJlc3BvbnNlVGltZSlcblxuICAgIGlmIChpc0Vycm9yKSB7XG4gICAgICB0aGlzLmVycm9yQ291bnQrK1xuICAgIH1cblxuICAgIC8vIOS/neaMgeacgOi/kTEwMDDkuKrlk43lupTml7bpl7TnmoTorrDlvZVcbiAgICBpZiAodGhpcy5yZXNwb25zZVRpbWVzLmxlbmd0aCA+IDEwMDApIHtcbiAgICAgIHRoaXMucmVzcG9uc2VUaW1lcy5zaGlmdCgpXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgY29sbGVjdE1ldHJpY3NcbiAgICogQGRlc2NyaXB0aW9uIOaUtumbhuW9k+WJjeaAp+iDveaMh+agh1xuICAgKi9cbiAgQENyb24oQ3JvbkV4cHJlc3Npb24uRVZFUllfTUlOVVRFKVxuICBhc3luYyBjb2xsZWN0TWV0cmljcygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbWV0cmljcyA9IGF3YWl0IHRoaXMuZ2F0aGVyQ3VycmVudE1ldHJpY3MoKVxuICAgICAgdGhpcy5tZXRyaWNzLnB1c2gobWV0cmljcylcblxuICAgICAgLy8g5L+d5oyB5pyA6L+RMjTlsI/ml7bnmoTmlbDmja5cbiAgICAgIGNvbnN0IG9uZURheUFnbyA9IERhdGUubm93KCkgLSAyNCAqIDYwICogNjAgKiAxMDAwXG4gICAgICB0aGlzLm1ldHJpY3Muc3BsaWNlKFxuICAgICAgICAwLFxuICAgICAgICB0aGlzLm1ldHJpY3MuZmluZEluZGV4KChtKSA9PiBtLnRpbWVzdGFtcCA8IG9uZURheUFnbylcbiAgICAgIClcblxuICAgICAgLy8g5qOA5p+lU0xB5ZCI6KeE5oCnXG4gICAgICBhd2FpdCB0aGlzLmNoZWNrU0xBVmlvbGF0aW9ucyhtZXRyaWNzKVxuXG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgUGVyZm9ybWFuY2UgbWV0cmljcyBjb2xsZWN0ZWQ6ICR7SlNPTi5zdHJpbmdpZnkobWV0cmljcyl9YClcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBjb2xsZWN0IHBlcmZvcm1hbmNlIG1ldHJpY3M6JywgZXJyb3IpXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgY2hlY2tTTEFWaW9sYXRpb25zXG4gICAqIEBkZXNjcmlwdGlvbiDmo4Dmn6VTTEHov53op4RcbiAgICovXG4gIEBDcm9uKENyb25FeHByZXNzaW9uLkVWRVJZXzVfTUlOVVRFUylcbiAgYXN5bmMgY2hlY2tTTEFWaW9sYXRpb25zKG1ldHJpY3M6IFBlcmZvcm1hbmNlTWV0cmljcyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHNsYSA9IGdldFNMQVRhcmdldChtZXRyaWNzLnNlcnZpY2UpXG5cbiAgICAvLyDmo4Dmn6Xlk43lupTml7bpl7RcbiAgICBjb25zdCBydEhlYWx0aCA9IGlzUGVyZm9ybWFuY2VIZWFsdGh5KG1ldHJpY3Muc2VydmljZSwgJ3Jlc3BvbnNlVGltZScsIG1ldHJpY3MucmVzcG9uc2VUaW1lLnA5NSlcbiAgICBpZiAoIXJ0SGVhbHRoLmhlYWx0aHkpIHtcbiAgICAgIGF3YWl0IHRoaXMuY3JlYXRlQWxlcnQoe1xuICAgICAgICBzZXJ2aWNlOiBtZXRyaWNzLnNlcnZpY2UsXG4gICAgICAgIG1ldHJpYzogJ3Jlc3BvbnNlVGltZScsXG4gICAgICAgIHRocmVzaG9sZDogc2xhLnJlc3BvbnNlVGltZS5wOTUsXG4gICAgICAgIGN1cnJlbnRWYWx1ZTogbWV0cmljcy5yZXNwb25zZVRpbWUucDk1LFxuICAgICAgICBsZXZlbDogcnRIZWFsdGgubGV2ZWwsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgLy8g5qOA5p+l6ZSZ6K+v546HXG4gICAgY29uc3QgZXJIZWFsdGggPSBpc1BlcmZvcm1hbmNlSGVhbHRoeShtZXRyaWNzLnNlcnZpY2UsICdlcnJvclJhdGUnLCBtZXRyaWNzLmVycm9yUmF0ZSlcbiAgICBpZiAoIWVySGVhbHRoLmhlYWx0aHkpIHtcbiAgICAgIGF3YWl0IHRoaXMuY3JlYXRlQWxlcnQoe1xuICAgICAgICBzZXJ2aWNlOiBtZXRyaWNzLnNlcnZpY2UsXG4gICAgICAgIG1ldHJpYzogJ2Vycm9yUmF0ZScsXG4gICAgICAgIHRocmVzaG9sZDogc2xhLmVycm9yUmF0ZSxcbiAgICAgICAgY3VycmVudFZhbHVlOiBtZXRyaWNzLmVycm9yUmF0ZSxcbiAgICAgICAgbGV2ZWw6IGVySGVhbHRoLmxldmVsLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICB9KVxuICAgIH1cblxuICAgIC8vIOajgOafpeWPr+eUqOaAp1xuICAgIGNvbnN0IGF2SGVhbHRoID0gaXNQZXJmb3JtYW5jZUhlYWx0aHkobWV0cmljcy5zZXJ2aWNlLCAnYXZhaWxhYmlsaXR5JywgbWV0cmljcy5hdmFpbGFiaWxpdHkpXG4gICAgaWYgKCFhdkhlYWx0aC5oZWFsdGh5KSB7XG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZUFsZXJ0KHtcbiAgICAgICAgc2VydmljZTogbWV0cmljcy5zZXJ2aWNlLFxuICAgICAgICBtZXRyaWM6ICdhdmFpbGFiaWxpdHknLFxuICAgICAgICB0aHJlc2hvbGQ6IHNsYS5hdmFpbGFiaWxpdHksXG4gICAgICAgIGN1cnJlbnRWYWx1ZTogbWV0cmljcy5hdmFpbGFiaWxpdHksXG4gICAgICAgIGxldmVsOiBhdkhlYWx0aC5sZXZlbCxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBjcmVhdGVBbGVydFxuICAgKiBAZGVzY3JpcHRpb24g5Yib5bu65ZGK6K2mXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGNyZWF0ZUFsZXJ0KGFsZXJ0OiBBbGVydENvbmRpdGlvbik6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuYWxlcnRzLnB1c2goYWxlcnQpXG5cbiAgICAvLyDkv53mjIHmnIDov5ExMDDkuKrlkYroraZcbiAgICBpZiAodGhpcy5hbGVydHMubGVuZ3RoID4gMTAwKSB7XG4gICAgICB0aGlzLmFsZXJ0cy5zaGlmdCgpXG4gICAgfVxuXG4gICAgLy8g5Y+R6YCB5ZGK6K2m6YCa55+lICjov5nph4zlj6/ku6Xpm4bmiJDpgq7ku7bjgIFTbGFja+etiSlcbiAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgYPCfmqggUGVyZm9ybWFuY2UgQWxlcnQ6ICR7YWxlcnQuc2VydmljZX0gJHthbGVydC5tZXRyaWN9ICR7YWxlcnQubGV2ZWx9IC0gJHthbGVydC5jdXJyZW50VmFsdWV9ID4gJHthbGVydC50aHJlc2hvbGR9YFxuICAgIClcblxuICAgIC8vIFRPRE86IOmbhuaIkFNlbnRyeeaIluWFtuS7luWRiuitpuezu+e7n1xuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgZ2F0aGVyQ3VycmVudE1ldHJpY3NcbiAgICogQGRlc2NyaXB0aW9uIOaUtumbhuW9k+WJjeezu+e7n+aMh+agh1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnYXRoZXJDdXJyZW50TWV0cmljcygpOiBQcm9taXNlPFBlcmZvcm1hbmNlTWV0cmljcz4ge1xuICAgIC8vIOiuoeeul+WTjeW6lOaXtumXtOeZvuWIhuS9jeaVsFxuICAgIGNvbnN0IHNvcnRlZFRpbWVzID0gWy4uLnRoaXMucmVzcG9uc2VUaW1lc10uc29ydCgoYSwgYikgPT4gYSAtIGIpXG4gICAgY29uc3QgcDUwID0gdGhpcy5jYWxjdWxhdGVQZXJjZW50aWxlKHNvcnRlZFRpbWVzLCA1MClcbiAgICBjb25zdCBwOTUgPSB0aGlzLmNhbGN1bGF0ZVBlcmNlbnRpbGUoc29ydGVkVGltZXMsIDk1KVxuICAgIGNvbnN0IHA5OSA9IHRoaXMuY2FsY3VsYXRlUGVyY2VudGlsZShzb3J0ZWRUaW1lcywgOTkpXG4gICAgY29uc3QgYXZnID0gdGhpcy5yZXNwb25zZVRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gdGhpcy5yZXNwb25zZVRpbWVzLmxlbmd0aFxuXG4gICAgLy8g6K6h566X6ZSZ6K+v546HXG4gICAgY29uc3QgZXJyb3JSYXRlID0gdGhpcy5yZXF1ZXN0Q291bnQgPiAwID8gKHRoaXMuZXJyb3JDb3VudCAvIHRoaXMucmVxdWVzdENvdW50KSAqIDEwMCA6IDBcblxuICAgIC8vIOezu+e7n+aMh+agh1xuICAgIGNvbnN0IGNwdVVzYWdlID0gKG9zLmxvYWRhdmcoKVswXSAvIG9zLmNwdXMoKS5sZW5ndGgpICogMTAwXG4gICAgY29uc3QgbWVtb3J5VXNhZ2UgPSAoKG9zLnRvdGFsbWVtKCkgLSBvcy5mcmVlbWVtKCkpIC8gb3MudG90YWxtZW0oKSkgKiAxMDBcblxuICAgIC8vIOaooeaLn+a0u+i3g+i/nuaOpeaVsCAo55Sf5Lqn546v5aKD6ZyA6KaB5LuOV2ViU29ja2V0572R5YWz6I635Y+WKVxuICAgIGNvbnN0IGFjdGl2ZUNvbm5lY3Rpb25zID0gMCAvLyBUT0RPOiDpm4bmiJBXZWJTb2NrZXTov57mjqXorqHmlbBcblxuICAgIHJldHVybiB7XG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICBzZXJ2aWNlOiAnYXBpJywgLy8g6buY6K6k55uR5o6nQVBJ5pyN5YqhXG4gICAgICByZXNwb25zZVRpbWU6IHsgcDUwLCBwOTUsIHA5OSwgYXZnIH0sXG4gICAgICBlcnJvclJhdGUsXG4gICAgICBhdmFpbGFiaWxpdHk6IDk5LjksIC8vIFRPRE86IOiuoeeul+ecn+WunuWPr+eUqOaAp1xuICAgICAgdGhyb3VnaHB1dDogdGhpcy5yZXF1ZXN0Q291bnQsXG4gICAgICBzeXN0ZW06IHtcbiAgICAgICAgY3B1VXNhZ2UsXG4gICAgICAgIG1lbW9yeVVzYWdlLFxuICAgICAgICBhY3RpdmVDb25uZWN0aW9ucyxcbiAgICAgIH0sXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgY2FsY3VsYXRlUGVyY2VudGlsZVxuICAgKiBAZGVzY3JpcHRpb24g6K6h566X55m+5YiG5L2N5pWwXG4gICAqL1xuICBwcml2YXRlIGNhbGN1bGF0ZVBlcmNlbnRpbGUoc29ydGVkQXJyYXk6IG51bWJlcltdLCBwZXJjZW50aWxlOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGlmIChzb3J0ZWRBcnJheS5sZW5ndGggPT09IDApIHJldHVybiAwXG5cbiAgICBjb25zdCBpbmRleCA9IChwZXJjZW50aWxlIC8gMTAwKSAqIChzb3J0ZWRBcnJheS5sZW5ndGggLSAxKVxuICAgIGNvbnN0IGxvd2VyID0gTWF0aC5mbG9vcihpbmRleClcbiAgICBjb25zdCB1cHBlciA9IE1hdGguY2VpbChpbmRleClcblxuICAgIGlmIChsb3dlciA9PT0gdXBwZXIpIHtcbiAgICAgIHJldHVybiBzb3J0ZWRBcnJheVtsb3dlcl1cbiAgICB9XG5cbiAgICByZXR1cm4gc29ydGVkQXJyYXlbbG93ZXJdICsgKHNvcnRlZEFycmF5W3VwcGVyXSAtIHNvcnRlZEFycmF5W2xvd2VyXSkgKiAoaW5kZXggLSBsb3dlcilcbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGdldE1ldHJpY3NcbiAgICogQGRlc2NyaXB0aW9uIOiOt+WPluaAp+iDveaMh+agh1xuICAgKi9cbiAgZ2V0TWV0cmljcyhob3VyczogbnVtYmVyID0gMSk6IFBlcmZvcm1hbmNlTWV0cmljc1tdIHtcbiAgICBjb25zdCBjdXRvZmYgPSBEYXRlLm5vdygpIC0gaG91cnMgKiA2MCAqIDYwICogMTAwMFxuICAgIHJldHVybiB0aGlzLm1ldHJpY3MuZmlsdGVyKChtKSA9PiBtLnRpbWVzdGFtcCA+PSBjdXRvZmYpXG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBnZXRBbGVydHNcbiAgICogQGRlc2NyaXB0aW9uIOiOt+WPluWRiuitpuWIl+ihqFxuICAgKi9cbiAgZ2V0QWxlcnRzKGhvdXJzOiBudW1iZXIgPSAyNCk6IEFsZXJ0Q29uZGl0aW9uW10ge1xuICAgIGNvbnN0IGN1dG9mZiA9IERhdGUubm93KCkgLSBob3VycyAqIDYwICogNjAgKiAxMDAwXG4gICAgcmV0dXJuIHRoaXMuYWxlcnRzLmZpbHRlcigoYSkgPT4gYS50aW1lc3RhbXAgPj0gY3V0b2ZmKVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgZ2V0U0xBU3VtbWFyeVxuICAgKiBAZGVzY3JpcHRpb24g6I635Y+WU0xB5pGY6KaBXG4gICAqL1xuICBnZXRTTEFTdW1tYXJ5KCk6IFJlY29yZDxcbiAgICBrZXlvZiBTZXJ2aWNlU0xBcyxcbiAgICB7XG4gICAgICB0YXJnZXQ6IGFueVxuICAgICAgY3VycmVudDogYW55XG4gICAgICBzdGF0dXM6ICdoZWFsdGh5JyB8ICd3YXJuaW5nJyB8ICdjcml0aWNhbCcgfCAnZW1lcmdlbmN5J1xuICAgIH1cbiAgPiB7XG4gICAgY29uc3Qgc3VtbWFyeSA9IHt9IGFzIGFueVxuICAgIGNvbnN0IHNlcnZpY2VzID0gT2JqZWN0LmtleXMoUEVSRk9STUFOQ0VfQ09ORklHLnNsYXMpIGFzIChrZXlvZiBTZXJ2aWNlU0xBcylbXVxuXG4gICAgZm9yIChjb25zdCBzZXJ2aWNlIG9mIHNlcnZpY2VzKSB7XG4gICAgICBjb25zdCByZWNlbnRNZXRyaWNzID0gdGhpcy5nZXRNZXRyaWNzKDEpLmZpbHRlcigobSkgPT4gbS5zZXJ2aWNlID09PSBzZXJ2aWNlKVxuICAgICAgY29uc3QgbGF0ZXN0ID0gcmVjZW50TWV0cmljc1tyZWNlbnRNZXRyaWNzLmxlbmd0aCAtIDFdXG5cbiAgICAgIGlmIChsYXRlc3QpIHtcbiAgICAgICAgY29uc3Qgc2xhID0gZ2V0U0xBVGFyZ2V0KHNlcnZpY2UpXG4gICAgICAgIGNvbnN0IHJ0SGVhbHRoID0gaXNQZXJmb3JtYW5jZUhlYWx0aHkoc2VydmljZSwgJ3Jlc3BvbnNlVGltZScsIGxhdGVzdC5yZXNwb25zZVRpbWUucDk1KVxuICAgICAgICBjb25zdCBlckhlYWx0aCA9IGlzUGVyZm9ybWFuY2VIZWFsdGh5KHNlcnZpY2UsICdlcnJvclJhdGUnLCBsYXRlc3QuZXJyb3JSYXRlKVxuXG4gICAgICAgIHN1bW1hcnlbc2VydmljZV0gPSB7XG4gICAgICAgICAgdGFyZ2V0OiBzbGEsXG4gICAgICAgICAgY3VycmVudDoge1xuICAgICAgICAgICAgcmVzcG9uc2VUaW1lOiBsYXRlc3QucmVzcG9uc2VUaW1lLFxuICAgICAgICAgICAgZXJyb3JSYXRlOiBsYXRlc3QuZXJyb3JSYXRlLFxuICAgICAgICAgICAgYXZhaWxhYmlsaXR5OiBsYXRlc3QuYXZhaWxhYmlsaXR5LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc3RhdHVzOiBydEhlYWx0aC5oZWFsdGh5ICYmIGVySGVhbHRoLmhlYWx0aHkgPyAnaGVhbHRoeScgOiBydEhlYWx0aC5sZXZlbCxcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3VtbWFyeVtzZXJ2aWNlXSA9IHtcbiAgICAgICAgICB0YXJnZXQ6IGdldFNMQVRhcmdldChzZXJ2aWNlKSxcbiAgICAgICAgICBjdXJyZW50OiBudWxsLFxuICAgICAgICAgIHN0YXR1czogJ2hlYWx0aHknIGFzIGNvbnN0LFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1bW1hcnlcbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIHJlc2V0Q291bnRlcnNcbiAgICogQGRlc2NyaXB0aW9uIOmHjee9ruiuoeaVsOWZqCAo55So5LqO5rWL6K+VKVxuICAgKi9cbiAgcmVzZXRDb3VudGVycygpOiB2b2lkIHtcbiAgICB0aGlzLnJlcXVlc3RDb3VudCA9IDBcbiAgICB0aGlzLmVycm9yQ291bnQgPSAwXG4gICAgdGhpcy5yZXNwb25zZVRpbWVzID0gW11cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9