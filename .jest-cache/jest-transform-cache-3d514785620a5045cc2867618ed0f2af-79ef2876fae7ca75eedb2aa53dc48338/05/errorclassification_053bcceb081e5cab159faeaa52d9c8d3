835220bdae3d9c7134261cfbb2ba4146
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProcessingErrorType = void 0;
exports.classifyProcessingError = classifyProcessingError;
exports.shouldRetryError = shouldRetryError;
exports.getErrorMessage = getErrorMessage;
const zod_1 = require("zod");
const ai_exception_1 = require("../exceptions/ai-exception");
const prompt_injection_detected_exception_1 = require("./prompt-injection-detected.exception");
var ProcessingErrorType;
(function (ProcessingErrorType) {
    ProcessingErrorType["VALIDATION_ERROR"] = "VALIDATION_ERROR";
    ProcessingErrorType["AI_GENERATION_ERROR"] = "AI_GENERATION_ERROR";
    ProcessingErrorType["BUSINESS_LOGIC_ERROR"] = "BUSINESS_LOGIC_ERROR";
    ProcessingErrorType["NETWORK_ERROR"] = "NETWORK_ERROR";
    ProcessingErrorType["DATABASE_ERROR"] = "DATABASE_ERROR";
    ProcessingErrorType["UNKNOWN_ERROR"] = "UNKNOWN_ERROR";
})(ProcessingErrorType || (exports.ProcessingErrorType = ProcessingErrorType = {}));
function classifyProcessingError(error, context) {
    void context;
    if (error instanceof zod_1.ZodError) {
        return {
            errorType: ProcessingErrorType.VALIDATION_ERROR,
            retryable: false,
            errorCode: 'INVALID_MESSAGE_FORMAT',
            message: 'Message validation failed. The message format is incorrect.',
            details: error.issues,
            suggestedAction: 'Check the message format and resend with correct structure.',
        };
    }
    if (error instanceof prompt_injection_detected_exception_1.PromptInjectionDetectedException) {
        return {
            errorType: ProcessingErrorType.VALIDATION_ERROR,
            retryable: false,
            errorCode: 'PROMPT_INJECTION_DETECTED',
            message: 'Potential prompt injection detected. The input has been rejected.',
            details: error.details,
            suggestedAction: 'Revise the input to remove system override or malicious patterns before retrying.',
        };
    }
    if (error instanceof ai_exception_1.AiGenerationException) {
        return {
            errorType: ProcessingErrorType.AI_GENERATION_ERROR,
            retryable: true,
            errorCode: 'AI_GENERATION_FAILED',
            message: 'AI failed to generate valid output. The operation can be retried.',
            details: error.details,
            suggestedAction: 'Retry the operation. If the issue persists, check AI provider configuration.',
        };
    }
    if (error instanceof Error) {
        const errorMessage = error.message.toLowerCase();
        const errorName = error.name.toLowerCase();
        if (errorName.includes('network') ||
            errorMessage.includes('econnrefused') ||
            errorMessage.includes('etimedout') ||
            errorMessage.includes('enotfound') ||
            errorMessage.includes('socket') ||
            errorMessage.includes('timeout') ||
            errorMessage.includes('connection')) {
            return {
                errorType: ProcessingErrorType.NETWORK_ERROR,
                retryable: true,
                errorCode: 'NETWORK_CONNECTION_FAILED',
                message: 'Network connection failed. The operation can be retried.',
                details: error.message,
                suggestedAction: 'Retry the operation. Check network connectivity if the issue persists.',
            };
        }
        if (errorName.includes('prisma') ||
            errorMessage.includes('database') ||
            errorMessage.includes('connection') ||
            errorMessage.includes('query')) {
            return {
                errorType: ProcessingErrorType.DATABASE_ERROR,
                retryable: true,
                errorCode: 'DATABASE_OPERATION_FAILED',
                message: 'Database operation failed. The operation can be retried.',
                details: error.message,
                suggestedAction: 'Retry the operation. Check database connection if the issue persists.',
            };
        }
        if (errorName.includes('business') ||
            errorName.includes('logic') ||
            errorMessage.includes('business logic') ||
            errorMessage.includes('conflict') ||
            errorMessage.includes('duplicate')) {
            return {
                errorType: ProcessingErrorType.BUSINESS_LOGIC_ERROR,
                retryable: false,
                errorCode: 'BUSINESS_RULE_VIOLATION',
                message: 'Business logic validation failed. The operation cannot be retried.',
                details: error.message,
                suggestedAction: 'Review the request data and ensure it complies with business rules.',
            };
        }
    }
    return {
        errorType: ProcessingErrorType.UNKNOWN_ERROR,
        retryable: true,
        errorCode: 'UNKNOWN_ERROR',
        message: 'An unexpected error occurred. The operation can be retried.',
        details: error instanceof Error ? error.message : String(error),
        suggestedAction: 'Retry the operation. Contact support if the issue persists.',
    };
}
function shouldRetryError(error) {
    const classification = classifyProcessingError(error);
    return classification.retryable;
}
function getErrorMessage(error) {
    const classification = classifyProcessingError(error);
    return classification.message;
}
//# sourceMappingURL=error-classification.js.map