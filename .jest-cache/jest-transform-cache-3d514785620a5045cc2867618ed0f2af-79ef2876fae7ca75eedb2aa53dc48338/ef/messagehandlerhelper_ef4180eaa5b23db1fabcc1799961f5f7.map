{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\errors\\message-handler-helper.ts","mappings":";AAAA,qEAAqE;AACrE,uCAAuC;AACvC,EAAE;AACF,QAAQ;AACR,gBAAgB;AAChB,iBAAiB;AACjB,+BAA+B;AAC/B,oBAAoB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyEpB,8CAqHC;AAaD,sDAqBC;AA4BD,oDA6GC;AAtWD,qDAAsC;AAEtC,iEAAgE;AAChE,qEAAkE;AA0ClE;;;;;;;;;;;;;;;;;;;;;;;;GAwBG;AACH,SAAgB,iBAAiB,CAG/B,OAAmC,EACnC,MAAc,EACd,OAA+B,EAC/B,UAAiC,EAAE;IAEnC,MAAM,EACJ,UAAU,GAAG,CAAC,EACd,UAAU,GAAG,IAAI,EACjB,cAAc,GAAG,IAAI,EACrB,iBAAiB,GAAG,KAAK,EACzB,mBAAmB,EACnB,MAAM,EACN,cAAc,GAAG,mBAAmB,GACrC,GAAG,OAAO,CAAA;IAEX,OAAO,KAAK,EAAE,IAAO,EAAE,QAAiB,EAAE,OAAgB,EAAiC,EAAE;QAC3F,MAAM,aAAa,GAAG,OAAO,EAAE,aAAa,IAAI,IAAI,CAAC,aAAa,IAAI,SAAS,CAAA;QAC/E,MAAM,MAAM,GAAG,OAAO,EAAE,MAAM,IAAI,IAAI,CAAC,MAAM,IAAI,SAAS,CAAA;QAC1D,MAAM,SAAS,GAAG,OAAO,EAAE,SAAS,IAAI,iBAAiB,CAAA;QACzD,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;QAE5B,IAAI,CAAC;YACH,MAAM,OAAO,CAAC,IAAI,CAAC,CAAA;YACnB,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAA;YAEvC,MAAM,CAAC,GAAG,CACR,IAAI,aAAa,KAAK,SAAS,qCAAqC,MAAM,KAAK,QAAQ,KAAK,CAC7F,CAAA;YACD,OAAO,KAAK,CAAA;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,aAAa,GAAG,IAAA,8CAAuB,EAAC,KAAK,EAAE;gBACnD,SAAS;gBACT,MAAM;gBACN,MAAM,EAAE,OAAO,EAAE,MAAM,IAAI,IAAI,CAAC,MAAM;aACvC,CAAC,CAAA;YAEF,aAAa;YACb,IAAI,cAAc,EAAE,CAAC;gBACnB,MAAM,CAAC,gBAAgB,CAAC,KAAK,EAAE;oBAC7B,IAAI,EAAE;wBACJ,aAAa;wBACb,MAAM;wBACN,SAAS,EAAE,aAAa,CAAC,SAAS;wBAClC,SAAS,EAAE,aAAa,CAAC,SAAS;wBAClC,SAAS,EAAE,MAAM,CAAC,aAAa,CAAC,SAAS,CAAC;qBAC3C;oBACD,KAAK,EAAE;wBACL,OAAO,EAAE,IAAI;wBACb,YAAY,EAAE,aAAa,CAAC,OAAO;qBACpC;iBACF,CAAC,CAAA;YACJ,CAAC;YAED,SAAS;YACT,IAAI,UAAU,EAAE,CAAC;gBACf,MAAM,CAAC,KAAK,CACV,IAAI,aAAa,KAAK,SAAS,oBAAoB,MAAM,KAAK,aAAa,CAAC,OAAO,EAAE,EACrF,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,EAChD,aAAa,CAAC,OAAO,CACtB,CAAA;YACH,CAAC;iBAAM,CAAC;gBACN,MAAM,CAAC,KAAK,CAAC,IAAI,aAAa,KAAK,SAAS,YAAY,aAAa,CAAC,SAAS,EAAE,CAAC,CAAA;YACpF,CAAC;YAED,oCAAoC;YACpC,IAAI,iBAAiB,IAAI,mBAAmB,EAAE,CAAC;gBAC7C,MAAM,eAAe,GAAG,MAAM,IAAI,OAAO,EAAE,MAAM,IAAI,IAAI,CAAC,MAAM,CAAA;gBAChE,IAAI,eAAe,EAAE,CAAC;oBACpB,IAAI,CAAC;wBACH,MAAM,YAAY,GAAG,IAAA,gDAAuB,EAC1C,aAAa,EACb,aAAa,EACb,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe,CACzD,CAAA;wBACD,mBAAmB,CAAC;4BAClB,MAAM,EAAE,eAAe;4BACvB,KAAK,EAAE,cAAc;4BACrB,IAAI,EAAE,YAAY;yBACnB,CAAC,CAAA;wBACF,MAAM,CAAC,KAAK,CAAC,IAAI,aAAa,qCAAqC,cAAc,EAAE,CAAC,CAAA;oBACtF,CAAC;oBAAC,OAAO,UAAU,EAAE,CAAC;wBACpB,uBAAuB;wBACvB,MAAM,CAAC,IAAI,CACT,IAAI,aAAa,oCAAoC,UAAU,YAAY,KAAK,CAAC,CAAC,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,UAAU,CAAC,EAAE,CAC7H,CAAA;oBACH,CAAC;gBACH,CAAC;YACH,CAAC;YAED,eAAe;YACf,IAAI,CAAC,aAAa,CAAC,SAAS,EAAE,CAAC;gBAC7B,MAAM,CAAC,IAAI,CACT,IAAI,aAAa,6BAA6B,aAAa,CAAC,SAAS,wBAAwB,CAC9F,CAAA;gBACD,OAAO,MAAM,CAAA;YACf,CAAC;YAED,SAAS;YACT,MAAM,UAAU,GAAG,CAAC,OAAO,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC,CAAC,MAAM,CAAA;YAEzE,IAAI,UAAU,GAAG,UAAU,EAAE,CAAC;gBAC5B,MAAM,CAAC,IAAI,CACT,IAAI,aAAa,KAAK,SAAS,wBAAwB,UAAU,GAAG,CAAC,IAAI,UAAU,GAAG,CAAC,aAAa,aAAa,CAAC,SAAS,EAAE,CAC9H,CAAA;gBACD,OAAO,SAAS,CAAA;YAClB,CAAC;iBAAM,CAAC;gBACN,MAAM,CAAC,KAAK,CACV,IAAI,aAAa,KAAK,SAAS,iBAAiB,UAAU,GAAG,CAAC,qCAAqC,aAAa,CAAC,SAAS,EAAE,CAC7H,CAAA;gBACD,mBAAmB;gBACnB,OAAO,MAAM,CAAA;YACf,CAAC;QACH,CAAC;IACH,CAAC,CAAA;AACH,CAAC;AAED;;;;;;;;;;GAUG;AACI,KAAK,UAAU,qBAAqB,CAGzC,OAAmC,EACnC,OAAgB,EAChB,OAAgB,EAChB,MAAc,EACd,OAA+B,EAC/B,UAAiC,EAAE;IAEnC,MAAM,cAAc,GAAG,iBAAiB,CAAC,OAAO,EAAE,MAAM,EAAE,OAAO,EAAE,OAAO,CAAC,CAAA;IAC3E,MAAM,MAAM,GAAG,MAAM,cAAc,CAAC,OAAO,CAAC,OAAuB,EAAE,OAAO,EAAE,OAAO,CAAC,CAAA;IAEtF,wBAAwB;IACxB,IAAI,MAAM,KAAK,KAAK,EAAE,CAAC;QACrB,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAA;IACtB,CAAC;SAAM,IAAI,MAAM,KAAK,SAAS,EAAE,CAAC;QAChC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,CAAA,CAAC,UAAU;IAC/C,CAAC;SAAM,CAAC;QACN,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,EAAE,KAAK,CAAC,CAAA,CAAC,UAAU;IAChD,CAAC;AACH,CAAC;AAED;;;;;;;;;;;;;;;;;;;;;;;;;GAyBG;AACH,SAAgB,oBAAoB,CAGlC,OAAmC,EACnC,MAAc,EACd,OAA+B,EAC/B,UAAiC,EAAE;IAEnC,MAAM,EACJ,UAAU,EAAE,WAAW,GAAG,CAAC,EAAE,wDAAwD;IACrF,UAAU,GAAG,IAAI,EACjB,cAAc,GAAG,IAAI,EACrB,iBAAiB,GAAG,KAAK,EACzB,mBAAmB,EACnB,MAAM,EACN,cAAc,GAAG,mBAAmB,GACrC,GAAG,OAAO,CAAA;IAEX,OAAO,KAAK,EAAE,IAAO,EAAiC,EAAE;QACtD,MAAM,aAAa,GAAG,OAAO,EAAE,aAAa,IAAI,IAAI,CAAC,aAAa,IAAI,SAAS,CAAA;QAC/E,MAAM,MAAM,GAAG,OAAO,EAAE,MAAM,IAAI,IAAI,CAAC,MAAM,IAAI,SAAS,CAAA;QAC1D,MAAM,SAAS,GAAG,OAAO,EAAE,SAAS,IAAI,iBAAiB,CAAA;QACzD,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;QAE5B,IAAI,CAAC;YACH,MAAM,OAAO,CAAC,IAAI,CAAC,CAAA;YACnB,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAA;YAEvC,MAAM,CAAC,GAAG,CACR,IAAI,aAAa,KAAK,SAAS,qCAAqC,MAAM,KAAK,QAAQ,KAAK,CAC7F,CAAA;YACD,OAAO,KAAK,CAAA;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,MAAM,aAAa,GAAG,IAAA,8CAAuB,EAAC,KAAK,EAAE;gBACnD,SAAS;gBACT,MAAM;gBACN,MAAM,EAAE,OAAO,EAAE,MAAM,IAAI,IAAI,CAAC,MAAM;aACvC,CAAC,CAAA;YAEF,aAAa;YACb,IAAI,cAAc,EAAE,CAAC;gBACnB,MAAM,CAAC,gBAAgB,CAAC,KAAK,EAAE;oBAC7B,IAAI,EAAE;wBACJ,aAAa;wBACb,MAAM;wBACN,SAAS,EAAE,aAAa,CAAC,SAAS;wBAClC,SAAS,EAAE,aAAa,CAAC,SAAS;wBAClC,SAAS,EAAE,MAAM,CAAC,aAAa,CAAC,SAAS,CAAC;qBAC3C;oBACD,KAAK,EAAE;wBACL,OAAO,EAAE,IAAI;wBACb,YAAY,EAAE,aAAa,CAAC,OAAO;qBACpC;iBACF,CAAC,CAAA;YACJ,CAAC;YAED,SAAS;YACT,IAAI,UAAU,EAAE,CAAC;gBACf,MAAM,CAAC,KAAK,CACV,IAAI,aAAa,KAAK,SAAS,oBAAoB,MAAM,KAAK,aAAa,CAAC,OAAO,EAAE,EACrF,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,EAChD,aAAa,CAAC,OAAO,CACtB,CAAA;YACH,CAAC;iBAAM,CAAC;gBACN,MAAM,CAAC,KAAK,CAAC,IAAI,aAAa,KAAK,SAAS,YAAY,aAAa,CAAC,SAAS,EAAE,CAAC,CAAA;YACpF,CAAC;YAED,oCAAoC;YACpC,IAAI,iBAAiB,IAAI,mBAAmB,EAAE,CAAC;gBAC7C,MAAM,eAAe,GAAG,MAAM,IAAI,OAAO,EAAE,MAAM,IAAI,IAAI,CAAC,MAAM,CAAA;gBAChE,IAAI,eAAe,EAAE,CAAC;oBACpB,IAAI,CAAC;wBACH,MAAM,YAAY,GAAG,IAAA,gDAAuB,EAC1C,aAAa,EACb,aAAa,EACb,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe,CACzD,CAAA;wBACD,mBAAmB,CAAC;4BAClB,MAAM,EAAE,eAAe;4BACvB,KAAK,EAAE,cAAc;4BACrB,IAAI,EAAE,YAAY;yBACnB,CAAC,CAAA;wBACF,MAAM,CAAC,KAAK,CAAC,IAAI,aAAa,qCAAqC,cAAc,EAAE,CAAC,CAAA;oBACtF,CAAC;oBAAC,OAAO,UAAU,EAAE,CAAC;wBACpB,uBAAuB;wBACvB,MAAM,CAAC,IAAI,CACT,IAAI,aAAa,oCAAoC,UAAU,YAAY,KAAK,CAAC,CAAC,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,UAAU,CAAC,EAAE,CAC7H,CAAA;oBACH,CAAC;gBACH,CAAC;YACH,CAAC;YAED,eAAe;YACf,IAAI,CAAC,aAAa,CAAC,SAAS,EAAE,CAAC;gBAC7B,MAAM,CAAC,IAAI,CACT,IAAI,aAAa,6BAA6B,aAAa,CAAC,SAAS,wBAAwB,CAC9F,CAAA;gBACD,OAAO,MAAM,CAAA;YACf,CAAC;YAED,wCAAwC;YACxC,oCAAoC;YACpC,wCAAwC;YACxC,MAAM,CAAC,IAAI,CACT,IAAI,aAAa,KAAK,SAAS,iDAAiD,aAAa,CAAC,SAAS,EAAE,CAC1G,CAAA;YACD,OAAO,SAAS,CAAA;QAClB,CAAC;IACH,CAAC,CAAA;AACH,CAAC","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\errors\\message-handler-helper.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/errors/message-handler-helper.ts\n// 职责: 提供 RabbitMQ 消息处理辅助函数，统一错误处理和重试逻辑\n//\n// 核心功能:\n// 1. 统一的错误处理包装器\n// 2. 自动错误分类和重试决策\n// 3. 返回正确的 ack/nack/requeue 响应\n// 4. 集成 Sentry 错误上报\n\nimport type { Logger } from '@nestjs/common'\nimport * as Sentry from '@sentry/node'\nimport type { Channel, Message } from 'amqplib'\nimport { classifyProcessingError } from './error-classification'\nimport { formatErrorForWebSocket } from './websocket-error-helper'\n\n/**\n * 消息处理结果\n */\nexport type MessageHandlerResult = 'ack' | 'nack' | 'requeue'\n\n/**\n * 消息处理上下文\n */\nexport interface MessageHandlerContext {\n  correlationId?: string\n  gameId?: string\n  userId?: string\n  operation?: string\n}\n\n/**\n * 消息处理选项\n */\nexport interface MessageHandlerOptions {\n  /** 最大重试次数（默认 2） */\n  maxRetries?: number\n  /** 是否记录详细错误日志（默认 true） */\n  logDetails?: boolean\n  /** 是否上报到 Sentry（默认 true） */\n  reportToSentry?: boolean\n  /** 错误时是否发布 WebSocket 错误事件（默认 false） */\n  publishErrorEvent?: boolean\n  /** 错误事件发布器（仅在 publishErrorEvent=true 时使用） */\n  errorEventPublisher?: (errorPayload: unknown) => void\n  /** 用户ID（用于错误事件，仅在 publishErrorEvent=true 时使用） */\n  userId?: string\n  /** 错误事件名称（默认 'processing_failed'） */\n  errorEventName?: string\n  /** Metrics 服务实例（可选，用于记录性能指标） */\n  /** 服务名称（用于指标标签，例如 'logic-agent'） */\n  serviceName?: string\n  /** 队列名称（用于指标标签） */\n  queueName?: string\n}\n\n/**\n * 包装消息处理函数，提供统一的错误处理\n *\n * @param handler - 消息处理函数\n * @param logger - Logger 实例\n * @param context - 消息上下文\n * @param options - 处理选项\n * @returns 包装后的处理函数，返回 'ack' | 'nack' | 'requeue'\n *\n * @remarks\n * 使用示例：\n * ```typescript\n * const wrappedHandler = withErrorHandling(\n *   async (data) => {\n *     await this.service.process(data);\n *   },\n *   this.logger,\n *   { correlationId: data.correlationId, gameId: data.gameId },\n *   { maxRetries: 2 }\n * );\n *\n * const result = await wrappedHandler(data);\n * // result 是 'ack' | 'nack' | 'requeue'\n * ```\n */\nexport function withErrorHandling<\n  T extends { correlationId?: string; gameId?: string; userId?: string },\n>(\n  handler: (data: T) => Promise<void>,\n  logger: Logger,\n  context?: MessageHandlerContext,\n  options: MessageHandlerOptions = {}\n): (data: T, channel: Channel, message: Message) => Promise<MessageHandlerResult> {\n  const {\n    maxRetries = 2,\n    logDetails = true,\n    reportToSentry = true,\n    publishErrorEvent = false,\n    errorEventPublisher,\n    userId,\n    errorEventName = 'processing_failed',\n  } = options\n\n  return async (data: T, _channel: Channel, message: Message): Promise<MessageHandlerResult> => {\n    const correlationId = context?.correlationId || data.correlationId || 'unknown'\n    const gameId = context?.gameId || data.gameId || 'unknown'\n    const operation = context?.operation || 'process_message'\n    const startTime = Date.now()\n\n    try {\n      await handler(data)\n      const duration = Date.now() - startTime\n\n      logger.log(\n        `[${correlationId}] ${operation} completed successfully for game: ${gameId} (${duration}ms)`\n      )\n      return 'ack'\n    } catch (error) {\n      const errorResponse = classifyProcessingError(error, {\n        operation,\n        gameId,\n        userId: context?.userId || data.userId,\n      })\n\n      // 上报到 Sentry\n      if (reportToSentry) {\n        Sentry.captureException(error, {\n          tags: {\n            correlationId,\n            gameId,\n            errorType: errorResponse.errorType,\n            errorCode: errorResponse.errorCode,\n            retryable: String(errorResponse.retryable),\n          },\n          extra: {\n            jobData: data,\n            errorDetails: errorResponse.details,\n          },\n        })\n      }\n\n      // 记录错误日志\n      if (logDetails) {\n        logger.error(\n          `[${correlationId}] ${operation} failed for game ${gameId}: ${errorResponse.message}`,\n          error instanceof Error ? error.stack : undefined,\n          errorResponse.details\n        )\n      } else {\n        logger.error(`[${correlationId}] ${operation} failed: ${errorResponse.errorCode}`)\n      }\n\n      // [核心新增] 发布增强的错误事件到 WebSocket（如果启用）\n      if (publishErrorEvent && errorEventPublisher) {\n        const effectiveUserId = userId || context?.userId || data.userId\n        if (effectiveUserId) {\n          try {\n            const errorPayload = formatErrorForWebSocket(\n              errorResponse,\n              correlationId,\n              error instanceof Error ? error.message : 'Unknown error'\n            )\n            errorEventPublisher({\n              userId: effectiveUserId,\n              event: errorEventName,\n              data: errorPayload,\n            })\n            logger.debug(`[${correlationId}] Published enhanced error event: ${errorEventName}`)\n          } catch (eventError) {\n            // 错误事件发布失败不应影响主要错误处理流程\n            logger.warn(\n              `[${correlationId}] Failed to publish error event: ${eventError instanceof Error ? eventError.message : String(eventError)}`\n            )\n          }\n        }\n      }\n\n      // 不可重试的错误，直接丢弃\n      if (!errorResponse.retryable) {\n        logger.warn(\n          `[${correlationId}] Error is not retryable (${errorResponse.errorType}). Discarding message.`\n        )\n        return 'nack'\n      }\n\n      // 检查重试次数\n      const retryCount = (message.properties.headers?.['x-death'] || []).length\n\n      if (retryCount < maxRetries) {\n        logger.warn(\n          `[${correlationId}] ${operation} failed. Will retry (${retryCount + 1}/${maxRetries + 1}). Error: ${errorResponse.errorCode}`\n        )\n        return 'requeue'\n      } else {\n        logger.error(\n          `[${correlationId}] ${operation} failed after ${maxRetries + 1} attempts. Sending to DLQ. Error: ${errorResponse.errorCode}`\n        )\n        // 超过最大重试次数，发送到死信队列\n        return 'nack'\n      }\n    }\n  }\n}\n\n/**\n * 处理 RabbitMQ 消息并返回正确的响应\n * 用于使用 @nestjs/microservices 的场景（手动管理 channel）\n *\n * @param handler - 消息处理函数\n * @param channel - RabbitMQ Channel\n * @param message - RabbitMQ Message\n * @param logger - Logger 实例\n * @param context - 消息上下文\n * @param options - 处理选项\n */\nexport async function handleRabbitMQMessage<\n  T extends { correlationId?: string; gameId?: string; userId?: string },\n>(\n  handler: (data: T) => Promise<void>,\n  channel: Channel,\n  message: Message,\n  logger: Logger,\n  context?: MessageHandlerContext,\n  options: MessageHandlerOptions = {}\n): Promise<void> {\n  const wrappedHandler = withErrorHandling(handler, logger, context, options)\n  const result = await wrappedHandler(message.content as unknown as T, channel, message)\n\n  // 根据结果执行相应的 RabbitMQ 操作\n  if (result === 'ack') {\n    channel.ack(message)\n  } else if (result === 'requeue') {\n    channel.nack(message, false, true) // requeue\n  } else {\n    channel.nack(message, false, false) // 发送到 DLQ\n  }\n}\n\n/**\n * 处理 nestjs-rmq 消息处理器的返回值\n * 用于使用 @RMQRoute 的场景（自动管理 ack/nack）\n *\n * @param handler - 消息处理函数\n * @param logger - Logger 实例\n * @param context - 消息上下文\n * @param options - 处理选项\n * @returns 包装后的处理函数，返回 'ack' | 'nack' | 'requeue'\n *\n * @remarks\n * 使用示例：\n * ```typescript\n * @RMQRoute('action.player.submitted', {...})\n * public async handlePlayerAction(data: GameActionJobData): Promise<'ack' | 'nack' | 'requeue'> {\n *   return withRMQErrorHandling(\n *     async () => {\n *       await this.service.process(data);\n *     },\n *     this.logger,\n *     { correlationId: data.correlationId, gameId: data.gameId },\n *     { maxRetries: 2 }\n *   );\n * }\n * ```\n */\nexport function withRMQErrorHandling<\n  T extends { correlationId?: string; gameId?: string; userId?: string },\n>(\n  handler: (data: T) => Promise<void>,\n  logger: Logger,\n  context?: MessageHandlerContext,\n  options: MessageHandlerOptions = {}\n): (data: T) => Promise<MessageHandlerResult> {\n  const {\n    maxRetries: _maxRetries = 2, // eslint-disable-line @typescript-eslint/no-unused-vars\n    logDetails = true,\n    reportToSentry = true,\n    publishErrorEvent = false,\n    errorEventPublisher,\n    userId,\n    errorEventName = 'processing_failed',\n  } = options\n\n  return async (data: T): Promise<MessageHandlerResult> => {\n    const correlationId = context?.correlationId || data.correlationId || 'unknown'\n    const gameId = context?.gameId || data.gameId || 'unknown'\n    const operation = context?.operation || 'process_message'\n    const startTime = Date.now()\n\n    try {\n      await handler(data)\n      const duration = Date.now() - startTime\n\n      logger.log(\n        `[${correlationId}] ${operation} completed successfully for game: ${gameId} (${duration}ms)`\n      )\n      return 'ack'\n    } catch (error) {\n      const errorResponse = classifyProcessingError(error, {\n        operation,\n        gameId,\n        userId: context?.userId || data.userId,\n      })\n\n      // 上报到 Sentry\n      if (reportToSentry) {\n        Sentry.captureException(error, {\n          tags: {\n            correlationId,\n            gameId,\n            errorType: errorResponse.errorType,\n            errorCode: errorResponse.errorCode,\n            retryable: String(errorResponse.retryable),\n          },\n          extra: {\n            jobData: data,\n            errorDetails: errorResponse.details,\n          },\n        })\n      }\n\n      // 记录错误日志\n      if (logDetails) {\n        logger.error(\n          `[${correlationId}] ${operation} failed for game ${gameId}: ${errorResponse.message}`,\n          error instanceof Error ? error.stack : undefined,\n          errorResponse.details\n        )\n      } else {\n        logger.error(`[${correlationId}] ${operation} failed: ${errorResponse.errorCode}`)\n      }\n\n      // [核心新增] 发布增强的错误事件到 WebSocket（如果启用）\n      if (publishErrorEvent && errorEventPublisher) {\n        const effectiveUserId = userId || context?.userId || data.userId\n        if (effectiveUserId) {\n          try {\n            const errorPayload = formatErrorForWebSocket(\n              errorResponse,\n              correlationId,\n              error instanceof Error ? error.message : 'Unknown error'\n            )\n            errorEventPublisher({\n              userId: effectiveUserId,\n              event: errorEventName,\n              data: errorPayload,\n            })\n            logger.debug(`[${correlationId}] Published enhanced error event: ${errorEventName}`)\n          } catch (eventError) {\n            // 错误事件发布失败不应影响主要错误处理流程\n            logger.warn(\n              `[${correlationId}] Failed to publish error event: ${eventError instanceof Error ? eventError.message : String(eventError)}`\n            )\n          }\n        }\n      }\n\n      // 不可重试的错误，直接丢弃\n      if (!errorResponse.retryable) {\n        logger.warn(\n          `[${correlationId}] Error is not retryable (${errorResponse.errorType}). Discarding message.`\n        )\n        return 'nack'\n      }\n\n      // 注意：在 nestjs-rmq 中，重试次数由 RabbitMQ 配置管理\n      // 我们只需要返回 'requeue'，让 RabbitMQ 处理重试\n      // maxRetries 参数在这里不适用，因为重试由 RabbitMQ 管理\n      logger.warn(\n        `[${correlationId}] ${operation} failed. Will be requeued by RabbitMQ. Error: ${errorResponse.errorCode}`\n      )\n      return 'requeue'\n    }\n  }\n}\n"],"version":3}