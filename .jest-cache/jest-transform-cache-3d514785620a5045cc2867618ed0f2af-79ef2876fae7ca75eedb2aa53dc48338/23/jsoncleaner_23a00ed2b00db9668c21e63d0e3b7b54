2e08caa453736cdcd71a0bad44485435
"use strict";
// 文件路径: packages/common-backend/src/ai/json-cleaner.ts
// 职责: 尝试修复并解析可能不规范的 AI JSON 输出
//
// 背景:
// AI 模型（特别是 LLM）在输出 JSON 时经常会出现以下问题：
// - 包裹在 Markdown 代码块中（```json ... ```）
// - 包含 JSON 不支持的单引号或注释
// - 缺少逗号或括号不匹配
// - 前后包含说明文字
//
// 本模块提供自动修复功能，尝试多种策略将"脏 JSON"转换为有效的 JSON 对象或数组。
//
// 修复策略（按优先级）:
// 1. 直接解析（最快的路径）
// 2. 使用 jsonrepair 库修复常见语法错误
// 3. 先修复引号再使用 jsonrepair
// 4. 仅修复引号
//
// 限制:
// - 只接受 JSON 对象或数组，不接受原始值（null, string, number, boolean）
// - 如果所有策略都失败，会抛出 JsonSanitizationError
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.JsonSanitizationError = void 0;
exports.cleanAndParseJson = cleanAndParseJson;
// 动态导入以避免CommonJS/ESM问题
/**
 * JSON 清理错误
 * 当无法将输入字符串修复为有效 JSON 时抛出
 *
 * @property context - 包含原始输入和最后一次尝试的错误信息
 */
class JsonSanitizationError extends Error {
    context;
    constructor(message, context) {
        super(message);
        this.context = context;
        this.name = 'JsonSanitizationError';
    }
}
exports.JsonSanitizationError = JsonSanitizationError;
/**
 * 类型守卫：检查值是否为可接受的 JSON 结构（对象或数组）
 *
 * @param value - 要检查的值
 * @returns 如果是对象或数组返回 true，否则返回 false
 *
 * @remarks
 * 我们只接受对象和数组，不接受原始值（null, string, number, boolean）
 * 这是因为 AI 输出通常是结构化的数据，而不是单个值
 */
function isAcceptableJsonValue(value) {
    // null 的类型是 'object'，需要显式排除
    if (value === null) {
        return false;
    }
    // 数组是可接受的
    if (Array.isArray(value)) {
        return true;
    }
    // 对象（但不是 null）是可接受的
    return typeof value === 'object';
}
/**
 * 移除 Markdown 代码块包裹，如 ```json ... ```
 */
function stripCodeFences(raw) {
    let result = raw.trim();
    if (result.startsWith('```')) {
        // 移除开头的 ``` 或 ```json
        result = result.replace(/^```[a-zA-Z]*\s*/i, '');
    }
    if (result.endsWith('```')) {
        result = result.replace(/```$/i, '');
    }
    return result.trim();
}
/**
 * 尝试提取字符串中的 JSON 主体（去掉说明文字、前后缀）。
 */
function extractJsonCore(raw) {
    const firstBrace = raw.indexOf('{');
    const firstBracket = raw.indexOf('[');
    let start = -1;
    if (firstBrace !== -1 && firstBracket !== -1) {
        start = Math.min(firstBrace, firstBracket);
    }
    else {
        start = Math.max(firstBrace, firstBracket);
    }
    if (start === -1) {
        return raw;
    }
    const lastBrace = raw.lastIndexOf('}');
    const lastBracket = raw.lastIndexOf(']');
    const endCandidates = [lastBrace, lastBracket].filter((index) => index !== -1);
    const end = endCandidates.length > 0 ? Math.max(...endCandidates) : raw.length - 1;
    if (end <= start) {
        return raw.slice(start);
    }
    return raw.slice(start, end + 1);
}
/**
 * 尝试替换常见的单引号 JSON 格式为双引号。
 */
function normalizeQuotes(raw) {
    const hasDoubleQuotes = raw.includes('"');
    const hasSingleQuotes = raw.includes("'");
    if (!hasDoubleQuotes && hasSingleQuotes) {
        return raw.replace(/'/g, '"');
    }
    return raw;
}
/**
 * 清理并解析 JSON 字符串
 *
 * @param raw - 可能是"脏"的 JSON 字符串，或已经是对象/数组的值
 * @returns 解析后的 JSON 对象或数组
 * @throws {JsonSanitizationError} 如果无法修复为有效 JSON
 *
 * @remarks
 * 修复流程：
 * 1. 如果不是字符串，直接返回（可能已经是解析过的对象）
 * 2. 移除 Markdown 代码块包裹
 * 3. 提取 JSON 核心部分（去掉前后说明文字）
 * 4. 尝试多种修复策略：
 *    a. 直接解析（最快的路径）
 *    b. 使用 jsonrepair 修复语法错误
 *    c. 先修复引号再使用 jsonrepair
 *    d. 仅修复引号
 * 5. 验证结果是对象或数组（不接受原始值）
 * 6. 如果所有策略都失败，抛出错误
 *
 * @example
 * ```typescript
 * // 处理包裹在 Markdown 中的 JSON
 * const result = cleanAndParseJson('```json\n{"key": "value"}\n```');
 * // => { key: "value" }
 *
 * // 处理单引号 JSON
 * const result2 = cleanAndParseJson("{'status': 'ok'}");
 * // => { status: "ok" }
 *
 * // 处理包含注释的 JSON
 * const result3 = cleanAndParseJson('{"name": "test", // comment\n}');
 * // => { name: "test" }
 * ```
 */
async function cleanAndParseJson(raw) {
    // 如果已经是对象或数组，直接返回（避免不必要的处理）
    if (typeof raw !== 'string') {
        return raw;
    }
    // 步骤 1: 移除 Markdown 代码块包裹
    let working = stripCodeFences(raw);
    // 步骤 2: 提取 JSON 核心部分（去掉前后说明文字）
    working = extractJsonCore(working);
    // 步骤 3: 去除首尾空白
    working = working.trim();
    // 步骤 4: 按优先级尝试多种修复策略
    // 从最快到最慢，从简单到复杂
    const attempts = [
        // 策略 1: 直接解析（最快的路径，适用于已经是有效 JSON 的情况）
        () => JSON.parse(working),
        // 策略 2: 使用 jsonrepair 修复常见语法错误（如缺少逗号、括号不匹配等）
        async () => {
            try {
                const { jsonrepair } = await Promise.resolve().then(() => __importStar(require('jsonrepair')));
                const repaired = jsonrepair(working);
                console.log('jsonrepair input:', JSON.stringify(working));
                console.log('jsonrepair output:', JSON.stringify(repaired));
                return JSON.parse(repaired);
            }
            catch (error) {
                console.log('jsonrepair strategy failed:', error);
                // 如果jsonrepair不可用，跳过此策略，让下一个策略尝试
                return undefined;
            }
        },
        // 策略 3: 先修复引号再使用 jsonrepair（处理单引号 JSON）
        async () => {
            try {
                const { jsonrepair } = await Promise.resolve().then(() => __importStar(require('jsonrepair')));
                return JSON.parse(jsonrepair(normalizeQuotes(working)));
            }
            catch {
                // 如果jsonrepair不可用，跳过此策略，让下一个策略尝试
                return undefined;
            }
        },
        // 策略 4: 仅修复引号（如果 jsonrepair 也不起作用）
        () => JSON.parse(normalizeQuotes(working)),
    ];
    let lastError;
    for (const attempt of attempts) {
        try {
            const parsed = await attempt();
            // 如果策略返回undefined，跳过此策略
            if (parsed === undefined) {
                continue;
            }
            // 验证结果是对象或数组（不接受原始值）
            if (isAcceptableJsonValue(parsed)) {
                return parsed;
            }
            // 如果解析成功但不是对象/数组，记录错误但继续尝试其他策略
            lastError = new Error('Sanitized output was not a JSON object or array.');
        }
        catch (error) {
            // 解析失败，记录错误并尝试下一个策略
            lastError = error;
            // 调试输出
            console.log(`Strategy failed:`, error);
        }
    }
    // 所有策略都失败，抛出详细的错误信息
    throw new JsonSanitizationError('Failed to sanitize AI output into valid JSON.', {
        raw,
        lastError,
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxhaVxcanNvbi1jbGVhbmVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQSx1REFBdUQ7QUFDdkQsK0JBQStCO0FBQy9CLEVBQUU7QUFDRixNQUFNO0FBQ04scUNBQXFDO0FBQ3JDLHVDQUF1QztBQUN2Qyx1QkFBdUI7QUFDdkIsZUFBZTtBQUNmLGFBQWE7QUFDYixFQUFFO0FBQ0YsZ0RBQWdEO0FBQ2hELEVBQUU7QUFDRixjQUFjO0FBQ2QsaUJBQWlCO0FBQ2pCLDZCQUE2QjtBQUM3Qix5QkFBeUI7QUFDekIsV0FBVztBQUNYLEVBQUU7QUFDRixNQUFNO0FBQ04seURBQXlEO0FBQ3pELHdDQUF3Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBMkl4Qyw4Q0F5RUM7QUFsTkQsd0JBQXdCO0FBRXhCOzs7OztHQUtHO0FBQ0gsTUFBYSxxQkFBc0IsU0FBUSxLQUFLO0lBRzVCO0lBRmxCLFlBQ0UsT0FBZSxFQUNDLE9BQThDO1FBRTlELEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUZFLFlBQU8sR0FBUCxPQUFPLENBQXVDO1FBRzlELElBQUksQ0FBQyxJQUFJLEdBQUcsdUJBQXVCLENBQUE7SUFDckMsQ0FBQztDQUNGO0FBUkQsc0RBUUM7QUFFRDs7Ozs7Ozs7O0dBU0c7QUFDSCxTQUFTLHFCQUFxQixDQUFDLEtBQWM7SUFDM0MsNEJBQTRCO0lBQzVCLElBQUksS0FBSyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ25CLE9BQU8sS0FBSyxDQUFBO0lBQ2QsQ0FBQztJQUNELFVBQVU7SUFDVixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUN6QixPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFDRCxvQkFBb0I7SUFDcEIsT0FBTyxPQUFPLEtBQUssS0FBSyxRQUFRLENBQUE7QUFDbEMsQ0FBQztBQUVEOztHQUVHO0FBQ0gs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XHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFxhaVxcanNvbi1jbGVhbmVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL2FpL2pzb24tY2xlYW5lci50c1xuLy8g6IGM6LSjOiDlsJ3or5Xkv67lpI3lubbop6PmnpDlj6/og73kuI3op4TojIPnmoQgQUkgSlNPTiDovpPlh7pcbi8vXG4vLyDog4zmma86XG4vLyBBSSDmqKHlnovvvIjnibnliKvmmK8gTExN77yJ5Zyo6L6T5Ye6IEpTT04g5pe257uP5bi45Lya5Ye6546w5Lul5LiL6Zeu6aKY77yaXG4vLyAtIOWMheijueWcqCBNYXJrZG93biDku6PnoIHlnZfkuK3vvIhgYGBqc29uIC4uLiBgYGDvvIlcbi8vIC0g5YyF5ZCrIEpTT04g5LiN5pSv5oyB55qE5Y2V5byV5Y+35oiW5rOo6YeKXG4vLyAtIOe8uuWwkemAl+WPt+aIluaLrOWPt+S4jeWMuemFjVxuLy8gLSDliY3lkI7ljIXlkKvor7TmmI7mloflrZdcbi8vXG4vLyDmnKzmqKHlnZfmj5Dkvpvoh6rliqjkv67lpI3lip/og73vvIzlsJ3or5XlpJrnp43nrZbnlaXlsIZcIuiEjyBKU09OXCLovazmjaLkuLrmnInmlYjnmoQgSlNPTiDlr7nosaHmiJbmlbDnu4TjgIJcbi8vXG4vLyDkv67lpI3nrZbnlaXvvIjmjInkvJjlhYjnuqfvvIk6XG4vLyAxLiDnm7TmjqXop6PmnpDvvIjmnIDlv6vnmoTot6/lvoTvvIlcbi8vIDIuIOS9v+eUqCBqc29ucmVwYWlyIOW6k+S/ruWkjeW4uOingeivreazlemUmeivr1xuLy8gMy4g5YWI5L+u5aSN5byV5Y+35YaN5L2/55SoIGpzb25yZXBhaXJcbi8vIDQuIOS7heS/ruWkjeW8leWPt1xuLy9cbi8vIOmZkOWItjpcbi8vIC0g5Y+q5o6l5Y+XIEpTT04g5a+56LGh5oiW5pWw57uE77yM5LiN5o6l5Y+X5Y6f5aeL5YC877yIbnVsbCwgc3RyaW5nLCBudW1iZXIsIGJvb2xlYW7vvIlcbi8vIC0g5aaC5p6c5omA5pyJ562W55Wl6YO95aSx6LSl77yM5Lya5oqb5Ye6IEpzb25TYW5pdGl6YXRpb25FcnJvclxuXG4vLyDliqjmgIHlr7zlhaXku6Xpgb/lhY1Db21tb25KUy9FU03pl67pophcblxuLyoqXG4gKiBKU09OIOa4heeQhumUmeivr1xuICog5b2T5peg5rOV5bCG6L6T5YWl5a2X56ym5Liy5L+u5aSN5Li65pyJ5pWIIEpTT04g5pe25oqb5Ye6XG4gKlxuICogQHByb3BlcnR5IGNvbnRleHQgLSDljIXlkKvljp/lp4vovpPlhaXlkozmnIDlkI7kuIDmrKHlsJ3or5XnmoTplJnor6/kv6Hmga9cbiAqL1xuZXhwb3J0IGNsYXNzIEpzb25TYW5pdGl6YXRpb25FcnJvciBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3IoXG4gICAgbWVzc2FnZTogc3RyaW5nLFxuICAgIHB1YmxpYyByZWFkb25seSBjb250ZXh0PzogeyByYXc6IHN0cmluZzsgbGFzdEVycm9yPzogdW5rbm93biB9XG4gICkge1xuICAgIHN1cGVyKG1lc3NhZ2UpXG4gICAgdGhpcy5uYW1lID0gJ0pzb25TYW5pdGl6YXRpb25FcnJvcidcbiAgfVxufVxuXG4vKipcbiAqIOexu+Wei+WuiOWNq++8muajgOafpeWAvOaYr+WQpuS4uuWPr+aOpeWPl+eahCBKU09OIOe7k+aehO+8iOWvueixoeaIluaVsOe7hO+8iVxuICpcbiAqIEBwYXJhbSB2YWx1ZSAtIOimgeajgOafpeeahOWAvFxuICogQHJldHVybnMg5aaC5p6c5piv5a+56LGh5oiW5pWw57uE6L+U5ZueIHRydWXvvIzlkKbliJnov5Tlm54gZmFsc2VcbiAqXG4gKiBAcmVtYXJrc1xuICog5oiR5Lus5Y+q5o6l5Y+X5a+56LGh5ZKM5pWw57uE77yM5LiN5o6l5Y+X5Y6f5aeL5YC877yIbnVsbCwgc3RyaW5nLCBudW1iZXIsIGJvb2xlYW7vvIlcbiAqIOi/meaYr+WboOS4uiBBSSDovpPlh7rpgJrluLjmmK/nu5PmnoTljJbnmoTmlbDmja7vvIzogIzkuI3mmK/ljZXkuKrlgLxcbiAqL1xuZnVuY3Rpb24gaXNBY2NlcHRhYmxlSnNvblZhbHVlKHZhbHVlOiB1bmtub3duKTogdmFsdWUgaXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4gfCB1bmtub3duW10ge1xuICAvLyBudWxsIOeahOexu+Wei+aYryAnb2JqZWN0J++8jOmcgOimgeaYvuW8j+aOkumZpFxuICBpZiAodmFsdWUgPT09IG51bGwpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuICAvLyDmlbDnu4TmmK/lj6/mjqXlj5fnmoRcbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuICAvLyDlr7nosaHvvIjkvYbkuI3mmK8gbnVsbO+8ieaYr+WPr+aOpeWPl+eahFxuICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0J1xufVxuXG4vKipcbiAqIOenu+mZpCBNYXJrZG93biDku6PnoIHlnZfljIXoo7nvvIzlpoIgYGBganNvbiAuLi4gYGBgXG4gKi9cbmZ1bmN0aW9uIHN0cmlwQ29kZUZlbmNlcyhyYXc6IHN0cmluZyk6IHN0cmluZyB7XG4gIGxldCByZXN1bHQgPSByYXcudHJpbSgpXG5cbiAgaWYgKHJlc3VsdC5zdGFydHNXaXRoKCdgYGAnKSkge1xuICAgIC8vIOenu+mZpOW8gOWktOeahCBgYGAg5oiWIGBgYGpzb25cbiAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZSgvXmBgYFthLXpBLVpdKlxccyovaSwgJycpXG4gIH1cbiAgaWYgKHJlc3VsdC5lbmRzV2l0aCgnYGBgJykpIHtcbiAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZSgvYGBgJC9pLCAnJylcbiAgfVxuXG4gIHJldHVybiByZXN1bHQudHJpbSgpXG59XG5cbi8qKlxuICog5bCd6K+V5o+Q5Y+W5a2X56ym5Liy5Lit55qEIEpTT04g5Li75L2T77yI5Y675o6J6K+05piO5paH5a2X44CB5YmN5ZCO57yA77yJ44CCXG4gKi9cbmZ1bmN0aW9uIGV4dHJhY3RKc29uQ29yZShyYXc6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IGZpcnN0QnJhY2UgPSByYXcuaW5kZXhPZigneycpXG4gIGNvbnN0IGZpcnN0QnJhY2tldCA9IHJhdy5pbmRleE9mKCdbJylcblxuICBsZXQgc3RhcnQgPSAtMVxuICBpZiAoZmlyc3RCcmFjZSAhPT0gLTEgJiYgZmlyc3RCcmFja2V0ICE9PSAtMSkge1xuICAgIHN0YXJ0ID0gTWF0aC5taW4oZmlyc3RCcmFjZSwgZmlyc3RCcmFja2V0KVxuICB9IGVsc2Uge1xuICAgIHN0YXJ0ID0gTWF0aC5tYXgoZmlyc3RCcmFjZSwgZmlyc3RCcmFja2V0KVxuICB9XG5cbiAgaWYgKHN0YXJ0ID09PSAtMSkge1xuICAgIHJldHVybiByYXdcbiAgfVxuXG4gIGNvbnN0IGxhc3RCcmFjZSA9IHJhdy5sYXN0SW5kZXhPZignfScpXG4gIGNvbnN0IGxhc3RCcmFja2V0ID0gcmF3Lmxhc3RJbmRleE9mKCddJylcbiAgY29uc3QgZW5kQ2FuZGlkYXRlcyA9IFtsYXN0QnJhY2UsIGxhc3RCcmFja2V0XS5maWx0ZXIoKGluZGV4KSA9PiBpbmRleCAhPT0gLTEpXG4gIGNvbnN0IGVuZCA9IGVuZENhbmRpZGF0ZXMubGVuZ3RoID4gMCA/IE1hdGgubWF4KC4uLmVuZENhbmRpZGF0ZXMpIDogcmF3Lmxlbmd0aCAtIDFcblxuICBpZiAoZW5kIDw9IHN0YXJ0KSB7XG4gICAgcmV0dXJuIHJhdy5zbGljZShzdGFydClcbiAgfVxuXG4gIHJldHVybiByYXcuc2xpY2Uoc3RhcnQsIGVuZCArIDEpXG59XG5cbi8qKlxuICog5bCd6K+V5pu/5o2i5bi46KeB55qE5Y2V5byV5Y+3IEpTT04g5qC85byP5Li65Y+M5byV5Y+344CCXG4gKi9cbmZ1bmN0aW9uIG5vcm1hbGl6ZVF1b3RlcyhyYXc6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IGhhc0RvdWJsZVF1b3RlcyA9IHJhdy5pbmNsdWRlcygnXCInKVxuICBjb25zdCBoYXNTaW5nbGVRdW90ZXMgPSByYXcuaW5jbHVkZXMoXCInXCIpXG5cbiAgaWYgKCFoYXNEb3VibGVRdW90ZXMgJiYgaGFzU2luZ2xlUXVvdGVzKSB7XG4gICAgcmV0dXJuIHJhdy5yZXBsYWNlKC8nL2csICdcIicpXG4gIH1cblxuICByZXR1cm4gcmF3XG59XG5cbi8qKlxuICog5riF55CG5bm26Kej5p6QIEpTT04g5a2X56ym5LiyXG4gKlxuICogQHBhcmFtIHJhdyAtIOWPr+iDveaYr1wi6ISPXCLnmoQgSlNPTiDlrZfnrKbkuLLvvIzmiJblt7Lnu4/mmK/lr7nosaEv5pWw57uE55qE5YC8XG4gKiBAcmV0dXJucyDop6PmnpDlkI7nmoQgSlNPTiDlr7nosaHmiJbmlbDnu4RcbiAqIEB0aHJvd3Mge0pzb25TYW5pdGl6YXRpb25FcnJvcn0g5aaC5p6c5peg5rOV5L+u5aSN5Li65pyJ5pWIIEpTT05cbiAqXG4gKiBAcmVtYXJrc1xuICog5L+u5aSN5rWB56iL77yaXG4gKiAxLiDlpoLmnpzkuI3mmK/lrZfnrKbkuLLvvIznm7TmjqXov5Tlm57vvIjlj6/og73lt7Lnu4/mmK/op6PmnpDov4fnmoTlr7nosaHvvIlcbiAqIDIuIOenu+mZpCBNYXJrZG93biDku6PnoIHlnZfljIXoo7lcbiAqIDMuIOaPkOWPliBKU09OIOaguOW/g+mDqOWIhu+8iOWOu+aOieWJjeWQjuivtOaYjuaWh+Wtl++8iVxuICogNC4g5bCd6K+V5aSa56eN5L+u5aSN562W55Wl77yaXG4gKiAgICBhLiDnm7TmjqXop6PmnpDvvIjmnIDlv6vnmoTot6/lvoTvvIlcbiAqICAgIGIuIOS9v+eUqCBqc29ucmVwYWlyIOS/ruWkjeivreazlemUmeivr1xuICogICAgYy4g5YWI5L+u5aSN5byV5Y+35YaN5L2/55SoIGpzb25yZXBhaXJcbiAqICAgIGQuIOS7heS/ruWkjeW8leWPt1xuICogNS4g6aqM6K+B57uT5p6c5piv5a+56LGh5oiW5pWw57uE77yI5LiN5o6l5Y+X5Y6f5aeL5YC877yJXG4gKiA2LiDlpoLmnpzmiYDmnInnrZbnlaXpg73lpLHotKXvvIzmipvlh7rplJnor69cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogLy8g5aSE55CG5YyF6KO55ZyoIE1hcmtkb3duIOS4reeahCBKU09OXG4gKiBjb25zdCByZXN1bHQgPSBjbGVhbkFuZFBhcnNlSnNvbignYGBganNvblxcbntcImtleVwiOiBcInZhbHVlXCJ9XFxuYGBgJyk7XG4gKiAvLyA9PiB7IGtleTogXCJ2YWx1ZVwiIH1cbiAqXG4gKiAvLyDlpITnkIbljZXlvJXlj7cgSlNPTlxuICogY29uc3QgcmVzdWx0MiA9IGNsZWFuQW5kUGFyc2VKc29uKFwieydzdGF0dXMnOiAnb2snfVwiKTtcbiAqIC8vID0+IHsgc3RhdHVzOiBcIm9rXCIgfVxuICpcbiAqIC8vIOWkhOeQhuWMheWQq+azqOmHiueahCBKU09OXG4gKiBjb25zdCByZXN1bHQzID0gY2xlYW5BbmRQYXJzZUpzb24oJ3tcIm5hbWVcIjogXCJ0ZXN0XCIsIC8vIGNvbW1lbnRcXG59Jyk7XG4gKiAvLyA9PiB7IG5hbWU6IFwidGVzdFwiIH1cbiAqIGBgYFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xlYW5BbmRQYXJzZUpzb24ocmF3OiB1bmtub3duKTogUHJvbWlzZTx1bmtub3duPiB7XG4gIC8vIOWmguaenOW3sue7j+aYr+WvueixoeaIluaVsOe7hO+8jOebtOaOpei/lOWbnu+8iOmBv+WFjeS4jeW/heimgeeahOWkhOeQhu+8iVxuICBpZiAodHlwZW9mIHJhdyAhPT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gcmF3XG4gIH1cblxuICAvLyDmraXpqqQgMTog56e76ZmkIE1hcmtkb3duIOS7o+eggeWdl+WMheijuVxuICBsZXQgd29ya2luZyA9IHN0cmlwQ29kZUZlbmNlcyhyYXcpXG4gIC8vIOatpemqpCAyOiDmj5Dlj5YgSlNPTiDmoLjlv4Ppg6jliIbvvIjljrvmjonliY3lkI7or7TmmI7mloflrZfvvIlcbiAgd29ya2luZyA9IGV4dHJhY3RKc29uQ29yZSh3b3JraW5nKVxuICAvLyDmraXpqqQgMzog5Y676Zmk6aaW5bC+56m655m9XG4gIHdvcmtpbmcgPSB3b3JraW5nLnRyaW0oKVxuXG4gIC8vIOatpemqpCA0OiDmjInkvJjlhYjnuqflsJ3or5XlpJrnp43kv67lpI3nrZbnlaVcbiAgLy8g5LuO5pyA5b+r5Yiw5pyA5oWi77yM5LuO566A5Y2V5Yiw5aSN5p2CXG4gIGNvbnN0IGF0dGVtcHRzOiBBcnJheTwoKSA9PiB1bmtub3duIHwgUHJvbWlzZTx1bmtub3duPj4gPSBbXG4gICAgLy8g562W55WlIDE6IOebtOaOpeino+aekO+8iOacgOW/q+eahOi3r+W+hO+8jOmAgueUqOS6juW3sue7j+aYr+acieaViCBKU09OIOeahOaDheWGte+8iVxuICAgICgpID0+IEpTT04ucGFyc2Uod29ya2luZyksXG4gICAgLy8g562W55WlIDI6IOS9v+eUqCBqc29ucmVwYWlyIOS/ruWkjeW4uOingeivreazlemUmeivr++8iOWmgue8uuWwkemAl+WPt+OAgeaLrOWPt+S4jeWMuemFjeetie+8iVxuICAgIGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsganNvbnJlcGFpciB9ID0gYXdhaXQgaW1wb3J0KCdqc29ucmVwYWlyJylcbiAgICAgICAgY29uc3QgcmVwYWlyZWQgPSBqc29ucmVwYWlyKHdvcmtpbmcpXG4gICAgICAgIGNvbnNvbGUubG9nKCdqc29ucmVwYWlyIGlucHV0OicsIEpTT04uc3RyaW5naWZ5KHdvcmtpbmcpKVxuICAgICAgICBjb25zb2xlLmxvZygnanNvbnJlcGFpciBvdXRwdXQ6JywgSlNPTi5zdHJpbmdpZnkocmVwYWlyZWQpKVxuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXBhaXJlZClcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdqc29ucmVwYWlyIHN0cmF0ZWd5IGZhaWxlZDonLCBlcnJvcilcbiAgICAgICAgLy8g5aaC5p6canNvbnJlcGFpcuS4jeWPr+eUqO+8jOi3s+i/h+atpOetlueVpe+8jOiuqeS4i+S4gOS4quetlueVpeWwneivlVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgICB9XG4gICAgfSxcbiAgICAvLyDnrZbnlaUgMzog5YWI5L+u5aSN5byV5Y+35YaN5L2/55SoIGpzb25yZXBhaXLvvIjlpITnkIbljZXlvJXlj7cgSlNPTu+8iVxuICAgIGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsganNvbnJlcGFpciB9ID0gYXdhaXQgaW1wb3J0KCdqc29ucmVwYWlyJylcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoanNvbnJlcGFpcihub3JtYWxpemVRdW90ZXMod29ya2luZykpKVxuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIC8vIOWmguaenGpzb25yZXBhaXLkuI3lj6/nlKjvvIzot7Pov4fmraTnrZbnlaXvvIzorqnkuIvkuIDkuKrnrZbnlaXlsJ3or5VcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgfVxuICAgIH0sXG4gICAgLy8g562W55WlIDQ6IOS7heS/ruWkjeW8leWPt++8iOWmguaenCBqc29ucmVwYWlyIOS5n+S4jei1t+S9nOeUqO+8iVxuICAgICgpID0+IEpTT04ucGFyc2Uobm9ybWFsaXplUXVvdGVzKHdvcmtpbmcpKSxcbiAgXVxuXG4gIGxldCBsYXN0RXJyb3I6IHVua25vd25cbiAgZm9yIChjb25zdCBhdHRlbXB0IG9mIGF0dGVtcHRzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhcnNlZCA9IGF3YWl0IGF0dGVtcHQoKVxuICAgICAgLy8g5aaC5p6c562W55Wl6L+U5ZuedW5kZWZpbmVk77yM6Lez6L+H5q2k562W55WlXG4gICAgICBpZiAocGFyc2VkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIC8vIOmqjOivgee7k+aenOaYr+WvueixoeaIluaVsOe7hO+8iOS4jeaOpeWPl+WOn+Wni+WAvO+8iVxuICAgICAgaWYgKGlzQWNjZXB0YWJsZUpzb25WYWx1ZShwYXJzZWQpKSB7XG4gICAgICAgIHJldHVybiBwYXJzZWRcbiAgICAgIH1cbiAgICAgIC8vIOWmguaenOino+aekOaIkOWKn+S9huS4jeaYr+WvueixoS/mlbDnu4TvvIzorrDlvZXplJnor6/kvYbnu6fnu63lsJ3or5Xlhbbku5bnrZbnlaVcbiAgICAgIGxhc3RFcnJvciA9IG5ldyBFcnJvcignU2FuaXRpemVkIG91dHB1dCB3YXMgbm90IGEgSlNPTiBvYmplY3Qgb3IgYXJyYXkuJylcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8g6Kej5p6Q5aSx6LSl77yM6K6w5b2V6ZSZ6K+v5bm25bCd6K+V5LiL5LiA5Liq562W55WlXG4gICAgICBsYXN0RXJyb3IgPSBlcnJvclxuICAgICAgLy8g6LCD6K+V6L6T5Ye6XG4gICAgICBjb25zb2xlLmxvZyhgU3RyYXRlZ3kgZmFpbGVkOmAsIGVycm9yKVxuICAgIH1cbiAgfVxuXG4gIC8vIOaJgOacieetlueVpemDveWksei0pe+8jOaKm+WHuuivpue7hueahOmUmeivr+S/oeaBr1xuICB0aHJvdyBuZXcgSnNvblNhbml0aXphdGlvbkVycm9yKCdGYWlsZWQgdG8gc2FuaXRpemUgQUkgb3V0cHV0IGludG8gdmFsaWQgSlNPTi4nLCB7XG4gICAgcmF3LFxuICAgIGxhc3RFcnJvcixcbiAgfSlcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==