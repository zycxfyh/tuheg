1cd328b1398ce530b29b3ccd3e5e9ebd
"use strict";
// 文件路径: packages/common-backend/src/config/env-loader.ts
// 核心理念: 支持环境变量扩展和多环境配置
Object.defineProperty(exports, "__esModule", { value: true });
exports.EnvLoader = void 0;
const dotenv_1 = require("dotenv");
const dotenv_expand_1 = require("dotenv-expand");
const fs_1 = require("fs");
const path_1 = require("path");
/**
 * @class EnvLoader
 * @description 环境变量加载器
 * 支持环境变量扩展和多环境配置
 */
class EnvLoader {
    /**
     * @method load
     * @description 加载环境变量
     *
     * @example
     * ```typescript
     * // 加载 .env 文件
     * EnvLoader.load();
     *
     * // 加载特定环境的配置
     * EnvLoader.load({ env: 'production' });
     * ```
     */
    static load(options = {}) {
        const { env = process.env.NODE_ENV || 'development', configDir = process.cwd(), override = false, silent = false, } = options;
        // 加载顺序：
        // 1. .env (基础配置)
        // 2. .env.local (本地覆盖，不提交到 Git)
        // 3. .env.{env} (环境特定配置，如 .env.production)
        // 4. .env.{env}.local (环境特定的本地覆盖)
        const envFiles = ['.env', '.env.local', `.env.${env}`, `.env.${env}.local`];
        for (const envFile of envFiles) {
            const envPath = (0, path_1.resolve)(configDir, envFile);
            if ((0, fs_1.existsSync)(envPath)) {
                try {
                    const result = (0, dotenv_1.config)({
                        path: envPath,
                        override,
                    });
                    if (result.error && !silent) {
                        console.warn(`Failed to load ${envFile}:`, result.error.message);
                    }
                    else if (result.parsed) {
                        // 扩展环境变量（支持 ${VAR} 引用）
                        (0, dotenv_expand_1.expand)(result);
                        console.log(`✓ Loaded ${envFile}`);
                    }
                }
                catch (error) {
                    if (!silent) {
                        console.warn(`Error loading ${envFile}:`, error);
                    }
                }
            }
        }
    }
    /**
     * @method loadForApp
     * @description 为特定应用加载环境变量
     *
     * @example
     * ```typescript
     * // 为 backend-gateway 加载配置
     * EnvLoader.loadForApp('backend-gateway');
     * ```
     */
    static loadForApp(appName, options = {}) {
        const { env = process.env.NODE_ENV || 'development', configDir = process.cwd() } = options;
        // 应用特定的环境文件
        const appEnvFiles = [
            `.env.${appName}`,
            `.env.${appName}.local`,
            `.env.${appName}.${env}`,
            `.env.${appName}.${env}.local`,
        ];
        for (const envFile of appEnvFiles) {
            const envPath = (0, path_1.resolve)(configDir, envFile);
            if ((0, fs_1.existsSync)(envPath)) {
                try {
                    const result = (0, dotenv_1.config)({
                        path: envPath,
                        override: true, // 应用特定配置覆盖全局配置
                    });
                    if (result.parsed) {
                        (0, dotenv_expand_1.expand)(result);
                        console.log(`✓ Loaded ${envFile} for ${appName}`);
                    }
                }
                catch (error) {
                    console.warn(`Error loading ${envFile}:`, error);
                }
            }
        }
    }
}
exports.EnvLoader = EnvLoader;
//# sourceMappingURL=env-loader.js.map