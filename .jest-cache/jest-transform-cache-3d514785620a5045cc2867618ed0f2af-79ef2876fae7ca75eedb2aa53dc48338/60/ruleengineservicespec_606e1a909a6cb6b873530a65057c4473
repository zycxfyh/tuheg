d85f652b4a581327ca98b954a3de1937
"use strict";
// 文件路径: apps/logic-agent/src/__tests__/rule-engine.service.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const testing_1 = require("@nestjs/testing");
const common_backend_1 = require("@tuheg/common-backend");
const jest_mock_extended_1 = require("jest-mock-extended");
const rule_engine_service_1 = require("../rule-engine.service");
describe('RuleEngineService', () => {
    let service;
    let prismaMock;
    const MOCK_GAME_ID = 'test-game-id';
    const MOCK_CHARACTER = {
        id: 'char-id',
        gameId: MOCK_GAME_ID,
        name: 'Kael',
        hp: 100,
        maxHp: 100,
        mp: 50,
        maxMp: 50,
        status: 'Normal',
        card: {},
    };
    beforeEach(async () => {
        prismaMock = (0, jest_mock_extended_1.mockDeep)();
        const module = await testing_1.Test.createTestingModule({
            providers: [rule_engine_service_1.RuleEngineService, { provide: common_backend_1.PrismaService, useValue: prismaMock }],
        }).compile();
        service = module.get(rule_engine_service_1.RuleEngineService);
        // [核心修复] 为 tx 参数提供明确的类型 PrismaClient
        prismaMock.$transaction.mockImplementation(async (fn) => {
            return await fn(prismaMock);
        });
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    it('should do nothing if directives array is empty', async () => {
        await service.execute(MOCK_GAME_ID, []);
        expect(prismaMock.$transaction).not.toHaveBeenCalled();
    });
    describe('Character Updates', () => {
        beforeEach(() => {
            prismaMock.character.findUniqueOrThrow.mockResolvedValue(MOCK_CHARACTER);
        });
        it('should correctly apply a single "decrement" hp directive', async () => {
            const directives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { hp: { op: 'decrement', value: 10 } },
                },
            ];
            await service.execute(MOCK_GAME_ID, directives);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: { hp: 90 },
            });
        });
        it('should correctly apply multiple directives in one transaction', async () => {
            const directives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: {
                        hp: { op: 'increment', value: 5 },
                        mp: { op: 'set', value: 42 },
                        status: { op: 'set', value: 'Energized' },
                    },
                },
            ];
            await service.execute(MOCK_GAME_ID, directives);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: {
                    hp: 105,
                    mp: 42,
                    status: 'Energized',
                },
            });
        });
        it('should handle string "append" and "prepend" operations', async () => {
            const initialCharacter = { ...MOCK_CHARACTER };
            prismaMock.character.findUniqueOrThrow.mockResolvedValue(initialCharacter);
            const prependDirective = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { status: { op: 'prepend', value: 'Slightly ' } },
                },
            ];
            await service.execute(MOCK_GAME_ID, prependDirective);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: { status: 'Slightly Normal' },
            });
            const appendedCharacter = {
                ...initialCharacter,
                status: 'Slightly Normal',
            };
            prismaMock.character.findUniqueOrThrow.mockResolvedValue(appendedCharacter);
            const appendDirective = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { status: { op: 'append', value: ' and Confused' } },
                },
            ];
            await service.execute(MOCK_GAME_ID, appendDirective);
            expect(prismaMock.character.update).toHaveBeenCalledWith({
                where: { gameId: MOCK_GAME_ID },
                data: { status: 'Slightly Normal and Confused' },
            });
        });
    });
    describe('Error Handling', () => {
        it('should re-throw transaction failures as a RuleEngineExecutionException', async () => {
            const dbError = new Error('Database connection lost');
            prismaMock.$transaction.mockRejectedValue(dbError);
            const directives = [
                {
                    op: 'update_character',
                    targetId: 'player',
                    payload: { hp: { op: 'decrement', value: 10 } },
                },
            ];
            await expect(service.execute(MOCK_GAME_ID, directives)).rejects.toThrow('Rule engine transaction failed: Database connection lost');
        });
        it('should throw BadRequestException for an unknown operation', async () => {
            const directives = [
                {
                    op: 'unknown_operation', // 使用一个未知的操作
                    targetId: 'player',
                    payload: {},
                },
            ];
            await expect(service.execute(MOCK_GAME_ID, directives)).rejects.toThrow(common_1.BadRequestException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXGFwcHNcXGxvZ2ljLWFnZW50XFxzcmNcXF9fdGVzdHNfX1xccnVsZS1lbmdpbmUuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxtRUFBbUU7O0FBRW5FLDJDQUFvRDtBQUNwRCw2Q0FBMEQ7QUFFMUQsMERBQXdFO0FBQ3hFLDJEQUFpRTtBQUNqRSxnRUFBMEQ7QUFFMUQsUUFBUSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRTtJQUNqQyxJQUFJLE9BQTBCLENBQUE7SUFDOUIsSUFBSSxVQUF1QyxDQUFBO0lBRTNDLE1BQU0sWUFBWSxHQUFHLGNBQWMsQ0FBQTtJQUNuQyxNQUFNLGNBQWMsR0FBYztRQUNoQyxFQUFFLEVBQUUsU0FBUztRQUNiLE1BQU0sRUFBRSxZQUFZO1FBQ3BCLElBQUksRUFBRSxNQUFNO1FBQ1osRUFBRSxFQUFFLEdBQUc7UUFDUCxLQUFLLEVBQUUsR0FBRztRQUNWLEVBQUUsRUFBRSxFQUFFO1FBQ04sS0FBSyxFQUFFLEVBQUU7UUFDVCxNQUFNLEVBQUUsUUFBUTtRQUNoQixJQUFJLEVBQUUsRUFBdUI7S0FDOUIsQ0FBQTtJQUVELFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixVQUFVLEdBQUcsSUFBQSw2QkFBUSxHQUFnQixDQUFBO1FBRXJDLE1BQU0sTUFBTSxHQUFrQixNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMzRCxTQUFTLEVBQUUsQ0FBQyx1Q0FBaUIsRUFBRSxFQUFFLE9BQU8sRUFBRSw4QkFBYSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsQ0FBQztTQUNqRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUE7UUFFWixPQUFPLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBb0IsdUNBQWlCLENBQUMsQ0FBQTtRQUUxRCxxQ0FBcUM7UUFDckMsVUFBVSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsRUFBTyxFQUFFLEVBQUU7WUFDM0QsT0FBTyxN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Q0FBQyxDQUFBIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxhcHBzXFxsb2dpYy1hZ2VudFxcc3JjXFxfX3Rlc3RzX19cXHJ1bGUtZW5naW5lLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyDmlofku7bot6/lvoQ6IGFwcHMvbG9naWMtYWdlbnQvc3JjL19fdGVzdHNfXy9ydWxlLWVuZ2luZS5zZXJ2aWNlLnNwZWMudHNcblxuaW1wb3J0IHsgQmFkUmVxdWVzdEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJ1xuaW1wb3J0IHsgVGVzdCwgdHlwZSBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJ1xuaW1wb3J0IHR5cGUgeyBDaGFyYWN0ZXIsIFByaXNtYSwgUHJpc21hQ2xpZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnXG5pbXBvcnQgeyB0eXBlIERpcmVjdGl2ZVNldCwgUHJpc21hU2VydmljZSB9IGZyb20gJ0B0dWhlZy9jb21tb24tYmFja2VuZCdcbmltcG9ydCB7IHR5cGUgRGVlcE1vY2tQcm94eSwgbW9ja0RlZXAgfSBmcm9tICdqZXN0LW1vY2stZXh0ZW5kZWQnXG5pbXBvcnQgeyBSdWxlRW5naW5lU2VydmljZSB9IGZyb20gJy4uL3J1bGUtZW5naW5lLnNlcnZpY2UnXG5cbmRlc2NyaWJlKCdSdWxlRW5naW5lU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFJ1bGVFbmdpbmVTZXJ2aWNlXG4gIGxldCBwcmlzbWFNb2NrOiBEZWVwTW9ja1Byb3h5PFByaXNtYUNsaWVudD5cblxuICBjb25zdCBNT0NLX0dBTUVfSUQgPSAndGVzdC1nYW1lLWlkJ1xuICBjb25zdCBNT0NLX0NIQVJBQ1RFUjogQ2hhcmFjdGVyID0ge1xuICAgIGlkOiAnY2hhci1pZCcsXG4gICAgZ2FtZUlkOiBNT0NLX0dBTUVfSUQsXG4gICAgbmFtZTogJ0thZWwnLFxuICAgIGhwOiAxMDAsXG4gICAgbWF4SHA6IDEwMCxcbiAgICBtcDogNTAsXG4gICAgbWF4TXA6IDUwLFxuICAgIHN0YXR1czogJ05vcm1hbCcsXG4gICAgY2FyZDoge30gYXMgUHJpc21hLkpzb25PYmplY3QsXG4gIH1cblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBwcmlzbWFNb2NrID0gbW9ja0RlZXA8UHJpc21hQ2xpZW50PigpXG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbUnVsZUVuZ2luZVNlcnZpY2UsIHsgcHJvdmlkZTogUHJpc21hU2VydmljZSwgdXNlVmFsdWU6IHByaXNtYU1vY2sgfV0sXG4gICAgfSkuY29tcGlsZSgpXG5cbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxSdWxlRW5naW5lU2VydmljZT4oUnVsZUVuZ2luZVNlcnZpY2UpXG5cbiAgICAvLyBb5qC45b+D5L+u5aSNXSDkuLogdHgg5Y+C5pWw5o+Q5L6b5piO56Gu55qE57G75Z6LIFByaXNtYUNsaWVudFxuICAgIHByaXNtYU1vY2suJHRyYW5zYWN0aW9uLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoZm46IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIGF3YWl0IGZuKHByaXNtYU1vY2spXG4gICAgfSlcbiAgfSlcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpXG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpXG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBkbyBub3RoaW5nIGlmIGRpcmVjdGl2ZXMgYXJyYXkgaXMgZW1wdHknLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgc2VydmljZS5leGVjdXRlKE1PQ0tfR0FNRV9JRCwgW10pXG4gICAgZXhwZWN0KHByaXNtYU1vY2suJHRyYW5zYWN0aW9uKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ0NoYXJhY3RlciBVcGRhdGVzJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgcHJpc21hTW9jay5jaGFyYWN0ZXIuZmluZFVuaXF1ZU9yVGhyb3cubW9ja1Jlc29sdmVkVmFsdWUoTU9DS19DSEFSQUNURVIpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgY29ycmVjdGx5IGFwcGx5IGEgc2luZ2xlIFwiZGVjcmVtZW50XCIgaHAgZGlyZWN0aXZlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZGlyZWN0aXZlczogRGlyZWN0aXZlU2V0ID0gW1xuICAgICAgICB7XG4gICAgICAgICAgb3A6ICd1cGRhdGVfY2hhcmFjdGVyJyxcbiAgICAgICAgICB0YXJnZXRJZDogJ3BsYXllcicsXG4gICAgICAgICAgcGF5bG9hZDogeyBocDogeyBvcDogJ2RlY3JlbWVudCcsIHZhbHVlOiAxMCB9IH0sXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgICBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGUoTU9DS19HQU1FX0lELCBkaXJlY3RpdmVzKVxuICAgICAgZXhwZWN0KHByaXNtYU1vY2suY2hhcmFjdGVyLnVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICB3aGVyZTogeyBnYW1lSWQ6IE1PQ0tfR0FNRV9JRCB9LFxuICAgICAgICBkYXRhOiB7IGhwOiA5MCB9LFxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgYXBwbHkgbXVsdGlwbGUgZGlyZWN0aXZlcyBpbiBvbmUgdHJhbnNhY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkaXJlY3RpdmVzOiBEaXJlY3RpdmVTZXQgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBvcDogJ3VwZGF0ZV9jaGFyYWN0ZXInLFxuICAgICAgICAgIHRhcmdldElkOiAncGxheWVyJyxcbiAgICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgICBocDogeyBvcDogJ2luY3JlbWVudCcsIHZhbHVlOiA1IH0sXG4gICAgICAgICAgICBtcDogeyBvcDogJ3NldCcsIHZhbHVlOiA0MiB9LFxuICAgICAgICAgICAgc3RhdHVzOiB7IG9wOiAnc2V0JywgdmFsdWU6ICdFbmVyZ2l6ZWQnIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF1cbiAgICAgIGF3YWl0IHNlcnZpY2UuZXhlY3V0ZShNT0NLX0dBTUVfSUQsIGRpcmVjdGl2ZXMpXG4gICAgICBleHBlY3QocHJpc21hTW9jay5jaGFyYWN0ZXIudXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHdoZXJlOiB7IGdhbWVJZDogTU9DS19HQU1FX0lEIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBocDogMTA1LFxuICAgICAgICAgIG1wOiA0MixcbiAgICAgICAgICBzdGF0dXM6ICdFbmVyZ2l6ZWQnLFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc3RyaW5nIFwiYXBwZW5kXCIgYW5kIFwicHJlcGVuZFwiIG9wZXJhdGlvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbml0aWFsQ2hhcmFjdGVyID0geyAuLi5NT0NLX0NIQVJBQ1RFUiB9XG4gICAgICBwcmlzbWFNb2NrLmNoYXJhY3Rlci5maW5kVW5pcXVlT3JUaHJvdy5tb2NrUmVzb2x2ZWRWYWx1ZShpbml0aWFsQ2hhcmFjdGVyKVxuXG4gICAgICBjb25zdCBwcmVwZW5kRGlyZWN0aXZlOiBEaXJlY3RpdmVTZXQgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBvcDogJ3VwZGF0ZV9jaGFyYWN0ZXInLFxuICAgICAgICAgIHRhcmdldElkOiAncGxheWVyJyxcbiAgICAgICAgICBwYXlsb2FkOiB7IHN0YXR1czogeyBvcDogJ3ByZXBlbmQnLCB2YWx1ZTogJ1NsaWdodGx5ICcgfSB9LFxuICAgICAgICB9LFxuICAgICAgXVxuICAgICAgYXdhaXQgc2VydmljZS5leGVjdXRlKE1PQ0tfR0FNRV9JRCwgcHJlcGVuZERpcmVjdGl2ZSlcbiAgICAgIGV4cGVjdChwcmlzbWFNb2NrLmNoYXJhY3Rlci51cGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgd2hlcmU6IHsgZ2FtZUlkOiBNT0NLX0dBTUVfSUQgfSxcbiAgICAgICAgZGF0YTogeyBzdGF0dXM6ICdTbGlnaHRseSBOb3JtYWwnIH0sXG4gICAgICB9KVxuXG4gICAgICBjb25zdCBhcHBlbmRlZENoYXJhY3RlciA9IHtcbiAgICAgICAgLi4uaW5pdGlhbENoYXJhY3RlcixcbiAgICAgICAgc3RhdHVzOiAnU2xpZ2h0bHkgTm9ybWFsJyxcbiAgICAgIH1cbiAgICAgIHByaXNtYU1vY2suY2hhcmFjdGVyLmZpbmRVbmlxdWVPclRocm93Lm1vY2tSZXNvbHZlZFZhbHVlKGFwcGVuZGVkQ2hhcmFjdGVyKVxuXG4gICAgICBjb25zdCBhcHBlbmREaXJlY3RpdmU6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndXBkYXRlX2NoYXJhY3RlcicsXG4gICAgICAgICAgdGFyZ2V0SWQ6ICdwbGF5ZXInLFxuICAgICAgICAgIHBheWxvYWQ6IHsgc3RhdHVzOiB7IG9wOiAnYXBwZW5kJywgdmFsdWU6ICcgYW5kIENvbmZ1c2VkJyB9IH0sXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgICBhd2FpdCBzZXJ2aWNlLmV4ZWN1dGUoTU9DS19HQU1FX0lELCBhcHBlbmREaXJlY3RpdmUpXG4gICAgICBleHBlY3QocHJpc21hTW9jay5jaGFyYWN0ZXIudXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHdoZXJlOiB7IGdhbWVJZDogTU9DS19HQU1FX0lEIH0sXG4gICAgICAgIGRhdGE6IHsgc3RhdHVzOiAnU2xpZ2h0bHkgTm9ybWFsIGFuZCBDb25mdXNlZCcgfSxcbiAgICAgIH0pXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnRXJyb3IgSGFuZGxpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZS10aHJvdyB0cmFuc2FjdGlvbiBmYWlsdXJlcyBhcyBhIFJ1bGVFbmdpbmVFeGVjdXRpb25FeGNlcHRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkYkVycm9yID0gbmV3IEVycm9yKCdEYXRhYmFzZSBjb25uZWN0aW9uIGxvc3QnKVxuICAgICAgcHJpc21hTW9jay4kdHJhbnNhY3Rpb24ubW9ja1JlamVjdGVkVmFsdWUoZGJFcnJvcilcbiAgICAgIGNvbnN0IGRpcmVjdGl2ZXM6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndXBkYXRlX2NoYXJhY3RlcicsXG4gICAgICAgICAgdGFyZ2V0SWQ6ICdwbGF5ZXInLFxuICAgICAgICAgIHBheWxvYWQ6IHsgaHA6IHsgb3A6ICdkZWNyZW1lbnQnLCB2YWx1ZTogMTAgfSB9LFxuICAgICAgICB9LFxuICAgICAgXVxuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuZXhlY3V0ZShNT0NLX0dBTUVfSUQsIGRpcmVjdGl2ZXMpKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAgICdSdWxlIGVuZ2luZSB0cmFuc2FjdGlvbiBmYWlsZWQ6IERhdGFiYXNlIGNvbm5lY3Rpb24gbG9zdCdcbiAgICAgIClcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBCYWRSZXF1ZXN0RXhjZXB0aW9uIGZvciBhbiB1bmtub3duIG9wZXJhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGRpcmVjdGl2ZXM6IERpcmVjdGl2ZVNldCA9IFtcbiAgICAgICAge1xuICAgICAgICAgIG9wOiAndW5rbm93bl9vcGVyYXRpb24nLCAvLyDkvb/nlKjkuIDkuKrmnKrnn6XnmoTmk43kvZxcbiAgICAgICAgICB0YXJnZXRJZDogJ3BsYXllcicsXG4gICAgICAgICAgcGF5bG9hZDoge30sXG4gICAgICAgIH0gYXMgYW55LCAvLyBUeXBlIGFzc2VydGlvbiB0byBieXBhc3MgdHlwZSBjaGVja2luZ1xuICAgICAgXVxuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuZXhlY3V0ZShNT0NLX0dBTUVfSUQsIGRpcmVjdGl2ZXMpKS5yZWplY3RzLnRvVGhyb3coQmFkUmVxdWVzdEV4Y2VwdGlvbilcbiAgICB9KVxuICB9KVxufSlcbiJdLCJ2ZXJzaW9uIjozfQ==