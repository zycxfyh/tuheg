{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\tar-variable.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\vcp\\tar-variable.service.ts"],"sourcesContent":["// ============================================================================\n// Tar* 变量系统集成服务\n// 集成 VCPToolBox 的动态配置和环境感知能力\n// ============================================================================\n\nimport { Injectable, Logger, type OnModuleInit } from '@nestjs/common'\nimport { ConfigService } from '@nestjs/config'\nimport {\n  type TarVariable,\n  tarVariableManager,\n  type VariableContext,\n} from '../../../apps/vcptoolbox/src/modules/core/TarVariableSystem'\n\n@Injectable()\nexport class TarVariableService implements OnModuleInit {\n  private readonly logger = new Logger(TarVariableService.name)\n\n  constructor(private configService: ConfigService) {}\n\n  async onModuleInit() {\n    await this.initializeSystemVariables()\n    this.setupDynamicUpdates()\n    this.logger.log('Tar* 变量系统已初始化')\n  }\n\n  // ==================== 系统变量初始化 ====================\n\n  /**\n   * 初始化系统变量\n   */\n  private async initializeSystemVariables(): Promise<void> {\n    // 时间相关变量\n    await this.registerSystemVariable({\n      name: 'VarTimeNow',\n      value: () => new Date().toLocaleString('zh-CN'),\n      type: 'dynamic',\n      scope: 'global',\n      dependencies: [],\n      metadata: {\n        description: '当前时间（中文格式）',\n        author: 'system',\n        tags: ['time', 'system', 'narrative'],\n      },\n    })\n\n    // 位置相关变量（简化实现，实际应该调用地理位置API）\n    await this.registerSystemVariable({\n      name: 'VarCity',\n      value: this.configService.get('DEFAULT_CITY', '北京市'),\n      type: 'dynamic',\n      scope: 'global',\n      dependencies: [],\n      updater: async () => {\n        // 实际实现中应该调用地理位置服务\n        return this.configService.get('DEFAULT_CITY', '北京市')\n      },\n      metadata: {\n        description: '当前位置城市',\n        author: 'system',\n        tags: ['location', 'system', 'narrative'],\n      },\n    })\n\n    // 天气信息变量\n    await this.registerSystemVariable({\n      name: 'VCPWeatherInfo',\n      value: '晴天，温度适中',\n      type: 'dynamic',\n      scope: 'global',\n      dependencies: ['VarCity'],\n      updater: async (context: VariableContext) => {\n        const city = await this.getVariableValue('VarCity', context)\n        // 实际实现中应该调用天气API\n        return `${city} - 晴天，温度20-25°C，适合创作`\n      },\n      metadata: {\n        description: '天气信息，用于叙事环境设定',\n        author: 'system',\n        tags: ['weather', 'system', 'narrative'],\n      },\n    })\n\n    // 用户相关变量\n    await this.registerSystemVariable({\n      name: 'UserName',\n      value: '创作者',\n      type: 'dynamic',\n      scope: 'session',\n      dependencies: [],\n      metadata: {\n        description: '当前用户名称',\n        author: 'system',\n        tags: ['user', 'session', 'narrative'],\n      },\n    })\n\n    // 创作风格变量\n    await this.registerSystemVariable({\n      name: 'NarrativeStyle',\n      value: this.configService.get('DEFAULT_NARRATIVE_STYLE', '现代现实主义'),\n      type: 'dynamic',\n      scope: 'session',\n      dependencies: [],\n      metadata: {\n        description: '当前叙事风格',\n        author: 'system',\n        tags: ['narrative', 'style', 'session'],\n      },\n    })\n\n    // AI模型配置变量\n    await this.registerSystemVariable({\n      name: 'AIModelConfig',\n      value: {\n        provider: this.configService.get('AI_PROVIDER', 'openai'),\n        model: this.configService.get('AI_MODEL', 'gpt-4'),\n        temperature: 0.7,\n        maxTokens: 2000,\n      },\n      type: 'static',\n      scope: 'global',\n      dependencies: [],\n      metadata: {\n        description: 'AI模型配置参数',\n        author: 'system',\n        tags: ['ai', 'config', 'model'],\n      },\n    })\n\n    // 故事世界设定变量\n    await this.registerSystemVariable({\n      name: 'WorldSetting',\n      value: '现代都市',\n      type: 'dynamic',\n      scope: 'session',\n      dependencies: [],\n      metadata: {\n        description: '当前故事世界设定',\n        author: 'system',\n        tags: ['world', 'setting', 'narrative'],\n      },\n    })\n\n    // 角色性格模板变量\n    await this.registerSystemVariable({\n      name: 'CharacterTemplate',\n      value: 'balanced',\n      type: 'dynamic',\n      scope: 'task',\n      dependencies: [],\n      metadata: {\n        description: '角色性格模板',\n        author: 'system',\n        tags: ['character', 'template', 'narrative'],\n      },\n    })\n\n    // 工具列表变量（VCP兼容）\n    await this.registerSystemVariable({\n      name: 'VarToolList',\n      value:\n        '文生图工具{{VCPFluxGen}},对话生成工具{{VCPDialogueGen}},情感分析工具{{VCPEmotionAnalyzer}}',\n      type: 'computed',\n      scope: 'agent',\n      dependencies: ['VCPFluxGen', 'VCPDialogueGen', 'VCPEmotionAnalyzer'],\n      metadata: {\n        description: '可用工具列表（VCP格式）',\n        author: 'system',\n        tags: ['tools', 'vcp', 'agent'],\n      },\n    })\n  }\n\n  // ==================== 变量管理接口 ====================\n\n  /**\n   * 注册系统变量\n   */\n  private async registerSystemVariable(variable: Omit<TarVariable, 'metadata'>): Promise<void> {\n    try {\n      tarVariableManager.registerVariable(variable)\n      this.logger.debug(`系统变量已注册: ${variable.name}`)\n    } catch (error) {\n      this.logger.error(`注册系统变量失败 ${variable.name}:`, error)\n    }\n  }\n\n  /**\n   * 获取变量值\n   */\n  async getVariableValue(name: string, context?: VariableContext): Promise<any> {\n    try {\n      return await tarVariableManager.getVariableValue(name, context)\n    } catch (error) {\n      this.logger.warn(`获取变量值失败 ${name}:`, error)\n      return null\n    }\n  }\n\n  /**\n   * 设置变量值\n   */\n  async setVariableValue(name: string, value: any, context?: VariableContext): Promise<void> {\n    try {\n      tarVariableManager.setVariableValue(name, value, context)\n      this.logger.debug(`变量值已设置: ${name} = ${value}`)\n    } catch (error) {\n      this.logger.error(`设置变量值失败 ${name}:`, error)\n      throw error\n    }\n  }\n\n  /**\n   * 批量获取变量值\n   */\n  async getMultipleValues(\n    names: string[],\n    context?: VariableContext\n  ): Promise<Record<string, any>> {\n    return await tarVariableManager.getMultipleValues(names, context)\n  }\n\n  /**\n   * 处理嵌套变量替换\n   */\n  async processNestedVariables(template: string, context?: VariableContext): Promise<string> {\n    try {\n      return await tarVariableManager.processNestedVariables(template, context)\n    } catch (error) {\n      this.logger.warn(`变量替换失败:`, error)\n      return template // 返回原模板\n    }\n  }\n\n  /**\n   * 监听变量变化\n   */\n  watchVariable(name: string, callback: (variable: TarVariable) => void): () => void {\n    return tarVariableManager.watchVariable(name, callback)\n  }\n\n  // ==================== 动态更新设置 ====================\n\n  /**\n   * 设置动态更新\n   */\n  private setupDynamicUpdates(): void {\n    // 设置时间变量的定期更新\n    setInterval(async () => {\n      try {\n        await this.updateTimeVariables()\n      } catch (error) {\n        this.logger.error('更新时间变量失败:', error)\n      }\n    }, 60000) // 每分钟更新\n\n    // 设置用户状态变量的监听\n    this.watchVariable('UserName', (variable) => {\n      this.logger.debug(`用户名已更新: ${variable.value}`)\n      // 触发相关变量的重新计算\n      tarVariableManager.triggerVariableUpdate('NarrativeStyle')\n    })\n\n    // 设置世界设定变化的监听\n    this.watchVariable('WorldSetting', async (variable) => {\n      this.logger.debug(`世界设定已更新: ${variable.value}`)\n      // 根据世界设定调整相关变量\n      await this.adjustVariablesForWorldSetting(variable.value)\n    })\n  }\n\n  /**\n   * 更新时间相关变量\n   */\n  private async updateTimeVariables(): Promise<void> {\n    const now = new Date()\n    const context: VariableContext = {\n      environment: { timestamp: now.getTime() },\n      timestamp: now,\n    }\n\n    // 触发时间变量更新\n    tarVariableManager.triggerVariableUpdate('VarTimeNow', context)\n    tarVariableManager.triggerVariableUpdate('VCPWeatherInfo', context)\n  }\n\n  /**\n   * 根据世界设定调整变量\n   */\n  private async adjustVariablesForWorldSetting(worldSetting: string): Promise<void> {\n    const settingAdjustments: Record<string, any> = {\n      现代都市: {\n        narrativeStyle: '现实主义',\n        characterTemplate: 'urban-professional',\n      },\n      奇幻世界: {\n        narrativeStyle: '奇幻史诗',\n        characterTemplate: 'heroic-fantasy',\n      },\n      科幻未来: {\n        narrativeStyle: '赛博朋克',\n        characterTemplate: 'cybernetic-enhanced',\n      },\n      历史古代: {\n        narrativeStyle: '古典文学',\n        characterTemplate: 'historical-figure',\n      },\n    }\n\n    const adjustments = settingAdjustments[worldSetting]\n    if (adjustments) {\n      await this.setVariableValue('NarrativeStyle', adjustments.narrativeStyle)\n      await this.setVariableValue('CharacterTemplate', adjustments.characterTemplate)\n    }\n  }\n\n  // ==================== 叙事专用接口 ====================\n\n  /**\n   * 为故事生成准备变量上下文\n   */\n  async prepareNarrativeContext(storyId: string, userId?: string): Promise<VariableContext> {\n    const context: VariableContext = {\n      agentId: `narrative-agent-${storyId}`,\n      sessionId: storyId,\n      userId,\n      environment: {},\n      timestamp: new Date(),\n    }\n\n    // 获取相关变量值\n    const [timeNow, city, weather, userName, narrativeStyle, worldSetting, characterTemplate] =\n      await Promise.all([\n        this.getVariableValue('VarTimeNow', context),\n        this.getVariableValue('VarCity', context),\n        this.getVariableValue('VCPWeatherInfo', context),\n        this.getVariableValue('UserName', context),\n        this.getVariableValue('NarrativeStyle', context),\n        this.getVariableValue('WorldSetting', context),\n        this.getVariableValue('CharacterTemplate', context),\n      ])\n\n    context.environment = {\n      timeNow,\n      city,\n      weather,\n      userName,\n      narrativeStyle,\n      worldSetting,\n      characterTemplate,\n    }\n\n    return context\n  }\n\n  /**\n   * 生成叙事提示词\n   */\n  async generateNarrativePrompt(basePrompt: string, context?: VariableContext): Promise<string> {\n    const fullContext = context || (await this.prepareNarrativeContext('default'))\n\n    // 构建增强的提示词\n    const enhancedPrompt = `\n当前环境信息：\n- 时间：{{VarTimeNow}}\n- 地点：{{VarCity}}\n- 天气：{{VCPWeatherInfo}}\n- 用户：{{UserName}}\n- 叙事风格：{{NarrativeStyle}}\n- 世界设定：{{WorldSetting}}\n- 角色模板：{{CharacterTemplate}}\n\n原始创作需求：${basePrompt}\n\n请基于以上环境信息，创作符合当前设定和风格的故事内容。\n`\n\n    return await this.processNestedVariables(enhancedPrompt, fullContext)\n  }\n\n  /**\n   * 更新用户创作偏好\n   */\n  async updateUserPreferences(\n    userId: string,\n    preferences: {\n      narrativeStyle?: string\n      worldSetting?: string\n      characterTemplate?: string\n    }\n  ): Promise<void> {\n    const context: VariableContext = {\n      userId,\n      environment: {},\n      timestamp: new Date(),\n    }\n\n    if (preferences.narrativeStyle) {\n      await this.setVariableValue('NarrativeStyle', preferences.narrativeStyle, context)\n    }\n\n    if (preferences.worldSetting) {\n      await this.setVariableValue('WorldSetting', preferences.worldSetting, context)\n    }\n\n    if (preferences.characterTemplate) {\n      await this.setVariableValue('CharacterTemplate', preferences.characterTemplate, context)\n    }\n\n    this.logger.log(`用户偏好已更新: ${userId}`)\n  }\n\n  // ==================== 工具集成接口 ====================\n\n  /**\n   * 获取工具配置\n   */\n  async getToolConfig(toolName: string): Promise<any> {\n    const toolConfig = await this.getVariableValue(`VCP${toolName}`)\n    return toolConfig || null\n  }\n\n  /**\n   * 注册工具变量\n   */\n  async registerToolVariable(toolName: string, config: any): Promise<void> {\n    await this.registerSystemVariable({\n      name: `VCP${toolName}`,\n      value: config,\n      type: 'static',\n      scope: 'global',\n      dependencies: [],\n      metadata: {\n        description: `${toolName} 工具配置`,\n        author: 'system',\n        tags: ['tool', 'vcp', 'config'],\n      },\n    })\n  }\n\n  // ==================== 监控和统计 ====================\n\n  /**\n   * 获取变量系统统计\n   */\n  getVariableStats(): any {\n    // 这里可以返回变量系统的统计信息\n    return {\n      totalVariables: 0, // 实际实现中应该从tarVariableManager获取\n      activeWatchers: 0,\n      recentUpdates: [],\n    }\n  }\n\n  /**\n   * 清理过期变量\n   */\n  async cleanupExpiredVariables(): Promise<void> {\n    // 清理逻辑\n    this.logger.log('变量清理完成')\n  }\n}\n"],"version":3}