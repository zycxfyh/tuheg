{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\rate-limit\\rate-limit.guard.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\rate-limit\\rate-limit.guard.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/rate-limit/rate-limit.guard.ts\n// 核心理念: API 限流保护，防止滥用和过载\n\nimport {\n  type CanActivate,\n  type ExecutionContext,\n  HttpException,\n  HttpStatus,\n  Injectable,\n  Logger,\n} from '@nestjs/common'\nimport type { Reflector } from '@nestjs/core'\nimport type { Request, Response } from 'express'\nimport type { RateLimitService } from './rate-limit.service'\n\n/**\n * @constant RATE_LIMIT_KEY\n * @description 元数据键，用于存储限流配置\n */\nexport const RATE_LIMIT_KEY = 'rate_limit'\n\n/**\n * @interface RateLimitOptions\n * @description 限流选项\n */\nexport interface RateLimitGuardOptions {\n  /** 时间窗口（秒） */\n  windowMs?: number\n  /** 最大请求数 */\n  max?: number\n  /** 限流键生成器 */\n  keyGenerator?: (request: Request) => string\n  /** 是否跳过成功请求 */\n  skipSuccessfulRequests?: boolean\n  /** 是否跳过失败请求 */\n  skipFailedRequests?: boolean\n  /** 自定义错误消息 */\n  message?: string\n}\n\n/**\n * @decorator RateLimit\n * @description 限流装饰器\n *\n * @example\n * ```typescript\n * @RateLimit({ windowMs: 60, max: 100 })\n * @Get()\n * findAll() {\n *   return this.service.findAll();\n * }\n * ```\n */\nexport const RateLimit = (options: RateLimitGuardOptions = {}) => {\n  return (_target: unknown, _propertyKey: string, descriptor: PropertyDescriptor) => {\n    Reflect.defineMetadata(RATE_LIMIT_KEY, options, descriptor.value)\n  }\n}\n\n/**\n * @guard RateLimitGuard\n * @description 限流守卫\n */\n@Injectable()\nexport class RateLimitGuard implements CanActivate {\n  private readonly logger = new Logger(RateLimitGuard.name)\n\n  constructor(\n    private readonly rateLimitService: RateLimitService,\n    private readonly reflector: Reflector\n  ) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest<Request>()\n    const response = context.switchToHttp().getResponse<Response>()\n\n    // 获取限流配置\n    const options = this.reflector.get<RateLimitGuardOptions>(\n      RATE_LIMIT_KEY,\n      context.getHandler()\n    ) || {\n      windowMs: 60, // 默认 60 秒\n      max: 100, // 默认 100 次请求\n    }\n\n    // 生成限流键\n    const keyGenerator = options.keyGenerator || this.defaultKeyGenerator\n    const key = keyGenerator(request)\n\n    // 检查限流\n    const result = await this.rateLimitService.checkLimit(key, {\n      windowMs: options.windowMs!,\n      max: options.max!,\n    })\n\n    // 设置限流响应头\n    response.setHeader('X-RateLimit-Limit', options.max!)\n    response.setHeader('X-RateLimit-Remaining', result.remaining)\n    response.setHeader('X-RateLimit-Reset', result.resetTime)\n\n    if (!result.allowed) {\n      const message =\n        options.message ||\n        `Rate limit exceeded. Try again in ${Math.ceil(result.retryAfter / 1000)} seconds.`\n\n      this.logger.warn(`Rate limit exceeded for key: ${key}, remaining: ${result.remaining}`)\n\n      throw new HttpException(\n        {\n          statusCode: HttpStatus.TOO_MANY_REQUESTS,\n          message,\n          retryAfter: Math.ceil(result.retryAfter / 1000),\n        },\n        HttpStatus.TOO_MANY_REQUESTS\n      )\n    }\n\n    return true\n  }\n\n  /**\n   * @method defaultKeyGenerator\n   * @description 默认限流键生成器（基于 IP 和用户 ID）\n   */\n  private defaultKeyGenerator(request: Request): string {\n    const ip = request.ip || request.socket.remoteAddress || 'unknown'\n    const userId = (request as { user?: { id?: string } }).user?.id || 'anonymous'\n    const path = request.path\n    return `rate_limit:${ip}:${userId}:${path}`\n  }\n}\n"],"version":3}