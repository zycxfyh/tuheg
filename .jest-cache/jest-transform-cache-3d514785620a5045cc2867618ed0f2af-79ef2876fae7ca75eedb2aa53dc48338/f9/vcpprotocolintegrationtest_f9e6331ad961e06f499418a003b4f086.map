{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\vcptoolbox\\src\\integration-tests\\vcp-protocol-integration.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\vcptoolbox\\src\\integration-tests\\vcp-protocol-integration.test.ts"],"sourcesContent":["// ============================================================================\n// VCP协议核心集成测试\n// 验证 VCPToolBox 协议标准的正确集成\n// ============================================================================\n\nimport { ConfigService } from '@nestjs/config'\nimport { Test, type TestingModule } from '@nestjs/testing'\nimport { VCPProtocolService } from '@tuheg/ai-domain'\n\ndescribe('VCPProtocolService Integration', () => {\n  let service: VCPProtocolService\n  let configService: ConfigService\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        VCPProtocolService,\n        {\n          provide: ConfigService,\n          useValue: {\n            get: jest.fn((key: string, defaultValue?: any) => {\n              const config = {\n                AI_PROVIDER: 'openai',\n                AI_MODEL: 'gpt-4',\n              }\n              return config[key] || defaultValue\n            }),\n          },\n        },\n      ],\n    }).compile()\n\n    service = module.get<VCPProtocolService>(VCPProtocolService)\n    configService = module.get<ConfigService>(ConfigService)\n  })\n\n  it('应该能获取协议统计信息', () => {\n    const stats = service.getProtocolStats()\n\n    expect(stats).toHaveProperty('pendingRequests')\n    expect(stats).toHaveProperty('activeEndpoints')\n    expect(stats).toHaveProperty('queuedMessages')\n    expect(stats).toHaveProperty('activeSubscriptions')\n    expect(typeof stats.pendingRequests).toBe('number')\n  })\n\n  it('应该能执行健康检查', async () => {\n    const health = await service.healthCheck()\n\n    expect(health).toHaveProperty('status')\n    expect(['healthy', 'error']).toContain(health.status)\n\n    if (health.status === 'healthy') {\n      expect(health).toHaveProperty('details')\n    }\n  })\n\n  it('应该能获取可用端点', () => {\n    const endpoints = service.getAvailableEndpoints()\n\n    expect(Array.isArray(endpoints)).toBe(true)\n    // 系统端点应该已经被注册\n    expect(endpoints.length).toBeGreaterThan(0)\n\n    // 检查是否有预期的端点\n    const aiService = endpoints.find((ep) => ep.id === 'ai-service')\n    expect(aiService).toBeDefined()\n    expect(aiService?.capabilities).toContain('text-generation')\n  })\n\n  it('应该能按能力过滤端点', () => {\n    const textGenEndpoints = service.getAvailableEndpoints('text-generation')\n\n    expect(Array.isArray(textGenEndpoints)).toBe(true)\n    textGenEndpoints.forEach((endpoint) => {\n      expect(endpoint.capabilities).toContain('text-generation')\n    })\n  })\n\n  it('应该能注册自定义端点', () => {\n    const customEndpoint = {\n      id: 'custom-endpoint',\n      type: 'tool' as const,\n      url: 'http://custom-tool.com',\n      capabilities: ['custom-analysis'],\n      status: 'online' as const,\n      metadata: {\n        version: '1.0.0',\n        description: 'Custom analysis tool',\n        author: 'test',\n        lastSeen: new Date(),\n      },\n    }\n\n    expect(() => {\n      service.registerEndpoint(customEndpoint)\n    }).not.toThrow()\n\n    const endpoints = service.getAvailableEndpoints('custom-analysis')\n    expect(endpoints.some((ep) => ep.id === 'custom-endpoint')).toBe(true)\n  })\n\n  it('应该能注销端点', () => {\n    // 先注册一个端点\n    const testEndpoint = {\n      id: 'test-endpoint-to-remove',\n      type: 'service' as const,\n      url: 'http://test.com',\n      capabilities: ['test-service'],\n      status: 'online' as const,\n      metadata: {\n        version: '1.0.0',\n        description: 'Test endpoint',\n        author: 'test',\n        lastSeen: new Date(),\n      },\n    }\n\n    service.registerEndpoint(testEndpoint)\n\n    // 确认端点已注册\n    let endpoints = service.getAvailableEndpoints('test-service')\n    expect(endpoints.some((ep) => ep.id === 'test-endpoint-to-remove')).toBe(true)\n\n    // 注销端点\n    service.unregisterEndpoint('test-endpoint-to-remove')\n\n    // 确认端点已移除\n    endpoints = service.getAvailableEndpoints('test-service')\n    expect(endpoints.some((ep) => ep.id === 'test-endpoint-to-remove')).toBe(false)\n  })\n\n  it('应该能调用AI生成工具（模拟）', async () => {\n    const prompt = '写一个简短的故事'\n    const options = {\n      model: 'gpt-4',\n      temperature: 0.7,\n      maxTokens: 500,\n    }\n\n    // 由于没有实际的AI服务，这可能会失败或返回模拟结果\n    await expect(service.callAIGenerationTool(prompt, options)).rejects.toThrow()\n  })\n\n  it('应该能调用分析工具（模拟）', async () => {\n    const content = '这是一个测试文本'\n    const analysisType = 'sentiment'\n\n    await expect(service.callAnalysisTool(content, analysisType)).rejects.toThrow()\n  })\n\n  it('应该能调用翻译工具（模拟）', async () => {\n    const text = 'Hello world'\n    const targetLanguage = 'zh-CN'\n\n    const result = await service.callTranslationTool(text, targetLanguage)\n    // 当前实现可能返回原文本或模拟结果\n    expect(typeof result).toBe('string')\n  })\n\n  it('应该能执行记忆操作（模拟）', async () => {\n    // 这些操作可能会失败，因为没有实际的后端服务\n    await expect(service.readMemory('test-key')).rejects.toThrow()\n    await expect(service.writeMemory('test-key', 'test-value')).rejects.toThrow()\n  })\n\n  it('应该能执行文件操作（模拟）', async () => {\n    const fileData = { content: 'test file content' }\n\n    await expect(service.uploadFile(fileData)).rejects.toThrow()\n    await expect(service.downloadFile('test-file-id')).rejects.toThrow()\n  })\n\n  it('应该能发送叙事生成请求（模拟）', async () => {\n    const storyId = 'test-story-123'\n    const prompt = '写一个科幻故事'\n    const context = { genre: 'sci-fi', length: 'short' }\n\n    const taskId = await service.requestNarrativeGeneration(storyId, prompt, context)\n    expect(typeof taskId).toBe('string')\n    expect(taskId.length).toBeGreaterThan(0)\n  })\n\n  it('应该能发送Agent协作请求（模拟）', async () => {\n    const collaborationId = 'test-collab-123'\n    const agentIds = ['agent1', 'agent2']\n    const task = { type: 'story-writing', priority: 'high' }\n\n    const resultId = await service.requestAgentCollaboration(collaborationId, agentIds, task)\n    expect(typeof resultId).toBe('string')\n  })\n\n  it('应该能广播系统事件（模拟）', async () => {\n    const eventType = 'system.maintenance'\n    const eventData = { message: 'System maintenance scheduled', time: '2024-01-01T00:00:00Z' }\n\n    // 不应该抛出错误\n    await expect(service.broadcastSystemEvent(eventType, eventData)).resolves.not.toThrow()\n  })\n\n  it('应该能清理过期任务', async () => {\n    // 不应该抛出错误\n    await expect(service.cleanupExpiredTasks()).resolves.not.toThrow()\n  })\n})\n"],"version":3}