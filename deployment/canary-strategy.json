{
  "version": "1.0.0",
  "strategy": "canary",
  "description": "金丝雀部署策略配置",

  "traffic_distribution": {
    "stages": [
      {
        "stage": 1,
        "percentage": 1,
        "duration_minutes": 15,
        "monitoring_window_minutes": 15,
        "rollback_thresholds": {
          "error_rate_5xx": 0.01,
          "response_time_p95": 2.0,
          "cpu_usage": 80,
          "memory_usage": 85
        },
        "description": "1%流量验证基础功能"
      },
      {
        "stage": 2,
        "percentage": 5,
        "duration_minutes": 15,
        "monitoring_window_minutes": 15,
        "rollback_thresholds": {
          "error_rate_5xx": 0.02,
          "response_time_p95": 2.0,
          "cpu_usage": 80,
          "memory_usage": 85
        },
        "description": "5%流量验证并发处理能力"
      },
      {
        "stage": 3,
        "percentage": 20,
        "duration_minutes": 30,
        "monitoring_window_minutes": 30,
        "rollback_thresholds": {
          "error_rate_5xx": 0.02,
          "response_time_p95": 2.0,
          "cpu_usage": 80,
          "memory_usage": 85
        },
        "description": "20%流量验证业务逻辑正确性",
        "requires_manual_approval": true
      },
      {
        "stage": 4,
        "percentage": 100,
        "duration_minutes": 1440,
        "monitoring_window_minutes": 1440,
        "rollback_thresholds": {
          "error_rate_5xx": 0.05,
          "response_time_p95": 5.0,
          "cpu_usage": 90,
          "memory_usage": 90
        },
        "description": "100%流量完全替换旧版本"
      }
    ]
  },

  "services": {
    "backend-gateway": {
      "health_check_endpoint": "/health",
      "metrics_endpoint": "/metrics",
      "readiness_probe": {
        "path": "/health",
        "initialDelaySeconds": 30,
        "periodSeconds": 10,
        "timeoutSeconds": 5,
        "failureThreshold": 3
      },
      "liveness_probe": {
        "path": "/health",
        "initialDelaySeconds": 60,
        "periodSeconds": 30,
        "timeoutSeconds": 10,
        "failureThreshold": 3
      }
    },
    "creation-agent": {
      "health_check_endpoint": "/health",
      "depends_on": ["backend-gateway"],
      "startup_probe": {
        "path": "/health",
        "initialDelaySeconds": 10,
        "periodSeconds": 5,
        "timeoutSeconds": 3,
        "failureThreshold": 6
      }
    },
    "logic-agent": {
      "health_check_endpoint": "/health",
      "depends_on": ["backend-gateway"]
    },
    "narrative-agent": {
      "health_check_endpoint": "/health",
      "depends_on": ["backend-gateway"]
    }
  },

  "monitoring": {
    "prometheus_endpoint": "http://prometheus:9090",
    "grafana_endpoint": "http://grafana:3000",
    "alertmanager_endpoint": "http://alertmanager:9093",

    "key_metrics": [
      "http_requests_total",
      "http_request_duration_seconds",
      "process_cpu_user_seconds_total",
      "process_resident_memory_bytes",
      "go_gc_duration_seconds"
    ],

    "alert_rules": {
      "high_error_rate": {
        "condition": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m]) > 0.05",
        "for": "5m",
        "severity": "warning",
        "description": "5xx错误率超过5%"
      },
      "high_response_time": {
        "condition": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2",
        "for": "5m",
        "severity": "warning",
        "description": "95%响应时间超过2秒"
      },
      "service_down": {
        "condition": "up == 0",
        "for": "1m",
        "severity": "critical",
        "description": "服务完全不可用"
      }
    }
  },

  "rollback": {
    "automatic_rollback_enabled": true,
    "manual_approval_required": true,
    "rollback_timeout_seconds": 600,
    "backup_replicas": 3,
    "data_backup_retention_days": 7
  },

  "notifications": {
    "slack": {
      "webhook_url": "${SLACK_WEBHOOK_URL}",
      "channels": {
        "deployments": "#deployments",
        "alerts": "#alerts",
        "emergency": "#emergency"
      }
    },
    "email": {
      "smtp_server": "${SMTP_SERVER}",
      "recipients": [
        "devops@tuheg.com",
        "tech-lead@tuheg.com"
      ]
    }
  },

  "environments": {
    "staging": {
      "namespace": "staging",
      "ingress_class": "nginx-staging",
      "domain": "staging.tuheg.com",
      "replicas": {
        "backend-gateway": 1,
        "creation-agent": 1,
        "logic-agent": 1,
        "narrative-agent": 1
      }
    },
    "production": {
      "namespace": "production",
      "ingress_class": "nginx",
      "domain": "api.tuheg.com",
      "replicas": {
        "backend-gateway": 3,
        "creation-agent": 2,
        "logic-agent": 2,
        "narrative-agent": 2
      }
    }
  }
}
