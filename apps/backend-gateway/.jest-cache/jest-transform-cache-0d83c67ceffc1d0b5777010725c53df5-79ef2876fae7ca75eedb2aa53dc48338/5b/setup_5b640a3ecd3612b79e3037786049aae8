cf0db3a0e03616f12615fa79d847be3c
"use strict";
/**
 * Jest 全局测试设置
 * 配置测试环境的快速失败机制和最佳实践
 */
// Mock ESM modules that cause issues in Jest
jest.mock('langfuse', () => ({
    Langfuse: jest.fn().mockImplementation(() => ({
        trace: jest.fn(),
        generation: jest.fn(),
        span: jest.fn(),
        score: jest.fn(),
        shutdownAsync: jest.fn().mockResolvedValue(undefined),
    })),
}));
// 设置更严格的超时
// @ts-expect-error - Jest is available globally in test environment
jest.setTimeout(30000);
// 启用全局fake timers以避免定时器相关警告
// @ts-expect-error - Jest is available globally in test environment
jest.useFakeTimers({ enableGlobally: true });
// 全局错误处理 - 任何未处理的错误都会导致测试失败
process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason);
    // 在测试环境中，让未处理的promise rejection导致测试失败
    throw new Error(`Unhandled promise rejection: ${reason}`);
});
process.on('uncaughtException', (error) => {
    console.error('Uncaught Exception:', error);
    // 在测试环境中，让未处理的异常导致测试失败
    throw error;
});
// 配置控制台警告 - 将console.error转换为测试失败
const originalConsoleError = console.error;
console.error = (...args) => {
    originalConsoleError(...args);
    // 在CI环境中，将console.error转换为测试失败
    if (process.env.CI) {
        throw new Error(`Console error detected: ${args.join(' ')}`);
    }
};
// Mock 全局对象以防止意外的网络调用
global.fetch = jest.fn(() => Promise.reject(new Error('fetch should be mocked in tests')));
global.Request = jest.fn();
global.Response = jest.fn();
// 设置环境变量用于测试
process.env.NODE_ENV = 'test';
process.env.JWT_SECRET = 'test-jwt-secret-for-testing-only';
process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test_db';
// 补齐缺失的环境变量
process.env.ENCRYPTION_KEY = 'test-encryption-key-32-characters-long';
process.env.ENCRYPTION_SALT = 'test-encryption-salt-16-chars';
process.env.ENCRYPTION_USE_SALT = 'false';
process.env.ENCRYPTION_ALGORITHM = 'aes-256-gcm';
process.env.CLERK_SECRET_KEY = 'test-clerk-secret-key';
process.env.CLERK_PUBLISHABLE_KEY = 'test-clerk-publishable-key';
process.env.CLERK_WEBHOOK_SECRET_KEY = 'test-clerk-webhook-secret';
process.env.RABBITMQ_URL = 'amqp://localhost:5672';
process.env.REDIS_URL = 'redis://localhost:6379';
process.env.SENTRY_DSN = 'https://test@test.ingest.sentry.io/test';
process.env.SENTRY_ENVIRONMENT = 'test';
process.env.SENTRY_TRACES_SAMPLE_RATE = '0.1';
process.env.QDRANT_URL = 'http://localhost:6333';
process.env.QDRANT_API_KEY = 'test-qdrant-api-key';
process.env.FALLBACK_API_KEY = 'test-fallback-api-key';
process.env.FALLBACK_MODEL_ID = 'deepseek-chat';
process.env.FALLBACK_BASE_URL = 'https://api.deepseek.com';
process.env.DB_CONNECTION_LIMIT = '20';
process.env.DB_POOL_TIMEOUT = '20';
process.env.DB_IDLE_TIMEOUT = '300';
process.env.JWT_EXPIRATION_SECONDS = '3600';
process.env.BACKEND_GATEWAY_PORT = '3000';
process.env.CREATION_AGENT_HTTP_PORT = '8080';
process.env.LOGIC_AGENT_HTTP_PORT = '8081';
process.env.NARRATIVE_AGENT_HTTP_PORT = '8082';
// 清理函数 - 在每个测试后运行
afterEach(() => {
    // 重置所有mock
    jest.clearAllMocks();
    // 清理任何可能的文件系统更改（如果适用）
    // 注意：实际的文件系统操作应该在集成测试中进行
    // 检查是否有未处理的异步操作
    if (jest.getTimerCount() > 0) {
        console.warn(`Warning: ${jest.getTimerCount()} timers still active after test`);
    }
});
afterAll(async () => {
    // 清理测试资源
    jest.clearAllMocks();
}, 5000);
// 自定义匹配器
expect.extend({
    toBeValidDate(received) {
        const pass = received instanceof Date && !Number.isNaN(received.getTime());
        if (pass) {
            return {
                message: () => `expected ${received} not to be a valid date`,
                pass: true,
            };
        }
        else {
            return {
                message: () => `expected ${received} to be a valid date`,
                pass: false,
            };
        }
    },
    toBeValidUUID(received) {
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        const pass = typeof received === 'string' && uuidRegex.test(received);
        if (pass) {
            return {
                message: () => `expected ${received} not to be a valid UUID`,
                pass: true,
            };
        }
        else {
            return {
                message: () => `expected ${received} to be a valid UUID`,
                pass: false,
            };
        }
    },
});
// 内存使用监控
if (process.env.CI) {
    const initialMemory = process.memoryUsage();
    const memoryThreshold = 500 * 1024 * 1024; // 500MB
    afterEach(() => {
        const currentMemory = process.memoryUsage();
        const memoryIncrease = currentMemory.heapUsed - initialMemory.heapUsed;
        if (memoryIncrease > memoryThreshold) {
            console.warn(`Warning: Memory usage increased by ${Math.round(memoryIncrease / 1024 / 1024)}MB`);
        }
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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RyxJQUFJLENBQUMsSUFBSSxDQUNuRixDQUFBO1FBQ0gsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXDE2NjYzXFxEZXNrdG9wXFx0dWhlZ1xcdGVzdHNcXHNldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSmVzdCDlhajlsYDmtYvor5Xorr7nva5cbiAqIOmFjee9rua1i+ivleeOr+Wig+eahOW/q+mAn+Wksei0peacuuWItuWSjOacgOS9s+Wunui3tVxuICovXG5cbi8vIOiuvue9ruabtOS4peagvOeahOi2heaXtlxuLy8gQHRzLWV4cGVjdC1lcnJvciAtIEplc3QgaXMgYXZhaWxhYmxlIGdsb2JhbGx5IGluIHRlc3QgZW52aXJvbm1lbnRcbmplc3Quc2V0VGltZW91dCgzMDAwMClcblxuLy8g5ZCv55So5YWo5bGAZmFrZSB0aW1lcnPku6Xpgb/lhY3lrprml7blmajnm7jlhbPorablkYpcbi8vIEB0cy1leHBlY3QtZXJyb3IgLSBKZXN0IGlzIGF2YWlsYWJsZSBnbG9iYWxseSBpbiB0ZXN0IGVudmlyb25tZW50XG5qZXN0LnVzZUZha2VUaW1lcnMoeyBlbmFibGVHbG9iYWxseTogdHJ1ZSB9KVxuXG4vLyDlhajlsYDplJnor6/lpITnkIYgLSDku7vkvZXmnKrlpITnkIbnmoTplJnor6/pg73kvJrlr7zoh7TmtYvor5XlpLHotKVcbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChyZWFzb24sIHByb21pc2UpID0+IHtcbiAgY29uc29sZS5lcnJvcignVW5oYW5kbGVkIFJlamVjdGlvbiBhdDonLCBwcm9taXNlLCAncmVhc29uOicsIHJlYXNvbilcbiAgLy8g5Zyo5rWL6K+V546v5aKD5Lit77yM6K6p5pyq5aSE55CG55qEcHJvbWlzZSByZWplY3Rpb27lr7zoh7TmtYvor5XlpLHotKVcbiAgdGhyb3cgbmV3IEVycm9yKGBVbmhhbmRsZWQgcHJvbWlzZSByZWplY3Rpb246ICR7cmVhc29ufWApXG59KVxuXG5wcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIChlcnJvcikgPT4ge1xuICBjb25zb2xlLmVycm9yKCdVbmNhdWdodCBFeGNlcHRpb246JywgZXJyb3IpXG4gIC8vIOWcqOa1i+ivleeOr+Wig+S4re+8jOiuqeacquWkhOeQhueahOW8guW4uOWvvOiHtOa1i+ivleWksei0pVxuICB0aHJvdyBlcnJvclxufSlcblxuLy8g6YWN572u5o6n5Yi25Y+w6K2m5ZGKIC0g5bCGY29uc29sZS5lcnJvcui9rOaNouS4uua1i+ivleWksei0pVxuY29uc3Qgb3JpZ2luYWxDb25zb2xlRXJyb3IgPSBjb25zb2xlLmVycm9yXG5jb25zb2xlLmVycm9yID0gKC4uLmFyZ3M6IGFueVtdKSA9PiB7XG4gIG9yaWdpbmFsQ29uc29sZUVycm9yKC4uLmFyZ3MpXG4gIC8vIOWcqENJ546v5aKD5Lit77yM5bCGY29uc29sZS5lcnJvcui9rOaNouS4uua1i+ivleWksei0pVxuICBpZiAocHJvY2Vzcy5lbnYuQ0kpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvbnNvbGUgZXJyb3IgZGV0ZWN0ZWQ6ICR7YXJncy5qb2luKCcgJyl9YClcbiAgfVxufVxuXG4vLyBNb2NrIOWFqOWxgOWvueixoeS7pemYsuatouaEj+WklueahOe9kee7nOiwg+eUqFxuZ2xvYmFsLmZldGNoID0gamVzdC5mbigoKSA9PiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ2ZldGNoIHNob3VsZCBiZSBtb2NrZWQgaW4gdGVzdHMnKSkpXG5cbmdsb2JhbC5SZXF1ZXN0ID0gamVzdC5mbigpXG5nbG9iYWwuUmVzcG9uc2UgPSBqZXN0LmZuKClcblxuLy8gTW9jayBFU00gbW9kdWxlcyB0aGF0IGNhdXNlIGlzc3VlcyBpbiBKZXN0XG5qZXN0Lm1vY2soJ2xhbmdmdXNlJywgKCkgPT4gKHtcbiAgTGFuZ2Z1c2U6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICB0cmFjZTogamVzdC5mbigpLFxuICAgIGdlbmVyYXRpb246IGplc3QuZm4oKSxcbiAgICBzcGFuOiBqZXN0LmZuKCksXG4gICAgc2NvcmU6IGplc3QuZm4oKSxcbiAgICBzaHV0ZG93bkFzeW5jOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgfSkpLFxufSkpXG5cbi8vIOiuvue9rueOr+Wig+WPmOmHj+eUqOS6jua1i+ivlVxucHJvY2Vzcy5lbnYuTk9ERV9FTlYgPSAndGVzdCdcbnByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSAndGVzdC1qd3Qtc2VjcmV0LWZvci10ZXN0aW5nLW9ubHknXG5wcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwgPSAncG9zdGdyZXNxbDovL3Rlc3Q6dGVzdEBsb2NhbGhvc3Q6NTQzMi90ZXN0X2RiJ1xuXG4vLyDooaXpvZDnvLrlpLHnmoTnjq/looPlj5jph49cbnByb2Nlc3MuZW52LkVOQ1JZUFRJT05fS0VZID0gJ3Rlc3QtZW5jcnlwdGlvbi1rZXktMzItY2hhcmFjdGVycy1sb25nJ1xucHJvY2Vzcy5lbnYuRU5DUllQVElPTl9TQUxUID0gJ3Rlc3QtZW5jcnlwdGlvbi1zYWx0LTE2LWNoYXJzJ1xucHJvY2Vzcy5lbnYuRU5DUllQVElPTl9VU0VfU0FMVCA9ICdmYWxzZSdcbnByb2Nlc3MuZW52LkVOQ1JZUFRJT05fQUxHT1JJVEhNID0gJ2Flcy0yNTYtZ2NtJ1xucHJvY2Vzcy5lbnYuQ0xFUktfU0VDUkVUX0tFWSA9ICd0ZXN0LWNsZXJrLXNlY3JldC1rZXknXG5wcm9jZXNzLmVudi5DTEVSS19QVUJMSVNIQUJMRV9LRVkgPSAndGVzdC1jbGVyay1wdWJsaXNoYWJsZS1rZXknXG5wcm9jZXNzLmVudi5DTEVSS19XRUJIT09LX1NFQ1JFVF9LRVkgPSAndGVzdC1jbGVyay13ZWJob29rLXNlY3JldCdcbnByb2Nlc3MuZW52LlJBQkJJVE1RX1VSTCA9ICdhbXFwOi8vbG9jYWxob3N0OjU2NzInXG5wcm9jZXNzLmVudi5SRURJU19VUkwgPSAncmVkaXM6Ly9sb2NhbGhvc3Q6NjM3OSdcbnByb2Nlc3MuZW52LlNFTlRSWV9EU04gPSAnaHR0cHM6Ly90ZXN0QHRlc3QuaW5nZXN0LnNlbnRyeS5pby90ZXN0J1xucHJvY2Vzcy5lbnYuU0VOVFJZX0VOVklST05NRU5UID0gJ3Rlc3QnXG5wcm9jZXNzLmVudi5TRU5UUllfVFJBQ0VTX1NBTVBMRV9SQVRFID0gJzAuMSdcbnByb2Nlc3MuZW52LlFEUkFOVF9VUkwgPSAnaHR0cDovL2xvY2FsaG9zdDo2MzMzJ1xucHJvY2Vzcy5lbnYuUURSQU5UX0FQSV9LRVkgPSAndGVzdC1xZHJhbnQtYXBpLWtleSdcbnByb2Nlc3MuZW52LkZBTExCQUNLX0FQSV9LRVkgPSAndGVzdC1mYWxsYmFjay1hcGkta2V5J1xucHJvY2Vzcy5lbnYuRkFMTEJBQ0tfTU9ERUxfSUQgPSAnZGVlcHNlZWstY2hhdCdcbnByb2Nlc3MuZW52LkZBTExCQUNLX0JBU0VfVVJMID0gJ2h0dHBzOi8vYXBpLmRlZXBzZWVrLmNvbSdcbnByb2Nlc3MuZW52LkRCX0NPTk5FQ1RJT05fTElNSVQgPSAnMjAnXG5wcm9jZXNzLmVudi5EQl9QT09MX1RJTUVPVVQgPSAnMjAnXG5wcm9jZXNzLmVudi5EQl9JRExFX1RJTUVPVVQgPSAnMzAwJ1xucHJvY2Vzcy5lbnYuSldUX0VYUElSQVRJT05fU0VDT05EUyA9ICczNjAwJ1xucHJvY2Vzcy5lbnYuQkFDS0VORF9HQVRFV0FZX1BPUlQgPSAnMzAwMCdcbnByb2Nlc3MuZW52LkNSRUFUSU9OX0FHRU5UX0hUVFBfUE9SVCA9ICc4MDgwJ1xucHJvY2Vzcy5lbnYuTE9HSUNfQUdFTlRfSFRUUF9QT1JUID0gJzgwODEnXG5wcm9jZXNzLmVudi5OQVJSQVRJVkVfQUdFTlRfSFRUUF9QT1JUID0gJzgwODInXG5cbi8vIOa4heeQhuWHveaVsCAtIOWcqOavj+S4qua1i+ivleWQjui/kOihjFxuYWZ0ZXJFYWNoKCgpID0+IHtcbiAgLy8g6YeN572u5omA5pyJbW9ja1xuICBqZXN0LmNsZWFyQWxsTW9ja3MoKVxuXG4gIC8vIOa4heeQhuS7u+S9leWPr+iDveeahOaWh+S7tuezu+e7n+abtOaUue+8iOWmguaenOmAgueUqO+8iVxuICAvLyDms6jmhI/vvJrlrp7pmYXnmoTmlofku7bns7vnu5/mk43kvZzlupTor6XlnKjpm4bmiJDmtYvor5XkuK3ov5vooYxcblxuICAvLyDmo4Dmn6XmmK/lkKbmnInmnKrlpITnkIbnmoTlvILmraXmk43kvZxcbiAgaWYgKGplc3QuZ2V0VGltZXJDb3VudCgpID4gMCkge1xuICAgIGNvbnNvbGUud2FybihgV2FybmluZzogJHtqZXN0LmdldFRpbWVyQ291bnQoKX0gdGltZXJzIHN0aWxsIGFjdGl2ZSBhZnRlciB0ZXN0YClcbiAgfVxufSlcblxuYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAvLyDmuIXnkIbmtYvor5XotYTmupBcbiAgamVzdC5jbGVhckFsbE1vY2tzKClcbn0sIDUwMDApXG5cbi8vIOiHquWumuS5ieWMuemFjeWZqFxuZXhwZWN0LmV4dGVuZCh7XG4gIHRvQmVWYWxpZERhdGUocmVjZWl2ZWQ6IGFueSkge1xuICAgIGNvbnN0IHBhc3MgPSByZWNlaXZlZCBpbnN0YW5jZW9mIERhdGUgJiYgIU51bWJlci5pc05hTihyZWNlaXZlZC5nZXRUaW1lKCkpXG4gICAgaWYgKHBhc3MpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG1lc3NhZ2U6ICgpID0+IGBleHBlY3RlZCAke3JlY2VpdmVkfSBub3QgdG8gYmUgYSB2YWxpZCBkYXRlYCxcbiAgICAgICAgcGFzczogdHJ1ZSxcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbWVzc2FnZTogKCkgPT4gYGV4cGVjdGVkICR7cmVjZWl2ZWR9IHRvIGJlIGEgdmFsaWQgZGF0ZWAsXG4gICAgICAgIHBhc3M6IGZhbHNlLFxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICB0b0JlVmFsaWRVVUlEKHJlY2VpdmVkOiBhbnkpIHtcbiAgICBjb25zdCB1dWlkUmVnZXggPSAvXlswLTlhLWZdezh9LVswLTlhLWZdezR9LVsxLTVdWzAtOWEtZl17M30tWzg5YWJdWzAtOWEtZl17M30tWzAtOWEtZl17MTJ9JC9pXG4gICAgY29uc3QgcGFzcyA9IHR5cGVvZiByZWNlaXZlZCA9PT0gJ3N0cmluZycgJiYgdXVpZFJlZ2V4LnRlc3QocmVjZWl2ZWQpXG4gICAgaWYgKHBhc3MpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG1lc3NhZ2U6ICgpID0+IGBleHBlY3RlZCAke3JlY2VpdmVkfSBub3QgdG8gYmUgYSB2YWxpZCBVVUlEYCxcbiAgICAgICAgcGFzczogdHJ1ZSxcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbWVzc2FnZTogKCkgPT4gYGV4cGVjdGVkICR7cmVjZWl2ZWR9IHRvIGJlIGEgdmFsaWQgVVVJRGAsXG4gICAgICAgIHBhc3M6IGZhbHNlLFxuICAgICAgfVxuICAgIH1cbiAgfSxcbn0pXG5cbi8vIOWvvOWHuuexu+Wei+S7peS+v+WcqOa1i+ivleS4reS9v+eUqFxuZGVjbGFyZSBnbG9iYWwge1xuICBuYW1lc3BhY2UgamVzdCB7XG4gICAgaW50ZXJmYWNlIE1hdGNoZXJzPFI+IHtcbiAgICAgIHRvQmVWYWxpZERhdGUoKTogUlxuICAgICAgdG9CZVZhbGlkVVVJRCgpOiBSXG4gICAgfVxuICB9XG59XG5cbi8vIOWGheWtmOS9v+eUqOebkeaOp1xuaWYgKHByb2Nlc3MuZW52LkNJKSB7XG4gIGNvbnN0IGluaXRpYWxNZW1vcnkgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKClcbiAgY29uc3QgbWVtb3J5VGhyZXNob2xkID0gNTAwICogMTAyNCAqIDEwMjQgLy8gNTAwTUJcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGNvbnN0IGN1cnJlbnRNZW1vcnkgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKClcbiAgICBjb25zdCBtZW1vcnlJbmNyZWFzZSA9IGN1cnJlbnRNZW1vcnkuaGVhcFVzZWQgLSBpbml0aWFsTWVtb3J5LmhlYXBVc2VkXG5cbiAgICBpZiAobWVtb3J5SW5jcmVhc2UgPiBtZW1vcnlUaHJlc2hvbGQpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgYFdhcm5pbmc6IE1lbW9yeSB1c2FnZSBpbmNyZWFzZWQgYnkgJHtNYXRoLnJvdW5kKG1lbW9yeUluY3JlYXNlIC8gMTAyNCAvIDEwMjQpfU1CYFxuICAgICAgKVxuICAgIH1cbiAgfSlcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==