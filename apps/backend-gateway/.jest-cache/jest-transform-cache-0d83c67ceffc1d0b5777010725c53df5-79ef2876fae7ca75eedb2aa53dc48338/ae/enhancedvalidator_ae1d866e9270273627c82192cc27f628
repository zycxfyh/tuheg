30af3f09a6977c6a5db4f6254d0fe74a
"use strict";
// 文件路径: packages/common-backend/src/validation/enhanced-validator.ts
// 核心理念: 类型即文档，运行时验证，友好的错误消息
Object.defineProperty(exports, "__esModule", { value: true });
exports.EnhancedValidator = void 0;
const zod_1 = require("zod");
/**
 * @class EnhancedValidator
 * @description 增强的验证器，提供 Pydantic 风格的友好错误消息
 */
// biome-ignore lint/complexity/noStaticOnlyClass: 这个类包含了验证相关的静态方法，适合作为工具类
class EnhancedValidator {
    /**
     * @method validate
     * @description 验证数据
     * @param schema - Zod schema
     * @param data - 要验证的数据
     * @returns 验证结果
     */
    static validate(schema, data) {
        try {
            const parsed = schema.parse(data);
            return {
                success: true,
                data: parsed,
            };
        }
        catch (error) {
            if (error instanceof zod_1.z.ZodError) {
                return {
                    success: false,
                    errors: EnhancedValidator.formatZodErrors(error),
                };
            }
            return {
                success: false,
                errors: [
                    {
                        path: [],
                        message: error instanceof Error ? error.message : String(error),
                        code: 'UNKNOWN_ERROR',
                    },
                ],
            };
        }
    }
    /**
     * @method validateAsync
     * @description 异步验证数据（支持异步验证规则）
     * @param schema - Zod schema
     * @param data - 要验证的数据
     * @returns 验证结果 Promise
     */
    static async validateAsync(schema, data) {
        try {
            const parsed = await schema.parseAsync(data);
            return {
                success: true,
                data: parsed,
            };
        }
        catch (error) {
            if (error instanceof zod_1.z.ZodError) {
                return {
                    success: false,
                    errors: EnhancedValidator.formatZodErrors(error),
                };
            }
            return {
                success: false,
                errors: [
                    {
                        path: [],
                        message: error instanceof Error ? error.message : String(error),
                        code: 'UNKNOWN_ERROR',
                    },
                ],
            };
        }
    }
    /**
     * @method safeParse
     * @description 安全解析（不抛出异常）
     * @param schema - Zod schema
     * @param data - 要验证的数据
     * @returns 验证结果
     */
    static safeParse(schema, data) {
        const result = schema.safeParse(data);
        if (result.success) {
            return {
                success: true,
                data: result.data,
            };
        }
        return {
            success: false,
            errors: EnhancedValidator.formatZodErrors(result.error),
        };
    }
    /**
     * @method formatZodErrors
     * @description 格式化 Zod 错误为友好的错误消息
     */
    static formatZodErrors(error) {
        return error.errors.map((err) => {
            const validationError = {
                path: err.path,
                message: EnhancedValidator.formatErrorMessage(err),
                code: err.code,
            };
            // 添加类型信息
            if (err.code === 'invalid_type') {
                validationError.expected = err.expected;
                validationError.received = err.received;
            }
            // 添加约束信息
            if (err.code === 'too_small' || err.code === 'too_big') {
                const constraintErr = err;
                validationError.expected = `minimum: ${constraintErr.minimum ?? 'N/A'}, maximum: ${constraintErr.maximum ?? 'N/A'}`;
                validationError.received = constraintErr.received;
            }
            return validationError;
        });
    }
    /**
     * @method formatErrorMessage
     * @description 格式化错误消息，使其更友好
     */
    static formatErrorMessage(err) {
        const path = err.path.length > 0 ? err.path.join('.') : 'root';
        switch (err.code) {
            case 'invalid_type':
                return `${path}: 期望类型 "${err.expected}"，但收到类型 "${err.received}"`;
            case 'invalid_string':
                if (err.validation === 'email') {
                    return `${path}: 无效的电子邮件地址`;
                }
                if (err.validation === 'url') {
                    return `${path}: 无效的 URL`;
                }
                if (err.validation === 'uuid') {
                    return `${path}: 无效的 UUID`;
                }
                return `${path}: 字符串验证失败`;
            case 'too_small':
                if (err.type === 'string') {
                    return `${path}: 字符串长度至少为 ${err.minimum} 个字符`;
                }
                if (err.type === 'number') {
                    return `${path}: 数值必须大于或等于 ${err.minimum}`;
                }
                if (err.type === 'array') {
                    return `${path}: 数组至少需要 ${err.minimum} 个元素`;
                }
                return `${path}: 值太小（最小: ${err.minimum}）`;
            case 'too_big':
                if (err.type === 'string') {
                    return `${path}: 字符串长度不能超过 ${err.maximum} 个字符`;
                }
                if (err.type === 'number') {
                    return `${path}: 数值不能超过 ${err.maximum}`;
                }
                if (err.type === 'array') {
                    return `${path}: 数组最多只能包含 ${err.maximum} 个元素`;
                }
                return `${path}: 值太大（最大: ${err.maximum}）`;
            case 'invalid_enum_value':
                return `${path}: 无效的枚举值。允许的值: ${err.options?.join(', ') ?? 'N/A'}`;
            case 'invalid_literal':
                return `${path}: 必须是字面量值 "${err.expected}"`;
            case 'unrecognized_keys':
                return `${path}: 未知的键: ${err.keys.join(', ')}`;
            case 'invalid_union':
                return `${path}: 值不匹配任何联合类型选项`;
            case 'invalid_date':
                return `${path}: 无效的日期格式`;
            case 'custom':
                return err.message ?? `${path}: 自定义验证失败`;
            default:
                return err.message ?? `${path}: 验证失败`;
        }
    }
    /**
     * @method formatErrorsAsString
     * @description 将错误格式化为字符串（用于日志或用户消息）
     */
    static formatErrorsAsString(errors) {
        return errors
            .map((err) => {
            const path = err.path.length > 0 ? err.path.join('.') : 'root';
            let message = `${path}: ${err.message}`;
            if (err.expected) {
                message += ` (期望: ${err.expected})`;
            }
            if (err.received !== undefined) {
                message += ` (收到: ${JSON.stringify(err.received)})`;
            }
            return message;
        })
            .join('\n');
    }
}
exports.EnhancedValidator = EnhancedValidator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFwxNjY2M1xcRGVza3RvcFxcdHVoZWdcXHBhY2thZ2VzXFxjb21tb24tYmFja2VuZFxcc3JjXFx2YWxpZGF0aW9uXFxlbmhhbmNlZC12YWxpZGF0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHFFQUFxRTtBQUNyRSw0QkFBNEI7OztBQUc1Qiw2QkFBdUI7QUFrQ3ZCOzs7R0FHRztBQUNILDBFQUEwRTtBQUMxRSxNQUFhLGlCQUFpQjtJQUM1Qjs7Ozs7O09BTUc7SUFDSSxNQUFNLENBQUMsUUFBUSxDQUFJLE1BQW9CLEVBQUUsSUFBYTtRQUMzRCxJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ2pDLE9BQU87Z0JBQ0wsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsSUFBSSxFQUFFLE1BQU07YUFDYixDQUFBO1FBQ0gsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLEtBQUssWUFBWSxPQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ2hDLE9BQU87b0JBQ0wsT0FBTyxFQUFFLEtBQUs7b0JBQ2QsTUFBTSxFQUFFLGlCQUFpQixDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUM7aUJBQ2pELENBQUE7WUFDSCxDQUFDO1lBRUQsT0FBTztnQkFDTCxPQUFPLEVBQUUsS0FBSztnQkFDZCxNQUFNLEVBQUU7b0JBQ047d0JBQ0UsSUFBSSxFQUFFLEVBQUU7d0JBQ1IsT0FBTyxFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7d0JBQy9ELElBQUksRUFBRSxlQUFlO3FCQUN0QjtpQkFDRjthQUNGLENBQUE7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNJLE1BQU0sQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUMvQixNQUFvQixFQUNwQixJQUFhO1FBRWIsSUFBSSxDQUFDO1lB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LE1BQU07YUFDVixHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNYLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtZQUM5RCxJQUFJLE9BQU8sR0FBRyxHQUFHLElBQUksS0FBSyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUE7WUFFdkMsSUFBSSxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ2pCLE9BQU8sSUFBSSxTQUFTLEdBQUcsQ0FBQyxRQUFRLEdBQUcsQ0FBQTtZQUNyQyxDQUFDO1lBRUQsSUFBSSxHQUFHLENBQUMsUUFBUSxLQUFLLFNBQVMsRUFBRSxDQUFDO2dCQUMvQixPQUFPLElBQUksU0FBUyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFBO1lBQ3JELENBQUM7WUFFRCxPQUFPLE9BQU8sQ0FBQTtRQUNoQixDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDZixDQUFDO0NBQ0Y7QUExTkQsOENBME5DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcMTY2NjNcXERlc2t0b3BcXHR1aGVnXFxwYWNrYWdlc1xcY29tbW9uLWJhY2tlbmRcXHNyY1xcdmFsaWRhdGlvblxcZW5oYW5jZWQtdmFsaWRhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIOaWh+S7tui3r+W+hDogcGFja2FnZXMvY29tbW9uLWJhY2tlbmQvc3JjL3ZhbGlkYXRpb24vZW5oYW5jZWQtdmFsaWRhdG9yLnRzXG4vLyDmoLjlv4PnkIblv7U6IOexu+Wei+WNs+aWh+aho++8jOi/kOihjOaXtumqjOivge+8jOWPi+WlveeahOmUmeivr+a2iOaBr1xuXG5pbXBvcnQgdHlwZSB7IFpvZEVycm9yLCBab2RTY2hlbWEgfSBmcm9tICd6b2QnXG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJ1xuXG4vKipcbiAqIEBpbnRlcmZhY2UgVmFsaWRhdGlvblJlc3VsdFxuICogQGRlc2NyaXB0aW9uIOmqjOivgee7k+aenFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFZhbGlkYXRpb25SZXN1bHQ8VD4ge1xuICAvKiog6aqM6K+B5piv5ZCm5oiQ5YqfICovXG4gIHN1Y2Nlc3M6IGJvb2xlYW5cbiAgLyoqIOmqjOivgeWQjueahOaVsOaNru+8iOWmguaenOaIkOWKn++8iSAqL1xuICBkYXRhPzogVFxuICAvKiog6aqM6K+B6ZSZ6K+v77yI5aaC5p6c5aSx6LSl77yJICovXG4gIGVycm9ycz86IFZhbGlkYXRpb25FcnJvcltdXG59XG5cbi8qKlxuICogQGludGVyZmFjZSBWYWxpZGF0aW9uRXJyb3JcbiAqIEBkZXNjcmlwdGlvbiDpqozor4HplJnor6/or6bmg4VcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBWYWxpZGF0aW9uRXJyb3Ige1xuICAvKiog5a2X5q616Lev5b6EICovXG4gIHBhdGg6IChzdHJpbmcgfCBudW1iZXIpW11cbiAgLyoqIOmUmeivr+a2iOaBryAqL1xuICBtZXNzYWdlOiBzdHJpbmdcbiAgLyoqIOmUmeivr+S7o+eggSAqL1xuICBjb2RlOiBzdHJpbmdcbiAgLyoqIOacn+acm+eahOexu+Wei+aIluWAvCAqL1xuICBleHBlY3RlZD86IHN0cmluZ1xuICAvKiog5a6e6ZmF5pS25Yiw55qE5YC8ICovXG4gIHJlY2VpdmVkPzogdW5rbm93blxuICAvKiog5bWM5aWX6ZSZ6K+v77yI5aaC5p6c5pyJ77yJICovXG4gIG5lc3RlZD86IFZhbGlkYXRpb25FcnJvcltdXG59XG5cbi8qKlxuICogQGNsYXNzIEVuaGFuY2VkVmFsaWRhdG9yXG4gKiBAZGVzY3JpcHRpb24g5aKe5by655qE6aqM6K+B5Zmo77yM5o+Q5L6bIFB5ZGFudGljIOmjjuagvOeahOWPi+WlvemUmeivr+a2iOaBr1xuICovXG4vLyBiaW9tZS1pZ25vcmUgbGludC9jb21wbGV4aXR5L25vU3RhdGljT25seUNsYXNzOiDov5nkuKrnsbvljIXlkKvkuobpqozor4Hnm7jlhbPnmoTpnZnmgIHmlrnms5XvvIzpgILlkIjkvZzkuLrlt6XlhbfnsbtcbmV4cG9ydCBjbGFzcyBFbmhhbmNlZFZhbGlkYXRvciB7XG4gIC8qKlxuICAgKiBAbWV0aG9kIHZhbGlkYXRlXG4gICAqIEBkZXNjcmlwdGlvbiDpqozor4HmlbDmja5cbiAgICogQHBhcmFtIHNjaGVtYSAtIFpvZCBzY2hlbWFcbiAgICogQHBhcmFtIGRhdGEgLSDopoHpqozor4HnmoTmlbDmja5cbiAgICogQHJldHVybnMg6aqM6K+B57uT5p6cXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIHZhbGlkYXRlPFQ+KHNjaGVtYTogWm9kU2NoZW1hPFQ+LCBkYXRhOiB1bmtub3duKTogVmFsaWRhdGlvblJlc3VsdDxUPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhcnNlZCA9IHNjaGVtYS5wYXJzZShkYXRhKVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcGFyc2VkLFxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiB6LlpvZEVycm9yKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3JzOiBFbmhhbmNlZFZhbGlkYXRvci5mb3JtYXRab2RFcnJvcnMoZXJyb3IpLFxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBwYXRoOiBbXSxcbiAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICAgICAgIGNvZGU6ICdVTktOT1dOX0VSUk9SJyxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIHZhbGlkYXRlQXN5bmNcbiAgICogQGRlc2NyaXB0aW9uIOW8guatpemqjOivgeaVsOaNru+8iOaUr+aMgeW8guatpemqjOivgeinhOWIme+8iVxuICAgKiBAcGFyYW0gc2NoZW1hIC0gWm9kIHNjaGVtYVxuICAgKiBAcGFyYW0gZGF0YSAtIOimgemqjOivgeeahOaVsOaNrlxuICAgKiBAcmV0dXJucyDpqozor4Hnu5PmnpwgUHJvbWlzZVxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBhc3luYyB2YWxpZGF0ZUFzeW5jPFQ+KFxuICAgIHNjaGVtYTogWm9kU2NoZW1hPFQ+LFxuICAgIGRhdGE6IHVua25vd25cbiAgKTogUHJvbWlzZTxWYWxpZGF0aW9uUmVzdWx0PFQ+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhcnNlZCA9IGF3YWl0IHNjaGVtYS5wYXJzZUFzeW5jKGRhdGEpXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBwYXJzZWQsXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIHouWm9kRXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcnM6IEVuaGFuY2VkVmFsaWRhdG9yLmZvcm1hdFpvZEVycm9ycyhlcnJvciksXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHBhdGg6IFtdLFxuICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgICAgICAgY29kZTogJ1VOS05PV05fRVJST1InLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2Qgc2FmZVBhcnNlXG4gICAqIEBkZXNjcmlwdGlvbiDlronlhajop6PmnpDvvIjkuI3mipvlh7rlvILluLjvvIlcbiAgICogQHBhcmFtIHNjaGVtYSAtIFpvZCBzY2hlbWFcbiAgICogQHBhcmFtIGRhdGEgLSDopoHpqozor4HnmoTmlbDmja5cbiAgICogQHJldHVybnMg6aqM6K+B57uT5p6cXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIHNhZmVQYXJzZTxUPihzY2hlbWE6IFpvZFNjaGVtYTxUPiwgZGF0YTogdW5rbm93bik6IFZhbGlkYXRpb25SZXN1bHQ8VD4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IHNjaGVtYS5zYWZlUGFyc2UoZGF0YSlcblxuICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YTogcmVzdWx0LmRhdGEsXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3JzOiBFbmhhbmNlZFZhbGlkYXRvci5mb3JtYXRab2RFcnJvcnMocmVzdWx0LmVycm9yKSxcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBmb3JtYXRab2RFcnJvcnNcbiAgICogQGRlc2NyaXB0aW9uIOagvOW8j+WMliBab2Qg6ZSZ6K+v5Li65Y+L5aW955qE6ZSZ6K+v5raI5oGvXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBmb3JtYXRab2RFcnJvcnMoZXJyb3I6IFpvZEVycm9yKTogVmFsaWRhdGlvbkVycm9yW10ge1xuICAgIHJldHVybiBlcnJvci5lcnJvcnMubWFwKChlcnIpID0+IHtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvcjogVmFsaWRhdGlvbkVycm9yID0ge1xuICAgICAgICBwYXRoOiBlcnIucGF0aCxcbiAgICAgICAgbWVzc2FnZTogRW5oYW5jZWRWYWxpZGF0b3IuZm9ybWF0RXJyb3JNZXNzYWdlKGVyciksXG4gICAgICAgIGNvZGU6IGVyci5jb2RlLFxuICAgICAgfVxuXG4gICAgICAvLyDmt7vliqDnsbvlnovkv6Hmga9cbiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ2ludmFsaWRfdHlwZScpIHtcbiAgICAgICAgdmFsaWRhdGlvbkVycm9yLmV4cGVjdGVkID0gZXJyLmV4cGVjdGVkXG4gICAgICAgIHZhbGlkYXRpb25FcnJvci5yZWNlaXZlZCA9IGVyci5yZWNlaXZlZFxuICAgICAgfVxuXG4gICAgICAvLyDmt7vliqDnuqbmnZ/kv6Hmga9cbiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ3Rvb19zbWFsbCcgfHwgZXJyLmNvZGUgPT09ICd0b29fYmlnJykge1xuICAgICAgICBjb25zdCBjb25zdHJhaW50RXJyID0gZXJyIGFzIHsgbWluaW11bT86IG51bWJlcjsgbWF4aW11bT86IG51bWJlcjsgcmVjZWl2ZWQ/OiB1bmtub3duIH1cbiAgICAgICAgdmFsaWRhdGlvbkVycm9yLmV4cGVjdGVkID0gYG1pbmltdW06ICR7Y29uc3RyYWludEVyci5taW5pbXVtID8/ICdOL0EnfSwgbWF4aW11bTogJHtjb25zdHJhaW50RXJyLm1heGltdW0gPz8gJ04vQSd9YFxuICAgICAgICB2YWxpZGF0aW9uRXJyb3IucmVjZWl2ZWQgPSBjb25zdHJhaW50RXJyLnJlY2VpdmVkXG4gICAgICB9XG5cbiAgICAgIHJldHVybiB2YWxpZGF0aW9uRXJyb3JcbiAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgZm9ybWF0RXJyb3JNZXNzYWdlXG4gICAqIEBkZXNjcmlwdGlvbiDmoLzlvI/ljJbplJnor6/mtojmga/vvIzkvb/lhbbmm7Tlj4vlpb1cbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGZvcm1hdEVycm9yTWVzc2FnZShlcnI6IHouWm9kSXNzdWUpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBhdGggPSBlcnIucGF0aC5sZW5ndGggPiAwID8gZXJyLnBhdGguam9pbignLicpIDogJ3Jvb3QnXG5cbiAgICBzd2l0Y2ggKGVyci5jb2RlKSB7XG4gICAgICBjYXNlICdpbnZhbGlkX3R5cGUnOlxuICAgICAgICByZXR1cm4gYCR7cGF0aH06IOacn+acm+exu+WeiyBcIiR7ZXJyLmV4cGVjdGVkfVwi77yM5L2G5pS25Yiw57G75Z6LIFwiJHtlcnIucmVjZWl2ZWR9XCJgXG5cbiAgICAgIGNhc2UgJ2ludmFsaWRfc3RyaW5nJzpcbiAgICAgICAgaWYgKGVyci52YWxpZGF0aW9uID09PSAnZW1haWwnKSB7XG4gICAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDml6DmlYjnmoTnlLXlrZDpgq7ku7blnLDlnYBgXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVyci52YWxpZGF0aW9uID09PSAndXJsJykge1xuICAgICAgICAgIHJldHVybiBgJHtwYXRofTog5peg5pWI55qEIFVSTGBcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXJyLnZhbGlkYXRpb24gPT09ICd1dWlkJykge1xuICAgICAgICAgIHJldHVybiBgJHtwYXRofTog5peg5pWI55qEIFVVSURgXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDlrZfnrKbkuLLpqozor4HlpLHotKVgXG5cbiAgICAgIGNhc2UgJ3Rvb19zbWFsbCc6XG4gICAgICAgIGlmIChlcnIudHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICByZXR1cm4gYCR7cGF0aH06IOWtl+espuS4sumVv+W6puiHs+WwkeS4uiAke2Vyci5taW5pbXVtfSDkuKrlrZfnrKZgXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVyci50eXBlID09PSAnbnVtYmVyJykge1xuICAgICAgICAgIHJldHVybiBgJHtwYXRofTog5pWw5YC85b+F6aG75aSn5LqO5oiW562J5LqOICR7ZXJyLm1pbmltdW19YFxuICAgICAgICB9XG4gICAgICAgIGlmIChlcnIudHlwZSA9PT0gJ2FycmF5Jykge1xuICAgICAgICAgIHJldHVybiBgJHtwYXRofTog5pWw57uE6Iez5bCR6ZyA6KaBICR7ZXJyLm1pbmltdW19IOS4quWFg+e0oGBcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYCR7cGF0aH06IOWAvOWkquWwj++8iOacgOWwjzogJHtlcnIubWluaW11bX3vvIlgXG5cbiAgICAgIGNhc2UgJ3Rvb19iaWcnOlxuICAgICAgICBpZiAoZXJyLnR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDlrZfnrKbkuLLplb/luqbkuI3og73otoXov4cgJHtlcnIubWF4aW11bX0g5Liq5a2X56ymYFxuICAgICAgICB9XG4gICAgICAgIGlmIChlcnIudHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICByZXR1cm4gYCR7cGF0aH06IOaVsOWAvOS4jeiDvei2hei/hyAke2Vyci5tYXhpbXVtfWBcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXJyLnR5cGUgPT09ICdhcnJheScpIHtcbiAgICAgICAgICByZXR1cm4gYCR7cGF0aH06IOaVsOe7hOacgOWkmuWPquiDveWMheWQqyAke2Vyci5tYXhpbXVtfSDkuKrlhYPntKBgXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDlgLzlpKrlpKfvvIjmnIDlpKc6ICR7ZXJyLm1heGltdW1977yJYFxuXG4gICAgICBjYXNlICdpbnZhbGlkX2VudW1fdmFsdWUnOlxuICAgICAgICByZXR1cm4gYCR7cGF0aH06IOaXoOaViOeahOaemuS4vuWAvOOAguWFgeiuuOeahOWAvDogJHtlcnIub3B0aW9ucz8uam9pbignLCAnKSA/PyAnTi9BJ31gXG5cbiAgICAgIGNhc2UgJ2ludmFsaWRfbGl0ZXJhbCc6XG4gICAgICAgIHJldHVybiBgJHtwYXRofTog5b+F6aG75piv5a2X6Z2i6YeP5YC8IFwiJHtlcnIuZXhwZWN0ZWR9XCJgXG5cbiAgICAgIGNhc2UgJ3VucmVjb2duaXplZF9rZXlzJzpcbiAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDmnKrnn6XnmoTplK46ICR7ZXJyLmtleXMuam9pbignLCAnKX1gXG5cbiAgICAgIGNhc2UgJ2ludmFsaWRfdW5pb24nOlxuICAgICAgICByZXR1cm4gYCR7cGF0aH06IOWAvOS4jeWMuemFjeS7u+S9leiBlOWQiOexu+Wei+mAiemhuWBcblxuICAgICAgY2FzZSAnaW52YWxpZF9kYXRlJzpcbiAgICAgICAgcmV0dXJuIGAke3BhdGh9OiDml6DmlYjnmoTml6XmnJ/moLzlvI9gXG5cbiAgICAgIGNhc2UgJ2N1c3RvbSc6XG4gICAgICAgIHJldHVybiBlcnIubWVzc2FnZSA/PyBgJHtwYXRofTog6Ieq5a6a5LmJ6aqM6K+B5aSx6LSlYFxuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gZXJyLm1lc3NhZ2UgPz8gYCR7cGF0aH06IOmqjOivgeWksei0pWBcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBmb3JtYXRFcnJvcnNBc1N0cmluZ1xuICAgKiBAZGVzY3JpcHRpb24g5bCG6ZSZ6K+v5qC85byP5YyW5Li65a2X56ym5Liy77yI55So5LqO5pel5b+X5oiW55So5oi35raI5oGv77yJXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZvcm1hdEVycm9yc0FzU3RyaW5nKGVycm9yczogVmFsaWRhdGlvbkVycm9yW10pOiBzdHJpbmcge1xuICAgIHJldHVybiBlcnJvcnNcbiAgICAgIC5tYXAoKGVycikgPT4ge1xuICAgICAgICBjb25zdCBwYXRoID0gZXJyLnBhdGgubGVuZ3RoID4gMCA/IGVyci5wYXRoLmpvaW4oJy4nKSA6ICdyb290J1xuICAgICAgICBsZXQgbWVzc2FnZSA9IGAke3BhdGh9OiAke2Vyci5tZXNzYWdlfWBcblxuICAgICAgICBpZiAoZXJyLmV4cGVjdGVkKSB7XG4gICAgICAgICAgbWVzc2FnZSArPSBgICjmnJ/mnJs6ICR7ZXJyLmV4cGVjdGVkfSlgXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyLnJlY2VpdmVkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBtZXNzYWdlICs9IGAgKOaUtuWIsDogJHtKU09OLnN0cmluZ2lmeShlcnIucmVjZWl2ZWQpfSlgXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbWVzc2FnZVxuICAgICAgfSlcbiAgICAgIC5qb2luKCdcXG4nKVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=