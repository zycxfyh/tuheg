{"file":"C:\\Users\\16663\\Desktop\\tuheg\\apps\\backend-gateway\\src\\auth\\__tests__\\auth.service.spec.ts","mappings":";AAAA,2EAA2E;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQ3E,gBAAgB;AAChB,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,GAAG,EAAE,CAAC,CAAC;IAC3B,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,gBAAgB,CAAC;IACnD,OAAO,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,IAAI,CAAC;CAC3C,CAAC,CAAC,CAAA;AAVH,6CAA0D;AAC1D,qCAAwC;AACxC,0DAAqD;AACrD,mDAAoC;AACpC,kDAA6C;AAQ7C,wCAAwC;AACxC,MAAM,iBAAiB,GAAG;IACxB,IAAI,EAAE;QACJ,UAAU,EAAE,IAAI,CAAC,EAAE,EAAE;QACrB,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;KAClB;CACF,CAAA;AAED,wCAAwC;AACxC,MAAM,cAAc,GAAG;IACrB,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,eAAe,CAAC,WAAW,CAAC;IAC5C,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;IACjB,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;CAClB,CAAA;AAED,QAAQ,CAAC,aAAa,EAAE,GAAG,EAAE;IAC3B,IAAI,OAAoB,CAAA;IAExB,UAAU,CAAC,KAAK,IAAI,EAAE;QACpB,cAAc;QACd,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,SAAS,EAAE,CAAA;QAC7C,iBAAiB,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,CAAA;QACzC,cAAc,CAAC,IAAI,CAAC,SAAS,EAAE,CAAA;QAC/B,cAAc,CAAC,IAAI,CAAC,eAAe,CAAC,WAAW,CAAC,CAAA;QAEhD,6BAA6B;QAC7B,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAA;QACzD,iBAAiB,CAAC,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC;YAC9C,EAAE,EAAE,GAAG;YACP,KAAK,EAAE,kBAAkB;YACzB,QAAQ,EAAE,gBAAgB;YAC1B,SAAS,EAAE,IAAI,IAAI,EAAE;YACrB,SAAS,EAAE,IAAI,IAAI,EAAE;SACtB,CAAC,CAAA;QAEF,MAAM,MAAM,GAAkB,MAAM,cAAI,CAAC,mBAAmB,CAAC;YAC3D,SAAS,EAAE;gBACT,0BAAW;gBACX,EAAE,OAAO,EAAE,8BAAa,EAAE,QAAQ,EAAE,iBAAiB,EAAE;gBACvD,EAAE,OAAO,EAAE,gBAAU,EAAE,QAAQ,EAAE,cAAc,EAAE;aAClD;SACF,CAAC,CAAC,OAAO,EAAE,CAAA;QAEZ,OAAO,GAAG,MAAM,CAAC,GAAG,CAAc,0BAAW,CAAC,CAAA;IAChD,CAAC,CAAC,CAAA;IAEF,EAAE,CAAC,mBAAmB,EAAE,GAAG,EAAE;QAC3B,MAAM,CAAC,OAAO,CAAC,CAAC,WAAW,EAAE,CAAA;IAC/B,CAAC,CAAC,CAAA;IAEF,QAAQ,CAAC,kBAAkB,EAAE,GAAG,EAAE;QAChC,EAAE,CAAC,8CAA8C,EAAE,KAAK,IAAI,EAAE;YAC5D,MAAM,WAAW,GAAG,EAAE,KAAK,EAAE,kBAAkB,EAAE,QAAQ,EAAE,eAAe,EAAE,CAAA;YAE5E,6BAA6B;YAC7B,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAA;YACzD,iBAAiB,CAAC,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC;gBAC9C,EAAE,EAAE,GAAG;gBACP,KAAK,EAAE,kBAAkB;gBACzB,QAAQ,EAAE,gBAAgB;gBAC1B,SAAS,EAAE,IAAI,IAAI,EAAE;gBACrB,SAAS,EAAE,IAAI,IAAI,EAAE;aACtB,CAAC,CAAA;YAEF,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAA;YAElD,4CAA4C;YAC5C,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,oBAAoB,CAAC,eAAe,EAAE,EAAE,CAAC,CAAA;YAE/D,oBAAoB;YACpB,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC;gBACrB,EAAE,EAAE,GAAG;gBACP,KAAK,EAAE,kBAAkB;gBACzB,SAAS,EAAE,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC;gBAC3B,SAAS,EAAE,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC;aAC5B,CAAC,CAAA;YACF,MAAM,CAAC,MAAM,CAAC,CAAC,GAAG,CAAC,cAAc,CAAC,UAAU,CAAC,CAAA;QAC/C,CAAC,CAAC,CAAA;QAEF,EAAE,CAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE;YAC1D,MAAM,cAAc,GAAG,gBAAgB,CAAA;YACvC,MAAM,aAAa,GAAG,eAAe,CAAA;YAErC,wCAAwC;YACxC,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC;gBAClD,EAAE,EAAE,GAAG;gBACP,KAAK,EAAE,kBAAkB;gBACzB,QAAQ,EAAE,cAAc;gBACxB,SAAS,EAAE,IAAI,IAAI,EAAE;gBACrB,SAAS,EAAE,IAAI,IAAI,EAAE;aACtB,CAAC,CAAA;YAEF,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,YAAY,CAAC,kBAAkB,EAAE,aAAa,CAAC,CAAA;YAE5E,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,oBAAoB,CAAC,aAAa,EAAE,cAAc,CAAC,CAAA;YAC5E,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC;gBACrB,EAAE,EAAE,GAAG;gBACP,KAAK,EAAE,kBAAkB;gBACzB,SAAS,EAAE,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC;gBAC3B,SAAS,EAAE,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC;aAC5B,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;QAEF,EAAE,CAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE;YAC1D,sBAAsB;YACtB,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAA;YAEzD,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,YAAY,CAAC,yBAAyB,EAAE,UAAU,CAAC,CAAA;YAEhF,MAAM,CAAC,MAAM,CAAC,CAAC,QAAQ,EAAE,CAAA;QAC3B,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;IAEF,QAAQ,CAAC,mBAAmB,EAAE,GAAG,EAAE;QACjC,EAAE,CAAC,0DAA0D,EAAE,KAAK,IAAI,EAAE;YACxE,MAAM,WAAW,GAAG,EAAE,KAAK,EAAE,sBAAsB,EAAE,QAAQ,EAAE,UAAU,EAAE,CAAA;YAE3E,qBAAqB;YACrB,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC;gBAClD,EAAE,EAAE,GAAG;gBACP,KAAK,EAAE,sBAAsB;gBAC7B,QAAQ,EAAE,QAAQ;gBAClB,SAAS,EAAE,IAAI,IAAI,EAAE;gBACrB,SAAS,EAAE,IAAI,IAAI,EAAE;aACtB,CAAC,CAAA;YAEF,MAAM,MAAM,CAAC,OAAO,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,2BAA2B,CAAC,CAAA;QAC1F,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;IAEF,QAAQ,CAAC,YAAY,EAAE,GAAG,EAAE;QAC1B,EAAE,CAAC,kDAAkD,EAAE,KAAK,IAAI,EAAE;YAChE,MAAM,QAAQ,GAAG,EAAE,KAAK,EAAE,kBAAkB,EAAE,QAAQ,EAAE,UAAU,EAAE,CAAA;YAEpE,6BAA6B;YAC7B,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC;gBAClD,EAAE,EAAE,GAAG;gBACP,KAAK,EAAE,kBAAkB;gBACzB,QAAQ,EAAE,gBAAgB;gBAC1B,SAAS,EAAE,IAAI,IAAI,EAAE;gBACrB,SAAS,EAAE,IAAI,IAAI,EAAE;aACtB,CAAC,CAAA;YAEF,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAA;YAE5C,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,EAAE,YAAY,EAAE,WAAW,EAAE,CAAC,CAAA;YACrD,MAAM,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,oBAAoB,CAAC;gBAC/C,KAAK,EAAE,kBAAkB;gBACzB,GAAG,EAAE,GAAG;aACT,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;QAEF,EAAE,CAAC,4DAA4D,EAAE,KAAK,IAAI,EAAE;YAC1E,MAAM,QAAQ,GAAG,EAAE,KAAK,EAAE,kBAAkB,EAAE,QAAQ,EAAE,eAAe,EAAE,CAAA;YAEzE,sBAAsB;YACtB,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAA;YAEzD,MAAM,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,sBAAsB,CAAC,CAAA;QAC/E,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;AACJ,CAAC,CAAC,CAAA","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\apps\\backend-gateway\\src\\auth\\__tests__\\auth.service.spec.ts"],"sourcesContent":["// 文件路径: apps/backend-gateway/src/auth/__tests__/auth.service.spec.ts (修正版)\n\nimport { Test, type TestingModule } from '@nestjs/testing'\nimport { JwtService } from '@nestjs/jwt'\nimport { PrismaService } from '@tuheg/common-backend'\nimport * as bcryptjs from 'bcryptjs'\nimport { AuthService } from '../auth.service'\n\n// Mock bcryptjs\njest.mock('bcryptjs', () => ({\n  hash: jest.fn().mockResolvedValue('hashedPassword'),\n  compare: jest.fn().mockResolvedValue(true),\n}))\n\n// Mock PrismaService with proper typing\nconst mockPrismaService = {\n  user: {\n    findUnique: jest.fn(),\n    create: jest.fn(),\n  },\n}\n\n// Mock JwtService with proper interface\nconst mockJwtService = {\n  sign: jest.fn().mockReturnValue('jwt-token'),\n  verify: jest.fn(),\n  decode: jest.fn(),\n}\n\ndescribe('AuthService', () => {\n  let service: AuthService\n\n  beforeEach(async () => {\n    // Reset mocks\n    mockPrismaService.user.findUnique.mockReset()\n    mockPrismaService.user.create.mockReset()\n    mockJwtService.sign.mockReset()\n    mockJwtService.sign.mockReturnValue('jwt-token')\n\n    // Set default mock behaviors\n    mockPrismaService.user.findUnique.mockResolvedValue(null)\n    mockPrismaService.user.create.mockResolvedValue({\n      id: '1',\n      email: 'test@example.com',\n      password: 'hashedPassword',\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    })\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        AuthService,\n        { provide: PrismaService, useValue: mockPrismaService },\n        { provide: JwtService, useValue: mockJwtService },\n      ],\n    }).compile()\n\n    service = module.get<AuthService>(AuthService)\n  })\n\n  it('should be defined', () => {\n    expect(service).toBeDefined()\n  })\n\n  describe('password hashing', () => {\n    it('should hash the password during registration', async () => {\n      const registerDto = { email: 'test@example.com', password: 'plainPassword' }\n\n      // Set up mocks for this test\n      mockPrismaService.user.findUnique.mockResolvedValue(null)\n      mockPrismaService.user.create.mockResolvedValue({\n        id: '1',\n        email: 'test@example.com',\n        password: 'hashedPassword',\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      })\n\n      const result = await service.register(registerDto)\n\n      // Verify bcryptjs.hash was called correctly\n      expect(bcryptjs.hash).toHaveBeenCalledWith('plainPassword', 10)\n\n      // Verify the result\n      expect(result).toEqual({\n        id: '1',\n        email: 'test@example.com',\n        createdAt: expect.any(Date),\n        updatedAt: expect.any(Date),\n      })\n      expect(result).not.toHaveProperty('password')\n    })\n\n    it('should validate user credentials correctly', async () => {\n      const hashedPassword = 'hashedPassword'\n      const plainPassword = 'plainPassword'\n\n      // Mock user exists with hashed password\n      mockPrismaService.user.findUnique.mockResolvedValue({\n        id: '1',\n        email: 'test@example.com',\n        password: hashedPassword,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      })\n\n      const result = await service.validateUser('test@example.com', plainPassword)\n\n      expect(bcryptjs.compare).toHaveBeenCalledWith(plainPassword, hashedPassword)\n      expect(result).toEqual({\n        id: '1',\n        email: 'test@example.com',\n        createdAt: expect.any(Date),\n        updatedAt: expect.any(Date),\n      })\n    })\n\n    it('should return null for invalid credentials', async () => {\n      // Mock user not found\n      mockPrismaService.user.findUnique.mockResolvedValue(null)\n\n      const result = await service.validateUser('nonexistent@example.com', 'password')\n\n      expect(result).toBeNull()\n    })\n  })\n\n  describe('user registration', () => {\n    it('should throw ConflictException when email already exists', async () => {\n      const registerDto = { email: 'existing@example.com', password: 'password' }\n\n      // Mock existing user\n      mockPrismaService.user.findUnique.mockResolvedValue({\n        id: '1',\n        email: 'existing@example.com',\n        password: 'hashed',\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      })\n\n      await expect(service.register(registerDto)).rejects.toThrow('Email already registered.')\n    })\n  })\n\n  describe('user login', () => {\n    it('should return access token for valid credentials', async () => {\n      const loginDto = { email: 'test@example.com', password: 'password' }\n\n      // Mock successful validation\n      mockPrismaService.user.findUnique.mockResolvedValue({\n        id: '1',\n        email: 'test@example.com',\n        password: 'hashedPassword',\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      })\n\n      const result = await service.login(loginDto)\n\n      expect(result).toEqual({ access_token: 'jwt-token' })\n      expect(mockJwtService.sign).toHaveBeenCalledWith({\n        email: 'test@example.com',\n        sub: '1'\n      })\n    })\n\n    it('should throw UnauthorizedException for invalid credentials', async () => {\n      const loginDto = { email: 'test@example.com', password: 'wrongpassword' }\n\n      // Mock user not found\n      mockPrismaService.user.findUnique.mockResolvedValue(null)\n\n      await expect(service.login(loginDto)).rejects.toThrow('Invalid credentials.')\n    })\n  })\n})\n"],"version":3}