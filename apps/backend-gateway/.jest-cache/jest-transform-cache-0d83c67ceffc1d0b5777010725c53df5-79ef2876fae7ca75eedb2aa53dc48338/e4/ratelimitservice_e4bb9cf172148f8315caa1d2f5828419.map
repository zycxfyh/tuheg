{"file":"C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\rate-limit\\rate-limit.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\16663\\Desktop\\tuheg\\packages\\common-backend\\src\\rate-limit\\rate-limit.service.ts"],"sourcesContent":["// 文件路径: packages/common-backend/src/rate-limit/rate-limit.service.ts\n// 核心理念: 滑动窗口限流算法，支持内存和 Redis 存储\n\nimport { Injectable, Logger, type OnModuleDestroy } from '@nestjs/common'\n// import type { RedisClientType } from \"redis\"; // 暂时不需要\nimport { Redis } from 'ioredis'\n\n/**\n * @interface RateLimitOptions\n * @description 限流选项\n */\nexport interface RateLimitOptions {\n  /** 时间窗口（毫秒） */\n  windowMs: number\n  /** 最大请求数 */\n  max: number\n}\n\n/**\n * @interface RateLimitResult\n * @description 限流检查结果\n */\nexport interface RateLimitResult {\n  /** 是否允许请求 */\n  allowed: boolean\n  /** 剩余请求数 */\n  remaining: number\n  /** 重置时间（Unix 时间戳，毫秒） */\n  resetTime: number\n  /** 重试延迟（毫秒） */\n  retryAfter: number\n}\n\n/**\n * @service RateLimitService\n * @description 限流服务\n * 支持内存存储（开发环境）和 Redis 存储（生产环境）\n */\n@Injectable()\nexport class RateLimitService implements OnModuleDestroy {\n  private readonly logger = new Logger(RateLimitService.name)\n\n  // 内存存储（用于开发环境或单实例部署）\n  private readonly memoryStore = new Map<string, { count: number; resetTime: number }>()\n\n  // Redis 客户端（可选，用于分布式部署）\n  private redisClient?: Redis\n\n  // 清理定时器\n  private cleanupInterval?: NodeJS.Timeout\n\n  constructor() {\n    // 尝试连接 Redis（如果配置了）\n    this.initRedis()\n\n    // 启动内存存储清理定时器\n    this.startCleanup()\n  }\n\n  /**\n   * @method initRedis\n   * @description 初始化 Redis 客户端（可选）\n   */\n  private initRedis(): void {\n    const redisUrl = process.env.REDIS_URL\n    if (redisUrl) {\n      try {\n        this.redisClient = new Redis(redisUrl, {\n          maxRetriesPerRequest: 3,\n          retryStrategy: (times) => {\n            const delay = Math.min(times * 50, 2000)\n            return delay\n          },\n        })\n\n        this.redisClient.on('error', (error) => {\n          this.logger.warn('Redis connection error, falling back to memory store:', error)\n          this.redisClient = undefined\n        })\n\n        this.logger.log('Rate limiting using Redis storage')\n      } catch (error) {\n        this.logger.warn('Failed to initialize Redis, using memory store:', error)\n      }\n    } else {\n      this.logger.log('Rate limiting using memory store (REDIS_URL not configured)')\n    }\n  }\n\n  /**\n   * @method checkLimit\n   * @description 检查限流\n   *\n   * @example\n   * ```typescript\n   * const result = await rateLimitService.checkLimit('user:123', {\n   *   windowMs: 60000,\n   *   max: 100,\n   * });\n   *\n   * if (!result.allowed) {\n   *   throw new Error(`Rate limit exceeded. Retry after ${result.retryAfter}ms`);\n   * }\n   * ```\n   */\n  async checkLimit(key: string, options: RateLimitOptions): Promise<RateLimitResult> {\n    if (this.redisClient) {\n      return this.checkLimitRedis(key, options)\n    }\n    return this.checkLimitMemory(key, options)\n  }\n\n  /**\n   * @method checkLimitRedis\n   * @description 使用 Redis 检查限流（滑动窗口）\n   */\n  private async checkLimitRedis(key: string, options: RateLimitOptions): Promise<RateLimitResult> {\n    const { windowMs, max } = options\n    const now = Date.now()\n    const windowStart = now - windowMs\n    const redisKey = `rate_limit:${key}`\n\n    try {\n      // 使用 Redis 的 Sorted Set 实现滑动窗口\n      const pipeline = this.redisClient?.pipeline()\n\n      // 移除过期的时间戳\n      pipeline.zremrangebyscore(redisKey, '-inf', String(windowStart))\n\n      // 添加当前时间戳\n      pipeline.zadd(redisKey, now, String(now))\n\n      // 获取当前窗口内的请求数\n      pipeline.zcard(redisKey)\n\n      // 设置过期时间\n      pipeline.expire(redisKey, Math.ceil(windowMs / 1000))\n\n      const results = await pipeline.exec()\n      const count = (results?.[2]?.[1] as number) || 0\n\n      const allowed = count < max\n      const remaining = Math.max(0, max - count)\n      const resetTime = now + windowMs\n      const retryAfter = allowed ? 0 : resetTime - now\n\n      return {\n        allowed,\n        remaining,\n        resetTime,\n        retryAfter,\n      }\n    } catch (error) {\n      this.logger.error(`Redis rate limit check failed, falling back to memory:`, error)\n      return this.checkLimitMemory(key, options)\n    }\n  }\n\n  /**\n   * @method checkLimitMemory\n   * @description 使用内存检查限流（固定窗口）\n   */\n  private checkLimitMemory(key: string, options: RateLimitOptions): RateLimitResult {\n    const { windowMs, max } = options\n    const now = Date.now()\n    const record = this.memoryStore.get(key)\n\n    if (!record || now > record.resetTime) {\n      // 新窗口或窗口已过期\n      this.memoryStore.set(key, {\n        count: 1,\n        resetTime: now + windowMs,\n      })\n\n      return {\n        allowed: true,\n        remaining: max - 1,\n        resetTime: now + windowMs,\n        retryAfter: 0,\n      }\n    }\n\n    // 窗口内\n    const allowed = record.count < max\n    record.count++\n\n    return {\n      allowed,\n      remaining: Math.max(0, max - record.count),\n      resetTime: record.resetTime,\n      retryAfter: allowed ? 0 : record.resetTime - now,\n    }\n  }\n\n  /**\n   * @method startCleanup\n   * @description 启动内存存储清理定时器\n   */\n  private startCleanup(): void {\n    this.cleanupInterval = setInterval(() => {\n      const now = Date.now()\n      for (const [key, record] of this.memoryStore.entries()) {\n        if (now > record.resetTime) {\n          this.memoryStore.delete(key)\n        }\n      }\n    }, 60000) // 每分钟清理一次\n  }\n\n  /**\n   * @method onModuleDestroy\n   * @description 模块销毁时清理资源\n   */\n  onModuleDestroy(): void {\n    if (this.cleanupInterval) {\n      clearInterval(this.cleanupInterval)\n    }\n    if (this.redisClient) {\n      this.redisClient.quit()\n    }\n  }\n}\n"],"version":3}