# 项目解耦与模块化重构计划

## 🎯 重构目标

通过清晰的架构分层和模块化设计，实现：
- **低耦合**：模块间依赖关系清晰，职责单一
- **高内聚**：相关功能集中在一个模块内
- **可维护性**：便于独立开发、测试和部署
- **可扩展性**：新功能易于添加，不影响现有代码

## 🏗️ 新架构设计

### 架构分层图

```
┌─────────────────────────────────────────────────────────────┐
│                    🎨 表现层 (Presentation)                 │
│  Frontend App - 用户界面、状态管理、路由                    │
├─────────────────────────────────────────────────────────────┤
│                 🏢 应用层 (Application)                     │
│  API Gateway + Business Services + Orchestration           │
├─────────────────────────────────────────────────────────────┤
│                 🤖 领域层 (Domain)                          │
│  AI Domain + Narrative Domain + Game Core + Enterprise     │
├─────────────────────────────────────────────────────────────┤
│                 📋 预编译层 (Precompiled)                  │
│  Database Abstraction + Event Bus                          │
├─────────────────────────────────────────────────────────────┤
│                 🏗️ 基础设施层 (Infrastructure)             │
│  Config + AI Providers + Infrastructure Services           │
├─────────────────────────────────────────────────────────────┤
│                 🎯 基础层 (Foundation)                      │
│  Shared Types + Core Abstractions                          │
└─────────────────────────────────────────────────────────────┘
```

### 依赖倒置原则

```
高层模块 ←────── 抽象接口 ──────→ 低层实现
    ↑                                      ↓
依赖注入容器 ←────── 具体实现 ──────→ 基础设施
```

## 📦 模块重构计划

### 1. 基础层 (Foundation Layer)

#### 1.1 shared-types 模块
**职责**：定义所有模块共享的基础类型
**依赖**：无外部依赖
**被依赖**：所有其他模块

**重构内容**：
- 统一基础类型定义
- API 数据传输对象
- 通用工具类型

#### 1.2 abstractions 模块
**职责**：定义核心接口和抽象
**依赖**：shared-types
**被依赖**：基础设施层及以上

**重构内容**：
- 领域接口定义
- 服务抽象接口
- 事件接口定义

### 2. 基础设施层 (Infrastructure Layer)

#### 2.1 infrastructure 模块
**职责**：提供基础设施服务
**依赖**：shared-types, abstractions
**被依赖**：预编译层

**重构内容**：
- 数据库连接服务
- 缓存服务
- 事件总线基础实现
- 配置服务
- 日志服务
- 监控服务

#### 2.2 config-management 模块
**职责**：配置管理服务
**依赖**：shared-types, abstractions
**被依赖**：应用层

**重构内容**：
- 环境变量加载
- 配置验证
- 配置热重载

#### 2.3 ai-providers 模块
**职责**：AI提供商抽象层
**依赖**：shared-types, abstractions
**被依赖**：领域层

**重构内容**：
- AI提供商接口
- 提供商工厂
- 重试策略
- 缓存机制

### 3. 预编译层 (Precompiled Layer)

#### 3.1 database 模块
**职责**：数据库抽象层
**依赖**：shared-types, abstractions, infrastructure
**被依赖**：领域层

**重构内容**：
- 仓储模式实现
- 数据迁移
- 查询构建器

#### 3.2 event-bus 模块
**职责**：事件总线服务
**依赖**：shared-types, abstractions, infrastructure
**被依赖**：应用层

**重构内容**：
- 事件发布订阅
- 事件处理器
- 事件序列化

### 4. 领域层 (Domain Layer)

#### 4.1 ai-domain 模块
**职责**：AI相关业务逻辑
**依赖**：shared-types, abstractions, ai-providers, database
**被依赖**：应用层

**重构内容**：
- AI服务编排
- 向量搜索
- 提示词管理
- VCP协议实现

#### 4.2 narrative-domain 模块
**职责**：叙事相关业务逻辑
**依赖**：shared-types, abstractions, database
**被依赖**：应用层

**重构内容**：
- 故事生成逻辑
- 叙事结构管理
- 角色发展逻辑

#### 4.3 enterprise-domain 模块
**职责**：企业级功能
**依赖**：shared-types, abstractions, database
**被依赖**：应用层

**重构内容**：
- 多租户管理
- 企业安全
- 审计日志

#### 4.4 game-core 模块
**职责**：游戏核心逻辑
**依赖**：shared-types, abstractions, database
**被依赖**：应用层

**重构内容**：
- 游戏状态管理
- 游戏规则引擎
- 玩家交互逻辑

### 5. 应用层 (Application Layer)

#### 5.1 backend-gateway 模块
**职责**：API网关和业务编排
**依赖**：所有领域层模块 + config-management + event-bus
**被依赖**：表现层

**重构内容**：
- RESTful API接口
- GraphQL接口
- WebSocket网关
- 认证授权

#### 5.2 *-agent 应用模块
**职责**：具体的代理服务应用
**依赖**：相应领域模块 + config-management
**被依赖**：无（独立部署）

**重构内容**：
- 代理服务实现
- 消息队列集成
- 健康检查

### 6. 表现层 (Presentation Layer)

#### 6.1 frontend 模块
**职责**：用户界面和交互
**依赖**：backend-gateway API
**被依赖**：无

**重构内容**：
- Vue 3 组件
- 状态管理 (Pinia)
- 路由管理
- UI组件库

## 🔄 重构步骤

### 阶段3：重构基础层
1. 重构 shared-types 模块
2. 重构 abstractions 模块
3. 定义核心接口

### 阶段4：重构预编译层
1. 重构 database 模块
2. 重构 event-bus 模块
3. 实现仓储模式

### 阶段5：重构域层
1. 重构 ai-domain 模块
2. 重构 narrative-domain 模块
3. 重构 enterprise-domain 模块
4. 重构 game-core 模块

### 阶段6：重构应用层
1. 重构 backend-gateway
2. 重构各 agent 应用
3. 实现依赖注入

### 阶段7：重构表现层
1. 重构 frontend 应用
2. 优化组件结构
3. 改进状态管理

### 阶段8：更新依赖关系
1. 更新所有 package.json
2. 配置依赖注入容器
3. 验证依赖关系

## ✅ 验证标准

### 功能验证
- [ ] 所有现有功能正常工作
- [ ] API接口兼容性保持
- [ ] 数据库迁移成功
- [ ] 消息队列正常工作

### 架构验证
- [ ] 无循环依赖
- [ ] 依赖倒置正确实现
- [ ] 模块边界清晰
- [ ] 测试覆盖率 >= 80%

### 性能验证
- [ ] 启动时间无明显增加
- [ ] 内存使用合理
- [ ] API响应时间正常
- [ ] 构建时间可接受

## 📊 预期收益

1. **开发效率提升**：模块化后，开发人员可专注于特定领域
2. **维护成本降低**：清晰的架构便于问题定位和修复
3. **测试效率提升**：模块独立测试，减少集成测试复杂度
4. **部署灵活性**：可独立部署和扩展各模块
5. **技术栈升级**：各模块可独立升级技术栈
