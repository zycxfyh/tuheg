name: ðŸš€ Optimized CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '9.x'
  TURBO_FORCE: true
  TURBO_REMOTE_CACHE_DISABLED: false

# æœ€å°æƒé™åŽŸåˆ™
permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

# å¹¶å‘æŽ§åˆ¶ä¼˜åŒ–
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # ä¾èµ–å®‰è£…å’Œç¼“å­˜ - ç‹¬ç«‹Jobä»¥ä¾¿é‡ç”¨
  deps:
    name: 'ðŸ“¦ Dependencies'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # å¤šå±‚ç¼“å­˜ç­–ç•¥
      - name: ðŸ“¦ Cache PNPM Store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¦ Cache Node Modules
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ðŸ“¦ Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile --prefer-offline

      # éªŒè¯å®‰è£…
      - name: âœ… Verify dependencies
        run: pnpm ls --depth=0

  # æž„å»ºç¼“å­˜ - ä¸ºåŽç»­Jobå‡†å¤‡æž„å»ºäº§ç‰©
  build:
    name: 'ðŸ—ï¸ Build'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: deps

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.NODE_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # æ¢å¤ä¾èµ–ç¼“å­˜
      - name: ðŸ“¦ Restore Node Modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      # æž„å»ºç¼“å­˜
      - name: ðŸ“¦ Cache Build Artifacts
        uses: actions/cache@v4
        id: cache-build
        with:
          path: |
            apps/frontend/dist
            packages/common-backend/dist
            apps/*/dist
            packages/*/dist
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: ðŸ—ï¸ Build application
        if: steps.cache-build.outputs.cache-hit != 'true'
        run: pnpm build

      # ä¸Šä¼ æž„å»ºäº§ç‰©ä¾›åŽç»­Jobä½¿ç”¨
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            apps/frontend/dist/
            packages/common-backend/dist/
          retention-days: 1

  # å¹¶è¡Œæµ‹è¯• - å•å…ƒæµ‹è¯•
  test-unit:
    name: 'ðŸ§ª Unit Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: build

    strategy:
      matrix:
        node-version: [18.x, 20.x]
        shard: [1, 2, 3]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      # æ¢å¤ä¾èµ–ç¼“å­˜
      - name: ðŸ“¦ Restore Node Modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      # è¿è¡Œåˆ†ç‰‡æµ‹è¯•
      - name: ðŸ§ª Run unit tests (Shard ${{ matrix.shard }}/3)
        run: |
          pnpm test -- --shard=${{ matrix.shard }}/3 --coverage=false --passWithNoTests

  # å¹¶è¡Œæµ‹è¯• - é›†æˆæµ‹è¯•
  test-integration:
    name: 'ðŸ”— Integration Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: build

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports: [5432:5432]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports: [6379:6379]
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # æ¢å¤ä¾èµ–ç¼“å­˜
      - name: ðŸ“¦ Restore Node Modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      # æ¢å¤æž„å»ºäº§ç‰©
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ðŸ”— Run integration tests
        run: pnpm test:integration
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379

  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: 'ðŸ” Code Quality'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: deps

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # æ¢å¤ä¾èµ–ç¼“å­˜
      - name: ðŸ“¦ Restore Node Modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ðŸŽ¨ Run ESLint
        run: pnpm lint

      - name: ðŸ”· Run TypeScript check
        run: pnpm type-check

      - name: ðŸ“ Run Prettier check
        run: pnpm format:check

  # å®‰å…¨æ£€æŸ¥
  security:
    name: 'ðŸ”’ Security'
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: deps

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # æ¢å¤ä¾èµ–ç¼“å­˜
      - name: ðŸ“¦ Restore Node Modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ðŸ”’ Dependency audit
        run: pnpm audit --audit-level moderate

      - name: ðŸ›¡ï¸ Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: 0

      - name: ðŸ“Š Upload security results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

  # ç»“æžœæ±‡æ€»
  results:
    name: 'ðŸ“Š Test Results'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: [test-unit, test-integration, quality, security]
    if: always()

    steps:
      - name: ðŸ“Š Generate test summary
        run: |
          echo "# ðŸš€ CI æ‰§è¡Œæ‘˜è¦" > ci-summary.md
          echo "" >> ci-summary.md
          echo "**æ‰§è¡Œæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> ci-summary.md
          echo "**æäº¤**: \`${{ github.sha }}\`" >> ci-summary.md
          echo "**åˆ†æ”¯**: \`${{ github.ref }}\`" >> ci-summary.md
          echo "" >> ci-summary.md

          # æ£€æŸ¥å„ä¸ªJobçŠ¶æ€
          UNIT_STATUS="${{ needs.test-unit.result }}"
          INTEGRATION_STATUS="${{ needs.test-integration.result }}"
          QUALITY_STATUS="${{ needs.quality.result }}"
          SECURITY_STATUS="${{ needs.security.result }}"

          echo "## ðŸ“‹ æ‰§è¡Œç»“æžœ" >> ci-summary.md
          echo "" >> ci-summary.md
          echo "| é˜¶æ®µ | çŠ¶æ€ |" >> ci-summary.md
          echo "|------|------|" >> ci-summary.md
          echo "| å•å…ƒæµ‹è¯• | $([ "$UNIT_STATUS" = "success" ] && echo "âœ…" || echo "âŒ") |" >> ci-summary.md
          echo "| é›†æˆæµ‹è¯• | $([ "$INTEGRATION_STATUS" = "success" ] && echo "âœ…" || echo "âŒ") |" >> ci-summary.md
          echo "| ä»£ç è´¨é‡ | $([ "$QUALITY_STATUS" = "success" ] && echo "âœ…" || echo "âŒ") |" >> ci-summary.md
          echo "| å®‰å…¨æ£€æŸ¥ | $([ "$SECURITY_STATUS" = "success" ] && echo "âœ…" || echo "âŒ") |" >> ci-summary.md
          echo "" >> ci-summary.md

          # æ€»ä½“çŠ¶æ€
          if [ "$UNIT_STATUS" = "success" ] && [ "$INTEGRATION_STATUS" = "success" ] && [ "$QUALITY_STATUS" = "success" ] && [ "$SECURITY_STATUS" = "success" ]; then
            echo "## âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡" >> ci-summary.md
            echo "" >> ci-summary.md
            echo "ðŸŽ‰ CIæµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰è´¨é‡é—¨ç¦å·²é€šè¿‡ï¼" >> ci-summary.md
          else
            echo "## âŒ æ£€æŸ¥å¤±è´¥" >> ci-summary.md
            echo "" >> ci-summary.md
            echo "âš ï¸ éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚" >> ci-summary.md
          fi

      - name: ðŸ“¤ Upload CI summary
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary-${{ github.sha }}
          path: ci-summary.md
          retention-days: 7
