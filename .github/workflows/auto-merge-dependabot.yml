name: ğŸ¤– Auto Merge Dependabot

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted]
  status: {}

# æœ€å°æƒé™åŸåˆ™
permissions:
  contents: read
  pull-requests: write
  checks: read
  statuses: read

jobs:
  dependabot-auto-merge:
    name: 'ğŸ¤– Dependabot è‡ªåŠ¨åˆå¹¶'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    # åªå¯¹ Dependabot PR æ‰§è¡Œ
    if: >
      github.event_name == 'pull_request' &&
      github.actor == 'dependabot[bot]' &&
      github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # ç­‰å¾…æ‰€æœ‰å¿…éœ€æ£€æŸ¥å®Œæˆ
      - name: â³ ç­‰å¾… CI æ£€æŸ¥å®Œæˆ
        id: wait-for-ci
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: 'ğŸš€ CI/CD Pipeline'
          ref: ${{ github.event.pull_request.head.sha }}

      # æ£€æŸ¥æ˜¯å¦æœ‰æœªè§£å†³çš„å†²çª
      - name: ğŸ” æ£€æŸ¥åˆå¹¶å†²çª
        run: |
          if git merge-tree $(git merge-base HEAD ${{ github.event.pull_request.head.sha }}) HEAD ${{ github.event.pull_request.head.sha }} | grep -q "<<<<<<<"; then
            echo "âŒ å‘ç°åˆå¹¶å†²çªï¼Œè·³è¿‡è‡ªåŠ¨åˆå¹¶"
            exit 1
          else
            echo "âœ… æ— åˆå¹¶å†²çª"
          fi

      # é¢å¤–çš„å®‰å…¨æ£€æŸ¥ï¼ˆé’ˆå¯¹ä¾èµ–æ›´æ–°ï¼‰
      - name: ğŸ”’ éªŒè¯ä¾èµ–æ›´æ–°å®‰å…¨
        run: |
          # å¯¹äºä¸»è¦ç‰ˆæœ¬æ›´æ–°ï¼Œä½¿ç”¨æ›´ä¸¥æ ¼çš„æ£€æŸ¥
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ "$PR_TITLE" == *"major"* ]] || [[ "$PR_TITLE" == *"bump "*[0-9]*"."[0-9]*"."[0-9]* ]]; then
            echo "ğŸ”’ ä¸»è¦ç‰ˆæœ¬æ›´æ–°ï¼šéœ€è¦äººå·¥å®¡æŸ¥"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸ºå®‰å…¨æ›´æ–°
          if [[ "$PR_TITLE" == *"security"* ]] || [[ "${{ github.event.pull_request.labels.*.name }}" == *"security"* ]]; then
            echo "ğŸ”’ å®‰å…¨æ›´æ–°ï¼šæ‰§è¡Œé¢å¤–éªŒè¯"
            # è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„å®‰å…¨æ£€æŸ¥
          fi

      # è‡ªåŠ¨åˆå¹¶ - åªå¯¹è¡¥ä¸ç‰ˆæœ¬å’Œå°ç‰ˆæœ¬æ›´æ–°
      - name: ğŸ¤– æ‰§è¡Œè‡ªåŠ¨åˆå¹¶
        if: >
          steps.wait-for-ci.outputs.conclusion == 'success' &&
          (contains(github.event.pull_request.title, 'patch') ||
           contains(github.event.pull_request.title, 'minor') ||
           contains(github.event.pull_request.labels.*.name, 'patch') ||
           contains(github.event.pull_request.labels.*.name, 'minor'))
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          merge-method: squash

      # å¯¹äºä¸»è¦ç‰ˆæœ¬æ›´æ–°ï¼Œæ·»åŠ äººå·¥å®¡æŸ¥æé†’
      - name: ğŸ“ æ·»åŠ äººå·¥å®¡æŸ¥æé†’
        if: >
          steps.wait-for-ci.outputs.conclusion == 'success' &&
          (contains(github.event.pull_request.title, 'major') ||
           contains(github.event.pull_request.labels.*.name, 'major'))
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: \`## ğŸ”„ ä¸»è¦ç‰ˆæœ¬ä¾èµ–æ›´æ–°

æ­¤ PR åŒ…å«ä¸»è¦ç‰ˆæœ¬ä¾èµ–æ›´æ–°ï¼Œéœ€è¦äººå·¥å®¡æŸ¥ã€‚

### ğŸ“‹ æ£€æŸ¥æ¸…å•

- [ ] å®¡æŸ¥ç ´åæ€§å˜æ›´ (Breaking Changes)
- [ ] æ£€æŸ¥è¿ç§»æŒ‡å— (Migration Guide)
- [ ] éªŒè¯å‘åå…¼å®¹æ€§
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£
- [ ] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

### ğŸ‘¥ å¿…éœ€è¯„å®¡è€…

- @devops-team
- @backend-team (å¦‚æœæ¶‰åŠåç«¯ä¾èµ–)
- @frontend-team (å¦‚æœæ¶‰åŠå‰ç«¯ä¾èµ–)

### â° å“åº”æ—¶é—´

è¯·åœ¨ 24 å°æ—¶å†…å®Œæˆå®¡æŸ¥ã€‚

---
*æ­¤æé†’ç”±è‡ªåŠ¨ä¾èµ–ç®¡ç†ç”Ÿæˆ*\`
            });

      # é€šçŸ¥å¤±è´¥æƒ…å†µ
      - name: ğŸš¨ é€šçŸ¥è‡ªåŠ¨åˆå¹¶å¤±è´¥
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: \`## âš ï¸ è‡ªåŠ¨åˆå¹¶å¤±è´¥

**åŸå› **: CI æ£€æŸ¥å¤±è´¥ã€å­˜åœ¨å†²çªæˆ–éœ€è¦äººå·¥å®¡æŸ¥
**æ—¶é—´**: \${new Date().toISOString()}

### ğŸ” å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ

1. **CI å¤±è´¥**: æ£€æŸ¥æµ‹è¯•æ—¥å¿—ï¼Œä¿®å¤å¤±è´¥çš„æµ‹è¯•
2. **åˆå¹¶å†²çª**: è§£å†³ä»£ç å†²çªåé‡æ–°è¿è¡Œ
3. **ä¸»è¦ç‰ˆæœ¬æ›´æ–°**: éœ€è¦äººå·¥å®¡æŸ¥å’Œæ‰¹å‡†
4. **å®‰å…¨æ›´æ–°**: å¯èƒ½éœ€è¦é¢å¤–çš„å®‰å…¨éªŒè¯

### ğŸ“ è”ç³»æ”¯æŒ

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³» @devops-team æˆ– @security-team

---
*æ­¤é€šçŸ¥ç”±è‡ªåŠ¨ä¾èµ–ç®¡ç†ç”Ÿæˆ*\`
            });
