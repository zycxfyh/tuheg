name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (ç•™ç©ºä½¿ç”¨latest)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm lint

      - name: Run type checking
        run: pnpm type-check

      - name: Run unit tests
        run: pnpm test:run

      - name: Run security audit
        run: pnpm audit --audit-level moderate

  # æž„å»ºå’ŒæŽ¨é€é•œåƒ
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: quality-check
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit-sha: ${{ steps.commit.outputs.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=build-$(date +%Y%m%d-%H%M%S)-${{ github.sha::7 }}" >> $GITHUB_OUTPUT
          fi

      - name: Get commit SHA
        id: commit
        run: echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend-gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: backend-gateway-prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend-gateway:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend-gateway:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push creation-agent
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: creation-agent-prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/creation-agent:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/creation-agent:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push logic-agent
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: logic-agent-prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/logic-agent:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/logic-agent:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push narrative-agent
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: narrative-agent-prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/narrative-agent:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/narrative-agent:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: frontend-prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # æ•°æ®åº“è¿ç§»æµ‹è¯•
  database-migration-test:
    name: Database Migration Test
    runs-on: ubuntu-latest
    needs: build-and-push
    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_DB: tuheg_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run database migration tests
        run: |
          export DATABASE_URL="postgresql://postgres:test_password@localhost:5432/tuheg_test"
          ./deployment/database/test-migration.sh test
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: test_password

  # StagingçŽ¯å¢ƒéƒ¨ç½²
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push, database-migration-test]
    if: github.event.inputs.environment == 'staging' || github.ref_type != 'tag'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.STAGING_KUBECONFIG }}

      - name: Deploy to staging
        run: |
          # æ›´æ–°é•œåƒç‰ˆæœ¬
          sed -i 's|image: tuheg/|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/{{service}}:${{ needs.build-and-push.outputs.version }}|g' deployment/k8s/staging/*.yaml

          # åº”ç”¨Kubernetesé…ç½®
          kubectl apply -f deployment/k8s/namespace.yaml
          kubectl apply -f deployment/k8s/staging/

          # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          kubectl rollout status deployment/backend-gateway -n tuheg-staging --timeout=600s
          kubectl rollout status deployment/creation-agent -n tuheg-staging --timeout=600s
          kubectl rollout status deployment/logic-agent -n tuheg-staging --timeout=600s
          kubectl rollout status deployment/narrative-agent -n tuheg-staging --timeout=600s

      - name: Run smoke tests
        run: |
          # ç®€å•çš„å†’çƒŸæµ‹è¯•
          kubectl run smoke-test --image=curlimages/curl --rm -i --restart=Never -- curl -f http://backend-gateway.tuheg-staging.svc.cluster.local/health

      - name: Notify deployment success
        uses: 8398a7/action-slack@v3
        if: success()
        with:
          status: success
          text: 'âœ… Staging deployment successful: ${{ needs.build-and-push.outputs.version }}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify deployment failure
        uses: 8398a7/action-slack@v3
        if: failure()
        with:
          status: failure
          text: 'âŒ Staging deployment failed: ${{ needs.build-and-push.outputs.version }}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ProductionçŽ¯å¢ƒéƒ¨ç½²
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event.inputs.environment == 'production' || (github.ref_type == 'tag' && startsWith(github.ref_name, 'v'))
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.PRODUCTION_KUBECONFIG }}

      - name: Run canary deployment
        run: |
          export VERSION=${{ needs.build-and-push.outputs.version }}
          export ENVIRONMENT=production

          # æ‰§è¡Œé‡‘ä¸é›€éƒ¨ç½²
          chmod +x deployment/canary-deploy.sh
          ./deployment/canary-deploy.sh "$VERSION" backend-gateway production

      - name: Run integration tests
        run: |
          # è¿è¡Œç”Ÿäº§çŽ¯å¢ƒé›†æˆæµ‹è¯•
          npm run test:integration:production

      - name: Finalize production deployment
        run: |
          # å¦‚æžœé‡‘ä¸é›€éƒ¨ç½²æˆåŠŸï¼Œå®Œæˆç”Ÿäº§éƒ¨ç½²
          echo "Production deployment completed successfully"

      - name: Notify production deployment
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: 'ðŸš€ Production deployment successful: ${{ needs.build-and-push.outputs.version }}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_PRODUCTION_WEBHOOK_URL }}

  # éƒ¨ç½²åŽç›‘æŽ§
  post-deployment-monitoring:
    name: Post-deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: needs.deploy-production.result == 'success'
    steps:
      - name: Wait for monitoring period
        run: |
          echo "ç­‰å¾…30åˆ†é’Ÿç›‘æŽ§æœŸ..."
          sleep 1800  # 30 minutes

      - name: Check deployment health
        run: |
          # æ£€æŸ¥ç”Ÿäº§çŽ¯å¢ƒå¥åº·çŠ¶æ€
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„ç›‘æŽ§æ£€æŸ¥
          echo "Deployment health check completed"

      - name: Generate deployment report
        run: |
          cat > deployment_report.md << EOF
          # ç”Ÿäº§éƒ¨ç½²æŠ¥å‘Š

          ## éƒ¨ç½²ä¿¡æ¯
          - ç‰ˆæœ¬: ${{ needs.build-and-push.outputs.version }}
          - æ—¶é—´: $(date)
          - Commit: ${{ needs.build-and-push.outputs.commit-sha }}
          - çŽ¯å¢ƒ: production

          ## éƒ¨ç½²çŠ¶æ€
          âœ… æž„å»ºæˆåŠŸ
          âœ… æµ‹è¯•é€šè¿‡
          âœ… Stagingéƒ¨ç½²æˆåŠŸ
          âœ… Productionéƒ¨ç½²æˆåŠŸ
          âœ… ç›‘æŽ§æ£€æŸ¥é€šè¿‡

          ## æœåŠ¡çŠ¶æ€
          - Backend Gateway: Healthy
          - Creation Agent: Healthy
          - Logic Agent: Healthy
          - Narrative Agent: Healthy
          - Frontend: Healthy

          ---
          *è‡ªåŠ¨ç”ŸæˆäºŽ: $(date)*
          EOF

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment_report.md
