name: ğŸ“¦ ä¾èµ–å®‰å…¨æ£€æŸ¥

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹æ£€æŸ¥ä¾èµ–
    - cron: '0 8 * * 1'
  workflow_dispatch:
  push:
    branches: [main, develop]
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'

jobs:
  dependency-audit:
    name: å®‰å…¨å®¡è®¡ä¸æ›´æ–°æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9.x

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”’ å…¨é¢å®‰å…¨å®¡è®¡
        run: |
          echo "## ğŸ”’ ä¾èµ–å®‰å…¨å®¡è®¡æŠ¥å‘Š" > security-report.md
          echo "" >> security-report.md
          echo "### ğŸ“Š å®¡è®¡æ¦‚è§ˆ" >> security-report.md
          echo "- å®¡è®¡æ—¶é—´: $(date)" >> security-report.md
          echo "- Node.jsç‰ˆæœ¬: $(node --version)" >> security-report.md
          echo "- PNPMç‰ˆæœ¬: $(pnpm --version)" >> security-report.md
          echo "" >> security-report.md

          echo "### ğŸš¨ å®‰å…¨æ¼æ´ç»Ÿè®¡" >> security-report.md
          echo "\`\`\`" >> security-report.md

          # Run audit and capture results
          AUDIT_OUTPUT=$(pnpm audit --audit-level moderate --json 2>/dev/null || true)

          if [ -n "$AUDIT_OUTPUT" ]; then
            echo "$AUDIT_OUTPUT" | jq -r '
              if .metadata then
                "æ€»ä¾èµ–æ•°: \(.metadata.total // 0)",
                "é«˜å±æ¼æ´: \(.metadata.high // 0)",
                "ä¸­å±æ¼æ´: \(.metadata.moderate // 0)",
                "ä½å±æ¼æ´: \(.metadata.low // 0)",
                "ä¿¡æ¯çº§: \(.metadata.info // 0)"
              else
                "å®¡è®¡å®Œæˆï¼Œæ— ä¸¥é‡æ¼æ´"
              end
            ' 2>/dev/null || echo "å®¡è®¡æ•°æ®è§£æå¤±è´¥"
          else
            echo "å®¡è®¡å®Œæˆï¼Œæ— æ¼æ´å‘ç°"
          fi

          echo "\`\`\`" >> security-report.md

      - name: ğŸ“ˆ è¿‡æ—¶ä¾èµ–åˆ†æ
        run: |
          echo "" >> security-report.md
          echo "### ğŸ“… è¿‡æ—¶ä¾èµ–æ£€æŸ¥" >> security-report.md
          echo "\`\`\`" >> security-report.md

          # Check for outdated packages
          OUTDATED=$(pnpm outdated --format json 2>/dev/null || echo "[]")

          if [ "$OUTDATED" != "[]" ] && [ -n "$OUTDATED" ]; then
            echo "$OUTDATED" | jq -r '
              if length > 0 then
                "å‘ç° \(length) ä¸ªè¿‡æ—¶ä¾èµ–:",
                "",
                "åŒ…å | å½“å‰ç‰ˆæœ¬ | æœ€æ–°ç‰ˆæœ¬ | ä¸¥é‡ç¨‹åº¦",
                "--- | --- | --- | ---",
                (.[] | "\(.name) | \(.current) | \(.latest) | \(.severity // "unknown")")
              else
                "æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
              end
            ' 2>/dev/null || echo "è¿‡æ—¶ä¾èµ–æ£€æŸ¥å®Œæˆ"
          else
            echo "æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
          fi

          echo "\`\`\`" >> security-report.md

      - name: ğŸ”„ å¯ç”¨æ›´æ–°åˆ†æ
        run: |
          echo "" >> security-report.md
          echo "### ğŸ“¦ æ¨èæ›´æ–°" >> security-report.md
          echo "\`\`\`" >> security-report.md

          # Check what can be updated
          pnpm update --latest --dry-run | head -20 >> security-report.md 2>/dev/null || echo "æ›´æ–°æ£€æŸ¥å®Œæˆ" >> security-report.md
          echo "\`\`\`" >> security-report.md

      - name: ğŸ·ï¸ ç”Ÿæˆå®‰å…¨è¯„åˆ†
        run: |
          echo "" >> security-report.md
          echo "### ğŸ“Š å®‰å…¨è¯„åˆ†" >> security-report.md

          # Calculate security score
          SCORE=100

          # Check for high severity vulnerabilities
          HIGH_VULN=$(pnpm audit --audit-level high --json 2>/dev/null | jq -r '.metadata.high // 0' 2>/dev/null || echo "0")
          if [ "$HIGH_VULN" -gt 0 ]; then
            SCORE=$((SCORE - HIGH_VULN * 20))
            echo "-20åˆ†/é«˜å±æ¼æ´ (å‘ç° $HIGH_VULN ä¸ªé«˜å±æ¼æ´)" >> security-report.md
          fi

          # Check for moderate severity vulnerabilities
          MODERATE_VULN=$(pnpm audit --audit-level moderate --json 2>/dev/null | jq -r '.metadata.moderate // 0' 2>/dev/null || echo "0")
          if [ "$MODERATE_VULN" -gt 0 ]; then
            SCORE=$((SCORE - MODERATE_VULN * 5))
            echo "-5åˆ†/ä¸­å±æ¼æ´ (å‘ç° $MODERATE_VULN ä¸ªä¸­å±æ¼æ´)" >> security-report.md
          fi

          # Check for outdated packages (minor penalty)
          OUTDATED_COUNT=$(pnpm outdated --format json 2>/dev/null | jq length 2>/dev/null || echo "0")
          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            SCORE=$((SCORE - OUTDATED_COUNT * 2))
            echo "-2åˆ†/è¿‡æ—¶ä¾èµ– (å‘ç° $OUTDATED_COUNT ä¸ªè¿‡æ—¶ä¾èµ–)" >> security-report.md
          fi

          # Ensure score doesn't go below 0
          if [ $SCORE -lt 0 ]; then
            SCORE=0
          fi

          echo "" >> security-report.md
          echo "**æ€»å¾—åˆ†: $SCORE/100**" >> security-report.md

          if [ $SCORE -ge 90 ]; then
            echo "**å®‰å…¨ç­‰çº§: ğŸŸ¢ ä¼˜ç§€**" >> security-report.md
          elif [ $SCORE -ge 70 ]; then
            echo "**å®‰å…¨ç­‰çº§: ğŸŸ¡ è‰¯å¥½**" >> security-report.md
          else
            echo "**å®‰å…¨ç­‰çº§: ğŸ”´ éœ€è¦æ”¹è¿›**" >> security-report.md
          fi

          # Export score for later use
          echo "SECURITY_SCORE=$SCORE" >> $GITHUB_ENV

      - name: ğŸ“¤ Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-$(date +%Y%m%d)
          path: security-report.md
          retention-days: 30

      - name: ğŸš¨ åˆ›å»ºå®‰å…¨é—®é¢˜ (å¦‚æœéœ€è¦)
        if: env.SECURITY_SCORE < 70
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            const score = process.env.SECURITY_SCORE;

            // Check if there's already an open security issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security', 'dependencies'],
              state: 'open'
            });

            const existingIssue = issues.find(issue =>
              issue.title.includes('ä¾èµ–å®‰å…¨æ£€æŸ¥å¤±è´¥')
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸš¨ ä¾èµ–å®‰å…¨æ£€æŸ¥å¤±è´¥ - éœ€è¦ç«‹å³å¤„ç†',
                body: `## å®‰å…¨æ£€æŸ¥å¤±è´¥\\n\\n### å®‰å…¨è¯„åˆ†: **\${score}/100** ğŸ”´\\n\\n\`\`\`\\n${report}\\n\`\`\`\\n\\n### ç´§æ€¥ç¨‹åº¦\\n- ğŸ”´ **é«˜å±æ¼æ´**: å¿…é¡»ç«‹å³ä¿®å¤\\n- ğŸŸ¡ **ä¸­å±æ¼æ´**: å»ºè®®åœ¨ä¸€å‘¨å†…ä¿®å¤\\n- ğŸŸ¢ **ä½å±æ¼æ´**: å¯é€‰æ‹©æ€§ä¿®å¤\\n\\n### ä¿®å¤å»ºè®®\\n1. **ç«‹å³æ›´æ–°**é«˜å±æ¼æ´åŒ…\\n2. **å®¡æŸ¥**ä¾èµ–çš„ä½¿ç”¨æƒ…å†µ\\n3. **è¯„ä¼°**å®‰å…¨é£é™©å½±å“\\n4. **åˆ¶å®š**å‡çº§è®¡åˆ’\\n\\n### è”ç³»æ–¹å¼\\n- å®‰å…¨å›¢é˜Ÿ: security@company.com\\n- ç´§æ€¥å“åº”: +1-XXX-XXX-XXXX\\n\\n---\\n\\n*è‡ªåŠ¨ç”Ÿæˆçš„å®‰å…¨æŠ¥å‘Š - $(date)*`,
                labels: ['security', 'dependencies', 'urgent', 'auto-generated']
              });
            }

  license-check:
    name: è®¸å¯è¯åˆè§„æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: dependency-audit

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: ğŸ“‹ è®¸å¯è¯å…¼å®¹æ€§æ£€æŸ¥
        run: |
          echo "## ğŸ“„ è®¸å¯è¯åˆè§„æŠ¥å‘Š" > license-report.md
          echo "" >> license-report.md
          echo "### ğŸ“Š è®¸å¯è¯æ¦‚è§ˆ" >> license-report.md
          echo "- æ£€æŸ¥æ—¶é—´: $(date)" >> license-report.md
          echo "- é¡¹ç›®è®¸å¯è¯: $(jq -r '.license // "Unknown"' package.json)" >> license-report.md
          echo "" >> license-report.md

          echo "### ğŸ” ä¾èµ–è®¸å¯è¯åˆ†æ" >> license-report.md
          echo "\`\`\`" >> license-report.md

          # Check licenses using license-checker or similar tool
          npx license-checker --production --json | jq -r '
            to_entries | sort_by(.value.licenses) |
            "è®¸å¯è¯ | åŒ…æ•°é‡ | ç¤ºä¾‹åŒ…å",
            "--- | --- | ---",
            (group_by(.value.licenses) | map({
              license: .[0].value.licenses,
              count: length,
              examples: map(.key) | .[0:3] | join(", ")
            }) | .[] | "\(.license) | \(.count) | \(.examples)")
          ' >> license-report.md 2>/dev/null || echo "è®¸å¯è¯æ£€æŸ¥å®Œæˆ" >> license-report.md

          echo "\`\`\`" >> license-report.md

          echo "" >> license-report.md
          echo "### âš ï¸ è®¸å¯è¯å…¼å®¹æ€§è­¦å‘Š" >> license-report.md

          # Check for potentially problematic licenses
          PROBLEMATIC_LICENSES=$(npx license-checker --production --json 2>/dev/null | jq -r '
            to_entries | map(select(
              (.value.licenses | test("GPL"; "i")) or
              (.value.licenses | test("AGPL"; "i")) or
              (.value.licenses | test("LGPL"; "i"))
            )) | length
          ' 2>/dev/null || echo "0")

          if [ "$PROBLEMATIC_LICENSES" -gt 0 ]; then
            echo "âš ï¸ å‘ç° $PROBLEMATIC_LICENSES ä¸ªä½¿ç”¨GPL/LGPLè®¸å¯è¯çš„ä¾èµ–" >> license-report.md
            echo "" >> license-report.md
            echo "**å»ºè®®æªæ–½:**" >> license-report.md
            echo "- è¯„ä¼°è®¸å¯è¯å…¼å®¹æ€§" >> license-report.md
            echo "- è€ƒè™‘æ›¿æ¢ä¸ºMIT/BSDè®¸å¯è¯çš„æ›¿ä»£å“" >> license-report.md
            echo "- å’¨è¯¢æ³•å¾‹é¡¾é—®" >> license-report.md
          else
            echo "âœ… æœªå‘ç°è®¸å¯è¯å…¼å®¹æ€§é—®é¢˜" >> license-report.md
          fi

      - name: ğŸ“¤ Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report-$(date +%Y%m%d)
          path: license-report.md
          retention-days: 30
