name: ğŸ“ˆ æ€§èƒ½ç›‘æ§ä¸åˆ†æ

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š9ç‚¹è¿›è¡Œæ€§èƒ½ç›‘æ§
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - lighthouse-only
          - load-test-only
  push:
    branches: [main]
    paths:
      - 'apps/frontend/**'
      - 'packages/common-backend/**'

jobs:
  performance-metrics:
    name: æ€§èƒ½æŒ‡æ ‡æ”¶é›†
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build application
        run: pnpm build

      - name: ğŸš€ Start application for testing
        run: |
          # Start the application in background
          pnpm dev &
          SERVER_PID=$!

          # Wait for server to be ready
          echo "â³ Waiting for server to start..."
          for i in {1..30}; do
            if curl -f http://localhost:5173 > /dev/null 2>&1; then
              echo "âœ… Server is ready"
              break
            fi
            sleep 2
          done

          # Store PID for cleanup
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

      - name: ğŸ“Š Lighthouse æ€§èƒ½å®¡è®¡
        run: |
          echo "ğŸ® è¿è¡Œ Lighthouse æ€§èƒ½å®¡è®¡..."

          # Install Lighthouse
          npm install -g lighthouse

          # Run Lighthouse audit
          lighthouse http://localhost:5173 \
            --output=json \
            --output-path=./lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage --disable-gpu" \
            --only-categories=performance,accessibility,best-practices,seo

          echo "âœ… Lighthouse å®¡è®¡å®Œæˆ"

      - name: ğŸ“ˆ ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        run: |
          echo "# ğŸ“Š æ€§èƒ½ç›‘æ§æŠ¥å‘Š" > performance-report.md
          echo "" >> performance-report.md
          echo "## ğŸš€ Lighthouse è¯„åˆ†" >> performance-report.md
          echo "" >> performance-report.md

          if [ -f "lighthouse-report.json" ]; then
            echo "| æŒ‡æ ‡ | åˆ†æ•° | çŠ¶æ€ | ç›®æ ‡ | å·®è· |" >> performance-report.md
            echo "|------|------|------|------|------|" >> performance-report.md

            # Parse Lighthouse results
            node -e "
              const fs = require('fs');
              const report = JSON.parse(fs.readFileSync('lighthouse-report.json'));
              const categories = report.categories;

              const metrics = [
                { name: 'æ€§èƒ½', key: 'performance', threshold: 85 },
                { name: 'æ— éšœç¢æ€§', key: 'accessibility', threshold: 90 },
                { name: 'æœ€ä½³å®è·µ', key: 'best-practices', threshold: 85 },
                { name: 'SEO', key: 'seo', threshold: 85 }
              ];

              metrics.forEach(metric => {
                const score = Math.round(categories[metric.key].score * 100);
                const status = score >= metric.threshold ? 'âœ…' : score >= metric.threshold - 10 ? 'âš ï¸' : 'âŒ';
                const gap = score - metric.threshold;
                const gapText = gap >= 0 ? \`+\${gap}\` : gap.toString();
                console.log(\`| \${metric.name} | \${score} | \${status} | \${metric.threshold} | \${gapText} |\`);
              });
            " >> performance-report.md

            echo "" >> performance-report.md
            echo "## ğŸ“ è¯¦ç»†æ€§èƒ½æŒ‡æ ‡" >> performance-report.md
            echo "" >> performance-report.md

            node -e "
              const fs = require('fs');
              const report = JSON.parse(fs.readFileSync('lighthouse-report.json'));

              console.log('### åŠ è½½æ€§èƒ½');
              console.log('');
              console.log('| æŒ‡æ ‡ | å€¼ | çŠ¶æ€ |');
              console.log('|------|-----|------|');

              const audits = report.audits;
              const loadMetrics = [
                { name: 'é¦–æ¬¡å†…å®¹ç»˜åˆ¶ (FCP)', key: 'first-contentful-paint', threshold: 1800 },
                { name: 'æœ€å¤§å†…å®¹ç»˜åˆ¶ (LCP)', key: 'largest-contentful-paint', threshold: 2500 },
                { name: 'é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ (FID)', key: 'max-potential-fid', threshold: 100 },
                { name: 'ç´¯ç§¯å¸ƒå±€åç§» (CLS)', key: 'cumulative-layout-shift', threshold: 0.1 }
              ];

              loadMetrics.forEach(metric => {
                if (audits[metric.key]) {
                  const value = audits[metric.key].numericValue;
                  let displayValue, status;

                  if (metric.key === 'cumulative-layout-shift') {
                    displayValue = value.toFixed(3);
                    status = value <= metric.threshold ? 'âœ…' : value <= metric.threshold * 2 ? 'âš ï¸' : 'âŒ';
                  } else {
                    displayValue = metric.key === 'max-potential-fid' ? \`\${Math.round(value)}ms\` : \`\${Math.round(value)}ms\`;
                    status = value <= metric.threshold ? 'âœ…' : value <= metric.threshold * 1.5 ? 'âš ï¸' : 'âŒ';
                  }

                  console.log(\`| \${metric.name} | \${displayValue} | \${status} |\`);
                }
              });

              console.log('');
              console.log('### èµ„æºå¤§å°');
              console.log('');
              console.log('| èµ„æºç±»å‹ | å¤§å° | é¢„ç®—çŠ¶æ€ |');
              console.log('|----------|------|----------|');

              if (audits['total-byte-weight']) {
                const totalSize = audits['total-byte-weight'].numericValue;
                const sizeKB = (totalSize / 1024).toFixed(1);
                const status = totalSize < 2048000 ? 'âœ…' : totalSize < 4096000 ? 'âš ï¸' : 'âŒ'; // 2MB / 4MB
                console.log(\`| æ€»å¤§å° | \${sizeKB} KB | \${status} |\`);
              }
            " >> performance-report.md

          else
            echo "| çŠ¶æ€ | æè¿° |" >> performance-report.md
            echo "|------|------|" >> performance-report.md
            echo "| âŒ | Lighthouse æŠ¥å‘Šç”Ÿæˆå¤±è´¥ |" >> performance-report.md
          fi

      - name: ğŸ” åŒ…å¤§å°åˆ†æ
        run: |
          echo "" >> performance-report.md
          echo "## ğŸ“¦ åŒ…å¤§å°åˆ†æ" >> performance-report.md
          echo "" >> performance-report.md

          # Install and run bundle analyzer
          npm install -g size-limit

          echo "### Size Limit åˆ†æ" >> performance-report.md
          echo "\`\`\`" >> performance-report.md
          npx size-limit --json 2>/dev/null | jq -r '
            if length > 0 then
              "æ–‡ä»¶ | å¤§å° | é™åˆ¶ | çŠ¶æ€",
              "--- | --- | --- | ---",
              (.[] | "\(.name) | \(.size) | \(.limit // "æ— é™åˆ¶") | \(if .passed == true then "âœ…" elif .passed == false then "âŒ" else "âš ï¸" end)")
            else
              "åŒ…å¤§å°åˆ†æå®Œæˆï¼Œæ— é…ç½®é™åˆ¶"
            end
          ' >> performance-report.md 2>/dev/null || echo "åŒ…å¤§å°åˆ†æå®Œæˆ" >> performance-report.md
          echo "\`\`\`" >> performance-report.md

      - name: âš¡ è¿è¡Œæ—¶æ€§èƒ½æµ‹è¯•
        run: |
          echo "" >> performance-report.md
          echo "## âš¡ è¿è¡Œæ—¶æ€§èƒ½æµ‹è¯•" >> performance-report.md
          echo "" >> performance-report.md

          # Simple runtime performance tests
          echo "### API å“åº”æ—¶é—´æµ‹è¯•" >> performance-report.md
          echo "\`\`\`" >> performance-report.md

          # Test API endpoints if available
          if curl -f http://localhost:5173/api/health > /dev/null 2>&1; then
            echo "å¥åº·æ£€æŸ¥ç«¯ç‚¹å“åº”æµ‹è¯•:" >> performance-report.md
            for i in {1..5}; do
              RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" http://localhost:5173/api/health)
              echo "è¯·æ±‚ $i: $(echo "$RESPONSE_TIME * 1000" | bc | xargs printf "%.0f")ms" >> performance-report.md
            done
          else
            echo "API ç«¯ç‚¹ä¸å¯ç”¨ï¼Œè·³è¿‡å“åº”æ—¶é—´æµ‹è¯•" >> performance-report.md
          fi

          echo "\`\`\`" >> performance-report.md

          echo "" >> performance-report.md
          echo "### å†…å­˜ä½¿ç”¨æƒ…å†µ" >> performance-report.md
          echo "\`\`\`" >> performance-report.md
          # Get memory usage if possible
          ps aux --no-headers -o pmem,pcpu,comm | head -5 >> performance-report.md 2>/dev/null || echo "å†…å­˜ç›‘æ§æ•°æ®ä¸å¯ç”¨" >> performance-report.md
          echo "\`\`\`" >> performance-report.md

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          # Stop the background server
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID 2>/dev/null || true
          fi

      - name: ğŸ“¤ Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-$(date +%Y%m%d)
          path: |
            performance-report.md
            lighthouse-report.json
          retention-days: 30

      - name: ğŸ“Š æ€§èƒ½å›å½’æ£€æµ‹
        run: |
          # Check for performance regressions
          if [ -f "lighthouse-report.json" ]; then
            PERFORMANCE_SCORE=$(node -e "console.log(Math.round(JSON.parse(require('fs').readFileSync('lighthouse-report.json')).categories.performance.score * 100))")

            # Define acceptable performance threshold
            THRESHOLD=80

            if [ "$PERFORMANCE_SCORE" -lt $THRESHOLD ]; then
              echo "PERFORMANCE_REGRESSION=true" >> $GITHUB_ENV
              echo "æ€§èƒ½åˆ†æ•° $PERFORMANCE_SCORE ä½äºé˜ˆå€¼ $THRESHOLDï¼Œæ£€æµ‹åˆ°æ€§èƒ½å›å½’"
            else
              echo "PERFORMANCE_REGRESSION=false" >> $GITHUB_ENV
              echo "æ€§èƒ½åˆ†æ•° $PERFORMANCE_SCORE ç¬¦åˆè¦æ±‚"
            fi
          fi

      - name: ğŸš¨ æ€§èƒ½å›å½’å‘Šè­¦
        if: env.PERFORMANCE_REGRESSION == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('performance-report.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ“‰ æ€§èƒ½å›å½’æ£€æµ‹ - éœ€è¦ç«‹å³å¤„ç†',
              body: \`## æ€§èƒ½å›å½’è­¦å‘Š\\n\\nğŸš¨ æ£€æµ‹åˆ°æ€§èƒ½æŒ‡æ ‡æ˜¾è‘—ä¸‹é™ï¼\\n\\n### ğŸ“Š å½“å‰æ€§èƒ½çŠ¶æ€\\n\`\`\`\\n${report}\\n\`\`\`\\n\\n### ğŸ” å¯èƒ½çš„åŸå› \\n- ğŸ“¦ æ–°å¢å¤§æ–‡ä»¶æˆ–ä¾èµ–\\n- ğŸŒ ä½æ•ˆçš„ä»£ç å®ç°\\n- ğŸŒ ç½‘ç»œè¯·æ±‚å¢åŠ \\n- ğŸ’¾ å†…å­˜æ³„æ¼\\n- ğŸ¨ æ¸²æŸ“æ€§èƒ½é—®é¢˜\\n\\n### ğŸ’¡ ä¿®å¤å»ºè®®\\n1. **ç«‹å³è°ƒæŸ¥**æœ€è¿‘çš„ä»£ç å˜æ›´\\n2. **åˆ†æ**Lighthouseæ€§èƒ½æŠ¥å‘Š\\n3. **æ£€æŸ¥**åŒ…å¤§å°å˜åŒ–\\n4. **ä¼˜åŒ–**æ€§èƒ½ç“¶é¢ˆ\\n5. **è€ƒè™‘**ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½\\n\\n### ğŸ“ ç´§æ€¥è”ç³»\\n- å‰ç«¯å›¢é˜Ÿ: frontend@company.com\\n- DevOpså›¢é˜Ÿ: devops@company.com\\n\\n### ğŸ¯ ç›®æ ‡\\n- æ€§èƒ½åˆ†æ•° â‰¥85\\n- é¦–æ¬¡å†…å®¹ç»˜åˆ¶ <1.8s\\n- æ€»åŒ…å¤§å° <2MB\\n\\n---\\n\\n*è‡ªåŠ¨ç”Ÿæˆçš„æ€§èƒ½å‘Šè­¦ - $(date)*\`,
              labels: ['performance', 'urgent', 'auto-generated', 'regression']
            });

  load-testing:
    name: è´Ÿè½½æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: performance-metrics
    if: github.event.inputs.test_type != 'lighthouse-only' || github.event_name == 'schedule'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build application
        run: pnpm build

      - name: ğŸš€ Start application
        run: |
          pnpm dev &
          SERVER_PID=$!

          # Wait for server to be ready
          echo "â³ Waiting for server to start..."
          for i in {1..30}; do
            if curl -f http://localhost:5173 > /dev/null 2>&1; then
              echo "âœ… Server is ready"
              break
            fi
            sleep 2
          done

          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

      - name: ğŸ§ª k6 è´Ÿè½½æµ‹è¯•
        run: |
          echo "ğŸ”¥ è¿è¡Œ k6 è´Ÿè½½æµ‹è¯•..."

          # Install k6
          curl -sSL https://github.com/grafana/k6/releases/latest/download/k6_0.45.0_linux_amd64.tar.gz | tar -xz
          sudo mv k6 /usr/local/bin/

          # Create k6 test script
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export const options = {
            stages: [
              { duration: '30s', target: 10 },  // Ramp up to 10 users
              { duration: '1m', target: 50 },   // Ramp up to 50 users
              { duration: '2m', target: 50 },   // Stay at 50 users
              { duration: '30s', target: 0 },   // Ramp down to 0 users
            ],
            thresholds: {
              http_req_duration: ['p(95)<500'], // 95% of requests should be below 500ms
              http_req_failed: ['rate<0.1'],    // Error rate should be below 10%
            },
          };

          export default function () {
            const response = http.get('http://localhost:5173');

            check(response, {
              'status is 200': (r) => r.status === 200,
              'response time < 500ms': (r) => r.timings.duration < 500,
            });

            sleep(1);
          }
          EOF

          # Run k6 test
          k6 run --out json=load-test-results.json load-test.js

      - name: ğŸ“Š ç”Ÿæˆè´Ÿè½½æµ‹è¯•æŠ¥å‘Š
        run: |
          echo "## ğŸ§ª è´Ÿè½½æµ‹è¯•ç»“æœ" > load-test-report.md
          echo "" >> load-test-report.md

          if [ -f "load-test-results.json" ]; then
            echo "### ğŸ“ˆ å…³é”®æŒ‡æ ‡" >> load-test-report.md
            echo "" >> load-test-report.md

            # Parse k6 results
            node -e "
              const fs = require('fs');
              const results = fs.readFileSync('load-test-results.json', 'utf8')
                .split('\\n')
                .filter(line => line.trim())
                .map(line => {
                  try {
                    return JSON.parse(line);
                  } catch (e) {
                    return null;
                  }
                })
                .filter(Boolean);

              if (results.length > 0) {
                console.log('| æŒ‡æ ‡ | å€¼ | çŠ¶æ€ |');
                console.log('|------|-----|------|');

                // Extract key metrics
                const metrics = results.filter(r => r.type === 'Point' && r.metric);

                // Find specific metrics
                const findMetric = (name) => metrics.find(m => m.metric === name);

                const httpReqDuration = findMetric('http_req_duration');
                const httpReqFailed = findMetric('http_req_failed');

                if (httpReqDuration) {
                  const p95 = Math.round(httpReqDuration.data.value);
                  const status = p95 < 500 ? 'âœ…' : p95 < 1000 ? 'âš ï¸' : 'âŒ';
                  console.log(\`| å“åº”æ—¶é—´ P95 | \${p95}ms | \${status} |\`);
                }

                if (httpReqFailed) {
                  const errorRate = (httpReqFailed.data.value * 100).toFixed(2);
                  const status = errorRate < 1 ? 'âœ…' : errorRate < 5 ? 'âš ï¸' : 'âŒ';
                  console.log(\`| é”™è¯¯ç‡ | \${errorRate}% | \${status} |\`);
                }

                console.log('');
                console.log('### ğŸ“Š è¯¦ç»†ç»“æœ');
                console.log('');
                console.log('| æŒ‡æ ‡ | æœ€å°å€¼ | å¹³å‡å€¼ | æœ€å¤§å€¼ | P95 | P99 |');
                console.log('|------|--------|--------|--------|-----|-----|');

                // More detailed metrics
                ['http_req_duration', 'http_req_waiting'].forEach(metricName => {
                  const metric = findMetric(metricName);
                  if (metric && metric.data) {
                    const data = metric.data;
                    console.log(\`| \${metricName} | \${Math.round(data.min)}ms | \${Math.round(data.avg)}ms | \${Math.round(data.max)}ms | \${Math.round(data['p(95)'])}ms | \${Math.round(data['p(99)'])}ms |\`);
                  }
                });
              } else {
                console.log('è´Ÿè½½æµ‹è¯•ç»“æœè§£æå¤±è´¥');
              }
            " >> load-test-report.md
          else
            echo "âŒ è´Ÿè½½æµ‹è¯•ç»“æœæ–‡ä»¶ä¸å­˜åœ¨" >> load-test-report.md
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID 2>/dev/null || true
          fi

      - name: ğŸ“¤ Upload load test report
        uses: actions/upload-artifact@v4
        with:
          name: load-test-report-$(date +%Y%m%d)
          path: |
            load-test-report.md
            load-test-results.json
            load-test.js
          retention-days: 30
