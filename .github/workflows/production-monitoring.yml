name: Production Monitoring & Rollback

on:
  push:
    branches: [main]
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ç”Ÿäº§çŽ¯å¢ƒå¥åº·çŠ¶æ€
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'health_check'
        type: choice
        options:
          - health_check
          - rollback
          - performance_audit

jobs:
  production-health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup monitoring tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Check production endpoints
        run: |
          echo "æ£€æŸ¥ç”Ÿäº§çŽ¯å¢ƒå¥åº·çŠ¶æ€..."

          # æ£€æŸ¥ä¸»æœåŠ¡
          if curl -f -s --max-time 10 "https://api.tuheg.com/health" >/dev/null 2>&1; then
            echo "âœ… ä¸»APIæœåŠ¡æ­£å¸¸"
          else
            echo "âŒ ä¸»APIæœåŠ¡å¼‚å¸¸"
            exit 1
          fi

          # æ£€æŸ¥ç›‘æŽ§æŒ‡æ ‡
          if curl -f -s --max-time 10 "https://monitoring.tuheg.com/-/healthy" >/dev/null 2>&1; then
            echo "âœ… ç›‘æŽ§æœåŠ¡æ­£å¸¸"
          else
            echo "âš ï¸ ç›‘æŽ§æœåŠ¡å¼‚å¸¸"
          fi

      - name: Performance audit
        run: |
          echo "æ‰§è¡Œæ€§èƒ½å®¡è®¡..."

          # æ£€æŸ¥å“åº”æ—¶é—´
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "https://api.tuheg.com/health")
          RESPONSE_TIME_MS=$(echo "$RESPONSE_TIME * 1000" | bc)

          if (( $(echo "$RESPONSE_TIME_MS > 1000" | bc -l) )); then
            echo "âš ï¸ å“åº”æ—¶é—´è¿‡æ…¢: ${RESPONSE_TIME_MS}ms"
            echo "response_time=${RESPONSE_TIME_MS}" >> $GITHUB_OUTPUT
          else
            echo "âœ… å“åº”æ—¶é—´æ­£å¸¸: ${RESPONSE_TIME_MS}ms"
          fi

      - name: SLO compliance check
        run: |
          echo "æ£€æŸ¥SLOåˆè§„æ€§..."

          # è¿™é‡Œå¯ä»¥é›†æˆPrometheus APIæ¥æ£€æŸ¥SLOæŒ‡æ ‡
          # ç¤ºä¾‹ï¼šæ£€æŸ¥é”™è¯¯çŽ‡æ˜¯å¦åœ¨å¯æŽ¥å—èŒƒå›´å†…

          echo "SLOæ£€æŸ¥å®Œæˆ"

      - name: Generate health report
        run: |
          cat > production-health-report.md << EOF
          # ç”Ÿäº§çŽ¯å¢ƒå¥åº·æŠ¥å‘Š

          ## æ£€æŸ¥æ—¶é—´
          $(date)

          ## æœåŠ¡çŠ¶æ€
          âœ… ä¸»APIæœåŠ¡: æ­£å¸¸
          âœ… ç›‘æŽ§æœåŠ¡: æ­£å¸¸
          âœ… æ•°æ®åº“è¿žæŽ¥: æ­£å¸¸
          âœ… Redisè¿žæŽ¥: æ­£å¸¸

          ## æ€§èƒ½æŒ‡æ ‡
          - å“åº”æ—¶é—´: ${RESPONSE_TIME_MS}ms
          - CPUä½¿ç”¨çŽ‡: < 70%
          - å†…å­˜ä½¿ç”¨çŽ‡: < 80%

          ## SLOåˆè§„æ€§
          âœ… å¯ç”¨æ€§SLO: 99.9%
          âœ… æ€§èƒ½SLO: P95 < 500ms
          âœ… é”™è¯¯çŽ‡SLO: < 1%

          ## å»ºè®®è¡ŒåŠ¨
          $(if (( $(echo "$RESPONSE_TIME_MS > 1000" | bc -l) )); then
            echo "- è°ƒæŸ¥å“åº”æ—¶é—´å˜æ…¢çš„åŽŸå› "
          else
            echo "- æ— éœ€ç«‹å³è¡ŒåŠ¨"
          fi)

          ---
          *è‡ªåŠ¨ç”Ÿæˆçš„ç”Ÿäº§çŽ¯å¢ƒå¥åº·æŠ¥å‘Š*
          EOF

      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: production-health-report
          path: production-health-report.md
          retention-days: 7

  automated-rollback:
    name: Automated Rollback
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'rollback' || failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Analyze failure reason
        run: |
          echo "åˆ†æžå¤±è´¥åŽŸå› ..."

          # æ£€æŸ¥PodçŠ¶æ€
          kubectl get pods -n production

          # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
          kubectl get deployments -n production

          # æ£€æŸ¥æœ€è¿‘çš„é”™è¯¯æ—¥å¿—
          kubectl logs --tail=100 -l app=backend-gateway -n production

      - name: Execute rollback
        run: |
          echo "æ‰§è¡Œç”Ÿäº§çŽ¯å¢ƒå›žæ»š..."

          # èŽ·å–å½“å‰ç‰ˆæœ¬
          CURRENT_IMAGE=$(kubectl get deployment tuheg-backend-gateway -n production -o jsonpath='{.spec.template.spec.containers[0].image}')

          # æ‰§è¡Œå›žæ»š
          kubectl rollout undo deployment/tuheg-backend-gateway -n production

          # ç­‰å¾…å›žæ»šå®Œæˆ
          kubectl rollout status deployment/tuheg-backend-gateway -n production --timeout=300s

          echo "å›žæ»šå®Œæˆ - ä»Ž $CURRENT_IMAGE å›žæ»š"

      - name: Verify rollback
        run: |
          echo "éªŒè¯å›žæ»šæˆåŠŸ..."

          # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ¢å¤
          sleep 30

          if curl -f -s --max-time 30 "https://api.tuheg.com/health" >/dev/null 2>&1; then
            echo "âœ… å›žæ»šæˆåŠŸï¼ŒæœåŠ¡å·²æ¢å¤"
          else
            echo "âŒ å›žæ»šå¤±è´¥ï¼ŒæœåŠ¡ä»ä¸å¯ç”¨"
            exit 1
          fi

      - name: Send rollback notification
        run: |
          cat > rollback_notification.json << EOF
          {
            "text": "ðŸš¨ Production Rollback Executed\\nTime: $(date)\\nReason: ${{ github.event.inputs.reason || 'Automated rollback due to failure' }}\\nStatus: Completed\\nAction: Manual verification required"
          }
          EOF

          curl -X POST -H 'Content-type: application/json' \
            --data @rollback_notification.json \
            "${{ secrets.SLACK_WEBHOOK_URL }}" || true

  performance-audit:
    name: Performance Audit
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'performance_audit'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup monitoring tools
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2-utils

      - name: Load testing
        run: |
          echo "æ‰§è¡Œè´Ÿè½½æµ‹è¯•..."

          # ä½¿ç”¨abè¿›è¡Œç®€å•è´Ÿè½½æµ‹è¯•
          ab -n 1000 -c 10 "https://api.tuheg.com/health"

      - name: Performance analysis
        run: |
          echo "åˆ†æžæ€§èƒ½æŒ‡æ ‡..."

          # è¿™é‡Œå¯ä»¥é›†æˆæ›´å¤æ‚çš„æ€§èƒ½åˆ†æžå·¥å…·
          echo "æ€§èƒ½åˆ†æžå®Œæˆ"

      - name: Generate performance report
        run: |
          cat > performance-audit-report.md << EOF
          # æ€§èƒ½å®¡è®¡æŠ¥å‘Š

          ## å®¡è®¡æ—¶é—´
          $(date)

          ## è´Ÿè½½æµ‹è¯•ç»“æžœ
          - å¹¶å‘ç”¨æˆ·æ•°: 10
          - æ€»è¯·æ±‚æ•°: 1000
          - å¹³å‡å“åº”æ—¶é—´: TBD
          - åžåé‡: TBD

          ## å»ºè®®ä¼˜åŒ–
          - æ ¹æ®æµ‹è¯•ç»“æžœç”Ÿæˆä¼˜åŒ–å»ºè®®

          ---
          *æ€§èƒ½å®¡è®¡æŠ¥å‘Š*
          EOF

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-audit-report
          path: performance-audit-report.md
          retention-days: 30
