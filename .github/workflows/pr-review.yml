name: ğŸ” PR è´¨é‡å®¡æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  pr-validation:
    name: PR è´¨é‡éªŒè¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9.x

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“ Validate commit messages
        run: |
          # Check conventional commit format
          npx commitlint --from ${{ github.event.pull_request.head.sha }}~${{ github.event.pull_request.commits }} --to ${{ github.event.pull_request.head.sha }} --verbose

      - name: ğŸ—ï¸ Build validation
        run: pnpm build

      - name: ğŸ” Code quality check
        run: pnpm lint

      - name: ğŸ“Š Incremental test coverage
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Run tests for changed components
          if echo "$CHANGED_FILES" | grep -q "packages/common-backend"; then
            echo "Backend changes detected, running backend tests..."
            pnpm test packages/common-backend/ --coverage --passWithNoTests
          fi

          if echo "$CHANGED_FILES" | grep -q "apps/frontend"; then
            echo "Frontend changes detected, running frontend tests..."
            pnpm test apps/frontend/ --coverage --passWithNoTests
          fi

      - name: ğŸ“ PR size analysis
        uses: codiga/git-changes-analyzer@v1
        id: analyze
        with:
          path: ${{ github.workspace }}

      - name: ğŸ·ï¸ PR size label
        uses: codiga/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message_if_xl: |
            This PR is very large. Consider splitting it into multiple smaller PRs for easier review.

  pr-quality-gate:
    name: è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: pr-validation

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9.x

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“Š Calculate quality score
        id: quality-score
        run: |
          echo "ğŸ§® è®¡ç®—PRè´¨é‡åˆ†æ•°..."
          SCORE=0

          # ä»£ç è´¨é‡ (30åˆ†)
          if pnpm lint > /dev/null 2>&1; then
            SCORE=$((SCORE + 30))
            echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡ (+30åˆ†)"
          else
            echo "âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥"
          fi

          # æµ‹è¯•è¦†ç›– (40åˆ†)
          pnpm test:coverage > /dev/null 2>&1
          if [ $? -eq 0 ] && [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.statements.pct)")
            if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
              SCORE=$((SCORE + 40))
              echo "âœ… æµ‹è¯•è¦†ç›–ç‡ä¼˜ç§€ (+40åˆ†)"
            elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
              SCORE=$((SCORE + 30))
              echo "âš ï¸ æµ‹è¯•è¦†ç›–ç‡è‰¯å¥½ (+30åˆ†)"
            elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
              SCORE=$((SCORE + 20))
              echo "âš ï¸ æµ‹è¯•è¦†ç›–ç‡ä¸€èˆ¬ (+20åˆ†)"
            else
              SCORE=$((SCORE + 10))
              echo "âŒ æµ‹è¯•è¦†ç›–ç‡ä¸è¶³ (+10åˆ†)"
            fi
          else
            echo "âš ï¸ æ— æ³•è·å–æµ‹è¯•è¦†ç›–ç‡"
            SCORE=$((SCORE + 10))
          fi

          # å®‰å…¨æ£€æŸ¥ (20åˆ†)
          if pnpm audit --audit-level moderate > /dev/null 2>&1; then
            SCORE=$((SCORE + 20))
            echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ (+20åˆ†)"
          else
            echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜"
            SCORE=$((SCORE + 10))
          fi

          # ç±»å‹æ£€æŸ¥ (10åˆ†)
          if pnpm build > /dev/null 2>&1; then
            SCORE=$((SCORE + 10))
            echo "âœ… ç±»å‹æ£€æŸ¥é€šè¿‡ (+10åˆ†)"
          else
            echo "âŒ ç±»å‹æ£€æŸ¥å¤±è´¥"
          fi

          echo "ğŸ“Š æ€»åˆ†: $SCORE/100"
          echo "score=$SCORE" >> $GITHUB_OUTPUT

          if [ $SCORE -ge 80 ]; then
            echo "ğŸ‰ PRè´¨é‡ä¼˜ç§€ï¼"
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ $SCORE -ge 60 ]; then
            echo "âš ï¸ PRè´¨é‡è‰¯å¥½ï¼Œéœ€è¦æ”¹è¿›"
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "âŒ PRè´¨é‡ä¸è¶³ï¼Œéœ€è¦é‡å¤§æ”¹è¿›"
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

  pr-feedback:
    name: ç”ŸæˆPRåé¦ˆ
    runs-on: ubuntu-latest
    needs: pr-quality-gate
    if: always()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ’¬ Generate comprehensive PR feedback
        uses: actions/github-script@v7
        with:
          script: |
            const qualityScore = ${{ needs.pr-quality-gate.outputs.score || 0 }};
            const status = '${{ needs.pr-quality-gate.outputs.status || "unknown" }}';

            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            let comment = '## ğŸ” PR è´¨é‡æ£€æŸ¥æŠ¥å‘Š\\n\\n';

            // Quality scoring with emojis
            if (qualityScore >= 80) {
              comment += 'ğŸ‰ **ä¼˜ç§€** - PRè´¨é‡å¾ˆé«˜ï¼Œå¯ä»¥æ”¾å¿ƒåˆå¹¶ï¼\\n\\n';
            } else if (qualityScore >= 60) {
              comment += 'âš ï¸ **è‰¯å¥½** - PRåŸºæœ¬è¾¾æ ‡ï¼Œå»ºè®®å°å¹…æ”¹è¿›\\n\\n';
            } else {
              comment += 'âŒ **éœ€è¦æ”¹è¿›** - PRè´¨é‡ä¸è¶³ï¼Œå»ºè®®é‡å¤§ä¿®æ”¹\\n\\n';
            }

            comment += `### ğŸ“Š è´¨é‡è¯„åˆ†: **\${qualityScore}/100**\\n\\n`;

            // Detailed feedback
            comment += '### âœ… æ£€æŸ¥ç»“æœ\\n\\n';
            comment += '| æ£€æŸ¥é¡¹ | çŠ¶æ€ | æƒé‡ | å¾—åˆ† |\\n';
            comment += '|--------|------|------|------|\\n';

            // Code quality
            const lintPassed = qualityScore >= 30 ? 'âœ…' : 'âŒ';
            comment += \`| ä»£ç è´¨é‡ (ESLint) | \${lintPassed} | 30åˆ† | \${qualityScore >= 30 ? '30' : '0'} |\\n\`;

            // Test coverage
            let coverageStatus = 'âŒ';
            let coverageScore = '0';
            if (qualityScore >= 40) {
              coverageStatus = 'âœ…';
              coverageScore = '40';
            } else if (qualityScore >= 30) {
              coverageStatus = 'âš ï¸';
              coverageScore = '30';
            } else if (qualityScore >= 20) {
              coverageStatus = 'âš ï¸';
              coverageScore = '20';
            } else if (qualityScore >= 10) {
              coverageStatus = 'âš ï¸';
              coverageScore = '10';
            }
            comment += \`| æµ‹è¯•è¦†ç›–ç‡ | \${coverageStatus} | 40åˆ† | \${coverageScore} |\\n\`;

            // Security
            const securityStatus = qualityScore >= 20 ? 'âœ…' : 'âš ï¸';
            const securityScore = qualityScore >= 20 ? '20' : '10';
            comment += \`| å®‰å…¨æ£€æŸ¥ | \${securityStatus} | 20åˆ† | \${securityScore} |\\n\`;

            // TypeScript
            const tsStatus = qualityScore % 10 == 0 ? 'âœ…' : 'âŒ';
            const tsScore = qualityScore % 10 == 0 ? '10' : '0';
            comment += \`| ç±»å‹æ£€æŸ¥ | \${tsStatus} | 10åˆ† | \${tsScore} |\\n\`;

            comment += '\\n';

            // PR information
            comment += '### ğŸ“‹ PR ä¿¡æ¯\\n\\n';
            comment += \`| å±æ€§ | å€¼ |\\n\`;
            comment += \`|------|-----|\\n\`;
            comment += \`| åˆ†æ”¯ | \`\${pr.head.ref}\` â†’ \`\${pr.base.ref}\` |\\n\`;
            comment += \`| æäº¤æ•° | \${pr.commits} |\\n\`;
            comment += \`| æ›´æ”¹æ–‡ä»¶ | \${pr.changed_files} |\\n\`;
            comment += \`| æ·»åŠ è¡Œæ•° | +\${pr.additions} |\\n\`;
            comment += \`| åˆ é™¤è¡Œæ•° | -\${pr.deletions} |\\n\`;
            comment += '\\n';

            // Improvement suggestions
            if (status !== 'success') {
              comment += '### ğŸ’¡ æ”¹è¿›å»ºè®®\\n\\n';

              if (qualityScore < 60) {
                comment += '**ğŸ”´ ç´§æ€¥æ”¹è¿›é¡¹ï¼š**\\n\\n';
                comment += '- ğŸ”´ æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•ï¼Œæå‡è¦†ç›–ç‡åˆ°80%ä»¥ä¸Š\\n';
                comment += '- ğŸ”´ ä¿®å¤æ‰€æœ‰ESLinté”™è¯¯å’Œè­¦å‘Š\\n';
                comment += '- ğŸ”´ è§£å†³æ‰€æœ‰TypeScriptç±»å‹é”™è¯¯\\n';
                comment += '- ğŸ”´ è§£å†³é«˜ä¼˜å…ˆçº§å®‰å…¨æ¼æ´\\n\\n';
              }

              comment += '**ğŸŸ¡ å»ºè®®æ”¹è¿›é¡¹ï¼š**\\n\\n';
              comment += '- ğŸŸ¡ è€ƒè™‘å°†å¤§PRæ‹†åˆ†ä¸ºå¤šä¸ªå°PR\\n';
              comment += '- ğŸŸ¡ æ·»åŠ æ›´è¯¦ç»†çš„æäº¤ä¿¡æ¯\\n';
              comment += '- ğŸŸ¡ æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œæ³¨é‡Š\\n';
              comment += '- ğŸŸ¡ è€ƒè™‘æ·»åŠ é›†æˆæµ‹è¯•\\n\\n';
            }

            // Quality standards
            comment += '### ğŸ“ˆ è´¨é‡æ ‡å‡†\\n\\n';
            comment += '| æŒ‡æ ‡ | å½“å‰è¦æ±‚ | ç›®æ ‡æ ‡å‡† | çŠ¶æ€ |\\n';
            comment += '|------|----------|----------|------|\\n';
            comment += '| ä»£ç è´¨é‡ | é›¶ESLinté”™è¯¯ | é›¶è­¦å‘Š | ' + (lintPassed === 'âœ…' ? 'âœ…' : 'âŒ') + ' |\\n';
            comment += '| æµ‹è¯•è¦†ç›– | â‰¥70% | â‰¥80% | ' + coverageStatus + ' |\\n';
            comment += '| ç±»å‹æ£€æŸ¥ | é›¶TypeScripté”™è¯¯ | é›¶é”™è¯¯ | ' + tsStatus + ' |\\n';
            comment += '| å®‰å…¨å®¡è®¡ | é›¶é«˜å±æ¼æ´ | é›¶ä¸­å±ä»¥ä¸Š | ' + securityStatus + ' |\\n\\n';

            // Next steps
            comment += '### ğŸ¯ ä¸‹ä¸€æ­¥\\n\\n';
            if (status === 'success') {
              comment += 'âœ… **å‡†å¤‡åˆå¹¶** - PRå·²è¾¾åˆ°æ‰€æœ‰è´¨é‡æ ‡å‡†ï¼\\n\\n';
              comment += 'ğŸš€ å¯ä»¥å®‰å…¨åœ°åˆå¹¶è¿™ä¸ªPRåˆ°ä¸»åˆ†æ”¯ã€‚\\n\\n';
            } else if (status === 'warning') {
              comment += 'âš ï¸ **éœ€è¦å®¡æ ¸** - PRè´¨é‡å¯æ¥å—ï¼Œä½†å»ºè®®æ”¹è¿›\\n\\n';
              comment += 'ğŸ” è¯·ä»£ç å®¡æŸ¥è€…é‡ç‚¹æ£€æŸ¥å»ºè®®çš„æ”¹è¿›é¡¹ã€‚\\n\\n';
            } else {
              comment += 'âŒ **éœ€è¦ä¿®æ”¹** - PRè´¨é‡ä¸è¶³ï¼Œå¿…é¡»æ”¹è¿›\\n\\n';
              comment += 'ğŸ”§ è¯·æŒ‰æ”¹è¿›å»ºè®®ä¿®æ”¹ä»£ç åé‡æ–°æäº¤ã€‚\\n\\n';
            }

            comment += '### ğŸ“ æ”¯æŒ\\n\\n';
            comment += '- ğŸ“– [ä»£ç è§„èŒƒ](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/CONTRIBUTING.md)\\n';
            comment += '- ğŸ§ª [æµ‹è¯•æŒ‡å—](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/docs/testing.md)\\n';
            comment += '- ğŸ”’ [å®‰å…¨è¦æ±‚](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/SECURITY.md)\\n\\n';

            comment += '---\\n\\n';
            comment += '*æ­¤æŠ¥å‘Šç”± ğŸ¤– è‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥ç³»ç»Ÿç”Ÿæˆ | éµå¾ª GitHub ç¤¾åŒºæœ€ä½³å®è·µ*\\n\\n';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('PRè´¨é‡æ£€æŸ¥æŠ¥å‘Š')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  # Require PR approval for main branch
  require-approval:
    name: è¦æ±‚å®¡æ‰¹
    runs-on: ubuntu-latest
    needs: pr-quality-gate
    if: github.event.pull_request.base.ref == 'main' && needs.pr-quality-gate.outputs.status != 'success'

    steps:
      - name: ğŸš« é˜»æ­¢ä½è´¨é‡PRåˆå¹¶åˆ°mainåˆ†æ”¯
        run: |
          echo "âŒ PRè´¨é‡ä¸è¶³ï¼Œé˜»æ­¢åˆå¹¶åˆ°mainåˆ†æ”¯"
          echo "è¯·æ ¹æ®åé¦ˆå»ºè®®æ”¹è¿›ä»£ç è´¨é‡ï¼Œç„¶åé‡æ–°æäº¤"
          exit 1
