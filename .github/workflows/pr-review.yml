name: PR Review & Quality Gates

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # æ£€æŸ¥æ˜¯å¦ç¬¦åˆConventional Commitsæ ¼å¼
          if ! echo "$PR_TITLE" | grep -E "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?: .{10,}" > /dev/null; then
            echo "âŒ PR title does not follow conventional commit format"
            echo "Expected format: type(scope): description (min 10 chars)"
            echo "Example: feat(auth): add user login functionality"
            exit 1
          fi

          echo "âœ… PR title format is valid"

      - name: Check branch naming
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch: $BRANCH_NAME"

          # æ£€æŸ¥åˆ†æ”¯å‘½åè§„èŒƒ
          if ! echo "$BRANCH_NAME" | grep -E "^(feature|bugfix|hotfix|chore)/.+" > /dev/null; then
            echo "âŒ Branch name does not follow naming convention"
            echo "Expected formats: feature/*, bugfix/*, hotfix/*, chore/*"
            exit 1
          fi

          echo "âœ… Branch name follows convention"

      - name: Run Linting
        run: pnpm turbo run lint

      - name: Run TypeScript checks
        run: pnpm turbo run type-check || pnpm run build

      - name: Run Tests
        run: pnpm turbo run test

      - name: Run Security Audit
        run: pnpm audit --audit-level high

      - name: Check test coverage
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json')); console.log(data.total.lines.pct)")
            echo "Coverage: ${COVERAGE}%"

            if (( $(echo "$COVERAGE < 80" | bc -l) )); then
              echo "âŒ Test coverage is below 80%"
              exit 1
            fi

            echo "âœ… Test coverage meets threshold"
          else
            echo "âš ï¸ No coverage report found"
          fi

      - name: Check PR size
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 | wc -l)
          CHANGED_LINES=$(git diff --stat HEAD~1 | tail -1 | awk '{print $4+$6}')

          echo "Changed files: $CHANGED_FILES"
          echo "Changed lines: $CHANGED_LINES"

          if [ "$CHANGED_FILES" -gt 50 ]; then
            echo "âš ï¸ Large PR: $CHANGED_FILES files changed"
          fi

          if [ "$CHANGED_LINES" -gt 1000 ]; then
            echo "âš ï¸ Large PR: $CHANGED_LINES lines changed"
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          config-file: '.github/dependency-review-config.yml'

      - name: Check for vulnerable dependencies
        run: |
          echo "ğŸ” Checking for dependency vulnerabilities..."
          npx audit-ci --config audit-ci.json || exit 1

  code-quality-review:
    name: Code Quality Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Biome checks
        run: npx @biomejs/biome check . --apply-unsafe || npx @biomejs/biome check .

      - name: Check for TODO comments
        run: |
          TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX" --include="*.ts" --include="*.js" --include="*.vue" apps/ packages/ | wc -l)
          if [ "$TODO_COUNT" -gt 5 ]; then
            echo "âš ï¸ Found $TODO_COUNT TODO/FIXME comments"
            echo "Consider addressing these before merge"
          fi

      - name: Check for console.log statements
        run: |
          CONSOLE_COUNT=$(grep -r "console\." --include="*.ts" --include="*.js" apps/ packages/ | grep -v "console\.error\|console\.warn" | wc -l)
          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            echo "âš ï¸ Found $CONSOLE_COUNT console statements (excluding error/warn)"
            echo "Consider removing debug console statements"
          fi

      - name: Check bundle size impact
        uses: codacy/git-version@v2
        with:
          release-branch: main

  pr-comments:
    name: PR Comments & Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: [pr-validation, dependency-review, code-quality-review]

    steps:
      - name: Add PR review checklist
        uses: actions/github-script@v7
        with:
          script: |
            const body = `
            ## ğŸ” PR Review Checklist

            ### âœ… Automated Checks
            - [x] Branch naming convention
            - [x] PR title follows conventional commits
            - [x] Linting passes
            - [x] TypeScript compilation succeeds
            - [x] Tests pass
            - [x] Test coverage â‰¥ 80%
            - [x] Security audit passes
            - [x] Dependency review passes

            ### ğŸ”§ Manual Review Required
            - [ ] Code follows project conventions
            - [ ] Appropriate error handling
            - [ ] Security considerations addressed
            - [ ] Performance impact assessed
            - [ ] Documentation updated if needed
            - [ ] Breaking changes clearly documented

            ### ğŸ§ª Testing
            - [ ] Unit tests added/updated
            - [ ] Integration tests pass
            - [ ] E2E tests pass (if applicable)
            - [ ] Manual testing performed

            ### ğŸ“‹ Additional Notes
            - **Size**: ${context.payload.pull_request.changed_files} files changed
            - **Labels**: ${{ context.payload.pull_request.labels.map(l => l.name).join(', ') || 'None' }}

            ---
            *This checklist was automatically generated. Please review and update as needed.*
            `

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      - name: Request reviewers
        if: contains(github.event.pull_request.labels.*.name, 'requires-review')
        run: |
          echo "ğŸ” This PR requires additional review"
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥è‡ªåŠ¨åˆ†é…å®¡æŸ¥è€…

  pr-size-label:
    name: PR Size Labeling
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Label PR by size
        uses: codacy/git-version@v2
        with:
          release-branch: main
          dev-branch: develop

      - name: Size label
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'
          message_if_xl: |
            This PR is very large. Consider splitting it into multiple smaller PRs for easier review.
          github_api_url: 'api.github.com'
