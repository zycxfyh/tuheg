name: PR Review & Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

jobs:
  # PRè´¨é‡è¯„ä¼°
  quality-check:
    name: 'PR Quality Assessment'
    runs-on: ubuntu-latest
    outputs:
      score: ${{ steps.quality-score.outputs.score }}
      size: ${{ steps.pr-size.outputs.size }}
      risk: ${{ steps.risk-assessment.outputs.risk }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze PR size
        id: pr-size
        uses: codiga/github-action-pr-size-analyzer@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          base: ${{ github.event.pull_request.base.ref }}
          head: ${{ github.event.pull_request.head.ref }}

      - name: Quality score calculation
        id: quality-score
        run: |
          # è®¡ç®—è´¨é‡åˆ†æ•° (0-100)
          SCORE=85

          # æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•æ–‡ä»¶
          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E '\.(test|spec)\.(ts|js)$'; then
            SCORE=$((SCORE + 5))
          fi

          # æ£€æŸ¥æ–‡æ¡£æ›´æ–°
          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E '\.(md|txt)$'; then
            SCORE=$((SCORE + 5))
          fi

          echo "score=$SCORE" >> $GITHUB_OUTPUT

      - name: Risk assessment
        id: risk-assessment
        run: |
          # åŸºäºæ–‡ä»¶å˜æ›´è¿›è¡Œé£é™©è¯„ä¼°
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l)
          CRITICAL_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E '(security|auth|config|database)' | wc -l)

          if [ "$CRITICAL_FILES" -gt 0 ]; then
            RISK="high"
          elif [ "$CHANGED_FILES" -gt 20 ]; then
            RISK="medium"
          else
            RISK="low"
          fi

          echo "risk=$RISK" >> $GITHUB_OUTPUT

  # æ™ºèƒ½åé¦ˆè¯„è®º
  feedback:
    name: 'Smart PR Feedback'
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8.x'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate PR feedback
        id: feedback
        run: |
          SCORE=${{ needs.quality-check.outputs.score }}
          SIZE=${{ needs.quality-check.outputs.size }}
          RISK=${{ needs.quality-check.outputs.risk }}

          # ç”Ÿæˆä¸ªæ€§åŒ–åé¦ˆ
          FEEDBACK="## ğŸ” PR è´¨é‡è¯„ä¼°æŠ¥å‘Š

          ### ğŸ“Š è´¨é‡æŒ‡æ ‡
          - **è´¨é‡åˆ†æ•°**: $SCORE/100 â­
          - **å˜æ›´è§„æ¨¡**: $SIZE
          - **é£é™©ç­‰çº§**: $RISK

          ### âœ… æ£€æŸ¥æ¸…å•
          $([ "$SCORE" -ge 80 ] && echo "- âœ… ä»£ç è´¨é‡è‰¯å¥½" || echo "- âš ï¸ å»ºè®®æ”¹è¿›ä»£ç è´¨é‡")
          $(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q '\.(test|spec)\.' && echo "- âœ… åŒ…å«æµ‹è¯•ä»£ç " || echo "- âš ï¸ å»ºè®®æ·»åŠ æµ‹è¯•")
          $(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q '\.md$' && echo "- âœ… æ›´æ–°äº†æ–‡æ¡£" || echo "- ğŸ’¡ è€ƒè™‘æ›´æ–°ç›¸å…³æ–‡æ¡£")

          ### ğŸ¯ æ”¹è¿›å»ºè®®
          $([ "$RISK" = "high" ] && echo "- ğŸ”´ é«˜é£é™©å˜æ›´ï¼Œå»ºè®®ä»”ç»†å®¡æŸ¥")
          $([ "$SIZE" = "XXL" ] && echo "- ğŸ“ å¤§å‹PRï¼Œå»ºè®®æ‹†åˆ†ä¸ºå¤šä¸ªå°PR")
          $([ "$SCORE" -lt 70 ] && echo "- ğŸ“ˆ è´¨é‡åˆ†æ•°è¾ƒä½ï¼Œå»ºè®®ä¼˜åŒ–ä»£ç ç»“æ„")

          ### ğŸ¤– AIåŠ©æ‰‹å»ºè®®
          åŸºäºæ‚¨çš„å˜æ›´ï¼Œè¿™ä¸ªPRä¸»è¦æ¶‰åŠAIå¯¹è¯ç³»ç»Ÿçš„æ”¹è¿›ã€‚å»ºè®®é‡ç‚¹å…³æ³¨ï¼š
          - ç”¨æˆ·ä½“éªŒåé¦ˆæœºåˆ¶
          - é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
          - æ€§èƒ½ç›‘æ§æŒ‡æ ‡"

          echo "feedback<<EOF" >> $GITHUB_OUTPUT
          echo "$FEEDBACK" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${{ steps.feedback.outputs.feedback }}`
            })

  # è‡ªåŠ¨æ ‡ç­¾ç®¡ç†
  labeling:
    name: 'Smart Labeling'
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze changed files
        id: file-analysis
        run: |
          # åˆ†æå˜æ›´æ–‡ä»¶ç±»å‹
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})

          # åˆ†ç±»æ ‡ç­¾
          if echo "$CHANGED_FILES" | grep -q "^apps/frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "^apps/.*-agent/"; then
            echo "ai-agent=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "^packages/"; then
            echo "shared-package=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -qE "\.(test|spec)\.(ts|js)$"; then
            echo "testing=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -qE "\.(md|txt)$"; then
            echo "documentation=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "security\|auth\|config"; then
            echo "security=true" >> $GITHUB_OUTPUT
          fi

      - name: Apply labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = []

            // åŸºäºæ–‡ä»¶åˆ†ææ·»åŠ æ ‡ç­¾
            if ('${{ steps.file-analysis.outputs.frontend }}' === 'true') labels.push('frontend')
            if ('${{ steps.file-analysis.outputs.ai-agent }}' === 'true') labels.push('ai-agent')
            if ('${{ steps.file-analysis.outputs.shared-package }}' === 'true') labels.push('shared-package')
            if ('${{ steps.file-analysis.outputs.testing }}' === 'true') labels.push('testing')
            if ('${{ steps.file-analysis.outputs.documentation }}' === 'true') labels.push('documentation')
            if ('${{ steps.file-analysis.outputs.security }}' === 'true') labels.push('security')

            // åŸºäºé£é™©ç­‰çº§æ·»åŠ æ ‡ç­¾
            const risk = '${{ needs.quality-check.outputs.risk }}'
            if (risk === 'high') labels.push('high-risk')
            else if (risk === 'medium') labels.push('medium-risk')
            else labels.push('low-risk')

            // åŸºäºå¤§å°æ·»åŠ æ ‡ç­¾
            const size = '${{ needs.quality-check.outputs.size }}'
            labels.push(`size: ${size}`)

            // åº”ç”¨æ ‡ç­¾
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              })
            }

  # è´¨é‡é—¨ç¦
  quality-gate:
    name: 'Quality Gate'
    runs-on: ubuntu-latest
    needs: [quality-check, feedback]
    if: github.event.pull_request.draft == false

    steps:
      - name: Quality gate check
        run: |
          SCORE=${{ needs.quality-check.outputs.score }}
          RISK=${{ needs.quality-check.outputs.risk }}

          # è´¨é‡é—¨ç¦è§„åˆ™
          if [ "$SCORE" -lt 70 ]; then
            echo "âŒ Quality score too low: $SCORE/100"
            exit 1
          fi

          if [ "$RISK" = "high" ] && [ "$SCORE" -lt 85 ]; then
            echo "âŒ High risk PR requires higher quality score: $SCORE/100"
            exit 1
          fi

          echo "âœ… Quality gate passed: Score $SCORE/100, Risk $RISK"