// 文件路径: packages/common-backend/src/prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique @db.VarChar(255)
  password  String    @db.VarChar(255)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  games     Game[]
  aiConfigs AiConfiguration[]

  @@map("users")
}

model Game {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(200)
  owner     User     @relation(fields: [ownerId], references: [id])
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  character Character?
  worldBook WorldBookEntry[]
  memories  Memory[]

  @@map("games")
}

model Character {
  id     String @id @default(cuid())
  game   Game   @relation(fields: [gameId], references: [id])
  gameId String @unique
  name   String @db.VarChar(100)
  hp     Int    @default(100)
  maxHp  Int    @default(100)
  mp     Int    @default(50)
  maxMp  Int    @default(50)
  status String @default("Normal") @db.VarChar(50)
  card   Json   @default("{}")

  @@map("characters")
}

model WorldBookEntry {
  id      String @id @default(cuid())
  game    Game   @relation(fields: [gameId], references: [id])
  gameId  String
  key     String @db.VarChar(200)
  content Json

  @@map("world_book_entries")
}

// [!] 核心改造：修改 AiConfiguration 模型并添加 Role 模型
model AiConfiguration {
  id        String   @id @default(cuid())
  owner     User     @relation(fields: [ownerId], references: [id])
  ownerId   String
  provider  String   @db.VarChar(50)
  apiKey    String   @db.VarChar(500)
  modelId   String   @db.VarChar(200)
  baseUrl   String?  @db.VarChar(500)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // [!] 桥梁的第一端：一个配置可以有多个角色
  roles     Role[]

  @@map("ai_configurations")
}

model Role {
  id             String            @id @default(cuid())
  name           String            @unique @db.VarChar(100) // e.g., "logic_parsing", "critic"
  description    String?           @db.VarChar(500)

  // [!] 桥梁的第二端：一个角色可以被多个配置使用
  configurations AiConfiguration[]

  @@map("roles")
}

model Memory {
  id        String    @id @default(cuid())
  game      Game      @relation(fields: [gameId], references: [id])
  gameId    String
  content   String    @db.Text
  embedding Unsupported("vector(1536)")?
  createdAt DateTime  @default(now())

  @@map("memories")
}