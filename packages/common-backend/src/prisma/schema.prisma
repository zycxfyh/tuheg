// 文件路径: packages/common-backend/src/prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique @db.Text
  password  String    @db.Text
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  games     Game[]
  aiConfigs AiConfiguration[]

  @@map("users")
}

model Game {
  id        String   @id @default(cuid())
  name      String   @db.Text
  owner     User     @relation(fields: [ownerId], references: [id])
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  character Character?
  worldBook WorldBookEntry[]
  memories  Memory[]

  @@map("games")
}

model Character {
  id     String @id @default(cuid())
  game   Game   @relation(fields: [gameId], references: [id])
  gameId String @unique
  name   String @db.Text
  hp     Int    @default(100)
  maxHp  Int    @default(100)
  mp     Int    @default(50)
  maxMp  Int    @default(50)
  status String @default("Normal") @db.Text
  card   Json   @default("{}")

  @@map("characters")
}

model WorldBookEntry {
  id      String @id @default(cuid())
  game    Game   @relation(fields: [gameId], references: [id])
  gameId  String
  key     String @db.Text
  content Json

  @@map("world_book_entries")
}

// [!] 核心改造：修改 AiConfiguration 模型并添加 Role 模型
model AiConfiguration {
  id        String   @id @default(cuid())
  owner     User     @relation(fields: [ownerId], references: [id])
  ownerId   String
  provider  String   @db.Text
  apiKey    String   @db.Text
  modelId   String   @db.Text
  baseUrl   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // [!] 桥梁的第一端：一个配置可以有多个角色
  roles     Role[]

  @@map("ai_configurations")
}

model Role {
  id             String            @id @default(cuid())
  name           String            @unique @db.Text // e.g., "logic_parsing", "critic"
  description    String?           @db.Text

  // [!] 桥梁的第二端：一个角色可以被多个配置使用
  configurations AiConfiguration[]

  @@map("roles")
}

model Memory {
  id        String    @id @default(cuid())
  game      Game      @relation(fields: [gameId], references: [id])
  gameId    String
  content   String    @db.Text
  embedding Unsupported("vector(1536)")?
  createdAt DateTime  @default(now())

  @@map("memories")
}

// ==================== 插件市场系统 ====================

model PluginMarketplace {
  id            String             @id @default(cuid())
  name          String             @unique @db.Text
  displayName   String             @db.Text
  description   String             @db.Text
  authorId      String
  author        User               @relation(fields: [authorId], references: [id])
  categoryId    String
  category      PluginCategory     @relation(fields: [categoryId], references: [id])
  status        PluginStatus       @default(PENDING_REVIEW)
  isPublic      Boolean            @default(false)
  isFeatured    Boolean            @default(false)
  homepage      String?            @db.Text
  repository    String?            @db.Text
  license       String?            @db.Text
  totalDownloads Int               @default(0)
  averageRating Decimal?           @db.Decimal(3, 2)
  reviewCount   Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  // 关联
  versions      PluginVersion[]
  reviews       PluginReview[]
  downloads     PluginDownload[]
  tags          PluginTag[]
  dependencies  PluginDependency[] @relation("PluginDependencies")
  dependents    PluginDependency[] @relation("DependentPlugins")

  @@map("plugin_marketplace")
}

model PluginVersion {
  id            String            @id @default(cuid())
  pluginId      String
  plugin        PluginMarketplace @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  version       String            @db.Text
  changelog     String?           @db.Text
  downloadUrl   String            @db.Text
  fileSize      Int               @default(0)
  checksum      String?           @db.Text // SHA256
  minVersion    String?           @db.Text // 最低VCPToolBox版本要求
  maxVersion    String?           @db.Text // 最高支持版本
  isStable      Boolean           @default(true)
  downloads     Int               @default(0)
  createdAt     DateTime          @default(now())

  @@unique([pluginId, version])
  @@map("plugin_versions")
}

model PluginCategory {
  id          String             @id @default(cuid())
  name        String             @unique @db.Text
  displayName String             @db.Text
  description String?            @db.Text
  icon        String?            @db.Text
  color       String?            @db.Text // Hex color
  sortOrder   Int                @default(0)
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())

  // 关联
  plugins     PluginMarketplace[]

  @@map("plugin_categories")
}

model PluginReview {
  id        String             @id @default(cuid())
  pluginId  String
  plugin    PluginMarketplace  @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  userId    String
  user      User               @relation(fields: [userId], references: [id])
  rating    Int                @db.SmallInt // 1-5 stars
  title     String?            @db.Text
  content   String             @db.Text
  isVerifiedPurchase Boolean   @default(false) // 是否下载过该插件
  helpful   Int                @default(0) // 有帮助的投票数
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@unique([pluginId, userId])
  @@map("plugin_reviews")
}

model PluginDownload {
  id        String             @id @default(cuid())
  pluginId  String
  plugin    PluginMarketplace  @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?              @relation(fields: [userId], references: [id])
  versionId String
  version   PluginVersion      @relation(fields: [versionId], references: [id])
  ipAddress String?            @db.Inet
  userAgent String?            @db.Text
  downloadedAt DateTime        @default(now())

  @@map("plugin_downloads")
}

model PluginTag {
  id        String             @id @default(cuid())
  name      String             @unique @db.Text
  displayName String           @db.Text
  color     String?            @db.Text
  usageCount Int              @default(0)
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())

  // 关联
  plugins   PluginMarketplace[]

  @@map("plugin_tags")
}

model PluginDependency {
  id            String             @id @default(cuid())
  pluginId      String
  plugin        PluginMarketplace  @relation("PluginDependencies", fields: [pluginId], references: [id])
  dependencyId  String
  dependency    PluginMarketplace  @relation("DependentPlugins", fields: [dependencyId], references: [id])
  minVersion    String?            @db.Text
  maxVersion    String?            @db.Text
  isRequired    Boolean            @default(true)
  createdAt     DateTime           @default(now())

  @@unique([pluginId, dependencyId])
  @@map("plugin_dependencies")
}


// 插件状态枚举
enum PluginStatus {
  PENDING_REVIEW    // 待审核
  APPROVED          // 已通过
  REJECTED          // 已拒绝
  SUSPENDED         // 已暂停
  DEPRECATED        // 已弃用
}

// ==================== 多Agent协作系统 ====================

model Agent {
  id            String            @id @default(cuid())
  name          String            @unique @db.Text
  displayName   String            @db.Text
  description   String?           @db.Text
  type          AgentType         @default(GENERIC)
  status        AgentStatus       @default(OFFLINE)
  capabilities  Json              @default("[]") // Agent能力列表
  config        Json              @default("{}") // Agent配置
  maxConcurrency Int              @default(5)   // 最大并发任务数
  priority      Int               @default(1)   // Agent优先级
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // 关联
  tasks         AgentTask[]
  collaborations AgentCollaboration[]
  conversations  AgentConversation[]

  @@map("agents")
}

model AgentTask {
  id            String            @id @default(cuid())
  agentId       String
  agent         Agent             @relation(fields: [agentId], references: [id])
  taskId        String
  task          Task              @relation(fields: [taskId], references: [id])
  status        TaskStatus        @default(PENDING)
  priority      Int               @default(1)
  progress      Float             @default(0) // 0-1
  result        Json?             // 任务结果
  error         String?           // 错误信息
  startedAt     DateTime?
  completedAt   DateTime?
  assignedAt    DateTime          @default(now())

  @@unique([agentId, taskId])
  @@map("agent_tasks")
}

model Task {
  id            String            @id @default(cuid())
  title         String            @db.Text
  description   String?           @db.Text
  type          TaskType          @default(GENERIC)
  status        TaskStatus        @default(PENDING)
  priority      Int               @default(1)
  complexity    TaskComplexity    @default(MEDIUM)
  estimatedDuration Int?          // 预估耗时（分钟）
  actualDuration Int?             // 实际耗时（分钟）

  // 任务数据
  input         Json              @default("{}")
  output        Json?             @default("{}")
  requirements  Json              @default("{}") // 任务要求

  // 关联
  parentTaskId  String?
  parentTask    Task?             @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
  subtasks      Task[]            @relation("TaskHierarchy")
  agents        AgentTask[]
  collaborations TaskCollaboration[]
  gameId        String?           // 关联的游戏
  game          Game?             @relation(fields: [gameId], references: [id])

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deadline      DateTime?

  @@map("tasks")
}

model AgentCollaboration {
  id            String                @id @default(cuid())
  name          String                @db.Text
  description   String?               @db.Text
  type          CollaborationType     @default(TASK_BASED)
  status        CollaborationStatus   @default(ACTIVE)
  goal          String                @db.Text
  strategy      String?               @db.Text // 协作策略
  config        Json                  @default("{}")

  // 参与者
  leaderId      String
  leader        Agent                 @relation("CollaborationLeader", fields: [leaderId], references: [id])
  participants  Agent[]               @relation("CollaborationParticipants")

  // 任务和结果
  tasks         TaskCollaboration[]
  conversations AgentConversation[]

  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  completedAt   DateTime?

  @@map("agent_collaborations")
}

model TaskCollaboration {
  id                String            @id @default(cuid())
  collaborationId   String
  collaboration     AgentCollaboration @relation(fields: [collaborationId], references: [id])
  taskId            String
  task              Task              @relation(fields: [taskId], references: [id])
  assignedAgentId   String
  assignedAgent     Agent             @relation(fields: [assignedAgentId], references: [id])
  status            TaskStatus        @default(PENDING)
  contribution      String?           @db.Text // Agent的贡献描述
  assignedAt        DateTime          @default(now())
  completedAt       DateTime?

  @@unique([collaborationId, taskId])
  @@map("task_collaborations")
}

model AgentConversation {
  id            String            @id @default(cuid())
  collaborationId String?
  collaboration AgentCollaboration? @relation(fields: [collaborationId], references: [id])
  senderId      String
  sender        Agent             @relation(fields: [senderId], references: [id])
  receiverId    String?
  receiver      Agent?            @relation(fields: [receiverId], references: [id])
  message       String            @db.Text
  messageType   MessageType       @default(TEXT)
  metadata      Json              @default("{}") // 消息元数据
  createdAt     DateTime          @default(now())

  @@map("agent_conversations")
}

model AgentLearning {
  id            String            @id @default(cuid())
  agentId       String
  agent         Agent             @relation(fields: [agentId], references: [id])
  pattern       String            @db.Text // 学习模式
  data          Json              // 学习数据
  performance   Float             @default(0) // 性能评分
  appliedAt     DateTime          @default(now())

  @@map("agent_learning")
}

// 枚举定义
enum AgentType {
  GENERIC       // 通用Agent
  CREATION      // 创作Agent
  LOGIC         // 逻辑推理Agent
  NARRATIVE     // 叙事Agent
  CRITIC        // 批评Agent
  SPECIALIST    // 专业Agent
}

enum AgentStatus {
  OFFLINE       // 离线
  ONLINE        // 在线
  BUSY          // 忙碌
  MAINTENANCE   // 维护中
}

enum TaskType {
  GENERIC       // 通用任务
  CREATION      // 创作任务
  ANALYSIS      // 分析任务
  OPTIMIZATION  // 优化任务
  REVIEW        // 审查任务
  COLLABORATION // 协作任务
}

enum TaskStatus {
  PENDING       // 待处理
  ASSIGNED      // 已分配
  IN_PROGRESS   // 进行中
  COMPLETED     // 已完成
  FAILED        // 失败
  CANCELLED     // 已取消
}

enum TaskComplexity {
  LOW           // 低复杂度
  MEDIUM        // 中等复杂度
  HIGH          // 高复杂度
  CRITICAL      // 关键复杂度
}

enum CollaborationType {
  TASK_BASED    // 基于任务的协作
  GOAL_BASED    // 基于目标的协作
  COMPETITIVE   // 竞争性协作
  COOPERATIVE   // 合作性协作
}

enum CollaborationStatus {
  ACTIVE        // 活跃
  COMPLETED     // 已完成
  SUSPENDED     // 暂停
  TERMINATED    // 终止
}

enum MessageType {
  TEXT          // 文本消息
  COMMAND       // 命令消息
  RESULT        // 结果消息
  ERROR         // 错误消息
  STATUS        // 状态消息
}

// ==================== 高级AI模型集成 ====================

model AiProvider {
  id            String            @id @default(cuid())
  name          String            @unique @db.Text
  displayName   String            @db.Text
  description   String?           @db.Text
  baseUrl       String            @db.Text
  apiVersion    String            @db.Text
  status        ProviderStatus    @default(ACTIVE)
  rateLimit     Int               @default(60) // 请求/分钟
  priority      Int               @default(1)
  config        Json              @default("{}") // 提供商特定配置
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // 关联
  models        AiModel[]
  endpoints     ApiEndpoint[]
  metrics       ProviderMetrics[]

  @@map("ai_providers")
}

model AiModel {
  id            String            @id @default(cuid())
  providerId    String
  provider      AiProvider        @relation(fields: [providerId], references: [id])
  name          String            @db.Text
  displayName   String            @db.Text
  version       String            @db.Text
  modelType     ModelType         @default(TEXT)
  capabilities  Json              @default("[]") // 模型能力列表
  contextWindow Int               @default(4096)
  maxTokens     Int               @default(2048)
  pricing       Json              @default("{}") // 价格信息
  status        ModelStatus       @default(ACTIVE)
  performance   Float             @default(0) // 综合性能评分
  latency       Int               @default(0) // 平均延迟(ms)
  accuracy      Float             @default(0) // 准确性评分
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // 关联
  configurations AiConfiguration[]
  usages        ModelUsage[]
  metrics       ModelMetrics[]

  @@unique([providerId, name, version])
  @@map("ai_models")
}

model ApiEndpoint {
  id            String            @id @default(cuid())
  providerId    String
  provider      AiProvider        @relation(fields: [providerId], references: [id])
  name          String            @db.Text
  path          String            @db.Text
  method        HttpMethod        @default(POST)
  description   String?           @db.Text
  parameters    Json              @default("{}")
  headers       Json              @default("{}")
  rateLimit     Int               @default(60)
  timeout       Int               @default(30000) // ms
  retryConfig   Json              @default("{}")
  createdAt     DateTime          @default(now())

  @@map("api_endpoints")
}


model ModelUsage {
  id            String            @id @default(cuid())
  modelId       String
  model         AiModel           @relation(fields: [modelId], references: [id])
  userId        String?
  user          User?             @relation(fields: [userId], references: [id])
  requestTokens Int               @default(0)
  responseTokens Int              @default(0)
  totalTokens   Int               @default(0)
  cost          Decimal?          @db.Decimal(10, 6)
  latency       Int               @default(0) // ms
  status        UsageStatus       @default(SUCCESS)
  errorMessage  String?           @db.Text
  metadata      Json              @default("{}")
  createdAt     DateTime          @default(now())

  @@map("model_usage")
}

model ProviderMetrics {
  id            String            @id @default(cuid())
  providerId    String
  provider      AiProvider        @relation(fields: [providerId], references: [id])
  timestamp     DateTime          @default(now())
  requests      Int               @default(0)
  errors        Int               @default(0)
  avgLatency    Int               @default(0)
  rateLimitHits Int               @default(0)
  uptime        Float             @default(100) // 百分比

  @@map("provider_metrics")
}

model ModelMetrics {
  id            String            @id @default(cuid())
  modelId       String
  model         AiModel           @relation(fields: [modelId], references: [id])
  timestamp     DateTime          @default(now())
  requests      Int               @default(0)
  errors        Int               @default(0)
  avgLatency    Int               @default(0)
  tokenEfficiency Float           @default(0) // token利用率
  qualityScore  Float             @default(0) // 质量评分

  @@map("model_metrics")
}

model ModelRouter {
  id            String            @id @default(cuid())
  name          String            @unique @db.Text
  description   String?           @db.Text
  strategy      RoutingStrategy   @default(ROUND_ROBIN)
  conditions    Json              @default("{}") // 路由条件
  targets       Json              @default("[]") // 目标模型列表
  weights       Json              @default("{}") // 权重配置
  fallbackModel String?           @db.Text
  isActive      Boolean           @default(true)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@map("model_routers")
}

model AiTaskQueue {
  id            String            @id @default(cuid())
  modelId       String
  model         AiModel           @relation(fields: [modelId], references: [id])
  taskType      TaskType          @default(GENERIC)
  priority      Int               @default(1)
  payload       Json              @default("{}")
  status        QueueStatus       @default(PENDING)
  attempts      Int               @default(0)
  maxAttempts   Int               @default(3)
  result        Json?             @default("{}")
  error         String?           @db.Text
  scheduledAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime          @default(now())

  @@map("ai_task_queue")
}

// 枚举定义
enum ProviderStatus {
  ACTIVE      // 活跃
  INACTIVE    // 非活跃
  MAINTENANCE // 维护中
  DEPRECATED  // 已弃用
}

enum ModelType {
  TEXT        // 文本模型
  IMAGE       // 图像模型
  AUDIO       // 音频模型
  MULTIMODAL  // 多模态模型
  EMBEDDING   // 嵌入模型
}

enum ModelStatus {
  ACTIVE      // 活跃
  DEPRECATED  // 已弃用
  EXPERIMENTAL // 实验性
  BETA        // 测试版
}

enum HttpMethod {
  GET
  POST
  PUT
  DELETE
  PATCH
}

enum UsageStatus {
  SUCCESS     // 成功
  ERROR       // 错误
  TIMEOUT     // 超时
  RATE_LIMIT  // 频率限制
  QUOTA_EXCEEDED // 配额超限
}

enum RoutingStrategy {
  ROUND_ROBIN     // 轮询
  WEIGHTED        // 加权
  PERFORMANCE     // 性能优先
  COST_OPTIMAL    // 成本最优
  LOAD_BALANCE    // 负载均衡
  GEOGRAPHIC      // 地理位置
}

enum QueueStatus {
  PENDING       // 待处理
  PROCESSING    // 处理中
  COMPLETED     // 已完成
  FAILED        // 失败
  CANCELLED     // 已取消
  RETRY         // 重试
}

// ==================== 死信队列系统 ====================

model DeadLetterMessage {
  id            String            @id @default(cuid())
  originalQueue String            @db.Text
  userId        String?           @db.Text
  gameId        String?           @db.Text
  sagaId        String?           @db.Text

  // 消息内容
  messageBody   Json              @default("{}")
  headers       Json              @default("{}")

  // 错误信息
  error         String?           @db.Text
  errorDetails  Json              @default("{}")

  // 重试信息
  retryCount    Int               @default(0)
  maxRetries    Int               @default(3)
  lastAttemptAt DateTime?

  // 处理状态
  status        DLQMessageStatus  @default(PENDING_REVIEW)
  priority      Int               @default(1)

  // 处理信息
  reviewedBy    String?           @db.Text
  reviewedAt    DateTime?
  reviewNotes   String?           @db.Text
  reprocessedAt DateTime?
  resolution    String?           @db.Text

  // 时间戳
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // 索引
  @@index([originalQueue, createdAt])
  @@index([userId, createdAt])
  @@index([gameId, createdAt])
  @@index([sagaId])
  @@index([status, priority, createdAt])
  @@map("dead_letter_messages")
}

enum DLQMessageStatus {
  PENDING_REVIEW  // 待审核
  UNDER_REVIEW    // 审核中
  APPROVED        // 已批准重新处理
  REJECTED        // 已拒绝
  REPROCESSED     // 已重新处理
  ARCHIVED        // 已归档
  EXPIRED         // 已过期
}

// ==================== Phase 4: 企业级功能 ====================

model Tenant {
  id          String        @id @default(cuid())
  name        String        @unique @db.Text
  displayName String        @db.Text
  domain      String?       @unique @db.Text
  description String?       @db.Text
  status      TenantStatus  @default(ACTIVE)
  plan        TenantPlan    @default(STANDARD)

  // 配置
  config      Json          @default("{}")
  limits      Json          @default("{}") // 资源限制
  features    Json          @default("[]") // 启用的功能

  // 计费信息
  billingEmail String?      @db.Text
  billingAddress Json?      @default("{}")

  // 时间戳
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  activatedAt DateTime?
  suspendedAt DateTime?

  // 关联
  users       TenantUser[]
  workspaces  Workspace[]
  auditLogs   AuditLog[]
  integrations TenantIntegration[]
  apiKeys     TenantApiKey[]

  @@map("tenants")
}

model TenantUser {
  id         String            @id @default(cuid())
  tenantId   String
  tenant     Tenant            @relation(fields: [tenantId], references: [id])
  userId     String
  user       User              @relation(fields: [userId], references: [id])

  // 租户内角色和权限
  role       TenantRole        @default(MEMBER)
  permissions Json             @default("[]")
  departments Json             @default("[]") // 所属部门

  // 状态
  status     UserTenantStatus  @default(ACTIVE)
  invitedBy  String?
  invitedAt  DateTime?
  joinedAt   DateTime?

  // 时间戳
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@unique([tenantId, userId])
  @@map("tenant_users")
}

model Workspace {
  id          String            @id @default(cuid())
  tenantId    String
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  name        String            @db.Text
  description String?           @db.Text
  type        WorkspaceType     @default(PRIVATE)

  // 配置
  settings    Json              @default("{}")
  limits      Json              @default("{}")

  // 状态
  status      WorkspaceStatus   @default(ACTIVE)
  isDefault   Boolean           @default(false)

  // 时间戳
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // 关联
  members     WorkspaceMember[]
  projects    Project[]

  @@unique([tenantId, name])
  @@map("workspaces")
}

model WorkspaceMember {
  id          String              @id @default(cuid())
  workspaceId String
  workspace   Workspace           @relation(fields: [workspaceId], references: [id])
  userId      String
  user        User                @relation(fields: [userId], references: [id])

  // 权限
  role        WorkspaceRole       @default(VIEWER)
  permissions Json                @default("[]")

  // 状态
  status      MemberStatus        @default(ACTIVE)
  addedBy     String
  addedAt     DateTime            @default(now())

  // 时间戳
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@unique([workspaceId, userId])
  @@map("workspace_members")
}

model Project {
  id            String            @id @default(cuid())
  workspaceId   String
  workspace     Workspace         @relation(fields: [workspaceId], references: [id])
  name          String            @db.Text
  description   String?           @db.Text
  type          ProjectType       @default(GENERIC)

  // 配置
  settings      Json              @default("{}")
  metadata      Json              @default("{}")

  // 状态
  status        ProjectStatus     @default(ACTIVE)

  // 时间戳
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  completedAt   DateTime?

  // 关联
  members       ProjectMember[]
  assets        ProjectAsset[]

  @@map("projects")
}

model ProjectMember {
  id        String            @id @default(cuid())
  projectId String
  project   Project           @relation(fields: [projectId], references: [id])
  userId    String
  user      User              @relation(fields: [userId], references: [id])

  // 权限
  role      ProjectRole       @default(CONTRIBUTOR)
  permissions Json            @default("[]")

  // 状态
  status    MemberStatus      @default(ACTIVE)
  addedAt   DateTime          @default(now())

  @@unique([projectId, userId])
  @@map("project_members")
}

model ProjectAsset {
  id          String            @id @default(cuid())
  projectId   String
  project     Project           @relation(fields: [projectId], references: [id])
  name        String            @db.Text
  type        AssetType         @default(FILE)
  path        String            @db.Text
  size        Int               @default(0)
  mimeType    String?           @db.Text

  // 元数据
  metadata    Json              @default("{}")
  tags        Json              @default("[]")

  // 版本控制
  version     Int               @default(1)
  parentId    String?           // 父版本ID

  // 状态
  status      AssetStatus       @default(ACTIVE)

  // 时间戳
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdBy   String

  @@map("project_assets")
}

model AuditLog {
  id            String            @id @default(cuid())
  tenantId      String
  tenant        Tenant            @relation(fields: [tenantId], references: [id])

  // 操作信息
  action        String            @db.Text
  resourceType  String            @db.Text
  resourceId    String?           @db.Text
  userId        String?
  user          User?             @relation(fields: [userId], references: [id])

  // 操作详情
  details       Json              @default("{}")
  oldValues     Json?             @default("{}")
  newValues     Json?             @default("{}")

  // 上下文信息
  ipAddress     String?           @db.Text
  userAgent     String?           @db.Text
  sessionId     String?           @db.Text

  // 合规信息
  riskLevel     AuditRiskLevel    @default(LOW)
  complianceTags Json             @default("[]")

  // 时间戳
  createdAt     DateTime          @default(now())

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

model TenantIntegration {
  id            String                @id @default(cuid())
  tenantId      String
  tenant        Tenant                @relation(fields: [tenantId], references: [id])

  // 集成信息
  type          IntegrationType       @db.Text
  name          String                @db.Text
  description   String?               @db.Text

  // 配置
  config        Json                  @default("{}")
  credentials   Json                  @default("{}") // 加密存储

  // 状态
  status        IntegrationStatus     @default(INACTIVE)
  lastSyncAt    DateTime?
  lastError     String?               @db.Text

  // 时间戳
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  createdBy     String

  @@unique([tenantId, type, name])
  @@map("tenant_integrations")
}

model TenantApiKey {
  id            String            @id @default(cuid())
  tenantId      String
  tenant        Tenant            @relation(fields: [tenantId], references: [id])

  // API密钥信息
  name          String            @db.Text
  description   String?           @db.Text
  keyHash       String            @unique @db.Text
  permissions   Json              @default("[]")

  // 使用限制
  rateLimit     Int               @default(1000) // 请求/分钟
  quotaLimit    Int?              // 月度配额
  quotaUsed     Int               @default(0)

  // 状态
  status        ApiKeyStatus      @default(ACTIVE)
  expiresAt     DateTime?

  // 时间戳
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  lastUsedAt    DateTime?
  createdBy     String

  @@map("tenant_api_keys")
}

model ComplianceReport {
  id            String              @id @default(cuid())
  tenantId      String
  tenant        Tenant              @relation(fields: [tenantId], references: [id])

  // 报告信息
  type          ComplianceType      @db.Text
  period        String              @db.Text // YYYY-MM 或 YYYY-Q1
  status        ComplianceStatus    @default(PENDING)

  // 报告内容
  summary       Json                @default("{}")
  findings      Json                @default("[]")
  recommendations Json             @default("[]")

  // 审核信息
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNotes   String?             @db.Text

  // 时间戳
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  generatedAt   DateTime?

  @@unique([tenantId, type, period])
  @@map("compliance_reports")
}

model DataRetentionPolicy {
  id            String              @id @default(cuid())
  tenantId      String
  tenant        Tenant              @relation(fields: [tenantId], references: [id])

  // 策略信息
  name          String              @db.Text
  description   String?             @db.Text
  dataType      String              @db.Text

  // 保留规则
  retentionPeriod Int               // 天数
  retentionType  RetentionType      @default(TIME_BASED)
  autoDelete     Boolean            @default(true)

  // 例外规则
  exceptions    Json                @default("[]")

  // 状态
  status        PolicyStatus        @default(ACTIVE)

  // 时间戳
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     String

  @@map("data_retention_policies")
}

// ==================== 枚举定义 ====================

enum TenantStatus {
  ACTIVE      // 活跃
  SUSPENDED   // 暂停
  CANCELLED   // 取消
  PENDING     // 待激活
}

enum TenantPlan {
  FREE        // 免费版
  STANDARD    // 标准版
  PROFESSIONAL // 专业版
  ENTERPRISE  // 企业版
}

enum TenantRole {
  OWNER       // 所有者
  ADMIN       // 管理员
  MANAGER     // 管理者
  MEMBER      // 成员
}

enum UserTenantStatus {
  ACTIVE      // 活跃
  INVITED     // 已邀请
  SUSPENDED   // 暂停
  REMOVED     // 已移除
}

enum WorkspaceType {
  PRIVATE     // 私有
  SHARED      // 共享
  PUBLIC      // 公开
}

enum WorkspaceStatus {
  ACTIVE      // 活跃
  ARCHIVED    // 归档
  DELETED     // 删除
}

enum WorkspaceRole {
  OWNER       // 所有者
  ADMIN       // 管理员
  EDITOR      // 编辑者
  VIEWER      // 查看者
}

enum MemberStatus {
  ACTIVE      // 活跃
  INACTIVE    // 非活跃
  REMOVED     // 已移除
}

enum ProjectType {
  GENERIC     // 通用
  CONTENT_CREATION // 内容创作
  EDUCATION   // 教育
  HEALTHCARE  // 医疗
  BUSINESS    // 商业
}

enum ProjectStatus {
  ACTIVE      // 活跃
  COMPLETED   // 已完成
  ARCHIVED    // 归档
  CANCELLED   // 取消
}

enum ProjectRole {
  OWNER       // 所有者
  LEAD        // 项目负责人
  CONTRIBUTOR // 贡献者
  REVIEWER    // 审查者
}

enum AssetType {
  FILE        // 文件
  FOLDER      // 文件夹
  LINK        // 链接
  NOTE        // 笔记
}

enum AssetStatus {
  ACTIVE      // 活跃
  ARCHIVED    // 归档
  DELETED     // 删除
}

enum AuditRiskLevel {
  LOW         // 低风险
  MEDIUM      // 中风险
  HIGH        // 高风险
  CRITICAL    // 关键风险
}

enum IntegrationType {
  SLACK       // Slack
  TEAMS       // Microsoft Teams
  ZAPIER      // Zapier
  WEBHOOK     // Webhook
  API         // 自定义API
  SSO         // SSO
}

enum IntegrationStatus {
  ACTIVE      // 活跃
  INACTIVE    // 非活跃
  ERROR       // 错误
  MAINTENANCE // 维护中
}

enum ApiKeyStatus {
  ACTIVE      // 活跃
  INACTIVE    // 非活跃
  EXPIRED     // 已过期
  REVOKED     // 已撤销
}

enum ComplianceType {
  GDPR        // GDPR合规
  CCPA        // CCPA合规
  HIPAA       // HIPAA合规
  SOC2        // SOC2审计
  ISO27001    // ISO27001信息安全
}

enum ComplianceStatus {
  PENDING     // 待审核
  IN_REVIEW   // 审核中
  APPROVED    // 已批准
  REJECTED    // 已拒绝
  EXPIRED     // 已过期
}

enum RetentionType {
  TIME_BASED  // 基于时间
  EVENT_BASED // 基于事件
  MANUAL      // 手动
}

enum PolicyStatus {
  ACTIVE      // 活跃
  INACTIVE    // 非活跃
  ARCHIVED    // 归档
}
